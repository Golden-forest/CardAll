<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒä¹…åŒ–å­˜å‚¨é—®é¢˜æ·±åº¦åˆ†æ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .card { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #0078d4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #106ebe; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .db-list { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .db-item { background: white; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #0078d4; }
        .code-block { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 4px; margin: 10px 0; overflow-x: auto; }
        .analysis-step { background: #e6f3ff; border-left: 4px solid #0078d4; padding: 15px; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>ğŸ” æŒä¹…åŒ–å­˜å‚¨é—®é¢˜æ·±åº¦åˆ†æå·¥å…·</h1>

    <div class="card">
        <h2>ğŸ“Š é—®é¢˜çŠ¶æ€æ€»ç»“</h2>
        <div class="analysis-step">
            <h3>âœ… å·²ç¡®è®¤æ­£å¸¸çš„åŠŸèƒ½</h3>
            <ul>
                <li>IndexedDB APIå®Œå…¨æ”¯æŒ</li>
                <li>æµè§ˆå™¨å¯ä»¥åˆ›å»ºå’Œè®¿é—®IndexedDBæ•°æ®åº“</li>
                <li>å·²å‘ç°2ä¸ªç°æœ‰æ•°æ®åº“ï¼ˆè¯´æ˜åº”ç”¨æ›¾ç»æˆåŠŸè¿è¡Œï¼‰</li>
            </ul>
        </div>

        <div class="analysis-step">
            <h3>âŒ æ ¸å¿ƒé—®é¢˜</h3>
            <ul>
                <li><strong>æŒä¹…åŒ–å­˜å‚¨è¯·æ±‚è¢«æ‹’ç»</strong> - è¿™æ˜¯å¯¼è‡´åˆå§‹åŒ–å¡ä½çš„æ ¹æœ¬åŸå› </li>
                <li>ç”¨æˆ·å¯èƒ½é¢‘ç¹ç‚¹å‡»"è¯·æ±‚æŒä¹…åŒ–å­˜å‚¨"æŒ‰é’®</li>
                <li>æŒä¹…åŒ–å­˜å‚¨ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†ä¸åº”è¯¥é˜»æ­¢åˆå§‹åŒ–</li>
            </ul>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ” è¯¦ç»†æ•°æ®åº“æ£€æŸ¥</h2>
        <button onclick="checkExistingDatabases()">æ£€æŸ¥ç°æœ‰æ•°æ®åº“è¯¦æƒ…</button>
        <button onclick="checkCardAllDatabase()">æ£€æŸ¥CardAllæ•°æ®åº“çŠ¶æ€</button>
        <div id="database-details"></div>
    </div>

    <div class="card">
        <h2>ğŸ§ª æŒä¹…åŒ–å­˜å‚¨åˆ†æ</h2>
        <button onclick="analyzePersistentStorage()">åˆ†ææŒä¹…åŒ–å­˜å‚¨é—®é¢˜</button>
        <button onclick="testStorageWithoutPersistence()">æµ‹è¯•éæŒä¹…åŒ–å­˜å‚¨</button>
        <button onclick="checkBrowserPermissions()">æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®</button>
        <div id="persistent-analysis"></div>
    </div>

    <div class="card">
        <h2>ğŸ”§ åº”ç”¨åˆå§‹åŒ–æµ‹è¯•</h2>
        <button onclick="testAppInitialization()">æµ‹è¯•åº”ç”¨åˆå§‹åŒ–æµç¨‹</button>
        <button onclick="simulateDatabaseCreation()">æ¨¡æ‹Ÿæ•°æ®åº“åˆ›å»ºè¿‡ç¨‹</button>
        <button onclick="checkInitializationBlocking()">æ£€æŸ¥åˆå§‹åŒ–é˜»å¡ç‚¹</button>
        <div id="init-test"></div>
    </div>

    <div class="card">
        <h2>ğŸ’¡ è§£å†³æ–¹æ¡ˆéªŒè¯</h2>
        <button onclick="testSolution1()">è§£å†³æ–¹æ¡ˆ1: ä¼˜åŒ–æŒä¹…åŒ–å­˜å‚¨å¤„ç†</button>
        <button onclick="testSolution2()">è§£å†³æ–¹æ¡ˆ2: æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–</button>
        <button onclick="testSolution3()">è§£å†³æ–¹æ¡ˆ3: åˆå§‹åŒ–æµç¨‹é‡æ„</button>
        <div id="solution-test"></div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ æ§åˆ¶å°è°ƒè¯•å‘½ä»¤</h2>
        <div class="code-block">
// 1. æ£€æŸ¥å…·ä½“çš„CardAllæ•°æ®åº“çŠ¶æ€
window.indexedDB.databases().then(dbs => {
    const cardAllDBs = dbs.filter(db => db.name.includes('CardAll'));
    console.log('CardAllæ•°æ®åº“:', cardAllDBs);
});

// 2. å°è¯•ç›´æ¥æ‰“å¼€CardAllæ•°æ®åº“
try {
    const request = indexedDB.open('CardAllUnifiedDB_v3', 3);
    request.onsuccess = () => console.log('æ•°æ®åº“æ‰“å¼€æˆåŠŸ');
    request.onerror = (e) => console.log('æ•°æ®åº“æ‰“å¼€å¤±è´¥:', e.target.error);
    request.onblocked = () => console.log('æ•°æ®åº“è¢«é˜»å¡');
    request.onupgradeneeded = (e) => console.log('æ•°æ®åº“éœ€è¦å‡çº§');
} catch (error) {
    console.log('æ•°æ®åº“å¼‚å¸¸:', error);
}

// 3. æ£€æŸ¥å­˜å‚¨æƒé™çŠ¶æ€
navigator.storage.persisted().then(persisted => {
    console.log('å½“å‰æŒä¹…åŒ–çŠ¶æ€:', persisted);
});

// 4. æ‰‹åŠ¨æ¸…ç†å­˜å‚¨ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
// indexedDB.deleteDatabase('CardAllUnifiedDB_v3');
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // æ£€æŸ¥ç°æœ‰æ•°æ®åº“è¯¦æƒ…
        async function checkExistingDatabases() {
            const detailsDiv = document.getElementById('database-details');
            detailsDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥æ•°æ®åº“è¯¦æƒ…...</div>';

            try {
                const databases = await window.indexedDB.databases();
                log(`å‘ç° ${databases.length} ä¸ªæ•°æ®åº“`);

                let details = '<div class="db-list">';
                databases.forEach((db, index) => {
                    details += `
                        <div class="db-item">
                            <strong>æ•°æ®åº“ ${index + 1}:</strong> ${db.name}<br>
                            <strong>ç‰ˆæœ¬:</strong> ${db.version || 'æœªçŸ¥'}<br>
                            <strong>æ˜¯å¦ä¸ºCardAllç›¸å…³:</strong> ${db.name.includes('CardAll') ? 'âœ… æ˜¯' : 'âŒ å¦'}
                        </div>
                    `;
                });
                details += '</div>';

                // æ£€æŸ¥æ˜¯å¦æœ‰å†²çªçš„æ•°æ®åº“
                const cardAllDBs = databases.filter(db => db.name.includes('CardAll'));
                if (cardAllDBs.length > 1) {
                    details += '<div class="warning">âš ï¸ å‘ç°å¤šä¸ªCardAllç›¸å…³æ•°æ®åº“ï¼Œå¯èƒ½å¯¼è‡´å†²çª</div>';
                }

                detailsDiv.innerHTML = details;

            } catch (error) {
                detailsDiv.innerHTML = `<div class="error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥CardAllæ•°æ®åº“çŠ¶æ€
        async function checkCardAllDatabase() {
            const detailsDiv = document.getElementById('database-details');
            detailsDiv.innerHTML += '<div class="info">æ­£åœ¨æ£€æŸ¥CardAllæ•°æ®åº“çŠ¶æ€...</div>';

            try {
                // å°è¯•æ‰“å¼€æ•°æ®åº“
                const request = indexedDB.open('CardAllUnifiedDB_v3', 3);

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    log('âœ… CardAllæ•°æ®åº“æ‰“å¼€æˆåŠŸ');
                    log(`æ•°æ®åº“åç§°: ${db.name}`);
                    log(`æ•°æ®åº“ç‰ˆæœ¬: ${db.version}`);
                    log(`å¯¹è±¡å­˜å‚¨: ${Array.from(db.objectStoreNames).join(', ')}`);

                    detailsDiv.innerHTML += '<div class="success">âœ… CardAllæ•°æ®åº“çŠ¶æ€æ­£å¸¸</div>';
                    db.close();
                };

                request.onerror = (event) => {
                    const error = event.target.error;
                    log(`âŒ CardAllæ•°æ®åº“æ‰“å¼€å¤±è´¥: ${error.message}`);
                    detailsDiv.innerHTML += `<div class="error">âŒ æ•°æ®åº“æ‰“å¼€å¤±è´¥: ${error.message}</div>`;
                };

                request.onblocked = (event) => {
                    log('âŒ CardAllæ•°æ®åº“è¢«é˜»å¡');
                    detailsDiv.innerHTML += '<div class="warning">âš ï¸ æ•°æ®åº“è¢«é˜»å¡ï¼Œå¯èƒ½æœ‰å…¶ä»–è¿æ¥å ç”¨</div>';
                };

                request.onupgradeneeded = (event) => {
                    log('âš ï¸ CardAllæ•°æ®åº“éœ€è¦å‡çº§');
                    detailsDiv.innerHTML += '<div class="info">â„¹ï¸ æ•°æ®åº“éœ€è¦å‡çº§ç»“æ„</div>';
                };

            } catch (error) {
                log(`âŒ æ£€æŸ¥CardAllæ•°æ®åº“å¼‚å¸¸: ${error.message}`);
                detailsDiv.innerHTML += `<div class="error">âŒ æ£€æŸ¥å¼‚å¸¸: ${error.message}</div>`;
            }
        }

        // åˆ†ææŒä¹…åŒ–å­˜å‚¨é—®é¢˜
        async function analyzePersistentStorage() {
            const analysisDiv = document.getElementById('persistent-analysis');
            analysisDiv.innerHTML = '<div class="info">æ­£åœ¨åˆ†ææŒä¹…åŒ–å­˜å‚¨é—®é¢˜...</div>';

            try {
                log('å¼€å§‹åˆ†ææŒä¹…åŒ–å­˜å‚¨é—®é¢˜...');

                // æ£€æŸ¥å½“å‰æŒä¹…åŒ–çŠ¶æ€
                const persisted = await navigator.storage.persisted();
                log(`å½“å‰æŒä¹…åŒ–çŠ¶æ€: ${persisted}`);

                // æ£€æŸ¥å­˜å‚¨é…é¢
                const estimate = await navigator.storage.estimate();
                const usage = estimate.usage || 0;
                const quota = estimate.quota || 0;
                const usagePercent = quota > 0 ? (usage / quota * 100).toFixed(2) : 0;

                log(`å­˜å‚¨ä½¿ç”¨æƒ…å†µ: ${formatBytes(usage)} / ${formatBytes(quota)} (${usagePercent}%)`);

                // åˆ†ææŒä¹…åŒ–å­˜å‚¨è¢«æ‹’ç»çš„å¯èƒ½åŸå› 
                let reasons = [];

                if (usagePercent > 80) {
                    reasons.push('å­˜å‚¨ä½¿ç”¨ç‡è¿‡é«˜ï¼Œæµè§ˆå™¨æ‹’ç»æŒä¹…åŒ–è¯·æ±‚');
                }

                if (!persisted) {
                    reasons.push('æµè§ˆå™¨ç­–ç•¥é™åˆ¶è‡ªåŠ¨æŒä¹…åŒ–');
                    reasons.push('éœ€è¦ç”¨æˆ·æ˜ç¡®æˆæƒæ‰èƒ½æŒä¹…åŒ–');
                    reasons.push('éšç§æ¨¡å¼æˆ–å—é™æµè§ˆç¯å¢ƒ');
                }

                // å°è¯•è¯·æ±‚æŒä¹…åŒ–ï¼ˆä½†ä¸è¦å¾ªç¯è¯·æ±‚ï¼‰
                log('å°è¯•è¯·æ±‚æŒä¹…åŒ–å­˜å‚¨...');
                const persistResult = await navigator.storage.persist();
                log(`æŒä¹…åŒ–å­˜å‚¨è¯·æ±‚ç»“æœ: ${persistResult}`);

                let analysis = `
                    <div class="status ${persisted ? 'success' : 'warning'}">
                        <strong>å½“å‰æŒä¹…åŒ–çŠ¶æ€:</strong> ${persisted ? 'âœ… å·²æŒä¹…åŒ–' : 'âš ï¸ æœªæŒä¹…åŒ–'}
                    </div>
                    <div class="status info">
                        <strong>å­˜å‚¨ä½¿ç”¨æƒ…å†µ:</strong> ${formatBytes(usage)} / ${formatBytes(quota)} (${usagePercent}%)
                    </div>
                    <div class="status ${persistResult ? 'success' : 'warning'}">
                        <strong>æŒä¹…åŒ–è¯·æ±‚ç»“æœ:</strong> ${persistResult ? 'âœ… æˆåŠŸ' : 'âŒ è¢«æ‹’ç»'}
                    </div>
                `;

                if (reasons.length > 0) {
                    analysis += '<div class="status warning"><strong>å¯èƒ½çš„åŸå› :</strong><ul>';
                    reasons.forEach(reason => {
                        analysis += `<li>${reason}</li>`;
                    });
                    analysis += '</ul></div>';
                }

                analysis += `
                    <div class="status info">
                        <strong>é‡è¦è¯´æ˜:</strong><br>
                        â€¢ æŒä¹…åŒ–å­˜å‚¨ä¸æ˜¯å¿…éœ€çš„ï¼Œåº”ç”¨åº”è¯¥èƒ½åœ¨éæŒä¹…åŒ–æ¨¡å¼ä¸‹æ­£å¸¸å·¥ä½œ<br>
                        â€¢ é¢‘ç¹è¯·æ±‚æŒä¹…åŒ–å­˜å‚¨å¯èƒ½å¯¼è‡´æµè§ˆå™¨æ‹’ç»<br>
                        â€¢ åˆå§‹åŒ–ä¸åº”è¯¥å› ä¸ºæŒä¹…åŒ–å­˜å‚¨è¢«æ‹’ç»è€Œå¤±è´¥
                    </div>
                `;

                analysisDiv.innerHTML = analysis;

            } catch (error) {
                analysisDiv.innerHTML = `<div class="error">âŒ åˆ†æå¤±è´¥: ${error.message}</div>`;
                log(`âŒ æŒä¹…åŒ–å­˜å‚¨åˆ†æå¼‚å¸¸: ${error.message}`);
            }
        }

        // æµ‹è¯•éæŒä¹…åŒ–å­˜å‚¨
        async function testStorageWithoutPersistence() {
            const testDiv = document.getElementById('persistent-analysis');
            testDiv.innerHTML += '<div class="info">æ­£åœ¨æµ‹è¯•éæŒä¹…åŒ–å­˜å‚¨...</div>';

            try {
                log('æµ‹è¯•éæŒä¹…åŒ–å­˜å‚¨ä¸‹çš„æ•°æ®åº“æ“ä½œ...');

                // åˆ›å»ºæµ‹è¯•æ•°æ®åº“ï¼ˆä¸è¯·æ±‚æŒä¹…åŒ–ï¼‰
                const testName = 'TestNonPersistentDB_' + Date.now();
                const request = indexedDB.open(testName, 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore('testStore', { keyPath: 'id' });
                };

                request.onsuccess = async (event) => {
                    const db = event.target.result;
                    log('âœ… éæŒä¹…åŒ–æ•°æ®åº“åˆ›å»ºæˆåŠŸ');

                    // æµ‹è¯•åŸºæœ¬æ“ä½œ
                    const transaction = db.transaction('testStore', 'readwrite');
                    const store = transaction.objectStore('testStore');

                    const testData = { id: 1, data: 'æµ‹è¯•æ•°æ®', timestamp: new Date().toISOString() };
                    await store.add(testData);

                    const result = await store.get(1);
                    log(`âœ… æ•°æ®è¯»å†™æˆåŠŸ: ${JSON.stringify(result)}`);

                    // æ¸…ç†æµ‹è¯•æ•°æ®åº“
                    db.close();
                    await indexedDB.deleteDatabase(testName);
                    log('âœ… æµ‹è¯•æ•°æ®åº“æ¸…ç†å®Œæˆ');

                    testDiv.innerHTML += '<div class="success">âœ… éæŒä¹…åŒ–å­˜å‚¨å·¥ä½œæ­£å¸¸</div>';
                };

                request.onerror = (event) => {
                    log(`âŒ éæŒä¹…åŒ–å­˜å‚¨æµ‹è¯•å¤±è´¥: ${event.target.error.message}`);
                    testDiv.innerHTML += '<div class="error">âŒ éæŒä¹…åŒ–å­˜å‚¨æµ‹è¯•å¤±è´¥</div>';
                };

            } catch (error) {
                testDiv.innerHTML += `<div class="error">âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®
        async function checkBrowserPermissions() {
            const permDiv = document.getElementById('persistent-analysis');
            permDiv.innerHTML += '<div class="info">æ­£åœ¨æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®...</div>';

            try {
                // æ£€æŸ¥æƒé™APIæ”¯æŒ
                if ('permissions' in navigator) {
                    log('âœ… æµè§ˆå™¨æ”¯æŒæƒé™API');

                    // æ£€æŸ¥æŒä¹…åŒ–å­˜å‚¨æƒé™
                    try {
                        const permission = await navigator.permissions.query({ name: 'persistent-storage' });
                        log(`æŒä¹…åŒ–å­˜å‚¨æƒé™: ${permission.state}`);

                        permDiv.innerHTML += `
                            <div class="status ${permission.state === 'granted' ? 'success' : 'warning'}">
                                <strong>æŒä¹…åŒ–å­˜å‚¨æƒé™çŠ¶æ€:</strong> ${permission.state}
                            </div>
                        `;

                        // ç›‘å¬æƒé™å˜åŒ–
                        permission.onchange = () => {
                            log(`æŒä¹…åŒ–å­˜å‚¨æƒé™çŠ¶æ€å˜æ›´: ${permission.state}`);
                        };

                    } catch (permError) {
                        log(`æƒé™æ£€æŸ¥å¤±è´¥: ${permError.message}`);
                        permDiv.innerHTML += '<div class="warning">âš ï¸ æ— æ³•æ£€æŸ¥æŒä¹…åŒ–å­˜å‚¨æƒé™</div>';
                    }

                } else {
                    log('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒæƒé™API');
                    permDiv.innerHTML += '<div class="warning">âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒæƒé™API</div>';
                }

            } catch (error) {
                permDiv.innerHTML += `<div class="error">âŒ æƒé™æ£€æŸ¥å¼‚å¸¸: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•åº”ç”¨åˆå§‹åŒ–æµç¨‹
        async function testAppInitialization() {
            const testDiv = document.getElementById('init-test');
            testDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•åº”ç”¨åˆå§‹åŒ–æµç¨‹...</div>';

            try {
                log('å¼€å§‹æ¨¡æ‹Ÿåº”ç”¨åˆå§‹åŒ–æµç¨‹...');

                // æ­¥éª¤1: æ£€æŸ¥æ•°æ®åº“å¯ç”¨æ€§
                log('æ­¥éª¤1: æ£€æŸ¥æ•°æ®åº“å¯ç”¨æ€§...');
                const databases = await window.indexedDB.databases();
                const cardAllDB = databases.find(db => db.name === 'CardAllUnifiedDB_v3');

                if (cardAllDB) {
                    log(`âœ… æ‰¾åˆ°ç°æœ‰æ•°æ®åº“: ${cardAllDB.name} (ç‰ˆæœ¬ ${cardAllDB.version})`);
                } else {
                    log('âš ï¸ æœªæ‰¾åˆ°ç°æœ‰æ•°æ®åº“ï¼Œéœ€è¦åˆ›å»º');
                }

                // æ­¥éª¤2: æµ‹è¯•æ•°æ®åº“è¿æ¥
                log('æ­¥éª¤2: æµ‹è¯•æ•°æ®åº“è¿æ¥...');
                await new Promise((resolve, reject) => {
                    const request = indexedDB.open('CardAllUnifiedDB_v3', 3);

                    request.onsuccess = (event) => {
                        const db = event.target.result;
                        log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');
                        db.close();
                        resolve();
                    };

                    request.onerror = (event) => {
                        log(`âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${event.target.error.message}`);
                        reject(event.target.error);
                    };

                    request.onblocked = (event) => {
                        log('âŒ æ•°æ®åº“è¿æ¥è¢«é˜»å¡');
                        reject(new Error('æ•°æ®åº“è¿æ¥è¢«é˜»å¡'));
                    };

                    request.onupgradeneeded = (event) => {
                        log('âš ï¸ æ•°æ®åº“éœ€è¦å‡çº§');
                        const db = event.target.result;

                        // åˆ›å»ºå¿…è¦çš„å¯¹è±¡å­˜å‚¨
                        if (!db.objectStoreNames.contains('cards')) {
                            db.createObjectStore('cards', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('folders')) {
                            db.createObjectStore('folders', { keyPath: 'id' });
                        }
                    };
                });

                // æ­¥éª¤3: æµ‹è¯•åŸºæœ¬æ“ä½œ
                log('æ­¥éª¤3: æµ‹è¯•åŸºæœ¬æ•°æ®åº“æ“ä½œ...');
                await new Promise((resolve, reject) => {
                    const request = indexedDB.open('CardAllUnifiedDB_v3', 3);

                    request.onsuccess = (event) => {
                        const db = event.target.result;
                        const transaction = db.transaction(['cards'], 'readwrite');
                        const store = transaction.objectStore('cards');

                        const testCard = {
                            id: 'test-' + Date.now(),
                            frontContent: { title: 'æµ‹è¯•å¡ç‰‡', text: 'æµ‹è¯•å†…å®¹' },
                            backContent: { title: 'èƒŒé¢', text: 'èƒŒé¢å†…å®¹' },
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };

                        const addRequest = store.add(testCard);

                        addRequest.onsuccess = () => {
                            log('âœ… æµ‹è¯•å¡ç‰‡æ·»åŠ æˆåŠŸ');
                            db.close();
                            resolve();
                        };

                        addRequest.onerror = () => {
                            log('âŒ æµ‹è¯•å¡ç‰‡æ·»åŠ å¤±è´¥');
                            db.close();
                            reject(new Error('å¡ç‰‡æ·»åŠ å¤±è´¥'));
                        };
                    };

                    request.onerror = reject;
                });

                testDiv.innerHTML += '<div class="success">âœ… åº”ç”¨åˆå§‹åŒ–æµç¨‹æµ‹è¯•é€šè¿‡</div>';

            } catch (error) {
                log(`âŒ åº”ç”¨åˆå§‹åŒ–æµ‹è¯•å¤±è´¥: ${error.message}`);
                testDiv.innerHTML += `<div class="error">âŒ åˆå§‹åŒ–æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ¨¡æ‹Ÿæ•°æ®åº“åˆ›å»ºè¿‡ç¨‹
        async function simulateDatabaseCreation() {
            const testDiv = document.getElementById('init-test');
            testDiv.innerHTML += '<div class="info">æ­£åœ¨æ¨¡æ‹Ÿæ•°æ®åº“åˆ›å»ºè¿‡ç¨‹...</div>';

            try {
                log('å¼€å§‹æ¨¡æ‹Ÿæ•°æ®åº“åˆ›å»ºè¿‡ç¨‹...');

                // æ¸…ç†æ—§çš„æµ‹è¯•æ•°æ®åº“
                try {
                    await indexedDB.deleteDatabase('CardAllUnifiedDB_v3');
                    log('âœ… æ—§æ•°æ®åº“æ¸…ç†å®Œæˆ');
                } catch (error) {
                    log('âš ï¸ æ—§æ•°æ®åº“æ¸…ç†å¤±è´¥æˆ–ä¸å­˜åœ¨');
                }

                // åˆ›å»ºæ–°æ•°æ®åº“
                await new Promise((resolve, reject) => {
                    const request = indexedDB.open('CardAllUnifiedDB_v3', 3);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        log('æ•°æ®åº“å‡çº§ä¸­...');

                        // åˆ›å»ºæ‰€æœ‰å¿…è¦çš„å¯¹è±¡å­˜å‚¨
                        const stores = [
                            'cards', 'folders', 'tags', 'images',
                            'syncQueue', 'settings', 'sessions'
                        ];

                        stores.forEach(storeName => {
                            if (!db.objectStoreNames.contains(storeName)) {
                                log(`åˆ›å»ºå¯¹è±¡å­˜å‚¨: ${storeName}`);
                                db.createObjectStore(storeName, { keyPath: 'id' });
                            }
                        });
                    };

                    request.onsuccess = (event) => {
                        const db = event.target.result;
                        log('âœ… æ•°æ®åº“åˆ›å»ºæˆåŠŸ');
                        log(`å¯¹è±¡å­˜å‚¨: ${Array.from(db.objectStoreNames).join(', ')}`);
                        db.close();
                        resolve();
                    };

                    request.onerror = (event) => {
                        log(`âŒ æ•°æ®åº“åˆ›å»ºå¤±è´¥: ${event.target.error.message}`);
                        reject(event.target.error);
                    };
                });

                testDiv.innerHTML += '<div class="success">âœ… æ•°æ®åº“åˆ›å»ºè¿‡ç¨‹æ¨¡æ‹ŸæˆåŠŸ</div>';

            } catch (error) {
                testDiv.innerHTML += `<div class="error">âŒ æ•°æ®åº“åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥åˆå§‹åŒ–é˜»å¡ç‚¹
        async function checkInitializationBlocking() {
            const testDiv = document.getElementById('init-test');
            testDiv.innerHTML += '<div class="info">æ­£åœ¨æ£€æŸ¥åˆå§‹åŒ–é˜»å¡ç‚¹...</div>';

            try {
                log('æ£€æŸ¥å¯èƒ½çš„åˆå§‹åŒ–é˜»å¡ç‚¹...');

                // æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦è¢«é˜»å¡
                const isBlocked = await new Promise((resolve) => {
                    let blocked = false;
                    const request = indexedDB.open('CardAllUnifiedDB_v3', 3);

                    request.onblocked = () => {
                        blocked = true;
                        resolve(true);
                    };

                    request.onsuccess = () => {
                        request.result.close();
                        resolve(blocked);
                    };

                    request.onerror = () => {
                        resolve(blocked);
                    };

                    // è®¾ç½®è¶…æ—¶
                    setTimeout(() => resolve(blocked), 5000);
                });

                if (isBlocked) {
                    log('âŒ æ•°æ®åº“è¿æ¥è¢«é˜»å¡');
                    testDiv.innerHTML += '<div class="warning">âš ï¸ æ•°æ®åº“è¿æ¥è¢«é˜»å¡ï¼Œå¯èƒ½æ˜¯å…¶ä»–è¿æ¥å ç”¨</div>';
                } else {
                    log('âœ… æ•°æ®åº“è¿æ¥æœªè¢«é˜»å¡');
                }

                // æ£€æŸ¥å­˜å‚¨é…é¢æ˜¯å¦è¶³å¤Ÿ
                const estimate = await navigator.storage.estimate();
                const usagePercent = estimate.quota > 0 ? (estimate.usage / estimate.quota * 100) : 0;

                if (usagePercent > 90) {
                    log('âŒ å­˜å‚¨ç©ºé—´ä¸è¶³');
                    testDiv.innerHTML += '<div class="warning">âš ï¸ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå¯èƒ½å½±å“åˆå§‹åŒ–</div>';
                } else {
                    log(`âœ… å­˜å‚¨ç©ºé—´å……è¶³ (${usagePercent.toFixed(2)}% å·²ä½¿ç”¨)`);
                }

                testDiv.innerHTML += '<div class="success">âœ… é˜»å¡ç‚¹æ£€æŸ¥å®Œæˆ</div>';

            } catch (error) {
                testDiv.innerHTML += `<div class="error">âŒ é˜»å¡ç‚¹æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•è§£å†³æ–¹æ¡ˆ
        async function testSolution1() {
            const solutionDiv = document.getElementById('solution-test');
            solutionDiv.innerHTML = '<div class="info">æµ‹è¯•è§£å†³æ–¹æ¡ˆ1: ä¼˜åŒ–æŒä¹…åŒ–å­˜å‚¨å¤„ç†...</div>';

            try {
                log('æµ‹è¯•è§£å†³æ–¹æ¡ˆ1: ä¼˜åŒ–æŒä¹…åŒ–å­˜å‚¨å¤„ç†...');

                // æ–¹æ¡ˆ1: ä¼˜é›…åœ°å¤„ç†æŒä¹…åŒ–å­˜å‚¨å¤±è´¥
                const persisted = await navigator.storage.persisted();
                log(`å½“å‰æŒä¹…åŒ–çŠ¶æ€: ${persisted}`);

                if (!persisted) {
                    // å°è¯•è¯·æ±‚æŒä¹…åŒ–ï¼Œä½†ä¸é˜»å¡åˆå§‹åŒ–
                    navigator.storage.persist().then(result => {
                        log(`æŒä¹…åŒ–å­˜å‚¨è¯·æ±‚ç»“æœ: ${result ? 'æˆåŠŸ' : 'å¤±è´¥ï¼Œä½†ä¸å½±å“åˆå§‹åŒ–'}`);
                    }).catch(error => {
                        log(`æŒä¹…åŒ–å­˜å‚¨è¯·æ±‚å¼‚å¸¸: ${error.message}ï¼Œä½†ä¸å½±å“åˆå§‹åŒ–`);
                    });
                }

                solutionDiv.innerHTML += `
                    <div class="success">âœ… è§£å†³æ–¹æ¡ˆ1æµ‹è¯•é€šè¿‡</div>
                    <div class="info">
                        <strong>æ–¹æ¡ˆè¯´æ˜:</strong><br>
                        â€¢ ä¸å°†æŒä¹…åŒ–å­˜å‚¨ä½œä¸ºåˆå§‹åŒ–çš„å¿…éœ€æ­¥éª¤<br>
                        â€¢ åœ¨åå°å¼‚æ­¥è¯·æ±‚æŒä¹…åŒ–å­˜å‚¨<br>
                        â€¢ å³ä½¿è¢«æ‹’ç»ä¹Ÿä¸å½±å“åº”ç”¨æ­£å¸¸è¿è¡Œ
                    </div>
                `;

            } catch (error) {
                solutionDiv.innerHTML += `<div class="error">âŒ è§£å†³æ–¹æ¡ˆ1æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testSolution2() {
            const solutionDiv = document.getElementById('solution-test');
            solutionDiv.innerHTML += '<div class="info">æµ‹è¯•è§£å†³æ–¹æ¡ˆ2: æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–...</div>';

            try {
                log('æµ‹è¯•è§£å†³æ–¹æ¡ˆ2: æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–...');

                // æ–¹æ¡ˆ2: å®ç°æ•°æ®åº“è¿æ¥ç®¡ç†
                let dbConnection = null;

                const getDbConnection = async () => {
                    if (dbConnection) {
                        try {
                            // æµ‹è¯•è¿æ¥æ˜¯å¦æœ‰æ•ˆ
                            dbConnection.objectStoreNames;
                            return dbConnection;
                        } catch (error) {
                            log('æ•°æ®åº“è¿æ¥å·²å¤±æ•ˆï¼Œé‡æ–°è¿æ¥...');
                            dbConnection = null;
                        }
                    }

                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('CardAllUnifiedDB_v3', 3);

                        request.onsuccess = (event) => {
                            dbConnection = event.target.result;
                            resolve(dbConnection);
                        };

                        request.onerror = reject;
                    });
                };

                const db = await getDbConnection();
                log('âœ… æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–æµ‹è¯•æˆåŠŸ');

                if (db) {
                    db.close();
                }

                solutionDiv.innerHTML += `
                    <div class="success">âœ… è§£å†³æ–¹æ¡ˆ2æµ‹è¯•é€šè¿‡</div>
                    <div class="info">
                        <strong>æ–¹æ¡ˆè¯´æ˜:</strong><br>
                        â€¢ å®ç°æ•°æ®åº“è¿æ¥å¤ç”¨<br>
                        â€¢ è‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤å¤±æ•ˆè¿æ¥<br>
                        â€¢ é¿å…é‡å¤åˆ›å»ºè¿æ¥å¯¼è‡´çš„é˜»å¡
                    </div>
                `;

            } catch (error) {
                solutionDiv.innerHTML += `<div class="error">âŒ è§£å†³æ–¹æ¡ˆ2æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testSolution3() {
            const solutionDiv = document.getElementById('solution-test');
            solutionDiv.innerHTML += '<div class="info">æµ‹è¯•è§£å†³æ–¹æ¡ˆ3: åˆå§‹åŒ–æµç¨‹é‡æ„...</div>';

            try {
                log('æµ‹è¯•è§£å†³æ–¹æ¡ˆ3: åˆå§‹åŒ–æµç¨‹é‡æ„...');

                // æ–¹æ¡ˆ3: åˆ†æ­¥éª¤åˆå§‹åŒ–ï¼Œæ¯æ­¥éƒ½æœ‰é”™è¯¯å¤„ç†
                const steps = [
                    { name: 'æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ', fn: () => Promise.resolve('indexedDB' in window) },
                    { name: 'æ£€æŸ¥å­˜å‚¨æƒé™', fn: () => navigator.storage.estimate().then(() => true).catch(() => true) },
                    { name: 'è¿æ¥æ•°æ®åº“', fn: () => new Promise((resolve, reject) => {
                        const request = indexedDB.open('CardAllUnifiedDB_v3', 3);
                        request.onsuccess = (event) => { event.target.result.close(); resolve(true); };
                        request.onerror = () => reject(new Error('æ•°æ®åº“è¿æ¥å¤±è´¥'));
                    })},
                    { name: 'æŒä¹…åŒ–å­˜å‚¨', fn: () => navigator.storage.persist().then(() => true).catch(() => true) }
                ];

                for (const step of steps) {
                    try {
                        log(`æ‰§è¡Œæ­¥éª¤: ${step.name}...`);
                        const result = await step.fn();
                        log(`âœ… ${step.name}: ${result}`);
                    } catch (error) {
                        log(`âš ï¸ ${step.name} å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ: ${error.message}`);
                    }
                }

                solutionDiv.innerHTML += `
                    <div class="success">âœ… è§£å†³æ–¹æ¡ˆ3æµ‹è¯•é€šè¿‡</div>
                    <div class="info">
                        <strong>æ–¹æ¡ˆè¯´æ˜:</strong><br>
                        â€¢ å°†åˆå§‹åŒ–åˆ†è§£ä¸ºç‹¬ç«‹æ­¥éª¤<br>
                        â€¢ æ¯ä¸ªæ­¥éª¤éƒ½æœ‰ç‹¬ç«‹çš„é”™è¯¯å¤„ç†<br>
                        â€¢ å•ä¸ªæ­¥éª¤å¤±è´¥ä¸å½±å“æ•´ä½“åˆå§‹åŒ–
                    </div>
                `;

            } catch (error) {
                solutionDiv.innerHTML += `<div class="error">âŒ è§£å†³æ–¹æ¡ˆ3æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ ¼å¼åŒ–å­—èŠ‚æ•°
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆ†æ
        window.onload = function() {
            log('æŒä¹…åŒ–å­˜å‚¨é—®é¢˜åˆ†æå·¥å…·å·²åŠ è½½');
            log('è¯·ç‚¹å‡»å„ä¸ªæµ‹è¯•æŒ‰é’®è¿›è¡Œæ·±åº¦åˆ†æ');
        };
    </script>
</body>
</html>