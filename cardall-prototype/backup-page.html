<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardAll æ•°æ®å¤‡ä»½å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- å¤´éƒ¨ -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ—„ï¸ CardAll æ•°æ®å¤‡ä»½</h1>
            <p class="text-gray-600">å®Œæ•´çš„ IndexedDB æ•°æ®å¤‡ä»½å·¥å…·</p>
        </header>

        <!-- ä¸»è¦å†…å®¹ -->
        <main class="space-y-6">
            <!-- çŠ¶æ€å¡ç‰‡ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ“Š æ•°æ®åº“çŠ¶æ€</h2>
                <div id="databaseStatus" class="space-y-2">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>
                        <span class="text-gray-600">æ­£åœ¨æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...</span>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®ç»Ÿè®¡ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h2>
                <div id="dataStats" class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="text-center p-3 bg-blue-50 rounded">
                        <div class="text-2xl font-bold text-blue-600" id="cardsCount">-</div>
                        <div class="text-sm text-gray-600">å¡ç‰‡</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded">
                        <div class="text-2xl font-bold text-green-600" id="foldersCount">-</div>
                        <div class="text-sm text-gray-600">æ–‡ä»¶å¤¹</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded">
                        <div class="text-2xl font-bold text-purple-600" id="tagsCount">-</div>
                        <div class="text-sm text-gray-600">æ ‡ç­¾</div>
                    </div>
                    <div class="text-center p-3 bg-orange-50 rounded">
                        <div class="text-2xl font-bold text-orange-600" id="imagesCount">-</div>
                        <div class="text-sm text-gray-600">å›¾ç‰‡</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded">
                        <div class="text-2xl font-bold text-gray-600" id="totalSize">-</div>
                        <div class="text-sm text-gray-600">æ€»è®¡</div>
                    </div>
                </div>
            </div>

            <!-- å¤‡ä»½æ§åˆ¶ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ’¾ å¤‡ä»½æ“ä½œ</h2>

                <div class="space-y-4">
                    <!-- å¤‡ä»½é€‰é¡¹ -->
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="includeImages" checked class="mr-2">
                            <span>åŒ…å«å›¾ç‰‡æ•°æ®</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="includeSettings" checked class="mr-2">
                            <span>åŒ…å«åº”ç”¨è®¾ç½®</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="compressBackup" checked class="mr-2">
                            <span>å‹ç¼©å¤‡ä»½æ–‡ä»¶</span>
                        </label>
                    </div>

                    <!-- å¤‡ä»½æŒ‰é’® -->
                    <button id="startBackup" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        ğŸš€ å¼€å§‹å¤‡ä»½
                    </button>
                </div>

                <!-- è¿›åº¦æ¡ -->
                <div id="progressSection" class="mt-6 hidden">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">å¤‡ä»½è¿›åº¦</span>
                        <span id="progressText" class="text-sm text-gray-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="progressMessage" class="mt-2 text-sm text-gray-600"></div>
                </div>
            </div>

            <!-- å¤‡ä»½å†å² -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ“‹ å¤‡ä»½å†å²</h2>
                <div id="backupHistory" class="space-y-2">
                    <p class="text-gray-500">æš‚æ— å¤‡ä»½å†å²</p>
                </div>
            </div>
        </main>

        <!-- é¡µè„š -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>CardAll æ•°æ®å¤‡ä»½å·¥å…· v1.0.0</p>
            <p>ç¡®ä¿æ‚¨çš„æ•°æ®å®‰å…¨ï¼Œå®šæœŸå¤‡ä»½é‡è¦å†…å®¹</p>
        </footer>
    </div>

    <!-- æˆåŠŸ/é”™è¯¯æç¤º -->
    <div id="notification" class="fixed top-4 right-4 max-w-sm hidden">
        <div class="rounded-lg shadow-lg p-4 transition-all duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div id="notificationIcon"></div>
                </div>
                <div class="ml-3">
                    <h3 id="notificationTitle" class="text-sm font-medium"></h3>
                    <div id="notificationMessage" class="text-sm mt-1"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // æ•°æ®åº“é…ç½®
        const DB_NAME = 'CardAllLocalDB_v4';
        const DB_VERSION = 4;

        // çŠ¶æ€ç®¡ç†
        let isBackupInProgress = false;
        let backupHistory = [];

        // DOM å…ƒç´ 
        const elements = {
            startBackup: document.getElementById('startBackup'),
            progressSection: document.getElementById('progressSection'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            progressMessage: document.getElementById('progressMessage'),
            databaseStatus: document.getElementById('databaseStatus'),
            cardsCount: document.getElementById('cardsCount'),
            foldersCount: document.getElementById('foldersCount'),
            tagsCount: document.getElementById('tagsCount'),
            imagesCount: document.getElementById('imagesCount'),
            totalSize: document.getElementById('totalSize'),
            backupHistory: document.getElementById('backupHistory'),
            includeImages: document.getElementById('includeImages'),
            includeSettings: document.getElementById('includeSettings'),
            compressBackup: document.getElementById('compressBackup')
        };

        // æ‰“å¼€æ•°æ®åº“è¿æ¥
        async function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // åˆ›å»ºå¿…è¦çš„è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                    if (!db.objectStoreNames.contains('cards')) {
                        db.createObjectStore('cards', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('folders')) {
                        db.createObjectStore('folders', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('tags')) {
                        db.createObjectStore('tags', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('images')) {
                        db.createObjectStore('images', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'id' });
                    }
                };
            });
        }

        // è·å–è¡¨æ•°æ®
        async function getTableData(db, tableName) {
            return new Promise((resolve, reject) => {
                if (!db.objectStoreNames.contains(tableName)) {
                    resolve([]);
                    return;
                }

                const transaction = db.transaction([tableName], 'readonly');
                const store = transaction.objectStore(tableName);
                const request = store.getAll();

                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result || []);
            });
        }

        // æ›´æ–°æ•°æ®åº“çŠ¶æ€æ˜¾ç¤º
        async function updateDatabaseStatus() {
            try {
                const db = await openDatabase();

                elements.databaseStatus.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-green-600 font-medium">æ•°æ®åº“è¿æ¥æ­£å¸¸</span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        æ•°æ®åº“: ${DB_NAME} (ç‰ˆæœ¬ ${DB_VERSION})
                    </div>
                `;

                // è·å–æ•°æ®ç»Ÿè®¡
                const [cards, folders, tags, images] = await Promise.all([
                    getTableData(db, 'cards'),
                    getTableData(db, 'folders'),
                    getTableData(db, 'tags'),
                    getTableData(db, 'images')
                ]);

                elements.cardsCount.textContent = cards.length;
                elements.foldersCount.textContent = folders.length;
                elements.tagsCount.textContent = tags.length;
                elements.imagesCount.textContent = images.length;
                elements.totalSize.textContent = cards.length + folders.length + tags.length + images.length;

                db.close();

            } catch (error) {
                elements.databaseStatus.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                        <span class="text-red-600 font-medium">æ•°æ®åº“è¿æ¥å¤±è´¥</span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        é”™è¯¯: ${error.message}
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');

            // è®¾ç½®å›¾æ ‡
            const icons = {
                success: '<div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">âœ“</div>',
                error: '<div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center">âœ—</div>',
                info: '<div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">â„¹</div>'
            };

            icon.innerHTML = icons[type];
            titleEl.textContent = title;
            messageEl.textContent = message;

            // è®¾ç½®æ ·å¼
            const colors = {
                success: 'bg-green-50 border border-green-200 text-green-800',
                error: 'bg-red-50 border border-red-200 text-red-800',
                info: 'bg-blue-50 border border-blue-200 text-blue-800'
            };

            notification.firstElementChild.className = `rounded-lg shadow-lg p-4 transition-all duration-300 ${colors[type]}`;

            // æ˜¾ç¤ºé€šçŸ¥
            notification.classList.remove('hidden');

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(progress, message) {
            elements.progressBar.style.width = `${progress}%`;
            elements.progressText.textContent = `${progress}%`;
            elements.progressMessage.textContent = message;
        }

        // æ‰§è¡Œå¤‡ä»½
        async function performBackup() {
            if (isBackupInProgress) return;

            isBackupInProgress = true;
            elements.startBackup.disabled = true;
            elements.progressSection.classList.remove('hidden');

            try {
                updateProgress(0, 'æ­£åœ¨è¿æ¥æ•°æ®åº“...');

                const db = await openDatabase();
                updateProgress(10, 'æ­£åœ¨è¯»å–æ•°æ®...');

                // è¯»å–æ‰€æœ‰æ•°æ®
                const [cards, folders, tags, images, settings] = await Promise.all([
                    getTableData(db, 'cards'),
                    getTableData(db, 'folders'),
                    getTableData(db, 'tags'),
                    elements.includeImages.checked ? getTableData(db, 'images') : Promise.resolve([]),
                    elements.includeSettings.checked ? getTableData(db, 'settings') : Promise.resolve([])
                ]);

                updateProgress(50, 'æ­£åœ¨å¤„ç†æ•°æ®...');

                // åˆ›å»ºå¤‡ä»½æ•°æ®
                const backupData = {
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: '4.0.0',
                        description: 'CardAllå®Œæ•´æ•°æ®å¤‡ä»½',
                        environment: 'browser-backup-tool',
                        database: DB_NAME,
                        options: {
                            includeImages: elements.includeImages.checked,
                            includeSettings: elements.includeSettings.checked,
                            compressBackup: elements.compressBackup.checked
                        }
                    },
                    database: {
                        cards,
                        folders,
                        tags,
                        images,
                        settings
                    },
                    statistics: {
                        totalCards: cards.length,
                        totalFolders: folders.length,
                        totalTags: tags.length,
                        totalImages: images.length,
                        totalSettings: settings.length,
                        exportTimestamp: new Date().toISOString()
                    }
                };

                updateProgress(80, 'æ­£åœ¨ç”Ÿæˆå¤‡ä»½æ–‡ä»¶...');

                // ç”Ÿæˆæ–‡ä»¶
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').replace('T', '_');
                const filename = `cardall-backup-${timestamp}.json`;

                let jsonString = JSON.stringify(backupData, null, 2);

                // å‹ç¼©ï¼ˆå¦‚æœé€‰æ‹©äº†å‹ç¼©ï¼‰
                if (elements.compressBackup.checked) {
                    updateProgress(85, 'æ­£åœ¨å‹ç¼©æ•°æ®...');
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å‹ç¼©é€»è¾‘ï¼Œæš‚æ—¶è·³è¿‡
                }

                const blob = new Blob([jsonString], { type: 'application/json' });

                updateProgress(90, 'æ­£åœ¨ä¸‹è½½æ–‡ä»¶...');

                // ä¸‹è½½æ–‡ä»¶
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                updateProgress(100, 'å¤‡ä»½å®Œæˆ!');

                // æ·»åŠ åˆ°å†å²è®°å½•
                const backupRecord = {
                    filename,
                    timestamp: new Date().toISOString(),
                    size: (blob.size / 1024).toFixed(2) + ' KB',
                    records: backupData.statistics.totalCards + backupData.statistics.totalFolders +
                             backupData.statistics.totalTags + backupData.statistics.totalImages,
                    success: true
                };

                backupHistory.unshift(backupRecord);
                if (backupHistory.length > 5) backupHistory.pop(); // åªä¿ç•™æœ€è¿‘5æ¡

                updateBackupHistory();

                showNotification('å¤‡ä»½æˆåŠŸ', `æ–‡ä»¶ ${filename} å·²ä¸‹è½½`, 'success');

                db.close();

            } catch (error) {
                console.error('å¤‡ä»½å¤±è´¥:', error);
                showNotification('å¤‡ä»½å¤±è´¥', error.message, 'error');
            } finally {
                isBackupInProgress = false;
                elements.startBackup.disabled = false;

                // 3ç§’åéšè—è¿›åº¦æ¡
                setTimeout(() => {
                    elements.progressSection.classList.add('hidden');
                }, 3000);
            }
        }

        // æ›´æ–°å¤‡ä»½å†å²æ˜¾ç¤º
        function updateBackupHistory() {
            if (backupHistory.length === 0) {
                elements.backupHistory.innerHTML = '<p class="text-gray-500">æš‚æ— å¤‡ä»½å†å²</p>';
                return;
            }

            elements.backupHistory.innerHTML = backupHistory.map(record => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <div class="font-medium text-gray-800">${record.filename}</div>
                        <div class="text-sm text-gray-600">
                            ${new Date(record.timestamp).toLocaleString()} â€¢
                            ${record.size} â€¢
                            ${record.records} æ¡è®°å½•
                        </div>
                    </div>
                    <div class="text-green-600">
                        ${record.success ? 'âœ“' : 'âœ—'}
                    </div>
                </div>
            `).join('');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateDatabaseStatus();
            updateBackupHistory();

            // ç»‘å®šäº‹ä»¶
            elements.startBackup.addEventListener('click', performBackup);

            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®åº“çŠ¶æ€
            setInterval(updateDatabaseStatus, 30000);
        });

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
            showNotification('ç³»ç»Ÿé”™è¯¯', event.error.message, 'error');
        });
    </script>
</body>
</html>