# å†…å®¹å“ˆå¸Œå»é‡æœºåˆ¶

## æ¦‚è¿°

å†…å®¹å“ˆå¸Œå»é‡æœºåˆ¶æ˜¯ CardAll å¹³å°çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œç”¨äºåœ¨åˆ›å»ºæ–°å¡ç‰‡å‰è‡ªåŠ¨æ£€æµ‹å¹¶é˜²æ­¢é‡å¤ã€‚è¯¥ç³»ç»ŸåŸºäº SHA-256 å“ˆå¸Œç®—æ³•å’Œæ™ºèƒ½ç›¸ä¼¼åº¦æ£€æµ‹ï¼Œèƒ½å¤Ÿæœ‰æ•ˆè¯†åˆ«å®Œå…¨é‡å¤å’Œé«˜åº¦ç›¸ä¼¼çš„å¡ç‰‡å†…å®¹ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ é‡å¤æ£€æµ‹ç±»å‹
- **å®Œå…¨é‡å¤æ£€æµ‹**: åŸºäºå†…å®¹å“ˆå¸Œçš„ç²¾ç¡®åŒ¹é…
- **ç›¸ä¼¼é‡å¤æ£€æµ‹**: åŸºäºæ–‡æœ¬ç›¸ä¼¼åº¦å’Œå†…å®¹ç‰¹å¾çš„æ™ºèƒ½æ£€æµ‹
- **æ‰¹é‡å¤„ç†**: æ”¯æŒå¤§é‡å¡ç‰‡çš„é«˜æ•ˆæ‰¹é‡é‡å¤æ£€æŸ¥

### âš¡ æ€§èƒ½ä¼˜åŒ–
- **ç¼“å­˜æœºåˆ¶**: 5åˆ†é’ŸTTLçš„å†…å­˜ç¼“å­˜ï¼Œå¤§å¹…æå‡é‡å¤æŸ¥è¯¢æ€§èƒ½
- **æ‰¹é‡å¤„ç†**: ä¼˜åŒ–çš„æ‰¹é‡ç®—æ³•ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
- **ç´¢å¼•ä¼˜åŒ–**: æ•°æ®åº“çº§åˆ«çš„å“ˆå¸Œç´¢å¼•ï¼Œå®ç°æ¯«ç§’çº§æŸ¥è¯¢
- **å¼‚æ­¥å¤„ç†**: éé˜»å¡çš„é‡å¤æ£€æŸ¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ

### ğŸ”§ é›†æˆç‰¹æ€§
- **åŒæ­¥æœåŠ¡é›†æˆ**: ä¸äº‘ç«¯åŒæ­¥æœåŠ¡æ— ç¼é›†æˆï¼Œåœ¨æ•°æ®åŒæ­¥æ—¶è‡ªåŠ¨å»é‡
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿æœåŠ¡ç¨³å®šæ€§
- **ç»Ÿè®¡ç›‘æ§**: è¯¦ç»†çš„æ€§èƒ½ç»Ÿè®¡å’Œä½¿ç”¨æƒ…å†µç›‘æ§

## æŠ€æœ¯æ¶æ„

### æ–‡ä»¶ç»“æ„
```
src/services/
â”œâ”€â”€ content-deduplicator.ts          # æ ¸å¿ƒå»é‡æœåŠ¡
â”œâ”€â”€ content-deduplicator-example.ts  # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ content-deduplicator-README.md   # æ–‡æ¡£è¯´æ˜
â””â”€â”€ __tests__/
    â””â”€â”€ content-deduplicator.test.ts # å•å…ƒæµ‹è¯•
```

### æ ¸å¿ƒç»„ä»¶

#### 1. ContentDeduplicator ç±»
ä¸»è¦çš„å»é‡æœåŠ¡ç±»ï¼Œæä¾›ä»¥ä¸‹æ ¸å¿ƒæ–¹æ³•ï¼š
- `generateContentHash()`: ç”Ÿæˆå†…å®¹å“ˆå¸Œ
- `checkDuplicate()`: æ£€æŸ¥å•ä¸ªå¡ç‰‡é‡å¤
- `checkDuplicatesBatch()`: æ‰¹é‡æ£€æŸ¥é‡å¤
- `getStats()`: è·å–ç»Ÿè®¡ä¿¡æ¯

#### 2. å“ˆå¸Œç®—æ³•
ä½¿ç”¨ SHA-256 ç®—æ³•ç”Ÿæˆå†…å®¹å“ˆå¸Œï¼ŒåŒ…å«ï¼š
- æ ‡é¢˜æ–‡æœ¬ï¼ˆè§„èŒƒåŒ–å¤„ç†ï¼‰
- å†…å®¹æ–‡æœ¬ï¼ˆè§„èŒƒåŒ–å¤„ç†ï¼‰
- å›¾ç‰‡URLåˆ—è¡¨
- æ ‡ç­¾åˆ—è¡¨ï¼ˆæ’åºåï¼‰

#### 3. ç›¸ä¼¼åº¦ç®—æ³•
åŸºäºä»¥ä¸‹ç‰¹å¾è®¡ç®—å†…å®¹ç›¸ä¼¼åº¦ï¼š
- æ–‡æœ¬ç›¸ä¼¼åº¦ï¼ˆLevenshteinè·ç¦»ç®—æ³•ï¼‰
- å›¾ç‰‡ç›¸ä¼¼åº¦ï¼ˆURLåŒ¹é…ï¼‰
- æ ‡ç­¾ç›¸ä¼¼åº¦ï¼ˆJaccardç›¸ä¼¼åº¦ï¼‰

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```typescript
import { contentDeduplicator } from '@/services/content-deduplicator'

// åˆå§‹åŒ–æœåŠ¡
await contentDeduplicator.initialize()

// æ£€æŸ¥å•ä¸ªå¡ç‰‡é‡å¤
const result = await contentDeduplicator.checkDuplicate(card, userId)

if (result.isDuplicate) {
  console.log(`å‘ç°é‡å¤: ${result.duplicateType}`)
  console.log(`ç›¸ä¼¼åº¦: ${result.similarityScore}`)
  console.log(`åŒ¹é…å­—æ®µ: ${result.matchedFields}`)
}
```

### æ‰¹é‡æ£€æŸ¥

```typescript
// æ‰¹é‡æ£€æŸ¥é‡å¤
const results = await contentDeduplicator.checkDuplicatesBatch(cards, userId)

results.forEach((result, index) => {
  if (result.isDuplicate) {
    console.log(`å¡ç‰‡ ${cards[index].id} æ˜¯é‡å¤çš„`)
  }
})
```

### ä¸åŒæ­¥æœåŠ¡é›†æˆ

```typescript
import { simpleSyncService } from '@/services/simple-sync-service'

// åŒæ­¥æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œé‡å¤æ£€æŸ¥
await simpleSyncService.syncCards()

// è·å–å»é‡ç»Ÿè®¡ä¿¡æ¯
const stats = simpleSyncService.getDeduplicationStats()
```

## é…ç½®å‚æ•°

### æ ¸å¿ƒé…ç½®
```typescript
// ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆé»˜è®¤: 0.85ï¼‰
private readonly SIMILARITY_THRESHOLD = 0.85

// ç¼“å­˜TTLï¼ˆé»˜è®¤: 5åˆ†é’Ÿï¼‰
private readonly HASH_CACHE_TTL = 300000

// ç¼“å­˜å¤§å°é™åˆ¶ï¼ˆé»˜è®¤: 1000æ¡ï¼‰
if (this.hashCache.size > 1000) {
  this.cleanupCache()
}
```

### æ•°æ®åº“ç´¢å¼•
```typescript
// å¡ç‰‡è¡¨ç´¢å¼•æ”¯æŒ
cards: '++id, userId, folderId, ..., contentHash, [userId+contentHash], ...'
```

## æ€§èƒ½æŒ‡æ ‡

### æŸ¥è¯¢æ€§èƒ½
- **ç¼“å­˜å‘½ä¸­**: < 1ms
- **æ•°æ®åº“æŸ¥è¯¢**: < 10ms
- **æ‰¹é‡å¤„ç†**: 100å¼ å¡ç‰‡ < 100ms

### å‡†ç¡®æ€§æŒ‡æ ‡
- **å®Œå…¨é‡å¤æ£€æµ‹**: 100% å‡†ç¡®
- **ç›¸ä¼¼é‡å¤æ£€æµ‹**: 85% é˜ˆå€¼ä¸‹çš„é«˜å‡†ç¡®ç‡
- **è¯¯æŠ¥ç‡**: < 5%

### èµ„æºä½¿ç”¨
- **å†…å­˜å ç”¨**: < 10MBï¼ˆåŒ…å«ç¼“å­˜ï¼‰
- **CPU ä½¿ç”¨**: ä¼˜åŒ–çš„ç®—æ³•ï¼Œä½CPUå ç”¨
- **ç½‘ç»œæµé‡**: ä»…åœ¨åŒæ­¥æ—¶äº§ç”Ÿé¢å¤–æµé‡

## ç»Ÿè®¡ä¿¡æ¯

ç³»ç»Ÿæä¾›è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯ï¼š

```typescript
interface DeduplicationStats {
  totalChecks: number          // æ€»æ£€æŸ¥æ¬¡æ•°
  duplicatesFound: number      // å‘ç°é‡å¤æ•°
  exactDuplicates: number      // å®Œå…¨é‡å¤æ•°
  similarDuplicates: number    // ç›¸ä¼¼é‡å¤æ•°
  avgProcessingTime: number    // å¹³å‡å¤„ç†æ—¶é—´
  cacheHitRate: number         // ç¼“å­˜å‘½ä¸­ç‡
}
```

## æœ€ä½³å®è·µ

### 1. åˆå§‹åŒ–æ—¶æœº
åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–å»é‡æœåŠ¡ï¼š
```typescript
// åœ¨åº”ç”¨å…¥å£å¤„
await contentDeduplicator.initialize()
```

### 2. æ‰¹é‡æ“ä½œä¼˜å…ˆ
å¯¹äºå¤§é‡å¡ç‰‡ï¼Œä¼˜å…ˆä½¿ç”¨æ‰¹é‡æ£€æŸ¥ï¼š
```typescript
// âœ… æ¨èï¼šæ‰¹é‡æ£€æŸ¥
const results = await contentDeduplicator.checkDuplicatesBatch(cards, userId)

// âŒ é¿å…ï¼šå¾ªç¯å•ä¸ªæ£€æŸ¥
for (const card of cards) {
  const result = await contentDeduplicator.checkDuplicate(card, userId)
}
```

### 3. é”™è¯¯å¤„ç†
å¦¥å–„å¤„ç†é‡å¤æ£€æŸ¥é”™è¯¯ï¼š
```typescript
try {
  const result = await contentDeduplicator.checkDuplicate(card, userId)
  // å¤„ç†ç»“æœ
} catch (error) {
  console.warn('é‡å¤æ£€æŸ¥å¤±è´¥ï¼Œç»§ç»­åˆ›å»ºå¡ç‰‡:', error)
  // æ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šæ˜¯å¦ç»§ç»­
}
```

### 4. ç›‘æ§å’Œä¼˜åŒ–
å®šæœŸç›‘æ§æ€§èƒ½æŒ‡æ ‡ï¼š
```typescript
setInterval(() => {
  const stats = contentDeduplicator.getStats()
  console.log('å»é‡ç»Ÿè®¡:', stats)

  // å¦‚æœç¼“å­˜å‘½ä¸­ç‡è¿‡ä½ï¼Œè€ƒè™‘è°ƒæ•´ç¼“å­˜ç­–ç•¥
  if (stats.cacheHitRate < 0.5) {
    console.warn('ç¼“å­˜å‘½ä¸­ç‡è¾ƒä½ï¼Œå»ºè®®ä¼˜åŒ–')
  }
}, 60000)
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. é‡å¤æ£€æŸ¥å¤±è´¥
**é—®é¢˜**: é‡å¤æ£€æŸ¥è¿”å›é”™è¯¯
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸
- æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—

#### 2. æ€§èƒ½é—®é¢˜
**é—®é¢˜**: é‡å¤æ£€æŸ¥é€Ÿåº¦æ…¢
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
- è€ƒè™‘å¢åŠ ç¼“å­˜å¤§å°
- ä½¿ç”¨æ‰¹é‡å¤„ç†ä»£æ›¿å•ä¸ªå¤„ç†

#### 3. å‡†ç¡®æ€§é—®é¢˜
**é—®é¢˜**: è¯¯æŠ¥æˆ–æ¼æŠ¥é‡å¤
**è§£å†³æ–¹æ¡ˆ**:
- è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼
- æ£€æŸ¥å†…å®¹è§„èŒƒåŒ–é€»è¾‘
- æ›´æ–°ç›¸ä¼¼åº¦ç®—æ³•

### è°ƒè¯•æ¨¡å¼
å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```typescript
// åœ¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
localStorage.setItem('debug-deduplicator', 'true')
```

## ç‰ˆæœ¬å†å²

- **v1.0.0**: åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºæœ¬å»é‡åŠŸèƒ½
- **v1.1.0**: æ·»åŠ æ‰¹é‡å¤„ç†æ”¯æŒ
- **v1.2.0**: æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜æœºåˆ¶
- **v1.3.0**: ä¸åŒæ­¥æœåŠ¡é›†æˆ

## è´¡çŒ®æŒ‡å—

å¦‚éœ€æ”¹è¿›å»é‡æœºåˆ¶ï¼Œè¯·éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
1. ä¿æŒå‘åå…¼å®¹æ€§
2. æ·»åŠ ç›¸åº”çš„å•å…ƒæµ‹è¯•
3. æ›´æ–°æ–‡æ¡£å’Œç¤ºä¾‹
4. æ€§èƒ½æµ‹è¯•éªŒè¯

## è®¸å¯è¯

æœ¬åŠŸèƒ½éµå¾ª CardAll é¡¹ç›®çš„å¼€æºè®¸å¯è¯ã€‚