import { Card, CardAction, CardFilter, ViewSettings } from '@/types/card'

/**
 * 存储适配器接口
 * 统一localStorage和IndexedDB的访问接口，支持渐进式迁移
 */
export interface StorageAdapter {
  // 基础信息
  readonly name: string
  readonly version: string

  // 存储模式管理
  getStorageMode(): 'localStorage' | 'indexeddb'
  setStorageMode(mode: 'localStorage' | 'indexeddb'): Promise<void>

  // 数据迁移
  migrateFromLocalStorage(): Promise<MigrationResult>
  backupData(): Promise<BackupResult>
  restoreData(backup: BackupResult): Promise<boolean>

  // 卡片操作
  getCards(filter?: CardFilter): Promise<Card[]>
  getCardById(id: string): Promise<Card | null>
  createCard(card: Omit<Card, 'id' | 'createdAt' | 'updatedAt'>): Promise<Card>
  updateCard(id: string, updates: Partial<Card>): Promise<Card>
  deleteCard(id: string): Promise<boolean>

  // 批量操作
  createCards(cards: Omit<Card, 'id' | 'createdAt' | 'updatedAt'>[]): Promise<Card[]>
  updateCards(updates: Array<{ id: string; updates: Partial<Card> }>): Promise<Card[]>
  deleteCards(ids: string[]): Promise<boolean>

  // 搜索和过滤
  searchCards(query: string, filter?: CardFilter): Promise<Card[]>
  getCardsByTag(tagName: string): Promise<Card[]>
  getCardsByFolder(folderId: string): Promise<Card[]>

  // 统计信息
  getStats(): Promise<StorageStats>

  // 健康检查
  healthCheck(): Promise<HealthCheckResult>

  // 配置管理
  getConfig(): StorageConfig
  updateConfig(config: Partial<StorageConfig>): Promise<void>

  // 事件监听
  addEventListener(event: StorageEventType, listener: StorageEventListener): void
  removeEventListener(event: StorageEventType, listener: StorageEventListener): void
}

/**
 * 迁移结果
 */
export interface MigrationResult {
  success: boolean
  migratedCards: number
  totalCards: number
  errors: string[]
  warnings: string[]
  duration: number
  timestamp: Date
}

/**
 * 备份结果
 */
export interface BackupResult {
  id: string
  data: string
  timestamp: Date
  version: string
  cardCount: number
  checksum: string
}

/**
 * 存储统计信息
 */
export interface StorageStats {
  totalCards: number
  totalFolders: number
  totalTags: number
  totalSize: number
  lastUpdated: Date
  storageMode: 'localStorage' | 'indexeddb'
  indexedDBSize?: number
  localStorageSize?: number
}

/**
 * 健康检查结果
 */
export interface HealthCheckResult {
  healthy: boolean
  score: number
  issues: HealthIssue[]
  recommendations: string[]
  timestamp: Date
}

/**
 * 健康问题
 */
export interface HealthIssue {
  level: 'error' | 'warning' | 'info'
  code: string
  message: string
  details?: any
}

/**
 * 存储配置
 */
export interface StorageConfig {
  autoMigration: boolean
  backupOnMigration: boolean
  compressionEnabled: boolean
  cacheEnabled: boolean
  cacheSize: number
  syncEnabled: boolean
  debugMode: boolean
  performanceMonitoring: boolean
  maxRetries: number
  timeout: number
}

/**
 * 存储事件类型
 */
export type StorageEventType =
  | 'cardsChanged'
  | 'cardCreated'
  | 'cardUpdated'
  | 'cardDeleted'
  | 'migrationStarted'
  | 'migrationCompleted'
  | 'migrationFailed'
  | 'backupCreated'
  | 'backupRestored'
  | 'storageModeChanged'
  | 'error'

/**
 * 存储事件
 */
export interface StorageEvent {
  type: StorageEventType
  timestamp: Date
  data?: any
  error?: Error
}

/**
 * 事件监听器
 */
export type StorageEventListener = (event: StorageEvent) => void

/**
 * 默认配置
 */
export const DEFAULT_STORAGE_CONFIG: StorageConfig = {
  autoMigration: true,
  backupOnMigration: true,
  compressionEnabled: true,
  cacheEnabled: true,
  cacheSize: 1000,
  syncEnabled: true,
  debugMode: false,
  performanceMonitoring: true,
  maxRetries: 3,
  timeout: 30000
}

/**
 * 存储适配器工厂
 */
export class StorageAdapterFactory {
  private static instance: StorageAdapter | null = null

  /**
   * 创建存储适配器实例
   */
  static async create(config?: Partial<StorageConfig>): Promise<StorageAdapter> {
    if (this.instance) {
      return this.instance
    }

    // 动态导入实现类，避免循环依赖
    const { UniversalStorageAdapter } = await import('./universal-storage-adapter')
    this.instance = new UniversalStorageAdapter(config)

    return this.instance
  }

  /**
   * 获取当前实例
   */
  static getInstance(): StorageAdapter | null {
    return this.instance
  }

  /**
   * 重置实例（主要用于测试）
   */
  static resetInstance(): void {
    this.instance = null
  }
}