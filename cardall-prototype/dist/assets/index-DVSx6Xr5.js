const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/sync-ajixoks1.js","assets/supabase-BJjf9Ixn.js","assets/vendor-DBpFvjuy.js","assets/database-Ddn5sgg-.js"])))=>i.map(i=>d[i]);
import{j as s,S as Dn,a as wa,b as ba,P as Rn,C as va,I as Ca,c as ja,d as Sa,R as Na,L as ka,e as Ea,f as Tn,T as An,g as Da,V as In,h as _n,i as Ra,k as Mn,O as Ta,l as On,m as Aa,n as Fn,o as Ia,D as _a,p as Pn,q as Ma,r as Ln,s as $n,t as zn,u as Oa,v as Fa,w as Bn,x as Pa,y as Un,z as Vn,A as La,B as $a,F as za,E as Ba,G as Ua,H as Wn,J as Va,K as Wa,M as Ha,N as Ga,Q as Ka,U as Ya,W as qa,X as Hn,Y as Gn,Z as Ja,_ as Kn,$ as Xa,a0 as Qa,a1 as Yn,a2 as Za,a3 as qn,a4 as er,a5 as tr,a6 as Jn,a7 as Xn,a8 as sr,a9 as Qn,aa as Zn,ab as ar,ac as eo,ad as rr,ae as nr,af as or,ag as ir,ah as lr,ai as to,aj as cr,ak as so,al as dr,am as ur,an as mr,ao}from"./radix-w2nuJgPN.js";import{a as Qt,r as c,R as B,v as ro}from"./vendor-DBpFvjuy.js";import{_ as Os}from"./supabase-BJjf9Ixn.js";import{d as V,u as Ae,a as Me,b as de,c as no,i as oo}from"./sync-ajixoks1.js";import{t as io,c as lo,a as Zt}from"./utils--BulIq_u.js";import{C as es,a as qe,b as fr,S as co,I as gr,X as st,c as uo,E as mo,P as fo,d as go,e as Es,f as ho,g as hr,T as pr,F as qt,h as Fs,i as Ge,H as Ys,j as mt,D as ft,k as qs,l as xr,m as Ds,n as Ps,o as po,p as xo,B as yo,q as wo,r as bo,Z as yr,s as vo,L as Co,t as jo,u as Ee,v as Se,w as Gt,x as Js,R as De,y as wr,z as So,A as No,G as Ke,J as _t,K as Mt,W as Ls,M as ts,N as ko,O as Eo,Q as Do,U as Jt,V as Rs,Y as Ro,_ as Xs,$ as To,a0 as Ao,a1 as Io,a2 as _o,a3 as Et,a4 as Mo,a5 as Dt,a6 as Qs,a7 as hs,a8 as ps,a9 as Oo,aa as Fo}from"./icons-DKLFDR3M.js";import{u as Po,i as Lo,M as $o,a as zo,b as Bo,c as Uo,d as Vo,e as Wo,f as Ho,g as Go,h as Ko,j as Yo,E as qo}from"./editor-yCnBQ_u8.js";import"./database-Ddn5sgg-.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();var Ts={},Zs=Qt;Ts.createRoot=Zs.createRoot,Ts.hydrateRoot=Zs.hydrateRoot;class Rt{static PREFIX="cardall_";static VERSION="1.0";static setItem(e,t,r={}){try{const n=this.PREFIX+e,o={version:this.VERSION,timestamp:Date.now(),data:t,meta:{ttl:r.ttl,encrypted:r.encrypt||!1,compressed:r.compress||!1}};if(r.validate){const l=this.validateData(t);if(!l.isValid)return console.warn("Storage validation failed:",l.errors),!1}let i;try{i=this.serializeData(o)}catch(l){return console.error("Data serialization failed:",l),!1}return r.encrypt&&(i=this.encryptData(i)),r.compress&&(i=this.compressData(i)),localStorage.setItem(n,i),!0}catch(n){return console.error("Failed to store data securely:",n),!1}}static getItem(e,t={}){try{const r=this.PREFIX+e,n=localStorage.getItem(r);if(!n)return null;let o=n;t.compress&&(o=this.decompressData(o)),t.encrypt&&(o=this.decryptData(o));const i=this.deserializeData(o);if(i.version!==this.VERSION)return console.warn("Storage data version mismatch"),null;if(i.meta.ttl&&Date.now()-i.timestamp>i.meta.ttl)return console.log("Storage data expired, removing"),this.removeItem(e),null;if(t.validate){const l=this.validateData(i.data);if(!l.isValid)return console.warn("Retrieved data validation failed:",l.errors),null}return i.data}catch(r){return console.error("Failed to retrieve data securely:",r),null}}static removeItem(e){try{const t=this.PREFIX+e;localStorage.removeItem(t)}catch(t){console.error("Failed to remove storage item:",t)}}static clearAppData(){try{Object.keys(localStorage).forEach(t=>{t.startsWith(this.PREFIX)&&localStorage.removeItem(t)})}catch(e){console.error("Failed to clear app data:",e)}}static validateData(e){const t={isValid:!0,errors:[],warnings:[],sanitized:e};return e==null?t:this.hasPrototypePollution(e)?(t.isValid=!1,t.errors.push("Potential prototype pollution detected"),t):(this.hasCircularReference(e)&&(t.warnings.push("Circular reference detected in data"),t.sanitized=this.removeCircularReferences(e)),this.hasDangerousFunctions(e)?(t.isValid=!1,t.errors.push("Dangerous functions detected in data"),t):(this.estimateDataSize(e)>5*1024*1024&&t.warnings.push("Large data size may impact performance"),t))}static hasPrototypePollution(e){if(typeof e!="object"||e===null)return!1;const t=e;return["__proto__","constructor","prototype"].some(n=>n in t)}static hasCircularReference(e,t=new WeakSet){return typeof e!="object"||e===null?!1:t.has(e)?!0:(t.add(e),Array.isArray(e)?e.some(r=>this.hasCircularReference(r,t)):Object.values(e).some(r=>typeof r=="object"&&this.hasCircularReference(r,t)))}static removeCircularReferences(e,t=new WeakSet){if(typeof e!="object"||e===null)return e;if(t.has(e))return"[Circular]";if(t.add(e),Array.isArray(e))return e.map(n=>this.removeCircularReferences(n,t));const r={};for(const[n,o]of Object.entries(e))r[n]=this.removeCircularReferences(o,t);return r}static hasDangerousFunctions(e){if(typeof e!="object"||e===null)return!1;const t=e;if(Object.values(t).some(o=>typeof o=="function"))return!0;const r=["eval","Function","setTimeout","setInterval","document","window","global","process"],n=JSON.stringify(t).toLowerCase();return r.some(o=>n.includes(o.toLowerCase()))}static estimateDataSize(e){return new Blob([JSON.stringify(e)]).size}static serializeData(e){return JSON.stringify(e,(r,n)=>{if(typeof n!="function")return n===void 0?null:n instanceof Date?{__type:"Date",value:n.toISOString()}:n instanceof RegExp?{__type:"RegExp",value:n.toString()}:n})}static deserializeData(e){return JSON.parse(e,(r,n)=>{if(typeof n=="object"&&n!==null){const o=n;if(o.__type==="Date"&&typeof o.value=="string")return new Date(o.value);if(o.__type==="RegExp"&&typeof o.value=="string"){const i=o.value.match(/^\/(.*)\/([gim]*)$/);if(i)return new RegExp(i[1],i[2])}}return n})}static encryptData(e){const t="cardall-secure-key";let r="";for(let n=0;n<e.length;n++){const o=e.charCodeAt(n)^t.charCodeAt(n%t.length);r+=String.fromCharCode(o)}return btoa(r)}static decryptData(e){const t="cardall-secure-key",r=atob(e);let n="";for(let o=0;o<r.length;o++){const i=r.charCodeAt(o)^t.charCodeAt(o%t.length);n+=String.fromCharCode(i)}return n}static compressData(e){return e}static decompressData(e){return e}static getStorageStats(){try{const t=Object.keys(localStorage).filter(o=>o.startsWith(this.PREFIX));let r=0;const n=[];return t.forEach(o=>{const i=localStorage.getItem(o);if(i){const l=new Blob([i]).size;r+=l,n.push({key:o.replace(this.PREFIX,""),size:l,lastModified:Date.now()})}}),{totalSize:r,itemCount:t.length,items:n}}catch(e){return console.error("Failed to get storage stats:",e),{totalSize:0,itemCount:0,items:[]}}}}const se={set:(a,e,t)=>Rt.setItem(a,e,t),get:(a,e)=>Rt.getItem(a,e),remove:a=>Rt.removeItem(a),clear:()=>Rt.clearAppData(),getStats:()=>Rt.getStorageStats()};class ke{static dbCardToCard(e){const{userId:t,syncVersion:r,lastSyncAt:n,pendingSync:o,...i}=e;return{...i,id:i.id||"",createdAt:this.ensureDate(i.createdAt),updatedAt:this.ensureDate(i.updatedAt)}}static cardToDbCard(e,t){return{id:e.id,frontContent:e.frontContent,backContent:e.backContent,style:e.style,isFlipped:e.isFlipped,createdAt:this.ensureDate(e.createdAt),updatedAt:this.ensureDate(e.updatedAt),userId:t,syncVersion:1,pendingSync:!0,lastSyncAt:void 0}}static bulkDbCardsToCards(e){return e.map(t=>this.dbCardToCard(t))}static bulkCardsToDbCards(e,t){return e.map(r=>this.cardToDbCard(r,t))}static ensureDate(e){if(!e)return new Date;if(e instanceof Date)return e;try{return new Date(e)}catch{return new Date}}static validateCard(e){const t=[];return e.id||t.push("Card ID is required"),e.frontContent?.title||t.push("Front content title is required"),e.backContent?.title||t.push("Back content title is required"),e.createdAt||t.push("Created date is required"),e.updatedAt||t.push("Updated date is required"),{valid:t.length===0,errors:t}}static sanitizeCard(e){const t={};return e.id&&(t.id=e.id),e.frontContent&&(t.frontContent={title:String(e.frontContent.title||"").trim(),text:String(e.frontContent.text||"").trim(),images:Array.isArray(e.frontContent.images)?e.frontContent.images:[],tags:Array.isArray(e.frontContent.tags)?e.frontContent.tags.map(r=>String(r).trim()).filter(r=>r.length>0):[],lastModified:e.frontContent.lastModified||new Date}),e.backContent&&(t.backContent={title:String(e.backContent.title||"").trim(),text:String(e.backContent.text||"").trim(),images:Array.isArray(e.backContent.images)?e.backContent.images:[],tags:Array.isArray(e.backContent.tags)?e.backContent.tags.map(r=>String(r).trim()).filter(r=>r.length>0):[],lastModified:e.backContent.lastModified||new Date}),e.style&&(t.style={type:e.style.type||"solid",backgroundColor:e.style.backgroundColor||"#ffffff",fontFamily:e.style.fontFamily||"system-ui",fontSize:e.style.fontSize||"base",fontWeight:e.style.fontWeight||"normal",textColor:e.style.textColor||"#000000",borderRadius:e.style.borderRadius||"md",shadow:e.style.shadow||"none",borderWidth:e.style.borderWidth||0,gradientColors:e.style.gradientColors||void 0,gradientDirection:e.style.gradientDirection||"to-r"}),typeof e.isFlipped=="boolean"&&(t.isFlipped=e.isFlipped),e.createdAt&&(t.createdAt=this.ensureDate(e.createdAt)),e.updatedAt&&(t.updatedAt=this.ensureDate(e.updatedAt)),t}static loadFromLocalStorage(){try{const e=se.get("cards",{validate:!0,encrypt:!0});if(!e)return[];const t=[];for(const r of e){const n=this.sanitizeCard(r),o=this.validateCard(n);o.valid?t.push(n):console.warn("Invalid card in localStorage:",r,o.errors)}return t}catch(e){return console.error("Failed to load cards from localStorage:",e),[]}}static saveToLocalStorage(e){try{const t=e.map(r=>this.sanitizeCard(r)).filter(r=>this.validateCard(r).valid);se.set("cards",t)}catch(t){throw console.error("Failed to save cards to localStorage:",t),new Error(`Failed to save to localStorage: ${t instanceof Error?t.message:String(t)}`)}}static areCardsEqual(e,t){const r=JSON.stringify(this.sanitizeCard(e)),n=JSON.stringify(this.sanitizeCard(t));return r===n}static detectCardChanges(e,t){const r=new Map(e.map(u=>[u.id,u])),n=new Map(t.map(u=>[u.id,u])),o=[],i=[],l=[];for(const[u,m]of n){const d=r.get(u);d?this.areCardsEqual(d,m)||i.push(m):o.push(m)}for(const[u,m]of r)n.has(u)||l.push(m);return{added:o,updated:i,deleted:l}}static migrateLegacyData(e){try{if(this.isStandardCardFormat(e))return Array.isArray(e)?e:[e];const t=[];if(Array.isArray(e))for(const r of e){const n=this.migrateLegacyCard(r);n&&t.push(n)}else{const r=this.migrateLegacyCard(e);r&&t.push(r)}return t}catch(t){return console.error("Failed to migrate legacy data:",t),[]}}static migrateLegacyCard(e){try{const t={id:e.id||crypto.randomUUID(),frontContent:{title:e.frontTitle||e.title||"",text:e.frontText||e.text||"",images:e.frontImages||e.images||[],tags:e.frontTags||e.tags||[],lastModified:e.lastModified||new Date},backContent:{title:e.backTitle||e.backTitle||"",text:e.backText||e.backText||"",images:e.backImages||[],tags:e.backTags||[],lastModified:e.lastModified||new Date},style:e.style||{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#000000",borderRadius:"md",shadow:"none",borderWidth:0},isFlipped:e.isFlipped||!1,createdAt:this.ensureDate(e.createdAt||e.created||new Date),updatedAt:this.ensureDate(e.updatedAt||e.updated||new Date)},r=this.sanitizeCard(t);return this.validateCard(r).valid?r:null}catch(t){return console.error("Failed to migrate legacy card:",t),null}}static isStandardCardFormat(e){return!e||typeof e!="object"?!1:["id","frontContent","backContent","createdAt","updatedAt"].every(r=>r in e)}static generateCardChecksum(e){const t=this.sanitizeCard(e),r=JSON.stringify(t);let n=0;for(let o=0;o<r.length;o++){const i=r.charCodeAt(o);n=(n<<5)-n+i,n=n&n}return Math.abs(n).toString(16)}static compressCardData(e){const t=e.map(r=>{const n=this.sanitizeCard(r);return{i:n.id,ft:n.frontContent.title,ftx:n.frontContent.text,ftg:n.frontContent.tags,bt:n.backContent.title,btx:n.backContent.text,btg:n.backContent.tags,s:n.style,f:n.isFlipped,ca:n.createdAt.getTime(),ua:n.updatedAt.getTime()}});return JSON.stringify(t)}static decompressCardData(e){try{return JSON.parse(e).map(r=>({id:r.i,frontContent:{title:r.ft||"",text:r.ftx||"",images:[],tags:r.ftg||[],lastModified:new Date},backContent:{title:r.bt||"",text:r.btx||"",images:[],tags:r.btg||[],lastModified:new Date},style:r.s||{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#000000",borderRadius:"md",shadow:"none",borderWidth:0},isFlipped:r.f||!1,createdAt:new Date(r.ca),updatedAt:new Date(r.ua)}))}catch(t){return console.error("Failed to decompress card data:",t),[]}}}const $s={autoMigration:!0,backupOnMigration:!0,compressionEnabled:!0,cacheEnabled:!0,cacheSize:1e3,syncEnabled:!0,debugMode:!1,performanceMonitoring:!0,maxRetries:3,timeout:3e4};function br(a){const e={...$s,...a},t=[],r=[];return(e.cacheSize<0||e.cacheSize>1e4)&&t.push("cacheSize must be between 0 and 10000"),(e.timeout<1e3||e.timeout>3e5)&&r.push("timeout should be between 1000ms and 300000ms"),(e.maxRetries<0||e.maxRetries>10)&&t.push("maxRetries must be between 0 and 10"),{valid:t.length===0,errors:t,warnings:r,config:e}}function ce(a,e,t){return{code:a,message:e,details:t,timestamp:new Date,stack:new Error().stack}}class As{static instance=null;static async create(e){if(this.instance)return this.instance;const t=br(e||{});if(!t.valid)throw ce("INVALID_CONFIG","Invalid storage configuration",{errors:t.errors});try{const{UniversalStorageAdapter:r}=await Os(async()=>{const{UniversalStorageAdapter:n}=await Promise.resolve().then(()=>Xo);return{UniversalStorageAdapter:n}},void 0);this.instance=new r(t.config)}catch(r){throw ce("IMPORT_ERROR","Failed to import storage adapter implementation",{importError:r instanceof Error?r.message:String(r)})}return this.instance}static getInstance(){return this.instance}static resetInstance(){this.instance=null}}const Jo=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_STORAGE_CONFIG:$s,StorageAdapterFactory:As,createStorageError:ce,validateStorageConfig:br},Symbol.toStringTag,{value:"Module"}));class We{name="UniversalStorageAdapter";version="1.0.0";static instance;storageMode="localStorage";config;eventListeners=new Map;STORAGE_MODE_KEY="cardall_storage_mode";MIGRATION_STATUS_KEY="cardall_migration_status";progressCallbacks=new Set;cancelToken=null;constructor(e=$s){this.config=e,this.initializeStorageMode(),this.setupEventListeners()}static getInstance(){return We.instance||(We.instance=new We),We.instance}initializeStorageMode(){try{const e=se.get(this.STORAGE_MODE_KEY);e?this.storageMode=e:(this.storageMode="localStorage",this.saveStorageMode())}catch(e){console.warn("Failed to initialize storage mode:",e),this.storageMode="localStorage"}}saveStorageMode(){try{se.set(this.STORAGE_MODE_KEY,this.storageMode),this.emitEvent({type:"storageModeChanged",timestamp:new Date,data:{mode:this.storageMode}})}catch(e){console.error("Failed to save storage mode:",e)}}getStorageMode(){return this.storageMode}async switchStorageMode(e,t){if(this.storageMode===e)return this.notifyProgress({phase:"completed",percentage:100,message:`Already in ${e} mode`,timestamp:new Date}),{success:!0,message:"Already in requested mode",fromMode:this.storageMode,toMode:e,dataMigrated:!1,rollbackPerformed:!1,validation:{isValid:!0,issues:[]}};const r=this.storageMode,n=Date.now();let o,i=!1,l=!1;const u=[];t?.onProgress&&this.progressCallbacks.add(t.onProgress),this.cancelToken={cancelled:!1};try{this.notifyProgress({phase:"preparing",percentage:5,message:`准备从 ${r} 切换到 ${e}...`,timestamp:new Date}),this.notifyProgress({phase:"validating",percentage:15,message:"验证切换条件...",timestamp:new Date});const m=await this.validatePreSwitchConditions(e);if(!m.isValid)throw this.notifyProgress({phase:"failed",percentage:20,message:`切换前验证失败: ${m.issues.join(", ")}`,details:{issues:m.issues},timestamp:new Date}),new Error(`Pre-switch validation failed: ${m.issues.join(", ")}`);if(this.checkCancellation())throw new Error("Switch cancelled by user");this.config.backupOnMigration&&!t?.skipBackup&&(this.notifyProgress({phase:"backing-up",percentage:30,message:"创建数据备份...",timestamp:new Date}),o=await this.backupData(),this.notifyProgress({phase:"backing-up",percentage:45,message:`备份创建成功: ${o.id}`,details:{backupId:o.id},timestamp:new Date}));const d=e==="indexeddb"&&(await this.hasDataToMigrate()||t?.forceMigration);if(d){this.notifyProgress({phase:"migrating",percentage:50,message:"开始数据迁移...",timestamp:new Date});const p=await this.migrateFromLocalStorage();if(!p.success)throw this.notifyProgress({phase:"failed",percentage:60,message:`数据迁移失败: ${p.errors.join(", ")}`,details:{errors:p.errors},timestamp:new Date}),new Error(`Migration failed: ${p.errors.join(", ")}`);i=!0,this.notifyProgress({phase:"migrating",percentage:70,message:`数据迁移完成: ${p.migratedCards} 张卡片`,details:{migratedCards:p.migratedCards,totalCards:p.totalCards},timestamp:new Date})}if(this.checkCancellation())throw new Error("Switch cancelled by user");this.notifyProgress({phase:"switching",percentage:80,message:`切换存储模式到 ${e}...`,timestamp:new Date}),this.storageMode=e,this.saveStorageMode(),this.notifyProgress({phase:"validating-after",percentage:85,message:"验证切换后数据完整性...",timestamp:new Date});const h=await this.validatePostSwitchConditions(e,r);if(!h.isValid)throw this.notifyProgress({phase:"failed",percentage:90,message:`切换后验证失败: ${h.issues.join(", ")}`,details:{issues:h.issues},timestamp:new Date}),new Error(`Post-switch validation failed: ${h.issues.join(", ")}`);d&&i&&(this.notifyProgress({phase:"cleaning-up",percentage:95,message:"清理旧数据...",timestamp:new Date}),await this.cleanupOldData(r));const g=Date.now()-n;this.notifyProgress({phase:"completed",percentage:100,message:`存储模式切换成功完成，耗时 ${g}ms`,details:{duration:g,dataMigrated:i,fromMode:r,toMode:e},timestamp:new Date}),this.emitEvent({type:"storageModeChanged",timestamp:new Date,data:{fromMode:r,toMode:e,dataMigrated:i,duration:g}});const f={success:!0,message:`Successfully switched from ${r} to ${e}`,fromMode:r,toMode:e,dataMigrated:i,rollbackPerformed:l,duration:g,backup:o,validation:h,progress:u};return this.recordSwitchHistory(f),f}catch(m){if(console.error("Storage mode switch failed:",m),this.notifyProgress({phase:"failed",percentage:0,message:`存储模式切换失败: ${m instanceof Error?m.message:String(m)}`,timestamp:new Date}),o){this.notifyProgress({phase:"rolling-back",percentage:50,message:"正在回滚到原始状态...",timestamp:new Date}),console.log("Attempting rollback...");const g=await this.performRollback(r,o);l=g,g?(this.notifyProgress({phase:"rolled-back",percentage:100,message:"回滚成功",timestamp:new Date}),console.log("Rollback completed successfully")):(this.notifyProgress({phase:"rollback-failed",percentage:100,message:"回滚失败 - 可能需要手动干预",timestamp:new Date}),console.error("Rollback failed - manual intervention may be required"))}else console.log("No backup available, reverting to original mode..."),this.storageMode=r,this.saveStorageMode();const d=m instanceof Error?m.message:String(m);this.emitEvent({type:"error",timestamp:new Date,data:{error:"StorageModeSwitchFailed",details:{fromMode:r,toMode:e,error:d,rollbackPerformed:l}},error:m instanceof Error?m:new Error(d)});const h={success:!1,message:`Failed to switch storage mode: ${d}`,fromMode:r,toMode:e,dataMigrated:i,rollbackPerformed:l,validation:{isValid:!1,issues:[d]},progress:u};throw this.recordSwitchHistory(h),ce("STORAGE_MODE_SWITCH_FAILED",`Failed to switch storage mode: ${d}`,{fromMode:r,toMode:e,error:d,rollbackPerformed:l})}finally{t?.onProgress&&this.progressCallbacks.delete(t.onProgress),this.cancelToken=null}}async setStorageMode(e){try{const t=await this.switchStorageMode(e);if(!t.success)throw new Error(t.message)}catch(t){throw this.storageMode!==e&&(this.storageMode=e==="indexeddb"?"localStorage":"indexeddb",this.saveStorageMode()),t}}cancelStorageModeSwitch(e="用户取消"){this.cancelToken&&(this.cancelToken.cancelled=!0,this.cancelToken.reason=e,this.notifyProgress({phase:"cancelled",percentage:0,message:`操作已取消: ${e}`,timestamp:new Date}))}checkCancellation(){return this.cancelToken?.cancelled||!1}notifyProgress(e){this.progressCallbacks.forEach(t=>{try{t(e)}catch(r){console.warn("Progress callback error:",r)}}),this.emitEvent({type:"storageModeSwitchProgress",timestamp:new Date,data:e})}isSwitchInProgress(){return this.cancelToken!==null}async getStorageModeStats(){try{const e=se.get("storage_switch_history",[])||[],t=e.length,r=e[e.length-1],n=e.filter(h=>h.success===!1).length,o=typeof localStorage<"u",i=await this.isIndexedDBAvailable();let l=0,u=0,m=0,d=0;try{const h=se.get("cards",{validate:!0,encrypt:!0});h&&(l=h.length,m=JSON.stringify(h).length)}catch(h){console.warn("Failed to check localStorage data:",h)}try{if(i){u=await V.cards.count();const h=await V.cards.toArray();d=JSON.stringify(h).length}}catch(h){console.warn("Failed to check IndexedDB data:",h)}return{currentMode:this.storageMode,switchCount:t,lastSwitchTime:r?.timestamp?new Date(r.timestamp):void 0,lastSwitchDuration:r?.duration,failedSwitches:n,availableStorage:{localStorage:o,indexedDB:i},dataDistribution:{localStorageCards:l,indexedDBCards:u,localStorageSize:m,indexedDBSize:d}}}catch(e){throw console.error("Failed to get storage mode stats:",e),ce("GET_STORAGE_STATS_FAILED","Failed to get storage mode statistics",{error:e instanceof Error?e.message:String(e)})}}recordSwitchHistory(e){try{const t=se.get("storage_switch_history",[])||[];t.push({timestamp:new Date().toISOString(),fromMode:e.fromMode,toMode:e.toMode,success:e.success,duration:e.duration,dataMigrated:e.dataMigrated,rollbackPerformed:e.rollbackPerformed,message:e.message}),t.length>50&&t.splice(0,t.length-50),se.set("storage_switch_history",t)}catch(t){console.warn("Failed to record switch history:",t)}}clearSwitchHistory(){try{se.remove("storage_switch_history"),console.log("Storage switch history cleared")}catch(e){console.warn("Failed to clear switch history:",e)}}async getRecommendedStorageMode(){const e=[];try{const t=await this.getStorageModeStats(),r=t.availableStorage.indexedDB,n=t.availableStorage.localStorage;return r?t.dataDistribution.localStorageSize+t.dataDistribution.indexedDBSize>5*1024*1024?{recommendedMode:"indexeddb",reason:"Large data volume detected, IndexedDB is more suitable",confidence:"high",issues:[]}:t.failedSwitches===0||t.failedSwitches/t.switchCount<.2?{recommendedMode:t.currentMode,reason:"Current storage mode is working well",confidence:"medium",issues:[]}:{recommendedMode:"indexeddb",reason:"IndexedDB offers better performance and reliability",confidence:"medium",issues:[]}:{recommendedMode:"localStorage",reason:"IndexedDB is not available in this browser",confidence:"high",issues:["IndexedDB not supported"]}}catch(t){return e.push(`Failed to analyze storage recommendations: ${t instanceof Error?t.message:String(t)}`),{recommendedMode:"localStorage",reason:"Failed to analyze, using safe option",confidence:"low",issues:e}}}async validatePreSwitchConditions(e){const t=[],r=[],n={};try{if(e==="indexeddb"){const l=await this.isIndexedDBAvailable();l||t.push("IndexedDB is not available in this environment"),n.indexedDBAvailable=l}const o=await this.validateDataIntegrity();if(o.isValid||(t.push("Current data integrity check failed"),t.push(...o.issues)),n.currentDataValidation=o,e==="indexeddb"&&await this.hasDataToMigrate()){const l=await this.getCards(),u=JSON.stringify(l).length;if(navigator.storage&&navigator.storage.estimate)try{const m=await navigator.storage.estimate(),d=(m.quota||0)-(m.usage||0);d<u*2&&r.push("Available storage space may be insufficient"),n.storageQuota={total:m.quota,used:m.usage,available:d,required:u}}catch{r.push("Unable to estimate storage space")}}const i=this.checkBrowserCompatibility(e);return i.compatible||t.push(...i.issues),n.browserCompatibility=i,{isValid:t.length===0,issues:t,warnings:r.length>0?r:void 0,details:n}}catch(o){return{isValid:!1,issues:[`Pre-switch validation error: ${o instanceof Error?o.message:String(o)}`],warnings:r.length>0?r:void 0,details:n}}}async validatePostSwitchConditions(e,t){const r=[],n=[],o={};try{const i=Date.now();await this.getCards(),o.dataAccessTime=Date.now()-i;const l=await this.validateDataIntegrity(e);if(l.isValid||(r.push("New mode data integrity check failed"),r.push(...l.issues)),o.newDataValidation=l,t==="localStorage"&&e==="indexeddb"){const m=await this.validateMigrationConsistency();m.isValid||(r.push("Data consistency check failed"),r.push(...m.issues)),o.consistencyCheck=m}const u=await this.validateStoragePerformance(e);return u.warnings.length>0&&n.push(...u.warnings),o.performanceCheck=u,{isValid:r.length===0,issues:r,warnings:n.length>0?n:void 0,details:o}}catch(i){return{isValid:!1,issues:[`Post-switch validation error: ${i instanceof Error?i.message:String(i)}`],warnings:n.length>0?n:void 0,details:o}}}async performRollback(e,t){const r=Date.now();console.log(`Starting enhanced rollback to ${e}...`);try{console.log("Phase 1: Pre-rollback state check...");const n=this.storageMode,o=await this.getStats();console.log(`Current state: ${n}, ${o.totalCards} cards`),console.log("Phase 2: Creating pre-rollback safety backup...");const i=await this.createSafetyBackup();console.log(`Safety backup created: ${i?.id||"N/A"}`),console.log("Phase 3: Setting temporary storage mode...");const l=n;this.storageMode="rollback_temp",this.saveStorageMode(),console.log("Phase 4: Validating backup integrity...");const u=await this.validateBackupIntegrity(t);if(!u.isValid)throw new Error(`Backup integrity validation failed: ${u.issues.join(", ")}`);console.log("Phase 5: Restoring storage mode..."),this.storageMode=e,this.saveStorageMode(),console.log("Phase 6: Restoring data...");const m=await this.enhancedRestoreData(t);if(!m.success)throw new Error(`Data restoration failed: ${m.issues.join(", ")}`);console.log(`Restored ${m.restoredCards} cards`),console.log("Phase 7: Post-rollback validation...");const d=await this.validateDataIntegrity(e);if(!d.isValid&&(console.warn(`Post-rollback validation issues: ${d.issues.join(", ")}`),d.corruptedCards.length>0)){console.log("Attempting data repair...");const g=await this.repairDataIntegrity();if(console.log(`Repair result: ${g.repaired?"SUCCESS":"FAILED"}`),!g.repaired)throw new Error(`Post-rollback data repair failed: ${g.issues.join(", ")}`)}i&&(console.log("Phase 8: Cleaning up safety backup..."),await this.cleanupSafetyBackup(i.id));const h=Date.now()-r;return console.log(`Enhanced rollback completed successfully in ${h}ms`),this.emitEvent({type:"backupRestored",timestamp:new Date,data:{backupId:t.id,rollback:!0,duration:h,restoredCards:m.restoredCards,targetMode:e}}),!0}catch(n){const o=`Rollback failed: ${n instanceof Error?n.message:String(n)}`;console.error(o);try{console.log("Attempting emergency recovery..."),this.storageMode=e,this.saveStorageMode(),this.emitEvent({type:"error",timestamp:new Date,data:{error:"RollbackFailed",details:{targetMode:e,error:o,emergencyRecovery:!0}},error:n instanceof Error?n:new Error(o)})}catch(i){console.error("Emergency recovery also failed:",i)}return!1}}async createSafetyBackup(){try{const e=await this.getCards(),t={timestamp:new Date().toISOString(),version:this.version,purpose:"rollback_safety",cards:e},r=JSON.stringify(t),n=`safety_backup_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;se.set(n,t);const o=await this.calculateChecksum(r);return{id:n,data:r,timestamp:new Date,version:this.version,cardCount:e.length,checksum:o}}catch(e){return console.warn("Failed to create safety backup:",e),null}}async validateBackupIntegrity(e){const t=[],r={};try{const n=await this.calculateChecksum(e.data);r.checksumMatch=n===e.checksum,r.backupChecksum=e.checksum,r.currentChecksum=n,n!==e.checksum&&t.push("Backup checksum mismatch - data may be corrupted");try{const i=JSON.parse(e.data);if(r.dataFormatValid=!0,!i.cards||!Array.isArray(i.cards))t.push("Invalid backup data format - missing or invalid cards array"),r.cardsValid=!1;else{r.cardsValid=!0,r.cardCount=i.cards.length;const l=Math.min(5,i.cards.length),u=i.cards.slice(0,l),m=[];for(let d=0;d<u.length;d++){const h=u[d],g=this.validateCardStructure(h);g.length>0&&m.push(`Card at index ${d}: ${g.join(", ")}`)}m.length>0?(t.push(`Card structure issues found: ${m.join("; ")}`),r.structureIssues=m):r.structureValid=!0}}catch(i){t.push(`Backup data parsing failed: ${i instanceof Error?i.message:String(i)}`),r.dataFormatValid=!1}const o=Date.now()-e.timestamp.getTime();return r.backupAgeMs=o,r.backupAgeHours=o/(1e3*60*60),o>24*60*60*1e3&&t.push("Backup is more than 24 hours old"),{isValid:t.length===0,issues:t,details:r}}catch(n){return t.push(`Backup validation failed: ${n instanceof Error?n.message:String(n)}`),{isValid:!1,issues:t,details:r}}}async enhancedRestoreData(e){const t=[];let r=0;try{const n=JSON.parse(e.data);if(!n.cards||!Array.isArray(n.cards))throw new Error("Invalid backup data format");if(console.log("Clearing current data..."),this.storageMode==="indexeddb"&&await V.cards.clear(),se.remove("cards"),console.log(`Restoring ${n.cards.length} cards...`),this.storageMode==="indexeddb"){const i=n.cards.map(l=>this.convertToDbCard(l));try{await V.cards.bulkAdd(i),r=i.length}catch(l){console.warn("Bulk restore failed, trying individual restore..."),t.push(`Bulk restore failed: ${l instanceof Error?l.message:String(l)}`),r=0;for(const u of n.cards)try{const m=this.convertToDbCard(u);await V.cards.add(m),r++}catch(m){t.push(`Failed to restore card ${u.id}: ${m instanceof Error?m.message:String(m)}`)}}}else se.set("cards",n.cards),r=n.cards.length;const o=await this.validateDataIntegrity(this.storageMode);return o.isValid?console.log(`Data integrity check passed for ${o.cardCount} cards`):t.push(...o.issues.map(i=>`Validation: ${i}`)),{success:t.length===0||r>0&&t.length<r*.1,restoredCards:r,issues:t}}catch(n){return t.push(`Enhanced restore failed: ${n instanceof Error?n.message:String(n)}`),{success:!1,restoredCards:r,issues:t}}}async cleanupSafetyBackup(e){try{se.remove(e),console.log(`Safety backup ${e} cleaned up`)}catch(t){console.warn(`Failed to cleanup safety backup ${e}:`,t)}}async cleanupOldData(e){try{if(e==="localStorage"){const t=se.get("cards",{validate:!0,encrypt:!0});t&&t.length>0&&(console.log("Cleaning up localStorage data..."),se.remove("cards"),console.log("localStorage data cleaned up"))}else e==="indexeddb"&&await this.hasIndexedDBData()&&(console.log("Cleaning up IndexedDB data..."),await V.cards.clear(),console.log("IndexedDB data cleaned up"))}catch(t){console.warn("Failed to cleanup old data:",t)}}async validateMigrationConsistency(){const e=[],t=[],r={};try{console.log("Starting migration consistency validation...");const n=await V.cards.count();r.indexedDBCount=n;const o=se.get("cards",{validate:!0,encrypt:!0});if(r.localStorageCards=o?.length||0,o&&o.length>0){n!==o.length&&e.push(`Card count mismatch: IndexedDB has ${n}, localStorage had ${o.length}`);const l=Math.min(10,o.length),u=o.slice(0,l),m={};for(const f of u){const p={id:f.id,title:f.frontContent.title,found:!1,contentMatch:!1,tagsMatch:!1,timestampMatch:!1};try{const b=await V.cards.get(f.id);if(!b){e.push(`Card ${f.id} not found in IndexedDB`),p.found=!1,m[f.id]=p;continue}p.found=!0;const C=this.convertFromDbCard(b),v=C.frontContent.title===f.frontContent.title,y=C.backContent.title===f.backContent.title;p.contentMatch=v&&y;const x=C.frontContent.text===f.frontContent.text&&C.backContent.text===f.backContent.text;p.contentMatch=p.contentMatch&&x;const j=JSON.stringify(C.frontContent.tags.sort())===JSON.stringify(f.frontContent.tags.sort()),N=JSON.stringify(C.backContent.tags.sort())===JSON.stringify(f.backContent.tags.sort());p.tagsMatch=j&&N;const E=C.createdAt.getTime()===f.createdAt.getTime()&&C.updatedAt.getTime()===f.updatedAt.getTime();p.timestampMatch=E,m[f.id]=p,p.found||e.push(`Card ${f.id} missing in IndexedDB`),p.contentMatch||e.push(`Content mismatch for card ${f.id}`),p.tagsMatch||t.push(`Tags mismatch for card ${f.id}`),p.timestampMatch||t.push(`Timestamp mismatch for card ${f.id}`)}catch(b){console.warn(`Error validating card ${f.id}:`,b),e.push(`Validation error for card ${f.id}: ${b instanceof Error?b.message:String(b)}`)}}r.sampleValidation=m;const d=Object.keys(m).length*4,h=Object.values(m).reduce((f,p)=>f+(p.found?1:0)+(p.contentMatch?1:0)+(p.tagsMatch?1:0)+(p.timestampMatch?1:0),0),g=d>0?h/d*100:0;r.consistencyScore=g,g<95&&t.push(`Migration consistency score is ${g.toFixed(1)}%`);try{const f=await V.cards.toArray(),p=new Set,b=new Set;f.forEach(C=>{p.has(C.id)?b.add(C.id):p.add(C.id)}),b.size>0&&e.push(`Found duplicate card IDs: ${Array.from(b).join(", ")}`)}catch(f){t.push(`Could not validate ID uniqueness: ${f instanceof Error?f.message:String(f)}`)}try{const f=await V.cards.toArray(),p=await this.validateDatabaseStructure(f);p.length>0&&e.push(...p)}catch(f){t.push(`Structure validation failed: ${f instanceof Error?f.message:String(f)}`)}}else o===null&&t.push("Original localStorage data not available for comparison");const i=e.length===0;return console.log(`Migration consistency validation completed: ${i?"PASS":"FAIL"}`),i||console.warn(`Found ${e.length} issues and ${t.length} warnings`),{isValid:i,issues:e,warnings:t.length>0?t:void 0,details:r}}catch(n){const o=`Migration consistency check failed: ${n instanceof Error?n.message:String(n)}`;return console.error(o),{isValid:!1,issues:[o],warnings:t.length>0?t:void 0,details:r}}}async validateDatabaseStructure(e){const t=[];try{for(let r=0;r<e.length;r++){const n=e[r],o=["id","frontContent","backContent","createdAt","updatedAt"];for(const i of o)i in n||t.push(`Card at index ${r} missing required field: ${i}`);if(typeof n.id!="string"&&t.push(`Card ${n.id} has invalid ID type`),n.frontContent&&typeof n.frontContent!="object"&&t.push(`Card ${n.id} has invalid frontContent type`),n.backContent&&typeof n.backContent!="object"&&t.push(`Card ${n.id} has invalid backContent type`),n.createdAt)try{new Date(n.createdAt)}catch{t.push(`Card ${n.id} has invalid createdAt format`)}if(n.updatedAt)try{new Date(n.updatedAt)}catch{t.push(`Card ${n.id} has invalid updatedAt format`)}}}catch(r){t.push(`Structure validation error: ${r instanceof Error?r.message:String(r)}`)}return t}async validateStoragePerformance(e){const t=[],r={};try{const n=Date.now();await this.getCards(),r.readTime=Date.now()-n;const o=await this.createCard({frontContent:{title:"Performance Test",text:"Test content",tags:[]},backContent:{title:"Performance Test Back",text:"Test back content",tags:[]},style:{type:"solid"},isFlipped:!1}),i=Date.now();return await this.updateCard(o.id,{frontContent:{...o.frontContent,text:"Updated test content"}}),r.writeTime=Date.now()-i,await this.deleteCard(o.id),e==="indexeddb"&&r.readTime>1e3&&t.push("IndexedDB read performance is slow"),e==="localStorage"&&r.readTime>500&&t.push("LocalStorage read performance is slow"),{warnings:t,metrics:r}}catch(n){return t.push(`Performance validation failed: ${n instanceof Error?n.message:String(n)}`),{warnings:t,metrics:r}}}checkBrowserCompatibility(e){const t=[],r={};try{if(r.localStorageSupported=typeof localStorage<"u",r.indexedDBSupported=typeof indexedDB<"u",r.serviceWorkerSupported="serviceWorker"in navigator,e==="indexeddb"){r.indexedDBSupported||t.push("IndexedDB is not supported in this browser");try{const n=indexedDB.open("test_db",1);r.indexedDBOpenable=!0,n.onsuccess=()=>{n.result.close(),indexedDB.deleteDatabase("test_db")}}catch{r.indexedDBOpenable=!1,t.push("IndexedDB cannot be opened in this browser")}}return e==="localStorage"&&!r.localStorageSupported&&t.push("LocalStorage is not supported in this browser"),{compatible:t.length===0,issues:t,details:r}}catch(n){return{compatible:!1,issues:[`Browser compatibility check failed: ${n instanceof Error?n.message:String(n)}`],details:r}}}async hasDataToMigrate(){if(this.storageMode==="indexeddb")return!1;const e=se.get("cards",{validate:!0,encrypt:!0});return e?e.length>0:!1}async migrateFromLocalStorage(){const e=Date.now();this.emitEvent({type:"migrationStarted",timestamp:new Date});try{if(!await this.hasDataToMigrate()){const l={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:[],duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationCompleted",timestamp:new Date,data:l}),l}const r=se.get("cards",{validate:!0,encrypt:!0});if(!r||r.length===0){const l={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:[],duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationCompleted",timestamp:new Date,data:l}),l}let n;this.config.backupOnMigration&&(n=await this.backupData());const o=await this.performMigration(r);if(await this.validateMigration(r.length)&&o.success){await this.setStorageMode("indexeddb"),o.errors.length===0&&this.cleanupLocalStorage();const l={...o,totalCards:r.length,duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationCompleted",timestamp:new Date,data:l}),l}else{n&&await this.restoreData(n);const l={success:!1,migratedCards:0,totalCards:r.length,errors:["Migration validation failed"],warnings:o.warnings,duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationFailed",timestamp:new Date,data:l,error:new Error("Migration validation failed")}),l}}catch(t){const r={success:!1,migratedCards:0,totalCards:0,errors:[t instanceof Error?t.message:"Unknown migration error"],warnings:[],duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationFailed",timestamp:new Date,data:r,error:t instanceof Error?t:new Error(String(t))}),r}}async performMigration(e){const t=[],r=[];let n=0;try{const o=e.map(i=>this.convertToDbCard(i));return await V.cards.bulkAdd(o),n=o.length,{success:!0,migratedCards:n,totalCards:e.length,errors:[],warnings:r,duration:0,timestamp:new Date}}catch(o){console.error("Bulk migration failed:",o);for(const l of e)try{const u=this.convertToDbCard(l);await V.cards.add(u),n++}catch(u){console.error(`Failed to migrate card ${l.id}:`,u),t.push(l.id)}const i=t.length===0;return i||r.push(`Some cards failed to migrate: ${t.length} out of ${e.length}`),{success:i,migratedCards:n,totalCards:e.length,errors:t,warnings:r,duration:0,timestamp:new Date}}}async validateMigration(e){try{return await V.cards.count()===e}catch(t){return console.error("Migration validation failed:",t),!1}}cleanupLocalStorage(){try{se.remove("cards")}catch(e){console.warn("Failed to cleanup localStorage:",e)}}async backupData(){const e=await this.getCards(),t={timestamp:new Date().toISOString(),version:this.version,cards:e},r=JSON.stringify(t),n=`backup_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;se.set(n,t);const o=await this.calculateChecksum(r),i={id:n,data:r,timestamp:new Date,version:this.version,cardCount:e.length,checksum:o};return this.emitEvent({type:"backupCreated",timestamp:new Date,data:i}),i}async restoreData(e){try{if(await this.calculateChecksum(e.data)!==e.checksum)throw new Error("Backup data integrity check failed");const r=JSON.parse(e.data);if(!r.cards||!Array.isArray(r.cards))throw new Error("Invalid backup data format");if(this.storageMode==="indexeddb"){const n=r.cards.map(o=>this.convertToDbCard(o));await V.cards.clear(),await V.cards.bulkAdd(n)}else se.set("cards",r.cards);return this.emitEvent({type:"backupRestored",timestamp:new Date,data:{backupId:e.id,cardCount:e.cardCount}}),!0}catch(t){return console.error("Restore failed:",t),!1}}async calculateChecksum(e){let t=0;for(let r=0;r<e.length;r++){const n=e.charCodeAt(r);t=(t<<5)-t+n,t=t&t}return Math.abs(t).toString(16)}convertToDbCard(e){return{id:e.id,frontContent:e.frontContent,backContent:e.backContent,style:e.style,isFlipped:e.isFlipped,createdAt:e.createdAt,updatedAt:e.updatedAt,userId:void 0,syncVersion:1,pendingSync:!0,lastSyncAt:void 0}}convertFromDbCard(e){const{userId:t,syncVersion:r,lastSyncAt:n,pendingSync:o,...i}=e;return{...i,id:i.id||"",createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)}}async getCards(e){try{if(this.storageMode==="indexeddb"){const r=(await V.cards.toArray()).map(n=>this.convertFromDbCard(n));return e?this.applyFilter(r,e):r}else{const t=se.get("cards",{validate:!0,encrypt:!0})||[];return e?this.applyFilter(t,e):t}}catch(t){throw ce("GET_CARDS_FAILED","Failed to get cards",{error:t instanceof Error?t.message:String(t)})}}applyFilter(e,t){return e.filter(r=>{if(t.searchTerm){const n=t.searchTerm.toLowerCase(),o=r.frontContent.title.toLowerCase().includes(n)||r.backContent.title.toLowerCase().includes(n),i=r.frontContent.text.toLowerCase().includes(n)||r.backContent.text.toLowerCase().includes(n);if(!o&&!i)return!1}if(t.tags&&t.tags.length>0){const n=[...r.frontContent.tags,...r.backContent.tags];if(!t.tags.some(i=>n.includes(i)))return!1}return!0})}async getCardById(e){try{if(this.storageMode==="indexeddb"){const t=await V.cards.get(e);return t?this.convertFromDbCard(t):null}else return(await this.getCards()).find(r=>r.id===e)||null}catch(t){throw ce("GET_CARD_FAILED",`Failed to get card ${e}`,{error:t instanceof Error?t.message:String(t)})}}async createCard(e){const t=new Date,r={...e,id:crypto.randomUUID(),createdAt:t,updatedAt:t};try{if(this.storageMode==="indexeddb"){const n=this.convertToDbCard(r);await V.cards.add(n)}else{const n=await this.getCards();n.push(r),await this.saveCards(n)}return this.emitEvent({type:"cardCreated",timestamp:new Date,data:{card:r}}),r}catch(n){throw ce("CREATE_CARD_FAILED","Failed to create card",{error:n instanceof Error?n.message:String(n)})}}async updateCard(e,t){try{if(this.storageMode==="indexeddb"){const r=await V.cards.get(e);if(!r)throw ce("CARD_NOT_FOUND",`Card ${e} not found`);const n={...r,...t,updatedAt:new Date};return await V.cards.put(n),this.convertFromDbCard(n)}else{const r=await this.getCards(),n=r.findIndex(o=>o.id===e);if(n===-1)throw ce("CARD_NOT_FOUND",`Card ${e} not found`);return r[n]={...r[n],...t,updatedAt:new Date},await this.saveCards(r),r[n]}}catch(r){throw ce("UPDATE_CARD_FAILED",`Failed to update card ${e}`,{error:r instanceof Error?r.message:String(r)})}}async deleteCard(e){try{if(this.storageMode==="indexeddb")await V.cards.delete(e);else{const r=(await this.getCards()).filter(n=>n.id!==e);await this.saveCards(r)}return this.emitEvent({type:"cardDeleted",timestamp:new Date,data:{cardId:e}}),!0}catch(t){throw ce("DELETE_CARD_FAILED",`Failed to delete card ${e}`,{error:t instanceof Error?t.message:String(t)})}}async saveCards(e){try{if(this.storageMode==="indexeddb"){const t=e.map(r=>this.convertToDbCard(r));await V.cards.clear(),await V.cards.bulkAdd(t)}else se.set("cards",e);this.emitEvent({type:"cardsChanged",timestamp:new Date,data:{cardCount:e.length}})}catch(t){throw ce("SAVE_CARDS_FAILED","Failed to save cards",{error:t instanceof Error?t.message:String(t)})}}async createCards(e){const t=new Date,r=e.map(n=>({...n,id:crypto.randomUUID(),createdAt:t,updatedAt:t}));try{if(this.storageMode==="indexeddb"){const n=r.map(o=>this.convertToDbCard(o));await V.cards.bulkAdd(n)}else{const n=await this.getCards();n.push(...r),await this.saveCards(n)}return r}catch(n){throw ce("CREATE_CARDS_FAILED","Failed to create cards",{error:n instanceof Error?n.message:String(n)})}}async updateCards(e){const t=[];try{if(this.storageMode==="indexeddb")for(const{id:r,updates:n}of e){const o=await this.updateCard(r,n);t.push(o)}else{const r=await this.getCards();for(const{id:n,updates:o}of e){const i=r.findIndex(l=>l.id===n);i!==-1&&(r[i]={...r[i],...o,updatedAt:new Date},t.push(r[i]))}await this.saveCards(r)}return t}catch(r){throw ce("UPDATE_CARDS_FAILED","Failed to update cards",{error:r instanceof Error?r.message:String(r)})}}async deleteCards(e){try{if(this.storageMode==="indexeddb")await V.cards.bulkDelete(e);else{const r=(await this.getCards()).filter(n=>!e.includes(n.id));await this.saveCards(r)}return!0}catch(t){throw ce("DELETE_CARDS_FAILED","Failed to delete cards",{error:t instanceof Error?t.message:String(t)})}}async searchCards(e,t){const r={...t,searchTerm:e};return this.getCards(r)}async getCardsByTag(e){const t={searchTerm:"",tags:[e]};return this.getCards(t)}async getCardsByFolder(e){return(await this.getCards()).filter(r=>r.folderId===e)}async getStats(){try{let e=0,t=0,r=0;if(this.storageMode==="indexeddb"){e=await V.cards.count();const i=await V.cards.toArray();r=JSON.stringify(i).length}else{const i=await this.getCards();e=i.length,t=JSON.stringify(i).length}const n=Math.max(t,r);return{totalCards:e,totalFolders:0,totalTags:0,totalSize:n,lastUpdated:new Date,storageMode:this.storageMode,indexedDBSize:r>0?r:void 0,localStorageSize:t>0?t:void 0}}catch(e){throw ce("GET_STATS_FAILED","Failed to get storage stats",{error:e instanceof Error?e.message:String(e)})}}async healthCheck(){const e=[],t=[];let r=100;try{if(await this.getCards(),this.storageMode==="indexeddb")try{await V.cards.count()}catch(n){e.push({level:"error",code:"INDEXEDDB_ACCESS_FAILED",message:"Cannot access IndexedDB",details:{error:n instanceof Error?n.message:String(n)}}),r-=40}try{se.get("test")}catch(n){e.push({level:"warning",code:"LOCALSTORAGE_ACCESS_FAILED",message:"Cannot access localStorage",details:{error:n instanceof Error?n.message:String(n)}}),r-=20}if(this.storageMode==="indexeddb"){const n=await this.getStats();n.totalSize>50*1024*1024&&(e.push({level:"warning",code:"LARGE_STORAGE_SIZE",message:"Storage size is large",details:{size:n.totalSize}}),r-=10,t.push("Consider archiving old cards"))}return{healthy:r>=70,score:Math.max(0,r),issues:e,recommendations:t,timestamp:new Date}}catch(n){return{healthy:!1,score:0,issues:[{level:"error",code:"HEALTH_CHECK_FAILED",message:"Health check failed",details:{error:n instanceof Error?n.message:String(n)}}],recommendations:["Check storage permissions and browser compatibility"],timestamp:new Date}}}getConfig(){return{...this.config}}async isIndexedDBAvailable(){try{if(typeof window>"u")return console.warn("IndexedDB not available: not in browser environment"),!1;if(!("indexedDB"in window))return console.warn("IndexedDB not available: indexedDB not supported in this browser"),!1;if(!window.indexedDB||typeof window.indexedDB.open!="function")return console.warn("IndexedDB not available: IDBFactory interface not available"),!1;try{const e="cardall_availability_test",t=window.indexedDB.open(e,1);return new Promise(r=>{let n;const o=()=>{n&&clearTimeout(n);try{window.indexedDB.deleteDatabase(e)}catch(i){console.debug("Failed to cleanup test database:",i)}};n=window.setTimeout(()=>{console.warn("IndexedDB availability test timed out"),o(),r(!1)},5e3),t.onerror=i=>{console.warn("IndexedDB availability test failed:",i),o(),r(!1)},t.onblocked=()=>{console.warn("IndexedDB availability test blocked"),o(),r(!1)},t.onsuccess=()=>{const i=t.result;try{i.close(),o(),console.debug("IndexedDB availability test passed"),r(!0)}catch(l){console.warn("Failed to close test database:",l),o(),r(!1)}},t.onupgradeneeded=i=>{console.debug("IndexedDB upgrade needed during availability test")}})}catch(e){return console.warn("IndexedDB availability test error:",e),!1}}catch(e){return console.warn("IndexedDB not available:",e),!1}}async hasIndexedDBData(){try{if(!await this.isIndexedDBAvailable())return console.debug("IndexedDB data check: IndexedDB not available"),!1;try{if(!V.isOpen())try{await V.open()}catch(n){return console.warn("Failed to open database for data check:",n),!1}let t;try{t=await V.cards.count(),console.debug(`IndexedDB card count: ${t}`)}catch(n){return console.warn("Failed to get card count:",n),!1}return t>0||await this.checkOtherDataTables()?!0:(console.debug("IndexedDB data check: no data found"),!1)}catch(t){return console.warn("Database operation failed during data check:",t),!1}}catch(e){return console.warn("Failed to check IndexedDB data:",e),!1}}async checkOtherDataTables(){try{try{const e=await V.folders.count();if(e>0)return console.debug(`Found ${e} folders in IndexedDB`),!0}catch(e){console.debug("Failed to check folders:",e)}try{const e=await V.tags.count();if(e>0)return console.debug(`Found ${e} tags in IndexedDB`),!0}catch(e){console.debug("Failed to check tags:",e)}try{const e=await V.images.count();if(e>0)return console.debug(`Found ${e} images in IndexedDB`),!0}catch(e){console.debug("Failed to check images:",e)}try{const e=await V.settings.count();if(e>0)return console.debug(`Found ${e} settings in IndexedDB`),!0}catch(e){console.debug("Failed to check settings:",e)}return!1}catch(e){return console.debug("Error checking other data tables:",e),!1}}async validateDataIntegrity(e){const t=e||this.storageMode,r=[],n=[];try{console.log(`Validating data integrity for ${t}...`);const o=await this.getCards();if(!Array.isArray(o))return r.push("Cards data is not an array"),{isValid:!1,issues:r,cardCount:0,corruptedCards:n};for(const u of o){const m=this.validateCardStructure(u);m.length>0&&(n.push(u.id||"unknown"),r.push(`Card ${u.id||"unknown"} has issues: ${m.join(", ")}`))}if(t==="indexeddb"){const u=await V.cards.toArray();u.length!==o.length&&r.push(`Card count mismatch: IndexedDB has ${u.length}, adapter returned ${o.length}`)}const i=this.validateTimestamps(o);r.push(...i);const l=r.length===0;return console.log(`Data integrity validation completed: ${l?"PASS":"FAIL"}`),l||console.warn(`Found ${r.length} issues`),{isValid:l,issues:r,cardCount:o.length,corruptedCards:n}}catch(o){const i=`Data integrity validation failed: ${o instanceof Error?o.message:String(o)}`;return r.push(i),console.error(i),{isValid:!1,issues:r,cardCount:0,corruptedCards:n}}}validateCardStructure(e){const t=[];return(!e.id||typeof e.id!="string")&&t.push("Missing or invalid id"),!e.frontContent||typeof e.frontContent!="object"?t.push("Missing or invalid frontContent"):((!e.frontContent.title||typeof e.frontContent.title!="string")&&t.push("Missing or invalid frontContent.title"),typeof e.frontContent.text!="string"&&t.push("Invalid frontContent.text type")),!e.backContent||typeof e.backContent!="object"?t.push("Missing or invalid backContent"):((!e.backContent.title||typeof e.backContent.title!="string")&&t.push("Missing or invalid backContent.title"),typeof e.backContent.text!="string"&&t.push("Invalid backContent.text type")),(!e.createdAt||!(e.createdAt instanceof Date))&&t.push("Missing or invalid createdAt"),(!e.updatedAt||!(e.updatedAt instanceof Date))&&t.push("Missing or invalid updatedAt"),e.style&&typeof e.style!="object"&&t.push("Invalid style type"),e.frontContent.tags&&!Array.isArray(e.frontContent.tags)&&t.push("Invalid frontContent.tags type"),e.backContent.tags&&!Array.isArray(e.backContent.tags)&&t.push("Invalid backContent.tags type"),t}validateTimestamps(e){const t=[];for(const r of e){r.createdAt>new Date&&t.push(`Card ${r.id} has creation date in the future`),r.updatedAt>new Date&&t.push(`Card ${r.id} has update date in the future`),r.updatedAt<r.createdAt&&t.push(`Card ${r.id} has update date before creation date`);const n=new Date("2000-01-01");(r.createdAt<n||r.updatedAt<n)&&t.push(`Card ${r.id} has suspiciously old timestamps`)}return t}async repairDataIntegrity(){console.log("Starting data integrity repair...");const e=[],t=[],r=[];try{const n=await this.validateDataIntegrity();if(n.isValid)return console.log("No integrity issues found"),{repaired:!0,repairedCards:0,issues:[],failedRepairs:[]};console.log(`Found ${n.issues.length} issues to repair`);const o=await this.getCards(),i=[];for(const l of o){const u=this.validateCardStructure(l);if(u.length>0){const m=this.repairCard(l);this.validateCardStructure(m).length===0?(i.push(m),e.push(l.id||"unknown"),console.log(`Successfully repaired card ${l.id}`)):(t.push(l.id||"unknown"),r.push(`Failed to repair card ${l.id}: ${u.join(", ")}`))}else i.push(l)}return i.length!==o.length&&(await this.saveCards(i),console.log(`Repaired ${e.length} cards`)),{repaired:t.length===0,repairedCards:e.length,issues:r,failedRepairs:t}}catch(n){const o=`Data repair failed: ${n instanceof Error?n.message:String(n)}`;return console.error(o),{repaired:!1,repairedCards:0,issues:[o],failedRepairs:e}}}repairCard(e){const t={id:e.id||crypto.randomUUID(),frontContent:{title:e.frontContent?.title||"Untitled",text:e.frontContent?.text||"",tags:Array.isArray(e.frontContent?.tags)?e.frontContent.tags:[]},backContent:{title:e.backContent?.title||"Untitled",text:e.backContent?.text||"",tags:Array.isArray(e.backContent?.tags)?e.backContent.tags:[]},style:typeof e.style=="object"?e.style:{type:"solid"},isFlipped:typeof e.isFlipped=="boolean"?e.isFlipped:!1,createdAt:e.createdAt instanceof Date?e.createdAt:new Date,updatedAt:new Date};return t.createdAt>new Date&&(t.createdAt=new Date),t.updatedAt<t.createdAt&&(t.updatedAt=t.createdAt),t}async updateConfig(e){const{validateStorageConfig:t}=await Os(async()=>{const{validateStorageConfig:n}=await Promise.resolve().then(()=>Jo);return{validateStorageConfig:n}},void 0),r=t({...this.config,...e});if(!r.valid)throw ce("INVALID_CONFIG","Invalid storage configuration",{errors:r.errors});this.config=r.config}setupEventListeners(){if(this.storageMode==="indexeddb")try{V.cards.hook("creating",(e,t,r)=>{this.emitEvent({type:"cardCreated",timestamp:new Date,data:{cardId:e}})}),V.cards.hook("updating",(e,t,r,n)=>{this.emitEvent({type:"cardUpdated",timestamp:new Date,data:{cardId:t}})}),V.cards.hook("deleting",(e,t,r)=>{this.emitEvent({type:"cardDeleted",timestamp:new Date,data:{cardId:e}})})}catch(e){console.warn("Failed to setup IndexedDB event listeners:",e)}}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}removeEventListener(e,t){const r=this.eventListeners.get(e);if(r){const n=r.indexOf(t);n>-1&&r.splice(n,1)}}emitEvent(e){const t=this.eventListeners.get(e.type);t&&t.forEach(r=>{try{r(e)}catch(n){console.error(`Event listener error for ${e.type}:`,n)}})}}const Xo=Object.freeze(Object.defineProperty({__proto__:null,UniversalStorageAdapter:We},Symbol.toStringTag,{value:"Module"}));class it{static instance;errorListeners=[];recoveryStrategies=new Map;static getInstance(){return it.instance||(it.instance=new it),it.instance}onError(e){return this.errorListeners.push(e),()=>{const t=this.errorListeners.indexOf(e);t>-1&&this.errorListeners.splice(t,1)}}registerRecoveryStrategy(e,t){this.recoveryStrategies.set(e,t)}async handleError(e,t){const r=this.normalizeError(e,t);this.errorListeners.forEach(o=>o(r));const n=this.recoveryStrategies.get(r.type);if(n?.canRecover)try{await n.recover()}catch(o){console.error("错误恢复失败:",o)}return r}normalizeError(e,t){if(e instanceof Error){const r=this.classifyError(e),n=this.getSeverity(r),o=this.isRecoverable(e);return{type:r,message:t?`${t}: ${e.message}`:e.message,details:e.stack,timestamp:new Date,recoverable:o,severity:n,userMessage:this.getUserMessage(r),retryCount:0,maxRetries:this.getMaxRetries(r)}}return{type:"UNKNOWN_ERROR",message:t?`${t}: 未知错误`:"未知错误",details:e,timestamp:new Date,recoverable:!1,severity:"critical",userMessage:"发生了未知错误，请联系技术支持",retryCount:0,maxRetries:0}}classifyError(e){const t=e.message.toLowerCase(),r=e.stack?.toLowerCase()||"";return t.includes("storage")||t.includes("localstorage")||t.includes("indexeddb")?t.includes("quota")||t.includes("exceeded")||t.includes("full")||t.includes("quota exceeded")?"STORAGE_QUOTA_ERROR":t.includes("permission")||t.includes("access denied")||t.includes("security")||t.includes("security error")?"STORAGE_PERMISSION_ERROR":t.includes("corruption")||t.includes("corrupted")||t.includes("invalid data")||t.includes("data error")?"STORAGE_CORRUPTION_ERROR":t.includes("read-only")||t.includes("readonly")||t.includes("blocked")?"STORAGE_PERMISSION_ERROR":"STORAGE_TEMPORARY_ERROR":t.includes("network")||t.includes("fetch")||t.includes("ajax")||t.includes("xhr")?t.includes("offline")||t.includes("no internet")||t.includes("connection")||t.includes("networkerror")?"NETWORK_OFFLINE_ERROR":t.includes("timeout")||t.includes("timed out")||t.includes("timeout error")?"NETWORK_TIMEOUT_ERROR":t.includes("server")||t.includes("500")||t.includes("502")||t.includes("503")||t.includes("504")||t.includes("bad gateway")||t.includes("cors")||t.includes("cross-origin")||t.includes("origin")?"NETWORK_SERVER_ERROR":"NETWORK_ERROR":t.includes("validation")||t.includes("invalid")||t.includes("schema")||t.includes("type error")?t.includes("structure")||t.includes("format")||t.includes("unexpected token")||t.includes("syntax error")?"VALIDATION_STRUCTURE_ERROR":t.includes("required")||t.includes("missing")||t.includes("undefined")||t.includes("null")?"VALIDATION_DATA_ERROR":"VALIDATION_ERROR":t.includes("migration")||t.includes("migrate")||t.includes("upgrade")?t.includes("legacy")||t.includes("old version")||t.includes("version mismatch")?"MIGRATION_LEGACY_ERROR":t.includes("version")||t.includes("compatibility")||t.includes("incompatible")?"MIGRATION_VERSION_ERROR":"MIGRATION_ERROR":t.includes("initialization")||t.includes("init")||t.includes("setup")||t.includes("configuration")?"INITIALIZATION_ERROR":r.includes("indexeddb")||r.includes("idb")?t.includes("version")||t.includes("upgrade")?"MIGRATION_VERSION_ERROR":"STORAGE_TEMPORARY_ERROR":t.includes("database")||t.includes("db")||t.includes("transaction")?t.includes("constraint")||t.includes("unique")?"VALIDATION_DATA_ERROR":"STORAGE_TEMPORARY_ERROR":t.includes("memory")||t.includes("heap")||t.includes("out of memory")?"STORAGE_QUOTA_ERROR":t.includes("file")||t.includes("directory")||t.includes("filesystem")?"STORAGE_TEMPORARY_ERROR":"UNKNOWN_ERROR"}isRecoverable(e){const t=e.message.toLowerCase(),n=["quota","permission","access denied","security","critical","readonly","blocked","insufficient","not supported"].some(o=>t.includes(o));return t.includes("temporary")||t.includes("transient")||t.includes("network")&&!t.includes("offline")||t.includes("timeout")?!0:!n}getSeverity(e){switch(e){case"STORAGE_QUOTA_ERROR":case"STORAGE_PERMISSION_ERROR":case"VALIDATION_STRUCTURE_ERROR":case"MIGRATION_VERSION_ERROR":case"UNKNOWN_ERROR":return"critical";case"INITIALIZATION_ERROR":case"STORAGE_CORRUPTION_ERROR":case"NETWORK_SERVER_ERROR":return"high";case"VALIDATION_DATA_ERROR":case"MIGRATION_LEGACY_ERROR":case"MIGRATION_ERROR":return"medium";case"STORAGE_TEMPORARY_ERROR":case"NETWORK_OFFLINE_ERROR":case"NETWORK_TIMEOUT_ERROR":case"NETWORK_ERROR":case"VALIDATION_ERROR":return"low";default:return"low"}}getUserMessage(e){switch(e){case"STORAGE_QUOTA_ERROR":return"存储空间已满。请清理一些旧的卡片或使用浏览器的存储管理功能释放空间。";case"STORAGE_PERMISSION_ERROR":return"无法访问存储。请检查浏览器隐私设置，确保允许网站使用本地存储。";case"STORAGE_CORRUPTION_ERROR":return"检测到数据损坏。系统正在自动修复，请稍候...";case"STORAGE_TEMPORARY_ERROR":return"存储暂时不可用。系统正在重试，请稍等片刻...";case"NETWORK_OFFLINE_ERROR":return"网络连接已断开。请检查您的网络连接，连接后系统会自动同步。";case"NETWORK_TIMEOUT_ERROR":return"网络响应超时。请检查网络连接并稍后重试。";case"NETWORK_SERVER_ERROR":return"服务器暂时不可用。请稍后重试，或联系技术支持。";case"VALIDATION_STRUCTURE_ERROR":return"数据格式有问题。系统正在尝试自动修复...";case"VALIDATION_DATA_ERROR":return"数据内容验证失败。系统正在清理无效数据...";case"MIGRATION_LEGACY_ERROR":return"旧版本数据迁移失败。部分数据可能需要手动重新输入。";case"MIGRATION_VERSION_ERROR":return"版本兼容性问题。请更新应用到最新版本。";case"INITIALIZATION_ERROR":return"系统初始化失败。请刷新页面重试，如持续出现问题请清除浏览器数据。";case"UNKNOWN_ERROR":return"发生了未知错误。请刷新页面重试，如问题持续请联系技术支持。";case"NETWORK_ERROR":return"网络连接出现问题。请检查网络设置后重试。";case"VALIDATION_ERROR":return"数据验证出现问题。系统正在处理...";case"MIGRATION_ERROR":return"数据迁移过程中出现问题。系统正在尝试解决...";default:return"发生了错误，请稍后重试。"}}getMaxRetries(e){switch(e){case"STORAGE_TEMPORARY_ERROR":case"NETWORK_TIMEOUT_ERROR":case"NETWORK_OFFLINE_ERROR":case"NETWORK_ERROR":return 5;case"STORAGE_CORRUPTION_ERROR":case"VALIDATION_DATA_ERROR":case"NETWORK_SERVER_ERROR":return 3;case"VALIDATION_STRUCTURE_ERROR":case"MIGRATION_LEGACY_ERROR":case"MIGRATION_ERROR":case"INITIALIZATION_ERROR":return 2;case"STORAGE_QUOTA_ERROR":case"STORAGE_PERMISSION_ERROR":case"MIGRATION_VERSION_ERROR":return 1;case"UNKNOWN_ERROR":case"VALIDATION_ERROR":return 2;default:return 0}}}const xs=async()=>{try{const a=`_storage_test_${Date.now()}`;if(localStorage.setItem(a,"test"),localStorage.removeItem(a),"indexedDB"in window){const e=indexedDB.open("_storage_test_db",1);await new Promise((t,r)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>r(e.error)}),indexedDB.deleteDatabase("_storage_test_db")}return!0}catch(a){return console.error("存储可用性检查失败:",a),!1}},ea=async()=>{try{const a="card_error_history",e=localStorage.getItem(a);if(e){const n=JSON.parse(e).slice(-20);localStorage.setItem(a,JSON.stringify(n))}const t=Object.keys(localStorage).filter(r=>r.startsWith("_temp_")||r.startsWith("_cache_"));t.forEach(r=>localStorage.removeItem(r)),console.log(`清理了 ${t.length} 个临时项`)}catch(a){throw console.error("存储空间清理失败:",a),a}},ta=async()=>{try{const a=localStorage.getItem("cards");if(a){const t=JSON.parse(a).map(r=>({id:r.id,frontContent:{title:r.frontContent.title,text:r.frontContent.text,tags:r.frontContent.tags,lastModified:r.frontContent.lastModified},backContent:{title:r.backContent.title,text:r.backContent.text,tags:r.backContent.tags,lastModified:r.backContent.lastModified},style:r.style,createdAt:r.createdAt,updatedAt:r.updatedAt}));localStorage.setItem("cards",JSON.stringify(t))}console.log("数据压缩完成")}catch(a){throw console.error("数据压缩失败:",a),a}},Qo=async()=>{try{const a=localStorage.getItem("cards");if(!a)return[];const e=JSON.parse(a);if(!Array.isArray(e))return[];const t=e.map(r=>{const n={id:r.id||Date.now().toString(),frontContent:{title:r.frontContent?.title||"未命名卡片",text:r.frontContent?.text||"",images:r.frontContent?.images||[],tags:r.frontContent?.tags||[],lastModified:r.frontContent?.lastModified?new Date(r.frontContent.lastModified):new Date},backContent:{title:r.backContent?.title||"背面",text:r.backContent?.text||"",images:r.backContent?.images||[],tags:r.backContent?.tags||[],lastModified:r.backContent?.lastModified?new Date(r.backContent.lastModified):new Date},style:r.style||{type:"solid",backgroundColor:"#f8fafc",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:r.isFlipped||!1,createdAt:r.createdAt?new Date(r.createdAt):new Date,updatedAt:r.updatedAt?new Date(r.updatedAt):new Date};return r.folderId&&(n.folderId=r.folderId),n});return localStorage.setItem("cards",JSON.stringify(t)),t}catch(a){return console.error("localStorage数据修复失败:",a),[]}},Zo=async()=>{try{return"indexedDB"in window?new Promise((a,e)=>{const t=indexedDB.open("CardAllDB",1);t.onsuccess=()=>{const r=t.result,i=r.transaction(["cards"],"readonly").objectStore("cards").getAll();i.onsuccess=()=>{const l=i.result||[];r.close(),a(l)},i.onerror=()=>{r.close(),e(i.error)}},t.onerror=()=>{e(t.error)}}):[]}catch(a){return console.error("IndexedDB数据恢复失败:",a),[]}},ei=async()=>{try{if("caches"in window){const e=await(await caches.open("cardall-data")).match("/cards-data");if(e)return(await e.json()).cards||[]}return[]}catch(a){return console.error("浏览器缓存恢复失败:",a),[]}},_e=a=>{try{return a&&typeof a.id=="string"&&a.frontContent&&typeof a.frontContent.title=="string"&&a.backContent&&typeof a.backContent.title=="string"&&a.style&&a.createdAt&&a.updatedAt}catch{return!1}},ys=async a=>a.map(e=>{const t={id:e.id||Date.now().toString(),frontContent:{title:e.frontContent?.title||"修复的卡片",text:e.frontContent?.text||"",images:Array.isArray(e.frontContent?.images)?e.frontContent.images:[],tags:Array.isArray(e.frontContent?.tags)?e.frontContent.tags:[],lastModified:e.frontContent?.lastModified?new Date(e.frontContent.lastModified):new Date},backContent:{title:e.backContent?.title||"背面",text:e.backContent?.text||"",images:Array.isArray(e.backContent?.images)?e.backContent.images:[],tags:Array.isArray(e.backContent?.tags)?e.backContent.tags:[],lastModified:e.backContent?.lastModified?new Date(e.backContent.lastModified):new Date},style:e.style||{type:"solid",backgroundColor:"#f8fafc",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:typeof e.isFlipped=="boolean"?e.isFlipped:!1,createdAt:e.createdAt?new Date(e.createdAt):new Date,updatedAt:new Date};return e.folderId&&(t.folderId=e.folderId),t}),ws=async()=>{try{const a=Date.now(),e=await fetch("/api/health",{method:"HEAD",cache:"no-cache"}),t=Date.now()-a;return{success:e.ok,latency:t}}catch{try{const e=Date.now(),t=await fetch("/",{method:"HEAD",cache:"no-cache"}),r=Date.now()-e;return{success:t.ok,latency:r}}catch{return{success:!1}}}},ti=async()=>{try{const a=await fetch("/api/status",{method:"GET",headers:{"Content-Type":"application/json"}});return a.ok?{success:!0,message:(await a.json()).message||"服务器正常"}:{success:!1,message:`服务器响应错误: ${a.status}`}}catch{return{success:!1,message:"无法连接到服务器"}}},si=[{id:"1",frontContent:{title:"React Best Practices",text:"Key principles for writing maintainable React code including component composition, state management, and performance optimization.",images:[],tags:["react","frontend","best-practices"],lastModified:new Date},backContent:{title:"Implementation Details",text:"Use functional components with hooks, implement proper error boundaries, optimize with React.memo and useMemo for expensive calculations.",images:[],tags:["react","frontend","best-practices"],lastModified:new Date},style:{type:"solid",backgroundColor:"#f8fafc",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:!1,createdAt:new Date("2024-01-15"),updatedAt:new Date("2024-01-15")},{id:"2",frontContent:{title:"TypeScript Tips",text:"Advanced TypeScript patterns for better type safety and developer experience in large applications.",images:[],tags:["typescript","types","development"],lastModified:new Date},backContent:{title:"Advanced Patterns",text:"Utility types, conditional types, mapped types, and template literal types for complex type transformations.",images:[],tags:["typescript","types","development"],lastModified:new Date},style:{type:"gradient",gradientColors:["#667eea","#764ba2"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"xl",shadow:"lg",borderWidth:0},isFlipped:!1,createdAt:new Date("2024-01-16"),updatedAt:new Date("2024-01-16")}];function ai(){const[a,e]=c.useState([]),[t,r]=c.useState(!1),[n,o]=c.useState({searchTerm:"",tags:[]}),[i,l]=c.useState({layout:"grid",cardSize:"medium",showTags:!0,showDates:!1,sortBy:"updated",sortOrder:"desc"}),[u,m]=c.useState([]),[d,h]=c.useState(null),[g,f]=c.useState([]),[p,b]=c.useState(!1),[C,v]=c.useState(!1),[y,x]=c.useState(null),j=it.getInstance(),N=We.getInstance();c.useEffect(()=>{const R=j.onError(S=>{if(h(S),f($=>[...$.slice(-9),S]),S.userMessage)switch(S.severity){case"critical":console.error("严重错误:",S.userMessage);break;case"high":console.warn("高级别错误:",S.userMessage);break;case"medium":console.warn("中等级别错误:",S.userMessage);break;case"low":console.info("低级别错误:",S.userMessage);break}});j.registerRecoveryStrategy("STORAGE_TEMPORARY_ERROR",{canRecover:!0,maxRetries:3,retryDelay:1e3,recover:async()=>{console.log("尝试恢复临时存储错误...");try{if(!await xs())throw new Error("存储不可用");await ea(),await new Promise($=>setTimeout($,1e3))}catch(S){throw console.error("临时存储恢复失败:",S),S}},fallback:()=>{console.log("临时存储恢复失败，使用空数据"),e([])},shouldUseMock:!1}),j.registerRecoveryStrategy("STORAGE_CORRUPTION_ERROR",{canRecover:!0,maxRetries:2,retryDelay:500,recover:async()=>{console.log("尝试修复数据损坏...");try{let S=[];const $=await Qo();if($.length>0&&(S=$),S.length===0){const J=await Zo();J.length>0&&(S=J)}if(S.length===0){const J=await ei();J.length>0&&(S=J)}if(S.length>0)e(S),console.log(`成功恢复 ${S.length} 张卡片`);else throw new Error("无法从任何来源恢复数据")}catch(S){throw console.error("数据修复失败:",S),S}},fallback:()=>{console.log("数据修复失败，使用空数据"),e([])},shouldUseMock:!1}),j.registerRecoveryStrategy("VALIDATION_DATA_ERROR",{canRecover:!0,maxRetries:2,retryDelay:300,recover:async()=>{console.log("尝试修复数据验证错误...");try{const S=a.filter($=>!_e($));if(S.length>0){console.log(`发现 ${S.length} 张无效卡片，尝试修复...`);const $=await ys(S);e(J=>J.map(ue=>$.find(he=>he.id===ue.id)||ue)),console.log(`成功修复 ${$.length} 张卡片`)}}catch(S){throw console.error("数据验证修复失败:",S),S}},fallback:()=>{console.log("数据验证修复失败，移除无效卡片"),e(S=>S.filter($=>_e($)))},shouldUseMock:!1}),j.registerRecoveryStrategy("NETWORK_TIMEOUT_ERROR",{canRecover:!0,maxRetries:3,retryDelay:2e3,recover:async()=>{console.log("网络超时恢复策略...");try{if(!navigator.onLine)throw new Error("网络离线");if(!(await ws()).success)throw new Error("网络连接测试失败");console.log("网络连接已恢复")}catch(S){throw console.error("网络恢复失败:",S),S}},shouldUseMock:!1}),j.registerRecoveryStrategy("NETWORK_OFFLINE_ERROR",{canRecover:!0,maxRetries:3,retryDelay:3e3,recover:async()=>{console.log("网络离线恢复策略...");try{let S=0;const $=10;for(;S<$;){if(navigator.onLine&&(await ws()).success){console.log("网络连接已恢复");return}S++,await new Promise(J=>setTimeout(J,1e3))}throw new Error("网络连接未在预期时间内恢复")}catch(S){throw console.error("网络离线恢复失败:",S),S}},shouldUseMock:!1}),j.registerRecoveryStrategy("STORAGE_QUOTA_ERROR",{canRecover:!0,maxRetries:1,retryDelay:1e3,recover:async()=>{console.log("存储配额错误恢复策略...");try{await ea(),await ta(),console.log("存储空间清理完成")}catch(S){throw console.error("存储配额恢复失败:",S),S}},fallback:()=>{console.log("存储空间不足，建议清理数据或使用云端同步"),alert("存储空间不足，请清理一些数据或使用云端同步功能")},shouldUseMock:!1}),j.registerRecoveryStrategy("INITIALIZATION_ERROR",{canRecover:!0,maxRetries:2,retryDelay:1e3,recover:async()=>{console.log("初始化错误恢复策略...");try{await N.reinitialize(),await E(),console.log("初始化恢复成功")}catch(S){throw console.error("初始化恢复失败:",S),S}},shouldUseMock:!1}),j.registerRecoveryStrategy("NETWORK_SERVER_ERROR",{canRecover:!0,maxRetries:3,retryDelay:2e3,recover:async()=>{console.log("服务器错误恢复策略...");try{if(await new Promise($=>setTimeout($,2e3)),!(await ti()).success)throw new Error("服务器仍然不可用");console.log("服务器连接已恢复")}catch(S){throw console.error("服务器恢复失败:",S),S}},shouldUseMock:!1});const D=async S=>{console.log("存储数据变更:",S),S.type==="cardsChanged"&&S.data?.externalChange&&(console.log("检测到外部数据变更，重新加载..."),await E()),S.type==="cardsChanged"&&x(new Date)};return N.addEventListener("cardsChanged",D),N.addEventListener("cardCreated",D),N.addEventListener("cardUpdated",D),N.addEventListener("cardDeleted",D),()=>{R(),N.removeEventListener("cardsChanged",D),N.removeEventListener("cardCreated",D),N.removeEventListener("cardUpdated",D),N.removeEventListener("cardDeleted",D)}},[N]);const E=c.useCallback(async()=>{b(!0);try{let R=[],D=0;const S=3;for(;D<S;)try{R=await N.getCards();break}catch($){if(D++,D===S)throw $;console.warn(`第 ${D} 次加载失败，等待重试...`),await new Promise(J=>setTimeout(J,1e3*D))}if(R.length>0){const $=R.filter(_e);$.length!==R.length&&console.warn(`发现 ${R.length-$.length} 张无效卡片，已过滤`),e($),console.log(`成功加载 ${$.length} 张有效卡片 (使用 ${N.getStorageMode()} 存储模式)`)}else console.log("没有找到数据，使用空数组"),e([]);r(!0)}catch(R){console.error("加载数据失败:",R),await j.handleError(R,"加载卡片数据失败");try{console.log("尝试回退到DataConverterAdapter...");const D=ke.loadFromLocalStorage();if(D.length>0){const S=D.filter(_e);e(S),console.log(`回退加载成功：${S.length} 张有效卡片`)}else e([])}catch(D){console.error("回退加载也失败:",D),await j.handleError(D,"回退加载失败"),e([])}r(!0)}finally{b(!1)}},[j]),w=c.useCallback(async()=>{if(!(!d||!d.recoverable)){b(!0),v(!0);try{const R=j.recoveryStrategies.get(d.type);if(R?.canRecover){const D=R.maxRetries||d.maxRetries||1,S=R.retryDelay||1e3;let $=null;for(let J=1;J<=D;J++)try{console.log(`尝试恢复 ${d.type} - 第 ${J} 次`),await R.recover(),await E(),h(null),console.log(`错误恢复成功：${d.type}`);break}catch(ue){if($=ue,console.error(`恢复失败，第 ${J} 次尝试:`,ue),J<D){const me=S*Math.pow(2,J-1);console.log(`等待 ${me}ms 后重试...`),await new Promise(he=>setTimeout(he,me))}}$&&R.fallback&&(console.log("所有恢复尝试失败，执行fallback策略"),R.fallback()),d&&R.shouldUseMock&&a.length===0&&(console.warn("所有恢复策略失败，使用mock数据作为最后手段"),e(si),h(null))}else console.warn(`错误类型 ${d.type} 没有可用的恢复策略`)}catch(R){console.error("错误恢复过程中发生异常:",R);const D=j.recoveryStrategies.get(d.type)?.fallback;D&&D()}finally{b(!1)}}},[d,j,a.length,E]),k=c.useCallback(()=>{const R=a.filter(D=>{if(n.searchTerm){const S=n.searchTerm.toLowerCase(),$=D.frontContent.title.toLowerCase().includes(S)||D.backContent.title.toLowerCase().includes(S),J=D.frontContent.text.toLowerCase().includes(S)||D.backContent.text.toLowerCase().includes(S),ue=[...D.frontContent.tags,...D.backContent.tags].some(me=>me.toLowerCase().includes(S));if(!$&&!J&&!ue)return!1}if(n.tags.length>0){const S=[...D.frontContent.tags,...D.backContent.tags];if(!n.tags.some($=>S.includes($)))return!1}if(n.folderId&&D.folderId!==n.folderId)return!1;if(n.dateRange){const S=new Date(D.updatedAt);if(S<n.dateRange.start||S>n.dateRange.end)return!1}return!(n.styleType&&D.style.type!==n.styleType||n.hasImages!==void 0&&(D.frontContent.images.length>0||D.backContent.images.length>0)!==n.hasImages)});return R.sort((D,S)=>{let $=0;switch(i.sortBy){case"created":$=new Date(D.createdAt).getTime()-new Date(S.createdAt).getTime();break;case"updated":$=new Date(D.updatedAt).getTime()-new Date(S.updatedAt).getTime();break;case"title":$=D.frontContent.title.localeCompare(S.frontContent.title);break;default:$=0}return i.sortOrder==="desc"?-$:$}),R},[a,n,i]),I=c.useCallback(R=>{e(D=>{switch(R.type){case"CREATE_CARD":{const S={...R.payload,id:Date.now().toString(),createdAt:new Date,updatedAt:new Date};return[...D,S]}case"UPDATE_CARD":return D.map(S=>S.id===R.payload.id?{...S,...R.payload.updates,updatedAt:new Date}:S);case"DELETE_CARD":return D.filter(S=>S.id!==R.payload);case"FLIP_CARD":return D.map(S=>S.id===R.payload?{...S,isFlipped:!S.isFlipped,updatedAt:new Date}:S);case"SELECT_CARD":return m(S=>S.includes(R.payload)?S.filter($=>$!==R.payload):[...S,R.payload]),D;case"DESELECT_ALL":return m([]),D;case"DUPLICATE_CARD":{const S=D.find(J=>J.id===R.payload);if(!S)return D;const $={...S,id:Date.now().toString(),createdAt:new Date,updatedAt:new Date};return[...D,$]}case"MOVE_TO_FOLDER":return D.map($=>$.id===R.payload.cardId?{...$,folderId:R.payload.folderId,updatedAt:new Date}:$);default:return D}})},[]),K=c.useCallback(R=>a.find(D=>D.id===R),[a]),O=c.useCallback(()=>a.filter(R=>u.includes(R.id)),[a,u]),H=c.useCallback(()=>{const R=new Set;return a.forEach(D=>{D.frontContent.tags.forEach(S=>R.add(S)),D.backContent.tags.forEach(S=>R.add(S))}),Array.from(R).sort()},[a]),te=c.useCallback((R,D)=>{e(S=>S.map($=>{const J=he=>D?he.map(pe=>pe===R?D:pe):he.filter(pe=>pe!==R),ue=J($.frontContent.tags),me=J($.backContent.tags);return JSON.stringify(ue)!==JSON.stringify($.frontContent.tags)||JSON.stringify(me)!==JSON.stringify($.backContent.tags)?{...$,frontContent:{...$.frontContent,tags:ue,lastModified:new Date},backContent:{...$.backContent,tags:me,lastModified:new Date},updatedAt:new Date}:$}))},[]),W=c.useCallback(R=>a.filter(D=>D.frontContent.tags.includes(R)||D.backContent.tags.includes(R)),[a]);c.useEffect(()=>{if(t)return;(async()=>{b(!0);try{const D=await N.getCards();if(D.length>0)e(D),console.log(`成功加载 ${D.length} 张卡片 (使用 ${N.getStorageMode()} 存储模式)`);else try{console.log("尝试从localStorage加载数据...");const S=ke.loadFromLocalStorage();S.length>0?(e(S),console.log(`从localStorage加载 ${S.length} 张卡片`),await N.saveCards(S),console.log("数据已迁移到UniversalStorageAdapter")):(console.log("没有找到数据，使用空数组"),e([]))}catch(S){console.warn("从localStorage加载失败:",S),e([])}r(!0)}catch(D){console.error("加载卡片数据失败:",D),await j.handleError(D,"加载卡片数据失败"),await w()}finally{b(!1)}})()},[t,j,w,N]),c.useEffect(()=>{if(!t||p)return;const R=setTimeout(async()=>{try{const D=a.filter(J=>!_e(J));if(D.length>0){console.warn(`发现 ${D.length} 张无效卡片，保存前尝试修复...`);const J=await ys(D);J.length>0&&e(ue=>ue.map(me=>J.find(pe=>pe.id===me.id)||me))}let S=0;const $=2;for(;S<$;)try{await N.saveCards(a),console.log(`自动保存成功：${a.length} 张卡片 (使用 ${N.getStorageMode()} 存储模式)`);break}catch(J){if(S++,S===$)throw J;console.warn(`第 ${S} 次保存失败，等待重试...`),await new Promise(ue=>setTimeout(ue,500*S))}}catch(D){console.error("保存卡片到持久化存储失败:",D),await j.handleError(D,"保存卡片数据失败");try{console.log("尝试回退到DataConverterAdapter..."),ke.saveToLocalStorage(a),console.log("回退保存成功")}catch(S){console.error("回退保存也失败:",S),await j.handleError(S,"回退保存失败")}}},2e3);return()=>clearTimeout(R)},[a,t,p,j,N]);const Z={performPreventiveChecks:async()=>{try{if(!await xs())return console.warn("存储空间检查失败，可能即将出现问题"),!1;navigator.onLine&&((await ws()).success||console.warn("网络连接不稳定，可能影响数据同步"));const D=a.filter(S=>!_e(S));return D.length>0&&console.warn(`发现 ${D.length} 张无效卡片，建议修复`),!0}catch(R){return console.error("预防性检查失败:",R),!1}},analyzeErrorTrends:()=>{const R=g.slice(-10),D=g.slice(-20,-10);if(R.length===0)return{trend:"improving",suggestions:["错误率正常，继续保持"]};const S=new Map;R.forEach(he=>{const pe=S.get(he.type)||0;S.set(he.type,pe+1)});const $=[];S.forEach((he,pe)=>{if(he>2)switch(pe){case"STORAGE_TEMPORARY_ERROR":$.push("频繁的存储临时错误，建议检查存储设备");break;case"NETWORK_TIMEOUT_ERROR":$.push("网络超时频繁，建议检查网络连接");break;case"VALIDATION_DATA_ERROR":$.push("数据验证错误增多，建议检查数据源");break}});const J=R.length,ue=D.length;let me="stable";return J<ue?me="improving":J>ue&&(me="worsening"),$.length===0&&$.push("系统运行正常，继续保持"),{trend:me,suggestions:$}},runMaintenanceTasks:async()=>{try{console.log("开始运行维护任务..."),g.length>50&&(f(S=>S.slice(-30)),console.log("清理了错误历史记录")),await xs()||(await ta(),console.log("执行了数据压缩"));const D=a.filter(S=>!_e(S));if(D.length>0){const S=await ys(D);S.length>0&&console.log(`修复了 ${S.length} 张无效卡片`)}console.log("维护任务完成")}catch(R){console.error("维护任务执行失败:",R)}}},[ne,re]=c.useState(new Set),ge=c.useCallback(R=>(re(D=>new Set(D).add(R)),()=>{re(D=>{const S=new Set(D);return S.delete(R),S})}),[]),z=c.useCallback((R,D)=>{ne.forEach(S=>{try{S(R,D)}catch($){console.error("数据变更监听器执行失败:",$)}})},[ne]),q=c.useCallback(async(R=!1)=>{if(!R&&t&&a.length>0)return a;b(!0);try{let D=[];try{D=await N.getCards(),D.length>0&&console.log(`从UniversalStorageAdapter加载 ${D.length} 张卡片`)}catch($){console.warn("UniversalStorageAdapter加载失败，尝试回退:",$)}if(D.length===0)try{const $=ke.loadFromLocalStorage();$.length>0&&(D=$,console.log(`从localStorage加载 ${$.length} 张卡片`),await N.saveCards($))}catch($){console.warn("localStorage加载失败:",$)}const S=D.filter(_e);return S.length!==D.length&&console.warn(`过滤了 ${D.length-S.length} 张无效卡片`),e(S),r(!0),z("cardsLoaded",{cardCount:S.length}),S}catch(D){return console.error("加载卡片失败:",D),await j.handleError(D,"loadCards失败"),e([]),r(!0),[]}finally{b(!1)}},[t,a.length,N,j,z]),_=c.useCallback(async(R=a)=>{try{const D=R.filter(J=>!_e(J));D.length>0&&console.warn(`保存前发现 ${D.length} 张无效卡片`);const S=R.filter(_e);return await N.saveCards(S)?(console.log(`成功保存 ${S.length} 张卡片`),z("cardsSaved",{cardCount:S.length}),!0):!1}catch(D){console.error("保存卡片失败:",D),await j.handleError(D,"saveCards失败");try{return ke.saveToLocalStorage(R),console.log("回退保存成功"),!0}catch(S){return console.error("回退保存失败:",S),!1}}},[a,N,j,z]),M=c.useCallback(async(R,D)=>{b(!0);try{console.log(`开始批量操作: ${D}`);for(let S=0;S<R.length;S++)try{await R[S]()}catch($){throw console.error(`批量操作第 ${S+1} 步失败:`,$),$}return await _(),console.log(`批量操作完成: ${D}`),z("batchOperationCompleted",{description:D,operationCount:R.length}),!0}catch(S){return console.error(`批量操作失败: ${D}`,S),await j.handleError(S,`批量操作失败: ${D}`),!1}finally{b(!1)}},[_,j,z]);c.useEffect(()=>{if(!t)return;const R=setInterval(async()=>{try{await Z.runMaintenanceTasks()}catch(S){console.error("定期维护任务失败:",S)}},5*60*1e3),D=setInterval(async()=>{try{await Z.performPreventiveChecks()}catch(S){console.error("预防性检查失败:",S)}},30*1e3);return()=>{clearInterval(R),clearInterval(D)}},[t,Z]);const T=c.useCallback(async()=>{if(!d||!d.recoverable)return!1;console.log("开始增强的错误恢复流程..."),b(!0);try{const R=j.recoveryStrategies.get(d.type);return R?.canRecover?(await R.recover(),await E(),h(null),console.log("错误恢复成功"),!0):!1}catch(R){return console.error("错误恢复失败:",R),!1}finally{b(!1)}},[d,j,E]),U=c.useCallback(()=>{if(!d)return null;switch(d.severity){case"critical":return{level:"critical",message:"严重错误，需要立即关注"};case"high":return{level:"high",message:"高级别错误，建议尽快处理"};case"medium":return{level:"medium",message:"中等级别错误，可以稍后处理"};case"low":return{level:"low",message:"低级别错误，可以忽略"};default:return null}},[d]),Y=c.useCallback(()=>d?d.userMessage||d.message:null,[d]),L=c.useCallback(()=>{},[]);return{cards:k(),allCards:a,filter:n,setFilter:o,viewSettings:i,setViewSettings:l,selectedCardIds:u,dispatch:I,getCardById:K,getSelectedCards:O,getAllTags:H,updateTagsInAllCards:te,getCardsWithTag:W,isInitialized:t,error:d,errorHistory:g,isLoading:p,recoveryAttempted:C,recoverFromError:w,reloadData:E,clearError:()=>h(null),clearErrorHistory:()=>f([]),lastSyncTime:y,getUserErrorMessage:Y,getErrorSeverityInfo:U,errorPrevention:Z,loadCards:q,saveCards:_,onDataChange:ge,performBatchOperation:M,enhancedRecoverFromError:T,useMockDataForDevelopment:L}}class ri{config;directoryHandle=null;isSupported;constructor(){this.config={baseDirectory:"CardAll",imageDirectory:"images",tempDirectory:"temp",cacheDirectory:"cache"},this.isSupported="showDirectoryPicker"in window}isFileSystemAccessSupported(){return this.isSupported}async requestDirectoryAccess(){if(!this.isSupported)return console.warn("File System Access API not supported, using fallback storage"),!1;try{return this.directoryHandle=await window.showDirectoryPicker({mode:"readwrite",startIn:"documents"}),await this.ensureDirectoryStructure(),!0}catch(e){return e.name==="AbortError"?console.log("User cancelled directory selection"):console.error("Failed to access directory:",e),!1}}async ensureDirectoryStructure(){if(this.directoryHandle)try{await this.getOrCreateDirectory(this.config.imageDirectory),await this.getOrCreateDirectory(this.config.tempDirectory),await this.getOrCreateDirectory(this.config.cacheDirectory),console.log("Directory structure created successfully")}catch(e){console.error("Failed to create directory structure:",e)}}async getOrCreateDirectory(e){if(!this.directoryHandle)throw new Error("No directory handle available");try{return await this.directoryHandle.getDirectoryHandle(e)}catch{return await this.directoryHandle.getDirectoryHandle(e,{create:!0})}}async getOrCreateNestedDirectory(e){if(!this.directoryHandle)throw new Error("No directory handle available");const t=e.split("/");let r=this.directoryHandle;for(const n of t)if(n)try{r=await r.getDirectoryHandle(n)}catch{r=await r.getDirectoryHandle(n,{create:!0})}return r}generateImagePath(e,t){const r=t||"uncategorized";return`${this.config.imageDirectory}/${r}/${e}`}async saveImage(e,t,r){const n=`img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o=`${n}.webp`,l=`${this.generateImagePath(t,r)}/${o}`;try{const u=await this.processImage(e),m=await this.getImageMetadata(e,u);this.isSupported&&this.directoryHandle?await this.saveToFileSystem(l,u):await this.saveToIndexedDB(l,u);const d={id:n,cardId:t,fileName:o,filePath:l,metadata:m,createdAt:new Date,syncVersion:1,pendingSync:!0};return await V.images.add(d),{id:n,fileName:o,filePath:l,metadata:m}}catch(u){throw console.error("Failed to save image:",u),u}}async processImage(e){return new Promise((t,r)=>{const n=document.createElement("canvas"),o=n.getContext("2d"),i=new Image;i.onload=()=>{try{let{width:m,height:d}=i;if(m>1920||d>1080){const h=Math.min(1920/m,1080/d);m*=h,d*=h}n.width=m,n.height=d,o?.drawImage(i,0,0,m,d),n.toBlob(h=>{h?t(h):r(new Error("Failed to convert image"))},"image/webp",.8)}catch(l){r(l)}},i.onerror=()=>r(new Error("Failed to load image")),i.src=URL.createObjectURL(e)})}async getImageMetadata(e,t){return new Promise(r=>{const n=new Image;n.onload=()=>{r({originalName:e.name,size:t.size,width:n.width,height:n.height,format:"webp",compressed:!0})},n.src=URL.createObjectURL(t)})}async saveToFileSystem(e,t){if(!this.directoryHandle)throw new Error("No directory handle available");const r=e.split("/"),n=r.pop(),o=r.join("/"),u=await(await(await this.getOrCreateNestedDirectory(o)).getFileHandle(n,{create:!0})).createWritable();await u.write(t),await u.close()}async saveToIndexedDB(e,t){await t.arrayBuffer();const r=await this.blobToBase64(t);localStorage.setItem(`cardall_file_${e}`,r)}blobToBase64(e){return new Promise((t,r)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=r,n.readAsDataURL(e)})}async getImage(e){try{return this.isSupported&&this.directoryHandle?await this.getFromFileSystem(e):await this.getFromIndexedDB(e)}catch(t){throw console.error("Failed to get image:",t),t}}async getFromFileSystem(e){if(!this.directoryHandle)throw new Error("No directory handle available");const t=e.split("/"),r=t.pop(),n=t.join("/"),l=await(await(await this.getOrCreateNestedDirectory(n)).getFileHandle(r)).getFile();return URL.createObjectURL(l)}async getFromIndexedDB(e){const t=localStorage.getItem(`cardall_file_${e}`);if(!t)throw new Error("Image not found in storage");return t}async deleteImage(e){try{this.isSupported&&this.directoryHandle?await this.deleteFromFileSystem(e):await this.deleteFromIndexedDB(e),await V.images.where("filePath").equals(e).delete()}catch(t){throw console.error("Failed to delete image:",t),t}}async deleteFromFileSystem(e){if(this.directoryHandle)try{const t=e.split("/"),r=t.pop(),n=t.join("/");await(await this.getOrCreateNestedDirectory(n)).removeEntry(r)}catch(t){console.warn("Failed to delete file from filesystem:",t)}}async deleteFromIndexedDB(e){localStorage.removeItem(`cardall_file_${e}`)}async getStorageStats(){const e=await V.images.toArray(),t=e.reduce((r,n)=>r+n.metadata.size,0);return{totalImages:e.length,totalSize:t,storageMode:this.isSupported&&this.directoryHandle?"filesystem":"indexeddb"}}}const gt=new ri,ni=a=>{const{userId:e,syncVersion:t,lastSyncAt:r,pendingSync:n,...o}=a;return{...o,id:o.id||"",createdAt:new Date(o.createdAt),updatedAt:new Date(o.updatedAt)}},bs=()=>Me.getCurrentUser()?.id||null;function oi(){const[a,e]=c.useState([]),[t,r]=c.useState({searchTerm:"",tags:[]}),[n,o]=c.useState({layout:"grid",cardSize:"medium",showTags:!0,showDates:!1,sortBy:"updated",sortOrder:"desc"}),[i,l]=c.useState([]),[u,m]=c.useState(!0),d=c.useCallback(async()=>{try{m(!0);const j=(await V.cards.toArray()).map(ni);e(j)}catch(x){console.error("Failed to load cards:",x)}finally{m(!1)}},[]);c.useEffect(()=>{d()},[d]),c.useEffect(()=>{const x=V.cards.hook("creating",(E,w,k)=>{console.log("Card creating:",E)}),j=V.cards.hook("updating",(E,w,k,I)=>{console.log("Card updating:",w)}),N=V.cards.hook("deleting",(E,w,k)=>{console.log("Card deleting:",E)});return()=>{x?.unsubscribe(),j?.unsubscribe(),N?.unsubscribe()}},[]);const h=c.useCallback(()=>{const x=a.filter(j=>{if(t.searchTerm){const N=t.searchTerm.toLowerCase(),E=j.frontContent.title.toLowerCase().includes(N)||j.backContent.title.toLowerCase().includes(N),w=j.frontContent.text.toLowerCase().includes(N)||j.backContent.text.toLowerCase().includes(N),k=[...j.frontContent.tags,...j.backContent.tags].some(I=>I.toLowerCase().includes(N));if(!E&&!w&&!k)return!1}if(t.tags.length>0){const N=[...j.frontContent.tags,...j.backContent.tags];if(!t.tags.some(E=>N.includes(E)))return!1}if(t.folderId&&j.folderId!==t.folderId)return!1;if(t.dateRange){const N=new Date(j.updatedAt);if(N<t.dateRange.start||N>t.dateRange.end)return!1}return!(t.styleType&&j.style.type!==t.styleType||t.hasImages!==void 0&&(j.frontContent.images.length>0||j.backContent.images.length>0)!==t.hasImages)});return x.sort((j,N)=>{let E=0;switch(n.sortBy){case"created":E=new Date(j.createdAt).getTime()-new Date(N.createdAt).getTime();break;case"updated":E=new Date(j.updatedAt).getTime()-new Date(N.updatedAt).getTime();break;case"title":E=j.frontContent.title.localeCompare(N.frontContent.title);break;default:E=0}return n.sortOrder==="desc"?-E:E}),x},[a,t,n]),g=c.useCallback(async x=>{const j=bs();try{switch(x.type){case"CREATE_CARD":{const N=crypto.randomUUID(),E={...x.payload,id:N,userId:j,createdAt:new Date,updatedAt:new Date,syncVersion:1,pendingSync:!0};await V.cards.add(E),await Ae.addOperation({type:"create",entity:"card",entityId:N,data:E,priority:"normal"}),await d();break}case"UPDATE_CARD":{const N={...x.payload.updates,userId:j,updatedAt:new Date,syncVersion:1,pendingSync:!0};await V.cards.update(x.payload.id,N),await Ae.addOperation({type:"update",entity:"card",entityId:x.payload.id,data:{...x.payload.updates,userId:j},priority:"normal"}),await d();break}case"DELETE_CARD":{const N=await V.cards.get(x.payload);if(N){const E=[...N.frontContent.images,...N.backContent.images];for(const w of E)if(w.url&&!w.url.startsWith("data:"))try{await gt.deleteImage(w.url)}catch(k){console.warn("Failed to delete image:",k)}}await V.cards.delete(x.payload),await Ae.addOperation({type:"delete",entity:"card",entityId:x.payload,data:{userId:j},priority:"high"}),await d();break}case"FLIP_CARD":{const N=await V.cards.get(x.payload);if(N){const E={isFlipped:!N.isFlipped,updatedAt:new Date,syncVersion:(N.syncVersion||0)+1,pendingSync:!0};await V.cards.update(x.payload,E),await Ae.addOperation({type:"update",table:"cards",data:E,localId:x.payload}),await d()}break}case"SELECT_CARD":l(N=>N.includes(x.payload)?N.filter(E=>E!==x.payload):[...N,x.payload]);break;case"DESELECT_ALL":l([]);break;case"DUPLICATE_CARD":{const N=await V.cards.get(x.payload);if(N){const E=crypto.randomUUID(),w={...N,id:E,userId:j,createdAt:new Date,updatedAt:new Date,syncVersion:1,pendingSync:!0};await V.cards.add(w),await Ae.addOperation({type:"create",table:"cards",data:w,localId:E}),await d()}break}case"MOVE_TO_FOLDER":{const N={folderId:x.payload.folderId,userId:j,updatedAt:new Date,syncVersion:1,pendingSync:!0};await V.cards.update(x.payload.cardId,N),await Ae.addOperation({type:"update",table:"cards",data:N,localId:x.payload.cardId}),await d();break}default:console.warn("Unknown card action:",x)}}catch(N){throw console.error("Card operation failed:",N),N}},[d]),f=c.useCallback(x=>a.find(j=>j.id===x),[a]),p=c.useCallback(()=>a.filter(x=>i.includes(x.id)),[a,i]),b=c.useCallback(()=>{const x=new Set;return a.forEach(j=>{j.frontContent.tags.forEach(N=>x.add(N)),j.backContent.tags.forEach(N=>x.add(N))}),Array.from(x).sort()},[a]),C=c.useCallback(async(x,j)=>{const N=bs();try{const E=await V.cards.filter(w=>w.frontContent.tags.includes(x)||w.backContent.tags.includes(x)).toArray();for(const w of E){const k=H=>j?H.map(te=>te===x?j:te):H.filter(te=>te!==x),I=k(w.frontContent.tags),K=k(w.backContent.tags),O={frontContent:{...w.frontContent,tags:I,lastModified:new Date},backContent:{...w.backContent,tags:K,lastModified:new Date},userId:N,updatedAt:new Date,syncVersion:(w.syncVersion||0)+1,pendingSync:!0};await V.cards.update(w.id,O),await Ae.addOperation({type:"update",table:"cards",data:O,localId:w.id})}await d()}catch(E){throw console.error("Failed to update tags in cards:",E),E}},[d]),v=c.useCallback(x=>a.filter(j=>j.frontContent.tags.includes(x)||j.backContent.tags.includes(x)),[a]),y=c.useCallback(async(x,j)=>{const N=bs();try{const E=await V.cards.get(j);if(!E)throw new Error("Card not found");const w=await gt.saveImage(x,j,E.folderId),k={id:w.id,url:w.filePath,alt:x.name,width:w.metadata.width,height:w.metadata.height,aspectRatio:w.metadata.width/w.metadata.height},I=E.isFlipped?"backContent":"frontContent",K=[...E[I].images,k];return await V.cards.update(j,O=>{I==="frontContent"?O.frontContent={...O.frontContent,images:K,lastModified:new Date}:O.backContent={...O.backContent,images:K,lastModified:new Date},O.userId=N,O.updatedAt=new Date,O.syncVersion=(O.syncVersion||0)+1,O.pendingSync=!0}),await Ae.addOperation({type:"update",table:"cards",data:{[I]:{images:K},userId:N,updatedAt:new Date},localId:j}),await d(),k}catch(E){throw console.error("Failed to upload image:",E),E}},[d]);return{cards:h(),allCards:a,filter:t,setFilter:r,viewSettings:n,setViewSettings:o,selectedCardIds:i,isLoading:u,dispatch:g,getCardById:f,getSelectedCards:p,getAllTags:b,updateTagsInAllCards:C,getCardsWithTag:v,handleImageUpload:y,loadCards:d}}class Ue{static instance=null;MIGRATION_STATUS_KEY="cardall_migration_status";BACKUP_PREFIX="cardall_backup_";static getInstance(){return Ue.instance||(Ue.instance=new Ue),Ue.instance}async needsMigration(){try{return!(this.getMigrationStatus()?.completed||!se.get("cards")||await V.cards.count()>0)}catch(e){return console.error("Failed to check migration status:",e),!1}}async migrate(e={}){const{createBackup:t=!0,validateData:r=!0,cleanupAfterSuccess:n=!0,progressCallback:o}=e,i=Date.now();try{if(!await this.needsMigration()){const g={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:[],duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"completed",progress:100,message:"No migration needed"}),g}this.reportProgress(o,{stage:"starting",progress:0,message:"Starting migration..."}),this.setMigrationStatus({started:!0,startTime:new Date,stage:"starting"}),this.reportProgress(o,{stage:"loading",progress:10,message:"Loading data from localStorage..."});const u=this.loadLocalStorageData();if(u.length===0){const g={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:["No data found in localStorage"],duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"completed",progress:100,message:"No data to migrate"}),g}let m;if(t&&(this.reportProgress(o,{stage:"backup",progress:20,message:"Creating backup..."}),m=await this.createBackup(u)),r){this.reportProgress(o,{stage:"validation",progress:30,message:"Validating data integrity..."});const g=this.validateMigrationData(u);if(!g.valid)throw ce("VALIDATION_FAILED","Data validation failed",{errors:g.errors})}this.reportProgress(o,{stage:"migration",progress:50,message:`Migrating ${u.length} cards...`});const d=await this.performMigration(u,(g,f)=>{this.reportProgress(o,{stage:"migration",progress:50+g*.4,message:f})});if(r){this.reportProgress(o,{stage:"verification",progress:90,message:"Verifying migration results..."});const g=await this.verifyMigrationResults(u.length);if(!g.success)throw ce("VERIFICATION_FAILED","Migration verification failed",{details:g.errors})}n&&d.errors.length===0&&(this.reportProgress(o,{stage:"cleanup",progress:95,message:"Cleaning up original data..."}),this.cleanupLocalStorage()),this.setMigrationStatus({completed:!0,completedAt:new Date,success:!0,migratedCards:d.migratedCards,totalCards:u.length});const h={success:d.success,migratedCards:d.migratedCards,totalCards:u.length,errors:d.errors,warnings:d.warnings,duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"completed",progress:100,message:`Migration completed successfully: ${d.migratedCards}/${u.length} cards migrated`}),h}catch(l){this.setMigrationStatus({completed:!0,completedAt:new Date,success:!1,error:l instanceof Error?l.message:String(l)});const u={success:!1,migratedCards:0,totalCards:0,errors:[l instanceof Error?l.message:"Unknown migration error"],warnings:[],duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"error",progress:0,message:`Migration failed: ${l instanceof Error?l.message:"Unknown error"}`}),u}}loadLocalStorageData(){try{return ke.loadFromLocalStorage()}catch(e){throw ce("LOAD_DATA_FAILED","Failed to load data from localStorage",{error:e instanceof Error?e.message:String(e)})}}async createBackup(e){try{return await(await As.create()).backupData()}catch(t){throw ce("BACKUP_FAILED","Failed to create backup",{error:t instanceof Error?t.message:String(t)})}}validateMigrationData(e){const t=[];return Array.isArray(e)?(e.forEach((r,n)=>{const o=ke.validateCard(r);o.valid||t.push(`Card at index ${n}: ${o.errors.join(", ")}`)}),{valid:t.length===0,errors:t}):(t.push("Data is not an array"),{valid:!1,errors:t})}async performMigration(e,t){const r=[],n=[];let o=0;try{const i=ke.bulkCardsToDbCards(e);return t&&t(.1,"Starting batch migration..."),await V.cards.bulkAdd(i),o=i.length,t&&t(1,"Batch migration completed"),{migratedCards:o,errors:r,warnings:n}}catch(i){console.warn("Bulk migration failed, trying individual migration:",i);const l=e.length;for(let m=0;m<e.length;m++){const d=e[m];try{const h=ke.cardToDbCard(d);if(await V.cards.add(h),o++,t){const g=(m+1)/l;t(g,`Migrated card ${m+1}/${l}: ${d.frontContent.title}`)}}catch(h){console.error(`Failed to migrate card ${d.id}:`,h),r.push(d.id)}}return r.length===0||n.push(`Some cards failed to migrate: ${r.length} out of ${l}`),{migratedCards:o,errors:r,warnings:n}}}async verifyMigrationResults(e){const t=[];try{const r=await V.cards.count();if(r!==e&&t.push(`Record count mismatch: expected ${e}, got ${r}`),r>0){const n=await V.cards.limit(10).toArray();for(const o of n){const i=ke.dbCardToCard(o),l=ke.validateCard(i);l.valid||t.push(`Data integrity issue with card ${i.id}: ${l.errors.join(", ")}`)}}return{success:t.length===0,errors:t}}catch(r){return t.push(`Verification failed: ${r instanceof Error?r.message:String(r)}`),{success:!1,errors:t}}}cleanupLocalStorage(){try{se.remove("cards")}catch(e){console.warn("Failed to cleanup localStorage:",e)}}async rollback(){try{const e=this.getAvailableBackups();if(e.length===0)throw ce("NO_BACKUP","No backup available for rollback");const t=e[0];return await(await As.create()).restoreData(t)?(this.setMigrationStatus({rolledBack:!0,rolledBackAt:new Date,backupId:t.id}),await V.cards.clear(),!0):!1}catch(e){throw ce("ROLLBACK_FAILED","Failed to rollback migration",{error:e instanceof Error?e.message:String(e)})}}getAvailableBackups(){const e=[];try{for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t);if(r&&r.startsWith(this.BACKUP_PREFIX))try{const n=se.get(r);n&&e.push({id:r,data:JSON.stringify(n),timestamp:new Date(n.timestamp),version:n.version||"1.0.0",cardCount:n.cards?.length||0,checksum:""})}catch(n){console.warn(`Failed to parse backup ${r}:`,n)}}}catch(t){console.error("Failed to get available backups:",t)}return e.sort((t,r)=>r.timestamp.getTime()-t.timestamp.getTime())}getMigrationStatus(){try{return se.get(this.MIGRATION_STATUS_KEY)}catch{return null}}setMigrationStatus(e){try{const t=this.getMigrationStatus()||{};se.set(this.MIGRATION_STATUS_KEY,{...t,...e})}catch(t){console.error("Failed to set migration status:",t)}}reportProgress(e,t){if(e)try{e(t)}catch(r){console.error("Progress callback error:",r)}}async getMigrationStats(){try{const e=this.getMigrationStatus(),t=this.getAvailableBackups();return{migrationNeeded:await this.needsMigration(),migrationCompleted:e?.completed||!1,migrationSuccessful:e?.success||!1,lastMigrationTime:e?.completedAt||null,availableBackups:t.length,localStorageCardCount:await this.getLocalStorageCardCount(),indexedDBCardCount:await V.cards.count()}}catch(e){throw ce("GET_STATS_FAILED","Failed to get migration stats",{error:e instanceof Error?e.message:String(e)})}}async getLocalStorageCardCount(){try{return ke.loadFromLocalStorage().length}catch{return 0}}}Ue.getInstance();async function ii(){const a=new We;try{const e=await a.isIndexedDBAvailable();let t=!1,r=0;if(e&&(t=await a.hasIndexedDBData(),t))try{const i=await Os(()=>import("./sync-ajixoks1.js").then(l=>l.e),__vite__mapDeps([0,1,2,3])).then(l=>l.db);if(i&&i.isOpen()){r=await i.cards.count();const[l,u,m]=await Promise.all([i.folders.count().catch(()=>0),i.tags.count().catch(()=>0),i.images.count().catch(()=>0)]);r+=l+u+m,console.debug(`IndexedDB data count: ${r} (cards: ${await i.cards.count()}, folders: ${l}, tags: ${u}, images: ${m})`)}}catch(i){console.debug("Failed to get IndexedDB data count:",i)}let n=!1,o=0;try{const i=localStorage.getItem("cards");if(i){const u=JSON.parse(i);Array.isArray(u)&&u.length>0&&(n=!0,o=u.length,console.debug(`localStorage data count: ${o}`))}const l=["folders","tags","settings"];for(const u of l){const m=localStorage.getItem(u);if(m)try{const d=JSON.parse(m);Array.isArray(d)&&d.length>0&&(n=!0,o+=d.length)}catch(d){console.debug(`Failed to parse localStorage ${u}:`,d)}}}catch(i){console.debug("Failed to check localStorage data:",i)}if(!e)return console.debug("IndexedDB not available, using localStorage"),"localStorage";if(t&&!n)return console.debug("Only IndexedDB has data, using IndexedDB"),"indexeddb";if(!t&&n)return console.debug("Only localStorage has data, using localStorage"),"localStorage";if(t&&n)return r>o?(console.debug(`Both have data, IndexedDB has more (${r} > ${o}), using IndexedDB`),"indexeddb"):o>r?(console.debug(`Both have data, localStorage has more (${o} > ${r}), using localStorage`),"localStorage"):(console.debug("Both have equal data, preferring IndexedDB"),"indexeddb");try{const i=localStorage.getItem("preferredStorageMode");if(i==="indexeddb"&&e)return console.debug("User prefers IndexedDB, using IndexedDB"),"indexeddb";if(i==="localStorage")return console.debug("User prefers localStorage, using localStorage"),"localStorage"}catch(i){console.debug("Failed to get user preference:",i)}return e?(console.debug("Default: IndexedDB available, using IndexedDB"),"indexeddb"):(console.debug("Default: using localStorage"),"localStorage")}catch(e){return console.error("Error determining storage mode:",e),"localStorage"}}function li(){const[a,e]=c.useState({mode:"localStorage",isReady:!1}),t=ai(),r=oi();c.useEffect(()=>{(async()=>{try{e(h=>({...h,mode:"migrating",isReady:!1}));const u=Ue.getInstance();await u.needsMigration()&&await u.migrate({createBackup:!0,validateData:!0,cleanupAfterSuccess:!0,progressCallback:h=>{e(g=>({...g,migrationProgress:{stage:h.stage,progress:h.progress,message:h.message}}))}});const d=await ii();e({mode:d,isReady:!0})}catch(u){console.error("Failed to initialize adapter:",u),e({mode:"localStorage",isReady:!0})}})()},[]);const n=a.mode==="indexeddb"?r:t,o=c.useCallback(async()=>{e(l=>({...l,mode:"migrating",isReady:!1}));try{const u=await Ue.getInstance().migrate({createBackup:!0,validateData:!0,cleanupAfterSuccess:!0,progressCallback:m=>{e(d=>({...d,migrationProgress:{stage:m.stage,progress:m.progress,message:m.message}}))}});e(u?{mode:"indexeddb",isReady:!0}:{mode:"localStorage",isReady:!0})}catch(l){console.error("Migration retry failed:",l),e({mode:"localStorage",isReady:!0})}},[]),i=c.useCallback(async()=>{try{await Ue.getInstance().rollback()&&e({mode:"localStorage",isReady:!0})}catch(l){console.error("Rollback failed:",l)}},[]);return{...n,adapterState:a,storageMode:a.mode,isReady:a.isReady,migrationProgress:a.migrationProgress,retryMigration:o,rollbackMigration:i,isUsingLocalStorage:a.mode==="localStorage",isUsingIndexedDB:a.mode==="indexeddb",isMigrating:a.mode==="migrating"}}const ci=[{id:"folder-1",name:"Development",color:"#3b82f6",icon:"Code",cardIds:["1"],isExpanded:!0,createdAt:new Date("2024-01-10"),updatedAt:new Date("2024-01-15")},{id:"folder-2",name:"Design Resources",color:"#8b5cf6",icon:"Palette",cardIds:[],isExpanded:!1,createdAt:new Date("2024-01-12"),updatedAt:new Date("2024-01-12")},{id:"folder-3",name:"Learning Notes",color:"#10b981",icon:"BookOpen",cardIds:["2"],parentId:"folder-1",isExpanded:!0,createdAt:new Date("2024-01-14"),updatedAt:new Date("2024-01-16")}];function di(){const[a,e]=c.useState(ci),[t,r]=c.useState(null),n=c.useCallback(()=>{const g=a.filter(p=>!p.parentId),f=p=>p.map(b=>({...b,children:f(a.filter(C=>C.parentId===b.id))}));return f(g)},[a]),o=c.useCallback(g=>{e(f=>{switch(g.type){case"CREATE_FOLDER":const p={...g.payload,id:`folder-${Date.now()}`,cardIds:[],createdAt:new Date,updatedAt:new Date};return[...f,p];case"UPDATE_FOLDER":return f.map(C=>C.id===g.payload.id?{...C,...g.payload.updates,updatedAt:new Date}:C);case"DELETE_FOLDER":if(f.find(C=>C.id===g.payload)){const C=j=>{const N=f.filter(k=>k.parentId===j),E=N.map(k=>k.id),w=N.flatMap(k=>C(k.id));return[...E,...w]},v=C(g.payload),y=[g.payload,...v],x=f.filter(j=>y.includes(j.id)).flatMap(j=>j.cardIds);return"onDeleteCards"in g&&g.onDeleteCards&&x.length>0&&g.onDeleteCards(x),f.filter(j=>!y.includes(j.id))}return f.filter(C=>C.id!==g.payload);case"TOGGLE_FOLDER":return f.map(C=>C.id===g.payload?{...C,isExpanded:!C.isExpanded,updatedAt:new Date}:C);default:return f}})},[]),i=c.useCallback(g=>a.find(f=>f.id===g),[a]),l=c.useCallback(g=>{const f=[];let p=i(g);for(;p;)f.unshift(p),p=p.parentId?i(p.parentId):null;return f},[a,i]),u=c.useCallback((g,f)=>{o({type:"UPDATE_FOLDER",payload:{id:f,updates:{cardIds:[...i(f)?.cardIds||[],g]}}})},[o,i]),m=c.useCallback((g,f)=>{const p=i(f);p&&o({type:"UPDATE_FOLDER",payload:{id:f,updates:{cardIds:p.cardIds.filter(b=>b!==g)}}})},[o,i]),d=c.useCallback((g,f,p)=>{f&&m(g,f),p&&u(g,p)},[u,m]),h=c.useCallback((g,f)=>{if(g===f)return!1;let p=f;for(;p;){if(p===g)return!1;p=i(p)?.parentId??null}return!0},[i]);return c.useEffect(()=>{const g=setTimeout(()=>{se.set("folders",a,{validate:!0,encrypt:!0})},1e3);return()=>clearTimeout(g)},[a]),c.useEffect(()=>{const g=se.get("folders",{validate:!0,encrypt:!0});g&&e(g)},[]),{folders:a,folderTree:n(),selectedFolderId:t,setSelectedFolderId:r,dispatch:o,getFolderById:i,getFolderPath:l,addCardToFolder:u,removeCardFromFolder:m,moveCardBetweenFolders:d,canMoveFolder:h}}const ui=[{id:"tag-1",name:"react",color:"#3b82f6",count:1,createdAt:new Date("2024-01-15")},{id:"tag-2",name:"frontend",color:"#8b5cf6",count:1,createdAt:new Date("2024-01-15")},{id:"tag-3",name:"best-practices",color:"#10b981",count:1,createdAt:new Date("2024-01-15")},{id:"tag-4",name:"typescript",color:"#f59e0b",count:1,createdAt:new Date("2024-01-16")},{id:"tag-5",name:"types",color:"#ef4444",count:1,createdAt:new Date("2024-01-16")},{id:"tag-6",name:"development",color:"#06b6d4",count:1,createdAt:new Date("2024-01-16")}],nt=["#3b82f6","#8b5cf6","#10b981","#f59e0b","#ef4444","#06b6d4","#8b5a2b","#6b7280","#ec4899","#84cc16","#f97316","#6366f1"];function mi(){const[a,e]=c.useState(ui),[t,r]=c.useState([]),n=c.useCallback(()=>a.filter(v=>!t.includes(v.id)),[a,t]),o=c.useCallback(v=>{const y=[...n()].sort((x,j)=>j.count-x.count);return v?y.slice(0,v):y},[n]),i=c.useCallback(v=>{e(y=>{switch(v.type){case"CREATE_TAG":const x=y.find(N=>N.name.toLowerCase()===v.payload.name.toLowerCase());if(x)return y.map(N=>N.id===x.id?{...N,count:N.count+1}:N);const j={...v.payload,id:`tag-${Date.now()}`,count:1,color:v.payload.color||nt[y.length%nt.length],createdAt:new Date};return[...y,j];case"UPDATE_TAG":return y.map(N=>N.id===v.payload.id?{...N,...v.payload.updates}:N);case"DELETE_TAG":return y.filter(N=>N.id!==v.payload);case"TOGGLE_TAG_VISIBILITY":return r(N=>N.includes(v.payload)?N.filter(E=>E!==v.payload):[...N,v.payload]),y;default:return y}})},[]),l=c.useCallback(v=>a.find(y=>y.id===v),[a]),u=c.useCallback(v=>a.find(y=>y.name.toLowerCase()===v.toLowerCase()),[a]),m=c.useCallback((v,y)=>{const x=u(v);return x||(i({type:"CREATE_TAG",payload:{name:v,color:y||nt[a.length%nt.length]}}),null)},[i,u,a.length]),d=c.useCallback((v,y)=>{const x=u(v);if(x){const j=Math.max(0,x.count+y);i(j===0?{type:"DELETE_TAG",payload:x.id}:{type:"UPDATE_TAG",payload:{id:x.id,updates:{count:j}}})}},[i,u]),h=c.useCallback(v=>{const y=v.reduce((E,w)=>(E[w]=(E[w]||0)+1,E),{}),x=a.map(E=>({...E,count:y[E.name]||0})),j=new Set(a.map(E=>E.name));Object.entries(y).forEach(([E,w])=>{if(!j.has(E)){const k={id:`tag-${Date.now()}-${Math.random()}`,name:E,color:nt[x.length%nt.length],count:w,createdAt:new Date};x.push(k)}});const N=x.filter(E=>E.count>0);e(N)},[a]),g=c.useCallback(v=>{if(!v.trim())return n();const y=v.toLowerCase();return n().filter(x=>x.name.toLowerCase().includes(y))},[n]),f=c.useCallback((v,y=5)=>v.trim()?g(v).slice(0,y):o(y),[g,o]),p=c.useCallback((v,y)=>{const x=u(v);if(!x)return!1;const j=u(y);return j&&j.id!==x.id?!1:(i({type:"UPDATE_TAG",payload:{id:x.id,updates:{name:y.trim()}}}),!0)},[i,u]),b=c.useCallback(v=>{const y=u(v);return y?(i({type:"DELETE_TAG",payload:y.id}),!0):!1},[i,u]),C=c.useCallback(()=>a.map(v=>v.name),[a]);return c.useEffect(()=>{const v=setTimeout(()=>{se.set("tags",a,{validate:!0,encrypt:!0}),se.set("hidden-tags",t,{validate:!0,encrypt:!0})},1e3);return()=>clearTimeout(v)},[a,t]),c.useEffect(()=>{const v=se.get("tags",{validate:!0,encrypt:!0});v&&e(v);const y=se.get("hidden-tags",{validate:!0,encrypt:!0});y&&r(y)},[]),{tags:n(),allTags:a,hiddenTags:t,popularTags:o,dispatch:i,getTagById:l,getTagByName:u,createTagIfNotExists:m,updateTagCount:d,syncTagsWithCards:h,searchTags:g,getTagSuggestions:f,renameTag:p,deleteTagByName:b,getAllTagNames:C}}const vr=c.createContext(null);function fi({children:a}){const e=li(),t=di(),r=mi();B.useEffect(()=>{if(e.isReady&&!e.isMigrating){const o=[];e.allCards.forEach(i=>{o.push(...i.frontContent.tags,...i.backContent.tags)}),r.syncTagsWithCards(o)}},[e.allCards,e.isReady,e.isMigrating,r.syncTagsWithCards]);const n={cards:e,folders:t,tags:r};return s.jsx(vr.Provider,{value:n,children:a})}function zs(){const a=c.useContext(vr);if(!a)throw new Error("useCardAll must be used within a CardAllProvider");return a}function gi(){return zs().cards}function Cr(){return zs().folders}function jr(){return zs().tags}const Sr=c.createContext(void 0);function hi({children:a}){const[e,t]=c.useState(!1),r=()=>t(!0),n=()=>t(!1);return s.jsx(Sr.Provider,{value:{isOpen:e,openModal:r,closeModal:n},children:a})}function Nr(){const a=c.useContext(Sr);if(a===void 0)throw new Error("useAuthModal must be used within an AuthModalProvider");return a}function A(...a){return io(lo(a))}const Bs=Zt("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),P=c.forwardRef(({className:a,variant:e,size:t,asChild:r=!1,...n},o)=>{const i=r?Dn:"button";return s.jsx(i,{className:A(Bs({variant:e,size:t,className:a})),ref:o,...n})});P.displayName="Button";const pi=Tn,xi=An,yi=c.forwardRef(({className:a,inset:e,children:t,...r},n)=>s.jsxs(wa,{ref:n,className:A("flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",a),...r,children:[t,s.jsx(es,{className:"ml-auto"})]}));yi.displayName=wa.displayName;const wi=c.forwardRef(({className:a,...e},t)=>s.jsx(ba,{ref:t,className:A("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e}));wi.displayName=ba.displayName;const kr=c.forwardRef(({className:a,sideOffset:e=4,...t},r)=>s.jsx(Rn,{children:s.jsx(va,{ref:r,sideOffset:e,className:A("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...t})}));kr.displayName=va.displayName;const Be=c.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(Ca,{ref:r,className:A("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",a),...t}));Be.displayName=Ca.displayName;const bi=c.forwardRef(({className:a,children:e,checked:t,...r},n)=>s.jsxs(ja,{ref:n,className:A("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:t,...r,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(Sa,{children:s.jsx(qe,{className:"h-4 w-4"})})}),e]}));bi.displayName=ja.displayName;const vi=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Na,{ref:r,className:A("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(Sa,{children:s.jsx(fr,{className:"h-2 w-2 fill-current"})})}),e]}));vi.displayName=Na.displayName;const Ci=c.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(ka,{ref:r,className:A("px-2 py-1.5 text-sm font-semibold",e&&"pl-8",a),...t}));Ci.displayName=ka.displayName;const Is=c.forwardRef(({className:a,...e},t)=>s.jsx(Ea,{ref:t,className:A("-mx-1 my-1 h-px bg-muted",a),...e}));Is.displayName=Ea.displayName;const vs=[{emoji:"😀",name:"grinning"},{emoji:"😃",name:"smiley"},{emoji:"😄",name:"smile"},{emoji:"😁",name:"grin"},{emoji:"😆",name:"laughing"},{emoji:"😅",name:"sweat_smile"},{emoji:"🤣",name:"rofl"},{emoji:"😂",name:"joy"},{emoji:"🙂",name:"slightly_smiling_face"},{emoji:"🙃",name:"upside_down_face"},{emoji:"😉",name:"wink"},{emoji:"😊",name:"blush"},{emoji:"😇",name:"innocent"},{emoji:"🥰",name:"smiling_face_with_hearts"},{emoji:"😍",name:"heart_eyes"},{emoji:"🤩",name:"star_struck"},{emoji:"😘",name:"kissing_heart"},{emoji:"😗",name:"kissing"},{emoji:"😚",name:"kissing_closed_eyes"},{emoji:"😙",name:"kissing_smiling_eyes"},{emoji:"🥲",name:"smiling_face_with_tear"},{emoji:"😋",name:"yum"},{emoji:"😛",name:"stuck_out_tongue"},{emoji:"😜",name:"stuck_out_tongue_winking_eye"},{emoji:"🤪",name:"zany_face"},{emoji:"😝",name:"stuck_out_tongue_closed_eyes"},{emoji:"🤑",name:"money_mouth_face"},{emoji:"🤗",name:"hugs"},{emoji:"🤭",name:"hand_over_mouth"},{emoji:"🤫",name:"shushing_face"},{emoji:"🤔",name:"thinking"},{emoji:"🤐",name:"zipper_mouth_face"},{emoji:"🤨",name:"raised_eyebrow"},{emoji:"😐",name:"neutral_face"},{emoji:"😑",name:"expressionless"},{emoji:"😶",name:"no_mouth"},{emoji:"😏",name:"smirk"},{emoji:"😒",name:"unamused"},{emoji:"🙄",name:"roll_eyes"},{emoji:"😬",name:"grimacing"},{emoji:"🤥",name:"lying_face"},{emoji:"😔",name:"pensive"},{emoji:"😪",name:"sleepy"},{emoji:"🤤",name:"drooling_face"},{emoji:"😴",name:"sleeping"},{emoji:"😷",name:"mask"},{emoji:"🤒",name:"face_with_thermometer"},{emoji:"🤕",name:"face_with_head_bandage"},{emoji:"🤢",name:"nauseated_face"},{emoji:"🤮",name:"vomiting_face"},{emoji:"🤧",name:"sneezing_face"},{emoji:"🥵",name:"hot_face"},{emoji:"🥶",name:"cold_face"},{emoji:"🥴",name:"woozy_face"},{emoji:"😵",name:"dizzy_face"},{emoji:"🤯",name:"exploding_head"},{emoji:"🤠",name:"cowboy_hat_face"},{emoji:"🥳",name:"partying_face"},{emoji:"🥸",name:"disguised_face"},{emoji:"😎",name:"sunglasses"},{emoji:"🤓",name:"nerd_face"},{emoji:"🧐",name:"monocle_face"},{emoji:"😕",name:"confused"},{emoji:"😟",name:"worried"},{emoji:"🙁",name:"slightly_frowning_face"},{emoji:"☹️",name:"frowning_face"},{emoji:"😮",name:"open_mouth"},{emoji:"😯",name:"hushed"},{emoji:"😲",name:"astonished"},{emoji:"😳",name:"flushed"},{emoji:"🥺",name:"pleading_face"},{emoji:"😦",name:"frowning"},{emoji:"😧",name:"anguished"},{emoji:"😨",name:"fearful"},{emoji:"😰",name:"cold_sweat"},{emoji:"😥",name:"disappointed_relieved"},{emoji:"😢",name:"cry"},{emoji:"😭",name:"sob"},{emoji:"😱",name:"scream"},{emoji:"😖",name:"confounded"},{emoji:"😣",name:"persevere"},{emoji:"😞",name:"disappointed"},{emoji:"😓",name:"sweat"},{emoji:"😩",name:"weary"},{emoji:"😫",name:"tired_face"},{emoji:"🥱",name:"yawning_face"},{emoji:"😤",name:"triumph"},{emoji:"😡",name:"rage"},{emoji:"😠",name:"angry"},{emoji:"🤬",name:"cursing_face"},{emoji:"😈",name:"smiling_imp"},{emoji:"👿",name:"imp"},{emoji:"💀",name:"skull"},{emoji:"☠️",name:"skull_and_crossbones"},{emoji:"💩",name:"poop"},{emoji:"🤡",name:"clown_face"},{emoji:"👹",name:"ogre"},{emoji:"👺",name:"goblin"},{emoji:"👻",name:"ghost"},{emoji:"👽",name:"alien"},{emoji:"👾",name:"space_invader"},{emoji:"🤖",name:"robot"},{emoji:"😺",name:"smiley_cat"},{emoji:"😸",name:"smile_cat"},{emoji:"😹",name:"joy_cat"},{emoji:"😻",name:"heart_eyes_cat"},{emoji:"😼",name:"smirk_cat"},{emoji:"😽",name:"kissing_cat"},{emoji:"🙀",name:"scream_cat"},{emoji:"😿",name:"crying_cat_face"},{emoji:"😾",name:"pouting_cat"},{emoji:"👋",name:"wave"},{emoji:"🤚",name:"raised_back_of_hand"},{emoji:"🖐️",name:"raised_hand_with_fingers_splayed"},{emoji:"✋",name:"hand"},{emoji:"🖖",name:"vulcan_salute"},{emoji:"👌",name:"ok_hand"},{emoji:"🤌",name:"pinched_fingers"},{emoji:"🤏",name:"pinching_hand"},{emoji:"✌️",name:"v"},{emoji:"🤞",name:"crossed_fingers"},{emoji:"🤟",name:"love_you_gesture"},{emoji:"🤘",name:"metal"},{emoji:"🤙",name:"call_me_hand"},{emoji:"👈",name:"point_left"},{emoji:"👉",name:"point_right"},{emoji:"👆",name:"point_up_2"},{emoji:"🖕",name:"middle_finger"},{emoji:"👇",name:"point_down"},{emoji:"☝️",name:"point_up"},{emoji:"👍",name:"thumbsup"},{emoji:"👎",name:"thumbsdown"},{emoji:"✊",name:"fist"},{emoji:"👊",name:"facepunch"},{emoji:"🤛",name:"fist_left"},{emoji:"🤜",name:"fist_right"},{emoji:"👏",name:"clap"},{emoji:"🙌",name:"raised_hands"},{emoji:"👐",name:"open_hands"},{emoji:"🤲",name:"palms_up_together"},{emoji:"🤝",name:"handshake"},{emoji:"🙏",name:"pray"},{emoji:"❤️",name:"heart"},{emoji:"🧡",name:"orange_heart"},{emoji:"💛",name:"yellow_heart"},{emoji:"💚",name:"green_heart"},{emoji:"💙",name:"blue_heart"},{emoji:"💜",name:"purple_heart"},{emoji:"🖤",name:"black_heart"},{emoji:"🤍",name:"white_heart"},{emoji:"🤎",name:"brown_heart"},{emoji:"💔",name:"broken_heart"},{emoji:"❣️",name:"heavy_heart_exclamation"},{emoji:"💕",name:"two_hearts"},{emoji:"💞",name:"revolving_hearts"},{emoji:"💓",name:"heartbeat"},{emoji:"💗",name:"heartpulse"},{emoji:"💖",name:"sparkling_heart"},{emoji:"💘",name:"cupid"},{emoji:"💝",name:"gift_heart"},{emoji:"💟",name:"heart_decoration"},{emoji:"☮️",name:"peace_symbol"},{emoji:"✝️",name:"latin_cross"},{emoji:"☪️",name:"star_and_crescent"},{emoji:"🕉️",name:"om"},{emoji:"☸️",name:"wheel_of_dharma"},{emoji:"✡️",name:"star_of_david"},{emoji:"🔯",name:"six_pointed_star"},{emoji:"🕎",name:"menorah"},{emoji:"☯️",name:"yin_yang"},{emoji:"☦️",name:"orthodox_cross"},{emoji:"🛐",name:"place_of_worship"},{emoji:"⛎",name:"ophiuchus"},{emoji:"♈",name:"aries"},{emoji:"♉",name:"taurus"},{emoji:"♊",name:"gemini"},{emoji:"♋",name:"cancer"},{emoji:"♌",name:"leo"},{emoji:"♍",name:"virgo"},{emoji:"♎",name:"libra"},{emoji:"♏",name:"scorpius"},{emoji:"♐",name:"sagittarius"},{emoji:"♑",name:"capricorn"},{emoji:"♒",name:"aquarius"},{emoji:"♓",name:"pisces"},{emoji:"🆔",name:"id"},{emoji:"⚡",name:"zap"},{emoji:"💥",name:"boom"},{emoji:"💫",name:"dizzy"},{emoji:"💦",name:"sweat_drops"},{emoji:"💨",name:"dash"},{emoji:"🕳️",name:"hole"},{emoji:"💣",name:"bomb"},{emoji:"💬",name:"speech_balloon"},{emoji:"👁️‍🗨️",name:"eye_speech_bubble"},{emoji:"🗨️",name:"left_speech_bubble"},{emoji:"🗯️",name:"right_anger_bubble"},{emoji:"💭",name:"thought_balloon"},{emoji:"💤",name:"zzz"}];function ji({onEmojiSelect:a,onClose:e,query:t="",position:r}){const[n,o]=c.useState(vs);c.useEffect(()=>{if(t&&t.trim()){const d=t.toLowerCase().trim(),h=vs.filter(g=>g.name.toLowerCase().includes(d)||g.emoji.includes(t)||g.name.toLowerCase().startsWith(d));o(h.slice(0,20))}else o(vs.slice(0,40))},[t]);const i=d=>{a(d),e()},l=d=>{d.key==="Escape"&&e()},u=()=>{if(!r)return{};const d=window.innerWidth,h=window.innerHeight,g=320,f=240;let p=r.x,b=r.y;return p+g>d&&(p=d-g-20),b+f>h&&(b=r.y-f-10),{left:Math.max(10,p),top:Math.max(10,b)}},m=s.jsxs("div",{className:"fixed bg-white border border-border rounded-lg shadow-xl p-3 w-80",style:{...u(),zIndex:2147483647},onKeyDown:l,children:[t&&s.jsxs("div",{className:"text-xs text-blue-600 mb-2 font-medium",children:['"',t,'"']}),s.jsx("div",{className:"grid grid-cols-10 gap-1 max-h-52 overflow-y-auto",children:n.map((d,h)=>s.jsx(P,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 hover:bg-blue-50 text-lg transition-colors",onClick:()=>i(d.emoji),title:d.name,children:d.emoji},`${d.emoji}-${h}`))}),n.length===0&&t&&s.jsx("div",{className:"text-center text-muted-foreground text-sm py-6",children:"No emojis found"})]});return Qt.createPortal(m,document.body)}function Si({content:a,placeholder:e="Start typing...",onUpdate:t,onSave:r,onCancel:n,className:o,autoFocus:i=!1}){const[l,u]=c.useState(!1),[m,d]=c.useState(""),[h,g]=c.useState(null),f=c.useRef(null),p=Po({extensions:[Lo.configure({strike:!1,code:!1,blockquote:!1}),$o.configure({html:!0,transformPastedText:!0,transformCopiedText:!1}),zo,Bo.configure({nested:!0}),Uo.configure({openOnClick:!1,HTMLAttributes:{class:"text-blue-600 underline hover:text-blue-800 cursor-pointer",target:"_blank",rel:"noopener noreferrer"},protocols:["http","https","ftp","mailto"],validate:y=>/^https?:\/\//.test(y)}),Vo.configure({HTMLAttributes:{class:"border-l-4 border-gray-300 pl-4 italic"}}),Wo.configure({HTMLAttributes:{class:"inline-code"}}),Ho.configure({HTMLAttributes:{class:"code-block"}}),Go.configure({HTMLAttributes:{class:"line-through"}}),Ko.configure({inline:!0,allowBase64:!0,HTMLAttributes:{class:"rounded-md max-w-full h-auto"}}),Yo.configure({placeholder:e})],content:a,onUpdate:({editor:y})=>{t(y.getHTML())},editorProps:{attributes:{class:"tiptap-editor text-sm leading-relaxed focus:outline-none min-h-[100px] w-full"},handleKeyDown:(y,x)=>{if(x.key==="/"&&!l){const{selection:j}=y.state,{from:N}=j,E=y.state.doc.resolve(N),w=E.parent.textBetween(0,E.parentOffset);if(!w.trim()||w.endsWith(" ")){const I=y.coordsAtPos(N);return g({x:I.left,y:I.bottom+5}),u(!0),d(""),x.preventDefault(),!0}}if(l){if(x.key==="Escape")return u(!1),d(""),!0;if(x.key==="Backspace")return m.length>0?d(j=>j.slice(0,-1)):u(!1),!0;if(x.key.length===1&&!x.ctrlKey&&!x.metaKey&&x.key!==" ")return d(j=>j+x.key),!0;if(x.key===" ")return u(!1),d(""),!0}return!1}}}),b=c.useCallback(()=>{const y=document.createElement("input");y.type="file",y.accept="image/*",y.onchange=x=>{const j=x.target.files?.[0];if(j&&p){const N=new FileReader;N.onload=E=>{const w=E.target?.result;p.chain().focus().setImage({src:w}).run()},N.readAsDataURL(j)}},y.click()},[p]);c.useEffect(()=>{if(!p)return;const y=j=>{const N=j.clipboardData?.items;if(N)for(let E=0;E<N.length;E++){const w=N[E];if(w.type.indexOf("image")!==-1){j.preventDefault();const k=w.getAsFile();if(k){const I=new FileReader;I.onload=K=>{const O=K.target?.result;p.chain().focus().setImage({src:O}).run()},I.readAsDataURL(k)}}}},x=p.view.dom;return x.addEventListener("paste",y),()=>{x.removeEventListener("paste",y)}},[p]);const C=c.useCallback(y=>{p&&p.chain().focus().insertContent(y).run(),u(!1),d("")},[p]),v=c.useCallback(()=>{u(!1),d("")},[]);return c.useEffect(()=>{if(!p)return;const y=j=>{j.key==="Escape"?l?(u(!1),d("")):n():j.key==="Enter"&&(j.ctrlKey||j.metaKey)&&r()},x=p.view.dom;return x.addEventListener("keydown",y),()=>{x.removeEventListener("keydown",y)}},[p,r,n,l]),c.useEffect(()=>{p&&i&&p.commands.focus()},[p,i]),p?s.jsxs("div",{className:A("relative z-20",o),ref:f,children:[s.jsxs("div",{className:"relative p-2 -m-2",children:[s.jsx(qo,{editor:p,className:"min-h-[100px]"}),s.jsxs("div",{className:"absolute top-0 right-0 flex gap-1 opacity-60 hover:opacity-100 transition-opacity",children:[s.jsx(P,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white/90 hover:bg-white shadow-sm rounded",onClick:()=>u(!l),title:"Insert Emoji (Press / to open)",children:s.jsx(co,{className:"h-3 w-3"})}),s.jsx(P,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white/90 hover:bg-white shadow-sm rounded",onClick:b,title:"Insert Image",children:s.jsx(gr,{className:"h-3 w-3"})})]})]}),l&&s.jsx(ji,{onEmojiSelect:C,onClose:v,query:m,position:h||void 0}),s.jsxs("div",{className:"flex justify-end gap-2 mt-2 pt-2 border-t border-border/30",children:[s.jsxs(P,{size:"sm",variant:"ghost",onClick:n,className:"h-7 px-3 text-xs",children:[s.jsx(st,{className:"h-3 w-3 mr-1"}),"Cancel"]}),s.jsxs(P,{size:"sm",onClick:r,className:"h-7 px-3 text-xs",children:[s.jsx(qe,{className:"h-3 w-3 mr-1"}),"Accept"]})]}),p&&s.jsxs("div",{className:"absolute top-0 right-0 text-xs text-muted-foreground bg-white/90 px-2 py-1 rounded shadow-sm opacity-0 hover:opacity-100 transition-opacity pointer-events-none z-10 max-w-xs",children:["**bold** *italic* # heading - list ",">"," quote `code` ~~strike~~ [link](url) [] task / emoji"]})]}):null}function Ni({content:a,onUpdate:e,onSave:t,onCancel:r,className:n,autoFocus:o=!1}){const[i,l]=c.useState(a),u=c.useRef(null);c.useEffect(()=>{l(a)},[a]),c.useEffect(()=>{o&&u.current&&(u.current.focus(),u.current.select())},[o]);const m=h=>{l(h.target.value),e(h.target.value)},d=h=>{h.key==="Enter"?t():h.key==="Escape"&&r()};return s.jsxs("div",{className:A("relative",n),children:[s.jsx("input",{ref:u,type:"text",value:i,onChange:m,onKeyDown:d,className:"w-full bg-transparent border-none outline-none text-lg font-semibold resize-none pr-16",placeholder:"Card title..."}),s.jsxs("div",{className:"absolute right-0 top-0 flex gap-1",children:[s.jsx(P,{size:"sm",variant:"ghost",onClick:r,className:"h-6 w-6 p-0 bg-white/80 hover:bg-white shadow-sm",children:s.jsx(st,{className:"h-3 w-3"})}),s.jsx(P,{size:"sm",onClick:t,className:"h-6 w-6 p-0 bg-white/80 hover:bg-white shadow-sm",children:s.jsx(qe,{className:"h-3 w-3"})})]})]})}const ki=a=>{const e=["#3b82f6","#8b5cf6","#10b981","#f59e0b","#ef4444","#06b6d4","#8b5a2b","#6b7280","#ec4899","#84cc16","#f97316","#6366f1"];let t=0;for(let r=0;r<a.length;r++)t=a.charCodeAt(r)+((t<<5)-t);return e[Math.abs(t)%e.length]},Ei=({tags:a,className:e,maxTags:t=5,size:r="sm"})=>{if(!a||a.length===0)return null;const n=a.slice(0,t),o=a.length-t,i={sm:"text-xs px-2 py-1",md:"text-sm px-2.5 py-1.5",lg:"text-base px-3 py-2"};return s.jsxs("div",{className:A("flex flex-wrap gap-1.5 mt-3",e),children:[n.map((l,u)=>s.jsx("span",{className:A("inline-flex items-center rounded-full font-medium text-white","shadow-sm transition-all duration-200 hover:scale-105",i[r]),style:{backgroundColor:ki(l),fontSize:r==="sm"?"0.75rem":r==="md"?"0.875rem":"1rem"},children:l},`${l}-${u}`)),o>0&&s.jsxs("span",{className:A("inline-flex items-center rounded-full bg-gray-500 text-white font-medium",i[r]),children:["+",o]})]})};function Di({card:a,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onStyleChange:l,onTagsChange:u,onMoveToFolder:m,className:d,size:h="md"}){const[g,f]=c.useState(!1),[p,b]=c.useState(!1),[C,v]=c.useState(null),[y,x]=c.useState(null),[j,N]=c.useState(null),[E,w]=c.useState(!1),k=c.useRef(null),I=a.isFlipped?a.backContent:a.frontContent,K={sm:"w-full",md:"w-full",lg:"w-full"},O={sm:"p-3",md:"p-4",lg:"p-5"},H=()=>{const{style:L}=a,R={borderRadius:"1rem",fontFamily:L.fontFamily,fontSize:L.fontSize==="sm"?"0.875rem":L.fontSize==="lg"?"1.125rem":"1rem",fontWeight:L.fontWeight,color:L.textColor,borderWidth:L.borderWidth||0,borderColor:L.borderColor};let D="";return L.type==="gradient"&&L.gradientColors?(R.background=`linear-gradient(135deg, ${L.gradientColors.join(", ")})`,L.gradientColors.includes("#8a2be2")&&L.gradientColors.includes("#00ffff")?(D="gradient-wave-animation",R.position="relative"):L.gradientColors.includes("#ee7752")&&L.gradientColors.includes("#23d5ab")?D="moving-gradient-animation":L.gradientColors.includes("#667eea")&&(D="gradient-mesh-animation")):L.type==="glass"?(R.background=L.backgroundColor||"rgba(255, 255, 255, 0.15)",R.backdropFilter="blur(20px) saturate(180%)",R.WebkitBackdropFilter="blur(20px) saturate(180%)",R.border=`1px solid ${L.borderColor||"rgba(255, 255, 255, 0.18)"}`,D="glass-morphism"):L.backgroundColor&&L.backgroundColor.includes("linear-gradient")?(R.background=L.backgroundColor,R.backgroundSize="400% 400%",L.backgroundColor.includes("#667eea")&&(D="gradient-mesh-animation")):(R.backgroundColor=L.backgroundColor,L.backgroundColor==="#1a1a2e"&&L.borderColor==="#4361ee"?D="pulse-border-animation":L.backgroundColor==="#0f172a"&&(D="glow-hover-animation")),{style:R,shadowClass:{sm:"shadow-sm",md:"shadow-md",lg:"shadow-lg",xl:"shadow-xl",none:"","2xl":"shadow-2xl",glass:"shadow-lg"}[L.shadow||"md"]||"shadow-md",specialClasses:D}},{style:te,shadowClass:W,specialClasses:Z}=H(),ne=c.useCallback(L=>{L.stopPropagation(),L.preventDefault(),!E&&(w(!0),e(a.id),setTimeout(()=>{w(!1)},600))},[a.id,e,E]),re=L=>{L.stopPropagation(),z("content")},ge=L=>{z(L)},z=L=>{x(I),N(I),v(L),b(!0)},q=(L,R)=>{j&&N({...j,[L]:R,lastModified:new Date})},_=()=>{if(j){const R={[a.isFlipped?"backContent":"frontContent"]:j};t(a.id,R)}b(!1),v(null),x(null),N(null)},M=()=>{b(!1),v(null),x(null),N(null)},T=L=>{q("title",L.target.value)},U=L=>{q("text",L.target.value)},Y=L=>{L.key==="Escape"&&M(),L.key==="Enter"&&L.ctrlKey&&_()};return s.jsx("div",{className:A("relative group",d),"data-card-id":a.id,onMouseEnter:()=>f(!0),onMouseLeave:()=>f(!1),children:s.jsx("div",{className:"flip-card-container",style:{perspective:"1000px",width:"100%",minHeight:"fit-content"},children:s.jsxs("div",{ref:k,className:A("flip-card-inner relative transition-all duration-700 ease-in-out",K[h]),style:{minHeight:"fit-content",width:"100%",transformStyle:"preserve-3d",transform:a.isFlipped?"rotateY(180deg)":"rotateY(0deg)"},children:[s.jsx("div",{className:A("flip-card-face flip-card-front w-full flex flex-col transition-all duration-300 relative",W,Z,O[h]),style:{...te,borderRadius:te.borderRadius,backfaceVisibility:"hidden",position:a.isFlipped?"absolute":"relative",opacity:a.isFlipped?0:1},children:s.jsx(sa,{content:j||a.frontContent,isEditing:p&&!a.isFlipped,editingField:C,onTitleChange:T,onTextChange:U,onTempContentUpdate:q,onSaveEdit:_,onCancelEdit:M,onDoubleClick:ge,onKeyDown:Y,sideLabel:"Front",isHovered:g,onEdit:re,onFlip:ne,onCopy:()=>r(a.id),onScreenshot:()=>n(a.id),onShare:()=>o(a.id),onDelete:()=>i(a.id),onStyleChange:l?()=>l(a.id):void 0,onTagsChange:u?()=>u(a.id):void 0,onMoveToFolder:m,card:a,isFlipping:E})}),s.jsx("div",{className:A("flip-card-face flip-card-back w-full flex flex-col transition-all duration-300 relative",W,Z,O[h]),style:{...te,borderRadius:te.borderRadius,backfaceVisibility:"hidden",transform:"rotateY(180deg)",position:a.isFlipped?"relative":"absolute",top:a.isFlipped?"auto":"0",opacity:a.isFlipped?1:0},children:s.jsx(sa,{content:j||a.backContent,isEditing:p&&a.isFlipped,editingField:C,onTitleChange:T,onTextChange:U,onTempContentUpdate:q,onSaveEdit:_,onCancelEdit:M,onDoubleClick:ge,onKeyDown:Y,sideLabel:"Back",isHovered:g,onEdit:re,onFlip:ne,onCopy:()=>r(a.id),onScreenshot:()=>n(a.id),onShare:()=>o(a.id),onDelete:()=>i(a.id),onStyleChange:l?()=>l(a.id):void 0,onTagsChange:u?()=>u(a.id):void 0,onMoveToFolder:m,card:a,isFlipping:E})})]})})})}function Ri({images:a}){const e=a.slice(0,4),t=e.length,r=o=>{switch(o){case 1:return"flex justify-center";case 2:return"grid grid-cols-2 gap-2";case 3:return"grid grid-cols-2 gap-2";case 4:default:return"grid grid-cols-2 gap-2"}},n=(o,i)=>{const l="relative aspect-video rounded-md overflow-hidden bg-muted transition-all duration-200 hover:scale-[1.02]";return o===1?`${l} max-w-xs w-full`:o===3&&i===2?`${l} col-span-2 max-w-xs mx-auto`:l};return s.jsx("div",{className:r(t),children:e.map((o,i)=>s.jsx("div",{className:n(t,i),children:s.jsx("img",{src:o.url,alt:o.alt||`Image ${i+1}`,className:"w-full h-full object-cover transition-transform duration-200",loading:"lazy"})},i))})}function sa({content:a,isEditing:e,editingField:t,onTitleChange:r,onTextChange:n,onTempContentUpdate:o,onSaveEdit:i,onCancelEdit:l,onDoubleClick:u,onKeyDown:m,sideLabel:d,isHovered:h,onEdit:g,onFlip:f,onCopy:p,onScreenshot:b,onShare:C,onDelete:v,onStyleChange:y,onTagsChange:x,onMoveToFolder:j,card:N,isFlipping:E}){return s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsxs("div",{className:"flex items-start justify-between mb-3",children:[s.jsx("div",{className:"flex-1 mr-2",children:e&&t==="title"?s.jsx(Ni,{content:a.title,onUpdate:w=>o("title",w),onSave:i,onCancel:l,autoFocus:!0}):s.jsx("h3",{className:"text-lg font-semibold text-left cursor-pointer hover:bg-black/5 rounded px-1 py-0.5 -mx-1 transition-colors",onDoubleClick:()=>u("title"),children:a.title||"Untitled Card"})}),s.jsxs("div",{className:A("flex gap-1 transition-all duration-200 flex-shrink-0",h||e?"opacity-100":"opacity-60"),children:[s.jsx(P,{size:"sm",variant:"ghost",className:A("h-7 w-7 p-0 rounded-md hover:bg-black/10 transition-all duration-200",E&&"animate-pulse"),onClick:f,title:`Flip to ${N.isFlipped?"Front":"Back"}`,disabled:E,children:s.jsx(uo,{className:A("h-3.5 w-3.5 transition-transform duration-200",E&&"scale-110")})}),s.jsxs(pi,{modal:!1,children:[s.jsx(xi,{asChild:!0,children:s.jsx("div",{className:"h-7 w-7 rounded-md hover:bg-black/10 flex items-center justify-center cursor-pointer transition-colors group",onMouseEnter:w=>{w.stopPropagation();const k=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});w.currentTarget.dispatchEvent(k)},onClick:w=>w.stopPropagation(),children:s.jsx(mo,{className:"h-3.5 w-3.5"})})}),s.jsxs(kr,{align:"end",className:"w-48",children:[s.jsxs(Be,{onClick:g,children:[s.jsx(fo,{className:"h-4 w-4 mr-2"}),"Edit Content"]}),s.jsxs(Be,{onClick:p,children:[s.jsx(go,{className:"h-4 w-4 mr-2"}),"Copy Text"]}),s.jsxs(Be,{onClick:b,children:[s.jsx(Es,{className:"h-4 w-4 mr-2"}),"Screenshot"]}),s.jsxs(Be,{onClick:C,children:[s.jsx(ho,{className:"h-4 w-4 mr-2"}),"Share"]}),s.jsx(Is,{}),y&&s.jsxs(Be,{onClick:y,children:[s.jsx(hr,{className:"h-4 w-4 mr-2"}),"Change Style"]}),x&&s.jsxs(Be,{onClick:x,children:[s.jsx(pr,{className:"h-4 w-4 mr-2"}),"Manage Tags"]}),j&&s.jsxs(Be,{onClick:j,children:[s.jsx(qt,{className:"h-4 w-4 mr-2"}),"Move to Folder"]}),s.jsx(Is,{}),s.jsxs(Be,{onClick:v,className:"text-destructive focus:text-destructive",children:[s.jsx(Fs,{className:"h-4 w-4 mr-2"}),"Delete Card"]})]})]})]})]}),a.images.length>0&&s.jsxs("div",{className:"mb-3 flex-shrink-0",children:[s.jsx(Ri,{images:a.images}),a.images.length>4&&s.jsxs("div",{className:"text-xs text-muted-foreground mt-1 text-center",children:["+",a.images.length-4," more images"]})]}),s.jsx("div",{className:"flex-1 mb-3 relative z-10",children:e&&t==="content"?s.jsx(Si,{content:a.text,placeholder:"Add your content here...",onUpdate:w=>o("text",w),onSave:i,onCancel:l,autoFocus:!0}):s.jsx("div",{className:"text-sm leading-relaxed text-left cursor-pointer hover:bg-black/5 rounded p-2 -m-2 transition-colors min-h-[100px] tiptap-editor relative z-10",onDoubleClick:w=>{w.target.tagName!=="A"&&u("content")},onClick:w=>{const k=w.target;if(k.tagName==="A"){w.stopPropagation();const I=k.getAttribute("href");I&&window.open(I,"_blank","noopener,noreferrer")}},children:s.jsx("div",{className:"whitespace-pre-wrap",dangerouslySetInnerHTML:{__html:a.text||'<span class="text-muted-foreground">Click to add content...</span>'}})})}),s.jsxs("div",{className:"mt-auto",children:[s.jsx(Ei,{tags:a.tags,size:"sm"}),a.images.length>0&&s.jsx("div",{className:"flex items-center justify-end text-xs text-muted-foreground mt-2",children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(gr,{className:"h-3 w-3"}),s.jsx("span",{children:a.images.length})]})})]})]})}const Re=({title:a="Sample Card",content:e="This is a preview of how your card will look with this style.",style:t,isSelected:r=!1,onClick:n,className:o})=>{console.log("Rendering StylePreviewCard (Simplified):",{title:a,isSelected:r,style:t});const i=()=>{const l={minHeight:"60px",width:"100%",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",padding:"8px",borderRadius:"8px",cursor:"pointer",border:r?"2px solid #3b82f6":"1px solid #e5e7eb",position:"relative",fontSize:"10px",textAlign:"center",boxShadow:r?"0 4px 12px rgba(59, 130, 246, 0.3)":"0 2px 4px rgba(0, 0, 0, 0.1)",transition:"all 0.2s ease",backgroundColor:"#ffffff"};if(typeof t=="object"&&t!==null){if("background"in t||"backgroundColor"in t)return{...l,...t,cursor:"pointer",border:r?"3px solid #3b82f6":t.border||"2px solid #e5e7eb",boxShadow:r?"0 4px 12px rgba(59, 130, 246, 0.3)":t.boxShadow||"0 2px 4px rgba(0, 0, 0, 0.1)",transition:"all 0.2s ease"};if("type"in t){if(t.type==="solid")return{...l,backgroundColor:t.backgroundColor||"#ffffff",color:t.textColor||"#374151"};if(t.type==="gradient"&&t.gradientColors){const m=`linear-gradient(${t.gradientDirection||"to bottom right"}, ${t.gradientColors.join(", ")})`;return{...l,background:m,color:t.textColor||"#ffffff"}}}}return l};return s.jsxs("div",{style:i(),onClick:n,className:o,children:[s.jsx("div",{style:{fontWeight:"600",marginBottom:"2px",fontSize:"11px"},children:a}),s.jsx("div",{style:{fontSize:"9px",opacity:.8,lineHeight:"1.1"},children:e})]})},Ti=({isSelected:a,onClick:e,className:t})=>{const r={background:"#ffffff",color:"#1f2937",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"400",borderRadius:"12px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",border:"1px solid #e5e7eb"};return s.jsx(Re,{title:"Classic White",content:"Clean and professional",style:r,isSelected:a,onClick:e,className:t})},Ai={id:"classic-white",name:"Classic White",category:"business",description:"Clean and professional white background with subtle shadows",style:{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"2xl",shadow:"md",borderWidth:1,borderColor:"#e5e7eb"},previewComponent:Ti},Ii=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #1f2937 0%, #111827 50%, #030712 100%)",color:"#f9fafb",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"12px",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1)",border:"1px solid rgba(255, 255, 255, 0.1)"};return s.jsx(Re,{title:"Deep Dark",content:"Bold and mysterious",style:r,isSelected:a,onClick:e,className:t})},_i={id:"deep-dark",name:"Deep Dark",category:"personality",description:"Bold dark gradient with mysterious depth",style:{type:"gradient",gradientColors:["#1f2937","#111827","#030712"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#f9fafb",borderRadius:"2xl",shadow:"2xl",borderWidth:1,borderColor:"rgba(255, 255, 255, 0.1)"},previewComponent:Ii},Mi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #c084fc 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"20px",boxShadow:"0 20px 25px -5px rgba(139, 92, 246, 0.25), 0 10px 10px -5px rgba(139, 92, 246, 0.1)",border:"none"};return s.jsx(Re,{title:"Elegant Purple",content:"Artistic and inspiring",style:r,isSelected:a,onClick:e,className:t})},Oi={id:"elegant-purple",name:"Elegant Purple",category:"creative",description:"Artistic purple gradient with elegant curves and shadows",style:{type:"gradient",gradientColors:["#8b5cf6","#a855f7","#c084fc"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Mi},Fi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"16px",boxShadow:"0 20px 25px -5px rgba(16, 185, 129, 0.2), 0 10px 10px -5px rgba(16, 185, 129, 0.1)",border:"none"};return s.jsx(Re,{title:"Fresh Green",content:"Natural and harmonious",style:r,isSelected:a,onClick:e,className:t})},Pi={id:"fresh-green",name:"Fresh Green",category:"natural",description:"Natural green gradient with organic harmony",style:{type:"gradient",gradientColors:["#10b981","#059669","#047857"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Fi},Li=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%)",backgroundSize:"400% 400%",animation:"gradientShift 8s ease infinite",color:"#ffffff",fontFamily:'"Inter", system-ui, -apple-system, sans-serif',fontSize:"14px",fontWeight:"500",borderRadius:"12px",boxShadow:"0 8px 32px rgba(102, 126, 234, 0.3), 0 4px 16px rgba(118, 75, 162, 0.2)",border:"none",position:"relative",overflow:"hidden"},n={position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%)",pointerEvents:"none"};return s.jsxs("div",{style:{position:"relative"},children:[s.jsx(Re,{title:"Gradient Mesh",content:"Dynamic gradient background",style:r,isSelected:a,onClick:e,className:t}),s.jsx("div",{style:n}),s.jsx("style",{jsx:!0,children:`
        @keyframes gradientShift {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
      `})]})},$i={id:"gradient-mesh",name:"Gradient Mesh",category:"creative",description:"Dynamic gradient background with animated mesh effect",style:{type:"solid",backgroundColor:"linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%)",fontFamily:"Inter",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"xl",borderWidth:0,borderColor:"transparent"},previewComponent:Li},zi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(90deg, #fb923c 0%, #8b5cf6 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"24px",boxShadow:"0 25px 50px -12px rgba(251, 146, 60, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2)",border:"none"};return s.jsx(Re,{title:"Gradient Sunset",content:"Vibrant and expressive",style:r,isSelected:a,onClick:e,className:t})},Bi={id:"gradient-sunset",name:"Gradient Sunset",category:"personality",description:"Warm orange to violet gradient with magical sunset vibes",style:{type:"gradient",gradientColors:["#fb923c","#8b5cf6"],gradientDirection:"to-r",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:zi},Ui=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #8a2be2 0%, #4b0082 25%, #9370db 50%, #00ffff 75%, #00bfff 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"24px",boxShadow:"0 25px 50px -12px rgba(138, 43, 226, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2)",border:"none",position:"relative",overflow:"hidden"};return s.jsx("div",{className:"relative",children:s.jsx(Re,{title:"Gradient Wave",content:"Dynamic wave effect",style:r,isSelected:a,onClick:e,className:`${t} gradient-wave-animation`})})},Vi={id:"gradient-wave",name:"Gradient Wave",category:"creative",description:"Purple to cyan gradient with dynamic wave effect",style:{type:"gradient",gradientColors:["#8a2be2","#4b0082","#9370db","#00ffff","#00bfff"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Ui},Wi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"16px",boxShadow:"0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1)",border:"none"};return s.jsx(Re,{title:"Modern Blue",content:"Contemporary gradient design",style:r,isSelected:a,onClick:e,className:t})},Hi={id:"modern-blue",name:"Modern Blue",category:"business",description:"Contemporary blue gradient with professional appeal",style:{type:"gradient",gradientColors:["#3b82f6","#1d4ed8","#1e40af"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"lg",borderWidth:0},previewComponent:Wi},Gi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab)",backgroundSize:"400% 400%",color:"#ffffff",fontFamily:'"Poppins", system-ui, sans-serif',fontSize:"14px",fontWeight:"600",borderRadius:"16px",boxShadow:"0 15px 30px -10px rgba(0, 0, 0, 0.25)",border:"none",position:"relative",overflow:"hidden"};return s.jsx("div",{className:"relative",children:s.jsx(Re,{title:"Moving Gradient",content:"Flowing color effect",style:r,isSelected:a,onClick:e,className:`${t} moving-gradient-animation`})})},Ki={id:"moving-gradient",name:"Moving Gradient",category:"creative",description:"Colorful gradient with flowing animation effect",style:{type:"gradient",gradientColors:["#ee7752","#e73c7e","#23a6d5","#23d5ab"],gradientDirection:"to-br",fontFamily:"Poppins",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"xl",shadow:"xl",borderWidth:0},previewComponent:Gi},Yi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(90deg, #34d399 0%, #0d9488 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"20px",boxShadow:"0 10px 15px -3px rgba(52, 211, 153, 0.3), 0 4px 6px -2px rgba(13, 148, 136, 0.1)",border:"1px solid rgba(52, 211, 153, 0.3)"};return s.jsx(Re,{title:"Ocean Breeze",content:"Fresh and refreshing",style:r,isSelected:a,onClick:e,className:t})},qi={id:"ocean-breeze",name:"Ocean Breeze",category:"natural",description:"Fresh emerald to teal gradient with tropical vibes",style:{type:"gradient",gradientColors:["#34d399","#0d9488"],gradientDirection:"to-r",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"lg",borderWidth:1,borderColor:"rgba(52, 211, 153, 0.3)"},previewComponent:Yi},Ji=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(90deg, #fda4af 0%, #f87171 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"20px",boxShadow:"0 10px 15px -3px rgba(253, 164, 175, 0.3), 0 4px 6px -2px rgba(248, 113, 113, 0.1)",border:"1px solid rgba(253, 164, 175, 0.3)"};return s.jsx(Re,{title:"Soft Pink",content:"Gentle and soothing",style:r,isSelected:a,onClick:e,className:t})},Xi={id:"soft-pink",name:"Soft Pink",category:"natural",description:"Warm pink to red gradient with romantic tones",style:{type:"gradient",gradientColors:["#fda4af","#f87171"],gradientDirection:"to-r",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"lg",borderWidth:1,borderColor:"rgba(253, 164, 175, 0.3)"},previewComponent:Ji},Qi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"18px",boxShadow:"0 25px 50px -12px rgba(255, 126, 95, 0.25), 0 0 0 1px rgba(255, 126, 95, 0.1)",border:"none"};return s.jsx(Re,{title:"Warm Orange",content:"Energetic and vibrant",style:r,isSelected:a,onClick:e,className:t})},Zi={id:"warm-orange",name:"Warm Orange",category:"creative",description:"Energetic warm orange gradient with peachy tones",style:{type:"gradient",gradientColors:["#ff7e5f","#feb47b"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Qi};class lt{static instance;presets=new Map;categories=new Map;constructor(){this.initializeCategories()}static getInstance(){return lt.instance||(lt.instance=new lt),lt.instance}initializeCategories(){["business","creative","natural","personality"].forEach(t=>{this.categories.set(t,[])})}register(e){this.presets.set(e.id,e);const t=this.categories.get(e.category)||[];t.push(e),this.categories.set(e.category,t)}unregister(e){const t=this.presets.get(e);if(t){this.presets.delete(e);const n=(this.categories.get(t.category)||[]).filter(o=>o.id!==e);this.categories.set(t.category,n)}}getByCategory(e){return this.categories.get(e)||[]}getById(e){return this.presets.get(e)}getAll(){return Array.from(this.presets.values())}getAllByOrder(){const e=[];return["business","creative","natural","personality"].forEach(r=>{const n=this.getByCategory(r);e.push(...n)}),e}getCategoryCount(e){return this.categories.get(e)?.length||0}getTotalCount(){return this.presets.size}clear(){this.presets.clear(),this.initializeCategories()}}const Us=lt.getInstance(),el=()=>Us.getAllByOrder();class ct{static instance;STORAGE_KEYS={USER_PREFERENCES:"cardall_style_preferences",RECENT_STYLES:"cardall_recent_styles",DEFAULT_STYLE:"cardall_default_style"};constructor(){}static getInstance(){return ct.instance||(ct.instance=new ct),ct.instance}saveUserPreference(e,t){try{const r=this.getUserPreferences();r[e]={styleId:t,appliedAt:new Date().toISOString()},localStorage.setItem(this.STORAGE_KEYS.USER_PREFERENCES,JSON.stringify(r)),this.addToRecentStyles(t)}catch(r){console.error("Failed to save user style preference:",r)}}getUserPreference(e){try{return this.getUserPreferences()[e]?.styleId||null}catch(t){return console.error("Failed to get user style preference:",t),null}}getRecentStyles(e=10){try{const t=localStorage.getItem(this.STORAGE_KEYS.RECENT_STYLES);return t?JSON.parse(t).slice(0,e):[]}catch(t){return console.error("Failed to get recent styles:",t),[]}}clearPreferences(){try{localStorage.removeItem(this.STORAGE_KEYS.USER_PREFERENCES),localStorage.removeItem(this.STORAGE_KEYS.RECENT_STYLES)}catch(e){console.error("Failed to clear style preferences:",e)}}setDefaultStyle(e){try{localStorage.setItem(this.STORAGE_KEYS.DEFAULT_STYLE,e)}catch(t){console.error("Failed to set default style:",t)}}getDefaultStyle(){try{return localStorage.getItem(this.STORAGE_KEYS.DEFAULT_STYLE)}catch(e){return console.error("Failed to get default style:",e),null}}getUserPreferences(){try{const e=localStorage.getItem(this.STORAGE_KEYS.USER_PREFERENCES);return e?JSON.parse(e):{}}catch(e){return console.error("Failed to parse user preferences:",e),{}}}addToRecentStyles(e){try{const r=this.getRecentStyles().filter(o=>o!==e),n=[e,...r].slice(0,10);localStorage.setItem(this.STORAGE_KEYS.RECENT_STYLES,JSON.stringify(n))}catch(t){console.error("Failed to update recent styles:",t)}}getStyleUsageStats(){try{const e=this.getUserPreferences(),t={};return Object.values(e).forEach(({styleId:r})=>{t[r]=(t[r]||0)+1}),t}catch(e){return console.error("Failed to get style usage stats:",e),{}}}getMostUsedStyles(e=5){try{const t=this.getStyleUsageStats();return Object.entries(t).sort(([,r],[,n])=>n-r).slice(0,e).map(([r])=>r)}catch(t){return console.error("Failed to get most used styles:",t),[]}}}const aa=ct.getInstance(),tl=()=>{const a=[Ai,Hi,Oi,Zi,Pi,Xi,qi,_i,Bi,$i,Vi,Ki];a.forEach(e=>{Us.register(e)}),console.log(`Registered ${a.length} card style presets`)};tl();const sl=({isOpen:a,onClose:e,context:t})=>{const[r,n]=c.useState(null),[o,i]=c.useState([]);c.useEffect(()=>{const m=el();console.log("Loaded style presets:",m.length,m),i(m);const d=aa.getUserPreference(t.targetCardId);d&&n(d)},[t.targetCardId]);const l=m=>{const d=Us.getById(m);d&&(n(m),t.onStyleApply(d.style),aa.saveUserPreference(t.targetCardId,m))},u=()=>{n(null),e()};return a?s.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",style:{backgroundColor:"rgba(0, 0, 0, 0.1)",backdropFilter:"blur(2px)"},children:[s.jsx("div",{className:"absolute inset-0",onClick:u}),s.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl border border-gray-200 p-6 w-full max-w-md sm:max-w-2xl lg:max-w-4xl",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Card Styles"}),s.jsx("button",{onClick:u,className:"p-1 rounded-lg hover:bg-gray-100 transition-colors",children:s.jsx(st,{className:"w-5 h-5 text-gray-500"})})]}),s.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 mb-6",style:{minHeight:"300px",maxHeight:"70vh",overflowY:"auto"},children:o.map(m=>{const d=m.previewComponent;return console.log("Rendering preset:",m.id,m.name,d),s.jsxs("div",{className:"relative",children:[s.jsx(d,{isSelected:r===m.id,onClick:()=>l(m.id),className:"w-full"}),s.jsxs("div",{className:"mt-2 text-center",children:[s.jsx("div",{className:"text-xs font-medium text-gray-700 truncate",children:m.name}),s.jsx("div",{className:"text-xs text-gray-500 capitalize",children:m.category})]})]},m.id)})}),s.jsxs("div",{className:"text-xs text-gray-400 text-center mb-2",children:["Loaded ",o.length," presets"]}),s.jsx("div",{className:"text-xs text-gray-500 text-center",children:"Click any style to apply it instantly to your card"})]})]}):null},Er=c.createContext(void 0),al=()=>{const a=c.useContext(Er);if(!a)throw new Error("useStylePanel must be used within a StylePanelProvider");return a},rl=({children:a})=>{const[e,t]=c.useState({isOpen:!1,context:null}),r=i=>{t({isOpen:!0,context:i})},n=()=>{t({isOpen:!1,context:null})},o={openStylePanel:r,closeStylePanel:n,isOpen:e.isOpen};return s.jsxs(Er.Provider,{value:o,children:[a,typeof window<"u"&&e.isOpen&&e.context&&Qt.createPortal(s.jsx(sl,{isOpen:e.isOpen,onClose:n,context:e.context}),document.body)]})},Dr=c.createContext(void 0);function nl({children:a}){const[e,t]=c.useState(!1),[r,n]=c.useState(null),[o,i]=c.useState([]),[l,u]=c.useState(null),h={isOpen:e,currentCardId:r,currentCardTags:o,onTagsChange:l,openTagPanel:g=>{n(g.targetCardId),i(g.currentTags),u(()=>g.onTagsApply),t(!0)},closeTagPanel:()=>{t(!1),n(null),i([]),u(null)}};return s.jsx(Dr.Provider,{value:h,children:a})}function Rr(){const a=c.useContext(Dr);if(a===void 0)throw new Error("useTagPanel must be used within a TagPanelProvider");return a}const ve=c.forwardRef(({className:a,type:e,...t},r)=>s.jsx("input",{type:e,className:A("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",a),ref:r,...t}));ve.displayName="Input";const Ye=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Da,{ref:r,className:A("relative overflow-hidden",a),...t,children:[s.jsx(In,{className:"h-full w-full rounded-[inherit]",children:e}),s.jsx(Tr,{}),s.jsx(_n,{})]}));Ye.displayName=Da.displayName;const Tr=c.forwardRef(({className:a,orientation:e="vertical",...t},r)=>s.jsx(Ra,{ref:r,orientation:e,className:A("flex touch-none select-none transition-colors",e==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",e==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",a),...t,children:s.jsx(Mn,{className:"relative flex-1 rounded-full bg-border"})}));Tr.displayName=Ra.displayName;const ol=Zt("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function Q({className:a,variant:e,...t}){return s.jsx("div",{className:A(ol({variant:e}),a),...t})}const tt=Pn,il=On,Ar=c.forwardRef(({className:a,...e},t)=>s.jsx(Ta,{ref:t,className:A("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...e}));Ar.displayName=Ta.displayName;const Je=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(il,{children:[s.jsx(Ar,{}),s.jsxs(Aa,{ref:r,className:A("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...t,children:[e,s.jsxs(Fn,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[s.jsx(st,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Je.displayName=Aa.displayName;const wt=({className:a,...e})=>s.jsx("div",{className:A("flex flex-col space-y-1.5 text-center sm:text-left",a),...e});wt.displayName="DialogHeader";const bt=({className:a,...e})=>s.jsx("div",{className:A("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...e});bt.displayName="DialogFooter";const vt=c.forwardRef(({className:a,...e},t)=>s.jsx(Ia,{ref:t,className:A("text-lg font-semibold leading-none tracking-tight",a),...e}));vt.displayName=Ia.displayName;const ss=c.forwardRef(({className:a,...e},t)=>s.jsx(_a,{ref:t,className:A("text-sm text-muted-foreground",a),...e}));ss.displayName=_a.displayName;function ll({isOpen:a,onClose:e,currentCardId:t,currentFolderId:r,onFolderSelect:n}){const{folders:o,getFolderById:i}=Cr(),[l,u]=c.useState(""),[m,d]=c.useState(r);c.useEffect(()=>{a&&(d(r),u(""))},[a,r]);const h=o.filter(v=>v.name.toLowerCase().includes(l.toLowerCase())),g=r?i(r):null,f=v=>{d(v)},p=()=>{n&&n(m),e()},b=()=>{d(r),e()},C=m!==r;return s.jsx(tt,{open:a,onOpenChange:e,children:s.jsxs(Je,{className:"sm:max-w-md",children:[s.jsx(wt,{children:s.jsxs(vt,{className:"flex items-center gap-2",children:[s.jsx(Ge,{className:"h-5 w-5"}),"Move Card to Folder"]})}),s.jsxs("div",{className:"space-y-4",children:[g&&s.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted rounded-lg",children:[s.jsx(qt,{className:"h-4 w-4 text-muted-foreground"}),s.jsx("span",{className:"text-sm text-muted-foreground",children:"Currently in:"}),s.jsx(Q,{variant:"secondary",children:g.name})]}),!g&&s.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted rounded-lg",children:[s.jsx(Ys,{className:"h-4 w-4 text-muted-foreground"}),s.jsx("span",{className:"text-sm text-muted-foreground",children:"Currently in: Root"})]}),s.jsxs("div",{className:"relative",children:[s.jsx(mt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{placeholder:"Search folders...",value:l,onChange:v=>u(v.target.value),className:"pl-10"})]}),s.jsx(Ye,{className:"h-64 w-full border rounded-md",children:s.jsxs("div",{className:"p-2 space-y-1",children:[s.jsxs("div",{className:A("flex items-center gap-3 p-2 rounded-md cursor-pointer transition-colors",m===null?"bg-primary text-primary-foreground":"hover:bg-muted"),onClick:()=>f(null),children:[s.jsx(Ys,{className:"h-4 w-4 flex-shrink-0"}),s.jsx("span",{className:"flex-1",children:"Root"}),m===null&&s.jsx(qe,{className:"h-4 w-4 flex-shrink-0"}),r===null&&s.jsx(Q,{variant:"outline",className:"text-xs",children:"Current"})]}),h.map(v=>s.jsxs("div",{className:A("flex items-center gap-3 p-2 rounded-md cursor-pointer transition-colors",m===v.id?"bg-primary text-primary-foreground":"hover:bg-muted",r===v.id&&"opacity-60"),onClick:()=>f(v.id),children:[s.jsx(Ge,{className:"h-4 w-4 flex-shrink-0"}),s.jsx("span",{className:"flex-1",children:v.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Q,{variant:"outline",className:"text-xs",children:v.cardIds.length}),m===v.id&&s.jsx(qe,{className:"h-4 w-4 flex-shrink-0"}),r===v.id&&s.jsx(Q,{variant:"outline",className:"text-xs",children:"Current"})]})]},v.id)),h.length===0&&l&&s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx(Ge,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),s.jsx("p",{className:"text-sm",children:"No folders found"})]})]})})]}),s.jsxs(bt,{children:[s.jsx(P,{variant:"outline",onClick:b,children:"Cancel"}),s.jsx(P,{onClick:p,disabled:!C,children:C?"Move Card":"No Change"})]})]})})}const Ir=c.createContext(void 0);function cl({children:a}){const[e,t]=c.useState(!1),[r,n]=c.useState(null),[o,i]=c.useState(null),[l,u]=c.useState(null),m=g=>{n(g.targetCardId),i(g.currentFolderId||null),u(()=>g.onFolderApply),t(!0)},d=()=>{t(!1),n(null),i(null),u(null)},h={isOpen:e,currentCardId:r,currentFolderId:o,onFolderSelect:l,openFolderPanel:m,closeFolderPanel:d};return s.jsxs(Ir.Provider,{value:h,children:[a,typeof window<"u"&&e&&r&&Qt.createPortal(s.jsx(ll,{isOpen:e,onClose:d,currentCardId:r,currentFolderId:o,onFolderSelect:l}),document.body)]})}function dl(){const a=c.useContext(Ir);if(a===void 0)throw new Error("useFolderPanel must be used within a FolderPanelProvider");return a}function ul({card:a,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onMoveToFolder:l,className:u,size:m="md"}){const{openStylePanel:d}=al(),{openTagPanel:h}=Rr(),{openFolderPanel:g}=dl(),f=(y,x)=>{t(y,{style:x,updatedAt:new Date})},p=()=>{d({targetCardId:a.id,currentStyle:a.style,onStyleApply:y=>f(a.id,y),onPanelClose:()=>{}})},b=(y,x)=>{const j=a.isFlipped?a.backContent:a.frontContent,N=a.isFlipped?"backContent":"frontContent";t(y,{[N]:{...j,tags:x,lastModified:new Date},updatedAt:new Date})},C=()=>{const y=a.isFlipped?a.backContent:a.frontContent;h({targetCardId:a.id,currentTags:y.tags,onTagsApply:x=>b(a.id,x),onPanelClose:()=>{}})},v=()=>{l&&g({targetCardId:a.id,currentFolderId:a.folderId,onFolderApply:y=>l(a.id,y),onPanelClose:()=>{}})};return s.jsx(Di,{card:a,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onStyleChange:p,onTagsChange:C,onMoveToFolder:l?v:void 0,className:u,size:m})}function ml({items:a,gap:e=16,minColumnWidth:t=280,maxColumns:r=5,breakpoints:n={sm:640,md:768,lg:1024,xl:1280,"2xl":1536}}){const o=c.useRef(null),[i,l]=c.useState(new Map),[u,m]=c.useState(0),[d,h]=c.useState({columns:1,gap:e,containerWidth:0}),g=c.useCallback(v=>{if(v===0)return 1;let y=r;v<n.sm?y=1:v<n.md?y=2:v<n.lg?y=3:v<n.xl&&(y=4);const x=v-e,j=Math.floor(x/(t+e));return Math.min(Math.max(1,j),y)},[e,t,r,n]),f=c.useCallback((v,y,x,j)=>{if(y===0||x===0)return{positions:new Map,totalHeight:0};const N=j*(y-1),E=x-N,w=Math.floor(E/y),k=new Array(y).fill(0),I=new Map;v.forEach(O=>{const H=k.indexOf(Math.min(...k)),te=H*(w+j),W=k[H];I.set(O.id,{x:te,y:W,width:w,height:O.height}),k[H]+=O.height+j});const K=Math.max(...k)-j;return{positions:I,totalHeight:K}},[]),p=c.useCallback(v=>{const y=v[0];if(!y)return;const x=y.contentRect.width,j=g(x);h(N=>({...N,columns:j,containerWidth:x}))},[g]);c.useEffect(()=>{const v=o.current;if(!v)return;const y=new ResizeObserver(x=>{p(x)});return y.observe(v),()=>{y.disconnect()}},[p]),c.useEffect(()=>{if(a.length===0||d.containerWidth===0){l(new Map),m(0);return}const{positions:v,totalHeight:y}=f(a,d.columns,d.containerWidth,e);l(v),m(y)},[a,d,e,f]);const b=c.useCallback(v=>i.get(v),[i]),C=c.useCallback((v,y)=>{const x=a.findIndex(w=>w.id===v);if(x===-1)return;const j=[...a];j[x]={...j[x],height:y};const{positions:N,totalHeight:E}=f(j,d.columns,d.containerWidth,e);l(N),m(E)},[a,d,e,f]);return{containerRef:o,positions:i,containerHeight:u,config:d,getItemPosition:b,updateItemHeight:C}}function fl({cards:a,onCardFlip:e,onCardUpdate:t,onCardCopy:r,onCardScreenshot:n,onCardShare:o,onCardDelete:i,onMoveToFolder:l,onCardStyleChange:u,cardSize:m="md",className:d,gap:h=16,enableVirtualization:g=!0,overscan:f=5}){const[p,b]=c.useState(new Map),[C,v]=c.useState(!1),[y,x]=c.useState(0),[j,N]=c.useState(0),E=c.useRef(new Map),w=c.useRef(null),k=c.useMemo(()=>[...a].sort((z,q)=>new Date(q.createdAt).getTime()-new Date(z.createdAt).getTime()),[a]),I=c.useCallback(z=>{const _={sm:.8,md:1,lg:1.3}[m],M=200*_,T=Math.min(Math.ceil(z.frontContent.title.length/25),3)*24*_,U=Math.min(Math.ceil(z.frontContent.text.length/40),8)*18*_,Y=z.frontContent.images.length>0?120*_:0,L=z.frontContent.tags.length>0?32*_:0,R=32*_;return Math.round(M+T+U+Y+L+R)},[m]),K=c.useMemo(()=>k.map(z=>({id:z.id,height:p.get(z.id)||I(z)})),[k,p,I]),O=c.useMemo(()=>({sm:{minColumnWidth:240,maxColumns:5},md:{minColumnWidth:280,maxColumns:4},lg:{minColumnWidth:320,maxColumns:3}})[m],[m]),{containerRef:H,positions:te,containerHeight:W,updateItemHeight:Z}=ml({items:K,gap:h,...O,breakpoints:{sm:640,md:768,lg:1024,xl:1280,"2xl":1536}}),ne=c.useMemo(()=>{if(!g||!w.current)return k;const z=w.current.clientHeight,q=y-f*100,_=y+z+f*100;return k.filter(M=>{const T=te.get(M.id);return T?T.y+T.height>=q&&T.y<=_:!0})},[k,te,y,g,f]);c.useCallback(z=>{g&&x(z.currentTarget.scrollTop)},[g]);const re=c.useCallback(z=>{const q=E.current.get(z);if(!q)return;const _=new ResizeObserver(M=>{const T=M[0];if(T){const U=T.contentRect.height,Y=p.get(z);Math.abs(U-(Y||0))>3&&(b(L=>{const R=new Map(L);return R.set(z,U),R}),Z(z,U))}});return _.observe(q),()=>_.disconnect()},[p,Z]);c.useEffect(()=>{if(!C&&k.length>0){const z=new Map;k.forEach(q=>{z.set(q.id,I(q))}),b(z),v(!0)}},[k,I,C]),c.useEffect(()=>{const z=[];return ne.forEach(q=>{const _=re(q.id);_&&z.push(_)}),()=>{z.forEach(q=>q())}},[ne,re]);const ge=c.useCallback((z,q)=>{q?E.current.set(z,q):E.current.delete(z)},[]);return c.useEffect(()=>{w.current&&N(w.current.clientHeight)},[]),k.length===0?s.jsx("div",{className:"flex-1 flex items-center justify-center p-12",children:s.jsxs("div",{className:"text-center space-y-4",children:[s.jsx("div",{className:"w-24 h-24 mx-auto rounded-full bg-muted flex items-center justify-center",children:s.jsx("div",{className:"w-12 h-12 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center",children:s.jsx("span",{className:"text-white font-bold text-lg",children:"+"})})}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h3",{className:"text-lg font-semibold",children:"No cards yet"}),s.jsx("p",{className:"text-muted-foreground max-w-sm",children:"Create your first knowledge card to get started. Click the + button to begin."})]})]})}):s.jsx("div",{ref:H,className:A("relative w-full",d),style:{height:W},children:ne.map(z=>{const q=te.get(z.id);return q?s.jsx("div",{ref:_=>ge(z.id,_),className:"absolute transition-all duration-300 ease-out",style:{transform:`translate3d(${q.x}px, ${q.y}px, 0)`,width:q.width,willChange:"transform"},children:s.jsx(ul,{card:z,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onMoveToFolder:l,size:m,className:"w-full"})},z.id):null})})}const _r=c.forwardRef(({className:a,...e},t)=>s.jsxs(Ma,{ref:t,className:A("relative flex w-full touch-none select-none items-center",a),...e,children:[s.jsx(Ln,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:s.jsx($n,{className:"absolute h-full bg-primary"})}),s.jsx(zn,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));_r.displayName=Ma.displayName;const gl=Zt("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),Ce=c.forwardRef(({className:a,...e},t)=>s.jsx(Oa,{ref:t,className:A(gl(),a),...e}));Ce.displayName=Oa.displayName;const dt=c.forwardRef(({className:a,orientation:e="horizontal",decorative:t=!0,...r},n)=>s.jsx(Fa,{ref:n,decorative:t,orientation:e,className:A("shrink-0 bg-border",e==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",a),...r}));dt.displayName=Fa.displayName;const Mr=Un,Or=Vn,Vs=c.forwardRef(({className:a,align:e="center",sideOffset:t=4,...r},n)=>s.jsx(Bn,{children:s.jsx(Pa,{ref:n,align:e,sideOffset:t,className:A("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...r})}));Vs.displayName=Pa.displayName;function ra(a){if(!a)return"";try{const e=new DOMParser().parseFromString(a,"text/html");e.querySelectorAll("img").forEach(i=>i.remove()),e.querySelectorAll("br").forEach(i=>{i.replaceWith(`
`)}),e.querySelectorAll("p, div, h1, h2, h3, h4, h5, h6, li, blockquote").forEach(i=>{i.insertAdjacentText("afterend",`
`)});let o=e.body.textContent||e.body.innerText||"";return o=o.replace(/[ \t]+/g," ").replace(/[ \t]*\n[ \t]*/g,`
`).replace(/\n{3,}/g,`

`).trim(),o}catch(e){return console.warn("Failed to parse HTML, falling back to regex cleanup:",e),a.replace(/<img[^>]*>/gi,"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/?(p|div|h[1-6]|li|blockquote)[^>]*>/gi,`
`).replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/[ \t]+/g," ").replace(/[ \t]*\n[ \t]*/g,`
`).replace(/\n{3,}/g,`

`).trim()}}function hl(a,e){const t=ra(a),r=ra(e);return`${t}

${r}`}async function pl(a){try{if(navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(a),!0;{const e=document.createElement("textarea");e.value=a,e.style.position="fixed",e.style.left="-999999px",e.style.top="-999999px",document.body.appendChild(e),e.focus(),e.select();const t=document.execCommand("copy");return document.body.removeChild(e),t}}catch(e){return console.error("Failed to copy text to clipboard:",e),!1}}function xl(a,e){return a[13]=1,a[14]=e>>8,a[15]=e&255,a[16]=e>>8,a[17]=e&255,a}const Fr=112,Pr=72,Lr=89,$r=115;let Cs;function yl(){const a=new Int32Array(256);for(let e=0;e<256;e++){let t=e;for(let r=0;r<8;r++)t=t&1?3988292384^t>>>1:t>>>1;a[e]=t}return a}function wl(a){let e=-1;Cs||(Cs=yl());for(let t=0;t<a.length;t++)e=Cs[(e^a[t])&255]^e>>>8;return e^-1}function bl(a){const e=a.length-1;for(let t=e;t>=4;t--)if(a[t-4]===9&&a[t-3]===Fr&&a[t-2]===Pr&&a[t-1]===Lr&&a[t]===$r)return t-3;return 0}function vl(a,e,t=!1){const r=new Uint8Array(13);e*=39.3701,r[0]=Fr,r[1]=Pr,r[2]=Lr,r[3]=$r,r[4]=e>>>24,r[5]=e>>>16,r[6]=e>>>8,r[7]=e&255,r[8]=r[4],r[9]=r[5],r[10]=r[6],r[11]=r[7],r[12]=1;const n=wl(r),o=new Uint8Array(4);if(o[0]=n>>>24,o[1]=n>>>16,o[2]=n>>>8,o[3]=n&255,t){const i=bl(a);return a.set(r,i),a.set(o,i+13),a}else{const i=new Uint8Array(4);i[0]=0,i[1]=0,i[2]=0,i[3]=9;const l=new Uint8Array(54);return l.set(a,0),l.set(i,33),l.set(r,37),l.set(o,50),l}}const Cl="AAlwSFlz",jl="AAAJcEhZ",Sl="AAAACXBI";function Nl(a){let e=a.indexOf(Cl);return e===-1&&(e=a.indexOf(jl)),e===-1&&(e=a.indexOf(Sl)),e}const zr="[modern-screenshot]",Xe=typeof window<"u",kl=Xe&&"Worker"in window,El=Xe&&"atob"in window,Dl=Xe&&"btoa"in window,Ws=Xe?window.navigator?.userAgent:"",Br=Ws.includes("Chrome"),Xt=Ws.includes("AppleWebKit")&&!Br,Hs=Ws.includes("Firefox"),Rl=a=>a&&"__CONTEXT__"in a,Tl=a=>a.constructor.name==="CSSFontFaceRule",Al=a=>a.constructor.name==="CSSImportRule",Pe=a=>a.nodeType===1,Lt=a=>typeof a.className=="object",Ur=a=>a.tagName==="image",Il=a=>a.tagName==="use",Ot=a=>Pe(a)&&typeof a.style<"u"&&!Lt(a),_l=a=>a.nodeType===8,Ml=a=>a.nodeType===3,yt=a=>a.tagName==="IMG",as=a=>a.tagName==="VIDEO",Ol=a=>a.tagName==="CANVAS",Fl=a=>a.tagName==="TEXTAREA",Pl=a=>a.tagName==="INPUT",Ll=a=>a.tagName==="STYLE",$l=a=>a.tagName==="SCRIPT",zl=a=>a.tagName==="SELECT",Bl=a=>a.tagName==="SLOT",Ul=a=>a.tagName==="IFRAME",Vl=(...a)=>console.warn(zr,...a);function Wl(a){const e=a?.createElement?.("canvas");return e&&(e.height=e.width=1),!!e&&"toDataURL"in e&&!!e.toDataURL("image/webp").includes("image/webp")}const _s=a=>a.startsWith("data:");function Vr(a,e){if(a.match(/^[a-z]+:\/\//i))return a;if(Xe&&a.match(/^\/\//))return window.location.protocol+a;if(a.match(/^[a-z]+:/i)||!Xe)return a;const t=rs().implementation.createHTMLDocument(),r=t.createElement("base"),n=t.createElement("a");return t.head.appendChild(r),t.body.appendChild(n),e&&(r.href=e),n.href=a,n.href}function rs(a){return(a&&Pe(a)?a?.ownerDocument:a)??window.document}const ns="http://www.w3.org/2000/svg";function Hl(a,e,t){const r=rs(t).createElementNS(ns,"svg");return r.setAttributeNS(null,"width",a.toString()),r.setAttributeNS(null,"height",e.toString()),r.setAttributeNS(null,"viewBox",`0 0 ${a} ${e}`),r}function Gl(a,e){let t=new XMLSerializer().serializeToString(a);return e&&(t=t.replace(/[\u0000-\u0008\v\f\u000E-\u001F\uD800-\uDFFF\uFFFE\uFFFF]/gu,"")),`data:image/svg+xml;charset=utf-8,${encodeURIComponent(t)}`}function Kl(a,e){return new Promise((t,r)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=()=>r(n.error),n.onabort=()=>r(new Error(`Failed read blob to ${e}`)),n.readAsDataURL(a)})}const Yl=a=>Kl(a,"dataUrl");function ht(a,e){const t=rs(e).createElement("img");return t.decoding="sync",t.loading="eager",t.src=a,t}function Ft(a,e){return new Promise(t=>{const{timeout:r,ownerDocument:n,onError:o,onWarn:i}=e??{},l=typeof a=="string"?ht(a,rs(n)):a;let u=null,m=null;function d(){t(l),u&&clearTimeout(u),m?.()}if(r&&(u=setTimeout(d,r)),as(l)){const h=l.currentSrc||l.src;if(!h)return l.poster?Ft(l.poster,e).then(t):d();if(l.readyState>=2)return d();const g=d,f=p=>{i?.("Failed video load",h,p),o?.(p),d()};m=()=>{l.removeEventListener("loadeddata",g),l.removeEventListener("error",f)},l.addEventListener("loadeddata",g,{once:!0}),l.addEventListener("error",f,{once:!0})}else{const h=Ur(l)?l.href.baseVal:l.currentSrc||l.src;if(!h)return d();const g=async()=>{if(yt(l)&&"decode"in l)try{await l.decode()}catch(p){i?.("Failed to decode image, trying to render anyway",l.dataset.originalSrc||h,p)}d()},f=p=>{i?.("Failed image load",l.dataset.originalSrc||h,p),d()};if(yt(l)&&l.complete)return g();m=()=>{l.removeEventListener("load",g),l.removeEventListener("error",f)},l.addEventListener("load",g,{once:!0}),l.addEventListener("error",f,{once:!0})}})}async function ql(a,e){Ot(a)&&(yt(a)||as(a)?await Ft(a,e):await Promise.all(["img","video"].flatMap(t=>Array.from(a.querySelectorAll(t)).map(r=>Ft(r,e)))))}const Wr=function(){let e=0;const t=()=>`0000${(Math.random()*36**4<<0).toString(36)}`.slice(-4);return()=>(e+=1,`u${t()}${e}`)}();function Hr(a){return a?.split(",").map(e=>e.trim().replace(/"|'/g,"").toLowerCase()).filter(Boolean)}let na=0;function Jl(a){const e=`${zr}[#${na}]`;return na++,{time:t=>a&&console.time(`${e} ${t}`),timeEnd:t=>a&&console.timeEnd(`${e} ${t}`),warn:(...t)=>a&&Vl(...t)}}function Xl(a){return{cache:a?"no-cache":"force-cache"}}async function os(a,e){return Rl(a)?a:Ql(a,{...e,autoDestruct:!0})}async function Ql(a,e){const{scale:t=1,workerUrl:r,workerNumber:n=1}=e||{},o=!!e?.debug,i=e?.features??!0,l=a.ownerDocument??(Xe?window.document:void 0),u=a.ownerDocument?.defaultView??(Xe?window:void 0),m=new Map,d={width:0,height:0,quality:1,type:"image/png",scale:t,backgroundColor:null,style:null,filter:null,maximumCanvasSize:0,timeout:3e4,progress:null,debug:o,fetch:{requestInit:Xl(e?.fetch?.bypassingCache),placeholderImage:"data:image/png;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",bypassingCache:!1,...e?.fetch},fetchFn:null,font:{},drawImageInterval:100,workerUrl:null,workerNumber:n,onCloneEachNode:null,onCloneNode:null,onEmbedNode:null,onCreateForeignObjectSvg:null,includeStyleProperties:null,autoDestruct:!1,...e,__CONTEXT__:!0,log:Jl(o),node:a,ownerDocument:l,ownerWindow:u,dpi:t===1?null:96*t,svgStyleElement:Gr(l),svgDefsElement:l?.createElementNS(ns,"defs"),svgStyles:new Map,defaultComputedStyles:new Map,workers:[...Array.from({length:kl&&r&&n?n:0})].map(()=>{try{const f=new Worker(r);return f.onmessage=async p=>{const{url:b,result:C}=p.data;C?m.get(b)?.resolve?.(C):m.get(b)?.reject?.(new Error(`Error receiving message from worker: ${b}`))},f.onmessageerror=p=>{const{url:b}=p.data;m.get(b)?.reject?.(new Error(`Error receiving message from worker: ${b}`))},f}catch(f){return d.log.warn("Failed to new Worker",f),null}}).filter(Boolean),fontFamilies:new Map,fontCssTexts:new Map,acceptOfImage:`${[Wl(l)&&"image/webp","image/svg+xml","image/*","*/*"].filter(Boolean).join(",")};q=0.8`,requests:m,drawImageCount:0,tasks:[],features:i,isEnable:f=>f==="restoreScrollPosition"?typeof i=="boolean"?!1:i[f]??!1:typeof i=="boolean"?i:i[f]??!0,shadowRoots:[]};d.log.time("wait until load"),await ql(a,{timeout:d.timeout,onWarn:d.log.warn}),d.log.timeEnd("wait until load");const{width:h,height:g}=Zl(a,d);return d.width=h,d.height=g,d}function Gr(a){if(!a)return;const e=a.createElement("style"),t=e.ownerDocument.createTextNode(`
.______background-clip--text {
  background-clip: text;
  -webkit-background-clip: text;
}
`);return e.appendChild(t),e}function Zl(a,e){let{width:t,height:r}=e;if(Pe(a)&&(!t||!r)){const n=a.getBoundingClientRect();t=t||n.width||Number(a.getAttribute("width"))||0,r=r||n.height||Number(a.getAttribute("height"))||0}return{width:t,height:r}}async function ec(a,e){const{log:t,timeout:r,drawImageCount:n,drawImageInterval:o}=e;t.time("image to canvas");const i=await Ft(a,{timeout:r,onWarn:e.log.warn}),{canvas:l,context2d:u}=tc(a.ownerDocument,e),m=()=>{try{u?.drawImage(i,0,0,l.width,l.height)}catch(d){e.log.warn("Failed to drawImage",d)}};if(m(),e.isEnable("fixSvgXmlDecode"))for(let d=0;d<n;d++)await new Promise(h=>{setTimeout(()=>{u?.clearRect(0,0,l.width,l.height),m(),h()},d+o)});return e.drawImageCount=0,t.timeEnd("image to canvas"),l}function tc(a,e){const{width:t,height:r,scale:n,backgroundColor:o,maximumCanvasSize:i}=e,l=a.createElement("canvas");l.width=Math.floor(t*n),l.height=Math.floor(r*n),l.style.width=`${t}px`,l.style.height=`${r}px`,i&&(l.width>i||l.height>i)&&(l.width>i&&l.height>i?l.width>l.height?(l.height*=i/l.width,l.width=i):(l.width*=i/l.height,l.height=i):l.width>i?(l.height*=i/l.width,l.width=i):(l.width*=i/l.height,l.height=i));const u=l.getContext("2d");return u&&o&&(u.fillStyle=o,u.fillRect(0,0,l.width,l.height)),{canvas:l,context2d:u}}function Kr(a,e){if(a.ownerDocument)try{const o=a.toDataURL();if(o!=="data:,")return ht(o,a.ownerDocument)}catch(o){e.log.warn("Failed to clone canvas",o)}const t=a.cloneNode(!1),r=a.getContext("2d"),n=t.getContext("2d");try{return r&&n&&n.putImageData(r.getImageData(0,0,a.width,a.height),0,0),t}catch(o){e.log.warn("Failed to clone canvas",o)}return t}function sc(a,e){try{if(a?.contentDocument?.body)return Gs(a.contentDocument.body,e)}catch(t){e.log.warn("Failed to clone iframe",t)}return a.cloneNode(!1)}function ac(a){const e=a.cloneNode(!1);return a.currentSrc&&a.currentSrc!==a.src&&(e.src=a.currentSrc,e.srcset=""),e.loading==="lazy"&&(e.loading="eager"),e}async function rc(a,e){if(a.ownerDocument&&!a.currentSrc&&a.poster)return ht(a.poster,a.ownerDocument);const t=a.cloneNode(!1);t.crossOrigin="anonymous",a.currentSrc&&a.currentSrc!==a.src&&(t.src=a.currentSrc);const r=t.ownerDocument;if(r){let n=!0;if(await Ft(t,{onError:()=>n=!1,onWarn:e.log.warn}),!n)return a.poster?ht(a.poster,a.ownerDocument):t;t.currentTime=a.currentTime,await new Promise(i=>{t.addEventListener("seeked",i,{once:!0})});const o=r.createElement("canvas");o.width=a.offsetWidth,o.height=a.offsetHeight;try{const i=o.getContext("2d");i&&i.drawImage(t,0,0,o.width,o.height)}catch(i){return e.log.warn("Failed to clone video",i),a.poster?ht(a.poster,a.ownerDocument):t}return Kr(o,e)}return t}function nc(a,e){return Ol(a)?Kr(a,e):Ul(a)?sc(a,e):yt(a)?ac(a):as(a)?rc(a,e):a.cloneNode(!1)}function oc(a){let e=a.sandbox;if(!e){const{ownerDocument:t}=a;try{t&&(e=t.createElement("iframe"),e.id=`__SANDBOX__${Wr()}`,e.width="0",e.height="0",e.style.visibility="hidden",e.style.position="fixed",t.body.appendChild(e),e.srcdoc='<!DOCTYPE html><meta charset="UTF-8"><title></title><body>',a.sandbox=e)}catch(r){a.log.warn("Failed to getSandBox",r)}}return e}const ic=["width","height","-webkit-text-fill-color"],lc=["stroke","fill"];function Yr(a,e,t){const{defaultComputedStyles:r}=t,n=a.nodeName.toLowerCase(),o=Lt(a)&&n!=="svg",i=o?lc.map(b=>[b,a.getAttribute(b)]).filter(([,b])=>b!==null):[],l=[o&&"svg",n,i.map((b,C)=>`${b}=${C}`).join(","),e].filter(Boolean).join(":");if(r.has(l))return r.get(l);const m=oc(t)?.contentWindow;if(!m)return new Map;const d=m?.document;let h,g;o?(h=d.createElementNS(ns,"svg"),g=h.ownerDocument.createElementNS(h.namespaceURI,n),i.forEach(([b,C])=>{g.setAttributeNS(null,b,C)}),h.appendChild(g)):h=g=d.createElement(n),g.textContent=" ",d.body.appendChild(h);const f=m.getComputedStyle(g,e),p=new Map;for(let b=f.length,C=0;C<b;C++){const v=f.item(C);ic.includes(v)||p.set(v,f.getPropertyValue(v))}return d.body.removeChild(h),r.set(l,p),p}function qr(a,e,t){const r=new Map,n=[],o=new Map;if(t)for(const l of t)i(l);else for(let l=a.length,u=0;u<l;u++){const m=a.item(u);i(m)}for(let l=n.length,u=0;u<l;u++)o.get(n[u])?.forEach((m,d)=>r.set(d,m));function i(l){const u=a.getPropertyValue(l),m=a.getPropertyPriority(l),d=l.lastIndexOf("-"),h=d>-1?l.substring(0,d):void 0;if(h){let g=o.get(h);g||(g=new Map,o.set(h,g)),g.set(l,[u,m])}e.get(l)===u&&!m||(h?n.push(h):r.set(l,[u,m]))}return r}function cc(a,e,t,r){const{ownerWindow:n,includeStyleProperties:o,currentParentNodeStyle:i}=r,l=e.style,u=n.getComputedStyle(a),m=Yr(a,null,r);i?.forEach((h,g)=>{m.delete(g)});const d=qr(u,m,o);d.delete("transition-property"),d.delete("all"),d.delete("d"),d.delete("content"),t&&(d.delete("margin-top"),d.delete("margin-right"),d.delete("margin-bottom"),d.delete("margin-left"),d.delete("margin-block-start"),d.delete("margin-block-end"),d.delete("margin-inline-start"),d.delete("margin-inline-end"),d.set("box-sizing",["border-box",""])),d.get("background-clip")?.[0]==="text"&&e.classList.add("______background-clip--text"),Br&&(d.has("font-kerning")||d.set("font-kerning",["normal",""]),(d.get("overflow-x")?.[0]==="hidden"||d.get("overflow-y")?.[0]==="hidden")&&d.get("text-overflow")?.[0]==="ellipsis"&&a.scrollWidth===a.clientWidth&&d.set("text-overflow",["clip",""]));for(let h=l.length,g=0;g<h;g++)l.removeProperty(l.item(g));return d.forEach(([h,g],f)=>{l.setProperty(f,h,g)}),d}function dc(a,e){(Fl(a)||Pl(a)||zl(a))&&e.setAttribute("value",a.value)}const uc=[":before",":after"],mc=[":-webkit-scrollbar",":-webkit-scrollbar-button",":-webkit-scrollbar-thumb",":-webkit-scrollbar-track",":-webkit-scrollbar-track-piece",":-webkit-scrollbar-corner",":-webkit-resizer"];function fc(a,e,t,r,n){const{ownerWindow:o,svgStyleElement:i,svgStyles:l,currentNodeStyle:u}=r;if(!i||!o)return;function m(d){const h=o.getComputedStyle(a,d);let g=h.getPropertyValue("content");if(!g||g==="none")return;n?.(g),g=g.replace(/(')|(")|(counter\(.+\))/g,"");const f=[Wr()],p=Yr(a,d,r);u?.forEach((x,j)=>{p.delete(j)});const b=qr(h,p,r.includeStyleProperties);b.delete("content"),b.delete("-webkit-locale"),b.get("background-clip")?.[0]==="text"&&e.classList.add("______background-clip--text");const C=[`content: '${g}';`];if(b.forEach(([x,j],N)=>{C.push(`${N}: ${x}${j?" !important":""};`)}),C.length===1)return;try{e.className=[e.className,...f].join(" ")}catch(x){r.log.warn("Failed to copyPseudoClass",x);return}const v=C.join(`
  `);let y=l.get(v);y||(y=[],l.set(v,y)),y.push(`.${f[0]}:${d}`)}uc.forEach(m),t&&mc.forEach(m)}const oa=new Set(["symbol"]);async function ia(a,e,t,r,n){if(Pe(t)&&(Ll(t)||$l(t))||r.filter&&!r.filter(t))return;oa.has(e.nodeName)||oa.has(t.nodeName)?r.currentParentNodeStyle=void 0:r.currentParentNodeStyle=r.currentNodeStyle;const o=await Gs(t,r,!1,n);r.isEnable("restoreScrollPosition")&&gc(a,o),e.appendChild(o)}async function la(a,e,t,r){let n=a.firstChild;Pe(a)&&a.shadowRoot&&(n=a.shadowRoot?.firstChild,t.shadowRoots.push(a.shadowRoot));for(let o=n;o;o=o.nextSibling)if(!_l(o))if(Pe(o)&&Bl(o)&&typeof o.assignedNodes=="function"){const i=o.assignedNodes();for(let l=0;l<i.length;l++)await ia(a,e,i[l],t,r)}else await ia(a,e,o,t,r)}function gc(a,e){if(!Ot(a)||!Ot(e))return;const{scrollTop:t,scrollLeft:r}=a;if(!t&&!r)return;const{transform:n}=e.style,o=new DOMMatrix(n),{a:i,b:l,c:u,d:m}=o;o.a=1,o.b=0,o.c=0,o.d=1,o.translateSelf(-r,-t),o.a=i,o.b=l,o.c=u,o.d=m,e.style.transform=o.toString()}function hc(a,e){const{backgroundColor:t,width:r,height:n,style:o}=e,i=a.style;if(t&&i.setProperty("background-color",t,"important"),r&&i.setProperty("width",`${r}px`,"important"),n&&i.setProperty("height",`${n}px`,"important"),o)for(const l in o)i[l]=o[l]}const pc=/^[\w-:]+$/;async function Gs(a,e,t=!1,r){const{ownerDocument:n,ownerWindow:o,fontFamilies:i,onCloneEachNode:l}=e;if(n&&Ml(a))return r&&/\S/.test(a.data)&&r(a.data),n.createTextNode(a.data);if(n&&o&&Pe(a)&&(Ot(a)||Lt(a))){const m=await nc(a,e);if(e.isEnable("removeAbnormalAttributes")){const b=m.getAttributeNames();for(let C=b.length,v=0;v<C;v++){const y=b[v];pc.test(y)||m.removeAttribute(y)}}const d=e.currentNodeStyle=cc(a,m,t,e);t&&hc(m,e);let h=!1;if(e.isEnable("copyScrollbar")){const b=[d.get("overflow-x")?.[0],d.get("overflow-y")?.[0]];h=b.includes("scroll")||(b.includes("auto")||b.includes("overlay"))&&(a.scrollHeight>a.clientHeight||a.scrollWidth>a.clientWidth)}const g=d.get("text-transform")?.[0],f=Hr(d.get("font-family")?.[0]),p=f?b=>{g==="uppercase"?b=b.toUpperCase():g==="lowercase"?b=b.toLowerCase():g==="capitalize"&&(b=b[0].toUpperCase()+b.substring(1)),f.forEach(C=>{let v=i.get(C);v||i.set(C,v=new Set),b.split("").forEach(y=>v.add(y))})}:void 0;return fc(a,m,h,e,p),dc(a,m),as(a)||await la(a,m,e,p),await l?.(m),m}const u=a.cloneNode(!1);return await la(a,u,e),await l?.(u),u}function xc(a){if(a.ownerDocument=void 0,a.ownerWindow=void 0,a.svgStyleElement=void 0,a.svgDefsElement=void 0,a.svgStyles.clear(),a.defaultComputedStyles.clear(),a.sandbox){try{a.sandbox.remove()}catch(e){a.log.warn("Failed to destroyContext",e)}a.sandbox=void 0}a.workers=[],a.fontFamilies.clear(),a.fontCssTexts.clear(),a.requests.clear(),a.tasks=[],a.shadowRoots=[]}function yc(a){const{url:e,timeout:t,responseType:r,...n}=a,o=new AbortController,i=t?setTimeout(()=>o.abort(),t):void 0;return fetch(e,{signal:o.signal,...n}).then(l=>{if(!l.ok)throw new Error("Failed fetch, not 2xx response",{cause:l});switch(r){case"arrayBuffer":return l.arrayBuffer();case"dataUrl":return l.blob().then(Yl);case"text":default:return l.text()}}).finally(()=>clearTimeout(i))}function Pt(a,e){const{url:t,requestType:r="text",responseType:n="text",imageDom:o}=e;let i=t;const{timeout:l,acceptOfImage:u,requests:m,fetchFn:d,fetch:{requestInit:h,bypassingCache:g,placeholderImage:f},font:p,workers:b,fontFamilies:C}=a;r==="image"&&(Xt||Hs)&&a.drawImageCount++;let v=m.get(t);if(!v){g&&g instanceof RegExp&&g.test(i)&&(i+=(/\?/.test(i)?"&":"?")+new Date().getTime());const y=r.startsWith("font")&&p&&p.minify,x=new Set;y&&r.split(";")[1].split(",").forEach(w=>{C.has(w)&&C.get(w).forEach(k=>x.add(k))});const j=y&&x.size,N={url:i,timeout:l,responseType:j?"arrayBuffer":n,headers:r==="image"?{accept:u}:void 0,...h};v={type:r,resolve:void 0,reject:void 0,response:null},v.response=(async()=>{if(d&&r==="image"){const E=await d(t);if(E)return E}return!Xt&&t.startsWith("http")&&b.length?new Promise((E,w)=>{b[m.size&b.length-1].postMessage({rawUrl:t,...N}),v.resolve=E,v.reject=w}):yc(N)})().catch(E=>{if(m.delete(t),r==="image"&&f)return a.log.warn("Failed to fetch image base64, trying to use placeholder image",i),typeof f=="string"?f:f(o);throw E}),m.set(t,v)}return v.response}async function Jr(a,e,t,r){if(!Xr(a))return a;for(const[n,o]of wc(a,e))try{const i=await Pt(t,{url:o,requestType:r?"image":"text",responseType:"dataUrl"});a=a.replace(bc(n),`$1${i}$3`)}catch(i){t.log.warn("Failed to fetch css data url",n,i)}return a}function Xr(a){return/url\((['"]?)([^'"]+?)\1\)/.test(a)}const Qr=/url\((['"]?)([^'"]+?)\1\)/g;function wc(a,e){const t=[];return a.replace(Qr,(r,n,o)=>(t.push([o,Vr(o,e)]),r)),t.filter(([r])=>!_s(r))}function bc(a){const e=a.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1");return new RegExp(`(url\\(['"]?)(${e})(['"]?\\))`,"g")}const vc=["background-image","border-image-source","-webkit-border-image","-webkit-mask-image","list-style-image"];function Cc(a,e){return vc.map(t=>{const r=a.getPropertyValue(t);return!r||r==="none"?null:((Xt||Hs)&&e.drawImageCount++,Jr(r,null,e,!0).then(n=>{!n||r===n||a.setProperty(t,n,a.getPropertyPriority(t))}))}).filter(Boolean)}function jc(a,e){if(yt(a)){const t=a.currentSrc||a.src;if(!_s(t))return[Pt(e,{url:t,imageDom:a,requestType:"image",responseType:"dataUrl"}).then(r=>{r&&(a.srcset="",a.dataset.originalSrc=t,a.src=r||"")})];(Xt||Hs)&&e.drawImageCount++}else if(Lt(a)&&!_s(a.href.baseVal)){const t=a.href.baseVal;return[Pt(e,{url:t,imageDom:a,requestType:"image",responseType:"dataUrl"}).then(r=>{r&&(a.dataset.originalSrc=t,a.href.baseVal=r||"")})]}return[]}function Sc(a,e){const{ownerDocument:t,svgDefsElement:r}=e,n=a.getAttribute("href")??a.getAttribute("xlink:href");if(!n)return[];const[o,i]=n.split("#");if(i){const l=`#${i}`,u=e.shadowRoots.reduce((m,d)=>m??d.querySelector(`svg ${l}`),t?.querySelector(`svg ${l}`));if(o&&a.setAttribute("href",l),r?.querySelector(l))return[];if(u)return r?.appendChild(u.cloneNode(!0)),[];if(o)return[Pt(e,{url:o,responseType:"text"}).then(m=>{r?.insertAdjacentHTML("beforeend",m)})]}return[]}function Zr(a,e){const{tasks:t}=e;Pe(a)&&((yt(a)||Ur(a))&&t.push(...jc(a,e)),Il(a)&&t.push(...Sc(a,e))),Ot(a)&&t.push(...Cc(a.style,e)),a.childNodes.forEach(r=>{Zr(r,e)})}async function Nc(a,e){const{ownerDocument:t,svgStyleElement:r,fontFamilies:n,fontCssTexts:o,tasks:i,font:l}=e;if(!(!t||!r||!n.size))if(l&&l.cssText){const u=da(l.cssText,e);r.appendChild(t.createTextNode(`${u}
`))}else{const u=Array.from(t.styleSheets).filter(d=>{try{return"cssRules"in d&&!!d.cssRules.length}catch(h){return e.log.warn(`Error while reading CSS rules from ${d.href}`,h),!1}});await Promise.all(u.flatMap(d=>Array.from(d.cssRules).map(async(h,g)=>{if(Al(h)){let f=g+1;const p=h.href;let b="";try{b=await Pt(e,{url:p,requestType:"text",responseType:"text"})}catch(v){e.log.warn(`Error fetch remote css import from ${p}`,v)}const C=b.replace(Qr,(v,y,x)=>v.replace(x,Vr(x,p)));for(const v of Ec(C))try{d.insertRule(v,v.startsWith("@import")?f+=1:d.cssRules.length)}catch(y){e.log.warn("Error inserting rule from remote css import",{rule:v,error:y})}}}))),u.flatMap(d=>Array.from(d.cssRules)).filter(d=>Tl(d)&&Xr(d.style.getPropertyValue("src"))&&Hr(d.style.getPropertyValue("font-family"))?.some(h=>n.has(h))).forEach(d=>{const h=d,g=o.get(h.cssText);g?r.appendChild(t.createTextNode(`${g}
`)):i.push(Jr(h.cssText,h.parentStyleSheet?h.parentStyleSheet.href:null,e).then(f=>{f=da(f,e),o.set(h.cssText,f),r.appendChild(t.createTextNode(`${f}
`))}))})}}const kc=/(\/\*[\s\S]*?\*\/)/g,ca=/((@.*?keyframes [\s\S]*?){([\s\S]*?}\s*?)})/gi;function Ec(a){if(a==null)return[];const e=[];let t=a.replace(kc,"");for(;;){const o=ca.exec(t);if(!o)break;e.push(o[0])}t=t.replace(ca,"");const r=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,n=new RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");for(;;){let o=r.exec(t);if(o)n.lastIndex=r.lastIndex;else if(o=n.exec(t),o)r.lastIndex=n.lastIndex;else break;e.push(o[0])}return e}const Dc=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,Rc=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function da(a,e){const{font:t}=e,r=t?t?.preferredFormat:void 0;return r?a.replace(Rc,n=>{for(;;){const[o,,i]=Dc.exec(n)||[];if(!i)return"";if(i===r)return`src: ${o};`}}):a}async function Tc(a,e){const t=await os(a,e);if(Pe(t.node)&&Lt(t.node))return t.node;const{ownerDocument:r,log:n,tasks:o,svgStyleElement:i,svgDefsElement:l,svgStyles:u,font:m,progress:d,autoDestruct:h,onCloneNode:g,onEmbedNode:f,onCreateForeignObjectSvg:p}=t;n.time("clone node");const b=await Gs(t.node,t,!0);if(i&&r){let j="";u.forEach((N,E)=>{j+=`${N.join(`,
`)} {
  ${E}
}
`}),i.appendChild(r.createTextNode(j))}n.timeEnd("clone node"),await g?.(b),m!==!1&&Pe(b)&&(n.time("embed web font"),await Nc(b,t),n.timeEnd("embed web font")),n.time("embed node"),Zr(b,t);const C=o.length;let v=0;const y=async()=>{for(;;){const j=o.pop();if(!j)break;try{await j}catch(N){t.log.warn("Failed to run task",N)}d?.(++v,C)}};d?.(v,C),await Promise.all([...Array.from({length:4})].map(y)),n.timeEnd("embed node"),await f?.(b);const x=Ac(b,t);return l&&x.insertBefore(l,x.children[0]),i&&x.insertBefore(i,x.children[0]),h&&xc(t),await p?.(x),x}function Ac(a,e){const{width:t,height:r}=e,n=Hl(t,r,a.ownerDocument),o=n.ownerDocument.createElementNS(n.namespaceURI,"foreignObject");return o.setAttributeNS(null,"x","0%"),o.setAttributeNS(null,"y","0%"),o.setAttributeNS(null,"width","100%"),o.setAttributeNS(null,"height","100%"),o.append(a),n.appendChild(o),n}async function Ic(a,e){const t=await os(a,e),r=await Tc(t),n=Gl(r,t.isEnable("removeControlCharacter"));t.autoDestruct||(t.svgStyleElement=Gr(t.ownerDocument),t.svgDefsElement=t.ownerDocument?.createElementNS(ns,"defs"),t.svgStyles.clear());const o=ht(n,r.ownerDocument);return await ec(o,t)}async function _c(a,e){const t=await os(a,e),{log:r,quality:n,type:o,dpi:i}=t,l=await Ic(t);r.time("canvas to data url");let u=l.toDataURL(o,n);if(["image/png","image/jpeg"].includes(o)&&i&&El&&Dl){const[m,d]=u.split(",");let h=0,g=!1;if(o==="image/png"){const x=Nl(d);x>=0?(h=Math.ceil((x+28)/3)*4,g=!0):h=33/3*4}else o==="image/jpeg"&&(h=18/3*4);const f=d.substring(0,h),p=d.substring(h),b=window.atob(f),C=new Uint8Array(b.length);for(let x=0;x<C.length;x++)C[x]=b.charCodeAt(x);const v=o==="image/png"?vl(C,i,g):xl(C,i),y=window.btoa(String.fromCharCode(...v));u=[m,",",y,p].join("")}return r.timeEnd("canvas to data url"),u}async function Mc(a,e){return _c(await os(a,{...e,type:"image/png"}))}function Oc(a,e=30){if(!a||a.trim()==="")return"untitled-card";let t=a.replace(/[^\w\s\u4e00-\u9fff\u3400-\u4dbf\u20000-\u2a6df\u2a700-\u2b73f\u2b740-\u2b81f\u2b820-\u2ceaf\uf900-\ufaff\u3300-\u33ff-]/g,"").replace(/\s+/g," ").trim();return t?(t.length>e&&(t=t.substring(0,e).trim()),t):"untitled-card"}async function Fc(a,e={}){const{quality:t=1,pixelRatio:r=2,backgroundColor:n="transparent",includeStyles:o=!0}=e;try{const i=await Mc(a,{quality:t,pixelRatio:r,backgroundColor:n,style:o?void 0:{},filter:u=>{if(u instanceof HTMLElement){const m=u.classList;return!m.contains("tooltip")&&!m.contains("dropdown-menu")&&!m.contains("popover")}return!0}});return await(await fetch(i)).blob()}catch(i){throw console.error("Screenshot capture failed:",i),new Error("Failed to capture screenshot")}}function Pc(a,e){const t=URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download=`${e}.png`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t)}async function Lc(a,e,t={}){const r=Oc(e);return{blob:await Fc(a,{quality:1,pixelRatio:2,backgroundColor:"transparent",...t}),fileName:r}}function $c(a={}){const[e,t]=c.useState(!1),[r,n]=c.useState(!1),[o,i]=c.useState(null),[l,u]=c.useState(!1),[m,d]=c.useState(null),h=c.useCallback(async(b,C)=>{t(!0),d(null);try{const{blob:v,fileName:y}=await Lc(b,C),x=URL.createObjectURL(v);i({blob:v,fileName:y,previewUrl:x}),u(!0)}catch(v){const y=v instanceof Error?v:new Error("Screenshot failed");d(y.message),a.onError?.(y)}finally{t(!1)}},[a]),g=c.useCallback(async()=>{if(o){n(!0);try{await new Promise(b=>setTimeout(b,500)),Pc(o.blob,o.fileName),a.onSuccess?.(o.fileName),u(!1),setTimeout(()=>{o.previewUrl&&URL.revokeObjectURL(o.previewUrl),i(null)},100)}catch(b){const C=b instanceof Error?b:new Error("Download failed");d(C.message),a.onError?.(C)}finally{n(!1)}}},[o,a]),f=c.useCallback(()=>{u(!1),setTimeout(()=>{o?.previewUrl&&URL.revokeObjectURL(o.previewUrl),i(null)},100)},[o]),p=c.useCallback(()=>{d(null)},[]);return{isCapturing:e,isDownloading:r,showPreview:l,previewData:o,error:m,captureScreenshot:h,confirmDownload:g,cancelPreview:f,clearError:p}}function zc({isOpen:a,onClose:e,onConfirm:t,previewUrl:r,fileName:n,isDownloading:o=!1}){const[i,l]=c.useState(!1),u=()=>{l(!0),setTimeout(()=>{t(),l(!1)},800)};return s.jsx(tt,{open:a,onOpenChange:e,children:s.jsxs(Je,{className:"max-w-2xl max-h-[90vh] overflow-hidden",children:[s.jsx(wt,{children:s.jsxs(vt,{className:"flex items-center gap-2",children:[s.jsx(Es,{className:"h-5 w-5"}),"Screenshot Preview"]})}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"flex items-center justify-between",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(Q,{variant:"secondary",className:"font-mono text-xs",children:[n,".png"]}),s.jsx(Q,{variant:"outline",className:"text-xs",children:"High Quality"})]})}),s.jsx("div",{className:"relative bg-checkered rounded-lg overflow-hidden border",children:r?s.jsxs("div",{className:"relative",children:[s.jsx("img",{src:r,alt:"Screenshot preview",className:A("w-full h-auto max-h-[60vh] object-contain transition-all duration-300",i&&"scale-95 opacity-80")}),i&&s.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/20 to-purple-600/20 flex items-center justify-center",children:s.jsx("div",{className:"bg-white/90 backdrop-blur-sm rounded-full p-6 shadow-lg animate-pulse",children:s.jsxs("div",{className:"relative",children:[s.jsx(ft,{className:"h-8 w-8 text-blue-600 animate-bounce"}),s.jsx(qs,{className:"h-4 w-4 text-purple-500 absolute -top-1 -right-1 animate-spin"})]})})})]}):s.jsx("div",{className:"h-64 flex items-center justify-center text-muted-foreground",children:s.jsxs("div",{className:"text-center space-y-2",children:[s.jsx(Es,{className:"h-12 w-12 mx-auto opacity-50"}),s.jsx("p",{children:"Loading preview..."})]})})}),o&&s.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-muted-foreground",children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent"}),"Preparing download..."]})]}),s.jsxs(bt,{className:"gap-2",children:[s.jsxs(P,{variant:"outline",onClick:e,disabled:i||o,children:[s.jsx(st,{className:"h-4 w-4 mr-2"}),"Cancel"]}),s.jsx(P,{onClick:u,disabled:i||o||!r,className:A("relative overflow-hidden",i&&"bg-gradient-to-r from-blue-500 to-purple-600"),children:i?s.jsxs(s.Fragment,{children:[s.jsx(qs,{className:"h-4 w-4 mr-2 animate-spin"}),"Downloading..."]}):s.jsxs(s.Fragment,{children:[s.jsx(ft,{className:"h-4 w-4 mr-2"}),"Download PNG"]})})]})]})})}const Bc=`
.bg-checkered {
  background-image: 
    linear-gradient(45deg, #f1f5f9 25%, transparent 25%), 
    linear-gradient(-45deg, #f1f5f9 25%, transparent 25%), 
    linear-gradient(45deg, transparent 75%, #f1f5f9 75%), 
    linear-gradient(-45deg, transparent 75%, #f1f5f9 75%);
  background-size: 20px 20px;
  background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}
`;if(typeof document<"u"){const a=document.createElement("style");a.textContent=Bc,document.head.appendChild(a)}const Uc=1,Vc=1e6;let js=0;function Wc(){return js=(js+1)%Number.MAX_SAFE_INTEGER,js.toString()}const Ss=new Map,ua=a=>{if(Ss.has(a))return;const e=setTimeout(()=>{Ss.delete(a),It({type:"REMOVE_TOAST",toastId:a})},Vc);Ss.set(a,e)},Hc=(a,e)=>{switch(e.type){case"ADD_TOAST":return{...a,toasts:[e.toast,...a.toasts].slice(0,Uc)};case"UPDATE_TOAST":return{...a,toasts:a.toasts.map(t=>t.id===e.toast.id?{...t,...e.toast}:t)};case"DISMISS_TOAST":{const{toastId:t}=e;return t?ua(t):a.toasts.forEach(r=>{ua(r.id)}),{...a,toasts:a.toasts.map(r=>r.id===t||t===void 0?{...r,open:!1}:r)}}case"REMOVE_TOAST":return e.toastId===void 0?{...a,toasts:[]}:{...a,toasts:a.toasts.filter(t=>t.id!==e.toastId)}}},Kt=[];let Yt={toasts:[]};function It(a){Yt=Hc(Yt,a),Kt.forEach(e=>{e(Yt)})}function Gc({...a}){const e=Wc(),t=n=>It({type:"UPDATE_TOAST",toast:{...n,id:e}}),r=()=>It({type:"DISMISS_TOAST",toastId:e});return It({type:"ADD_TOAST",toast:{...a,id:e,open:!0,onOpenChange:n=>{n||r()}}}),{id:e,dismiss:r,update:t}}function Kc(){const[a,e]=c.useState(Yt);return c.useEffect(()=>(Kt.push(e),()=>{const t=Kt.indexOf(e);t>-1&&Kt.splice(t,1)}),[a]),{...a,toast:Gc,dismiss:t=>It({type:"DISMISS_TOAST",toastId:t})}}const en=c.forwardRef(({className:a,...e},t)=>s.jsx(La,{ref:t,className:A("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",a),...e}));en.displayName=La.displayName;const tn=c.forwardRef(({className:a,...e},t)=>s.jsx($a,{ref:t,className:A("aspect-square h-full w-full",a),...e}));tn.displayName=$a.displayName;const sn=c.forwardRef(({className:a,...e},t)=>s.jsx(za,{ref:t,className:A("flex h-full w-full items-center justify-center rounded-full bg-muted",a),...e}));sn.displayName=za.displayName;const an=["from-violet-500 to-pink-500","from-blue-500 to-purple-600","from-green-500 to-teal-600","from-orange-500 to-red-600","from-pink-500 to-rose-600","from-indigo-500 to-blue-600","from-yellow-500 to-orange-600","from-purple-500 to-pink-600","from-teal-500 to-green-600","from-red-500 to-pink-600","from-cyan-500 to-blue-600"];function Yc(a){let e=0;for(let t=0;t<a.length;t++){const r=a.charCodeAt(t);e=(e<<5)-e+r,e=e&e}return Math.abs(e)%an.length}function qc(a){return a?a.username?a.username.charAt(0).toUpperCase():a.email?a.email.charAt(0).toUpperCase():"?":"?"}function Jc(a){return a&&(a.username||a.email)||"anonymous"}function rn({user:a,size:e="md",className:t,onClick:r,showHoverEffect:n=!0}){const o=qc(a),i=Jc(a),l=Yc(i),u=an[l],d=A({sm:"h-6 w-6 text-xs",md:"h-8 w-8 text-sm",lg:"h-10 w-10 text-base"}[e],n&&r&&"cursor-pointer transition-transform hover:scale-105",t),h=A("bg-gradient-to-br text-white font-semibold flex items-center justify-center",u,n&&r&&"transition-all duration-200 hover:shadow-md");return s.jsxs(en,{className:d,onClick:r,children:[s.jsx(tn,{src:a?.avatar_url,alt:a?.username||a?.email||"User"}),s.jsx(sn,{className:h,children:o})]})}const nn=Hn,on=Gn,Xc=c.forwardRef(({className:a,inset:e,children:t,...r},n)=>s.jsxs(Ba,{ref:n,className:A("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",e&&"pl-8",a),...r,children:[t,s.jsx(es,{className:"ml-auto h-4 w-4"})]}));Xc.displayName=Ba.displayName;const Qc=c.forwardRef(({className:a,...e},t)=>s.jsx(Ua,{ref:t,className:A("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e}));Qc.displayName=Ua.displayName;const Ks=c.forwardRef(({className:a,...e},t)=>s.jsx(Wn,{children:s.jsx(Va,{ref:t,className:A("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e})}));Ks.displayName=Va.displayName;const pt=c.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(Wa,{ref:r,className:A("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",e&&"pl-8",a),...t}));pt.displayName=Wa.displayName;const Zc=c.forwardRef(({className:a,children:e,checked:t,...r},n)=>s.jsxs(Ha,{ref:n,className:A("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:t,...r,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(Ga,{children:s.jsx(qe,{className:"h-4 w-4"})})}),e]}));Zc.displayName=Ha.displayName;const ed=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Ka,{ref:r,className:A("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(Ga,{children:s.jsx(fr,{className:"h-2 w-2 fill-current"})})}),e]}));ed.displayName=Ka.displayName;const td=c.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(Ya,{ref:r,className:A("px-2 py-1.5 text-sm font-semibold text-foreground",e&&"pl-8",a),...t}));td.displayName=Ya.displayName;const ln=c.forwardRef(({className:a,...e},t)=>s.jsx(qa,{ref:t,className:A("-mx-1 my-1 h-px bg-border",a),...e}));ln.displayName=qa.displayName;function ma({children:a,folderId:e,folderName:t,onRename:r,onDelete:n,onCreateSubfolder:o,disabled:i=!1}){return i?s.jsx(s.Fragment,{children:a}):s.jsxs(nn,{children:[s.jsx(on,{asChild:!0,children:a}),s.jsxs(Ks,{className:"w-48",children:[s.jsxs(pt,{onClick:()=>r(e),children:[s.jsx(xr,{className:"h-4 w-4 mr-2"}),"Rename Folder"]}),s.jsxs(pt,{onClick:()=>o(e),children:[s.jsx(Ds,{className:"h-4 w-4 mr-2"}),"New Subfolder"]}),s.jsx(ln,{}),s.jsxs(pt,{onClick:()=>n(e),className:"text-destructive focus:text-destructive",children:[s.jsx(Fs,{className:"h-4 w-4 mr-2"}),"Delete Folder"]})]})]})}const sd=Qn,ad=Zn,cn=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Ja,{ref:r,className:A("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",a),...t,children:[e,s.jsx(Kn,{asChild:!0,children:s.jsx(Ps,{className:"h-4 w-4 opacity-50"})})]}));cn.displayName=Ja.displayName;const dn=c.forwardRef(({className:a,...e},t)=>s.jsx(Xa,{ref:t,className:A("flex cursor-default items-center justify-center py-1",a),...e,children:s.jsx(po,{className:"h-4 w-4"})}));dn.displayName=Xa.displayName;const un=c.forwardRef(({className:a,...e},t)=>s.jsx(Qa,{ref:t,className:A("flex cursor-default items-center justify-center py-1",a),...e,children:s.jsx(Ps,{className:"h-4 w-4"})}));un.displayName=Qa.displayName;const mn=c.forwardRef(({className:a,children:e,position:t="popper",...r},n)=>s.jsx(Yn,{children:s.jsxs(Za,{ref:n,className:A("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:t,...r,children:[s.jsx(dn,{}),s.jsx(qn,{className:A("p-1",t==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:e}),s.jsx(un,{})]})}));mn.displayName=Za.displayName;const rd=c.forwardRef(({className:a,...e},t)=>s.jsx(er,{ref:t,className:A("py-1.5 pl-8 pr-2 text-sm font-semibold",a),...e}));rd.displayName=er.displayName;const fn=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(tr,{ref:r,className:A("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(Jn,{children:s.jsx(qe,{className:"h-4 w-4"})})}),s.jsx(Xn,{children:e})]}));fn.displayName=tr.displayName;const nd=c.forwardRef(({className:a,...e},t)=>s.jsx(sr,{ref:t,className:A("-mx-1 my-1 h-px bg-muted",a),...e}));nd.displayName=sr.displayName;const od=[{value:"#3b82f6",label:"Blue"},{value:"#8b5cf6",label:"Purple"},{value:"#10b981",label:"Green"},{value:"#f59e0b",label:"Orange"},{value:"#ef4444",label:"Red"},{value:"#06b6d4",label:"Cyan"},{value:"#84cc16",label:"Lime"},{value:"#f97316",label:"Orange"}],Ns=[{value:"Folder",label:"Folder",icon:Ge},{value:"Code",label:"Code",icon:xo},{value:"Palette",label:"Design",icon:hr},{value:"BookOpen",label:"Learning",icon:yo},{value:"Star",label:"Favorites",icon:wo},{value:"Heart",label:"Personal",icon:bo},{value:"Zap",label:"Quick",icon:yr},{value:"Target",label:"Goals",icon:vo},{value:"Lightbulb",label:"Ideas",icon:Co},{value:"Coffee",label:"Work",icon:jo}];function id({isOpen:a,onClose:e,onConfirm:t,parentId:r,initialData:n,mode:o="create"}){const[i,l]=c.useState(""),[u,m]=c.useState("#3b82f6"),[d,h]=c.useState("Folder");c.useEffect(()=>{a&&(n?(l(n.name),m(n.color),h(n.icon)):(l(""),m("#3b82f6"),h("Folder")))},[a]),c.useEffect(()=>{a&&n&&(l(n.name),m(n.color),h(n.icon))},[n,a]);const g=p=>{p.preventDefault(),i.trim()&&(t({name:i.trim(),color:u,icon:d,parentId:r}),e())},f=Ns.find(p=>p.value===d)?.icon||Ge;return s.jsx(tt,{open:a,onOpenChange:e,children:s.jsxs(Je,{className:"sm:max-w-md",children:[s.jsxs(wt,{children:[s.jsx(vt,{children:o==="create"?"Create New Folder":"Edit Folder"}),s.jsx(ss,{children:o==="create"?"Create a new folder to organize your cards.":"Update folder details."})]}),s.jsxs("form",{onSubmit:g,className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"folder-name",children:"Folder Name"}),s.jsx(ve,{id:"folder-name",value:i,onChange:p=>l(p.target.value),placeholder:"Enter folder name...",autoFocus:!0})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{children:"Color"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:od.map(p=>s.jsx("button",{type:"button",onClick:()=>m(p.value),className:`w-8 h-8 rounded-full border-2 transition-all ${u===p.value?"border-foreground scale-110":"border-muted hover:scale-105"}`,style:{backgroundColor:p.value},title:p.label},p.value))})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{children:"Icon"}),s.jsxs(sd,{value:d,onValueChange:h,children:[s.jsx(cn,{children:s.jsx(ad,{children:s.jsxs("div",{className:"flex items-center gap-2",children:[B.createElement(f,{className:"h-4 w-4",style:{color:u}}),Ns.find(p=>p.value===d)?.label]})})}),s.jsx(mn,{children:Ns.map(p=>{const b=p.icon;return s.jsx(fn,{value:p.value,children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(b,{className:"h-4 w-4"}),p.label]})},p.value)})})]})]}),r&&s.jsx("div",{className:"flex items-center gap-2",children:s.jsx(Q,{variant:"secondary",children:"Subfolder"})}),s.jsxs(bt,{children:[s.jsx(P,{type:"button",variant:"outline",onClick:e,children:"Cancel"}),s.jsx(P,{type:"submit",disabled:!i.trim(),children:o==="create"?"Create Folder":"Save Changes"})]})]})]})})}const ld=to,cd=eo,gn=c.forwardRef(({className:a,...e},t)=>s.jsx(ar,{className:A("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...e,ref:t}));gn.displayName=ar.displayName;const hn=c.forwardRef(({className:a,...e},t)=>s.jsxs(cd,{children:[s.jsx(gn,{}),s.jsx(rr,{ref:t,className:A("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...e})]}));hn.displayName=rr.displayName;const pn=({className:a,...e})=>s.jsx("div",{className:A("flex flex-col space-y-2 text-center sm:text-left",a),...e});pn.displayName="AlertDialogHeader";const xn=({className:a,...e})=>s.jsx("div",{className:A("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...e});xn.displayName="AlertDialogFooter";const yn=c.forwardRef(({className:a,...e},t)=>s.jsx(nr,{ref:t,className:A("text-lg font-semibold",a),...e}));yn.displayName=nr.displayName;const wn=c.forwardRef(({className:a,...e},t)=>s.jsx(or,{ref:t,className:A("text-sm text-muted-foreground",a),...e}));wn.displayName=or.displayName;const bn=c.forwardRef(({className:a,...e},t)=>s.jsx(ir,{ref:t,className:A(Bs(),a),...e}));bn.displayName=ir.displayName;const vn=c.forwardRef(({className:a,...e},t)=>s.jsx(lr,{ref:t,className:A(Bs({variant:"outline"}),"mt-2 sm:mt-0",a),...e}));vn.displayName=lr.displayName;function dd({isOpen:a,onClose:e,onConfirm:t,folderName:r,cardCount:n,hasSubfolders:o=!1,subfolderCount:i=0}){const l=()=>{t(),e()};return s.jsx(ld,{open:a,onOpenChange:e,children:s.jsxs(hn,{children:[s.jsxs(pn,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Ee,{className:"h-5 w-5 text-destructive"}),s.jsx(yn,{children:"Delete Folder"})]}),s.jsxs(wn,{className:"space-y-3",children:[s.jsxs("p",{children:["Are you sure you want to delete the folder ",s.jsxs("strong",{children:['"',r,'"']}),"?"]}),s.jsxs("div",{className:"bg-destructive/10 p-3 rounded-lg space-y-2",children:[s.jsx("p",{className:"text-sm font-medium text-destructive",children:"This action will permanently delete:"}),s.jsxs("div",{className:"flex flex-wrap gap-2",children:[n>0&&s.jsxs(Q,{variant:"destructive",children:[n," card",n!==1?"s":""]}),o&&i>0&&s.jsxs(Q,{variant:"destructive",children:[i," subfolder",i!==1?"s":""]})]})]}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"This action cannot be undone."})]})]}),s.jsxs(xn,{children:[s.jsx(vn,{children:"Cancel"}),s.jsx(bn,{onClick:l,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete Forever"})]})]})})}function ud({children:a,tagName:e,onRename:t,onDelete:r,disabled:n=!1}){const o=()=>{n||t(e)},i=()=>{n||r(e)};return n?s.jsx(s.Fragment,{children:a}):s.jsxs(nn,{children:[s.jsx(on,{asChild:!0,children:a}),s.jsxs(Ks,{className:"w-48",children:[s.jsxs(pt,{onClick:o,className:"flex items-center gap-2",children:[s.jsx(xr,{className:"h-4 w-4"}),"Rename Tag"]}),s.jsxs(pt,{onClick:i,className:"flex items-center gap-2 text-destructive focus:text-destructive",children:[s.jsx(Fs,{className:"h-4 w-4"}),"Delete Tag"]})]})]})}function md({isOpen:a,onClose:e,onConfirm:t,tagName:r,existingTags:n}){const[o,i]=c.useState(""),[l,u]=c.useState("");c.useEffect(()=>{a&&(i(r),u(""))},[a,r]);const m=g=>{const f=g.trim();return f?f===r?"Please enter a different name":n.includes(f)?"A tag with this name already exists":f.length>50?"Tag name must be less than 50 characters":"":"Tag name cannot be empty"},d=()=>{const g=o.trim(),f=m(g);if(f){u(f);return}t(r,g),e()},h=g=>{g.key==="Enter"&&d()};return s.jsx(tt,{open:a,onOpenChange:e,children:s.jsxs(Je,{className:"sm:max-w-md",children:[s.jsxs(wt,{children:[s.jsx(vt,{children:"Rename Tag"}),s.jsxs(ss,{children:['Enter a new name for the tag "',r,'". This will update all cards using this tag.']})]}),s.jsx("div",{className:"space-y-4 py-4",children:s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"tag-name",children:"Tag Name"}),s.jsx(ve,{id:"tag-name",value:o,onChange:g=>{i(g.target.value),l&&u("")},onKeyPress:h,placeholder:"Enter tag name...",autoFocus:!0}),l&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[s.jsx(Se,{className:"h-4 w-4"}),l]})]})}),s.jsxs(bt,{children:[s.jsx(P,{variant:"outline",onClick:e,children:"Cancel"}),s.jsx(P,{onClick:d,disabled:!!l||!o.trim(),children:"Rename Tag"})]})]})})}function fd({isOpen:a,onClose:e,onConfirm:t,tagName:r,cardCount:n}){return s.jsx(tt,{open:a,onOpenChange:e,children:s.jsxs(Je,{className:"sm:max-w-md",children:[s.jsxs(wt,{children:[s.jsxs(vt,{className:"flex items-center gap-2",children:[s.jsx(Ee,{className:"h-5 w-5 text-destructive"}),"Delete Tag"]}),s.jsxs(ss,{children:['Are you sure you want to delete the tag "',r,'"?']})]}),s.jsx("div",{className:"py-4",children:s.jsxs("div",{className:"rounded-lg bg-destructive/10 p-4 border border-destructive/20",children:[s.jsx("p",{className:"text-sm text-destructive font-medium mb-2",children:"This action cannot be undone."}),s.jsxs("p",{className:"text-sm text-muted-foreground",children:["This tag will be removed from ",s.jsx("strong",{children:n})," ",n===1?"card":"cards","."]})]})}),s.jsxs(bt,{children:[s.jsx(P,{variant:"outline",onClick:e,children:"Cancel"}),s.jsx(P,{variant:"destructive",onClick:t,children:"Delete Tag"})]})]})})}const gd=({tag:a,isSelected:e,onClick:t,className:r,showCount:n=!0})=>s.jsxs("button",{onClick:()=>t(a),className:A("relative flex items-center justify-between px-3 py-2 rounded-xl border transition-all duration-300 ease-out","hover:shadow-lg hover:shadow-black/10 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-blue-500/30","backdrop-blur-sm group",e?"bg-gradient-to-r from-blue-500 to-blue-600 border-blue-500 text-white shadow-md shadow-blue-500/25":"bg-white/80 border-gray-200/60 text-gray-700 hover:bg-white hover:border-gray-300/80",r),style:{boxShadow:e?"0 4px 20px -4px rgba(59, 130, 246, 0.3), 0 0 0 1px rgba(59, 130, 246, 0.1)":void 0},children:[s.jsxs("div",{className:"flex items-center gap-2.5 flex-1 min-w-0",children:[s.jsx("div",{className:A("w-2 h-2 rounded-full flex-shrink-0 transition-all duration-300",e?"bg-white/90 shadow-sm":"shadow-sm"),style:{backgroundColor:e?"rgba(255, 255, 255, 0.9)":a.color,boxShadow:e?"0 1px 3px rgba(0, 0, 0, 0.1)":`0 1px 3px ${a.color}40`}}),s.jsx("span",{className:A("text-sm font-medium truncate transition-all duration-300",e?"text-white":"text-gray-700 group-hover:text-gray-900"),children:a.name}),e&&s.jsx(qe,{className:"w-3.5 h-3.5 text-white/90 flex-shrink-0 animate-in fade-in-0 zoom-in-95 duration-200"})]}),n&&s.jsx("span",{className:A("text-xs font-medium px-2 py-0.5 rounded-full ml-2 flex-shrink-0 transition-all duration-300",e?"text-blue-600 bg-white/90 shadow-sm":"text-gray-500 bg-gray-100/80 group-hover:bg-gray-200/80 group-hover:text-gray-600"),children:a.count})]}),hd=({tags:a,selectedTags:e,onTagClick:t,className:r,emptyMessage:n="No tags found"})=>a.length===0?s.jsx("div",{className:A("text-center py-8 text-gray-500",r),children:s.jsx("p",{className:"text-sm",children:n})}):s.jsx("div",{className:A("grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2",r),children:a.map(o=>s.jsx(gd,{tag:o,isSelected:e.includes(o.name),onClick:t},o.id))}),pd=({onSearch:a,onCreateTag:e,searchResults:t,searchQuery:r,className:n})=>{const[o,i]=c.useState(r);c.useEffect(()=>{i(r)},[r]);const l=d=>{const h=d.target.value;i(h),a(h)},u=()=>{o.trim()&&(e(o.trim()),i(""),a(""))},m=o.trim()&&t.length===0&&!t.some(d=>d.name.toLowerCase()===o.toLowerCase());return s.jsxs("div",{className:A("space-y-3",n),children:[s.jsxs("div",{className:"relative",children:[s.jsx(mt,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),s.jsx(ve,{placeholder:"Search tags or create new...",value:o,onChange:l,className:"pl-11 pr-4 py-3 rounded-2xl border-gray-200/60 bg-gray-50/50 backdrop-blur-sm focus:bg-white focus:border-blue-300 transition-all duration-300"})]}),m&&s.jsxs(P,{onClick:u,variant:"outline",className:"w-full justify-start text-left rounded-xl border-dashed border-2 border-gray-300 hover:border-blue-400 hover:bg-blue-50/50 transition-all duration-300 py-3",children:[s.jsx(Gt,{className:"h-4 w-4 mr-2 text-blue-500"}),s.jsxs("span",{className:"text-gray-700",children:['Create tag "',s.jsx("span",{className:"font-medium text-blue-600",children:o}),'"']})]})]})},xd=({isOpen:a,onClose:e,currentCardTags:t,onTagsChange:r})=>{const{tags:n,searchTags:o,dispatch:i,createTagIfNotExists:l}=jr(),[u,m]=c.useState(""),[d,h]=c.useState([]),[g,f]=c.useState(t);c.useEffect(()=>{if(u.trim()){const y=o(u);h(y)}else{const y=[...n].sort((x,j)=>j.count-x.count);h(y)}},[u,n,o]),c.useEffect(()=>{f(t)},[t]);const p=y=>{m(y)},b=y=>{i({type:"CREATE_TAG",payload:{name:y,color:"#3b82f6"}});const x=[...g,y];f(x),r(x),m("")},C=y=>{const x=g.includes(y.name);let j;x?j=g.filter(N=>N!==y.name):j=[...g,y.name],f(j),r(j)},v=()=>{m(""),e()};return a?s.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",style:{backgroundColor:"rgba(0, 0, 0, 0.15)",backdropFilter:"blur(8px)"},children:[s.jsx("div",{className:"absolute inset-0",onClick:v}),s.jsxs("div",{className:"relative bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 p-6 w-full max-w-sm sm:max-w-md lg:max-w-2xl max-h-[85vh] flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Manage Tags"}),s.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Select tags for this card"})]}),s.jsx("button",{onClick:v,className:"p-1 rounded-lg hover:bg-gray-100 transition-colors",children:s.jsx(st,{className:"w-5 h-5 text-gray-500"})})]}),s.jsx(pd,{onSearch:p,onCreateTag:b,searchResults:d,searchQuery:u,className:"mb-4"}),g.length>0&&s.jsxs("div",{className:"mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-100/50",children:[s.jsxs("p",{className:"text-sm font-medium text-blue-700 mb-3",children:["Selected tags (",g.length,"):"]}),s.jsx("div",{className:"flex flex-wrap gap-1.5",children:g.map(y=>s.jsx("span",{className:"inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-sm",children:y},y))})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx(hd,{tags:d,selectedTags:g,onTagClick:C,emptyMessage:u?`No tags found for "${u}"`:"No tags available"})}),s.jsx("div",{className:"text-xs text-gray-400 text-center mt-4 pt-4 border-t border-gray-100",children:s.jsxs("div",{className:"flex items-center justify-center gap-2",children:[s.jsx("div",{className:"w-1 h-1 rounded-full bg-gray-300"}),s.jsx("span",{children:"Click tags to add/remove them from this card"}),s.jsx("div",{className:"w-1 h-1 rounded-full bg-gray-300"})]})})]})]}):null},yd=()=>{const{isOpen:a,currentCardTags:e,onTagsChange:t,closeTagPanel:r}=Rr();return!a||!t?null:s.jsx(xd,{isOpen:a,onClose:r,currentCardTags:e,onTagsChange:t})};class wd{static generateSuggestions(e){const t=[];switch(e.type){case"card_content":t.push(...this.generateCardContentSuggestions(e));break;case"folder_name":t.push(...this.generateFolderNameSuggestions(e));break;case"tag_rename":t.push(...this.generateTagRenameSuggestions(e));break;default:t.push(this.getDefaultSuggestion())}return t.sort((r,n)=>n.confidence-r.confidence)}static generateCardContentSuggestions(e){const t=[],{localVersion:r,remoteVersion:n}=e,o=this.calculateSimilarity(r.content.frontContent.title,n.content.frontContent.title),i=this.calculateSimilarity(r.content.frontContent.text,n.content.frontContent.text),u=Math.abs(r.updatedAt.getTime()-n.updatedAt.getTime())<5*60*1e3,m=r.content.frontContent.text.length,d=n.content.frontContent.text.length,h=Math.max(m,d)/Math.min(m,d);o>.8&&i>.6&&u&&t.push({type:"merge",confidence:.9,reason:"内容高度相似，建议智能合并保留最佳内容",preview:{mergedTitle:this.mergeTitles(r.content.frontContent.title,n.content.frontContent.title),mergedLength:Math.max(m,d)}}),n.updatedAt.getTime()>r.updatedAt.getTime()&&h>2&&d>m&&t.push({type:"keep_remote",confidence:.8,reason:"远程版本内容更丰富且更新时间更近"});const g=new Set(r.content.frontContent.tags),f=new Set(n.content.frontContent.tags),p=[...g].filter(C=>!f.has(C));p.length>0&&p.length/g.size>.3&&t.push({type:"keep_local",confidence:.7,reason:"本地版本包含独特标签，可能包含重要分类信息"});const b=r.updatedAt.getTime()>n.updatedAt.getTime()?"local":"remote";return t.push({type:b==="local"?"keep_local":"keep_remote",confidence:.6,reason:`保留最新版本（${b==="local"?"本地":"远程"}设备）`}),t}static generateFolderNameSuggestions(e){const t=[],{localVersion:r,remoteVersion:n}=e,o=r.name.toLowerCase(),i=n.name.toLowerCase();if(o===i)return[];if(this.calculateSimilarity(r.name,n.name)>.8&&t.push({type:"merge",confidence:.9,reason:"文件夹名称相似，建议统一命名"}),o.includes(i)||i.includes(o)){const m=r.name.length>n.name.length?"local":"remote";t.push({type:m==="local"?"keep_local":"keep_remote",confidence:.8,reason:"保留更具描述性的文件夹名称"})}const u=r.updatedAt.getTime()>n.updatedAt.getTime()?"local":"remote";return t.push({type:u==="local"?"keep_local":"keep_remote",confidence:.6,reason:`保留最新修改的版本（${u==="local"?"本地":"远程"}）`}),t}static generateTagRenameSuggestions(e){const t=[],{localVersion:r,remoteVersion:n}=e,o=r.count/Math.max(n.count,1);o>2?t.push({type:"keep_local",confidence:.9,reason:`本地标签使用频率更高（${r.count}次 vs ${n.count}次）`}):o<.5&&t.push({type:"keep_remote",confidence:.9,reason:`远程标签使用频率更高（${n.count}次 vs ${r.count}次）`});const i=this.evaluateTagNameQuality(r.name),l=this.evaluateTagNameQuality(n.name);if(Math.abs(i-l)>.3){const m=i>l?"local":"remote";t.push({type:m==="local"?"keep_local":"keep_remote",confidence:.8,reason:`${m==="local"?"本地":"远程"}标签名称质量更好`})}const u=r.updatedAt.getTime()>n.updatedAt.getTime()?"local":"remote";return t.push({type:u==="local"?"keep_local":"keep_remote",confidence:.6,reason:"保留最新修改的版本"}),t}static calculateSimilarity(e,t){if(!e||!t)return 0;const r=e.toLowerCase().trim(),n=t.toLowerCase().trim();if(r===n)return 1;const o=Math.max(r.length,n.length);return o===0?1:1-this.levenshteinDistance(r,n)/o}static levenshteinDistance(e,t){const r=Array(t.length+1).fill(null).map(()=>Array(e.length+1).fill(null));for(let n=0;n<=e.length;n+=1)r[0][n]=n;for(let n=0;n<=t.length;n+=1)r[n][0]=n;for(let n=1;n<=t.length;n+=1)for(let o=1;o<=e.length;o+=1){const i=e[o-1]===t[n-1]?0:1;r[n][o]=Math.min(r[n][o-1]+1,r[n-1][o]+1,r[n-1][o-1]+i)}return r[t.length][e.length]}static mergeTitles(e,t){if(e===t||e.includes(t)&&e.length>t.length)return e;if(t.includes(e)&&t.length>e.length)return t;const r=new Set(e.toLowerCase().split(/\s+/)),n=new Set(t.toLowerCase().split(/\s+/)),o=new Set([...r,...n]),i=e.split(/\s+/),l=t.split(/\s+/),u=[];return i.forEach(m=>{!u.includes(m)&&o.has(m.toLowerCase())&&u.push(m)}),l.forEach(m=>{!u.includes(m)&&o.has(m.toLowerCase())&&u.push(m)}),u.join(" ")}static evaluateTagNameQuality(e){let t=.5;e.length>=3&&e.length<=20&&(t+=.2),e.length>30&&(t-=.1),/^[a-zA-Z0-9\u4e00-\u9fff\s\-_]+$/.test(e)&&(t+=.2),(e===e.toLowerCase()||/^[A-Z][a-z]+([A-Z][a-z]*)*$/.test(e))&&(t+=.1);const n=e.match(/[^a-zA-Z0-9\u4e00-\u9fff\s]/g);return n&&n.length>2&&(t-=.1),Math.max(0,Math.min(1,t))}static getDefaultSuggestion(){return{type:"manual",confidence:.5,reason:"无法自动确定最佳解决方案，建议手动处理"}}static applyResolution(e,t){switch(t.type){case"keep_local":return this.getLocalVersion(e);case"keep_remote":return this.getRemoteVersion(e);case"merge":return this.mergeVersions(e,t.mergedData);case"manual":return t.mergedData||t.manualChanges;default:throw new Error(`Unknown resolution type: ${t.type}`)}}static getLocalVersion(e){return e.entityType==="card",e.localVersion}static getRemoteVersion(e){return e.entityType==="card",e.remoteVersion}static mergeVersions(e,t){return t||this.smartMerge(e)}static smartMerge(e){if(e.entityType==="card"){const t=e,r=t.localVersion,n=t.remoteVersion;return{content:{frontContent:{title:this.mergeTitles(r.content.frontContent.title,n.content.frontContent.title),text:this.mergeText(r.content.frontContent.text,n.content.frontContent.text),tags:[...new Set([...r.content.frontContent.tags,...n.content.frontContent.tags])],lastModified:new Date},backContent:{title:this.mergeTitles(r.content.backContent.title,n.content.backContent.title),text:this.mergeText(r.content.backContent.text,n.content.backContent.text),tags:[...new Set([...r.content.backContent.tags,...n.content.backContent.tags])],lastModified:new Date}},style:r.style,folderId:r.folderId,isFlipped:r.isFlipped,updatedAt:new Date}}return this.getLocalVersion(e)}static mergeText(e,t){if(e===t)return e;const r=e.split(/[.!?]+/).filter(i=>i.trim()),n=t.split(/[.!?]+/).filter(i=>i.trim()),o=new Set([...r.map(i=>i.trim()),...n.map(i=>i.trim())]);return`${Array.from(o).filter(i=>i.length>0).join(". ")}.`}}function is(){const[a,e]=c.useState([]),[t,r]=c.useState(null),[n,o]=c.useState(!1),[i,l]=c.useState(!1),[u,m]=c.useState(null),[d,h]=c.useState(null),[g,f]=c.useState(null),p=c.useRef({totalConflicts:0,resolvedConflicts:0,pendingConflicts:0,conflictsByType:{},conflictsBySeverity:{},averageResolutionTime:0});c.useEffect(()=>{const _={totalConflicts:a.length,resolvedConflicts:a.filter(M=>M.status==="resolved").length,pendingConflicts:a.filter(M=>M.status==="pending").length,conflictsByType:{},conflictsBySeverity:{},averageResolutionTime:N()};a.forEach(M=>{_.conflictsByType[M.type]=(_.conflictsByType[M.type]||0)+1,_.conflictsBySeverity[M.severity]=(_.conflictsBySeverity[M.severity]||0)+1}),p.current=_},[a]),c.useEffect(()=>{b();const _=setInterval(()=>{E()},5e3);return()=>{clearInterval(_)}},[]);const b=async()=>{l(!0);try{await C(),await E(),m(null)}catch(_){console.error("Failed to initialize conflict management:",_),m(_ instanceof Error?_.message:"Unknown error")}finally{l(!1)}},C=async()=>{try{const _=de.getConflicts(),M=v(_);return e(M),M}catch(_){return console.error("Failed to load conflicts from service:",_),[]}},v=_=>_.map(M=>{const T={id:M.id,type:y(M.conflictType),entityType:M.entityType,entityId:M.entityId,timestamp:M.detectedAt||new Date,sourceDevice:M.sourceDevice||"Unknown",severity:M.severity,status:x(M.status),createdAt:M.detectedAt||new Date,resolvedAt:M.resolvedAt,resolvedBy:M.resolvedBy,resolution:M.resolution?j(M.resolution):void 0};switch(M.entityType){case"card":return{...T,type:"card_content",localVersion:M.localData,remoteVersion:M.cloudData,conflictFields:M.conflictFields||[],suggestions:M.suggestions?.map(U=>({type:U.type,confidence:U.confidence,reason:U.reasoning||U.reason,preview:U.preview}))};case"folder":return{...T,type:"folder_name",localVersion:M.localData,remoteVersion:M.cloudData,affectedCards:M.conflictDetails?.affectedEntities||[]};case"tag":return{...T,type:"tag_rename",localVersion:M.localData,remoteVersion:M.cloudData,affectedCards:M.conflictDetails?.affectedEntities||[]};default:throw new Error(`Unknown entity type: ${M.entityType}`)}}),y=_=>({content:"card_content",version:"card_content",structure:"folder_structure",delete:"tag_delete",field:"card_content"})[_]||"card_content",x=_=>({pending:"pending",resolving:"reviewing",resolved:"resolved",manual_required:"pending"})[_]||"pending",j=_=>({type:_.type,mergedData:_.mergedData,reason:_.reasoning,manualChanges:_.manualChanges}),N=()=>{const _=a.filter(T=>T.status==="resolved"&&T.resolvedAt);return _.length===0?0:_.reduce((T,U)=>T+(U.resolvedAt.getTime()-U.createdAt.getTime()),0)/_.length},E=async()=>{try{const _=de.getStatus();f(_),_.isSyncing===!1&&_.networkStatus?.online&&await w()}catch(_){console.error("Failed to update sync status:",_)}},w=async()=>{try{const _=await C();_.filter(T=>T.status==="pending").length>a.filter(T=>T.status==="pending").length&&e(_)}catch(_){console.error("Failed to detect new conflicts:",_)}},k=c.useCallback(_=>a.find(M=>M.id===_),[a]),I=c.useCallback(()=>a.filter(_=>_.status==="pending"),[a]),K=c.useCallback(()=>a.filter(_=>_.severity==="high"||_.severity==="critical"),[a]),O=c.useCallback(()=>({...p.current}),[]),H=c.useCallback(async(_,M)=>{o(!0),m(null);try{if(await de.resolveConflict(_,M.type,M.mergedData))return e(U=>U.map(Y=>Y.id===_?{...Y,status:"resolved",resolvedAt:new Date,resolvedBy:"user",resolution:M}:Y)),r(null),await E(),!0;throw new Error("Failed to resolve conflict via sync service")}catch(T){return console.error("Failed to resolve conflict:",T),m(T instanceof Error?T.message:"Unknown error"),!1}finally{o(!1)}},[]),te=c.useCallback(async _=>{try{if(!a.find(T=>T.id===_))return;e(T=>T.map(U=>U.id===_?{...U,status:"ignored"}:U)),r(null)}catch(M){console.error("Failed to ignore conflict:",M),m(M instanceof Error?M.message:"Unknown error")}},[a]),W=c.useCallback(async(_,M)=>{o(!0),m(null);try{const T=await Promise.allSettled(_.map(L=>de.resolveConflict(L,M.type,M.mergedData))),U=T.filter(L=>L.status==="fulfilled").length,Y=T.filter(L=>L.status==="rejected").length;if(U>0&&e(L=>L.map(R=>_.includes(R.id)?{...R,status:"resolved",resolvedAt:new Date,resolvedBy:"user",resolution:M}:R)),Y>0)throw new Error(`${Y} conflicts failed to resolve`);return await E(),!0}catch(T){return console.error("Failed to batch resolve conflicts:",T),m(T instanceof Error?T.message:"Unknown error"),!1}finally{o(!1)}},[]),Z=c.useCallback(_=>{const M=k(_);if(!M)return[];const T=wd.generateSuggestions(M),U=de.getConflict(_)?.suggestions||[];return[...T,...U.map(L=>({type:L.type,confidence:L.confidence,reason:L.reasoning||L.reason,preview:L.preview}))].sort((L,R)=>R.confidence-L.confidence)},[k]),ne=c.useCallback(async()=>{l(!0);try{const _=await de.sync({type:"incremental",direction:"bidirectional"}),M=await C(),T=M.filter(U=>U.status==="pending");return e(M),T}catch(_){return console.error("Failed to detect conflicts:",_),m(_ instanceof Error?_.message:"Unknown error"),[]}finally{l(!1)}},[]),re=c.useCallback(async()=>{o(!0);try{const _=await de.autoResolveConflicts();return await C(),await E(),_}catch(_){return console.error("Failed to auto-resolve conflicts:",_),m(_ instanceof Error?_.message:"Unknown error"),0}finally{o(!1)}},[]),ge=c.useCallback(async _=>{try{const M=k(_);if(!M)return null;const T=de.getConflict(_);return{...M,syncDetails:T,suggestions:Z(_)}}catch(M){return console.error("Failed to get conflict details:",M),null}},[k,Z]),z=c.useCallback(async()=>{l(!0);try{await C(),await E(),m(null)}catch(_){console.error("Failed to refresh conflicts:",_),m(_ instanceof Error?_.message:"Unknown error")}finally{l(!1)}},[]),q=c.useCallback(()=>{m(null)},[]);return{conflicts:a,selectedConflict:t,setSelectedConflict:r,isResolving:n,isLoading:i,error:u,syncStatus:g,metrics:d,stats:{...p.current},getConflictById:k,getPendingConflicts:I,getHighPriorityConflicts:K,getStats:O,resolveConflict:H,ignoreConflict:te,batchResolveConflicts:W,getSuggestions:Z,detectConflicts:ne,autoResolveConflicts:re,getConflictDetails:ge,refreshConflicts:z,clearError:q}}const bd=Zt("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),et=c.forwardRef(({className:a,variant:e,...t},r)=>s.jsx("div",{ref:r,role:"alert",className:A(bd({variant:e}),a),...t}));et.displayName="Alert";const Cn=c.forwardRef(({className:a,...e},t)=>s.jsx("h5",{ref:t,className:A("mb-1 font-medium leading-none tracking-tight",a),...e}));Cn.displayName="AlertTitle";const xt=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:A("text-sm [&_p]:leading-relaxed",a),...e}));xt.displayName="AlertDescription";function vd({className:a,onOpenConflictPanel:e}){const{stats:t,getHighPriorityConflicts:r,detectConflicts:n,setSelectedConflict:o}=is(),i=r();if(!(t.pendingConflicts>0))return null;const u=async()=>{await n()},m=h=>{o(h),e?.()},d=h=>{switch(h){case"critical":return"bg-red-500 text-white";case"high":return"bg-orange-500 text-white";case"medium":return"bg-yellow-500 text-white";case"low":return"bg-blue-500 text-white";default:return"bg-gray-500 text-white"}};return s.jsxs("div",{className:A("space-y-2",a),children:[s.jsxs(et,{className:"border-orange-200 bg-orange-50",children:[s.jsx(Ee,{className:"h-4 w-4 text-orange-600"}),s.jsx(Cn,{className:"text-orange-800",children:"检测到数据冲突"}),s.jsxs(xt,{className:"text-orange-700",children:["发现 ",t.pendingConflicts," 个待解决的数据冲突，建议及时处理以避免数据丢失。",i.length>0&&s.jsxs("span",{className:"ml-2 font-medium",children:["其中 ",i.length," 个需要立即处理。"]})]}),s.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(P,{variant:"outline",size:"sm",onClick:e,className:"text-orange-700 border-orange-300 hover:bg-orange-100",children:[s.jsx(Js,{className:"h-4 w-4 mr-2"}),"查看所有冲突"]}),s.jsxs(P,{variant:"ghost",size:"sm",onClick:u,className:"text-orange-600 hover:bg-orange-100",children:[s.jsx(De,{className:"h-4 w-4 mr-2"}),"刷新检测"]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(Q,{variant:"secondary",className:"text-orange-700 bg-orange-100",children:["总计: ",t.totalConflicts]}),s.jsxs(Q,{variant:"destructive",className:"bg-red-100 text-red-700",children:["待解决: ",t.pendingConflicts]})]})]})]}),i.length>0&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h4",{className:"text-sm font-medium text-red-700",children:"高优先级冲突"}),s.jsxs(Q,{variant:"destructive",className:"text-xs",children:[i.length," 个"]})]}),i.slice(0,3).map(h=>s.jsx(et,{className:"border-red-200 bg-red-50 cursor-pointer hover:bg-red-100 transition-colors",onClick:()=>m(h.id),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(Q,{variant:"outline",className:A("text-xs",d(h.severity)),children:h.severity}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-red-800",children:Cd(h)}),s.jsx("p",{className:"text-xs text-red-600",children:jd(h)})]})]}),s.jsx(P,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-red-600 hover:bg-red-100",onClick:g=>{g.stopPropagation(),m(h.id)},children:s.jsx(Js,{className:"h-4 w-4"})})]})},h.id)),i.length>3&&s.jsxs(P,{variant:"ghost",size:"sm",onClick:e,className:"w-full text-red-600 hover:bg-red-100",children:["查看剩余 ",i.length-3," 个高优先级冲突"]})]})]})}function Cd(a){switch(a.type){case"card_content":return"卡片内容冲突";case"card_style":return"卡片样式冲突";case"card_tags":return"卡片标签冲突";case"card_folder":return"卡片文件夹冲突";case"folder_name":return"文件夹名称冲突";case"folder_structure":return"文件夹结构冲突";case"tag_rename":return"标签重命名冲突";case"tag_delete":return"标签删除冲突";case"tag_color":return"标签颜色冲突";default:return"数据冲突"}}function jd(a){switch(a.type){case"card_content":return`卡片 "${a.localVersion.content.frontContent.title}" 在多设备上被同时编辑`;case"folder_name":return`文件夹 "${a.localVersion.name}" 与远程版本名称不一致`;case"tag_rename":return`标签 "${a.localVersion.name}" 重命名冲突`;default:return"数据版本不一致，需要手动解决"}}const ie=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:A("rounded-lg border bg-card text-card-foreground shadow-sm",a),...e}));ie.displayName="Card";const Oe=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:A("flex flex-col space-y-1.5 p-6",a),...e}));Oe.displayName="CardHeader";const Fe=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:A("text-2xl font-semibold leading-none tracking-tight",a),...e}));Fe.displayName="CardTitle";const jn=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:A("text-sm text-muted-foreground",a),...e}));jn.displayName="CardDescription";const le=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:A("p-6 pt-0",a),...e}));le.displayName="CardContent";const Sd=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:A("flex items-center p-6 pt-0",a),...e}));Sd.displayName="CardFooter";const He=c.forwardRef(({className:a,value:e,...t},r)=>s.jsx(cr,{ref:r,className:A("relative h-4 w-full overflow-hidden rounded-full bg-secondary",a),...t,children:s.jsx(so,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(e||0)}%)`}})}));He.displayName=cr.displayName;class ut{static instance;metrics=[];alerts=[];observers=[];sessionId;startTime;constructor(){this.sessionId=this.generateSessionId(),this.startTime=performance.now(),this.initializeObservers()}static getInstance(){return ut.instance||(ut.instance=new ut),ut.instance}initializeObservers(){"PerformanceObserver"in window&&(this.observePaintTiming(),this.observeLayoutShift(),this.observeInteraction()),this.observeMemoryUsage(),this.observeNetworkPerformance(),this.observeErrors(),this.startPeriodicCollection()}observePaintTiming(){try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(n=>{n.name==="first-paint"?this.updateMetric("firstPaint",n.startTime):n.name==="first-contentful-paint"&&this.updateMetric("firstContentfulPaint",n.startTime)})});e.observe({entryTypes:["paint"]}),this.observers.push(e)}catch(e){console.warn("Failed to observe paint timing:",e)}}observeLayoutShift(){try{const e=new PerformanceObserver(t=>{const r=t.getEntries();let n=0;r.forEach(o=>{o instanceof LayoutShift&&(n+=o.value)}),this.updateMetric("cumulativeLayoutShift",n)});e.observe({entryTypes:["layout-shift"]}),this.observers.push(e)}catch(e){console.warn("Failed to observe layout shift:",e)}}observeInteraction(){try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(n=>{n instanceof PerformanceEventTiming&&(this.updateMetric("interactionTime",n.duration),this.updateMetric("firstInputDelay",n.processingStart-n.startTime))})});e.observe({entryTypes:["first-input","event"]}),this.observers.push(e)}catch(e){console.warn("Failed to observe interactions:",e)}}observeMemoryUsage(){setInterval(()=>{if("memory"in performance){const e=performance.memory;this.updateMetric("memoryUsage",e.usedJSHeapSize),e.jsHeapSizeLimit-e.usedJSHeapSize<e.jsHeapSizeLimit*.1&&this.createAlert({type:"warning",category:"memory",message:"High memory usage detected",severity:"medium",suggestions:["Check for memory leaks","Consider garbage collection"]})}},5e3)}observeNetworkPerformance(){const e=window.fetch;window.fetch=async(...t)=>{const r=performance.now();try{const n=await e(...t),o=performance.now();return this.updateMetric("requestTime",o-r),n}catch(n){const o=performance.now();throw this.updateMetric("requestTime",o-r),n}}}observeErrors(){window.addEventListener("error",e=>{this.createAlert({type:"error",category:"performance",message:`JavaScript error: ${e.message}`,severity:"high",context:{filename:e.filename,lineno:e.lineno,colno:e.colno}})}),window.addEventListener("unhandledrejection",e=>{this.createAlert({type:"error",category:"performance",message:`Unhandled promise rejection: ${e.reason}`,severity:"high"})})}startPeriodicCollection(){setInterval(()=>{this.collectMetrics()},3e4)}collectMetrics(){const e={renderTime:this.calculateRenderTime(),firstPaint:this.getMetric("firstPaint")||0,firstContentfulPaint:this.getMetric("firstContentfulPaint")||0,largestContentfulPaint:this.getLCP(),cumulativeLayoutShift:this.getMetric("cumulativeLayoutShift")||0,firstInputDelay:this.getMetric("firstInputDelay")||0,interactionTime:this.getMetric("interactionTime")||0,clickLatency:this.measureClickLatency(),scrollPerformance:this.measureScrollPerformance(),inputResponsiveness:this.measureInputResponsiveness(),memoryUsage:this.getMemoryUsage(),memoryLeakDetected:this.detectMemoryLeak(),garbageCollectionTime:this.measureGarbageCollection(),networkLatency:this.measureNetworkLatency(),requestTime:this.getMetric("requestTime")||0,resourceLoadTime:this.measureResourceLoadTime(),conflictDetectionTime:this.getMetric("conflictDetectionTime")||0,conflictResolutionTime:this.getMetric("conflictResolutionTime")||0,batchOperationTime:this.getMetric("batchOperationTime")||0,perceivedPerformance:this.calculatePerceivedPerformance(),errorRate:this.calculateErrorRate(),crashRate:this.calculateCrashRate(),userSatisfaction:this.calculateUserSatisfaction(),timestamp:new Date,sessionId:this.sessionId};this.metrics.push(e),this.analyzeMetrics(e)}startConflictDetection(){const e=performance.now();return()=>{const t=performance.now();this.updateMetric("conflictDetectionTime",t-e)}}startConflictResolution(){const e=performance.now();return()=>{const t=performance.now();this.updateMetric("conflictResolutionTime",t-e)}}startBatchOperation(){const e=performance.now();return()=>{const t=performance.now();this.updateMetric("batchOperationTime",t-e)}}trackUserInteraction(e,t,r){this.updateMetric(`${e}Duration`,t),r||this.createAlert({type:"warning",category:"ux",message:`User interaction failed: ${e}`,severity:"medium"})}trackUserSatisfaction(e,t){this.updateMetric("userSatisfaction",e),t&&console.log("User feedback:",t)}analyzeMetrics(e){e.renderTime>100&&this.createAlert({type:"warning",category:"performance",message:"Slow render time detected",severity:"medium",suggestions:["Optimize component rendering","Consider virtualization"]}),e.memoryUsage>100*1024*1024&&this.createAlert({type:"warning",category:"memory",message:"High memory usage detected",severity:"medium",suggestions:["Check for memory leaks","Optimize data structures"]}),e.networkLatency>1e3&&this.createAlert({type:"warning",category:"network",message:"High network latency detected",severity:"medium",suggestions:["Check network connection","Optimize API calls"]}),e.conflictResolutionTime>5e3&&this.createAlert({type:"warning",category:"performance",message:"Slow conflict resolution detected",severity:"medium",suggestions:["Optimize conflict resolution algorithm","Consider caching"]})}generateReport(e=36e5){const t=new Date,r=new Date(t.getTime()-e),n=this.metrics.filter(i=>i.timestamp>=r&&i.timestamp<=t),o=this.calculateUserExperienceMetrics(n);return{period:{start:r,end:t},metrics:n,userExperience:o,alerts:this.alerts.filter(i=>i.timestamp>=r),summary:{averagePerformance:this.calculateAveragePerformance(n),performanceTrend:this.calculatePerformanceTrend(n),criticalIssues:this.alerts.filter(i=>i.severity==="critical").length,recommendations:this.generateRecommendations(n,o)}}}updateMetric(e,t){const r=this.metrics[this.metrics.length-1];r&&(r[e]=t)}getMetric(e){const t=this.metrics[this.metrics.length-1];return t?t[e]:null}calculateRenderTime(){const e=performance.getEntriesByType("navigation")[0];return e?e.loadEventEnd-e.loadEventStart:0}getLCP(){const e=performance.getEntriesByType("largest-contentful-paint")[0];return e?e.startTime:0}measureClickLatency(){return 0}measureScrollPerformance(){return 0}measureInputResponsiveness(){return 0}getMemoryUsage(){return"memory"in performance?performance.memory.usedJSHeapSize:0}detectMemoryLeak(){return!1}measureGarbageCollection(){return 0}measureNetworkLatency(){return 0}measureResourceLoadTime(){return 0}calculatePerceivedPerformance(){return 85}calculateErrorRate(){return .01}calculateCrashRate(){return .001}calculateUserSatisfaction(){return 85}calculateUserExperienceMetrics(e){return{averageTaskCompletionTime:0,taskSuccessRate:.95,clickCount:0,scrollDepth:0,timeOnPage:0,bounceRate:.1,conflictResolutionSuccess:.9,conflictResolutionAttempts:0,averageResolutionTime:0,userPreferredResolution:"auto",interfaceResponsiveness:85,loadingTime:0,errorEncounterRate:.02,satisfactionScore:85,feedbackCount:0,commonComplaints:[]}}calculateAveragePerformance(e){return e.length===0?0:e.reduce((r,n)=>r+n.perceivedPerformance,0)/e.length}calculatePerformanceTrend(e){if(e.length<2)return"stable";const t=e.slice(-10),r=e.slice(-20,-10),n=t.reduce((i,l)=>i+l.perceivedPerformance,0)/t.length,o=r.reduce((i,l)=>i+l.perceivedPerformance,0)/r.length;return n>o+5?"improving":n<o-5?"declining":"stable"}generateRecommendations(e,t){const r=[];return t.conflictResolutionSuccess<.8&&r.push("Improve conflict resolution algorithms"),t.interfaceResponsiveness<70&&r.push("Optimize UI responsiveness"),t.errorEncounterRate>.05&&r.push("Reduce error rates in user interactions"),r}createAlert(e){const t={...e,id:this.generateAlertId(),timestamp:new Date};this.alerts.push(t),console.warn("Performance Alert:",t)}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateAlertId(){return`alert_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getMetrics(){return[...this.metrics]}getAlerts(){return[...this.alerts]}clearMetrics(){this.metrics=[],this.alerts=[]}getRealtimeMetrics(){return{renderTime:this.calculateRenderTime(),memoryUsage:this.getMemoryUsage(),networkLatency:this.measureNetworkLatency(),perceivedPerformance:this.calculatePerceivedPerformance()}}}const Ne=ut.getInstance();function Sn({className:a,showDetails:e=!1,compact:t=!1}){const[r,n]=c.useState(!0),[o,i]=c.useState(!1),[l,u]=c.useState(null),[m,d]=c.useState([]),[h,g]=c.useState({lastSyncTime:null,totalOperations:0,successfulOperations:0,failedOperations:0,averageSyncTime:0,networkLatency:0,serverResponseTime:0,dataTransferRate:0}),[f,p]=c.useState(!1);c.useEffect(()=>{const w=()=>n(!0),k=()=>n(!1);return window.addEventListener("online",w),window.addEventListener("offline",k),n(navigator.onLine),()=>{window.removeEventListener("online",w),window.removeEventListener("offline",k)}},[]),c.useEffect(()=>{const w=async()=>{try{const H=de.getStatus();u(H),i(H.isSyncing),H.lastSyncTime&&g(W=>({...W,lastSyncTime:new Date(H.lastSyncTime),totalOperations:H.totalSyncs||0,successfulOperations:H.successfulSyncs||0,failedOperations:H.failedSyncs||0}));const te=Ne.getRealtimeMetrics();g(W=>({...W,networkLatency:te.networkLatency||0}))}catch(H){console.error("Failed to update sync status:",H)}};w();const k=setInterval(w,2e3),I=()=>{i(!0),b({type:"upload",entity:"批量同步",status:"in_progress",progress:0,startTime:new Date})},K=()=>{i(!1),C("completed"),w()},O=H=>{i(!1),C("failed",H.message)};return de.on("sync:start",I),de.on("sync:complete",K),de.on("sync:error",O),()=>{clearInterval(k),de.off("sync:start",I),de.off("sync:complete",K),de.off("sync:error",O)}},[]);const b=w=>{const k={...w,id:`op_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};d(I=>[k,...I.slice(0,9)]),g(I=>({...I,totalOperations:I.totalOperations+1}))},C=(w,k)=>{d(I=>I.map(K=>K.status==="in_progress"?{...K,status:w,endTime:new Date,error:k,progress:w==="completed"?100:K.progress}:K)),w==="completed"?g(I=>({...I,successfulOperations:I.successfulOperations+1})):w==="failed"&&g(I=>({...I,failedOperations:I.failedOperations+1}))},v=async()=>{try{i(!0),await de.sync({type:"incremental",direction:"bidirectional"})}catch(w){console.error("Manual sync failed:",w)}finally{i(!1)}},y=()=>r?o?"text-yellow-500 animate-pulse":l?.hasConflicts?"text-orange-500":"text-green-500":"text-red-500",x=()=>r?o?s.jsx(De,{className:"h-4 w-4 animate-spin"}):l?.hasConflicts?s.jsx(Ee,{className:"h-4 w-4"}):s.jsx(ts,{className:"h-4 w-4"}):s.jsx(Ls,{className:"h-4 w-4"}),j=()=>r?o?"同步中...":l?.hasConflicts?"需要解决冲突":"已同步":"离线",N=w=>{if(!w)return"从未";const I=new Date().getTime()-w.getTime(),K=Math.floor(I/6e4);return K<1?"刚刚":K<60?`${K}分钟前`:K<1440?`${Math.floor(K/60)}小时前`:`${Math.floor(K/1440)}天前`},E=h.totalOperations>0?(h.successfulOperations/h.totalOperations*100).toFixed(1):"0.0";return t?s.jsxs("div",{className:A("flex items-center gap-2 text-sm",a),children:[s.jsxs("div",{className:A("flex items-center gap-1",y()),children:[x(),s.jsx("span",{children:j()})]}),l?.pendingOperations>0&&s.jsxs(Q,{variant:"secondary",className:"text-xs",children:[l.pendingOperations," 待同步"]}),s.jsx(P,{variant:"ghost",size:"sm",onClick:v,disabled:o||!r,children:s.jsx(De,{className:A("h-3 w-3",o&&"animate-spin")})})]}):s.jsxs(ie,{className:A("w-full",a),children:[s.jsxs(Oe,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Fe,{className:"text-lg",children:"同步状态"}),s.jsxs("div",{className:A("flex items-center gap-1 text-sm",y()),children:[x(),s.jsx("span",{children:j()})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[l?.pendingOperations>0&&s.jsxs(Q,{variant:"outline",children:[l.pendingOperations," 待同步"]}),s.jsxs(P,{variant:"outline",size:"sm",onClick:v,disabled:o||!r,children:[s.jsx(De,{className:A("h-4 w-4 mr-2",o&&"animate-spin")}),"立即同步"]}),e&&s.jsx(P,{variant:"ghost",size:"sm",onClick:()=>p(!f),children:f?"收起":"详情"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"网络状态:"}),s.jsx("span",{className:"ml-2 font-medium",children:r?"在线":"离线"})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"最后同步:"}),s.jsx("span",{className:"ml-2 font-medium",children:N(h.lastSyncTime)})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"成功率:"}),s.jsxs("span",{className:"ml-2 font-medium",children:[E,"%"]})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"延迟:"}),s.jsxs("span",{className:"ml-2 font-medium",children:[h.networkLatency,"ms"]})]})]}),o&&m.length>0&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between text-sm",children:[s.jsx("span",{children:"同步进度"}),s.jsxs("span",{children:[m.find(w=>w.status==="in_progress")?.progress||0,"%"]})]}),s.jsx(He,{value:m.find(w=>w.status==="in_progress")?.progress||0,className:"h-2"})]})]}),f&&e&&s.jsxs(le,{className:"space-y-4",children:[s.jsx(dt,{}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(wr,{className:"h-4 w-4 text-blue-500"}),s.jsx("span",{className:"font-medium",children:"操作统计"})]}),s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"总操作数:"}),s.jsx("span",{children:h.totalOperations})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"成功:"}),s.jsx("span",{className:"text-green-600",children:h.successfulOperations})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"失败:"}),s.jsx("span",{className:"text-red-600",children:h.failedOperations})]})]})]})}),s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(So,{className:"h-4 w-4 text-green-500"}),s.jsx("span",{className:"font-medium",children:"性能指标"})]}),s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"平均同步时间:"}),s.jsxs("span",{children:[h.averageSyncTime,"ms"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"服务器响应:"}),s.jsxs("span",{children:[h.serverResponseTime,"ms"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"传输速率:"}),s.jsxs("span",{children:[h.dataTransferRate,"KB/s"]})]})]})]})}),s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(No,{className:"h-4 w-4 text-purple-500"}),s.jsx("span",{className:"font-medium",children:"同步状态"})]}),s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"待同步操作:"}),s.jsx("span",{children:l?.pendingOperations||0})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"冲突数量:"}),s.jsx("span",{children:l?.conflicts?.length||0})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"同步模式:"}),s.jsx("span",{children:"自动"})]})]})]})})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"最近操作"}),s.jsx(Ye,{className:"h-48 border rounded-md p-2",children:s.jsx("div",{className:"space-y-2",children:m.length===0?s.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"暂无操作记录"}):m.map(w=>s.jsxs("div",{className:"flex items-center justify-between text-sm p-2 rounded border",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[w.status==="completed"&&s.jsx(Ke,{className:"h-3 w-3 text-green-500"}),w.status==="failed"&&s.jsx(_t,{className:"h-3 w-3 text-red-500"}),w.status==="in_progress"&&s.jsx(Mt,{className:"h-3 w-3 text-yellow-500 animate-spin"}),w.status==="pending"&&s.jsx(Mt,{className:"h-3 w-3 text-gray-500"}),s.jsx("span",{children:w.entity}),s.jsx(Q,{variant:"outline",className:"text-xs",children:w.type==="upload"?"上传":w.type==="download"?"下载":w.type==="conflict_resolution"?"冲突解决":"合并"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[w.status==="in_progress"&&s.jsx(He,{value:w.progress,className:"w-16 h-1"}),s.jsx("span",{className:"text-xs text-muted-foreground",children:N(w.startTime)})]})]},w.id))})})]})]})]})}function Nd({isOpen:a,onClose:e,className:t}){const{conflicts:r,setSelectedConflict:n,getStats:o,getPendingConflicts:i,getHighPriorityConflicts:l,resolveConflict:u,ignoreConflict:m,batchResolveConflicts:d,refreshConflicts:h,isResolving:g,isLoading:f,error:p,syncStatus:b}=is(),[C,v]=c.useState("all"),[y,x]=c.useState(""),[j,N]=c.useState(new Set),[E,w]=c.useState(new Set),[k,I]=c.useState(!1),[K,O]=c.useState(null),H=o(),te=i(),W=l(),Z=B.useMemo(()=>{let T=r;switch(C){case"pending":T=te;break;case"high":T=W;break;case"resolved":T=r.filter(U=>U.status==="resolved");break}if(y){const U=y.toLowerCase();T=T.filter(Y=>{switch(Y.entityType){case"card":return Y.localVersion.content.frontContent.title.toLowerCase().includes(U);case"folder":return Y.localVersion.name.toLowerCase().includes(U);case"tag":return Y.localVersion.name.toLowerCase().includes(U);default:return!1}})}return T.sort((U,Y)=>{const L={critical:4,high:3,medium:2,low:1},R=L[Y.severity]-L[U.severity];return R!==0?-R:Y.timestamp.getTime()-U.timestamp.getTime()})},[r,C,y,te,W]),ne=T=>{N(U=>{const Y=new Set(U);return Y.has(T)?Y.delete(T):Y.add(T),Y})},re=T=>{w(U=>{const Y=new Set(U);return Y.has(T)?Y.delete(T):Y.add(T),Y})},ge=T=>{O(T),I(!0)},z=()=>{E.size===Z.length?w(new Set):w(new Set(Z.map(T=>T.id)))},q=async T=>{if(E.size===0)return;const U=Array.from(E);await d(U,{type:T,reason:`批量选择${T==="keep_local"?"本地":"远程"}版本`}),w(new Set)},_=T=>{switch(T){case"critical":return"text-red-600 bg-red-50 border-red-200";case"high":return"text-orange-600 bg-orange-50 border-orange-200";case"medium":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"low":return"text-blue-600 bg-blue-50 border-blue-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}},M=T=>{switch(T){case"resolved":return s.jsx(Ke,{className:"h-4 w-4 text-green-500"});case"ignored":return s.jsx(_t,{className:"h-4 w-4 text-gray-500"});default:return s.jsx(Mt,{className:"h-4 w-4 text-yellow-500"})}};return a?s.jsx("div",{className:A("fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",t),children:s.jsxs(ie,{className:"w-full max-w-4xl max-h-[90vh] flex flex-col",children:[s.jsxs(Oe,{className:"pb-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(Ee,{className:"h-5 w-5 text-orange-500"}),s.jsx(Fe,{className:"text-xl",children:"冲突管理中心"}),s.jsxs(Q,{variant:"outline",className:"ml-2",children:[H.pendingConflicts," 待解决"]})]}),s.jsx(P,{variant:"ghost",size:"sm",onClick:e,children:"×"})]}),s.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[s.jsxs("span",{children:["总计: ",H.totalConflicts]}),s.jsxs("span",{children:["已解决: ",H.resolvedConflicts]}),s.jsxs("span",{children:["待处理: ",H.pendingConflicts]}),s.jsxs("span",{children:["高优先级: ",W.length]}),b&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:`w-2 h-2 rounded-full ${b.isSyncing?"bg-yellow-500 animate-pulse":b.networkStatus?.online?"bg-green-500":"bg-red-500"}`}),s.jsx("span",{children:b.isSyncing?"同步中...":b.networkStatus?.online?"在线":"离线"})]}),b.pendingOperations>0&&s.jsxs("span",{children:["待同步: ",b.pendingOperations]})]})]}),s.jsx(Sn,{showDetails:!0,compact:!1,className:"mb-4"}),p&&s.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-red-600",children:p}),s.jsx(P,{variant:"ghost",size:"sm",onClick:()=>window.location.reload(),children:"重试"})]})})]}),s.jsxs(le,{className:"flex-1 flex flex-col space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"relative flex-1",children:[s.jsx(mt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx("input",{type:"text",placeholder:"搜索冲突...",value:y,onChange:T=>x(T.target.value),className:"w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(P,{variant:C==="all"?"default":"outline",size:"sm",onClick:()=>v("all"),children:"全部"}),s.jsx(P,{variant:C==="pending"?"default":"outline",size:"sm",onClick:()=>v("pending"),children:"待解决"}),s.jsx(P,{variant:C==="high"?"default":"outline",size:"sm",onClick:()=>v("high"),children:"高优先级"}),s.jsx(P,{variant:C==="resolved"?"default":"outline",size:"sm",onClick:()=>v("resolved"),children:"已解决"})]}),s.jsxs(P,{variant:"outline",size:"sm",onClick:h,disabled:f,children:[s.jsx(De,{className:`h-4 w-4 mr-2 ${f?"animate-spin":""}`}),"刷新"]})]}),E.size>0&&s.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{className:"text-sm font-medium",children:["已选择 ",E.size," 个冲突"]}),s.jsx(P,{variant:"ghost",size:"sm",onClick:z,children:E.size===Z.length?"取消全选":"全选"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(P,{variant:"outline",size:"sm",onClick:()=>q("keep_local"),disabled:g,children:"批量保留本地"}),s.jsx(P,{variant:"outline",size:"sm",onClick:()=>q("keep_remote"),disabled:g,children:"批量保留远程"})]})]}),s.jsx(Ye,{className:"flex-1",children:s.jsx("div",{className:"space-y-3",children:f?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(De,{className:"h-8 w-8 animate-spin mx-auto mb-4 text-muted-foreground"}),s.jsx("p",{className:"text-muted-foreground",children:"加载冲突信息..."})]}):Z.length===0?s.jsx("div",{className:"text-center py-8 text-muted-foreground",children:y?"没有找到匹配的冲突":"暂无冲突"}):Z.map(T=>s.jsx(kd,{conflict:T,isExpanded:j.has(T.id),isSelected:E.has(T.id),onToggleExpand:()=>ne(T.id),onToggleSelect:()=>re(T.id),onSelect:()=>n(T.id),onViewDetail:()=>ge(T.id),onResolve:U=>u(T.id,U),onIgnore:()=>m(T.id),getSeverityColor:_,getStatusIcon:M,isResolving:g},T.id))})})]})]})}):null}function kd({conflict:a,isExpanded:e,isSelected:t,onToggleExpand:r,onToggleSelect:n,onSelect:o,onViewDetail:i,onResolve:l,onIgnore:u,getSeverityColor:m,getStatusIcon:d,isResolving:h}){return s.jsx(ie,{className:A("transition-all duration-200 cursor-pointer hover:shadow-md",m(a.severity),t&&"ring-2 ring-blue-500"),onClick:o,children:s.jsx(le,{className:"p-4",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[s.jsx("input",{type:"checkbox",checked:t,onChange:n,onClick:g=>g.stopPropagation(),className:"mt-1"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[d(a.status),s.jsx(Q,{variant:"outline",className:"text-xs",children:a.severity}),s.jsx(Q,{variant:"secondary",className:"text-xs",children:Ed(a.type)}),s.jsx("span",{className:"text-xs text-muted-foreground",children:fa(a.timestamp)})]}),s.jsx("h4",{className:"font-medium mb-1",children:Dd(a)}),s.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:Rd(a)}),e&&s.jsxs("div",{className:"mt-3 pt-3 border-t space-y-2",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"font-medium",children:"来源设备:"}),s.jsx("span",{className:"ml-2",children:a.sourceDevice})]}),s.jsxs("div",{children:[s.jsx("span",{className:"font-medium",children:"冲突时间:"}),s.jsx("span",{className:"ml-2",children:fa(a.timestamp)})]})]}),s.jsxs("div",{className:"flex gap-2 pt-2",children:[s.jsx(P,{variant:"default",size:"sm",onClick:g=>{g.stopPropagation(),i()},children:"查看详情"}),s.jsx(P,{variant:"outline",size:"sm",onClick:g=>{g.stopPropagation(),l({type:"keep_local",reason:"保留本地版本"})},disabled:h,children:"保留本地"}),s.jsx(P,{variant:"outline",size:"sm",onClick:g=>{g.stopPropagation(),l({type:"keep_remote",reason:"保留远程版本"})},disabled:h,children:"保留远程"}),s.jsx(P,{variant:"ghost",size:"sm",onClick:g=>{g.stopPropagation(),u()},children:"忽略"})]})]})]})]}),s.jsx(P,{variant:"ghost",size:"sm",onClick:g=>{g.stopPropagation(),r()},className:"ml-2",children:e?s.jsx(Ps,{className:"h-4 w-4"}):s.jsx(es,{className:"h-4 w-4"})})]})})})}function Ed(a){return{card_content:"卡片内容",card_style:"卡片样式",card_tags:"卡片标签",card_folder:"卡片文件夹",folder_name:"文件夹名称",folder_structure:"文件夹结构",tag_rename:"标签重命名",tag_delete:"标签删除",tag_color:"标签颜色"}[a]||a}function Dd(a){switch(a.entityType){case"card":return a.localVersion.content.frontContent.title;case"folder":return a.localVersion.name;case"tag":return a.localVersion.name;default:return"未知冲突"}}function Rd(a){switch(a.type){case"card_content":return"卡片内容在多设备上被同时编辑";case"folder_name":return"文件夹名称与远程版本不一致";case"tag_rename":return"标签重命名冲突";default:return"数据版本不一致"}}function fa(a){const t=new Date().getTime()-a.getTime(),r=Math.floor(t/6e4);return r<1?"刚刚":r<60?`${r}分钟前`:r<1440?`${Math.floor(r/60)}小时前`:`${Math.floor(r/1440)}天前`}const Td=ao,Nn=c.forwardRef(({className:a,...e},t)=>s.jsx(dr,{ref:t,className:A("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",a),...e}));Nn.displayName=dr.displayName;const Tt=c.forwardRef(({className:a,...e},t)=>s.jsx(ur,{ref:t,className:A("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",a),...e}));Tt.displayName=ur.displayName;const At=c.forwardRef(({className:a,...e},t)=>s.jsx(mr,{ref:t,className:A("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",a),...e}));At.displayName=mr.displayName;const kn=c.forwardRef(({className:a,...e},t)=>s.jsx("textarea",{className:A("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",a),ref:t,...e}));kn.displayName="Textarea";function Ad({conflictId:a,onClose:e,className:t}){const{getConflictById:r,resolveConflict:n,ignoreConflict:o,getSuggestions:i,isResolving:l}=is(),[u,m]=c.useState("compare"),[d,h]=c.useState("local"),[g,f]=c.useState({}),[p,b]=c.useState(!0),C=r(a),v=i(a);if(!C)return s.jsx(ie,{className:A("w-full max-w-6xl max-h-[90vh]",t),children:s.jsxs(le,{className:"p-8 text-center",children:[s.jsx(_t,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"冲突不存在"}),s.jsx("p",{className:"text-muted-foreground mb-4",children:"指定的冲突ID未找到或已被解决"}),s.jsx(P,{onClick:e,children:"关闭"})]})});const y=async()=>{let w;switch(d){case"local":w={type:"keep_local",reason:"用户选择保留本地版本"};break;case"remote":w={type:"keep_remote",reason:"用户选择保留远程版本"};break;case"merge":w={type:"merge",reason:"用户选择智能合并",mergedData:x()};break;case"manual":w={type:"manual",reason:"用户手动编辑",mergedData:g,manualChanges:Object.entries(g).map(([I,K])=>({field:I,value:K,source:"custom"}))};break}await n(a,w)&&e()},x=()=>C.entityType==="card"?{content:{frontContent:j(C.localVersion.content.frontContent,C.remoteVersion.content.frontContent),backContent:j(C.localVersion.content.backContent,C.remoteVersion.content.backContent)},style:C.localVersion.style}:C.localVersion,j=(w,k)=>({title:w.title.length>k.title.length?w.title:k.title,text:`${w.text}

${k.text}`,tags:[...new Set([...w.tags,...k.tags])],lastModified:new Date}),E=C.type==="card_content"?[{field:"title",label:"标题",local:C.localVersion.content.frontContent.title,remote:C.remoteVersion.content.frontContent.title},{field:"frontText",label:"正面内容",local:C.localVersion.content.frontContent.text,remote:C.remoteVersion.content.frontContent.text},{field:"backText",label:"背面内容",local:C.localVersion.content.backContent.text,remote:C.remoteVersion.content.backContent.text},{field:"tags",label:"标签",local:C.localVersion.content.frontContent.tags,remote:C.remoteVersion.content.frontContent.tags}]:[];return s.jsxs(ie,{className:A("w-full max-w-6xl max-h-[90vh] flex flex-col",t),children:[s.jsxs(Oe,{className:"pb-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(Ee,{className:A("h-5 w-5",Od(C.severity))}),s.jsxs("div",{children:[s.jsx(Fe,{className:"text-xl",children:Id(C)}),s.jsx("p",{className:"text-sm text-muted-foreground",children:_d(C)})]})]}),s.jsx(P,{variant:"ghost",size:"sm",onClick:e,children:"×"})]}),s.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[s.jsxs("span",{children:["类型: ",Md(C.type)]}),s.jsxs("span",{children:["优先级: ",C.severity]}),s.jsxs("span",{children:["来源: ",C.sourceDevice]}),s.jsxs("span",{children:["时间: ",ot(C.timestamp)]}),s.jsx(Q,{variant:"outline",children:C.status==="pending"?"待解决":C.status==="resolved"?"已解决":"已忽略"})]})]}),s.jsxs(le,{className:"flex-1 flex flex-col",children:[s.jsxs(Td,{value:u,onValueChange:m,className:"flex-1 flex flex-col",children:[s.jsxs(Nn,{className:"grid w-full grid-cols-4",children:[s.jsx(Tt,{value:"compare",children:"对比视图"}),s.jsx(Tt,{value:"suggestions",children:"智能建议"}),s.jsx(Tt,{value:"history",children:"历史记录"}),s.jsx(Tt,{value:"manual",children:"手动合并"})]}),s.jsxs("div",{className:"flex-1 mt-4",children:[s.jsx(At,{value:"compare",className:"h-full",children:s.jsxs("div",{className:"grid grid-cols-2 gap-4 h-full",children:[s.jsxs(ie,{className:"border-green-200",children:[s.jsxs(Oe,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(Fe,{className:"text-base flex items-center gap-2",children:[s.jsx(ko,{className:"h-4 w-4 text-green-600"}),"本地版本"]}),s.jsx(Q,{variant:"outline",className:"text-green-600 border-green-200",children:"本地设备"})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["更新时间: ",ot(C.localVersion.updatedAt)]})]}),s.jsx(le,{className:"p-4",children:s.jsx(Ye,{className:"h-96",children:ga(C,"local")})})]}),s.jsxs(ie,{className:"border-blue-200",children:[s.jsxs(Oe,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(Fe,{className:"text-base flex items-center gap-2",children:[s.jsx(Eo,{className:"h-4 w-4 text-blue-600"}),"远程版本"]}),s.jsx(Q,{variant:"outline",className:"text-blue-600 border-blue-200",children:C.sourceDevice})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["更新时间: ",ot(C.remoteVersion.updatedAt)]})]}),s.jsx(le,{className:"p-4",children:s.jsx(Ye,{className:"h-96",children:ga(C,"remote")})})]})]})}),s.jsx(At,{value:"suggestions",className:"h-full",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Do,{className:"h-5 w-5 text-blue-500"}),s.jsx("h3",{className:"text-lg font-semibold",children:"智能解决建议"})]}),v.length>0?s.jsx("div",{className:"grid gap-3",children:v.map((w,k)=>s.jsx(ie,{className:"cursor-pointer hover:shadow-md transition-shadow",children:s.jsx(le,{className:"p-4",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(Q,{variant:w.type==="merge"?"default":"secondary",children:Fd(w.type)}),s.jsxs(Q,{variant:"outline",children:["置信度: ",Math.round(w.confidence*100),"%"]})]}),s.jsx("p",{className:"text-sm mb-2",children:w.reason}),w.preview&&s.jsxs("div",{className:"text-xs text-muted-foreground bg-gray-50 p-2 rounded",children:["预览: ",JSON.stringify(w.preview)]})]}),s.jsx(P,{variant:"outline",size:"sm",onClick:()=>h(w.type),children:"应用建议"})]})})},k))}):s.jsx(ie,{children:s.jsxs(le,{className:"p-8 text-center",children:[s.jsx(_t,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-muted-foreground",children:"暂无智能建议，请手动选择解决方案"})]})})]})}),s.jsx(At,{value:"history",className:"h-full",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Mt,{className:"h-5 w-5 text-blue-500"}),s.jsx("h3",{className:"text-lg font-semibold",children:"冲突历史"})]}),s.jsx(ie,{children:s.jsx(le,{className:"p-4",children:s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:"冲突检测"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:ot(C.timestamp)})]}),s.jsx(Q,{variant:"destructive",children:"冲突"})]}),s.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:"本地版本更新"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:ot(C.localVersion.updatedAt)})]}),s.jsx(Q,{variant:"outline",children:"本地"})]}),s.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:"远程版本更新"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:ot(C.remoteVersion.updatedAt)})]}),s.jsx(Q,{variant:"outline",children:"远程"})]})]})})})]})}),s.jsx(At,{value:"manual",className:"h-full",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Jt,{className:"h-5 w-5 text-blue-500"}),s.jsx("h3",{className:"text-lg font-semibold",children:"手动合并"}),s.jsxs(P,{variant:"outline",size:"sm",onClick:()=>b(!p),children:[p?s.jsx(Rs,{className:"h-4 w-4 mr-1"}):s.jsx(Jt,{className:"h-4 w-4 mr-1"}),p?"隐藏差异":"显示差异"]})]}),s.jsx(Ye,{className:"h-96",children:s.jsx("div",{className:"space-y-4",children:E.map(w=>s.jsxs(ie,{children:[s.jsx(Oe,{className:"pb-3",children:s.jsx(Fe,{className:"text-base",children:w.label})}),s.jsxs(le,{className:"space-y-3",children:[p&&s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsxs("div",{className:"p-2 bg-green-50 rounded text-sm",children:[s.jsx("p",{className:"font-medium text-green-700 mb-1",children:"本地:"}),s.jsx("p",{children:w.local})]}),s.jsxs("div",{className:"p-2 bg-blue-50 rounded text-sm",children:[s.jsx("p",{className:"font-medium text-blue-700 mb-1",children:"远程:"}),s.jsx("p",{children:w.remote})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"text-sm font-medium mb-1 block",children:"合并结果:"}),w.field==="tags"?s.jsxs("div",{className:"flex flex-wrap gap-2",children:[Array.isArray(w.local)&&w.local.map(k=>s.jsx(Q,{variant:"secondary",children:k},k)),Array.isArray(w.remote)&&w.remote.map(k=>s.jsx(Q,{variant:"outline",children:k},k))]}):s.jsx(kn,{value:g[w.field]||w.local,onChange:k=>f(I=>({...I,[w.field]:k.target.value})),className:"min-h-[100px]"})]})]})]},w.field))})})]})})]})]}),s.jsx("div",{className:"mt-6 pt-6 border-t",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"text-sm font-medium",children:"解决方案:"}),s.jsx("div",{className:"flex gap-2",children:["local","remote","merge","manual"].map(w=>s.jsx(P,{variant:d===w?"default":"outline",size:"sm",onClick:()=>h(w),children:Pd(w)},w))})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(P,{variant:"outline",onClick:e,children:"取消"}),s.jsx(P,{variant:"ghost",onClick:()=>o(a),children:"忽略冲突"}),s.jsx(P,{onClick:y,disabled:l,children:l?"解决中...":"应用解决方案"})]})]})})]})]})}function ga(a,e){const t=e==="local"?a.localVersion:a.remoteVersion;return a.entityType==="card"?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"正面内容"}),s.jsxs("div",{className:"bg-gray-50 p-3 rounded",children:[s.jsx("h5",{className:"font-semibold mb-2",children:t.content.frontContent.title}),s.jsx("p",{className:"text-sm text-gray-600",children:t.content.frontContent.text}),s.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:t.content.frontContent.tags.map(r=>s.jsx(Q,{variant:"secondary",className:"text-xs",children:r},r))})]})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"背面内容"}),s.jsxs("div",{className:"bg-gray-50 p-3 rounded",children:[s.jsx("h5",{className:"font-semibold mb-2",children:t.content.backContent.title}),s.jsx("p",{className:"text-sm text-gray-600",children:t.content.backContent.text}),s.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:t.content.backContent.tags.map(r=>s.jsx(Q,{variant:"secondary",className:"text-xs",children:r},r))})]})]})]}):s.jsx("pre",{className:"text-sm",children:JSON.stringify(t,null,2)})}function Id(a){switch(a.entityType){case"card":return a.localVersion.content.frontContent.title;case"folder":return a.localVersion.name;case"tag":return a.localVersion.name;default:return"未知冲突"}}function _d(a){switch(a.type){case"card_content":return"卡片内容在多设备上被同时编辑，需要选择保留的版本";case"folder_name":return"文件夹名称与远程版本不一致";case"tag_rename":return"标签重命名冲突";default:return"数据版本不一致，需要手动解决"}}function Md(a){return{card_content:"卡片内容",card_style:"卡片样式",card_tags:"卡片标签",card_folder:"卡片文件夹",folder_name:"文件夹名称",folder_structure:"文件夹结构",tag_rename:"标签重命名",tag_delete:"标签删除",tag_color:"标签颜色"}[a]||a}function Od(a){switch(a){case"critical":return"text-red-600";case"high":return"text-orange-600";case"medium":return"text-yellow-600";case"low":return"text-blue-600";default:return"text-gray-600"}}function Fd(a){return{keep_local:"保留本地",keep_remote:"保留远程",merge:"智能合并",manual:"手动处理"}[a]||a}function Pd(a){return{local:"保留本地",remote:"保留远程",merge:"智能合并",manual:"手动合并"}[a]||a}function ot(a){const t=new Date().getTime()-a.getTime(),r=Math.floor(t/6e4);return r<1?"刚刚":r<60?`${r}分钟前`:r<1440?`${Math.floor(r/60)}小时前`:`${Math.floor(r/1440)}天前`}function Ld({className:a,showLabel:e=!0,showDetails:t=!0,onSync:r}){const[n,o]=c.useState({isOnline:!0,isSyncing:!1,hasConflicts:!1,pendingOperations:0,lastSyncTime:null,conflicts:[]});c.useEffect(()=>{const f=()=>{o(b=>({...b,isOnline:!0}))},p=()=>{o(b=>({...b,isOnline:!1}))};return window.addEventListener("online",f),window.addEventListener("offline",p),o(b=>({...b,isOnline:navigator.onLine})),()=>{window.removeEventListener("online",f),window.removeEventListener("offline",p)}},[]),c.useEffect(()=>{const f=async()=>{try{const y=de.getStatus();o(x=>({...x,isSyncing:y.isSyncing,hasConflicts:y.hasConflicts,pendingOperations:y.pendingOperations||0,lastSyncTime:y.lastSyncTime?new Date(y.lastSyncTime):null,conflicts:y.conflicts||[]}))}catch(y){console.error("Failed to update sync status:",y)}};f();const p=setInterval(f,3e3),b=()=>{o(y=>({...y,isSyncing:!0}))},C=()=>{o(y=>({...y,isSyncing:!1})),f()},v=()=>{o(y=>({...y,isSyncing:!1}))};return de.on("sync:start",b),de.on("sync:complete",C),de.on("sync:error",v),()=>{clearInterval(p),de.off("sync:start",b),de.off("sync:complete",C),de.off("sync:error",v)}},[]);const i=()=>n.isOnline?n.isSyncing?"text-yellow-500 animate-pulse":n.hasConflicts?"text-orange-500":"text-green-500":"text-red-500",l=()=>n.isOnline?n.isSyncing?s.jsx(De,{className:"h-4 w-4 animate-spin"}):n.hasConflicts?s.jsx(Ee,{className:"h-4 w-4"}):s.jsx(ts,{className:"h-4 w-4"}):s.jsx(Ls,{className:"h-4 w-4"}),u=()=>n.isOnline?n.isSyncing?"同步中...":n.hasConflicts?"有冲突":"已同步":"离线",m=f=>{if(!f)return"从未";const b=new Date().getTime()-f.getTime(),C=Math.floor(b/6e4);return C<1?"刚刚":C<60?`${C}分钟前`:C<1440?`${Math.floor(C/60)}小时前`:`${Math.floor(C/1440)}天前`},d=async()=>{if(r){r();return}try{await de.sync({type:"incremental",direction:"bidirectional"})}catch(f){console.error("Manual sync failed:",f)}},h=()=>s.jsxs("div",{className:A("flex items-center gap-2",a),children:[s.jsxs("div",{className:A("flex items-center gap-1",i()),children:[l(),e&&s.jsx("span",{className:"text-sm",children:u()})]}),n.pendingOperations>0&&s.jsx(Q,{variant:"secondary",className:"text-xs",children:n.pendingOperations}),n.conflicts.length>0&&s.jsx(Q,{variant:"destructive",className:"text-xs",children:n.conflicts.length}),s.jsx(P,{variant:"ghost",size:"sm",onClick:d,disabled:n.isSyncing||!n.isOnline,className:"h-6 w-6 p-0",children:s.jsx(De,{className:A("h-3 w-3",n.isSyncing&&"animate-spin")})})]}),g=()=>s.jsxs(Mr,{children:[s.jsx(Or,{asChild:!0,children:s.jsxs("div",{className:A("flex items-center gap-2 cursor-pointer hover:bg-accent rounded-md p-2",a),children:[s.jsxs("div",{className:A("flex items-center gap-1",i()),children:[l(),e&&s.jsx("span",{className:"text-sm font-medium",children:u()})]}),n.pendingOperations>0&&s.jsxs(Q,{variant:"outline",className:"text-xs",children:[n.pendingOperations," 待同步"]}),n.conflicts.length>0&&s.jsxs(Q,{variant:"destructive",className:"text-xs",children:[n.conflicts.length," 冲突"]}),s.jsx("span",{className:"text-xs text-muted-foreground",children:m(n.lastSyncTime)}),s.jsx(P,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),d()},disabled:n.isSyncing||!n.isOnline,className:"h-6 w-6 p-0 ml-auto",children:s.jsx(De,{className:A("h-3 w-3",n.isSyncing&&"animate-spin")})})]})}),s.jsx(Vs,{className:"w-96 p-0",align:"end",children:s.jsx(Sn,{showDetails:!0,compact:!1})})]});return t?s.jsx(g,{}):s.jsx(h,{})}function $d(a={}){const{enableMetricsCollection:e=!0,enableUserTracking:t=!0,enableConflictMonitoring:r=!0,reportInterval:n=3e4}=a,o=c.useRef({averageRenderTime:0,averageMemoryUsage:0,averageNetworkLatency:0,conflictResolutionTime:0,userSatisfaction:0,errorRate:0,totalOperations:0,successfulOperations:0}),i=c.useRef([]),l=c.useRef([]);c.useEffect(()=>{if(!e)return;Ne.clearMetrics();const k=setInterval(()=>{u()},n);return()=>{clearInterval(k)}},[e,n]);const u=c.useCallback(()=>{const k=Ne.getMetrics();if(k.length===0)return;const I=k.slice(-10),K=m(I);o.current={averageRenderTime:K.renderTime,averageMemoryUsage:K.memoryUsage,averageNetworkLatency:K.networkLatency,conflictResolutionTime:K.conflictResolutionTime,userSatisfaction:K.userSatisfaction,errorRate:d(I),totalOperations:I.length,successfulOperations:I.filter(O=>O.errorRate<.05).length},i.current=k},[]),m=c.useCallback(k=>k.length===0?{renderTime:0,memoryUsage:0,networkLatency:0,conflictResolutionTime:0,userSatisfaction:0,errorRate:0}:{renderTime:k.reduce((I,K)=>I+K.renderTime,0)/k.length,memoryUsage:k.reduce((I,K)=>I+K.memoryUsage,0)/k.length,networkLatency:k.reduce((I,K)=>I+K.networkLatency,0)/k.length,conflictResolutionTime:k.reduce((I,K)=>I+K.conflictResolutionTime,0)/k.length,userSatisfaction:k.reduce((I,K)=>I+K.userSatisfaction,0)/k.length,errorRate:k.reduce((I,K)=>I+K.errorRate,0)/k.length},[]),d=c.useCallback(k=>k.reduce((K,O)=>K+O.errorRate,0)/k.length,[]),h=c.useCallback(()=>r?Ne.startConflictDetection():()=>{},[r]),g=c.useCallback(()=>r?Ne.startConflictResolution():()=>{},[r]),f=c.useCallback(()=>r?Ne.startBatchOperation():()=>{},[r]),p=c.useCallback((k,I,K)=>{t&&(Ne.trackUserInteraction(k,I,K),l.current.push({action:k,duration:I,success:K,timestamp:new Date}),l.current.length>100&&(l.current=l.current.slice(-100)))},[t]),b=c.useCallback((k,I)=>{t&&Ne.trackUserSatisfaction(k,I)},[t]),C=c.useCallback((k=36e5)=>Ne.generateReport(k),[]),v=c.useCallback(()=>Ne.getRealtimeMetrics(),[]),y=c.useCallback(()=>Ne.getAlerts(),[]),x=c.useCallback((k=20)=>l.current.slice(-k),[]),j=c.useCallback(()=>({...o.current}),[]),N=c.useCallback(()=>{Ne.clearMetrics(),i.current=[],l.current=[],o.current={averageRenderTime:0,averageMemoryUsage:0,averageNetworkLatency:0,conflictResolutionTime:0,userSatisfaction:0,errorRate:0,totalOperations:0,successfulOperations:0}},[]),E=c.useCallback(()=>{const k=o.current;let I=100;return k.averageRenderTime>100&&(I-=20),k.averageRenderTime>200&&(I-=30),k.averageMemoryUsage>100*1024*1024&&(I-=15),k.averageMemoryUsage>200*1024*1024&&(I-=25),k.averageNetworkLatency>1e3&&(I-=10),k.averageNetworkLatency>2e3&&(I-=20),k.errorRate>.05&&(I-=15),k.errorRate>.1&&(I-=25),k.conflictResolutionTime>5e3&&(I-=10),k.conflictResolutionTime>1e4&&(I-=20),{healthScore:Math.max(0,I),status:I>=80?"good":I>=60?"warning":"critical",issues:w(k)}},[]),w=c.useCallback(k=>{const I=[];return k.averageRenderTime>100&&I.push("渲染时间过长，可能影响用户体验"),k.averageMemoryUsage>100*1024*1024&&I.push("内存使用较高，建议检查内存泄漏"),k.averageNetworkLatency>1e3&&I.push("网络延迟较高，可能影响同步性能"),k.errorRate>.05&&I.push("错误率较高，需要关注错误处理"),k.conflictResolutionTime>5e3&&I.push("冲突解决时间过长，建议优化算法"),I},[]);return{startConflictDetection:h,startConflictResolution:g,startBatchOperation:f,trackUserInteraction:p,trackUserSatisfaction:b,getPerformanceReport:C,getRealtimeMetrics:v,getPerformanceAlerts:y,getUserActionHistory:x,getPerformanceStats:j,clearPerformanceData:N,getPerformanceHealth:E,stats:o.current,isMonitoring:e}}function zd({className:a,showDetails:e=!0,compact:t=!1,autoRefresh:r=!0}){const[n,o]=c.useState(!1),[i,l]=c.useState("overview"),[u,m]=c.useState(0),{stats:d,getRealtimeMetrics:h,getPerformanceAlerts:g,getUserActionHistory:f,getPerformanceHealth:p,getPerformanceReport:b,isMonitoring:C}=$d({enableMetricsCollection:!0,enableUserTracking:!0,enableConflictMonitoring:!0,reportInterval:1e4}),[v,y]=c.useState({}),[x,j]=c.useState([]),[N,E]=c.useState([]),[w,k]=c.useState(null),I=()=>{y(h()),j(g()),E(f(20)),k(p()),m(W=>W+1)};c.useEffect(()=>{if(!r||!n)return;I();const W=setInterval(I,5e3);return()=>clearInterval(W)},[r,n,u]),c.useEffect(()=>{n&&I()},[n]);const K=W=>{if(W===0)return"0 B";const Z=1024,ne=["B","KB","MB","GB"],re=Math.floor(Math.log(W)/Math.log(Z));return`${parseFloat((W/Math.pow(Z,re)).toFixed(2))} ${ne[re]}`},O=W=>W<1e3?`${W.toFixed(0)}ms`:W<6e4?`${(W/1e3).toFixed(1)}s`:`${(W/6e4).toFixed(1)}min`,H=W=>{switch(W){case"good":return"text-green-500";case"warning":return"text-yellow-500";case"critical":return"text-red-500";default:return"text-gray-500"}},te=W=>{switch(W){case"good":return s.jsx(Ke,{className:"h-4 w-4 text-green-500"});case"warning":return s.jsx(Ee,{className:"h-4 w-4 text-yellow-500"});case"critical":return s.jsx(_t,{className:"h-4 w-4 text-red-500"});default:return s.jsx(Xs,{className:"h-4 w-4 text-gray-500"})}};return t?s.jsxs("div",{className:A("flex items-center gap-2",a),children:[s.jsxs("div",{className:A("flex items-center gap-1",H(w?.status||"unknown")),children:[te(w?.status||"unknown"),s.jsxs("span",{className:"text-sm font-medium",children:[w?.healthScore||0,"/100"]})]}),x.length>0&&s.jsx(Q,{variant:"destructive",className:"text-xs",children:x.length}),s.jsx(P,{variant:"ghost",size:"sm",onClick:()=>o(!n),children:s.jsx(Ro,{className:"h-4 w-4"})})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:A("flex items-center gap-2 cursor-pointer",a),onClick:()=>o(!n),children:[s.jsxs("div",{className:A("flex items-center gap-1",H(w?.status||"unknown")),children:[te(w?.status||"unknown"),s.jsxs("span",{className:"text-sm font-medium",children:["性能: ",w?.healthScore||0,"/100"]})]}),x.length>0&&s.jsxs(Q,{variant:"destructive",className:"text-xs",children:[x.length," 警报"]}),s.jsx(P,{variant:"ghost",size:"sm",children:n?"隐藏":"显示"})]}),n&&s.jsxs(ie,{className:"w-full max-w-4xl max-h-[80vh]",children:[s.jsxs(Oe,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(Fe,{className:"text-lg flex items-center gap-2",children:[s.jsx(Xs,{className:"h-5 w-5"}),"性能监控",s.jsx(Q,{variant:C?"default":"secondary",children:C?"监控中":"已停止"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(P,{variant:"outline",size:"sm",onClick:I,children:[s.jsx(De,{className:"h-4 w-4 mr-2"}),"刷新"]}),s.jsxs(P,{variant:"outline",size:"sm",onClick:()=>{const W=b();console.log("Performance Report:",W)},children:[s.jsx(ft,{className:"h-4 w-4 mr-2"}),"报告"]}),s.jsx(P,{variant:"ghost",size:"sm",onClick:()=>o(!1),children:"×"})]})]}),w&&s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"健康状态:"}),s.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[te(w.status),s.jsxs("span",{className:A("font-medium",H(w.status)),children:[w.healthScore,"/100 (",w.status,")"]})]})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"渲染时间:"}),s.jsx("span",{className:"ml-2 font-medium",children:O(v.renderTime||0)})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"内存使用:"}),s.jsx("span",{className:"ml-2 font-medium",children:K(v.memoryUsage||0)})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"网络延迟:"}),s.jsxs("span",{className:"ml-2 font-medium",children:[v.networkLatency||0,"ms"]})]})]})]}),s.jsxs(le,{children:[s.jsx("div",{className:"flex gap-2 mb-4",children:["overview","metrics","alerts","actions"].map(W=>s.jsxs(P,{variant:i===W?"default":"outline",size:"sm",onClick:()=>l(W),children:[W==="overview"&&"概览",W==="metrics"&&"指标",W==="alerts"&&"警报",W==="actions"&&"用户行为"]},W))}),s.jsxs(Ye,{className:"h-96",children:[i==="overview"&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(yr,{className:"h-4 w-4 text-yellow-500"}),s.jsx("span",{className:"font-medium",children:"渲染性能"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"平均渲染时间:"}),s.jsx("span",{children:O(d.averageRenderTime)})]}),s.jsx(He,{value:Math.min(100,d.averageRenderTime/100*100),className:"h-2"})]})]})}),s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(wr,{className:"h-4 w-4 text-blue-500"}),s.jsx("span",{className:"font-medium",children:"内存使用"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"内存使用:"}),s.jsx("span",{children:K(d.averageMemoryUsage)})]}),s.jsx(He,{value:Math.min(100,d.averageMemoryUsage/(100*1024*1024)*100),className:"h-2"})]})]})}),s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(ts,{className:"h-4 w-4 text-green-500"}),s.jsx("span",{className:"font-medium",children:"网络性能"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"平均延迟:"}),s.jsxs("span",{children:[d.averageNetworkLatency,"ms"]})]}),s.jsx(He,{value:Math.min(100,d.averageNetworkLatency/1e3*100),className:"h-2"})]})]})}),s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(To,{className:"h-4 w-4 text-purple-500"}),s.jsx("span",{className:"font-medium",children:"用户体验"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"满意度:"}),s.jsxs("span",{children:[d.userSatisfaction.toFixed(1),"%"]})]}),s.jsx(He,{value:d.userSatisfaction,className:"h-2"})]})]})})]}),w?.issues&&w.issues.length>0&&s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(Ee,{className:"h-4 w-4 text-orange-500"}),s.jsx("span",{className:"font-medium",children:"性能问题"})]}),s.jsx("div",{className:"space-y-1 text-sm",children:w.issues.map((W,Z)=>s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx("div",{className:"w-1 h-1 bg-orange-500 rounded-full mt-2 flex-shrink-0"}),s.jsx("span",{children:W})]},Z))})]})})]}),i==="metrics"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("h4",{className:"font-medium",children:"实时性能指标"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"渲染时间:"}),s.jsx("span",{children:O(v.renderTime||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"首次绘制:"}),s.jsx("span",{children:O(v.firstPaint||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"内容绘制:"}),s.jsx("span",{children:O(v.firstContentfulPaint||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"最大内容绘制:"}),s.jsx("span",{children:O(v.largestContentfulPaint||0)})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"内存使用:"}),s.jsx("span",{children:K(v.memoryUsage||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"网络延迟:"}),s.jsxs("span",{children:[v.networkLatency||0,"ms"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"冲突检测时间:"}),s.jsx("span",{children:O(v.conflictDetectionTime||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"冲突解决时间:"}),s.jsx("span",{children:O(v.conflictResolutionTime||0)})]})]})]})]}),i==="alerts"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("h4",{className:"font-medium",children:"性能警报"}),x.length===0?s.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"暂无性能警报"}):s.jsx("div",{className:"space-y-2",children:x.map((W,Z)=>s.jsx(ie,{className:"border-l-4 border-l-red-500",children:s.jsxs(le,{className:"p-3",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Ee,{className:"h-4 w-4 text-red-500"}),s.jsx("span",{className:"font-medium text-sm",children:W.type}),s.jsx(Q,{variant:"outline",className:"text-xs",children:W.severity})]}),s.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(W.timestamp).toLocaleTimeString()})]}),s.jsx("p",{className:"text-sm mb-2",children:W.message}),W.suggestions&&W.suggestions.length>0&&s.jsxs("div",{className:"space-y-1",children:[s.jsx("span",{className:"text-xs font-medium",children:"建议:"}),W.suggestions.map((ne,re)=>s.jsxs("div",{className:"text-xs text-muted-foreground",children:["• ",ne]},re))]})]})},Z))})]}),i==="actions"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("h4",{className:"font-medium",children:"用户行为历史"}),N.length===0?s.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"暂无用户行为记录"}):s.jsx("div",{className:"space-y-2",children:N.map((W,Z)=>s.jsx(ie,{children:s.jsx(le,{className:"p-3",children:s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-medium text-sm",children:W.action}),s.jsx(Q,{variant:W.success?"default":"destructive",className:"text-xs",children:W.success?"成功":"失败"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[s.jsx(Mt,{className:"h-3 w-3"}),s.jsx("span",{children:new Date(W.timestamp).toLocaleTimeString()}),s.jsxs("span",{children:["(",O(W.duration),")"]})]})]})})},Z))})]})]})]})]})]})}function Bd({className:a}){const[e,t]=c.useState({user:null,session:null,loading:!1,error:null}),{openModal:r}=Nr(),{cards:n,filter:o,setFilter:i,viewSettings:l,setViewSettings:u,dispatch:m,getAllTags:d,updateTagsInAllCards:h,getCardsWithTag:g}=gi(),{folderTree:f,selectedFolderId:p,setSelectedFolderId:b,dispatch:C,getFolderById:v,folders:y}=Cr(),{tags:x,popularTags:j,renameTag:N,deleteTagByName:E,getAllTagNames:w}=jr(),{toast:k}=Kc(),[I,K]=c.useState(!1),[O,H]=c.useState(!1),[te,W]=c.useState({gap:16,showLayoutControls:!1}),{stats:Z,selectedConflict:ne,setSelectedConflict:re}=is(),[ge,z]=c.useState(!1),[q,_]=c.useState(!1);c.useEffect(()=>Me.onAuthStateChange(t),[]);const[M,T]=c.useState(!1),[U,Y]=c.useState(!1),[L,R]=c.useState(null),[D,S]=c.useState(null),[$,J]=c.useState(),[ue,me]=c.useState(!1),[he,pe]=c.useState(!1),[$t,Ct]=c.useState(""),[je,jt]=c.useState(null),{isDownloading:zt,showPreview:Qe,previewData:St,captureScreenshot:Le,confirmDownload:ls,cancelPreview:cs}=$c({onSuccess:F=>{k({title:"Screenshot saved!",description:`${F}.png has been downloaded successfully.`})},onError:F=>{k({title:"Screenshot failed",description:F.message,variant:"destructive"})}}),we=F=>{m({type:"FLIP_CARD",payload:F})},Ve=(F,G)=>{m({type:"UPDATE_CARD",payload:{id:F,updates:G}})},ds=async F=>{const G=n.find(ee=>ee.id===F);if(G){const ee=G.isFlipped?G.backContent:G.frontContent,xe=hl(ee.title,ee.text);await pl(xe)?console.log("Card content copied to clipboard"):console.error("Failed to copy card content")}},us=async F=>{const G=n.find(fe=>fe.id===F);if(!G)return;const ee=document.querySelector(`[data-card-id="${F}"]`);if(!ee){k({title:"Screenshot failed",description:"Could not find card element. Please try again.",variant:"destructive"});return}const ye=(G.isFlipped?G.backContent:G.frontContent).title||"Untitled Card";await Le(ee,ye)},at=F=>{console.log("Share card:",F)},ms=F=>{m({type:"DELETE_CARD",payload:F})},Bt=(F,G)=>{const ee=n.find(fe=>fe.id===F);if(!ee)return;const xe=ee.folderId;if(m({type:"UPDATE_CARD",payload:{id:F,updates:{folderId:G||void 0}}}),xe){const fe=v(xe);fe&&C({type:"UPDATE_FOLDER",payload:{id:xe,updates:{cardIds:fe.cardIds.filter(En=>En!==F)}}})}if(G){const fe=v(G);fe&&C({type:"UPDATE_FOLDER",payload:{id:G,updates:{cardIds:[...fe.cardIds,F]}}})}const ye=G?v(G)?.name:"Root";k({title:"Card moved",description:`Card has been moved to "${ye}".`})},Ze=()=>{m({type:"CREATE_CARD",payload:{frontContent:{title:"New Card",text:"Click to edit this card...",images:[],tags:[],lastModified:new Date},backContent:{title:"Back Side",text:"Add additional content here...",images:[],tags:[],lastModified:new Date},style:{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:!1,folderId:p||void 0}})},$e=()=>{J(void 0),R(null),T(!0)},Nt=F=>{J(F),R(null),T(!0)},ze=F=>{const G=v(F);G&&(R({id:F,name:G.name,color:G.color,icon:G.icon||"Folder"}),J(void 0),T(!0))},Ut=F=>{const G=v(F);if(G){const ee=y.filter(xe=>xe.parentId===F);S({id:F,name:G.name,cardCount:G.cardIds.length,hasSubfolders:ee.length>0,subfolderCount:ee.length}),Y(!0)}},fs=F=>{L?(C({type:"UPDATE_FOLDER",payload:{id:L.id,updates:{name:F.name,color:F.color,icon:F.icon}}}),k({title:"Folder updated",description:`"${F.name}" has been updated successfully.`})):(C({type:"CREATE_FOLDER",payload:{name:F.name,color:F.color,icon:F.icon,cardIds:[],parentId:F.parentId,isExpanded:!0}}),k({title:"Folder created",description:`"${F.name}" has been created successfully.`}))},Vt=()=>{D&&(C({type:"DELETE_FOLDER",payload:D.id,onDeleteCards:F=>{F.forEach(G=>{m({type:"DELETE_CARD",payload:G})})}}),k({title:"Folder deleted",description:`"${D.name}" and ${D.cardCount} cards have been deleted.`}),p===D.id&&rt(null))},Wt=F=>{const G=o.tags.includes(F);i({...o,tags:G?o.tags.filter(ee=>ee!==F):[...o.tags,F]})},rt=F=>{b(F),i({...o,folderId:F||void 0})},kt=F=>{Ct(F),me(!0)},Ie=F=>{const G=g(F);jt({name:F,cardCount:G.length}),pe(!0)},gs=(F,G)=>{N(F,G)?(h(F,G),k({title:"Tag renamed",description:`"${F}" has been renamed to "${G}".`}),me(!1),Ct("")):k({title:"Rename failed",description:"A tag with this name already exists.",variant:"destructive"})},X=()=>{je&&E(je.name)&&(h(je.name),o.tags.includes(je.name)&&i({...o,tags:o.tags.filter(G=>G!==je.name)}),k({title:"Tag deleted",description:`"${je.name}" has been removed from ${je.cardCount} cards.`}),pe(!1),jt(null))},ae=(F,G=0)=>F.map(ee=>s.jsxs("div",{style:{marginLeft:G*16},children:[s.jsx(ma,{folderId:ee.id,folderName:ee.name,onRename:ze,onDelete:Ut,onCreateSubfolder:Nt,children:s.jsxs(P,{variant:p===ee.id?"secondary":"ghost",className:"w-full justify-start text-sm mb-1",onClick:()=>rt(ee.id),children:[s.jsx(Ge,{className:"h-4 w-4 mr-2",style:{color:ee.color}}),ee.name,s.jsx(Q,{variant:"secondary",className:"ml-auto",children:ee.cardIds.length})]})}),ee.children&&ee.children.length>0&&ee.isExpanded&&s.jsx("div",{className:"ml-4",children:ae(ee.children,G+1)})]},ee.id)),oe=F=>F.map(G=>s.jsxs("div",{children:[s.jsx(ma,{folderId:G.id,folderName:G.name,onRename:ze,onDelete:Ut,onCreateSubfolder:Nt,children:s.jsx(P,{variant:p===G.id?"secondary":"ghost",className:"w-full h-10 p-0 mb-1",onClick:()=>rt(G.id),title:G.name,children:s.jsx(Ge,{className:"h-4 w-4",style:{color:G.color}})})}),G.children&&G.children.length>0&&G.isExpanded&&s.jsx("div",{children:oe(G.children)})]},G.id));return s.jsx(cl,{children:s.jsxs("div",{className:A("min-h-screen bg-background",a),children:[s.jsx("header",{className:"sticky top-0 z-40 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:s.jsxs("div",{className:"container flex h-16 items-center justify-between px-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"h-8 w-8 rounded-lg bg-gradient-to-br from-violet-500 to-pink-500 flex items-center justify-center",children:s.jsx("span",{className:"text-white font-bold text-sm",children:"CA"})}),s.jsxs("h1",{className:"text-xl font-bold",children:[s.jsx("span",{className:"text-violet-600",children:"Card"}),s.jsx("span",{className:"text-pink-500",children:"All"})]})]}),s.jsx("div",{className:"absolute left-1/2 transform -translate-x-1/2 hidden md:block",children:s.jsxs("div",{className:"relative",children:[s.jsx(mt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{placeholder:"Search cards...",value:o.searchTerm,onChange:F=>i({...o,searchTerm:F.target.value}),className:"pl-10 rounded-full w-80"})]})}),s.jsx("div",{className:"md:hidden absolute left-1/2 transform -translate-x-1/2",children:s.jsxs("div",{className:"relative",children:[s.jsx(mt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{placeholder:"Search...",value:o.searchTerm,onChange:F=>i({...o,searchTerm:F.target.value}),className:"pl-10 rounded-full w-60"})]})}),s.jsxs("div",{className:"flex items-center gap-2",children:[Z.pendingConflicts>0&&s.jsxs(P,{variant:"ghost",size:"sm",onClick:()=>z(!0),className:"relative text-orange-600 hover:bg-orange-50",children:[s.jsx(Ee,{className:"h-4 w-4"}),Z.pendingConflicts>0&&s.jsx(Q,{variant:"destructive",className:"absolute -top-2 -right-2 h-5 w-5 flex items-center justify-center p-0 text-xs",children:Z.pendingConflicts>99?"99+":Z.pendingConflicts}),s.jsx("span",{className:"sr-only",children:"Conflict Notifications"})]}),s.jsx(Ld,{showDetails:!0,showLabel:!1,className:"mr-1"}),s.jsx(zd,{compact:!0,autoRefresh:!0}),s.jsxs(Mr,{children:[s.jsx(Or,{asChild:!0,children:s.jsx(P,{variant:"ghost",size:"sm",children:s.jsx(Ao,{className:"h-4 w-4"})})}),s.jsx(Vs,{className:"w-80",align:"end",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx("h4",{className:"font-medium",children:"Layout Settings"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Customize the masonry layout appearance"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs(Ce,{children:["Gap Size: ",te.gap,"px"]}),s.jsx(_r,{value:[te.gap],onValueChange:([F])=>W(G=>({...G,gap:F})),max:32,min:8,step:4,className:"w-full"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{children:"Card Size"}),s.jsx("div",{className:"flex gap-2",children:["small","medium","large"].map(F=>s.jsx(P,{variant:l.cardSize===F?"default":"outline",size:"sm",onClick:()=>u(G=>({...G,cardSize:F})),children:F.charAt(0).toUpperCase()+F.slice(1)},F))})]})]})})]}),s.jsxs(P,{onClick:Ze,variant:"ghost",size:"sm",className:"text-black font-bold hover:bg-gray-100 rounded-full w-10 h-10 p-0 flex items-center justify-center",children:[s.jsx(Gt,{className:"h-6 w-6"}),s.jsx("span",{className:"sr-only",children:"Add Card"})]}),s.jsx(P,{variant:"ghost",size:"sm",onClick:r,className:"flex items-center gap-2",children:e.user?s.jsxs(s.Fragment,{children:[s.jsx(rn,{user:e.user,size:"sm",onClick:r,showHoverEffect:!0}),s.jsx("span",{className:"hidden sm:inline text-sm",children:e.user.username||"User"})]}):s.jsxs(s.Fragment,{children:[s.jsx(Io,{className:"h-4 w-4"}),s.jsx("span",{className:"hidden sm:inline text-sm",children:"Login"})]})})]})]})}),s.jsxs("main",{className:"flex h-[calc(100vh-4rem)]",children:[s.jsx("div",{className:"absolute top-16 left-0 right-0 z-30 bg-background border-b",children:s.jsx(vd,{onOpenConflictPanel:()=>z(!0)})}),s.jsxs("aside",{className:A("border-r transition-all duration-300 ease-in-out flex flex-col",O?"w-16":"w-72"),children:[s.jsx("div",{className:"p-3 flex items-center justify-end",children:s.jsx(P,{variant:"ghost",size:"sm",onClick:()=>H(!O),className:"h-8 w-8 p-0",children:O?s.jsx(es,{className:"h-4 w-4"}):s.jsx(_o,{className:"h-4 w-4"})})}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsxs("div",{className:"p-3 space-y-4",children:[!O&&s.jsxs("div",{children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs(P,{className:"w-full justify-start",onClick:Ze,children:[s.jsx(Gt,{className:"h-4 w-4 mr-2"}),"New Card"]}),s.jsxs(P,{variant:"outline",className:"w-full justify-start",onClick:$e,children:[s.jsx(Ds,{className:"h-4 w-4 mr-2"}),"New Folder"]})]}),s.jsx(dt,{className:"my-4"})]}),O&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(P,{variant:"ghost",size:"sm",className:"w-full h-10 p-0",onClick:Ze,title:"New Card",children:s.jsx(Gt,{className:"h-4 w-4"})}),s.jsx(P,{variant:"ghost",size:"sm",className:"w-full h-10 p-0",onClick:$e,title:"New Folder",children:s.jsx(Ds,{className:"h-4 w-4"})}),s.jsx(dt,{className:"my-4"})]}),s.jsxs("div",{children:[!O&&s.jsx("h3",{className:"text-sm font-medium mb-3",children:"Folders"}),s.jsxs("div",{className:"space-y-1",children:[s.jsxs(P,{variant:p?"ghost":"secondary",className:A("w-full text-sm",O?"h-10 p-0":"justify-start"),onClick:()=>rt(null),title:O?"All Cards":void 0,children:[s.jsx(Ge,{className:"h-4 w-4"}),!O&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"ml-2",children:"All Cards"}),s.jsx(Q,{variant:"secondary",className:"ml-auto",children:n.length})]})]}),O?oe(f):ae(f)]})]}),s.jsx(dt,{}),s.jsxs("div",{children:[!O&&s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-medium",children:"Tags"}),o.tags.length>0&&s.jsx(P,{variant:"ghost",size:"sm",onClick:()=>i({...o,tags:[]}),className:"h-6 px-2 text-xs",children:"Clear"})]}),s.jsx("div",{className:"space-y-1",children:j(O?5:10).map(F=>s.jsx(ud,{tagName:F.name,onRename:kt,onDelete:Ie,disabled:O,children:s.jsxs(P,{variant:o.tags.includes(F.name)?"secondary":"ghost",className:A("w-full text-sm",O?"h-10 p-0":"justify-start"),onClick:()=>Wt(F.name),title:O?`${F.name} (Right-click to expand sidebar for tag management)`:F.name,children:[s.jsx(pr,{className:"h-3 w-3",style:{color:F.color}}),!O&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"ml-2",children:F.name}),s.jsx(Q,{variant:"secondary",className:"ml-auto",children:F.count})]})]})},F.id))})]}),!O&&(o.tags.length>0||o.searchTerm)&&s.jsxs(s.Fragment,{children:[s.jsx(dt,{}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-sm font-medium mb-3",children:"Active Filters"}),s.jsxs("div",{className:"space-y-2",children:[o.searchTerm&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(mt,{className:"h-3 w-3"}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:['"',o.searchTerm,'"']})]}),o.tags.map(F=>s.jsx(Q,{variant:"secondary",className:"mr-1",children:F},F))]})]})]})]})})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx("div",{className:"p-4",children:s.jsx(fl,{cards:n,onCardFlip:we,onCardUpdate:Ve,onCardCopy:ds,onCardScreenshot:us,onCardShare:at,onCardDelete:ms,onMoveToFolder:Bt,cardSize:l.cardSize==="small"?"sm":l.cardSize==="large"?"lg":"md",enableVirtualization:n.length>20,gap:te.gap,overscan:3})})})]}),s.jsx(zc,{isOpen:Qe,onClose:cs,onConfirm:ls,previewUrl:St?.previewUrl||null,fileName:St?.fileName||"",isDownloading:zt}),s.jsx(id,{isOpen:M,onClose:()=>{T(!1),R(null),J(void 0)},onConfirm:fs,parentId:$,initialData:c.useMemo(()=>L?{name:L.name,color:L.color,icon:L.icon}:void 0,[L]),mode:L?"edit":"create"}),s.jsx(dd,{isOpen:U,onClose:()=>{Y(!1),S(null)},onConfirm:Vt,folderName:D?.name||"",cardCount:D?.cardCount||0,hasSubfolders:D?.hasSubfolders||!1,subfolderCount:D?.subfolderCount||0}),s.jsx(md,{isOpen:ue,onClose:()=>{me(!1),Ct("")},onConfirm:gs,tagName:$t,existingTags:w()}),s.jsx(fd,{isOpen:he,onClose:()=>{pe(!1),jt(null)},onConfirm:X,tagName:je?.name||"",cardCount:je?.cardCount||0}),s.jsx(yd,{}),s.jsx(Nd,{isOpen:ge,onClose:()=>z(!1)}),ne&&s.jsx(Ad,{conflictId:ne,onClose:()=>{_(!1),re(null)}})]})})}const Ud={theme:"system",setTheme:()=>null},Vd=c.createContext(Ud);function Wd({children:a,defaultTheme:e="system",storageKey:t="vite-ui-theme",...r}){const[n,o]=c.useState(()=>localStorage.getItem(t)||e);c.useEffect(()=>{const l=window.document.documentElement;if(l.classList.remove("light","dark"),n==="system"){const u=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";l.classList.add(u);return}l.classList.add(n)},[n]);const i={theme:n,setTheme:l=>{localStorage.setItem(t,l),o(l)}};return s.jsx(Vd.Provider,{...r,value:i,children:a})}var Hd=a=>{switch(a){case"success":return Yd;case"info":return Jd;case"warning":return qd;case"error":return Xd;default:return null}},Gd=Array(12).fill(0),Kd=({visible:a,className:e})=>B.createElement("div",{className:["sonner-loading-wrapper",e].filter(Boolean).join(" "),"data-visible":a},B.createElement("div",{className:"sonner-spinner"},Gd.map((t,r)=>B.createElement("div",{className:"sonner-loading-bar",key:`spinner-bar-${r}`})))),Yd=B.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",height:"20",width:"20"},B.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z",clipRule:"evenodd"})),qd=B.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",height:"20",width:"20"},B.createElement("path",{fillRule:"evenodd",d:"M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z",clipRule:"evenodd"})),Jd=B.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",height:"20",width:"20"},B.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z",clipRule:"evenodd"})),Xd=B.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",height:"20",width:"20"},B.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})),Qd=B.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"},B.createElement("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),B.createElement("line",{x1:"6",y1:"6",x2:"18",y2:"18"})),Zd=()=>{let[a,e]=B.useState(document.hidden);return B.useEffect(()=>{let t=()=>{e(document.hidden)};return document.addEventListener("visibilitychange",t),()=>window.removeEventListener("visibilitychange",t)},[]),a},Ms=1,eu=class{constructor(){this.subscribe=a=>(this.subscribers.push(a),()=>{let e=this.subscribers.indexOf(a);this.subscribers.splice(e,1)}),this.publish=a=>{this.subscribers.forEach(e=>e(a))},this.addToast=a=>{this.publish(a),this.toasts=[...this.toasts,a]},this.create=a=>{var e;let{message:t,...r}=a,n=typeof a?.id=="number"||((e=a.id)==null?void 0:e.length)>0?a.id:Ms++,o=this.toasts.find(l=>l.id===n),i=a.dismissible===void 0?!0:a.dismissible;return this.dismissedToasts.has(n)&&this.dismissedToasts.delete(n),o?this.toasts=this.toasts.map(l=>l.id===n?(this.publish({...l,...a,id:n,title:t}),{...l,...a,id:n,dismissible:i,title:t}):l):this.addToast({title:t,...r,dismissible:i,id:n}),n},this.dismiss=a=>(this.dismissedToasts.add(a),a||this.toasts.forEach(e=>{this.subscribers.forEach(t=>t({id:e.id,dismiss:!0}))}),this.subscribers.forEach(e=>e({id:a,dismiss:!0})),a),this.message=(a,e)=>this.create({...e,message:a}),this.error=(a,e)=>this.create({...e,message:a,type:"error"}),this.success=(a,e)=>this.create({...e,type:"success",message:a}),this.info=(a,e)=>this.create({...e,type:"info",message:a}),this.warning=(a,e)=>this.create({...e,type:"warning",message:a}),this.loading=(a,e)=>this.create({...e,type:"loading",message:a}),this.promise=(a,e)=>{if(!e)return;let t;e.loading!==void 0&&(t=this.create({...e,promise:a,type:"loading",message:e.loading,description:typeof e.description!="function"?e.description:void 0}));let r=a instanceof Promise?a:a(),n=t!==void 0,o,i=r.then(async u=>{if(o=["resolve",u],B.isValidElement(u))n=!1,this.create({id:t,type:"default",message:u});else if(su(u)&&!u.ok){n=!1;let m=typeof e.error=="function"?await e.error(`HTTP error! status: ${u.status}`):e.error,d=typeof e.description=="function"?await e.description(`HTTP error! status: ${u.status}`):e.description;this.create({id:t,type:"error",message:m,description:d})}else if(e.success!==void 0){n=!1;let m=typeof e.success=="function"?await e.success(u):e.success,d=typeof e.description=="function"?await e.description(u):e.description;this.create({id:t,type:"success",message:m,description:d})}}).catch(async u=>{if(o=["reject",u],e.error!==void 0){n=!1;let m=typeof e.error=="function"?await e.error(u):e.error,d=typeof e.description=="function"?await e.description(u):e.description;this.create({id:t,type:"error",message:m,description:d})}}).finally(()=>{var u;n&&(this.dismiss(t),t=void 0),(u=e.finally)==null||u.call(e)}),l=()=>new Promise((u,m)=>i.then(()=>o[0]==="reject"?m(o[1]):u(o[1])).catch(m));return typeof t!="string"&&typeof t!="number"?{unwrap:l}:Object.assign(t,{unwrap:l})},this.custom=(a,e)=>{let t=e?.id||Ms++;return this.create({jsx:a(t),id:t,...e}),t},this.getActiveToasts=()=>this.toasts.filter(a=>!this.dismissedToasts.has(a.id)),this.subscribers=[],this.toasts=[],this.dismissedToasts=new Set}},be=new eu,tu=(a,e)=>{let t=e?.id||Ms++;return be.addToast({title:a,...e,id:t}),t},su=a=>a&&typeof a=="object"&&"ok"in a&&typeof a.ok=="boolean"&&"status"in a&&typeof a.status=="number",au=tu,ru=()=>be.toasts,nu=()=>be.getActiveToasts();Object.assign(au,{success:be.success,info:be.info,warning:be.warning,error:be.error,custom:be.custom,message:be.message,promise:be.promise,dismiss:be.dismiss,loading:be.loading},{getHistory:ru,getToasts:nu});function ou(a,{insertAt:e}={}){if(typeof document>"u")return;let t=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css",e==="top"&&t.firstChild?t.insertBefore(r,t.firstChild):t.appendChild(r),r.styleSheet?r.styleSheet.cssText=a:r.appendChild(document.createTextNode(a))}ou(`:where(html[dir="ltr"]),:where([data-sonner-toaster][dir="ltr"]){--toast-icon-margin-start: -3px;--toast-icon-margin-end: 4px;--toast-svg-margin-start: -1px;--toast-svg-margin-end: 0px;--toast-button-margin-start: auto;--toast-button-margin-end: 0;--toast-close-button-start: 0;--toast-close-button-end: unset;--toast-close-button-transform: translate(-35%, -35%)}:where(html[dir="rtl"]),:where([data-sonner-toaster][dir="rtl"]){--toast-icon-margin-start: 4px;--toast-icon-margin-end: -3px;--toast-svg-margin-start: 0px;--toast-svg-margin-end: -1px;--toast-button-margin-start: 0;--toast-button-margin-end: auto;--toast-close-button-start: unset;--toast-close-button-end: 0;--toast-close-button-transform: translate(35%, -35%)}:where([data-sonner-toaster]){position:fixed;width:var(--width);font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;--gray1: hsl(0, 0%, 99%);--gray2: hsl(0, 0%, 97.3%);--gray3: hsl(0, 0%, 95.1%);--gray4: hsl(0, 0%, 93%);--gray5: hsl(0, 0%, 90.9%);--gray6: hsl(0, 0%, 88.7%);--gray7: hsl(0, 0%, 85.8%);--gray8: hsl(0, 0%, 78%);--gray9: hsl(0, 0%, 56.1%);--gray10: hsl(0, 0%, 52.3%);--gray11: hsl(0, 0%, 43.5%);--gray12: hsl(0, 0%, 9%);--border-radius: 8px;box-sizing:border-box;padding:0;margin:0;list-style:none;outline:none;z-index:999999999;transition:transform .4s ease}:where([data-sonner-toaster][data-lifted="true"]){transform:translateY(-10px)}@media (hover: none) and (pointer: coarse){:where([data-sonner-toaster][data-lifted="true"]){transform:none}}:where([data-sonner-toaster][data-x-position="right"]){right:var(--offset-right)}:where([data-sonner-toaster][data-x-position="left"]){left:var(--offset-left)}:where([data-sonner-toaster][data-x-position="center"]){left:50%;transform:translate(-50%)}:where([data-sonner-toaster][data-y-position="top"]){top:var(--offset-top)}:where([data-sonner-toaster][data-y-position="bottom"]){bottom:var(--offset-bottom)}:where([data-sonner-toast]){--y: translateY(100%);--lift-amount: calc(var(--lift) * var(--gap));z-index:var(--z-index);position:absolute;opacity:0;transform:var(--y);filter:blur(0);touch-action:none;transition:transform .4s,opacity .4s,height .4s,box-shadow .2s;box-sizing:border-box;outline:none;overflow-wrap:anywhere}:where([data-sonner-toast][data-styled="true"]){padding:16px;background:var(--normal-bg);border:1px solid var(--normal-border);color:var(--normal-text);border-radius:var(--border-radius);box-shadow:0 4px 12px #0000001a;width:var(--width);font-size:13px;display:flex;align-items:center;gap:6px}:where([data-sonner-toast]:focus-visible){box-shadow:0 4px 12px #0000001a,0 0 0 2px #0003}:where([data-sonner-toast][data-y-position="top"]){top:0;--y: translateY(-100%);--lift: 1;--lift-amount: calc(1 * var(--gap))}:where([data-sonner-toast][data-y-position="bottom"]){bottom:0;--y: translateY(100%);--lift: -1;--lift-amount: calc(var(--lift) * var(--gap))}:where([data-sonner-toast]) :where([data-description]){font-weight:400;line-height:1.4;color:inherit}:where([data-sonner-toast]) :where([data-title]){font-weight:500;line-height:1.5;color:inherit}:where([data-sonner-toast]) :where([data-icon]){display:flex;height:16px;width:16px;position:relative;justify-content:flex-start;align-items:center;flex-shrink:0;margin-left:var(--toast-icon-margin-start);margin-right:var(--toast-icon-margin-end)}:where([data-sonner-toast][data-promise="true"]) :where([data-icon])>svg{opacity:0;transform:scale(.8);transform-origin:center;animation:sonner-fade-in .3s ease forwards}:where([data-sonner-toast]) :where([data-icon])>*{flex-shrink:0}:where([data-sonner-toast]) :where([data-icon]) svg{margin-left:var(--toast-svg-margin-start);margin-right:var(--toast-svg-margin-end)}:where([data-sonner-toast]) :where([data-content]){display:flex;flex-direction:column;gap:2px}[data-sonner-toast][data-styled=true] [data-button]{border-radius:4px;padding-left:8px;padding-right:8px;height:24px;font-size:12px;color:var(--normal-bg);background:var(--normal-text);margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end);border:none;cursor:pointer;outline:none;display:flex;align-items:center;flex-shrink:0;transition:opacity .4s,box-shadow .2s}:where([data-sonner-toast]) :where([data-button]):focus-visible{box-shadow:0 0 0 2px #0006}:where([data-sonner-toast]) :where([data-button]):first-of-type{margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end)}:where([data-sonner-toast]) :where([data-cancel]){color:var(--normal-text);background:rgba(0,0,0,.08)}:where([data-sonner-toast][data-theme="dark"]) :where([data-cancel]){background:rgba(255,255,255,.3)}:where([data-sonner-toast]) :where([data-close-button]){position:absolute;left:var(--toast-close-button-start);right:var(--toast-close-button-end);top:0;height:20px;width:20px;display:flex;justify-content:center;align-items:center;padding:0;color:var(--gray12);border:1px solid var(--gray4);transform:var(--toast-close-button-transform);border-radius:50%;cursor:pointer;z-index:1;transition:opacity .1s,background .2s,border-color .2s}[data-sonner-toast] [data-close-button]{background:var(--gray1)}:where([data-sonner-toast]) :where([data-close-button]):focus-visible{box-shadow:0 4px 12px #0000001a,0 0 0 2px #0003}:where([data-sonner-toast]) :where([data-disabled="true"]){cursor:not-allowed}:where([data-sonner-toast]):hover :where([data-close-button]):hover{background:var(--gray2);border-color:var(--gray5)}:where([data-sonner-toast][data-swiping="true"]):before{content:"";position:absolute;left:-50%;right:-50%;height:100%;z-index:-1}:where([data-sonner-toast][data-y-position="top"][data-swiping="true"]):before{bottom:50%;transform:scaleY(3) translateY(50%)}:where([data-sonner-toast][data-y-position="bottom"][data-swiping="true"]):before{top:50%;transform:scaleY(3) translateY(-50%)}:where([data-sonner-toast][data-swiping="false"][data-removed="true"]):before{content:"";position:absolute;inset:0;transform:scaleY(2)}:where([data-sonner-toast]):after{content:"";position:absolute;left:0;height:calc(var(--gap) + 1px);bottom:100%;width:100%}:where([data-sonner-toast][data-mounted="true"]){--y: translateY(0);opacity:1}:where([data-sonner-toast][data-expanded="false"][data-front="false"]){--scale: var(--toasts-before) * .05 + 1;--y: translateY(calc(var(--lift-amount) * var(--toasts-before))) scale(calc(-1 * var(--scale)));height:var(--front-toast-height)}:where([data-sonner-toast])>*{transition:opacity .4s}:where([data-sonner-toast][data-expanded="false"][data-front="false"][data-styled="true"])>*{opacity:0}:where([data-sonner-toast][data-visible="false"]){opacity:0;pointer-events:none}:where([data-sonner-toast][data-mounted="true"][data-expanded="true"]){--y: translateY(calc(var(--lift) * var(--offset)));height:var(--initial-height)}:where([data-sonner-toast][data-removed="true"][data-front="true"][data-swipe-out="false"]){--y: translateY(calc(var(--lift) * -100%));opacity:0}:where([data-sonner-toast][data-removed="true"][data-front="false"][data-swipe-out="false"][data-expanded="true"]){--y: translateY(calc(var(--lift) * var(--offset) + var(--lift) * -100%));opacity:0}:where([data-sonner-toast][data-removed="true"][data-front="false"][data-swipe-out="false"][data-expanded="false"]){--y: translateY(40%);opacity:0;transition:transform .5s,opacity .2s}:where([data-sonner-toast][data-removed="true"][data-front="false"]):before{height:calc(var(--initial-height) + 20%)}[data-sonner-toast][data-swiping=true]{transform:var(--y) translateY(var(--swipe-amount-y, 0px)) translate(var(--swipe-amount-x, 0px));transition:none}[data-sonner-toast][data-swiped=true]{user-select:none}[data-sonner-toast][data-swipe-out=true][data-y-position=bottom],[data-sonner-toast][data-swipe-out=true][data-y-position=top]{animation-duration:.2s;animation-timing-function:ease-out;animation-fill-mode:forwards}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=left]{animation-name:swipe-out-left}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=right]{animation-name:swipe-out-right}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=up]{animation-name:swipe-out-up}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=down]{animation-name:swipe-out-down}@keyframes swipe-out-left{0%{transform:var(--y) translate(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translate(calc(var(--swipe-amount-x) - 100%));opacity:0}}@keyframes swipe-out-right{0%{transform:var(--y) translate(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translate(calc(var(--swipe-amount-x) + 100%));opacity:0}}@keyframes swipe-out-up{0%{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) - 100%));opacity:0}}@keyframes swipe-out-down{0%{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) + 100%));opacity:0}}@media (max-width: 600px){[data-sonner-toaster]{position:fixed;right:var(--mobile-offset-right);left:var(--mobile-offset-left);width:100%}[data-sonner-toaster][dir=rtl]{left:calc(var(--mobile-offset-left) * -1)}[data-sonner-toaster] [data-sonner-toast]{left:0;right:0;width:calc(100% - var(--mobile-offset-left) * 2)}[data-sonner-toaster][data-x-position=left]{left:var(--mobile-offset-left)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--mobile-offset-bottom)}[data-sonner-toaster][data-y-position=top]{top:var(--mobile-offset-top)}[data-sonner-toaster][data-x-position=center]{left:var(--mobile-offset-left);right:var(--mobile-offset-right);transform:none}}[data-sonner-toaster][data-theme=light]{--normal-bg: #fff;--normal-border: var(--gray4);--normal-text: var(--gray12);--success-bg: hsl(143, 85%, 96%);--success-border: hsl(145, 92%, 91%);--success-text: hsl(140, 100%, 27%);--info-bg: hsl(208, 100%, 97%);--info-border: hsl(221, 91%, 91%);--info-text: hsl(210, 92%, 45%);--warning-bg: hsl(49, 100%, 97%);--warning-border: hsl(49, 91%, 91%);--warning-text: hsl(31, 92%, 45%);--error-bg: hsl(359, 100%, 97%);--error-border: hsl(359, 100%, 94%);--error-text: hsl(360, 100%, 45%)}[data-sonner-toaster][data-theme=light] [data-sonner-toast][data-invert=true]{--normal-bg: #000;--normal-border: hsl(0, 0%, 20%);--normal-text: var(--gray1)}[data-sonner-toaster][data-theme=dark] [data-sonner-toast][data-invert=true]{--normal-bg: #fff;--normal-border: var(--gray3);--normal-text: var(--gray12)}[data-sonner-toaster][data-theme=dark]{--normal-bg: #000;--normal-bg-hover: hsl(0, 0%, 12%);--normal-border: hsl(0, 0%, 20%);--normal-border-hover: hsl(0, 0%, 25%);--normal-text: var(--gray1);--success-bg: hsl(150, 100%, 6%);--success-border: hsl(147, 100%, 12%);--success-text: hsl(150, 86%, 65%);--info-bg: hsl(215, 100%, 6%);--info-border: hsl(223, 100%, 12%);--info-text: hsl(216, 87%, 65%);--warning-bg: hsl(64, 100%, 6%);--warning-border: hsl(60, 100%, 12%);--warning-text: hsl(46, 87%, 65%);--error-bg: hsl(358, 76%, 10%);--error-border: hsl(357, 89%, 16%);--error-text: hsl(358, 100%, 81%)}[data-sonner-toaster][data-theme=dark] [data-sonner-toast] [data-close-button]{background:var(--normal-bg);border-color:var(--normal-border);color:var(--normal-text)}[data-sonner-toaster][data-theme=dark] [data-sonner-toast] [data-close-button]:hover{background:var(--normal-bg-hover);border-color:var(--normal-border-hover)}[data-rich-colors=true][data-sonner-toast][data-type=success],[data-rich-colors=true][data-sonner-toast][data-type=success] [data-close-button]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=info],[data-rich-colors=true][data-sonner-toast][data-type=info] [data-close-button]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning],[data-rich-colors=true][data-sonner-toast][data-type=warning] [data-close-button]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=error],[data-rich-colors=true][data-sonner-toast][data-type=error] [data-close-button]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}.sonner-loading-wrapper{--size: 16px;height:var(--size);width:var(--size);position:absolute;inset:0;z-index:10}.sonner-loading-wrapper[data-visible=false]{transform-origin:center;animation:sonner-fade-out .2s ease forwards}.sonner-spinner{position:relative;top:50%;left:50%;height:var(--size);width:var(--size)}.sonner-loading-bar{animation:sonner-spin 1.2s linear infinite;background:var(--gray11);border-radius:6px;height:8%;left:-10%;position:absolute;top:-3.9%;width:24%}.sonner-loading-bar:nth-child(1){animation-delay:-1.2s;transform:rotate(.0001deg) translate(146%)}.sonner-loading-bar:nth-child(2){animation-delay:-1.1s;transform:rotate(30deg) translate(146%)}.sonner-loading-bar:nth-child(3){animation-delay:-1s;transform:rotate(60deg) translate(146%)}.sonner-loading-bar:nth-child(4){animation-delay:-.9s;transform:rotate(90deg) translate(146%)}.sonner-loading-bar:nth-child(5){animation-delay:-.8s;transform:rotate(120deg) translate(146%)}.sonner-loading-bar:nth-child(6){animation-delay:-.7s;transform:rotate(150deg) translate(146%)}.sonner-loading-bar:nth-child(7){animation-delay:-.6s;transform:rotate(180deg) translate(146%)}.sonner-loading-bar:nth-child(8){animation-delay:-.5s;transform:rotate(210deg) translate(146%)}.sonner-loading-bar:nth-child(9){animation-delay:-.4s;transform:rotate(240deg) translate(146%)}.sonner-loading-bar:nth-child(10){animation-delay:-.3s;transform:rotate(270deg) translate(146%)}.sonner-loading-bar:nth-child(11){animation-delay:-.2s;transform:rotate(300deg) translate(146%)}.sonner-loading-bar:nth-child(12){animation-delay:-.1s;transform:rotate(330deg) translate(146%)}@keyframes sonner-fade-in{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}@keyframes sonner-fade-out{0%{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.8)}}@keyframes sonner-spin{0%{opacity:1}to{opacity:.15}}@media (prefers-reduced-motion){[data-sonner-toast],[data-sonner-toast]>*,.sonner-loading-bar{transition:none!important;animation:none!important}}.sonner-loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transform-origin:center;transition:opacity .2s,transform .2s}.sonner-loader[data-visible=false]{opacity:0;transform:scale(.8) translate(-50%,-50%)}
`);function Ht(a){return a.label!==void 0}var iu=3,lu="32px",cu="16px",ha=4e3,du=356,uu=14,mu=20,fu=200;function Te(...a){return a.filter(Boolean).join(" ")}function gu(a){let[e,t]=a.split("-"),r=[];return e&&r.push(e),t&&r.push(t),r}var hu=a=>{var e,t,r,n,o,i,l,u,m,d,h;let{invert:g,toast:f,unstyled:p,interacting:b,setHeights:C,visibleToasts:v,heights:y,index:x,toasts:j,expanded:N,removeToast:E,defaultRichColors:w,closeButton:k,style:I,cancelButtonStyle:K,actionButtonStyle:O,className:H="",descriptionClassName:te="",duration:W,position:Z,gap:ne,loadingIcon:re,expandByDefault:ge,classNames:z,icons:q,closeButtonAriaLabel:_="Close toast",pauseWhenPageIsHidden:M}=a,[T,U]=B.useState(null),[Y,L]=B.useState(null),[R,D]=B.useState(!1),[S,$]=B.useState(!1),[J,ue]=B.useState(!1),[me,he]=B.useState(!1),[pe,$t]=B.useState(!1),[Ct,je]=B.useState(0),[jt,zt]=B.useState(0),Qe=B.useRef(f.duration||W||ha),St=B.useRef(null),Le=B.useRef(null),ls=x===0,cs=x+1<=v,we=f.type,Ve=f.dismissible!==!1,ds=f.className||"",us=f.descriptionClassName||"",at=B.useMemo(()=>y.findIndex(X=>X.toastId===f.id)||0,[y,f.id]),ms=B.useMemo(()=>{var X;return(X=f.closeButton)!=null?X:k},[f.closeButton,k]),Bt=B.useMemo(()=>f.duration||W||ha,[f.duration,W]),Ze=B.useRef(0),$e=B.useRef(0),Nt=B.useRef(0),ze=B.useRef(null),[Ut,fs]=Z.split("-"),Vt=B.useMemo(()=>y.reduce((X,ae,oe)=>oe>=at?X:X+ae.height,0),[y,at]),Wt=Zd(),rt=f.invert||g,kt=we==="loading";$e.current=B.useMemo(()=>at*ne+Vt,[at,Vt]),B.useEffect(()=>{Qe.current=Bt},[Bt]),B.useEffect(()=>{D(!0)},[]),B.useEffect(()=>{let X=Le.current;if(X){let ae=X.getBoundingClientRect().height;return zt(ae),C(oe=>[{toastId:f.id,height:ae,position:f.position},...oe]),()=>C(oe=>oe.filter(F=>F.toastId!==f.id))}},[C,f.id]),B.useLayoutEffect(()=>{if(!R)return;let X=Le.current,ae=X.style.height;X.style.height="auto";let oe=X.getBoundingClientRect().height;X.style.height=ae,zt(oe),C(F=>F.find(G=>G.toastId===f.id)?F.map(G=>G.toastId===f.id?{...G,height:oe}:G):[{toastId:f.id,height:oe,position:f.position},...F])},[R,f.title,f.description,C,f.id]);let Ie=B.useCallback(()=>{$(!0),je($e.current),C(X=>X.filter(ae=>ae.toastId!==f.id)),setTimeout(()=>{E(f)},fu)},[f,E,C,$e]);B.useEffect(()=>{if(f.promise&&we==="loading"||f.duration===1/0||f.type==="loading")return;let X;return N||b||M&&Wt?(()=>{if(Nt.current<Ze.current){let ae=new Date().getTime()-Ze.current;Qe.current=Qe.current-ae}Nt.current=new Date().getTime()})():Qe.current!==1/0&&(Ze.current=new Date().getTime(),X=setTimeout(()=>{var ae;(ae=f.onAutoClose)==null||ae.call(f,f),Ie()},Qe.current)),()=>clearTimeout(X)},[N,b,f,we,M,Wt,Ie]),B.useEffect(()=>{f.delete&&Ie()},[Ie,f.delete]);function gs(){var X,ae,oe;return q!=null&&q.loading?B.createElement("div",{className:Te(z?.loader,(X=f?.classNames)==null?void 0:X.loader,"sonner-loader"),"data-visible":we==="loading"},q.loading):re?B.createElement("div",{className:Te(z?.loader,(ae=f?.classNames)==null?void 0:ae.loader,"sonner-loader"),"data-visible":we==="loading"},re):B.createElement(Kd,{className:Te(z?.loader,(oe=f?.classNames)==null?void 0:oe.loader),visible:we==="loading"})}return B.createElement("li",{tabIndex:0,ref:Le,className:Te(H,ds,z?.toast,(e=f?.classNames)==null?void 0:e.toast,z?.default,z?.[we],(t=f?.classNames)==null?void 0:t[we]),"data-sonner-toast":"","data-rich-colors":(r=f.richColors)!=null?r:w,"data-styled":!(f.jsx||f.unstyled||p),"data-mounted":R,"data-promise":!!f.promise,"data-swiped":pe,"data-removed":S,"data-visible":cs,"data-y-position":Ut,"data-x-position":fs,"data-index":x,"data-front":ls,"data-swiping":J,"data-dismissible":Ve,"data-type":we,"data-invert":rt,"data-swipe-out":me,"data-swipe-direction":Y,"data-expanded":!!(N||ge&&R),style:{"--index":x,"--toasts-before":x,"--z-index":j.length-x,"--offset":`${S?Ct:$e.current}px`,"--initial-height":ge?"auto":`${jt}px`,...I,...f.style},onDragEnd:()=>{ue(!1),U(null),ze.current=null},onPointerDown:X=>{kt||!Ve||(St.current=new Date,je($e.current),X.target.setPointerCapture(X.pointerId),X.target.tagName!=="BUTTON"&&(ue(!0),ze.current={x:X.clientX,y:X.clientY}))},onPointerUp:()=>{var X,ae,oe,F;if(me||!Ve)return;ze.current=null;let G=Number(((X=Le.current)==null?void 0:X.style.getPropertyValue("--swipe-amount-x").replace("px",""))||0),ee=Number(((ae=Le.current)==null?void 0:ae.style.getPropertyValue("--swipe-amount-y").replace("px",""))||0),xe=new Date().getTime()-((oe=St.current)==null?void 0:oe.getTime()),ye=T==="x"?G:ee,fe=Math.abs(ye)/xe;if(Math.abs(ye)>=mu||fe>.11){je($e.current),(F=f.onDismiss)==null||F.call(f,f),L(T==="x"?G>0?"right":"left":ee>0?"down":"up"),Ie(),he(!0),$t(!1);return}ue(!1),U(null)},onPointerMove:X=>{var ae,oe,F,G;if(!ze.current||!Ve||((ae=window.getSelection())==null?void 0:ae.toString().length)>0)return;let ee=X.clientY-ze.current.y,xe=X.clientX-ze.current.x,ye=(oe=a.swipeDirections)!=null?oe:gu(Z);!T&&(Math.abs(xe)>1||Math.abs(ee)>1)&&U(Math.abs(xe)>Math.abs(ee)?"x":"y");let fe={x:0,y:0};T==="y"?(ye.includes("top")||ye.includes("bottom"))&&(ye.includes("top")&&ee<0||ye.includes("bottom")&&ee>0)&&(fe.y=ee):T==="x"&&(ye.includes("left")||ye.includes("right"))&&(ye.includes("left")&&xe<0||ye.includes("right")&&xe>0)&&(fe.x=xe),(Math.abs(fe.x)>0||Math.abs(fe.y)>0)&&$t(!0),(F=Le.current)==null||F.style.setProperty("--swipe-amount-x",`${fe.x}px`),(G=Le.current)==null||G.style.setProperty("--swipe-amount-y",`${fe.y}px`)}},ms&&!f.jsx?B.createElement("button",{"aria-label":_,"data-disabled":kt,"data-close-button":!0,onClick:kt||!Ve?()=>{}:()=>{var X;Ie(),(X=f.onDismiss)==null||X.call(f,f)},className:Te(z?.closeButton,(n=f?.classNames)==null?void 0:n.closeButton)},(o=q?.close)!=null?o:Qd):null,f.jsx||c.isValidElement(f.title)?f.jsx?f.jsx:typeof f.title=="function"?f.title():f.title:B.createElement(B.Fragment,null,we||f.icon||f.promise?B.createElement("div",{"data-icon":"",className:Te(z?.icon,(i=f?.classNames)==null?void 0:i.icon)},f.promise||f.type==="loading"&&!f.icon?f.icon||gs():null,f.type!=="loading"?f.icon||q?.[we]||Hd(we):null):null,B.createElement("div",{"data-content":"",className:Te(z?.content,(l=f?.classNames)==null?void 0:l.content)},B.createElement("div",{"data-title":"",className:Te(z?.title,(u=f?.classNames)==null?void 0:u.title)},typeof f.title=="function"?f.title():f.title),f.description?B.createElement("div",{"data-description":"",className:Te(te,us,z?.description,(m=f?.classNames)==null?void 0:m.description)},typeof f.description=="function"?f.description():f.description):null),c.isValidElement(f.cancel)?f.cancel:f.cancel&&Ht(f.cancel)?B.createElement("button",{"data-button":!0,"data-cancel":!0,style:f.cancelButtonStyle||K,onClick:X=>{var ae,oe;Ht(f.cancel)&&Ve&&((oe=(ae=f.cancel).onClick)==null||oe.call(ae,X),Ie())},className:Te(z?.cancelButton,(d=f?.classNames)==null?void 0:d.cancelButton)},f.cancel.label):null,c.isValidElement(f.action)?f.action:f.action&&Ht(f.action)?B.createElement("button",{"data-button":!0,"data-action":!0,style:f.actionButtonStyle||O,onClick:X=>{var ae,oe;Ht(f.action)&&((oe=(ae=f.action).onClick)==null||oe.call(ae,X),!X.defaultPrevented&&Ie())},className:Te(z?.actionButton,(h=f?.classNames)==null?void 0:h.actionButton)},f.action.label):null))};function pa(){if(typeof window>"u"||typeof document>"u")return"ltr";let a=document.documentElement.getAttribute("dir");return a==="auto"||!a?window.getComputedStyle(document.documentElement).direction:a}function pu(a,e){let t={};return[a,e].forEach((r,n)=>{let o=n===1,i=o?"--mobile-offset":"--offset",l=o?cu:lu;function u(m){["top","right","bottom","left"].forEach(d=>{t[`${i}-${d}`]=typeof m=="number"?`${m}px`:m})}typeof r=="number"||typeof r=="string"?u(r):typeof r=="object"?["top","right","bottom","left"].forEach(m=>{r[m]===void 0?t[`${i}-${m}`]=l:t[`${i}-${m}`]=typeof r[m]=="number"?`${r[m]}px`:r[m]}):u(l)}),t}var xu=c.forwardRef(function(a,e){let{invert:t,position:r="bottom-right",hotkey:n=["altKey","KeyT"],expand:o,closeButton:i,className:l,offset:u,mobileOffset:m,theme:d="light",richColors:h,duration:g,style:f,visibleToasts:p=iu,toastOptions:b,dir:C=pa(),gap:v=uu,loadingIcon:y,icons:x,containerAriaLabel:j="Notifications",pauseWhenPageIsHidden:N}=a,[E,w]=B.useState([]),k=B.useMemo(()=>Array.from(new Set([r].concat(E.filter(M=>M.position).map(M=>M.position)))),[E,r]),[I,K]=B.useState([]),[O,H]=B.useState(!1),[te,W]=B.useState(!1),[Z,ne]=B.useState(d!=="system"?d:typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),re=B.useRef(null),ge=n.join("+").replace(/Key/g,"").replace(/Digit/g,""),z=B.useRef(null),q=B.useRef(!1),_=B.useCallback(M=>{w(T=>{var U;return(U=T.find(Y=>Y.id===M.id))!=null&&U.delete||be.dismiss(M.id),T.filter(({id:Y})=>Y!==M.id)})},[]);return B.useEffect(()=>be.subscribe(M=>{if(M.dismiss){w(T=>T.map(U=>U.id===M.id?{...U,delete:!0}:U));return}setTimeout(()=>{ro.flushSync(()=>{w(T=>{let U=T.findIndex(Y=>Y.id===M.id);return U!==-1?[...T.slice(0,U),{...T[U],...M},...T.slice(U+1)]:[M,...T]})})})}),[]),B.useEffect(()=>{if(d!=="system"){ne(d);return}if(d==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?ne("dark"):ne("light")),typeof window>"u")return;let M=window.matchMedia("(prefers-color-scheme: dark)");try{M.addEventListener("change",({matches:T})=>{ne(T?"dark":"light")})}catch{M.addListener(({matches:U})=>{try{ne(U?"dark":"light")}catch(Y){console.error(Y)}})}},[d]),B.useEffect(()=>{E.length<=1&&H(!1)},[E]),B.useEffect(()=>{let M=T=>{var U,Y;n.every(L=>T[L]||T.code===L)&&(H(!0),(U=re.current)==null||U.focus()),T.code==="Escape"&&(document.activeElement===re.current||(Y=re.current)!=null&&Y.contains(document.activeElement))&&H(!1)};return document.addEventListener("keydown",M),()=>document.removeEventListener("keydown",M)},[n]),B.useEffect(()=>{if(re.current)return()=>{z.current&&(z.current.focus({preventScroll:!0}),z.current=null,q.current=!1)}},[re.current]),B.createElement("section",{ref:e,"aria-label":`${j} ${ge}`,tabIndex:-1,"aria-live":"polite","aria-relevant":"additions text","aria-atomic":"false",suppressHydrationWarning:!0},k.map((M,T)=>{var U;let[Y,L]=M.split("-");return E.length?B.createElement("ol",{key:M,dir:C==="auto"?pa():C,tabIndex:-1,ref:re,className:l,"data-sonner-toaster":!0,"data-theme":Z,"data-y-position":Y,"data-lifted":O&&E.length>1&&!o,"data-x-position":L,style:{"--front-toast-height":`${((U=I[0])==null?void 0:U.height)||0}px`,"--width":`${du}px`,"--gap":`${v}px`,...f,...pu(u,m)},onBlur:R=>{q.current&&!R.currentTarget.contains(R.relatedTarget)&&(q.current=!1,z.current&&(z.current.focus({preventScroll:!0}),z.current=null))},onFocus:R=>{R.target instanceof HTMLElement&&R.target.dataset.dismissible==="false"||q.current||(q.current=!0,z.current=R.relatedTarget)},onMouseEnter:()=>H(!0),onMouseMove:()=>H(!0),onMouseLeave:()=>{te||H(!1)},onDragEnd:()=>H(!1),onPointerDown:R=>{R.target instanceof HTMLElement&&R.target.dataset.dismissible==="false"||W(!0)},onPointerUp:()=>W(!1)},E.filter(R=>!R.position&&T===0||R.position===M).map((R,D)=>{var S,$;return B.createElement(hu,{key:R.id,icons:x,index:D,toast:R,defaultRichColors:h,duration:(S=b?.duration)!=null?S:g,className:b?.className,descriptionClassName:b?.descriptionClassName,invert:t,visibleToasts:p,closeButton:($=b?.closeButton)!=null?$:i,interacting:te,position:M,style:b?.style,unstyled:b?.unstyled,classNames:b?.classNames,cancelButtonStyle:b?.cancelButtonStyle,actionButtonStyle:b?.actionButtonStyle,removeToast:_,toasts:E.filter(J=>J.position==R.position),heights:I.filter(J=>J.position==R.position),setHeights:K,expandByDefault:o,gap:v,loadingIcon:y,expanded:O,pauseWhenPageIsHidden:N,swipeDirections:a.swipeDirections})})):null}))});const yu=({...a})=>s.jsx(xu,{theme:"light",className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"group-[.toast]:text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...a});function wu({open:a,onOpenChange:e}){const[t,r]=c.useState({user:null,session:null,loading:!1,error:null}),[n,o]=c.useState("main"),[i,l]=c.useState(!1),[u,m]=c.useState({email:"",password:"",confirmPassword:"",name:""}),[d,h]=c.useState({}),[g,f]=c.useState(!1);c.useEffect(()=>Me.onAuthStateChange(r),[]);const p=()=>{m({email:"",password:"",confirmPassword:"",name:""}),h({}),f(!1),l(!1)},b=O=>{const H={};return(O==="email-login"||O==="email-signup"||O==="forgot-password")&&(u.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(u.email)||(H.email="请输入有效的邮箱地址"):H.email="请输入邮箱地址"),(O==="email-login"||O==="email-signup")&&(u.password?u.password.length<6&&(H.password="密码至少需要6个字符"):H.password="请输入密码"),O==="email-signup"&&(u.name||(H.name="请输入姓名"),u.password!==u.confirmPassword&&(H.confirmPassword="两次输入的密码不一致")),h(H),Object.keys(H).length===0},C=async()=>{f(!0);const{error:O}=await Me.signInWithGitHub();O&&console.error("GitHub登录失败:",O),f(!1)},v=async()=>{if(!b("email-login"))return;f(!0);const{error:O}=await Me.signInWithEmail(u.email,u.password);O?h({general:O.message}):(e(!1),p(),o("main")),f(!1)},y=async()=>{if(!b("email-signup"))return;f(!0);const{error:O}=await Me.signUpWithEmail(u.email,u.password,{name:u.name});O?h({general:O.message}):o("check-email"),f(!1)},x=async()=>{if(!b("forgot-password"))return;f(!0);const{error:O}=await Me.resetPassword(u.email);O?h({general:O.message}):o("check-email"),f(!1)},j=async()=>{const{error:O}=await Me.signOut();O&&console.error("登出失败:",O)},N=async()=>{await no.performFullSync()};if(t.user)return s.jsx(tt,{open:a,onOpenChange:e,children:s.jsx(Je,{className:"sm:max-w-md border-0 shadow-2xl",children:s.jsxs("div",{className:"space-y-6 p-2",children:[s.jsx(ie,{className:"border-0 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/20 dark:to-indigo-950/20",children:s.jsx(le,{className:"p-6",children:s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsxs("div",{className:"relative",children:[s.jsx(rn,{user:t.user,size:"lg",className:"h-16 w-16 shadow-lg",showHoverEffect:!1}),s.jsx("div",{className:"absolute -bottom-1 -right-1 h-5 w-5 bg-green-500 rounded-full border-2 border-white"})]}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{className:"font-semibold text-lg",children:t.user.username||"用户"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:t.user.email}),s.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[s.jsx(Ke,{className:"h-3 w-3 text-green-500"}),s.jsx("span",{className:"text-xs text-green-600",children:"云端同步已启用"})]})]})]})})}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs(P,{onClick:N,variant:"outline",className:"w-full h-12 rounded-2xl border-2 hover:bg-blue-50 transition-all duration-200",disabled:t.loading,children:[t.loading?s.jsx(Et,{className:"h-5 w-5 mr-2 animate-spin"}):s.jsx(Ke,{className:"h-5 w-5 mr-2 text-blue-500"}),"立即同步数据"]}),s.jsx(P,{onClick:j,variant:"ghost",className:"w-full h-12 rounded-2xl hover:bg-red-50 hover:text-red-600 transition-all duration-200",disabled:t.loading,children:"退出登录"})]})]})})});const E=()=>s.jsxs("div",{className:"space-y-6 p-2",children:[s.jsxs("div",{className:"text-center space-y-2",children:[s.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent",children:"欢迎使用 CardAll"}),s.jsx("p",{className:"text-muted-foreground",children:"选择您的登录方式"})]}),s.jsxs(P,{onClick:C,disabled:g,className:"w-full h-14 rounded-2xl bg-gray-900 hover:bg-gray-800 text-white shadow-lg transition-all duration-200 transform hover:scale-[1.02]",size:"lg",children:[g?s.jsx(Et,{className:"h-5 w-5 mr-3 animate-spin"}):s.jsx(Mo,{className:"h-5 w-5 mr-3"}),"使用 GitHub 登录"]}),s.jsxs("div",{className:"relative",children:[s.jsx("div",{className:"absolute inset-0 flex items-center",children:s.jsx("span",{className:"w-full border-t border-gray-200"})}),s.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:s.jsx("span",{className:"bg-background px-4 text-muted-foreground",children:"或"})})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs(P,{onClick:()=>o("email-login"),variant:"outline",className:"w-full h-14 rounded-2xl border-2 hover:bg-blue-50 transition-all duration-200 transform hover:scale-[1.02]",size:"lg",children:[s.jsx(Dt,{className:"h-5 w-5 mr-3 text-blue-500"}),"使用邮箱登录"]}),s.jsxs(P,{onClick:()=>o("email-signup"),variant:"ghost",className:"w-full h-12 rounded-2xl hover:bg-green-50 hover:text-green-600 transition-all duration-200",children:[s.jsx(Qs,{className:"h-4 w-4 mr-2"}),"创建新账户"]})]}),s.jsxs("div",{className:"text-xs text-muted-foreground text-center space-y-1 pt-4",children:[s.jsx("p",{children:"登录后可享受云端同步功能"}),s.jsx("p",{children:"即使不登录也可正常使用本地功能"})]})]}),w=()=>s.jsxs("div",{className:"space-y-6 p-2",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(P,{variant:"ghost",size:"sm",onClick:()=>o("main"),className:"rounded-full p-2",children:s.jsx(hs,{className:"h-4 w-4"})}),s.jsx("h2",{className:"text-xl font-semibold",children:"邮箱登录"})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"email",children:"邮箱地址"}),s.jsxs("div",{className:"relative",children:[s.jsx(Dt,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"email",type:"email",placeholder:"输入您的邮箱地址",value:u.email,onChange:O=>m(H=>({...H,email:O.target.value})),className:"pl-10 h-12 rounded-2xl border-2"})]}),d.email&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),d.email]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"password",children:"密码"}),s.jsxs("div",{className:"relative",children:[s.jsx(ps,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"password",type:i?"text":"password",placeholder:"输入您的密码",value:u.password,onChange:O=>m(H=>({...H,password:O.target.value})),className:"pl-10 pr-10 h-12 rounded-2xl border-2"}),s.jsx(P,{type:"button",variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-10 w-10 rounded-xl",onClick:()=>l(!i),children:i?s.jsx(Rs,{className:"h-4 w-4"}):s.jsx(Jt,{className:"h-4 w-4"})})]}),d.password&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),d.password]})]}),s.jsx("div",{className:"text-right",children:s.jsx(P,{variant:"link",size:"sm",onClick:()=>o("forgot-password"),className:"text-blue-600 hover:text-blue-700 p-0 h-auto",children:"忘记密码？"})}),d.general&&s.jsxs("div",{className:"text-sm text-red-500 text-center bg-red-50 p-3 rounded-2xl flex items-center justify-center gap-2",children:[s.jsx(Se,{className:"h-4 w-4"}),d.general]}),s.jsxs(P,{onClick:v,disabled:g,className:"w-full h-12 rounded-2xl bg-blue-600 hover:bg-blue-700 transition-all duration-200",children:[g?s.jsx(Et,{className:"h-4 w-4 mr-2 animate-spin"}):null,"登录"]})]})]}),k=()=>s.jsxs("div",{className:"space-y-6 p-2",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(P,{variant:"ghost",size:"sm",onClick:()=>o("main"),className:"rounded-full p-2",children:s.jsx(hs,{className:"h-4 w-4"})}),s.jsx("h2",{className:"text-xl font-semibold",children:"创建账户"})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"name",children:"姓名"}),s.jsxs("div",{className:"relative",children:[s.jsx(Qs,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"name",type:"text",placeholder:"输入您的姓名",value:u.name,onChange:O=>m(H=>({...H,name:O.target.value})),className:"pl-10 h-12 rounded-2xl border-2"})]}),d.name&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),d.name]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"signup-email",children:"邮箱地址"}),s.jsxs("div",{className:"relative",children:[s.jsx(Dt,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"signup-email",type:"email",placeholder:"输入您的邮箱地址",value:u.email,onChange:O=>m(H=>({...H,email:O.target.value})),className:"pl-10 h-12 rounded-2xl border-2"})]}),d.email&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),d.email]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"signup-password",children:"密码"}),s.jsxs("div",{className:"relative",children:[s.jsx(ps,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"signup-password",type:i?"text":"password",placeholder:"设置您的密码（至少6个字符）",value:u.password,onChange:O=>m(H=>({...H,password:O.target.value})),className:"pl-10 pr-10 h-12 rounded-2xl border-2"}),s.jsx(P,{type:"button",variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-10 w-10 rounded-xl",onClick:()=>l(!i),children:i?s.jsx(Rs,{className:"h-4 w-4"}):s.jsx(Jt,{className:"h-4 w-4"})})]}),d.password&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),d.password]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"confirm-password",children:"确认密码"}),s.jsxs("div",{className:"relative",children:[s.jsx(ps,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"confirm-password",type:i?"text":"password",placeholder:"再次输入密码",value:u.confirmPassword,onChange:O=>m(H=>({...H,confirmPassword:O.target.value})),className:"pl-10 h-12 rounded-2xl border-2"})]}),d.confirmPassword&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),d.confirmPassword]})]}),d.general&&s.jsxs("div",{className:"text-sm text-red-500 text-center bg-red-50 p-3 rounded-2xl flex items-center justify-center gap-2",children:[s.jsx(Se,{className:"h-4 w-4"}),d.general]}),s.jsxs(P,{onClick:y,disabled:g,className:"w-full h-12 rounded-2xl bg-green-600 hover:bg-green-700 transition-all duration-200",children:[g?s.jsx(Et,{className:"h-4 w-4 mr-2 animate-spin"}):null,"创建账户"]}),s.jsx("div",{className:"text-xs text-muted-foreground text-center",children:s.jsx("p",{children:"注册即表示您同意我们的服务条款和隐私政策"})})]})]}),I=()=>s.jsxs("div",{className:"space-y-6 p-2",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(P,{variant:"ghost",size:"sm",onClick:()=>o("email-login"),className:"rounded-full p-2",children:s.jsx(hs,{className:"h-4 w-4"})}),s.jsx("h2",{className:"text-xl font-semibold",children:"重置密码"})]}),s.jsx("div",{className:"text-center space-y-2",children:s.jsx("p",{className:"text-muted-foreground",children:"输入您的邮箱地址，我们将发送重置密码的链接"})}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"reset-email",children:"邮箱地址"}),s.jsxs("div",{className:"relative",children:[s.jsx(Dt,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"reset-email",type:"email",placeholder:"输入您的邮箱地址",value:u.email,onChange:O=>m(H=>({...H,email:O.target.value})),className:"pl-10 h-12 rounded-2xl border-2"})]}),d.email&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),d.email]})]}),d.general&&s.jsxs("div",{className:"text-sm text-red-500 text-center bg-red-50 p-3 rounded-2xl flex items-center justify-center gap-2",children:[s.jsx(Se,{className:"h-4 w-4"}),d.general]}),s.jsxs(P,{onClick:x,disabled:g,className:"w-full h-12 rounded-2xl bg-blue-600 hover:bg-blue-700 transition-all duration-200",children:[g?s.jsx(Et,{className:"h-4 w-4 mr-2 animate-spin"}):null,"发送重置链接"]})]})]}),K=()=>s.jsxs("div",{className:"space-y-6 p-2 text-center",children:[s.jsx("div",{className:"flex justify-center",children:s.jsx("div",{className:"h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center",children:s.jsx(Dt,{className:"h-8 w-8 text-blue-600"})})}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h2",{className:"text-xl font-semibold",children:"检查您的邮箱"}),s.jsxs("p",{className:"text-muted-foreground",children:["我们已向 ",s.jsx("span",{className:"font-medium",children:u.email})," 发送了一封邮件"]}),s.jsxs("p",{className:"text-sm text-muted-foreground",children:["请点击邮件中的链接来完成",n==="check-email"?"账户激活":"密码重置"]})]}),s.jsx(P,{onClick:()=>{o("main"),p()},variant:"outline",className:"w-full h-12 rounded-2xl border-2",children:"返回登录"})]});return s.jsx(tt,{open:a,onOpenChange:O=>{e(O),O||(o("main"),p())},children:s.jsxs(Je,{className:"sm:max-w-md border-0 shadow-2xl rounded-3xl",children:[n==="main"&&E(),n==="email-login"&&w(),n==="email-signup"&&k(),n==="forgot-password"&&I(),n==="check-email"&&K()]})})}const bu=({onClose:a})=>{const[e,t]=c.useState(null),[r,n]=c.useState(!1),[o,i]=c.useState(!1),[l,u]=c.useState(navigator.onLine);c.useEffect(()=>{const h=()=>{window.matchMedia("(display-mode: standalone)").matches&&i(!0)},g=C=>{C.preventDefault(),t(C),setTimeout(()=>{o||n(!0)},3e3)},f=()=>{i(!0),n(!1),t(null),console.log("PWA was installed")},p=()=>u(!0),b=()=>u(!1);return h(),window.addEventListener("beforeinstallprompt",g),window.addEventListener("appinstalled",f),window.addEventListener("online",p),window.addEventListener("offline",b),()=>{window.removeEventListener("beforeinstallprompt",g),window.removeEventListener("appinstalled",f),window.removeEventListener("online",p),window.removeEventListener("offline",b)}},[o]);const m=async()=>{if(e)try{await e.prompt();const{outcome:h}=await e.userChoice;console.log(h==="accepted"?"User accepted the install prompt":"User dismissed the install prompt"),t(null),n(!1)}catch(h){console.error("Error during installation:",h)}},d=()=>{n(!1),a?.()};return!r||o?null:s.jsx("div",{className:"fixed bottom-4 right-4 z-50 max-w-sm",children:s.jsxs(ie,{className:"shadow-lg border-2 border-blue-200 bg-gradient-to-br from-blue-50 to-white",children:[s.jsxs(Oe,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ft,{className:"h-5 w-5 text-blue-600"}),s.jsx(Fe,{className:"text-lg",children:"安装 CardAll"})]}),s.jsx(P,{variant:"ghost",size:"sm",onClick:d,className:"h-6 w-6 p-0",children:s.jsx(st,{className:"h-4 w-4"})})]}),s.jsx(jn,{children:"将 CardAll 安装到您的设备上，享受更好的体验"})]}),s.jsxs(le,{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[s.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[l?s.jsx(ts,{className:"h-4 w-4"}):s.jsx(Ls,{className:"h-4 w-4"}),s.jsx("span",{children:l?"在线使用":"离线可用"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-blue-600",children:[s.jsx(Oo,{className:"h-4 w-4"}),s.jsx("span",{children:"移动优化"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-purple-600",children:[s.jsx(Fo,{className:"h-4 w-4"}),s.jsx("span",{children:"桌面应用"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-orange-600",children:[s.jsx(ft,{className:"h-4 w-4"}),s.jsx("span",{children:"快速启动"})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h4",{className:"font-medium text-sm",children:"安装后您将获得："}),s.jsxs("ul",{className:"text-xs text-gray-600 space-y-1",children:[s.jsx("li",{children:"• 完全离线功能"}),s.jsx("li",{children:"• 更快的加载速度"}),s.jsx("li",{children:"• 桌面快捷方式"}),s.jsx("li",{children:"• 推送通知支持"})]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(P,{onClick:m,className:"flex-1 bg-blue-600 hover:bg-blue-700",disabled:!e,children:[s.jsx(ft,{className:"h-4 w-4 mr-2"}),"立即安装"]}),s.jsx(P,{variant:"outline",onClick:d,className:"px-3",children:"稍后"})]})]})]})})};function vu({initializationError:a}){const{isOpen:e,closeModal:t}=Nr();return s.jsxs("div",{className:"min-h-screen bg-background",children:[a&&s.jsx("div",{className:"border-b bg-destructive/5",children:s.jsx("div",{className:"container mx-auto px-4 py-2",children:s.jsxs(et,{variant:"destructive",className:"mb-0",children:[s.jsx(Ee,{className:"h-4 w-4"}),s.jsx(xt,{children:a})]})})}),s.jsx(fi,{children:s.jsx(rl,{children:s.jsx(nl,{children:s.jsx(Bd,{})})})}),s.jsx(bu,{}),s.jsx(wu,{open:e,onOpenChange:t}),s.jsx(yu,{})]})}function xa({initializationError:a}){return s.jsx(Wd,{defaultTheme:"light",storageKey:"cardall-theme",children:s.jsx(hi,{children:s.jsx(vu,{initializationError:a})})})}class Cu{async hasLegacyData(){const e=!!localStorage.getItem("cardall-cards"),t=!!localStorage.getItem("cardall-folders"),r=!!localStorage.getItem("cardall-tags");return e||t||r}async migrateFromLocalStorage(){const e={success:!1,migratedCards:0,migratedFolders:0,migratedTags:0,migratedImages:0,errors:[]};try{console.log("Starting migration from localStorage...");const t=await this.migrateFolders();e.migratedFolders=t.length;const r=await this.migrateTags();e.migratedTags=r.length;const{cards:n,images:o}=await this.migrateCards();e.migratedCards=n.length,e.migratedImages=o,e.success=!0,console.log("Migration completed successfully:",e),await this.backupLegacyData()}catch(t){console.error("Migration failed:",t),e.errors.push(t instanceof Error?t.message:"Unknown error")}return e}async migrateFolders(){const e=localStorage.getItem("cardall-folders");if(!e)return[];try{const r=JSON.parse(e).map(n=>({...n,syncVersion:1,pendingSync:!0}));return await V.folders.bulkAdd(r),console.log(`Migrated ${r.length} folders`),r}catch(t){throw console.error("Failed to migrate folders:",t),t}}async migrateTags(){const e=localStorage.getItem("cardall-tags");if(!e)return[];try{const r=JSON.parse(e).map(n=>({...n,syncVersion:1,pendingSync:!0}));return await V.tags.bulkAdd(r),console.log(`Migrated ${r.length} tags`),r}catch(t){throw console.error("Failed to migrate tags:",t),t}}async migrateCards(){const e=localStorage.getItem("cardall-cards");if(!e)return{cards:[],images:0};try{const t=JSON.parse(e),r=[];let n=0;for(const o of t){const i=await this.migrateCardImages(o.frontContent.images,o.id,o.folderId),l=await this.migrateCardImages(o.backContent.images,o.id,o.folderId);n+=i.length+l.length;const u={...o,frontContent:{...o.frontContent,images:i},backContent:{...o.backContent,images:l},syncVersion:1,pendingSync:!0};r.push(u)}return await V.cards.bulkAdd(r),console.log(`Migrated ${r.length} cards with ${n} images`),{cards:r,images:n}}catch(t){throw console.error("Failed to migrate cards:",t),t}}async migrateCardImages(e,t,r){const n=[];for(const o of e)try{if(o.url&&o.url.startsWith("data:")){const i=await this.base64ToBlob(o.url),l=new File([i],o.alt||"migrated-image.jpg",{type:i.type}),u=await gt.saveImage(l,t,r);n.push({id:u.id,url:u.filePath,alt:o.alt,width:u.metadata.width,height:u.metadata.height,position:o.position,size:o.size,aspectRatio:u.metadata.width/u.metadata.height})}else n.push(o)}catch(i){console.error("Failed to migrate image:",i),n.push(o)}return n}async base64ToBlob(e){return(await fetch(e)).blob()}async backupLegacyData(){const e={cards:localStorage.getItem("cardall-cards"),folders:localStorage.getItem("cardall-folders"),tags:localStorage.getItem("cardall-tags"),hiddenTags:localStorage.getItem("cardall-hidden-tags"),timestamp:new Date().toISOString()};await V.settings.add({key:"legacy_backup",value:e,updatedAt:new Date}),console.log("Legacy data backed up successfully")}async cleanupLegacyData(){["cardall-cards","cardall-folders","cardall-tags","cardall-hidden-tags"].forEach(t=>localStorage.removeItem(t)),console.log("Legacy localStorage data cleaned up")}async restoreFromBackup(){try{const e=await V.settings.where("key").equals("legacy_backup").first();if(!e)return console.log("No backup data found"),!1;const t=e.value;return t.cards&&localStorage.setItem("cardall-cards",t.cards),t.folders&&localStorage.setItem("cardall-folders",t.folders),t.tags&&localStorage.setItem("cardall-tags",t.tags),t.hiddenTags&&localStorage.setItem("cardall-hidden-tags",t.hiddenTags),console.log("Backup data restored to localStorage"),!0}catch(e){return console.error("Failed to restore backup:",e),!1}}async getMigrationStatus(){const e=await this.hasLegacyData(),t=await V.getStats(),r=t.cards>0||t.folders>0||t.tags>0;return{hasLegacyData:e,hasMigratedData:r,migrationNeeded:e&&!r}}}const ks=new Cu;class ju{listeners=[];onStatusChange(e){return this.listeners.push(e),()=>{const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}}updateStatus(e){this.listeners.forEach(t=>t(e))}async initialize(){const e={success:!1,fileSystemAccess:!1};try{if(this.updateStatus({step:"database",progress:10,message:"正在初始化数据库...",isComplete:!1,hasError:!1}),await oo(),this.updateStatus({step:"migration-check",progress:25,message:"检查数据迁移需求...",isComplete:!1,hasError:!1}),(await ks.getMigrationStatus()).migrationNeeded&&(this.updateStatus({step:"migration",progress:40,message:"正在迁移现有数据...",isComplete:!1,hasError:!1}),e.migrationResult=await ks.migrateFromLocalStorage(),!e.migrationResult.success))throw new Error(`数据迁移失败: ${e.migrationResult.errors.join(", ")}`);if(this.updateStatus({step:"filesystem",progress:60,message:"请求文件系统访问权限...",isComplete:!1,hasError:!1}),gt.isFileSystemAccessSupported())try{e.fileSystemAccess=await gt.requestDirectoryAccess(),e.fileSystemAccess||console.warn("用户未授予文件系统访问权限，将使用降级存储")}catch(r){console.warn("文件系统访问请求失败，使用降级存储:",r),e.fileSystemAccess=!1}else console.info("浏览器不支持File System Access API，使用降级存储"),e.fileSystemAccess=!1;this.updateStatus({step:"sync",progress:80,message:"初始化同步服务...",isComplete:!1,hasError:!1}),Ae.setAuthService(Me),Me.isAuthenticated()&&await Ae.performFullSync(),this.updateStatus({step:"complete",progress:100,message:"应用初始化完成",isComplete:!0,hasError:!1}),e.success=!0,console.log("应用初始化成功:",e)}catch(t){console.error("应用初始化失败:",t),this.updateStatus({step:"error",progress:0,message:`初始化失败: ${t instanceof Error?t.message:"未知错误"}`,isComplete:!1,hasError:!0,error:t instanceof Error?t.message:"未知错误"}),e.success=!1,e.error=t instanceof Error?t.message:"未知错误"}return e}async reinitialize(){return console.log("重新初始化应用..."),this.initialize()}async checkInitializationStatus(){try{const e=await ks.getMigrationStatus();return{databaseReady:!0,syncServiceReady:Ae.getCurrentStatus()!==null,fileSystemAccess:gt.isFileSystemAccessSupported(),migrationNeeded:e.migrationNeeded}}catch(e){return console.error("检查初始化状态失败:",e),{databaseReady:!1,syncServiceReady:!1,fileSystemAccess:!1,migrationNeeded:!1}}}}const ya=new ju;function Su({onInitialized:a,onError:e,onSkipInitialization:t}){const[r,n]=c.useState({step:"starting",progress:0,message:"准备初始化...",isComplete:!1,hasError:!1}),[o,i]=c.useState(!1),[l,u]=c.useState(null),m=async()=>{i(!0),u(null);try{const g=await ya.initialize();u(g),g.success&&setTimeout(()=>{a(g)},1e3)}catch(g){console.error("初始化过程出错:",g),e&&e(g instanceof Error?g.message:"初始化失败")}finally{i(!1)}};c.useEffect(()=>ya.onStatusChange(n),[]),c.useEffect(()=>{m()},[]);const d=(g,f,p)=>f?s.jsx(Se,{className:"h-5 w-5 text-destructive"}):p?s.jsx(Ke,{className:"h-5 w-5 text-green-500"}):s.jsx(De,{className:"h-5 w-5 animate-spin text-blue-500"}),h=g=>({database:"初始化本地数据库，设置数据存储结构","migration-check":"检查是否有需要从localStorage迁移的数据",migration:"将现有数据迁移到新的数据库结构",filesystem:"请求文件系统访问权限以支持本地文件存储",sync:"初始化同步服务，准备离线和在线数据同步",complete:"所有组件初始化完成，应用准备就绪"})[g]||"正在处理...";return s.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4",children:s.jsxs(ie,{className:"w-full max-w-md",children:[s.jsx(Oe,{className:"text-center",children:s.jsxs(Fe,{className:"flex items-center justify-center gap-2",children:[s.jsx(qt,{className:"h-6 w-6 text-blue-600"}),"CardAll 初始化"]})}),s.jsxs(le,{className:"space-y-6",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{children:"初始化进度"}),s.jsxs("span",{children:[r.progress,"%"]})]}),s.jsx(He,{value:r.progress,className:"h-2"})]}),s.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted rounded-lg",children:[d(r.step,r.hasError,r.isComplete),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-medium",children:r.message}),s.jsx("div",{className:"text-sm text-muted-foreground",children:h(r.step)})]})]}),r.hasError&&r.error&&s.jsxs(et,{variant:"destructive",children:[s.jsx(Se,{className:"h-4 w-4"}),s.jsx(xt,{children:r.error})]}),l?.migrationResult&&s.jsxs(et,{children:[s.jsx(Ke,{className:"h-4 w-4"}),s.jsxs(xt,{children:["数据迁移完成: ",l.migrationResult.migratedCards," 张卡片, "," ",l.migrationResult.migratedFolders," 个文件夹, "," ",l.migrationResult.migratedTags," 个标签, "," ",l.migrationResult.migratedImages," 张图片"]})]}),l&&s.jsxs(et,{variant:l.fileSystemAccess?"default":"destructive",children:[s.jsx(qt,{className:"h-4 w-4"}),s.jsx(xt,{children:l.fileSystemAccess?"文件系统访问权限已获得，支持本地文件存储":"未获得文件系统访问权限，将使用浏览器内置存储"})]}),s.jsxs("div",{className:"flex gap-2",children:[r.hasError&&s.jsxs(s.Fragment,{children:[s.jsx(P,{onClick:m,disabled:o,className:"flex-1",children:o?s.jsxs(s.Fragment,{children:[s.jsx(De,{className:"h-4 w-4 mr-2 animate-spin"}),"重试中..."]}):"重试初始化"}),t&&s.jsx(P,{onClick:t,variant:"outline",className:"flex-1",children:"跳过初始化"})]}),l?.success&&s.jsxs(P,{onClick:()=>a(l),className:"flex-1",children:[s.jsx(Ke,{className:"h-4 w-4 mr-2"}),"进入应用"]})]}),s.jsxs("div",{className:"text-xs text-muted-foreground text-center space-y-1",children:[s.jsx("p",{children:"首次启动需要初始化数据库和同步服务"}),s.jsx("p",{children:"如果有现有数据，将自动迁移到新的存储结构"})]})]})]})})}function Nu(){const[a,e]=c.useState({isInitialized:!1,hasError:!1,canSkip:!1}),t=o=>{console.log("应用初始化完成:",o),e({isInitialized:!0,hasError:!1,canSkip:!1})},r=o=>{console.error("应用初始化失败:",o),e(i=>({...i,hasError:!0,error:o,canSkip:!0}))},n=()=>{console.warn("用户选择跳过初始化，应用将以降级模式运行"),e({isInitialized:!0,hasError:!0,canSkip:!1,error:"应用以降级模式运行，某些功能可能不可用"})};return!a.isInitialized||a.hasError&&!a.canSkip?s.jsx(Su,{onInitialized:t,onError:r,onSkipInitialization:a.canSkip?n:void 0}):a.hasError?s.jsx(xa,{initializationError:a.error}):s.jsx(xa,{})}Ts.createRoot(document.getElementById("root")).render(s.jsx(B.StrictMode,{children:s.jsx(Nu,{})}));
