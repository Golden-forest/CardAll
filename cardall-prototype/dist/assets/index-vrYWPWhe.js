const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/sync-DTvATBjT.js","assets/supabase-BJjf9Ixn.js","assets/vendor-DBpFvjuy.js","assets/database-Ddn5sgg-.js"])))=>i.map(i=>d[i]);
import{j as s,S as Tn,a as va,b as Ca,P as An,C as ja,I as Sa,c as Na,d as ka,R as Ea,L as Da,e as Ra,f as In,T as _n,g as Ta,V as Mn,h as Fn,i as Aa,k as On,O as Ia,l as Pn,m as _a,n as Ln,o as Ma,D as Fa,p as $n,q as Oa,r as zn,s as Bn,t as Un,u as Pa,v as La,w as Vn,x as $a,y as Wn,z as Hn,A as za,B as Ba,F as Ua,E as Va,G as Wa,H as Gn,J as Ha,K as Ga,M as Ka,N as Ya,Q as qa,U as Ja,W as Xa,X as Kn,Y as Yn,Z as Qa,_ as qn,$ as Za,a0 as er,a1 as Jn,a2 as tr,a3 as Xn,a4 as sr,a5 as ar,a6 as Qn,a7 as Zn,a8 as rr,a9 as eo,aa as to,ab as nr,ac as so,ad as or,ae as ir,af as lr,ag as cr,ah as dr,ai as ao,aj as ur,ak as ro,al as mr,am as fr,an as gr,ao as no}from"./radix-w2nuJgPN.js";import{a as Qt,r as d,R as V,v as oo}from"./vendor-DBpFvjuy.js";import{_ as Ps}from"./supabase-BJjf9Ixn.js";import{d as P,u as Ie,a as Ee,b as hs,c as de,e as io,i as lo}from"./sync-DTvATBjT.js";import{t as co,c as uo,a as Zt}from"./utils--BulIq_u.js";import{C as es,a as qe,b as hr,S as mo,I as pr,X as at,c as fo,E as go,P as ho,d as po,e as Rs,f as xo,g as xr,T as yr,F as qt,h as Ls,i as Ge,H as Js,j as ft,D as gt,k as Xs,l as wr,m as Ts,n as $s,o as yo,p as wo,B as bo,q as vo,r as Co,Z as br,s as jo,L as So,t as No,u as De,v as Se,w as Gt,x as Qs,R as Re,y as vr,z as ko,A as Eo,G as Ke,J as _t,K as Mt,W as zs,M as ts,N as Do,O as Ro,Q as To,U as Jt,V as As,Y as Ao,_ as Zs,$ as Io,a0 as _o,a1 as Mo,a2 as Fo,a3 as Et,a4 as Oo,a5 as Dt,a6 as ea,a7 as ps,a8 as xs,a9 as Po,aa as Lo}from"./icons-DKLFDR3M.js";import{u as $o,i as zo,M as Bo,a as Uo,b as Vo,c as Wo,d as Ho,e as Go,f as Ko,g as Yo,h as qo,j as Jo,E as Xo}from"./editor-yCnBQ_u8.js";import"./database-Ddn5sgg-.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();var Is={},ta=Qt;Is.createRoot=ta.createRoot,Is.hydrateRoot=ta.hydrateRoot;class Rt{static PREFIX="cardall_";static VERSION="1.0";static setItem(e,t,r={}){try{const n=this.PREFIX+e,o={version:this.VERSION,timestamp:Date.now(),data:t,meta:{ttl:r.ttl,encrypted:r.encrypt||!1,compressed:r.compress||!1}};if(r.validate){const l=this.validateData(t);if(!l.isValid)return console.warn("Storage validation failed:",l.errors),!1}let i;try{i=this.serializeData(o)}catch(l){return console.error("Data serialization failed:",l),!1}return r.encrypt&&(i=this.encryptData(i)),r.compress&&(i=this.compressData(i)),localStorage.setItem(n,i),!0}catch(n){return console.error("Failed to store data securely:",n),!1}}static getItem(e,t={}){try{const r=this.PREFIX+e,n=localStorage.getItem(r);if(!n)return null;let o=n;t.compress&&(o=this.decompressData(o)),t.encrypt&&(o=this.decryptData(o));const i=this.deserializeData(o);if(i.version!==this.VERSION)return console.warn("Storage data version mismatch"),null;if(i.meta.ttl&&Date.now()-i.timestamp>i.meta.ttl)return console.log("Storage data expired, removing"),this.removeItem(e),null;if(t.validate){const l=this.validateData(i.data);if(!l.isValid)return console.warn("Retrieved data validation failed:",l.errors),null}return i.data}catch(r){return console.error("Failed to retrieve data securely:",r),null}}static removeItem(e){try{const t=this.PREFIX+e;localStorage.removeItem(t)}catch(t){console.error("Failed to remove storage item:",t)}}static clearAppData(){try{Object.keys(localStorage).forEach(t=>{t.startsWith(this.PREFIX)&&localStorage.removeItem(t)})}catch(e){console.error("Failed to clear app data:",e)}}static validateData(e){const t={isValid:!0,errors:[],warnings:[],sanitized:e};return e==null?t:this.hasPrototypePollution(e)?(t.isValid=!1,t.errors.push("Potential prototype pollution detected"),t):(this.hasCircularReference(e)&&(t.warnings.push("Circular reference detected in data"),t.sanitized=this.removeCircularReferences(e)),this.hasDangerousFunctions(e)?(t.isValid=!1,t.errors.push("Dangerous functions detected in data"),t):(this.estimateDataSize(e)>5*1024*1024&&t.warnings.push("Large data size may impact performance"),t))}static hasPrototypePollution(e){if(typeof e!="object"||e===null)return!1;const t=e;return["__proto__","constructor","prototype"].some(n=>n in t)}static hasCircularReference(e,t=new WeakSet){return typeof e!="object"||e===null?!1:t.has(e)?!0:(t.add(e),Array.isArray(e)?e.some(r=>this.hasCircularReference(r,t)):Object.values(e).some(r=>typeof r=="object"&&this.hasCircularReference(r,t)))}static removeCircularReferences(e,t=new WeakSet){if(typeof e!="object"||e===null)return e;if(t.has(e))return"[Circular]";if(t.add(e),Array.isArray(e))return e.map(n=>this.removeCircularReferences(n,t));const r={};for(const[n,o]of Object.entries(e))r[n]=this.removeCircularReferences(o,t);return r}static hasDangerousFunctions(e){if(typeof e!="object"||e===null)return!1;const t=e;if(Object.values(t).some(o=>typeof o=="function"))return!0;const r=["eval","Function","setTimeout","setInterval","document","window","global","process"],n=JSON.stringify(t).toLowerCase();return r.some(o=>n.includes(o.toLowerCase()))}static estimateDataSize(e){return new Blob([JSON.stringify(e)]).size}static serializeData(e){return JSON.stringify(e,(r,n)=>{if(typeof n!="function")return n===void 0?null:n instanceof Date?{__type:"Date",value:n.toISOString()}:n instanceof RegExp?{__type:"RegExp",value:n.toString()}:n})}static deserializeData(e){return JSON.parse(e,(r,n)=>{if(typeof n=="object"&&n!==null){const o=n;if(o.__type==="Date"&&typeof o.value=="string")return new Date(o.value);if(o.__type==="RegExp"&&typeof o.value=="string"){const i=o.value.match(/^\/(.*)\/([gim]*)$/);if(i)return new RegExp(i[1],i[2])}}return n})}static encryptData(e){const t="cardall-secure-key";let r="";for(let n=0;n<e.length;n++){const o=e.charCodeAt(n)^t.charCodeAt(n%t.length);r+=String.fromCharCode(o)}return btoa(r)}static decryptData(e){const t="cardall-secure-key",r=atob(e);let n="";for(let o=0;o<r.length;o++){const i=r.charCodeAt(o)^t.charCodeAt(o%t.length);n+=String.fromCharCode(i)}return n}static compressData(e){return e}static decompressData(e){return e}static getStorageStats(){try{const t=Object.keys(localStorage).filter(o=>o.startsWith(this.PREFIX));let r=0;const n=[];return t.forEach(o=>{const i=localStorage.getItem(o);if(i){const l=new Blob([i]).size;r+=l,n.push({key:o.replace(this.PREFIX,""),size:l,lastModified:Date.now()})}}),{totalSize:r,itemCount:t.length,items:n}}catch(e){return console.error("Failed to get storage stats:",e),{totalSize:0,itemCount:0,items:[]}}}}const X={set:(a,e,t)=>Rt.setItem(a,e,t),get:(a,e)=>Rt.getItem(a,e),remove:a=>Rt.removeItem(a),clear:()=>Rt.clearAppData(),getStats:()=>Rt.getStorageStats()};class ke{static dbCardToCard(e){const{userId:t,syncVersion:r,lastSyncAt:n,pendingSync:o,...i}=e;return{...i,id:i.id||"",createdAt:this.ensureDate(i.createdAt),updatedAt:this.ensureDate(i.updatedAt)}}static cardToDbCard(e,t){return{id:e.id,frontContent:e.frontContent,backContent:e.backContent,style:e.style,isFlipped:e.isFlipped,createdAt:this.ensureDate(e.createdAt),updatedAt:this.ensureDate(e.updatedAt),userId:t,syncVersion:1,pendingSync:!0,lastSyncAt:void 0}}static bulkDbCardsToCards(e){return e.map(t=>this.dbCardToCard(t))}static bulkCardsToDbCards(e,t){return e.map(r=>this.cardToDbCard(r,t))}static ensureDate(e){if(!e)return new Date;if(e instanceof Date)return e;try{return new Date(e)}catch{return new Date}}static validateCard(e){const t=[];return e.id||t.push("Card ID is required"),e.frontContent?.title||t.push("Front content title is required"),e.backContent?.title||t.push("Back content title is required"),e.createdAt||t.push("Created date is required"),e.updatedAt||t.push("Updated date is required"),{valid:t.length===0,errors:t}}static sanitizeCard(e){const t={};return e.id&&(t.id=e.id),e.frontContent&&(t.frontContent={title:String(e.frontContent.title||"").trim(),text:String(e.frontContent.text||"").trim(),images:Array.isArray(e.frontContent.images)?e.frontContent.images:[],tags:Array.isArray(e.frontContent.tags)?e.frontContent.tags.map(r=>String(r).trim()).filter(r=>r.length>0):[],lastModified:e.frontContent.lastModified||new Date}),e.backContent&&(t.backContent={title:String(e.backContent.title||"").trim(),text:String(e.backContent.text||"").trim(),images:Array.isArray(e.backContent.images)?e.backContent.images:[],tags:Array.isArray(e.backContent.tags)?e.backContent.tags.map(r=>String(r).trim()).filter(r=>r.length>0):[],lastModified:e.backContent.lastModified||new Date}),e.style&&(t.style={type:e.style.type||"solid",backgroundColor:e.style.backgroundColor||"#ffffff",fontFamily:e.style.fontFamily||"system-ui",fontSize:e.style.fontSize||"base",fontWeight:e.style.fontWeight||"normal",textColor:e.style.textColor||"#000000",borderRadius:e.style.borderRadius||"md",shadow:e.style.shadow||"none",borderWidth:e.style.borderWidth||0,gradientColors:e.style.gradientColors||void 0,gradientDirection:e.style.gradientDirection||"to-r"}),typeof e.isFlipped=="boolean"&&(t.isFlipped=e.isFlipped),e.createdAt&&(t.createdAt=this.ensureDate(e.createdAt)),e.updatedAt&&(t.updatedAt=this.ensureDate(e.updatedAt)),t}static loadFromLocalStorage(){try{const e=X.get("cards",{validate:!0,encrypt:!0});if(!e)return[];const t=[];for(const r of e){const n=this.sanitizeCard(r),o=this.validateCard(n);o.valid?t.push(n):console.warn("Invalid card in localStorage:",r,o.errors)}return t}catch(e){return console.error("Failed to load cards from localStorage:",e),[]}}static saveToLocalStorage(e){try{const t=e.map(r=>this.sanitizeCard(r)).filter(r=>this.validateCard(r).valid);X.set("cards",t)}catch(t){throw console.error("Failed to save cards to localStorage:",t),new Error(`Failed to save to localStorage: ${t instanceof Error?t.message:String(t)}`)}}static areCardsEqual(e,t){const r=JSON.stringify(this.sanitizeCard(e)),n=JSON.stringify(this.sanitizeCard(t));return r===n}static detectCardChanges(e,t){const r=new Map(e.map(u=>[u.id,u])),n=new Map(t.map(u=>[u.id,u])),o=[],i=[],l=[];for(const[u,m]of n){const c=r.get(u);c?this.areCardsEqual(c,m)||i.push(m):o.push(m)}for(const[u,m]of r)n.has(u)||l.push(m);return{added:o,updated:i,deleted:l}}static migrateLegacyData(e){try{if(this.isStandardCardFormat(e))return Array.isArray(e)?e:[e];const t=[];if(Array.isArray(e))for(const r of e){const n=this.migrateLegacyCard(r);n&&t.push(n)}else{const r=this.migrateLegacyCard(e);r&&t.push(r)}return t}catch(t){return console.error("Failed to migrate legacy data:",t),[]}}static migrateLegacyCard(e){try{const t={id:e.id||crypto.randomUUID(),frontContent:{title:e.frontTitle||e.title||"",text:e.frontText||e.text||"",images:e.frontImages||e.images||[],tags:e.frontTags||e.tags||[],lastModified:e.lastModified||new Date},backContent:{title:e.backTitle||e.backTitle||"",text:e.backText||e.backText||"",images:e.backImages||[],tags:e.backTags||[],lastModified:e.lastModified||new Date},style:e.style||{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#000000",borderRadius:"md",shadow:"none",borderWidth:0},isFlipped:e.isFlipped||!1,createdAt:this.ensureDate(e.createdAt||e.created||new Date),updatedAt:this.ensureDate(e.updatedAt||e.updated||new Date)},r=this.sanitizeCard(t);return this.validateCard(r).valid?r:null}catch(t){return console.error("Failed to migrate legacy card:",t),null}}static isStandardCardFormat(e){return!e||typeof e!="object"?!1:["id","frontContent","backContent","createdAt","updatedAt"].every(r=>r in e)}static generateCardChecksum(e){const t=this.sanitizeCard(e),r=JSON.stringify(t);let n=0;for(let o=0;o<r.length;o++){const i=r.charCodeAt(o);n=(n<<5)-n+i,n=n&n}return Math.abs(n).toString(16)}static compressCardData(e){const t=e.map(r=>{const n=this.sanitizeCard(r);return{i:n.id,ft:n.frontContent.title,ftx:n.frontContent.text,ftg:n.frontContent.tags,bt:n.backContent.title,btx:n.backContent.text,btg:n.backContent.tags,s:n.style,f:n.isFlipped,ca:n.createdAt.getTime(),ua:n.updatedAt.getTime()}});return JSON.stringify(t)}static decompressCardData(e){try{return JSON.parse(e).map(r=>({id:r.i,frontContent:{title:r.ft||"",text:r.ftx||"",images:[],tags:r.ftg||[],lastModified:new Date},backContent:{title:r.bt||"",text:r.btx||"",images:[],tags:r.btg||[],lastModified:new Date},style:r.s||{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#000000",borderRadius:"md",shadow:"none",borderWidth:0},isFlipped:r.f||!1,createdAt:new Date(r.ca),updatedAt:new Date(r.ua)}))}catch(t){return console.error("Failed to decompress card data:",t),[]}}}const Bs={autoMigration:!0,backupOnMigration:!0,compressionEnabled:!0,cacheEnabled:!0,cacheSize:1e3,syncEnabled:!0,debugMode:!1,performanceMonitoring:!0,maxRetries:3,timeout:3e4};function Cr(a){const e={...Bs,...a},t=[],r=[];return(e.cacheSize<0||e.cacheSize>1e4)&&t.push("cacheSize must be between 0 and 10000"),(e.timeout<1e3||e.timeout>3e5)&&r.push("timeout should be between 1000ms and 300000ms"),(e.maxRetries<0||e.maxRetries>10)&&t.push("maxRetries must be between 0 and 10"),{valid:t.length===0,errors:t,warnings:r,config:e}}function ce(a,e,t){return{code:a,message:e,details:t,timestamp:new Date,stack:new Error().stack}}class _s{static instance=null;static async create(e){if(this.instance)return this.instance;const t=Cr(e||{});if(!t.valid)throw ce("INVALID_CONFIG","Invalid storage configuration",{errors:t.errors});try{const{UniversalStorageAdapter:r}=await Ps(async()=>{const{UniversalStorageAdapter:n}=await Promise.resolve().then(()=>Zo);return{UniversalStorageAdapter:n}},void 0);this.instance=new r(t.config)}catch(r){throw ce("IMPORT_ERROR","Failed to import storage adapter implementation",{importError:r instanceof Error?r.message:String(r)})}return this.instance}static getInstance(){return this.instance}static resetInstance(){this.instance=null}}const Qo=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_STORAGE_CONFIG:Bs,StorageAdapterFactory:_s,createStorageError:ce,validateStorageConfig:Cr},Symbol.toStringTag,{value:"Module"}));class We{name="UniversalStorageAdapter";version="1.0.0";static instance;storageMode="localStorage";config;eventListeners=new Map;STORAGE_MODE_KEY="cardall_storage_mode";MIGRATION_STATUS_KEY="cardall_migration_status";progressCallbacks=new Set;cancelToken=null;constructor(e=Bs){this.config=e,this.initializeStorageMode(),this.setupEventListeners()}static getInstance(){return We.instance||(We.instance=new We),We.instance}initializeStorageMode(){try{const e=X.get(this.STORAGE_MODE_KEY);e?this.storageMode=e:(this.storageMode="localStorage",this.saveStorageMode())}catch(e){console.warn("Failed to initialize storage mode:",e),this.storageMode="localStorage"}}saveStorageMode(){try{X.set(this.STORAGE_MODE_KEY,this.storageMode),this.emitEvent({type:"storageModeChanged",timestamp:new Date,data:{mode:this.storageMode}})}catch(e){console.error("Failed to save storage mode:",e)}}getStorageMode(){return this.storageMode}async switchStorageMode(e,t){if(this.storageMode===e)return this.notifyProgress({phase:"completed",percentage:100,message:`Already in ${e} mode`,timestamp:new Date}),{success:!0,message:"Already in requested mode",fromMode:this.storageMode,toMode:e,dataMigrated:!1,rollbackPerformed:!1,validation:{isValid:!0,issues:[]}};const r=this.storageMode,n=Date.now();let o,i=!1,l=!1;const u=[];t?.onProgress&&this.progressCallbacks.add(t.onProgress),this.cancelToken={cancelled:!1};try{this.notifyProgress({phase:"preparing",percentage:5,message:`准备从 ${r} 切换到 ${e}...`,timestamp:new Date}),this.notifyProgress({phase:"validating",percentage:15,message:"验证切换条件...",timestamp:new Date});const m=await this.validatePreSwitchConditions(e);if(!m.isValid)throw this.notifyProgress({phase:"failed",percentage:20,message:`切换前验证失败: ${m.issues.join(", ")}`,details:{issues:m.issues},timestamp:new Date}),new Error(`Pre-switch validation failed: ${m.issues.join(", ")}`);if(this.checkCancellation())throw new Error("Switch cancelled by user");this.config.backupOnMigration&&!t?.skipBackup&&(this.notifyProgress({phase:"backing-up",percentage:30,message:"创建数据备份...",timestamp:new Date}),o=await this.backupData(),this.notifyProgress({phase:"backing-up",percentage:45,message:`备份创建成功: ${o.id}`,details:{backupId:o.id},timestamp:new Date}));const c=e==="indexeddb"&&(await this.hasDataToMigrate()||t?.forceMigration);if(c){this.notifyProgress({phase:"migrating",percentage:50,message:"开始数据迁移...",timestamp:new Date});const C=await this.migrateFromLocalStorage();if(!C.success)throw this.notifyProgress({phase:"failed",percentage:60,message:`数据迁移失败: ${C.errors.join(", ")}`,details:{errors:C.errors},timestamp:new Date}),new Error(`Migration failed: ${C.errors.join(", ")}`);i=!0,this.notifyProgress({phase:"migrating",percentage:70,message:`数据迁移完成: ${C.migratedCards} 张卡片`,details:{migratedCards:C.migratedCards,totalCards:C.totalCards},timestamp:new Date})}if(this.checkCancellation())throw new Error("Switch cancelled by user");this.notifyProgress({phase:"switching",percentage:80,message:`切换存储模式到 ${e}...`,timestamp:new Date}),this.storageMode=e,this.saveStorageMode(),this.notifyProgress({phase:"validating-after",percentage:85,message:"验证切换后数据完整性...",timestamp:new Date});const x=await this.validatePostSwitchConditions(e,r);if(!x.isValid)throw this.notifyProgress({phase:"failed",percentage:90,message:`切换后验证失败: ${x.issues.join(", ")}`,details:{issues:x.issues},timestamp:new Date}),new Error(`Post-switch validation failed: ${x.issues.join(", ")}`);c&&i&&(this.notifyProgress({phase:"cleaning-up",percentage:95,message:"清理旧数据...",timestamp:new Date}),await this.cleanupOldData(r));const h=Date.now()-n;this.notifyProgress({phase:"completed",percentage:100,message:`存储模式切换成功完成，耗时 ${h}ms`,details:{duration:h,dataMigrated:i,fromMode:r,toMode:e},timestamp:new Date}),this.emitEvent({type:"storageModeChanged",timestamp:new Date,data:{fromMode:r,toMode:e,dataMigrated:i,duration:h}});const f={success:!0,message:`Successfully switched from ${r} to ${e}`,fromMode:r,toMode:e,dataMigrated:i,rollbackPerformed:l,duration:h,backup:o,validation:x,progress:u};return this.recordSwitchHistory(f),f}catch(m){if(console.error("Storage mode switch failed:",m),this.notifyProgress({phase:"failed",percentage:0,message:`存储模式切换失败: ${m instanceof Error?m.message:String(m)}`,timestamp:new Date}),o){this.notifyProgress({phase:"rolling-back",percentage:50,message:"正在回滚到原始状态...",timestamp:new Date}),console.log("Attempting rollback...");const h=await this.performRollback(r,o);l=h,h?(this.notifyProgress({phase:"rolled-back",percentage:100,message:"回滚成功",timestamp:new Date}),console.log("Rollback completed successfully")):(this.notifyProgress({phase:"rollback-failed",percentage:100,message:"回滚失败 - 可能需要手动干预",timestamp:new Date}),console.error("Rollback failed - manual intervention may be required"))}else console.log("No backup available, reverting to original mode..."),this.storageMode=r,this.saveStorageMode();const c=m instanceof Error?m.message:String(m);this.emitEvent({type:"error",timestamp:new Date,data:{error:"StorageModeSwitchFailed",details:{fromMode:r,toMode:e,error:c,rollbackPerformed:l}},error:m instanceof Error?m:new Error(c)});const x={success:!1,message:`Failed to switch storage mode: ${c}`,fromMode:r,toMode:e,dataMigrated:i,rollbackPerformed:l,validation:{isValid:!1,issues:[c]},progress:u};throw this.recordSwitchHistory(x),ce("STORAGE_MODE_SWITCH_FAILED",`Failed to switch storage mode: ${c}`,{fromMode:r,toMode:e,error:c,rollbackPerformed:l})}finally{t?.onProgress&&this.progressCallbacks.delete(t.onProgress),this.cancelToken=null}}async setStorageMode(e){try{const t=await this.switchStorageMode(e);if(!t.success)throw new Error(t.message)}catch(t){throw this.storageMode!==e&&(this.storageMode=e==="indexeddb"?"localStorage":"indexeddb",this.saveStorageMode()),t}}cancelStorageModeSwitch(e="用户取消"){this.cancelToken&&(this.cancelToken.cancelled=!0,this.cancelToken.reason=e,this.notifyProgress({phase:"cancelled",percentage:0,message:`操作已取消: ${e}`,timestamp:new Date}))}checkCancellation(){return this.cancelToken?.cancelled||!1}notifyProgress(e){this.progressCallbacks.forEach(t=>{try{t(e)}catch(r){console.warn("Progress callback error:",r)}}),this.emitEvent({type:"storageModeSwitchProgress",timestamp:new Date,data:e})}isSwitchInProgress(){return this.cancelToken!==null}async getStorageModeStats(){try{const e=X.get("storage_switch_history",[])||[],t=e.length,r=e[e.length-1],n=e.filter(x=>x.success===!1).length,o=typeof localStorage<"u",i=await this.isIndexedDBAvailable();let l=0,u=0,m=0,c=0;try{const x=X.get("cards",{validate:!0,encrypt:!0});x&&(l=x.length,m=JSON.stringify(x).length)}catch(x){console.warn("Failed to check localStorage data:",x)}try{if(i){u=await P.cards.count();const x=await P.cards.toArray();c=JSON.stringify(x).length}}catch(x){console.warn("Failed to check IndexedDB data:",x)}return{currentMode:this.storageMode,switchCount:t,lastSwitchTime:r?.timestamp?new Date(r.timestamp):void 0,lastSwitchDuration:r?.duration,failedSwitches:n,availableStorage:{localStorage:o,indexedDB:i},dataDistribution:{localStorageCards:l,indexedDBCards:u,localStorageSize:m,indexedDBSize:c}}}catch(e){throw console.error("Failed to get storage mode stats:",e),ce("GET_STORAGE_STATS_FAILED","Failed to get storage mode statistics",{error:e instanceof Error?e.message:String(e)})}}recordSwitchHistory(e){try{const t=X.get("storage_switch_history",[])||[];t.push({timestamp:new Date().toISOString(),fromMode:e.fromMode,toMode:e.toMode,success:e.success,duration:e.duration,dataMigrated:e.dataMigrated,rollbackPerformed:e.rollbackPerformed,message:e.message}),t.length>50&&t.splice(0,t.length-50),X.set("storage_switch_history",t)}catch(t){console.warn("Failed to record switch history:",t)}}clearSwitchHistory(){try{X.remove("storage_switch_history"),console.log("Storage switch history cleared")}catch(e){console.warn("Failed to clear switch history:",e)}}async getRecommendedStorageMode(){const e=[];try{const t=await this.getStorageModeStats(),r=t.availableStorage.indexedDB,n=t.availableStorage.localStorage;return r?t.dataDistribution.localStorageSize+t.dataDistribution.indexedDBSize>5*1024*1024?{recommendedMode:"indexeddb",reason:"Large data volume detected, IndexedDB is more suitable",confidence:"high",issues:[]}:t.failedSwitches===0||t.failedSwitches/t.switchCount<.2?{recommendedMode:t.currentMode,reason:"Current storage mode is working well",confidence:"medium",issues:[]}:{recommendedMode:"indexeddb",reason:"IndexedDB offers better performance and reliability",confidence:"medium",issues:[]}:{recommendedMode:"localStorage",reason:"IndexedDB is not available in this browser",confidence:"high",issues:["IndexedDB not supported"]}}catch(t){return e.push(`Failed to analyze storage recommendations: ${t instanceof Error?t.message:String(t)}`),{recommendedMode:"localStorage",reason:"Failed to analyze, using safe option",confidence:"low",issues:e}}}async validatePreSwitchConditions(e){const t=[],r=[],n={};try{if(e==="indexeddb"){const l=await this.isIndexedDBAvailable();l||t.push("IndexedDB is not available in this environment"),n.indexedDBAvailable=l}const o=await this.validateDataIntegrity();if(o.isValid||(t.push("Current data integrity check failed"),t.push(...o.issues)),n.currentDataValidation=o,e==="indexeddb"&&await this.hasDataToMigrate()){const l=await this.getCards(),u=JSON.stringify(l).length;if(navigator.storage&&navigator.storage.estimate)try{const m=await navigator.storage.estimate(),c=(m.quota||0)-(m.usage||0);c<u*2&&r.push("Available storage space may be insufficient"),n.storageQuota={total:m.quota,used:m.usage,available:c,required:u}}catch{r.push("Unable to estimate storage space")}}const i=this.checkBrowserCompatibility(e);return i.compatible||t.push(...i.issues),n.browserCompatibility=i,{isValid:t.length===0,issues:t,warnings:r.length>0?r:void 0,details:n}}catch(o){return{isValid:!1,issues:[`Pre-switch validation error: ${o instanceof Error?o.message:String(o)}`],warnings:r.length>0?r:void 0,details:n}}}async validatePostSwitchConditions(e,t){const r=[],n=[],o={};try{const i=Date.now();await this.getCards(),o.dataAccessTime=Date.now()-i;const l=await this.validateDataIntegrity(e);if(l.isValid||(r.push("New mode data integrity check failed"),r.push(...l.issues)),o.newDataValidation=l,t==="localStorage"&&e==="indexeddb"){const m=await this.validateMigrationConsistency();m.isValid||(r.push("Data consistency check failed"),r.push(...m.issues)),o.consistencyCheck=m}const u=await this.validateStoragePerformance(e);return u.warnings.length>0&&n.push(...u.warnings),o.performanceCheck=u,{isValid:r.length===0,issues:r,warnings:n.length>0?n:void 0,details:o}}catch(i){return{isValid:!1,issues:[`Post-switch validation error: ${i instanceof Error?i.message:String(i)}`],warnings:n.length>0?n:void 0,details:o}}}async performRollback(e,t){const r=Date.now();console.log(`Starting enhanced rollback to ${e}...`);try{console.log("Phase 1: Pre-rollback state check...");const n=this.storageMode,o=await this.getStats();console.log(`Current state: ${n}, ${o.totalCards} cards`),console.log("Phase 2: Creating pre-rollback safety backup...");const i=await this.createSafetyBackup();console.log(`Safety backup created: ${i?.id||"N/A"}`),console.log("Phase 3: Setting temporary storage mode...");const l=n;this.storageMode="rollback_temp",this.saveStorageMode(),console.log("Phase 4: Validating backup integrity...");const u=await this.validateBackupIntegrity(t);if(!u.isValid)throw new Error(`Backup integrity validation failed: ${u.issues.join(", ")}`);console.log("Phase 5: Restoring storage mode..."),this.storageMode=e,this.saveStorageMode(),console.log("Phase 6: Restoring data...");const m=await this.enhancedRestoreData(t);if(!m.success)throw new Error(`Data restoration failed: ${m.issues.join(", ")}`);console.log(`Restored ${m.restoredCards} cards`),console.log("Phase 7: Post-rollback validation...");const c=await this.validateDataIntegrity(e);if(!c.isValid&&(console.warn(`Post-rollback validation issues: ${c.issues.join(", ")}`),c.corruptedCards.length>0)){console.log("Attempting data repair...");const h=await this.repairDataIntegrity();if(console.log(`Repair result: ${h.repaired?"SUCCESS":"FAILED"}`),!h.repaired)throw new Error(`Post-rollback data repair failed: ${h.issues.join(", ")}`)}i&&(console.log("Phase 8: Cleaning up safety backup..."),await this.cleanupSafetyBackup(i.id));const x=Date.now()-r;return console.log(`Enhanced rollback completed successfully in ${x}ms`),this.emitEvent({type:"backupRestored",timestamp:new Date,data:{backupId:t.id,rollback:!0,duration:x,restoredCards:m.restoredCards,targetMode:e}}),!0}catch(n){const o=`Rollback failed: ${n instanceof Error?n.message:String(n)}`;console.error(o);try{console.log("Attempting emergency recovery..."),this.storageMode=e,this.saveStorageMode(),this.emitEvent({type:"error",timestamp:new Date,data:{error:"RollbackFailed",details:{targetMode:e,error:o,emergencyRecovery:!0}},error:n instanceof Error?n:new Error(o)})}catch(i){console.error("Emergency recovery also failed:",i)}return!1}}async createSafetyBackup(){try{const e=await this.getCards(),t={timestamp:new Date().toISOString(),version:this.version,purpose:"rollback_safety",cards:e},r=JSON.stringify(t),n=`safety_backup_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;X.set(n,t);const o=await this.calculateChecksum(r);return{id:n,data:r,timestamp:new Date,version:this.version,cardCount:e.length,checksum:o}}catch(e){return console.warn("Failed to create safety backup:",e),null}}async validateBackupIntegrity(e){const t=[],r={};try{const n=await this.calculateChecksum(e.data);r.checksumMatch=n===e.checksum,r.backupChecksum=e.checksum,r.currentChecksum=n,n!==e.checksum&&t.push("Backup checksum mismatch - data may be corrupted");try{const i=JSON.parse(e.data);if(r.dataFormatValid=!0,!i.cards||!Array.isArray(i.cards))t.push("Invalid backup data format - missing or invalid cards array"),r.cardsValid=!1;else{r.cardsValid=!0,r.cardCount=i.cards.length;const l=Math.min(5,i.cards.length),u=i.cards.slice(0,l),m=[];for(let c=0;c<u.length;c++){const x=u[c],h=this.validateCardStructure(x);h.length>0&&m.push(`Card at index ${c}: ${h.join(", ")}`)}m.length>0?(t.push(`Card structure issues found: ${m.join("; ")}`),r.structureIssues=m):r.structureValid=!0}}catch(i){t.push(`Backup data parsing failed: ${i instanceof Error?i.message:String(i)}`),r.dataFormatValid=!1}const o=Date.now()-e.timestamp.getTime();return r.backupAgeMs=o,r.backupAgeHours=o/(1e3*60*60),o>24*60*60*1e3&&t.push("Backup is more than 24 hours old"),{isValid:t.length===0,issues:t,details:r}}catch(n){return t.push(`Backup validation failed: ${n instanceof Error?n.message:String(n)}`),{isValid:!1,issues:t,details:r}}}async enhancedRestoreData(e){const t=[];let r=0;try{const n=JSON.parse(e.data);if(!n.cards||!Array.isArray(n.cards))throw new Error("Invalid backup data format");if(console.log("Clearing current data..."),this.storageMode==="indexeddb"&&await P.cards.clear(),X.remove("cards"),console.log(`Restoring ${n.cards.length} cards...`),this.storageMode==="indexeddb"){const i=n.cards.map(l=>this.convertToDbCard(l));try{await P.cards.bulkAdd(i),r=i.length}catch(l){console.warn("Bulk restore failed, trying individual restore..."),t.push(`Bulk restore failed: ${l instanceof Error?l.message:String(l)}`),r=0;for(const u of n.cards)try{const m=this.convertToDbCard(u);await P.cards.add(m),r++}catch(m){t.push(`Failed to restore card ${u.id}: ${m instanceof Error?m.message:String(m)}`)}}}else X.set("cards",n.cards),r=n.cards.length;const o=await this.validateDataIntegrity(this.storageMode);return o.isValid?console.log(`Data integrity check passed for ${o.cardCount} cards`):t.push(...o.issues.map(i=>`Validation: ${i}`)),{success:t.length===0||r>0&&t.length<r*.1,restoredCards:r,issues:t}}catch(n){return t.push(`Enhanced restore failed: ${n instanceof Error?n.message:String(n)}`),{success:!1,restoredCards:r,issues:t}}}async cleanupSafetyBackup(e){try{X.remove(e),console.log(`Safety backup ${e} cleaned up`)}catch(t){console.warn(`Failed to cleanup safety backup ${e}:`,t)}}async cleanupOldData(e){try{if(e==="localStorage"){const t=X.get("cards",{validate:!0,encrypt:!0});t&&t.length>0&&(console.log("Cleaning up localStorage data..."),X.remove("cards"),console.log("localStorage data cleaned up"))}else e==="indexeddb"&&await this.hasIndexedDBData()&&(console.log("Cleaning up IndexedDB data..."),await P.cards.clear(),console.log("IndexedDB data cleaned up"))}catch(t){console.warn("Failed to cleanup old data:",t)}}async validateMigrationConsistency(){const e=[],t=[],r={};try{console.log("Starting migration consistency validation...");const n=await P.cards.count();r.indexedDBCount=n;const o=X.get("cards",{validate:!0,encrypt:!0});if(r.localStorageCards=o?.length||0,o&&o.length>0){n!==o.length&&e.push(`Card count mismatch: IndexedDB has ${n}, localStorage had ${o.length}`);const l=Math.min(10,o.length),u=o.slice(0,l),m={};for(const f of u){const C={id:f.id,title:f.frontContent.title,found:!1,contentMatch:!1,tagsMatch:!1,timestampMatch:!1};try{const j=await P.cards.get(f.id);if(!j){e.push(`Card ${f.id} not found in IndexedDB`),C.found=!1,m[f.id]=C;continue}C.found=!0;const N=this.convertFromDbCard(j),v=N.frontContent.title===f.frontContent.title,g=N.backContent.title===f.backContent.title;C.contentMatch=v&&g;const p=N.frontContent.text===f.frontContent.text&&N.backContent.text===f.backContent.text;C.contentMatch=C.contentMatch&&p;const y=JSON.stringify(N.frontContent.tags.sort())===JSON.stringify(f.frontContent.tags.sort()),b=JSON.stringify(N.backContent.tags.sort())===JSON.stringify(f.backContent.tags.sort());C.tagsMatch=y&&b;const E=N.createdAt.getTime()===f.createdAt.getTime()&&N.updatedAt.getTime()===f.updatedAt.getTime();C.timestampMatch=E,m[f.id]=C,C.found||e.push(`Card ${f.id} missing in IndexedDB`),C.contentMatch||e.push(`Content mismatch for card ${f.id}`),C.tagsMatch||t.push(`Tags mismatch for card ${f.id}`),C.timestampMatch||t.push(`Timestamp mismatch for card ${f.id}`)}catch(j){console.warn(`Error validating card ${f.id}:`,j),e.push(`Validation error for card ${f.id}: ${j instanceof Error?j.message:String(j)}`)}}r.sampleValidation=m;const c=Object.keys(m).length*4,x=Object.values(m).reduce((f,C)=>f+(C.found?1:0)+(C.contentMatch?1:0)+(C.tagsMatch?1:0)+(C.timestampMatch?1:0),0),h=c>0?x/c*100:0;r.consistencyScore=h,h<95&&t.push(`Migration consistency score is ${h.toFixed(1)}%`);try{const f=await P.cards.toArray(),C=new Set,j=new Set;f.forEach(N=>{C.has(N.id)?j.add(N.id):C.add(N.id)}),j.size>0&&e.push(`Found duplicate card IDs: ${Array.from(j).join(", ")}`)}catch(f){t.push(`Could not validate ID uniqueness: ${f instanceof Error?f.message:String(f)}`)}try{const f=await P.cards.toArray(),C=await this.validateDatabaseStructure(f);C.length>0&&e.push(...C)}catch(f){t.push(`Structure validation failed: ${f instanceof Error?f.message:String(f)}`)}}else o===null&&t.push("Original localStorage data not available for comparison");const i=e.length===0;return console.log(`Migration consistency validation completed: ${i?"PASS":"FAIL"}`),i||console.warn(`Found ${e.length} issues and ${t.length} warnings`),{isValid:i,issues:e,warnings:t.length>0?t:void 0,details:r}}catch(n){const o=`Migration consistency check failed: ${n instanceof Error?n.message:String(n)}`;return console.error(o),{isValid:!1,issues:[o],warnings:t.length>0?t:void 0,details:r}}}async validateDatabaseStructure(e){const t=[];try{for(let r=0;r<e.length;r++){const n=e[r],o=["id","frontContent","backContent","createdAt","updatedAt"];for(const i of o)i in n||t.push(`Card at index ${r} missing required field: ${i}`);if(typeof n.id!="string"&&t.push(`Card ${n.id} has invalid ID type`),n.frontContent&&typeof n.frontContent!="object"&&t.push(`Card ${n.id} has invalid frontContent type`),n.backContent&&typeof n.backContent!="object"&&t.push(`Card ${n.id} has invalid backContent type`),n.createdAt)try{new Date(n.createdAt)}catch{t.push(`Card ${n.id} has invalid createdAt format`)}if(n.updatedAt)try{new Date(n.updatedAt)}catch{t.push(`Card ${n.id} has invalid updatedAt format`)}}}catch(r){t.push(`Structure validation error: ${r instanceof Error?r.message:String(r)}`)}return t}async validateStoragePerformance(e){const t=[],r={};try{const n=Date.now();await this.getCards(),r.readTime=Date.now()-n;const o=await this.createCard({frontContent:{title:"Performance Test",text:"Test content",tags:[]},backContent:{title:"Performance Test Back",text:"Test back content",tags:[]},style:{type:"solid"},isFlipped:!1}),i=Date.now();return await this.updateCard(o.id,{frontContent:{...o.frontContent,text:"Updated test content"}}),r.writeTime=Date.now()-i,await this.deleteCard(o.id),e==="indexeddb"&&r.readTime>1e3&&t.push("IndexedDB read performance is slow"),e==="localStorage"&&r.readTime>500&&t.push("LocalStorage read performance is slow"),{warnings:t,metrics:r}}catch(n){return t.push(`Performance validation failed: ${n instanceof Error?n.message:String(n)}`),{warnings:t,metrics:r}}}checkBrowserCompatibility(e){const t=[],r={};try{if(r.localStorageSupported=typeof localStorage<"u",r.indexedDBSupported=typeof indexedDB<"u",r.serviceWorkerSupported="serviceWorker"in navigator,e==="indexeddb"){r.indexedDBSupported||t.push("IndexedDB is not supported in this browser");try{const n=indexedDB.open("test_db",1);r.indexedDBOpenable=!0,n.onsuccess=()=>{n.result.close(),indexedDB.deleteDatabase("test_db")}}catch{r.indexedDBOpenable=!1,t.push("IndexedDB cannot be opened in this browser")}}return e==="localStorage"&&!r.localStorageSupported&&t.push("LocalStorage is not supported in this browser"),{compatible:t.length===0,issues:t,details:r}}catch(n){return{compatible:!1,issues:[`Browser compatibility check failed: ${n instanceof Error?n.message:String(n)}`],details:r}}}async hasDataToMigrate(){if(this.storageMode==="indexeddb")return!1;const e=X.get("cards",{validate:!0,encrypt:!0});return e?e.length>0:!1}async migrateFromLocalStorage(){const e=Date.now();this.emitEvent({type:"migrationStarted",timestamp:new Date});try{if(!await this.hasDataToMigrate()){const l={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:[],duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationCompleted",timestamp:new Date,data:l}),l}const r=X.get("cards",{validate:!0,encrypt:!0});if(!r||r.length===0){const l={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:[],duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationCompleted",timestamp:new Date,data:l}),l}let n;this.config.backupOnMigration&&(n=await this.backupData());const o=await this.performMigration(r);if(await this.validateMigration(r.length)&&o.success){await this.setStorageMode("indexeddb"),o.errors.length===0&&this.cleanupLocalStorage();const l={...o,totalCards:r.length,duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationCompleted",timestamp:new Date,data:l}),l}else{n&&await this.restoreData(n);const l={success:!1,migratedCards:0,totalCards:r.length,errors:["Migration validation failed"],warnings:o.warnings,duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationFailed",timestamp:new Date,data:l,error:new Error("Migration validation failed")}),l}}catch(t){const r={success:!1,migratedCards:0,totalCards:0,errors:[t instanceof Error?t.message:"Unknown migration error"],warnings:[],duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationFailed",timestamp:new Date,data:r,error:t instanceof Error?t:new Error(String(t))}),r}}async performMigration(e){const t=[],r=[];let n=0;try{const o=e.map(i=>this.convertToDbCard(i));return await P.cards.bulkAdd(o),n=o.length,{success:!0,migratedCards:n,totalCards:e.length,errors:[],warnings:r,duration:0,timestamp:new Date}}catch(o){console.error("Bulk migration failed:",o);for(const l of e)try{const u=this.convertToDbCard(l);await P.cards.add(u),n++}catch(u){console.error(`Failed to migrate card ${l.id}:`,u),t.push(l.id)}const i=t.length===0;return i||r.push(`Some cards failed to migrate: ${t.length} out of ${e.length}`),{success:i,migratedCards:n,totalCards:e.length,errors:t,warnings:r,duration:0,timestamp:new Date}}}async validateMigration(e){try{return await P.cards.count()===e}catch(t){return console.error("Migration validation failed:",t),!1}}cleanupLocalStorage(){try{X.remove("cards")}catch(e){console.warn("Failed to cleanup localStorage:",e)}}async backupData(){const e=await this.getCards(),t={timestamp:new Date().toISOString(),version:this.version,cards:e},r=JSON.stringify(t),n=`backup_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;X.set(n,t);const o=await this.calculateChecksum(r),i={id:n,data:r,timestamp:new Date,version:this.version,cardCount:e.length,checksum:o};return this.emitEvent({type:"backupCreated",timestamp:new Date,data:i}),i}async restoreData(e){try{if(await this.calculateChecksum(e.data)!==e.checksum)throw new Error("Backup data integrity check failed");const r=JSON.parse(e.data);if(!r.cards||!Array.isArray(r.cards))throw new Error("Invalid backup data format");if(this.storageMode==="indexeddb"){const n=r.cards.map(o=>this.convertToDbCard(o));await P.cards.clear(),await P.cards.bulkAdd(n)}else X.set("cards",r.cards);return this.emitEvent({type:"backupRestored",timestamp:new Date,data:{backupId:e.id,cardCount:e.cardCount}}),!0}catch(t){return console.error("Restore failed:",t),!1}}async calculateChecksum(e){let t=0;for(let r=0;r<e.length;r++){const n=e.charCodeAt(r);t=(t<<5)-t+n,t=t&t}return Math.abs(t).toString(16)}convertToDbCard(e){return{id:e.id,frontContent:e.frontContent,backContent:e.backContent,style:e.style,isFlipped:e.isFlipped,createdAt:e.createdAt,updatedAt:e.updatedAt,userId:void 0,syncVersion:1,pendingSync:!0,lastSyncAt:void 0}}convertFromDbCard(e){const{userId:t,syncVersion:r,lastSyncAt:n,pendingSync:o,...i}=e;return{...i,id:i.id||"",createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)}}async getCards(e){try{if(this.storageMode==="indexeddb"){const r=(await P.cards.toArray()).map(n=>this.convertFromDbCard(n));return e?this.applyFilter(r,e):r}else{const t=X.get("cards",{validate:!0,encrypt:!0})||[];return e?this.applyFilter(t,e):t}}catch(t){throw ce("GET_CARDS_FAILED","Failed to get cards",{error:t instanceof Error?t.message:String(t)})}}applyFilter(e,t){return e.filter(r=>{if(t.searchTerm){const n=t.searchTerm.toLowerCase(),o=r.frontContent.title.toLowerCase().includes(n)||r.backContent.title.toLowerCase().includes(n),i=r.frontContent.text.toLowerCase().includes(n)||r.backContent.text.toLowerCase().includes(n);if(!o&&!i)return!1}if(t.tags&&t.tags.length>0){const n=[...r.frontContent.tags,...r.backContent.tags];if(!t.tags.some(i=>n.includes(i)))return!1}return!0})}async getCardById(e){try{if(this.storageMode==="indexeddb"){const t=await P.cards.get(e);return t?this.convertFromDbCard(t):null}else return(await this.getCards()).find(r=>r.id===e)||null}catch(t){throw ce("GET_CARD_FAILED",`Failed to get card ${e}`,{error:t instanceof Error?t.message:String(t)})}}async createCard(e){const t=new Date,r={...e,id:crypto.randomUUID(),createdAt:t,updatedAt:t};try{if(this.storageMode==="indexeddb"){const n=this.convertToDbCard(r);await P.cards.add(n)}else{const n=await this.getCards();n.push(r),await this.saveCards(n)}return this.emitEvent({type:"cardCreated",timestamp:new Date,data:{card:r}}),r}catch(n){throw ce("CREATE_CARD_FAILED","Failed to create card",{error:n instanceof Error?n.message:String(n)})}}async updateCard(e,t){try{if(this.storageMode==="indexeddb"){const r=await P.cards.get(e);if(!r)throw ce("CARD_NOT_FOUND",`Card ${e} not found`);const n={...r,...t,updatedAt:new Date};return await P.cards.put(n),this.convertFromDbCard(n)}else{const r=await this.getCards(),n=r.findIndex(o=>o.id===e);if(n===-1)throw ce("CARD_NOT_FOUND",`Card ${e} not found`);return r[n]={...r[n],...t,updatedAt:new Date},await this.saveCards(r),r[n]}}catch(r){throw ce("UPDATE_CARD_FAILED",`Failed to update card ${e}`,{error:r instanceof Error?r.message:String(r)})}}async deleteCard(e){try{if(this.storageMode==="indexeddb")await P.cards.delete(e);else{const r=(await this.getCards()).filter(n=>n.id!==e);await this.saveCards(r)}return this.emitEvent({type:"cardDeleted",timestamp:new Date,data:{cardId:e}}),!0}catch(t){throw ce("DELETE_CARD_FAILED",`Failed to delete card ${e}`,{error:t instanceof Error?t.message:String(t)})}}async saveCards(e){try{if(this.storageMode==="indexeddb"){const t=e.map(r=>this.convertToDbCard(r));await P.cards.clear(),await P.cards.bulkAdd(t)}else X.set("cards",e);this.emitEvent({type:"cardsChanged",timestamp:new Date,data:{cardCount:e.length}})}catch(t){throw ce("SAVE_CARDS_FAILED","Failed to save cards",{error:t instanceof Error?t.message:String(t)})}}async createCards(e){const t=new Date,r=e.map(n=>({...n,id:crypto.randomUUID(),createdAt:t,updatedAt:t}));try{if(this.storageMode==="indexeddb"){const n=r.map(o=>this.convertToDbCard(o));await P.cards.bulkAdd(n)}else{const n=await this.getCards();n.push(...r),await this.saveCards(n)}return r}catch(n){throw ce("CREATE_CARDS_FAILED","Failed to create cards",{error:n instanceof Error?n.message:String(n)})}}async updateCards(e){const t=[];try{if(this.storageMode==="indexeddb")for(const{id:r,updates:n}of e){const o=await this.updateCard(r,n);t.push(o)}else{const r=await this.getCards();for(const{id:n,updates:o}of e){const i=r.findIndex(l=>l.id===n);i!==-1&&(r[i]={...r[i],...o,updatedAt:new Date},t.push(r[i]))}await this.saveCards(r)}return t}catch(r){throw ce("UPDATE_CARDS_FAILED","Failed to update cards",{error:r instanceof Error?r.message:String(r)})}}async deleteCards(e){try{if(this.storageMode==="indexeddb")await P.cards.bulkDelete(e);else{const r=(await this.getCards()).filter(n=>!e.includes(n.id));await this.saveCards(r)}return!0}catch(t){throw ce("DELETE_CARDS_FAILED","Failed to delete cards",{error:t instanceof Error?t.message:String(t)})}}async searchCards(e,t){const r={...t,searchTerm:e};return this.getCards(r)}async getCardsByTag(e){const t={searchTerm:"",tags:[e]};return this.getCards(t)}async getCardsByFolder(e){return(await this.getCards()).filter(r=>r.folderId===e)}async getStats(){try{let e=0,t=0,r=0;if(this.storageMode==="indexeddb"){e=await P.cards.count();const i=await P.cards.toArray();r=JSON.stringify(i).length}else{const i=await this.getCards();e=i.length,t=JSON.stringify(i).length}const n=Math.max(t,r);return{totalCards:e,totalFolders:0,totalTags:0,totalSize:n,lastUpdated:new Date,storageMode:this.storageMode,indexedDBSize:r>0?r:void 0,localStorageSize:t>0?t:void 0}}catch(e){throw ce("GET_STATS_FAILED","Failed to get storage stats",{error:e instanceof Error?e.message:String(e)})}}async healthCheck(){const e=[],t=[];let r=100;try{if(await this.getCards(),this.storageMode==="indexeddb")try{await P.cards.count()}catch(n){e.push({level:"error",code:"INDEXEDDB_ACCESS_FAILED",message:"Cannot access IndexedDB",details:{error:n instanceof Error?n.message:String(n)}}),r-=40}try{X.get("test")}catch(n){e.push({level:"warning",code:"LOCALSTORAGE_ACCESS_FAILED",message:"Cannot access localStorage",details:{error:n instanceof Error?n.message:String(n)}}),r-=20}if(this.storageMode==="indexeddb"){const n=await this.getStats();n.totalSize>50*1024*1024&&(e.push({level:"warning",code:"LARGE_STORAGE_SIZE",message:"Storage size is large",details:{size:n.totalSize}}),r-=10,t.push("Consider archiving old cards"))}return{healthy:r>=70,score:Math.max(0,r),issues:e,recommendations:t,timestamp:new Date}}catch(n){return{healthy:!1,score:0,issues:[{level:"error",code:"HEALTH_CHECK_FAILED",message:"Health check failed",details:{error:n instanceof Error?n.message:String(n)}}],recommendations:["Check storage permissions and browser compatibility"],timestamp:new Date}}}getConfig(){return{...this.config}}async isIndexedDBAvailable(){try{if(typeof window>"u")return console.warn("IndexedDB not available: not in browser environment"),!1;if(!("indexedDB"in window))return console.warn("IndexedDB not available: indexedDB not supported in this browser"),!1;if(!window.indexedDB||typeof window.indexedDB.open!="function")return console.warn("IndexedDB not available: IDBFactory interface not available"),!1;try{const e="cardall_availability_test",t=window.indexedDB.open(e,1);return new Promise(r=>{let n;const o=()=>{n&&clearTimeout(n);try{window.indexedDB.deleteDatabase(e)}catch(i){console.debug("Failed to cleanup test database:",i)}};n=window.setTimeout(()=>{console.warn("IndexedDB availability test timed out"),o(),r(!1)},5e3),t.onerror=i=>{console.warn("IndexedDB availability test failed:",i),o(),r(!1)},t.onblocked=()=>{console.warn("IndexedDB availability test blocked"),o(),r(!1)},t.onsuccess=()=>{const i=t.result;try{i.close(),o(),console.debug("IndexedDB availability test passed"),r(!0)}catch(l){console.warn("Failed to close test database:",l),o(),r(!1)}},t.onupgradeneeded=i=>{console.debug("IndexedDB upgrade needed during availability test")}})}catch(e){return console.warn("IndexedDB availability test error:",e),!1}}catch(e){return console.warn("IndexedDB not available:",e),!1}}async hasIndexedDBData(){try{if(!await this.isIndexedDBAvailable())return console.debug("IndexedDB data check: IndexedDB not available"),!1;try{if(!P.isOpen())try{await P.open()}catch(n){return console.warn("Failed to open database for data check:",n),!1}let t;try{t=await P.cards.count(),console.debug(`IndexedDB card count: ${t}`)}catch(n){return console.warn("Failed to get card count:",n),!1}return t>0||await this.checkOtherDataTables()?!0:(console.debug("IndexedDB data check: no data found"),!1)}catch(t){return console.warn("Database operation failed during data check:",t),!1}}catch(e){return console.warn("Failed to check IndexedDB data:",e),!1}}async checkOtherDataTables(){try{try{const e=await P.folders.count();if(e>0)return console.debug(`Found ${e} folders in IndexedDB`),!0}catch(e){console.debug("Failed to check folders:",e)}try{const e=await P.tags.count();if(e>0)return console.debug(`Found ${e} tags in IndexedDB`),!0}catch(e){console.debug("Failed to check tags:",e)}try{const e=await P.images.count();if(e>0)return console.debug(`Found ${e} images in IndexedDB`),!0}catch(e){console.debug("Failed to check images:",e)}try{const e=await P.settings.count();if(e>0)return console.debug(`Found ${e} settings in IndexedDB`),!0}catch(e){console.debug("Failed to check settings:",e)}return!1}catch(e){return console.debug("Error checking other data tables:",e),!1}}async validateDataIntegrity(e){const t=e||this.storageMode,r=[],n=[];try{console.log(`Validating data integrity for ${t}...`);const o=await this.getCards();if(!Array.isArray(o))return r.push("Cards data is not an array"),{isValid:!1,issues:r,cardCount:0,corruptedCards:n};for(const u of o){const m=this.validateCardStructure(u);m.length>0&&(n.push(u.id||"unknown"),r.push(`Card ${u.id||"unknown"} has issues: ${m.join(", ")}`))}if(t==="indexeddb"){const u=await P.cards.toArray();u.length!==o.length&&r.push(`Card count mismatch: IndexedDB has ${u.length}, adapter returned ${o.length}`)}const i=this.validateTimestamps(o);r.push(...i);const l=r.length===0;return console.log(`Data integrity validation completed: ${l?"PASS":"FAIL"}`),l||console.warn(`Found ${r.length} issues`),{isValid:l,issues:r,cardCount:o.length,corruptedCards:n}}catch(o){const i=`Data integrity validation failed: ${o instanceof Error?o.message:String(o)}`;return r.push(i),console.error(i),{isValid:!1,issues:r,cardCount:0,corruptedCards:n}}}validateCardStructure(e){const t=[];return(!e.id||typeof e.id!="string")&&t.push("Missing or invalid id"),!e.frontContent||typeof e.frontContent!="object"?t.push("Missing or invalid frontContent"):((!e.frontContent.title||typeof e.frontContent.title!="string")&&t.push("Missing or invalid frontContent.title"),typeof e.frontContent.text!="string"&&t.push("Invalid frontContent.text type")),!e.backContent||typeof e.backContent!="object"?t.push("Missing or invalid backContent"):((!e.backContent.title||typeof e.backContent.title!="string")&&t.push("Missing or invalid backContent.title"),typeof e.backContent.text!="string"&&t.push("Invalid backContent.text type")),(!e.createdAt||!(e.createdAt instanceof Date))&&t.push("Missing or invalid createdAt"),(!e.updatedAt||!(e.updatedAt instanceof Date))&&t.push("Missing or invalid updatedAt"),e.style&&typeof e.style!="object"&&t.push("Invalid style type"),e.frontContent.tags&&!Array.isArray(e.frontContent.tags)&&t.push("Invalid frontContent.tags type"),e.backContent.tags&&!Array.isArray(e.backContent.tags)&&t.push("Invalid backContent.tags type"),t}validateTimestamps(e){const t=[];for(const r of e){r.createdAt>new Date&&t.push(`Card ${r.id} has creation date in the future`),r.updatedAt>new Date&&t.push(`Card ${r.id} has update date in the future`),r.updatedAt<r.createdAt&&t.push(`Card ${r.id} has update date before creation date`);const n=new Date("2000-01-01");(r.createdAt<n||r.updatedAt<n)&&t.push(`Card ${r.id} has suspiciously old timestamps`)}return t}async repairDataIntegrity(){console.log("Starting data integrity repair...");const e=[],t=[],r=[];try{const n=await this.validateDataIntegrity();if(n.isValid)return console.log("No integrity issues found"),{repaired:!0,repairedCards:0,issues:[],failedRepairs:[]};console.log(`Found ${n.issues.length} issues to repair`);const o=await this.getCards(),i=[];for(const l of o){const u=this.validateCardStructure(l);if(u.length>0){const m=this.repairCard(l);this.validateCardStructure(m).length===0?(i.push(m),e.push(l.id||"unknown"),console.log(`Successfully repaired card ${l.id}`)):(t.push(l.id||"unknown"),r.push(`Failed to repair card ${l.id}: ${u.join(", ")}`))}else i.push(l)}return i.length!==o.length&&(await this.saveCards(i),console.log(`Repaired ${e.length} cards`)),{repaired:t.length===0,repairedCards:e.length,issues:r,failedRepairs:t}}catch(n){const o=`Data repair failed: ${n instanceof Error?n.message:String(n)}`;return console.error(o),{repaired:!1,repairedCards:0,issues:[o],failedRepairs:e}}}repairCard(e){const t={id:e.id||crypto.randomUUID(),frontContent:{title:e.frontContent?.title||"Untitled",text:e.frontContent?.text||"",tags:Array.isArray(e.frontContent?.tags)?e.frontContent.tags:[]},backContent:{title:e.backContent?.title||"Untitled",text:e.backContent?.text||"",tags:Array.isArray(e.backContent?.tags)?e.backContent.tags:[]},style:typeof e.style=="object"?e.style:{type:"solid"},isFlipped:typeof e.isFlipped=="boolean"?e.isFlipped:!1,createdAt:e.createdAt instanceof Date?e.createdAt:new Date,updatedAt:new Date};return t.createdAt>new Date&&(t.createdAt=new Date),t.updatedAt<t.createdAt&&(t.updatedAt=t.createdAt),t}async updateConfig(e){const{validateStorageConfig:t}=await Ps(async()=>{const{validateStorageConfig:n}=await Promise.resolve().then(()=>Qo);return{validateStorageConfig:n}},void 0),r=t({...this.config,...e});if(!r.valid)throw ce("INVALID_CONFIG","Invalid storage configuration",{errors:r.errors});this.config=r.config}setupEventListeners(){if(this.storageMode==="indexeddb")try{P.cards.hook("creating",(e,t,r)=>{this.emitEvent({type:"cardCreated",timestamp:new Date,data:{cardId:e}})}),P.cards.hook("updating",(e,t,r,n)=>{this.emitEvent({type:"cardUpdated",timestamp:new Date,data:{cardId:t}})}),P.cards.hook("deleting",(e,t,r)=>{this.emitEvent({type:"cardDeleted",timestamp:new Date,data:{cardId:e}})})}catch(e){console.warn("Failed to setup IndexedDB event listeners:",e)}}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}removeEventListener(e,t){const r=this.eventListeners.get(e);if(r){const n=r.indexOf(t);n>-1&&r.splice(n,1)}}emitEvent(e){const t=this.eventListeners.get(e.type);t&&t.forEach(r=>{try{r(e)}catch(n){console.error(`Event listener error for ${e.type}:`,n)}})}}const Zo=Object.freeze(Object.defineProperty({__proto__:null,UniversalStorageAdapter:We},Symbol.toStringTag,{value:"Module"}));class lt{static instance;errorListeners=[];recoveryStrategies=new Map;static getInstance(){return lt.instance||(lt.instance=new lt),lt.instance}onError(e){return this.errorListeners.push(e),()=>{const t=this.errorListeners.indexOf(e);t>-1&&this.errorListeners.splice(t,1)}}registerRecoveryStrategy(e,t){this.recoveryStrategies.set(e,t)}async handleError(e,t){const r=this.normalizeError(e,t);this.errorListeners.forEach(o=>o(r));const n=this.recoveryStrategies.get(r.type);if(n?.canRecover)try{await n.recover()}catch(o){console.error("错误恢复失败:",o)}return r}normalizeError(e,t){if(e instanceof Error){const r=this.classifyError(e),n=this.getSeverity(r),o=this.isRecoverable(e);return{type:r,message:t?`${t}: ${e.message}`:e.message,details:e.stack,timestamp:new Date,recoverable:o,severity:n,userMessage:this.getUserMessage(r),retryCount:0,maxRetries:this.getMaxRetries(r)}}return{type:"UNKNOWN_ERROR",message:t?`${t}: 未知错误`:"未知错误",details:e,timestamp:new Date,recoverable:!1,severity:"critical",userMessage:"发生了未知错误，请联系技术支持",retryCount:0,maxRetries:0}}classifyError(e){const t=e.message.toLowerCase(),r=e.stack?.toLowerCase()||"";return t.includes("storage")||t.includes("localstorage")||t.includes("indexeddb")?t.includes("quota")||t.includes("exceeded")||t.includes("full")||t.includes("quota exceeded")?"STORAGE_QUOTA_ERROR":t.includes("permission")||t.includes("access denied")||t.includes("security")||t.includes("security error")?"STORAGE_PERMISSION_ERROR":t.includes("corruption")||t.includes("corrupted")||t.includes("invalid data")||t.includes("data error")?"STORAGE_CORRUPTION_ERROR":t.includes("read-only")||t.includes("readonly")||t.includes("blocked")?"STORAGE_PERMISSION_ERROR":"STORAGE_TEMPORARY_ERROR":t.includes("network")||t.includes("fetch")||t.includes("ajax")||t.includes("xhr")?t.includes("offline")||t.includes("no internet")||t.includes("connection")||t.includes("networkerror")?"NETWORK_OFFLINE_ERROR":t.includes("timeout")||t.includes("timed out")||t.includes("timeout error")?"NETWORK_TIMEOUT_ERROR":t.includes("server")||t.includes("500")||t.includes("502")||t.includes("503")||t.includes("504")||t.includes("bad gateway")||t.includes("cors")||t.includes("cross-origin")||t.includes("origin")?"NETWORK_SERVER_ERROR":"NETWORK_ERROR":t.includes("validation")||t.includes("invalid")||t.includes("schema")||t.includes("type error")?t.includes("structure")||t.includes("format")||t.includes("unexpected token")||t.includes("syntax error")?"VALIDATION_STRUCTURE_ERROR":t.includes("required")||t.includes("missing")||t.includes("undefined")||t.includes("null")?"VALIDATION_DATA_ERROR":"VALIDATION_ERROR":t.includes("migration")||t.includes("migrate")||t.includes("upgrade")?t.includes("legacy")||t.includes("old version")||t.includes("version mismatch")?"MIGRATION_LEGACY_ERROR":t.includes("version")||t.includes("compatibility")||t.includes("incompatible")?"MIGRATION_VERSION_ERROR":"MIGRATION_ERROR":t.includes("initialization")||t.includes("init")||t.includes("setup")||t.includes("configuration")?"INITIALIZATION_ERROR":r.includes("indexeddb")||r.includes("idb")?t.includes("version")||t.includes("upgrade")?"MIGRATION_VERSION_ERROR":"STORAGE_TEMPORARY_ERROR":t.includes("database")||t.includes("db")||t.includes("transaction")?t.includes("constraint")||t.includes("unique")?"VALIDATION_DATA_ERROR":"STORAGE_TEMPORARY_ERROR":t.includes("memory")||t.includes("heap")||t.includes("out of memory")?"STORAGE_QUOTA_ERROR":t.includes("file")||t.includes("directory")||t.includes("filesystem")?"STORAGE_TEMPORARY_ERROR":"UNKNOWN_ERROR"}isRecoverable(e){const t=e.message.toLowerCase(),n=["quota","permission","access denied","security","critical","readonly","blocked","insufficient","not supported"].some(o=>t.includes(o));return t.includes("temporary")||t.includes("transient")||t.includes("network")&&!t.includes("offline")||t.includes("timeout")?!0:!n}getSeverity(e){switch(e){case"STORAGE_QUOTA_ERROR":case"STORAGE_PERMISSION_ERROR":case"VALIDATION_STRUCTURE_ERROR":case"MIGRATION_VERSION_ERROR":case"UNKNOWN_ERROR":return"critical";case"INITIALIZATION_ERROR":case"STORAGE_CORRUPTION_ERROR":case"NETWORK_SERVER_ERROR":return"high";case"VALIDATION_DATA_ERROR":case"MIGRATION_LEGACY_ERROR":case"MIGRATION_ERROR":return"medium";case"STORAGE_TEMPORARY_ERROR":case"NETWORK_OFFLINE_ERROR":case"NETWORK_TIMEOUT_ERROR":case"NETWORK_ERROR":case"VALIDATION_ERROR":return"low";default:return"low"}}getUserMessage(e){switch(e){case"STORAGE_QUOTA_ERROR":return"存储空间已满。请清理一些旧的卡片或使用浏览器的存储管理功能释放空间。";case"STORAGE_PERMISSION_ERROR":return"无法访问存储。请检查浏览器隐私设置，确保允许网站使用本地存储。";case"STORAGE_CORRUPTION_ERROR":return"检测到数据损坏。系统正在自动修复，请稍候...";case"STORAGE_TEMPORARY_ERROR":return"存储暂时不可用。系统正在重试，请稍等片刻...";case"NETWORK_OFFLINE_ERROR":return"网络连接已断开。请检查您的网络连接，连接后系统会自动同步。";case"NETWORK_TIMEOUT_ERROR":return"网络响应超时。请检查网络连接并稍后重试。";case"NETWORK_SERVER_ERROR":return"服务器暂时不可用。请稍后重试，或联系技术支持。";case"VALIDATION_STRUCTURE_ERROR":return"数据格式有问题。系统正在尝试自动修复...";case"VALIDATION_DATA_ERROR":return"数据内容验证失败。系统正在清理无效数据...";case"MIGRATION_LEGACY_ERROR":return"旧版本数据迁移失败。部分数据可能需要手动重新输入。";case"MIGRATION_VERSION_ERROR":return"版本兼容性问题。请更新应用到最新版本。";case"INITIALIZATION_ERROR":return"系统初始化失败。请刷新页面重试，如持续出现问题请清除浏览器数据。";case"UNKNOWN_ERROR":return"发生了未知错误。请刷新页面重试，如问题持续请联系技术支持。";case"NETWORK_ERROR":return"网络连接出现问题。请检查网络设置后重试。";case"VALIDATION_ERROR":return"数据验证出现问题。系统正在处理...";case"MIGRATION_ERROR":return"数据迁移过程中出现问题。系统正在尝试解决...";default:return"发生了错误，请稍后重试。"}}getMaxRetries(e){switch(e){case"STORAGE_TEMPORARY_ERROR":case"NETWORK_TIMEOUT_ERROR":case"NETWORK_OFFLINE_ERROR":case"NETWORK_ERROR":return 5;case"STORAGE_CORRUPTION_ERROR":case"VALIDATION_DATA_ERROR":case"NETWORK_SERVER_ERROR":return 3;case"VALIDATION_STRUCTURE_ERROR":case"MIGRATION_LEGACY_ERROR":case"MIGRATION_ERROR":case"INITIALIZATION_ERROR":return 2;case"STORAGE_QUOTA_ERROR":case"STORAGE_PERMISSION_ERROR":case"MIGRATION_VERSION_ERROR":return 1;case"UNKNOWN_ERROR":case"VALIDATION_ERROR":return 2;default:return 0}}}const ys=async()=>{try{const a=`_storage_test_${Date.now()}`;if(localStorage.setItem(a,"test"),localStorage.removeItem(a),"indexedDB"in window){const e=indexedDB.open("_storage_test_db",1);await new Promise((t,r)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>r(e.error)}),indexedDB.deleteDatabase("_storage_test_db")}return!0}catch(a){return console.error("存储可用性检查失败:",a),!1}},sa=async()=>{try{const a="card_error_history",e=localStorage.getItem(a);if(e){const n=JSON.parse(e).slice(-20);localStorage.setItem(a,JSON.stringify(n))}const t=Object.keys(localStorage).filter(r=>r.startsWith("_temp_")||r.startsWith("_cache_"));t.forEach(r=>localStorage.removeItem(r)),console.log(`清理了 ${t.length} 个临时项`)}catch(a){throw console.error("存储空间清理失败:",a),a}},aa=async()=>{try{const a=localStorage.getItem("cards");if(a){const t=JSON.parse(a).map(r=>({id:r.id,frontContent:{title:r.frontContent.title,text:r.frontContent.text,tags:r.frontContent.tags,lastModified:r.frontContent.lastModified},backContent:{title:r.backContent.title,text:r.backContent.text,tags:r.backContent.tags,lastModified:r.backContent.lastModified},style:r.style,createdAt:r.createdAt,updatedAt:r.updatedAt}));localStorage.setItem("cards",JSON.stringify(t))}console.log("数据压缩完成")}catch(a){throw console.error("数据压缩失败:",a),a}},ei=async()=>{try{const a=localStorage.getItem("cards");if(!a)return[];const e=JSON.parse(a);if(!Array.isArray(e))return[];const t=e.map(r=>{const n={id:r.id||Date.now().toString(),frontContent:{title:r.frontContent?.title||"未命名卡片",text:r.frontContent?.text||"",images:r.frontContent?.images||[],tags:r.frontContent?.tags||[],lastModified:r.frontContent?.lastModified?new Date(r.frontContent.lastModified):new Date},backContent:{title:r.backContent?.title||"背面",text:r.backContent?.text||"",images:r.backContent?.images||[],tags:r.backContent?.tags||[],lastModified:r.backContent?.lastModified?new Date(r.backContent.lastModified):new Date},style:r.style||{type:"solid",backgroundColor:"#f8fafc",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:r.isFlipped||!1,createdAt:r.createdAt?new Date(r.createdAt):new Date,updatedAt:r.updatedAt?new Date(r.updatedAt):new Date};return r.folderId&&(n.folderId=r.folderId),n});return localStorage.setItem("cards",JSON.stringify(t)),t}catch(a){return console.error("localStorage数据修复失败:",a),[]}},ti=async()=>{try{return"indexedDB"in window?new Promise((a,e)=>{const t=indexedDB.open("CardAllDB",1);t.onsuccess=()=>{const r=t.result,i=r.transaction(["cards"],"readonly").objectStore("cards").getAll();i.onsuccess=()=>{const l=i.result||[];r.close(),a(l)},i.onerror=()=>{r.close(),e(i.error)}},t.onerror=()=>{e(t.error)}}):[]}catch(a){return console.error("IndexedDB数据恢复失败:",a),[]}},si=async()=>{try{if("caches"in window){const e=await(await caches.open("cardall-data")).match("/cards-data");if(e)return(await e.json()).cards||[]}return[]}catch(a){return console.error("浏览器缓存恢复失败:",a),[]}},Me=a=>{try{return a&&typeof a.id=="string"&&a.frontContent&&typeof a.frontContent.title=="string"&&a.backContent&&typeof a.backContent.title=="string"&&a.style&&a.createdAt&&a.updatedAt}catch{return!1}},ws=async a=>a.map(e=>{const t={id:e.id||Date.now().toString(),frontContent:{title:e.frontContent?.title||"修复的卡片",text:e.frontContent?.text||"",images:Array.isArray(e.frontContent?.images)?e.frontContent.images:[],tags:Array.isArray(e.frontContent?.tags)?e.frontContent.tags:[],lastModified:e.frontContent?.lastModified?new Date(e.frontContent.lastModified):new Date},backContent:{title:e.backContent?.title||"背面",text:e.backContent?.text||"",images:Array.isArray(e.backContent?.images)?e.backContent.images:[],tags:Array.isArray(e.backContent?.tags)?e.backContent.tags:[],lastModified:e.backContent?.lastModified?new Date(e.backContent.lastModified):new Date},style:e.style||{type:"solid",backgroundColor:"#f8fafc",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:typeof e.isFlipped=="boolean"?e.isFlipped:!1,createdAt:e.createdAt?new Date(e.createdAt):new Date,updatedAt:new Date};return e.folderId&&(t.folderId=e.folderId),t}),bs=async()=>{try{const a=Date.now(),e=await fetch("/api/health",{method:"HEAD",cache:"no-cache"}),t=Date.now()-a;return{success:e.ok,latency:t}}catch{try{const e=Date.now(),t=await fetch("/",{method:"HEAD",cache:"no-cache"}),r=Date.now()-e;return{success:t.ok,latency:r}}catch{return{success:!1}}}},ai=async()=>{try{const a=await fetch("/api/status",{method:"GET",headers:{"Content-Type":"application/json"}});return a.ok?{success:!0,message:(await a.json()).message||"服务器正常"}:{success:!1,message:`服务器响应错误: ${a.status}`}}catch{return{success:!1,message:"无法连接到服务器"}}},ri=[{id:"1",frontContent:{title:"React Best Practices",text:"Key principles for writing maintainable React code including component composition, state management, and performance optimization.",images:[],tags:["react","frontend","best-practices"],lastModified:new Date},backContent:{title:"Implementation Details",text:"Use functional components with hooks, implement proper error boundaries, optimize with React.memo and useMemo for expensive calculations.",images:[],tags:["react","frontend","best-practices"],lastModified:new Date},style:{type:"solid",backgroundColor:"#f8fafc",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:!1,createdAt:new Date("2024-01-15"),updatedAt:new Date("2024-01-15")},{id:"2",frontContent:{title:"TypeScript Tips",text:"Advanced TypeScript patterns for better type safety and developer experience in large applications.",images:[],tags:["typescript","types","development"],lastModified:new Date},backContent:{title:"Advanced Patterns",text:"Utility types, conditional types, mapped types, and template literal types for complex type transformations.",images:[],tags:["typescript","types","development"],lastModified:new Date},style:{type:"gradient",gradientColors:["#667eea","#764ba2"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"xl",shadow:"lg",borderWidth:0},isFlipped:!1,createdAt:new Date("2024-01-16"),updatedAt:new Date("2024-01-16")}];function ni(){const[a,e]=d.useState([]),[t,r]=d.useState(!1),[n,o]=d.useState({searchTerm:"",tags:[]}),[i,l]=d.useState({layout:"grid",cardSize:"medium",showTags:!0,showDates:!1,sortBy:"updated",sortOrder:"desc"}),[u,m]=d.useState([]),[c,x]=d.useState(null),[h,f]=d.useState([]),[C,j]=d.useState(!1),[N,v]=d.useState(!1),[g,p]=d.useState(null),y=lt.getInstance(),b=We.getInstance();d.useEffect(()=>{const R=y.onError(S=>{if(x(S),f(U=>[...U.slice(-9),S]),S.userMessage)switch(S.severity){case"critical":console.error("严重错误:",S.userMessage);break;case"high":console.warn("高级别错误:",S.userMessage);break;case"medium":console.warn("中等级别错误:",S.userMessage);break;case"low":console.info("低级别错误:",S.userMessage);break}});y.registerRecoveryStrategy("STORAGE_TEMPORARY_ERROR",{canRecover:!0,maxRetries:3,retryDelay:1e3,recover:async()=>{console.log("尝试恢复临时存储错误...");try{if(!await ys())throw new Error("存储不可用");await sa(),await new Promise(U=>setTimeout(U,1e3))}catch(S){throw console.error("临时存储恢复失败:",S),S}},fallback:()=>{console.log("临时存储恢复失败，使用空数据"),e([])},shouldUseMock:!1}),y.registerRecoveryStrategy("STORAGE_CORRUPTION_ERROR",{canRecover:!0,maxRetries:2,retryDelay:500,recover:async()=>{console.log("尝试修复数据损坏...");try{let S=[];const U=await ei();if(U.length>0&&(S=U),S.length===0){const J=await ti();J.length>0&&(S=J)}if(S.length===0){const J=await si();J.length>0&&(S=J)}if(S.length>0)e(S),console.log(`成功恢复 ${S.length} 张卡片`);else throw new Error("无法从任何来源恢复数据")}catch(S){throw console.error("数据修复失败:",S),S}},fallback:()=>{console.log("数据修复失败，使用空数据"),e([])},shouldUseMock:!1}),y.registerRecoveryStrategy("VALIDATION_DATA_ERROR",{canRecover:!0,maxRetries:2,retryDelay:300,recover:async()=>{console.log("尝试修复数据验证错误...");try{const S=a.filter(U=>!Me(U));if(S.length>0){console.log(`发现 ${S.length} 张无效卡片，尝试修复...`);const U=await ws(S);e(J=>J.map(ue=>U.find(he=>he.id===ue.id)||ue)),console.log(`成功修复 ${U.length} 张卡片`)}}catch(S){throw console.error("数据验证修复失败:",S),S}},fallback:()=>{console.log("数据验证修复失败，移除无效卡片"),e(S=>S.filter(U=>Me(U)))},shouldUseMock:!1}),y.registerRecoveryStrategy("NETWORK_TIMEOUT_ERROR",{canRecover:!0,maxRetries:3,retryDelay:2e3,recover:async()=>{console.log("网络超时恢复策略...");try{if(!navigator.onLine)throw new Error("网络离线");if(!(await bs()).success)throw new Error("网络连接测试失败");console.log("网络连接已恢复")}catch(S){throw console.error("网络恢复失败:",S),S}},shouldUseMock:!1}),y.registerRecoveryStrategy("NETWORK_OFFLINE_ERROR",{canRecover:!0,maxRetries:3,retryDelay:3e3,recover:async()=>{console.log("网络离线恢复策略...");try{let S=0;const U=10;for(;S<U;){if(navigator.onLine&&(await bs()).success){console.log("网络连接已恢复");return}S++,await new Promise(J=>setTimeout(J,1e3))}throw new Error("网络连接未在预期时间内恢复")}catch(S){throw console.error("网络离线恢复失败:",S),S}},shouldUseMock:!1}),y.registerRecoveryStrategy("STORAGE_QUOTA_ERROR",{canRecover:!0,maxRetries:1,retryDelay:1e3,recover:async()=>{console.log("存储配额错误恢复策略...");try{await sa(),await aa(),console.log("存储空间清理完成")}catch(S){throw console.error("存储配额恢复失败:",S),S}},fallback:()=>{console.log("存储空间不足，建议清理数据或使用云端同步"),alert("存储空间不足，请清理一些数据或使用云端同步功能")},shouldUseMock:!1}),y.registerRecoveryStrategy("INITIALIZATION_ERROR",{canRecover:!0,maxRetries:2,retryDelay:1e3,recover:async()=>{console.log("初始化错误恢复策略...");try{await b.reinitialize(),await E(),console.log("初始化恢复成功")}catch(S){throw console.error("初始化恢复失败:",S),S}},shouldUseMock:!1}),y.registerRecoveryStrategy("NETWORK_SERVER_ERROR",{canRecover:!0,maxRetries:3,retryDelay:2e3,recover:async()=>{console.log("服务器错误恢复策略...");try{if(await new Promise(U=>setTimeout(U,2e3)),!(await ai()).success)throw new Error("服务器仍然不可用");console.log("服务器连接已恢复")}catch(S){throw console.error("服务器恢复失败:",S),S}},shouldUseMock:!1});const D=async S=>{console.log("存储数据变更:",S),S.type==="cardsChanged"&&S.data?.externalChange&&(console.log("检测到外部数据变更，重新加载..."),await E()),S.type==="cardsChanged"&&p(new Date)};return b.addEventListener("cardsChanged",D),b.addEventListener("cardCreated",D),b.addEventListener("cardUpdated",D),b.addEventListener("cardDeleted",D),()=>{R(),b.removeEventListener("cardsChanged",D),b.removeEventListener("cardCreated",D),b.removeEventListener("cardUpdated",D),b.removeEventListener("cardDeleted",D)}},[b]);const E=d.useCallback(async()=>{j(!0);try{let R=[],D=0;const S=3;for(;D<S;)try{R=await b.getCards();break}catch(U){if(D++,D===S)throw U;console.warn(`第 ${D} 次加载失败，等待重试...`),await new Promise(J=>setTimeout(J,1e3*D))}if(R.length>0){const U=R.filter(Me);U.length!==R.length&&console.warn(`发现 ${R.length-U.length} 张无效卡片，已过滤`),e(U),console.log(`成功加载 ${U.length} 张有效卡片 (使用 ${b.getStorageMode()} 存储模式)`)}else console.log("没有找到数据，使用空数组"),e([]);r(!0)}catch(R){console.error("加载数据失败:",R),await y.handleError(R,"加载卡片数据失败");try{console.log("尝试回退到DataConverterAdapter...");const D=ke.loadFromLocalStorage();if(D.length>0){const S=D.filter(Me);e(S),console.log(`回退加载成功：${S.length} 张有效卡片`)}else e([])}catch(D){console.error("回退加载也失败:",D),await y.handleError(D,"回退加载失败"),e([])}r(!0)}finally{j(!1)}},[y]),w=d.useCallback(async()=>{if(!(!c||!c.recoverable)){j(!0),v(!0);try{const R=y.recoveryStrategies.get(c.type);if(R?.canRecover){const D=R.maxRetries||c.maxRetries||1,S=R.retryDelay||1e3;let U=null;for(let J=1;J<=D;J++)try{console.log(`尝试恢复 ${c.type} - 第 ${J} 次`),await R.recover(),await E(),x(null),console.log(`错误恢复成功：${c.type}`);break}catch(ue){if(U=ue,console.error(`恢复失败，第 ${J} 次尝试:`,ue),J<D){const me=S*Math.pow(2,J-1);console.log(`等待 ${me}ms 后重试...`),await new Promise(he=>setTimeout(he,me))}}U&&R.fallback&&(console.log("所有恢复尝试失败，执行fallback策略"),R.fallback()),c&&R.shouldUseMock&&a.length===0&&(console.warn("所有恢复策略失败，使用mock数据作为最后手段"),e(ri),x(null))}else console.warn(`错误类型 ${c.type} 没有可用的恢复策略`)}catch(R){console.error("错误恢复过程中发生异常:",R);const D=y.recoveryStrategies.get(c.type)?.fallback;D&&D()}finally{j(!1)}}},[c,y,a.length,E]),k=d.useCallback(()=>{const R=a.filter(D=>{if(n.searchTerm){const S=n.searchTerm.toLowerCase(),U=D.frontContent.title.toLowerCase().includes(S)||D.backContent.title.toLowerCase().includes(S),J=D.frontContent.text.toLowerCase().includes(S)||D.backContent.text.toLowerCase().includes(S),ue=[...D.frontContent.tags,...D.backContent.tags].some(me=>me.toLowerCase().includes(S));if(!U&&!J&&!ue)return!1}if(n.tags.length>0){const S=[...D.frontContent.tags,...D.backContent.tags];if(!n.tags.some(U=>S.includes(U)))return!1}if(n.folderId&&D.folderId!==n.folderId)return!1;if(n.dateRange){const S=new Date(D.updatedAt);if(S<n.dateRange.start||S>n.dateRange.end)return!1}return!(n.styleType&&D.style.type!==n.styleType||n.hasImages!==void 0&&(D.frontContent.images.length>0||D.backContent.images.length>0)!==n.hasImages)});return R.sort((D,S)=>{let U=0;switch(i.sortBy){case"created":U=new Date(D.createdAt).getTime()-new Date(S.createdAt).getTime();break;case"updated":U=new Date(D.updatedAt).getTime()-new Date(S.updatedAt).getTime();break;case"title":U=D.frontContent.title.localeCompare(S.frontContent.title);break;default:U=0}return i.sortOrder==="desc"?-U:U}),R},[a,n,i]),T=d.useCallback(R=>{e(D=>{switch(R.type){case"CREATE_CARD":{const S={...R.payload,id:Date.now().toString(),createdAt:new Date,updatedAt:new Date};return[...D,S]}case"UPDATE_CARD":return D.map(S=>S.id===R.payload.id?{...S,...R.payload.updates,updatedAt:new Date}:S);case"DELETE_CARD":return D.filter(S=>S.id!==R.payload);case"FLIP_CARD":return D.map(S=>S.id===R.payload?{...S,isFlipped:!S.isFlipped,updatedAt:new Date}:S);case"SELECT_CARD":return m(S=>S.includes(R.payload)?S.filter(U=>U!==R.payload):[...S,R.payload]),D;case"DESELECT_ALL":return m([]),D;case"DUPLICATE_CARD":{const S=D.find(J=>J.id===R.payload);if(!S)return D;const U={...S,id:Date.now().toString(),createdAt:new Date,updatedAt:new Date};return[...D,U]}case"MOVE_TO_FOLDER":return D.map(U=>U.id===R.payload.cardId?{...U,folderId:R.payload.folderId,updatedAt:new Date}:U);default:return D}})},[]),$=d.useCallback(R=>a.find(D=>D.id===R),[a]),A=d.useCallback(()=>a.filter(R=>u.includes(R.id)),[a,u]),G=d.useCallback(()=>{const R=new Set;return a.forEach(D=>{D.frontContent.tags.forEach(S=>R.add(S)),D.backContent.tags.forEach(S=>R.add(S))}),Array.from(R).sort()},[a]),te=d.useCallback((R,D)=>{e(S=>S.map(U=>{const J=he=>D?he.map(pe=>pe===R?D:pe):he.filter(pe=>pe!==R),ue=J(U.frontContent.tags),me=J(U.backContent.tags);return JSON.stringify(ue)!==JSON.stringify(U.frontContent.tags)||JSON.stringify(me)!==JSON.stringify(U.backContent.tags)?{...U,frontContent:{...U.frontContent,tags:ue,lastModified:new Date},backContent:{...U.backContent,tags:me,lastModified:new Date},updatedAt:new Date}:U}))},[]),W=d.useCallback(R=>a.filter(D=>D.frontContent.tags.includes(R)||D.backContent.tags.includes(R)),[a]);d.useEffect(()=>{if(t)return;(async()=>{j(!0);try{const D=await b.getCards();if(D.length>0)e(D),console.log(`成功加载 ${D.length} 张卡片 (使用 ${b.getStorageMode()} 存储模式)`);else try{console.log("尝试从localStorage加载数据...");const S=ke.loadFromLocalStorage();S.length>0?(e(S),console.log(`从localStorage加载 ${S.length} 张卡片`),await b.saveCards(S),console.log("数据已迁移到UniversalStorageAdapter")):(console.log("没有找到数据，使用空数组"),e([]))}catch(S){console.warn("从localStorage加载失败:",S),e([])}r(!0)}catch(D){console.error("加载卡片数据失败:",D),await y.handleError(D,"加载卡片数据失败"),await w()}finally{j(!1)}})()},[t,y,w,b]),d.useEffect(()=>{if(!t||C)return;const R=setTimeout(async()=>{try{const D=a.filter(J=>!Me(J));if(D.length>0){console.warn(`发现 ${D.length} 张无效卡片，保存前尝试修复...`);const J=await ws(D);J.length>0&&e(ue=>ue.map(me=>J.find(pe=>pe.id===me.id)||me))}let S=0;const U=2;for(;S<U;)try{await b.saveCards(a),console.log(`自动保存成功：${a.length} 张卡片 (使用 ${b.getStorageMode()} 存储模式)`);break}catch(J){if(S++,S===U)throw J;console.warn(`第 ${S} 次保存失败，等待重试...`),await new Promise(ue=>setTimeout(ue,500*S))}}catch(D){console.error("保存卡片到持久化存储失败:",D),await y.handleError(D,"保存卡片数据失败");try{console.log("尝试回退到DataConverterAdapter..."),ke.saveToLocalStorage(a),console.log("回退保存成功")}catch(S){console.error("回退保存也失败:",S),await y.handleError(S,"回退保存失败")}}},2e3);return()=>clearTimeout(R)},[a,t,C,y,b]);const ee={performPreventiveChecks:async()=>{try{if(!await ys())return console.warn("存储空间检查失败，可能即将出现问题"),!1;navigator.onLine&&((await bs()).success||console.warn("网络连接不稳定，可能影响数据同步"));const D=a.filter(S=>!Me(S));return D.length>0&&console.warn(`发现 ${D.length} 张无效卡片，建议修复`),!0}catch(R){return console.error("预防性检查失败:",R),!1}},analyzeErrorTrends:()=>{const R=h.slice(-10),D=h.slice(-20,-10);if(R.length===0)return{trend:"improving",suggestions:["错误率正常，继续保持"]};const S=new Map;R.forEach(he=>{const pe=S.get(he.type)||0;S.set(he.type,pe+1)});const U=[];S.forEach((he,pe)=>{if(he>2)switch(pe){case"STORAGE_TEMPORARY_ERROR":U.push("频繁的存储临时错误，建议检查存储设备");break;case"NETWORK_TIMEOUT_ERROR":U.push("网络超时频繁，建议检查网络连接");break;case"VALIDATION_DATA_ERROR":U.push("数据验证错误增多，建议检查数据源");break}});const J=R.length,ue=D.length;let me="stable";return J<ue?me="improving":J>ue&&(me="worsening"),U.length===0&&U.push("系统运行正常，继续保持"),{trend:me,suggestions:U}},runMaintenanceTasks:async()=>{try{console.log("开始运行维护任务..."),h.length>50&&(f(S=>S.slice(-30)),console.log("清理了错误历史记录")),await ys()||(await aa(),console.log("执行了数据压缩"));const D=a.filter(S=>!Me(S));if(D.length>0){const S=await ws(D);S.length>0&&console.log(`修复了 ${S.length} 张无效卡片`)}console.log("维护任务完成")}catch(R){console.error("维护任务执行失败:",R)}}},[ae,re]=d.useState(new Set),fe=d.useCallback(R=>(re(D=>new Set(D).add(R)),()=>{re(D=>{const S=new Set(D);return S.delete(R),S})}),[]),z=d.useCallback((R,D)=>{ae.forEach(S=>{try{S(R,D)}catch(U){console.error("数据变更监听器执行失败:",U)}})},[ae]),Y=d.useCallback(async(R=!1)=>{if(!R&&t&&a.length>0)return a;j(!0);try{let D=[];try{D=await b.getCards(),D.length>0&&console.log(`从UniversalStorageAdapter加载 ${D.length} 张卡片`)}catch(U){console.warn("UniversalStorageAdapter加载失败，尝试回退:",U)}if(D.length===0)try{const U=ke.loadFromLocalStorage();U.length>0&&(D=U,console.log(`从localStorage加载 ${U.length} 张卡片`),await b.saveCards(U))}catch(U){console.warn("localStorage加载失败:",U)}const S=D.filter(Me);return S.length!==D.length&&console.warn(`过滤了 ${D.length-S.length} 张无效卡片`),e(S),r(!0),z("cardsLoaded",{cardCount:S.length}),S}catch(D){return console.error("加载卡片失败:",D),await y.handleError(D,"loadCards失败"),e([]),r(!0),[]}finally{j(!1)}},[t,a.length,b,y,z]),M=d.useCallback(async(R=a)=>{try{const D=R.filter(J=>!Me(J));D.length>0&&console.warn(`保存前发现 ${D.length} 张无效卡片`);const S=R.filter(Me);return await b.saveCards(S)?(console.log(`成功保存 ${S.length} 张卡片`),z("cardsSaved",{cardCount:S.length}),!0):!1}catch(D){console.error("保存卡片失败:",D),await y.handleError(D,"saveCards失败");try{return ke.saveToLocalStorage(R),console.log("回退保存成功"),!0}catch(S){return console.error("回退保存失败:",S),!1}}},[a,b,y,z]),F=d.useCallback(async(R,D)=>{j(!0);try{console.log(`开始批量操作: ${D}`);for(let S=0;S<R.length;S++)try{await R[S]()}catch(U){throw console.error(`批量操作第 ${S+1} 步失败:`,U),U}return await M(),console.log(`批量操作完成: ${D}`),z("batchOperationCompleted",{description:D,operationCount:R.length}),!0}catch(S){return console.error(`批量操作失败: ${D}`,S),await y.handleError(S,`批量操作失败: ${D}`),!1}finally{j(!1)}},[M,y,z]);d.useEffect(()=>{if(!t)return;const R=setInterval(async()=>{try{await ee.runMaintenanceTasks()}catch(S){console.error("定期维护任务失败:",S)}},5*60*1e3),D=setInterval(async()=>{try{await ee.performPreventiveChecks()}catch(S){console.error("预防性检查失败:",S)}},30*1e3);return()=>{clearInterval(R),clearInterval(D)}},[t,ee]);const I=d.useCallback(async()=>{if(!c||!c.recoverable)return!1;console.log("开始增强的错误恢复流程..."),j(!0);try{const R=y.recoveryStrategies.get(c.type);return R?.canRecover?(await R.recover(),await E(),x(null),console.log("错误恢复成功"),!0):!1}catch(R){return console.error("错误恢复失败:",R),!1}finally{j(!1)}},[c,y,E]),H=d.useCallback(()=>{if(!c)return null;switch(c.severity){case"critical":return{level:"critical",message:"严重错误，需要立即关注"};case"high":return{level:"high",message:"高级别错误，建议尽快处理"};case"medium":return{level:"medium",message:"中等级别错误，可以稍后处理"};case"low":return{level:"low",message:"低级别错误，可以忽略"};default:return null}},[c]),q=d.useCallback(()=>c?c.userMessage||c.message:null,[c]),B=d.useCallback(()=>{},[]);return{cards:k(),allCards:a,filter:n,setFilter:o,viewSettings:i,setViewSettings:l,selectedCardIds:u,dispatch:T,getCardById:$,getSelectedCards:A,getAllTags:G,updateTagsInAllCards:te,getCardsWithTag:W,isInitialized:t,error:c,errorHistory:h,isLoading:C,recoveryAttempted:N,recoverFromError:w,reloadData:E,clearError:()=>x(null),clearErrorHistory:()=>f([]),lastSyncTime:g,getUserErrorMessage:q,getErrorSeverityInfo:H,errorPrevention:ee,loadCards:Y,saveCards:M,onDataChange:fe,performBatchOperation:F,enhancedRecoverFromError:I,useMockDataForDevelopment:B}}class oi{config;directoryHandle=null;isSupported;constructor(){this.config={baseDirectory:"CardAll",imageDirectory:"images",tempDirectory:"temp",cacheDirectory:"cache"},this.isSupported="showDirectoryPicker"in window}isFileSystemAccessSupported(){return this.isSupported}async requestDirectoryAccess(){if(!this.isSupported)return console.warn("File System Access API not supported, using fallback storage"),this.saveStorageStrategy("indexeddb"),!1;try{return this.directoryHandle=await window.showDirectoryPicker({mode:"readwrite",startIn:"documents"}),await this.ensureDirectoryStructure(),this.saveStorageStrategy("filesystem"),!0}catch(e){return e.name==="AbortError"?console.log("User cancelled directory selection, using fallback storage"):console.error("Failed to access directory:",e),this.saveStorageStrategy("indexeddb"),!1}}async saveStorageStrategy(e){try{await P.settings.put({key:"storageStrategy",value:e,updatedAt:new Date,scope:"global"})}catch(t){console.error("Failed to save storage strategy:",t)}}async getStorageStrategy(){try{return(await P.settings.get("storageStrategy"))?.value||"indexeddb"}catch{return"indexeddb"}}async ensureDirectoryStructure(){if(this.directoryHandle)try{await this.getOrCreateDirectory(this.config.imageDirectory),await this.getOrCreateDirectory(this.config.tempDirectory),await this.getOrCreateDirectory(this.config.cacheDirectory),console.log("Directory structure created successfully")}catch(e){console.error("Failed to create directory structure:",e)}}async getOrCreateDirectory(e){if(!this.directoryHandle)throw new Error("No directory handle available");try{return await this.directoryHandle.getDirectoryHandle(e)}catch{return await this.directoryHandle.getDirectoryHandle(e,{create:!0})}}async getOrCreateNestedDirectory(e){if(!this.directoryHandle)throw new Error("No directory handle available");const t=e.split("/");let r=this.directoryHandle;for(const n of t)if(n)try{r=await r.getDirectoryHandle(n)}catch{r=await r.getDirectoryHandle(n,{create:!0})}return r}generateImagePath(e,t){const r=t||"uncategorized";return`${this.config.imageDirectory}/${r}/${e}`}async saveImage(e,t,r){const n=`img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o=`${n}.webp`,l=`${this.generateImagePath(t,r)}/${o}`;try{const u=await this.processImage(e),m=await this.getImageMetadata(e,u);this.isSupported&&this.directoryHandle?await this.saveToFileSystem(l,u):await this.saveToIndexedDB(l,u);const c={id:n,cardId:t,fileName:o,filePath:l,metadata:m,createdAt:new Date,syncVersion:1,pendingSync:!0};return await P.images.add(c),{id:n,fileName:o,filePath:l,metadata:m}}catch(u){throw console.error("Failed to save image:",u),u}}async processImage(e){return new Promise((t,r)=>{const n=document.createElement("canvas"),o=n.getContext("2d"),i=new Image;i.onload=()=>{try{let{width:m,height:c}=i;if(m>1920||c>1080){const x=Math.min(1920/m,1080/c);m*=x,c*=x}n.width=m,n.height=c,o?.drawImage(i,0,0,m,c),n.toBlob(x=>{x?t(x):r(new Error("Failed to convert image"))},"image/webp",.8)}catch(l){r(l)}},i.onerror=()=>r(new Error("Failed to load image")),i.src=URL.createObjectURL(e)})}async getImageMetadata(e,t){return new Promise(r=>{const n=new Image;n.onload=()=>{r({originalName:e.name,size:t.size,width:n.width,height:n.height,format:"webp",compressed:!0})},n.src=URL.createObjectURL(t)})}async saveToFileSystem(e,t){if(!this.directoryHandle)throw new Error("No directory handle available");const r=e.split("/"),n=r.pop(),o=r.join("/"),u=await(await(await this.getOrCreateNestedDirectory(o)).getFileHandle(n,{create:!0})).createWritable();await u.write(t),await u.close()}async saveToIndexedDB(e,t){await t.arrayBuffer();const r=await this.blobToBase64(t);localStorage.setItem(`cardall_file_${e}`,r)}blobToBase64(e){return new Promise((t,r)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=r,n.readAsDataURL(e)})}async getImage(e){try{return this.isSupported&&this.directoryHandle?await this.getFromFileSystem(e):await this.getFromIndexedDB(e)}catch(t){throw console.error("Failed to get image:",t),t}}async getFromFileSystem(e){if(!this.directoryHandle)throw new Error("No directory handle available");const t=e.split("/"),r=t.pop(),n=t.join("/"),l=await(await(await this.getOrCreateNestedDirectory(n)).getFileHandle(r)).getFile();return URL.createObjectURL(l)}async getFromIndexedDB(e){const t=localStorage.getItem(`cardall_file_${e}`);if(!t)throw new Error("Image not found in storage");return t}async deleteImage(e){try{this.isSupported&&this.directoryHandle?await this.deleteFromFileSystem(e):await this.deleteFromIndexedDB(e),await P.images.where("filePath").equals(e).delete()}catch(t){throw console.error("Failed to delete image:",t),t}}async deleteFromFileSystem(e){if(this.directoryHandle)try{const t=e.split("/"),r=t.pop(),n=t.join("/");await(await this.getOrCreateNestedDirectory(n)).removeEntry(r)}catch(t){console.warn("Failed to delete file from filesystem:",t)}}async deleteFromIndexedDB(e){localStorage.removeItem(`cardall_file_${e}`)}async getStorageStats(){const e=await P.images.toArray(),t=e.reduce((r,n)=>r+n.metadata.size,0);return{totalImages:e.length,totalSize:t,storageMode:this.isSupported&&this.directoryHandle?"filesystem":"indexeddb"}}}const et=new oi,ii=a=>{const{userId:e,syncVersion:t,lastSyncAt:r,pendingSync:n,...o}=a;return{...o,id:o.id||"",createdAt:new Date(o.createdAt),updatedAt:new Date(o.updatedAt)}},vs=()=>Ee.getCurrentUser()?.id||null;function li(){const[a,e]=d.useState([]),[t,r]=d.useState({searchTerm:"",tags:[]}),[n,o]=d.useState({layout:"grid",cardSize:"medium",showTags:!0,showDates:!1,sortBy:"updated",sortOrder:"desc"}),[i,l]=d.useState([]),[u,m]=d.useState(!0),c=d.useCallback(async()=>{try{m(!0);const y=(await P.cards.toArray()).map(ii);e(y)}catch(p){console.error("Failed to load cards:",p)}finally{m(!1)}},[]);d.useEffect(()=>{c()},[c]),d.useEffect(()=>{const p=P.cards.hook("creating",(E,w,k)=>{console.log("Card creating:",E)}),y=P.cards.hook("updating",(E,w,k,T)=>{console.log("Card updating:",w)}),b=P.cards.hook("deleting",(E,w,k)=>{console.log("Card deleting:",E)});return()=>{p?.unsubscribe(),y?.unsubscribe(),b?.unsubscribe()}},[]);const x=d.useCallback(()=>{const p=a.filter(y=>{if(t.searchTerm){const b=t.searchTerm.toLowerCase(),E=y.frontContent.title.toLowerCase().includes(b)||y.backContent.title.toLowerCase().includes(b),w=y.frontContent.text.toLowerCase().includes(b)||y.backContent.text.toLowerCase().includes(b),k=[...y.frontContent.tags,...y.backContent.tags].some(T=>T.toLowerCase().includes(b));if(!E&&!w&&!k)return!1}if(t.tags.length>0){const b=[...y.frontContent.tags,...y.backContent.tags];if(!t.tags.some(E=>b.includes(E)))return!1}if(t.folderId&&y.folderId!==t.folderId)return!1;if(t.dateRange){const b=new Date(y.updatedAt);if(b<t.dateRange.start||b>t.dateRange.end)return!1}return!(t.styleType&&y.style.type!==t.styleType||t.hasImages!==void 0&&(y.frontContent.images.length>0||y.backContent.images.length>0)!==t.hasImages)});return p.sort((y,b)=>{let E=0;switch(n.sortBy){case"created":E=new Date(y.createdAt).getTime()-new Date(b.createdAt).getTime();break;case"updated":E=new Date(y.updatedAt).getTime()-new Date(b.updatedAt).getTime();break;case"title":E=y.frontContent.title.localeCompare(b.frontContent.title);break;default:E=0}return n.sortOrder==="desc"?-E:E}),p},[a,t,n]),h=d.useCallback(async p=>{const y=vs();try{switch(p.type){case"CREATE_CARD":{const b=crypto.randomUUID(),E={...p.payload,id:b,userId:y,createdAt:new Date,updatedAt:new Date,syncVersion:1,pendingSync:!0};await P.cards.add(E),await Ie.addOperation({type:"create",entity:"card",entityId:b,data:E,priority:"normal"}),await c();break}case"UPDATE_CARD":{const b={...p.payload.updates,userId:y,updatedAt:new Date,syncVersion:1,pendingSync:!0};await P.cards.update(p.payload.id,b),await Ie.addOperation({type:"update",entity:"card",entityId:p.payload.id,data:{...p.payload.updates,userId:y},priority:"normal"}),await c();break}case"DELETE_CARD":{const b=await P.cards.get(p.payload);if(b){const E=[...b.frontContent.images,...b.backContent.images];for(const w of E)if(w.url&&!w.url.startsWith("data:"))try{await et.deleteImage(w.url)}catch(k){console.warn("Failed to delete image:",k)}}await P.cards.delete(p.payload),await Ie.addOperation({type:"delete",entity:"card",entityId:p.payload,data:{userId:y},priority:"high"}),await c();break}case"FLIP_CARD":{const b=await P.cards.get(p.payload);if(b){const E={isFlipped:!b.isFlipped,updatedAt:new Date,syncVersion:(b.syncVersion||0)+1,pendingSync:!0};await P.cards.update(p.payload,E),await Ie.addOperation({type:"update",table:"cards",data:E,localId:p.payload}),await c()}break}case"SELECT_CARD":l(b=>b.includes(p.payload)?b.filter(E=>E!==p.payload):[...b,p.payload]);break;case"DESELECT_ALL":l([]);break;case"DUPLICATE_CARD":{const b=await P.cards.get(p.payload);if(b){const E=crypto.randomUUID(),w={...b,id:E,userId:y,createdAt:new Date,updatedAt:new Date,syncVersion:1,pendingSync:!0};await P.cards.add(w),await Ie.addOperation({type:"create",table:"cards",data:w,localId:E}),await c()}break}case"MOVE_TO_FOLDER":{const b={folderId:p.payload.folderId,userId:y,updatedAt:new Date,syncVersion:1,pendingSync:!0};await P.cards.update(p.payload.cardId,b),await Ie.addOperation({type:"update",table:"cards",data:b,localId:p.payload.cardId}),await c();break}default:console.warn("Unknown card action:",p)}}catch(b){throw console.error("Card operation failed:",b),b}},[c]),f=d.useCallback(p=>a.find(y=>y.id===p),[a]),C=d.useCallback(()=>a.filter(p=>i.includes(p.id)),[a,i]),j=d.useCallback(()=>{const p=new Set;return a.forEach(y=>{y.frontContent.tags.forEach(b=>p.add(b)),y.backContent.tags.forEach(b=>p.add(b))}),Array.from(p).sort()},[a]),N=d.useCallback(async(p,y)=>{const b=vs();try{const E=await P.cards.filter(w=>w.frontContent.tags.includes(p)||w.backContent.tags.includes(p)).toArray();for(const w of E){const k=G=>y?G.map(te=>te===p?y:te):G.filter(te=>te!==p),T=k(w.frontContent.tags),$=k(w.backContent.tags),A={frontContent:{...w.frontContent,tags:T,lastModified:new Date},backContent:{...w.backContent,tags:$,lastModified:new Date},userId:b,updatedAt:new Date,syncVersion:(w.syncVersion||0)+1,pendingSync:!0};await P.cards.update(w.id,A),await Ie.addOperation({type:"update",table:"cards",data:A,localId:w.id})}await c()}catch(E){throw console.error("Failed to update tags in cards:",E),E}},[c]),v=d.useCallback(p=>a.filter(y=>y.frontContent.tags.includes(p)||y.backContent.tags.includes(p)),[a]),g=d.useCallback(async(p,y)=>{const b=vs();try{const E=await P.cards.get(y);if(!E)throw new Error("Card not found");const w=await et.saveImage(p,y,E.folderId),k={id:w.id,url:w.filePath,alt:p.name,width:w.metadata.width,height:w.metadata.height,aspectRatio:w.metadata.width/w.metadata.height},T=E.isFlipped?"backContent":"frontContent",$=[...E[T].images,k];return await P.cards.update(y,A=>{T==="frontContent"?A.frontContent={...A.frontContent,images:$,lastModified:new Date}:A.backContent={...A.backContent,images:$,lastModified:new Date},A.userId=b,A.updatedAt=new Date,A.syncVersion=(A.syncVersion||0)+1,A.pendingSync=!0}),await Ie.addOperation({type:"update",table:"cards",data:{[T]:{images:$},userId:b,updatedAt:new Date},localId:y}),await c(),k}catch(E){throw console.error("Failed to upload image:",E),E}},[c]);return{cards:x(),allCards:a,filter:t,setFilter:r,viewSettings:n,setViewSettings:o,selectedCardIds:i,isLoading:u,dispatch:h,getCardById:f,getSelectedCards:C,getAllTags:j,updateTagsInAllCards:N,getCardsWithTag:v,handleImageUpload:g,loadCards:c}}class Ue{static instance=null;MIGRATION_STATUS_KEY="cardall_migration_status";BACKUP_PREFIX="cardall_backup_";static getInstance(){return Ue.instance||(Ue.instance=new Ue),Ue.instance}async needsMigration(){try{return!(this.getMigrationStatus()?.completed||!X.get("cards")||await P.cards.count()>0)}catch(e){return console.error("Failed to check migration status:",e),!1}}async migrate(e={}){const{createBackup:t=!0,validateData:r=!0,cleanupAfterSuccess:n=!0,progressCallback:o}=e,i=Date.now();try{if(!await this.needsMigration()){const h={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:[],duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"completed",progress:100,message:"No migration needed"}),h}this.reportProgress(o,{stage:"starting",progress:0,message:"Starting migration..."}),this.setMigrationStatus({started:!0,startTime:new Date,stage:"starting"}),this.reportProgress(o,{stage:"loading",progress:10,message:"Loading data from localStorage..."});const u=this.loadLocalStorageData();if(u.length===0){const h={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:["No data found in localStorage"],duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"completed",progress:100,message:"No data to migrate"}),h}let m;if(t&&(this.reportProgress(o,{stage:"backup",progress:20,message:"Creating backup..."}),m=await this.createBackup(u)),r){this.reportProgress(o,{stage:"validation",progress:30,message:"Validating data integrity..."});const h=this.validateMigrationData(u);if(!h.valid)throw ce("VALIDATION_FAILED","Data validation failed",{errors:h.errors})}this.reportProgress(o,{stage:"migration",progress:50,message:`Migrating ${u.length} cards...`});const c=await this.performMigration(u,(h,f)=>{this.reportProgress(o,{stage:"migration",progress:50+h*.4,message:f})});if(r){this.reportProgress(o,{stage:"verification",progress:90,message:"Verifying migration results..."});const h=await this.verifyMigrationResults(u.length);if(!h.success)throw ce("VERIFICATION_FAILED","Migration verification failed",{details:h.errors})}n&&c.errors.length===0&&(this.reportProgress(o,{stage:"cleanup",progress:95,message:"Cleaning up original data..."}),this.cleanupLocalStorage()),this.setMigrationStatus({completed:!0,completedAt:new Date,success:!0,migratedCards:c.migratedCards,totalCards:u.length});const x={success:c.success,migratedCards:c.migratedCards,totalCards:u.length,errors:c.errors,warnings:c.warnings,duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"completed",progress:100,message:`Migration completed successfully: ${c.migratedCards}/${u.length} cards migrated`}),x}catch(l){this.setMigrationStatus({completed:!0,completedAt:new Date,success:!1,error:l instanceof Error?l.message:String(l)});const u={success:!1,migratedCards:0,totalCards:0,errors:[l instanceof Error?l.message:"Unknown migration error"],warnings:[],duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"error",progress:0,message:`Migration failed: ${l instanceof Error?l.message:"Unknown error"}`}),u}}loadLocalStorageData(){try{return ke.loadFromLocalStorage()}catch(e){throw ce("LOAD_DATA_FAILED","Failed to load data from localStorage",{error:e instanceof Error?e.message:String(e)})}}async createBackup(e){try{return await(await _s.create()).backupData()}catch(t){throw ce("BACKUP_FAILED","Failed to create backup",{error:t instanceof Error?t.message:String(t)})}}validateMigrationData(e){const t=[];return Array.isArray(e)?(e.forEach((r,n)=>{const o=ke.validateCard(r);o.valid||t.push(`Card at index ${n}: ${o.errors.join(", ")}`)}),{valid:t.length===0,errors:t}):(t.push("Data is not an array"),{valid:!1,errors:t})}async performMigration(e,t){const r=[],n=[];let o=0;try{const i=ke.bulkCardsToDbCards(e);return t&&t(.1,"Starting batch migration..."),await P.cards.bulkAdd(i),o=i.length,t&&t(1,"Batch migration completed"),{migratedCards:o,errors:r,warnings:n}}catch(i){console.warn("Bulk migration failed, trying individual migration:",i);const l=e.length;for(let m=0;m<e.length;m++){const c=e[m];try{const x=ke.cardToDbCard(c);if(await P.cards.add(x),o++,t){const h=(m+1)/l;t(h,`Migrated card ${m+1}/${l}: ${c.frontContent.title}`)}}catch(x){console.error(`Failed to migrate card ${c.id}:`,x),r.push(c.id)}}return r.length===0||n.push(`Some cards failed to migrate: ${r.length} out of ${l}`),{migratedCards:o,errors:r,warnings:n}}}async verifyMigrationResults(e){const t=[];try{const r=await P.cards.count();if(r!==e&&t.push(`Record count mismatch: expected ${e}, got ${r}`),r>0){const n=await P.cards.limit(10).toArray();for(const o of n){const i=ke.dbCardToCard(o),l=ke.validateCard(i);l.valid||t.push(`Data integrity issue with card ${i.id}: ${l.errors.join(", ")}`)}}return{success:t.length===0,errors:t}}catch(r){return t.push(`Verification failed: ${r instanceof Error?r.message:String(r)}`),{success:!1,errors:t}}}cleanupLocalStorage(){try{X.remove("cards")}catch(e){console.warn("Failed to cleanup localStorage:",e)}}async rollback(){try{const e=this.getAvailableBackups();if(e.length===0)throw ce("NO_BACKUP","No backup available for rollback");const t=e[0];return await(await _s.create()).restoreData(t)?(this.setMigrationStatus({rolledBack:!0,rolledBackAt:new Date,backupId:t.id}),await P.cards.clear(),!0):!1}catch(e){throw ce("ROLLBACK_FAILED","Failed to rollback migration",{error:e instanceof Error?e.message:String(e)})}}getAvailableBackups(){const e=[];try{for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t);if(r&&r.startsWith(this.BACKUP_PREFIX))try{const n=X.get(r);n&&e.push({id:r,data:JSON.stringify(n),timestamp:new Date(n.timestamp),version:n.version||"1.0.0",cardCount:n.cards?.length||0,checksum:""})}catch(n){console.warn(`Failed to parse backup ${r}:`,n)}}}catch(t){console.error("Failed to get available backups:",t)}return e.sort((t,r)=>r.timestamp.getTime()-t.timestamp.getTime())}getMigrationStatus(){try{return X.get(this.MIGRATION_STATUS_KEY)}catch{return null}}setMigrationStatus(e){try{const t=this.getMigrationStatus()||{};X.set(this.MIGRATION_STATUS_KEY,{...t,...e})}catch(t){console.error("Failed to set migration status:",t)}}reportProgress(e,t){if(e)try{e(t)}catch(r){console.error("Progress callback error:",r)}}async getMigrationStats(){try{const e=this.getMigrationStatus(),t=this.getAvailableBackups();return{migrationNeeded:await this.needsMigration(),migrationCompleted:e?.completed||!1,migrationSuccessful:e?.success||!1,lastMigrationTime:e?.completedAt||null,availableBackups:t.length,localStorageCardCount:await this.getLocalStorageCardCount(),indexedDBCardCount:await P.cards.count()}}catch(e){throw ce("GET_STATS_FAILED","Failed to get migration stats",{error:e instanceof Error?e.message:String(e)})}}async getLocalStorageCardCount(){try{return ke.loadFromLocalStorage().length}catch{return 0}}}Ue.getInstance();async function ci(){const a=new We;try{const e=await a.isIndexedDBAvailable();let t=!1,r=0;if(e&&(t=await a.hasIndexedDBData(),t))try{const i=await Ps(()=>import("./sync-DTvATBjT.js").then(l=>l.f),__vite__mapDeps([0,1,2,3])).then(l=>l.db);if(i&&i.isOpen()){r=await i.cards.count();const[l,u,m]=await Promise.all([i.folders.count().catch(()=>0),i.tags.count().catch(()=>0),i.images.count().catch(()=>0)]);r+=l+u+m,console.debug(`IndexedDB data count: ${r} (cards: ${await i.cards.count()}, folders: ${l}, tags: ${u}, images: ${m})`)}}catch(i){console.debug("Failed to get IndexedDB data count:",i)}let n=!1,o=0;try{const i=localStorage.getItem("cards");if(i){const u=JSON.parse(i);Array.isArray(u)&&u.length>0&&(n=!0,o=u.length,console.debug(`localStorage data count: ${o}`))}const l=["folders","tags","settings"];for(const u of l){const m=localStorage.getItem(u);if(m)try{const c=JSON.parse(m);Array.isArray(c)&&c.length>0&&(n=!0,o+=c.length)}catch(c){console.debug(`Failed to parse localStorage ${u}:`,c)}}}catch(i){console.debug("Failed to check localStorage data:",i)}if(!e)return console.debug("IndexedDB not available, using localStorage"),"localStorage";if(t&&!n)return console.debug("Only IndexedDB has data, using IndexedDB"),"indexeddb";if(!t&&n)return console.debug("Only localStorage has data, using localStorage"),"localStorage";if(t&&n)return r>o?(console.debug(`Both have data, IndexedDB has more (${r} > ${o}), using IndexedDB`),"indexeddb"):o>r?(console.debug(`Both have data, localStorage has more (${o} > ${r}), using localStorage`),"localStorage"):(console.debug("Both have equal data, preferring IndexedDB"),"indexeddb");try{const i=localStorage.getItem("preferredStorageMode");if(i==="indexeddb"&&e)return console.debug("User prefers IndexedDB, using IndexedDB"),"indexeddb";if(i==="localStorage")return console.debug("User prefers localStorage, using localStorage"),"localStorage"}catch(i){console.debug("Failed to get user preference:",i)}return e?(console.debug("Default: IndexedDB available, using IndexedDB"),"indexeddb"):(console.debug("Default: using localStorage"),"localStorage")}catch(e){return console.error("Error determining storage mode:",e),"localStorage"}}function di(){const[a,e]=d.useState({mode:"localStorage",isReady:!1}),t=ni(),r=li();d.useEffect(()=>{(async()=>{try{e(x=>({...x,mode:"migrating",isReady:!1}));const u=Ue.getInstance();await u.needsMigration()&&await u.migrate({createBackup:!0,validateData:!0,cleanupAfterSuccess:!0,progressCallback:x=>{e(h=>({...h,migrationProgress:{stage:x.stage,progress:x.progress,message:x.message}}))}});const c=await ci();e({mode:c,isReady:!0})}catch(u){console.error("Failed to initialize adapter:",u),e({mode:"localStorage",isReady:!0})}})()},[]);const n=a.mode==="indexeddb"?r:t,o=d.useCallback(async()=>{e(l=>({...l,mode:"migrating",isReady:!1}));try{const u=await Ue.getInstance().migrate({createBackup:!0,validateData:!0,cleanupAfterSuccess:!0,progressCallback:m=>{e(c=>({...c,migrationProgress:{stage:m.stage,progress:m.progress,message:m.message}}))}});e(u?{mode:"indexeddb",isReady:!0}:{mode:"localStorage",isReady:!0})}catch(l){console.error("Migration retry failed:",l),e({mode:"localStorage",isReady:!0})}},[]),i=d.useCallback(async()=>{try{await Ue.getInstance().rollback()&&e({mode:"localStorage",isReady:!0})}catch(l){console.error("Rollback failed:",l)}},[]);return{...n,adapterState:a,storageMode:a.mode,isReady:a.isReady,migrationProgress:a.migrationProgress,retryMigration:o,rollbackMigration:i,isUsingLocalStorage:a.mode==="localStorage",isUsingIndexedDB:a.mode==="indexeddb",isMigrating:a.mode==="migrating"}}const Cs=[{id:"folder-1",name:"Development",color:"#3b82f6",icon:"Code",cardIds:["1"],isExpanded:!0,createdAt:new Date("2024-01-10"),updatedAt:new Date("2024-01-15")},{id:"folder-2",name:"Design Resources",color:"#8b5cf6",icon:"Palette",cardIds:[],isExpanded:!1,createdAt:new Date("2024-01-12"),updatedAt:new Date("2024-01-12")},{id:"folder-3",name:"Learning Notes",color:"#10b981",icon:"BookOpen",cardIds:["2"],parentId:"folder-1",isExpanded:!0,createdAt:new Date("2024-01-14"),updatedAt:new Date("2024-01-16")}];function ui(){const[a,e]=d.useState(()=>{try{return X.get("folders_state_backup",{validate:!0,encrypt:!0})||[]}catch{return[]}}),[t,r]=d.useState(!1),[n,o]=d.useState(null),[i,l]=d.useState(!0),u=d.useCallback(()=>{const g=a.filter(y=>!y.parentId),p=y=>y.map(b=>({...b,children:p(a.filter(E=>E.parentId===b.id))}));return p(g)},[a]),m=d.useCallback(g=>{console.log("🎯 Folder Action dispatched:",g.type,g.payload),e(y=>{try{switch(g.type){case"CREATE_FOLDER":console.log("➕ Creating new folder...");const E=Ee.getCurrentUser()?.id||"default",w={...g.payload,id:`folder-${Date.now()}`,cardIds:[],syncVersion:1,pendingSync:!0,userId:E,createdAt:new Date,updatedAt:new Date};return console.log("✅ New folder created:",w.id,w.name),[...y,w];case"UPDATE_FOLDER":console.log("📝 Updating folder:",g.payload.id);const k=y.map(A=>A.id===g.payload.id?{...A,...g.payload.updates,updatedAt:new Date,syncVersion:(A.syncVersion||1)+1,pendingSync:!0}:A);return console.log("✅ Folder updated:",g.payload.id),k;case"DELETE_FOLDER":if(console.log("🗑️ Deleting folder:",g.payload),y.find(A=>A.id===g.payload)){const A=ae=>{const re=y.filter(Y=>Y.parentId===ae),fe=re.map(Y=>Y.id),z=re.flatMap(Y=>A(Y.id));return[...fe,...z]},G=A(g.payload),te=[g.payload,...G],W=y.filter(ae=>te.includes(ae.id)).flatMap(ae=>ae.cardIds);console.log("📋 Folders to delete:",te.length),console.log("📋 Cards to delete:",W.length),"onDeleteCards"in g&&g.onDeleteCards&&W.length>0&&(console.log("🔄 Triggering card deletion callback..."),g.onDeleteCards(W));const ee=y.filter(ae=>!te.includes(ae.id));return console.log("✅ Folder deleted successfully. Remaining folders:",ee.length),ee}return console.warn("⚠️ Folder to delete not found:",g.payload),y.filter(A=>A.id!==g.payload);case"TOGGLE_FOLDER":console.log("🔄 Toggling folder expansion:",g.payload);const $=y.map(A=>A.id===g.payload?{...A,isExpanded:!A.isExpanded,updatedAt:new Date}:A);return console.log("✅ Folder toggled:",g.payload),$;default:return console.warn("⚠️ Unknown folder action:",g.type),y}}catch(b){return console.error("❌ Error in folder dispatch:",b),y}});const p=async()=>{try{console.log("☁️ 触发文件夹云端同步..."),await hs.performIncrementalSync(),console.log("✅ 文件夹云端同步完成")}catch(y){console.error("❌ 文件夹云端同步失败:",y)}};(g.type==="CREATE_FOLDER"||g.type==="UPDATE_FOLDER"||g.type==="DELETE_FOLDER")&&setTimeout(p,100)},[hs]),c=d.useCallback(g=>a.find(p=>p.id===g),[a]),x=d.useCallback(g=>{const p=[];let y=c(g);for(;y;)p.unshift(y),y=y.parentId?c(y.parentId):null;return p},[a,c]),h=d.useCallback((g,p)=>{m({type:"UPDATE_FOLDER",payload:{id:p,updates:{cardIds:[...c(p)?.cardIds||[],g]}}})},[m,c]),f=d.useCallback((g,p)=>{const y=c(p);y&&m({type:"UPDATE_FOLDER",payload:{id:p,updates:{cardIds:y.cardIds.filter(b=>b!==g)}}})},[m,c]),C=d.useCallback((g,p,y)=>{p&&f(g,p),y&&h(g,y)},[h,f]),j=d.useCallback((g,p)=>{if(g===p)return!1;let y=p;for(;y;){if(y===g)return!1;y=c(y)?.parentId??null}return!0},[c]),N=d.useCallback(async()=>{try{if(a.length===0)return console.log("📋 没有文件夹数据，跳过一致性检查"),l(!0),!0;console.log("🔍 开始检查文件夹数据一致性...");const g=await P.folders.toArray(),p=new Set(g.map(T=>T.id)),y=new Set(a.map(T=>T.id));console.log("📊 数据统计:"),console.log("  - 内存中文件夹:",a.length),console.log("  - IndexedDB中文件夹:",g.length);let b=!0;a.length>0&&g.length===0&&console.warn("⚠️ 内存中有数据但IndexedDB为空，可能正在同步中");const E=a.filter(T=>!p.has(T.id)),w=g.filter(T=>!y.has(T.id));if(E.length>0&&(console.warn("❌ 发现IndexedDB中缺失的文件夹:",E.map(T=>T.id)),b=!1),w.length>0&&w.length>3&&(console.warn("⚠️ 发现IndexedDB中多余的文件夹:",w.map(T=>T.id)),b=!1),a.length>0){const T=a.filter($=>!$.syncVersion||$.pendingSync===void 0);if(T.length>0){console.warn("⚠️ 发现缺少同步字段的文件夹:",T.map(A=>A.id));const $=a.map(A=>({...A,syncVersion:A.syncVersion||1,pendingSync:A.pendingSync||!1,userId:A.userId||"default"}));JSON.stringify($)!==JSON.stringify(a)&&(e($),console.log("✅ 自动修复同步字段完成"))}}if(X.get("folder_data_needs_restore",{validate:!0})&&a.length===0){console.log("🔄 发现需要恢复的文件夹数据，且当前无数据");const T=X.get("folders_backup",{validate:!0,encrypt:!0});if(T&&T.length>0){console.log("💾 从备份恢复文件夹数据:",T.length),e(T),X.remove("folder_data_needs_restore"),X.remove("folders_backup");try{await P.folders.clear(),await P.folders.bulkAdd(T),console.log("✅ 恢复的文件夹数据已保存到IndexedDB"),b=!0}catch($){console.error("❌ 恢复数据保存失败:",$)}}}return l(b),console.log("🎯 文件夹数据一致性检查完成:",b?"✅ 一致":"❌ 不一致"),b}catch(g){return console.error("❌ 数据一致性检查失败:",g),l(!1),!1}},[a]),v=d.useCallback(async()=>{try{return console.log("开始强制修复文件夹数据..."),X.set("folders_repair_backup",a,{validate:!0,encrypt:!0}),await P.folders.clear(),await P.folders.bulkAdd(a),X.remove("folder_data_needs_restore"),X.remove("folders_backup"),X.set("folder_migration_complete",!0,{validate:!0}),console.log("文件夹数据强制修复完成"),l(!0),!0}catch(g){return console.error("强制修复文件夹数据失败:",g),!1}},[a]);return d.useEffect(()=>{(async()=>{if(t){console.log("📁 文件夹数据已初始化，跳过加载");return}try{console.log("🔄 开始加载文件夹数据...");let p=[];if(a.length>0)console.log("📋 使用内存中的文件夹数据:",a.length),p=a;else try{const y=await P.folders.toArray();if(console.log("📊 从 IndexedDB 查找到文件夹:",y.length),y.length>0)p=y.map(b=>({...b,cardIds:b.cardIds||[],syncVersion:b.syncVersion||1,pendingSync:b.pendingSync||!1,userId:b.userId||"default"})),console.log("✅ 使用 IndexedDB 中的文件夹数据"),e(p);else{if(X.get("folder_migration_complete",{validate:!0})){console.log("🔄 迁移已完成但无数据，可能数据被清空，保持空状态"),r(!0);return}console.log("🎯 首次使用，初始化默认文件夹数据"),p=Cs.map(E=>({...E,syncVersion:1,pendingSync:!1,userId:"default"})),await P.folders.clear(),await P.folders.bulkAdd(p),X.set("folder_migration_complete",!0,{validate:!0}),console.log("✅ 默认文件夹数据已保存到 IndexedDB"),e(p)}}catch(y){console.error("❌ 从 IndexedDB 加载失败:",y);try{const b=X.get("folders_state_backup",{validate:!0,encrypt:!0});b&&b.length>0?(console.log("💾 从localStorage备份恢复文件夹数据:",b.length),p=b,e(p)):(p=Cs.map(E=>({...E,syncVersion:1,pendingSync:!1,userId:"default"})),console.log("🚨 使用默认文件夹数据作为应急方案"),e(p))}catch(b){console.error("❌ 从备份恢复失败:",b),p=Cs.map(E=>({...E,syncVersion:1,pendingSync:!1,userId:"default"})),e(p)}}r(!0),console.log("🎉 文件夹数据加载完成，共",p.length,"个文件夹"),setTimeout(async()=>{try{if(Ee.isAuthenticated()){console.log("☁️ 开始后台云端同步..."),await hs.performIncrementalSync(),console.log("✅ 后台云端同步完成");const b=await P.folders.toArray();if(b.length>0){const E=b.map(w=>({...w,cardIds:w.cardIds||[],syncVersion:w.syncVersion||1,pendingSync:w.pendingSync||!1,userId:w.userId||"default"}));e(E),console.log("🔄 同步后更新文件夹数据:",E.length)}}await N()||(console.warn("⚠️ 数据一致性检查失败，尝试修复..."),await v())}catch(y){console.error("❌ 后台同步失败:",y)}},1e3)}catch(p){console.error("❌ 加载文件夹数据失败:",p),r(!0)}})()},[t]),d.useEffect(()=>{if(!t){console.log("⏳ 数据初始化未完成，跳过保存操作");return}if(a.length===0){console.log("📋 没有文件夹数据，跳过保存操作");return}const p=setTimeout(async()=>{try{console.log("💾 开始保存文件夹数据到IndexedDB...");const y=await P.folders.toArray(),b=new Set(y.map(k=>k.id)),E=new Set(a.map(k=>k.id));if(y.length>0&&a.length===0){console.warn("⚠️ 检测到数据可能被清空，跳过保存以避免覆盖");return}const w=a.map(k=>({...k,syncVersion:k.syncVersion||1,pendingSync:k.pendingSync||!1,userId:k.userId||"default",updatedAt:new Date}));await P.transaction("rw",P.folders,async()=>{if(E.size>0){const $=y.filter(A=>!E.has(A.id));$.length>0&&(await P.folders.bulkDelete($.map(A=>A.id)),console.log("🗑️ 删除已不存在的文件夹:",$.length))}const k=w.filter($=>b.has($.id));for(const $ of k)await P.folders.update($.id,$);console.log("📝 更新现有文件夹:",k.length);const T=w.filter($=>!b.has($.id));T.length>0&&(await P.folders.bulkAdd(T),console.log("➕ 添加新文件夹:",T.length))});try{X.set("folders_state_backup",a,{validate:!0,encrypt:!0}),console.log("💾 文件夹状态已备份到localStorage")}catch(k){console.warn("⚠️ 备份到localStorage失败:",k)}console.log("✅ 文件夹数据保存成功，共",w.length,"个文件夹"),setTimeout(async()=>{try{const k=await P.folders.toArray();console.log("🔍 验证保存结果: IndexedDB中现有",k.length,"个文件夹"),k.length!==w.length&&console.warn("⚠️ 保存的数据数量不匹配"),await N()||console.warn("⚠️ 保存后数据一致性检查失败")}catch(k){console.error("❌ 验证保存结果失败:",k)}},500)}catch(y){console.error("❌ 保存文件夹数据到IndexedDB失败:",y),console.warn("🔄 尝试重新保存文件夹数据...");try{const b=a.map(w=>({...w,syncVersion:w.syncVersion||1,pendingSync:w.pendingSync||!1,userId:w.userId||"default",updatedAt:new Date}));if((await P.folders.toArray()).length>0&&a.length>0){for(const w of b)await P.folders.put(w);console.log("✅ 文件夹数据更新保存成功")}else await P.folders.clear(),await P.folders.bulkAdd(b),console.log("✅ 文件夹数据重新保存成功")}catch(b){console.error("❌ 重新保存文件夹数据失败:",b),console.warn("💾 将文件夹数据临时保存到localStorage"),X.set("folders_backup",a,{validate:!0,encrypt:!0}),X.set("folder_data_needs_restore",!0,{validate:!0}),console.error("🚨 文件夹数据保存失败，已创建备份")}}},500);return()=>clearTimeout(p)},[a.length,t,a]),d.useEffect(()=>{const g=setInterval(async()=>{i&&await N()},3e4);return()=>clearInterval(g)},[i,N]),{folders:a,folderTree:u(),selectedFolderId:n,setSelectedFolderId:o,dispatch:m,getFolderById:c,getFolderPath:x,addCardToFolder:h,removeCardFromFolder:f,moveCardBetweenFolders:C,canMoveFolder:j,isConsistent:i,checkDataConsistency:N,forceDataRepair:v}}const mi=[{id:"tag-1",name:"react",color:"#3b82f6",count:1,createdAt:new Date("2024-01-15")},{id:"tag-2",name:"frontend",color:"#8b5cf6",count:1,createdAt:new Date("2024-01-15")},{id:"tag-3",name:"best-practices",color:"#10b981",count:1,createdAt:new Date("2024-01-15")},{id:"tag-4",name:"typescript",color:"#f59e0b",count:1,createdAt:new Date("2024-01-16")},{id:"tag-5",name:"types",color:"#ef4444",count:1,createdAt:new Date("2024-01-16")},{id:"tag-6",name:"development",color:"#06b6d4",count:1,createdAt:new Date("2024-01-16")}],ot=["#3b82f6","#8b5cf6","#10b981","#f59e0b","#ef4444","#06b6d4","#8b5a2b","#6b7280","#ec4899","#84cc16","#f97316","#6366f1"];function fi(){const[a,e]=d.useState(mi),[t,r]=d.useState([]),n=d.useCallback(()=>a.filter(v=>!t.includes(v.id)),[a,t]),o=d.useCallback(v=>{const g=[...n()].sort((p,y)=>y.count-p.count);return v?g.slice(0,v):g},[n]),i=d.useCallback(v=>{e(g=>{switch(v.type){case"CREATE_TAG":const p=g.find(b=>b.name.toLowerCase()===v.payload.name.toLowerCase());if(p)return g.map(b=>b.id===p.id?{...b,count:b.count+1}:b);const y={...v.payload,id:`tag-${Date.now()}`,count:1,color:v.payload.color||ot[g.length%ot.length],createdAt:new Date};return[...g,y];case"UPDATE_TAG":return g.map(b=>b.id===v.payload.id?{...b,...v.payload.updates}:b);case"DELETE_TAG":return g.filter(b=>b.id!==v.payload);case"TOGGLE_TAG_VISIBILITY":return r(b=>b.includes(v.payload)?b.filter(E=>E!==v.payload):[...b,v.payload]),g;default:return g}})},[]),l=d.useCallback(v=>a.find(g=>g.id===v),[a]),u=d.useCallback(v=>a.find(g=>g.name.toLowerCase()===v.toLowerCase()),[a]),m=d.useCallback((v,g)=>{const p=u(v);return p||(i({type:"CREATE_TAG",payload:{name:v,color:g||ot[a.length%ot.length]}}),null)},[i,u,a.length]),c=d.useCallback((v,g)=>{const p=u(v);if(p){const y=Math.max(0,p.count+g);i(y===0?{type:"DELETE_TAG",payload:p.id}:{type:"UPDATE_TAG",payload:{id:p.id,updates:{count:y}}})}},[i,u]),x=d.useCallback(v=>{const g=v.reduce((E,w)=>(E[w]=(E[w]||0)+1,E),{}),p=a.map(E=>({...E,count:g[E.name]||0})),y=new Set(a.map(E=>E.name));Object.entries(g).forEach(([E,w])=>{if(!y.has(E)){const k={id:`tag-${Date.now()}-${Math.random()}`,name:E,color:ot[p.length%ot.length],count:w,createdAt:new Date};p.push(k)}});const b=p.filter(E=>E.count>0);e(b)},[a]),h=d.useCallback(v=>{if(!v.trim())return n();const g=v.toLowerCase();return n().filter(p=>p.name.toLowerCase().includes(g))},[n]),f=d.useCallback((v,g=5)=>v.trim()?h(v).slice(0,g):o(g),[h,o]),C=d.useCallback((v,g)=>{const p=u(v);if(!p)return!1;const y=u(g);return y&&y.id!==p.id?!1:(i({type:"UPDATE_TAG",payload:{id:p.id,updates:{name:g.trim()}}}),!0)},[i,u]),j=d.useCallback(v=>{const g=u(v);return g?(i({type:"DELETE_TAG",payload:g.id}),!0):!1},[i,u]),N=d.useCallback(()=>a.map(v=>v.name),[a]);return d.useEffect(()=>{const v=setTimeout(()=>{X.set("tags",a,{validate:!0,encrypt:!0}),X.set("hidden-tags",t,{validate:!0,encrypt:!0})},1e3);return()=>clearTimeout(v)},[a,t]),d.useEffect(()=>{const v=X.get("tags",{validate:!0,encrypt:!0});v&&e(v);const g=X.get("hidden-tags",{validate:!0,encrypt:!0});g&&r(g)},[]),{tags:n(),allTags:a,hiddenTags:t,popularTags:o,dispatch:i,getTagById:l,getTagByName:u,createTagIfNotExists:m,updateTagCount:c,syncTagsWithCards:x,searchTags:h,getTagSuggestions:f,renameTag:C,deleteTagByName:j,getAllTagNames:N}}const jr=d.createContext(null);function gi({children:a}){const e=di(),t=ui(),r=fi();V.useEffect(()=>{if(e.isReady&&!e.isMigrating){const o=[];e.allCards.forEach(i=>{o.push(...i.frontContent.tags,...i.backContent.tags)}),r.syncTagsWithCards(o)}},[e.allCards,e.isReady,e.isMigrating,r.syncTagsWithCards]);const n={cards:e,folders:t,tags:r};return s.jsx(jr.Provider,{value:n,children:a})}function Us(){const a=d.useContext(jr);if(!a)throw new Error("useCardAll must be used within a CardAllProvider");return a}function hi(){return Us().cards}function Sr(){return Us().folders}function Nr(){return Us().tags}const kr=d.createContext(void 0);function pi({children:a}){const[e,t]=d.useState(!1),r=()=>t(!0),n=()=>t(!1);return s.jsx(kr.Provider,{value:{isOpen:e,openModal:r,closeModal:n},children:a})}function Er(){const a=d.useContext(kr);if(a===void 0)throw new Error("useAuthModal must be used within an AuthModalProvider");return a}function _(...a){return co(uo(a))}const Vs=Zt("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),L=d.forwardRef(({className:a,variant:e,size:t,asChild:r=!1,...n},o)=>{const i=r?Tn:"button";return s.jsx(i,{className:_(Vs({variant:e,size:t,className:a})),ref:o,...n})});L.displayName="Button";const xi=In,yi=_n,wi=d.forwardRef(({className:a,inset:e,children:t,...r},n)=>s.jsxs(va,{ref:n,className:_("flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",a),...r,children:[t,s.jsx(es,{className:"ml-auto"})]}));wi.displayName=va.displayName;const bi=d.forwardRef(({className:a,...e},t)=>s.jsx(Ca,{ref:t,className:_("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e}));bi.displayName=Ca.displayName;const Dr=d.forwardRef(({className:a,sideOffset:e=4,...t},r)=>s.jsx(An,{children:s.jsx(ja,{ref:r,sideOffset:e,className:_("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...t})}));Dr.displayName=ja.displayName;const Be=d.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(Sa,{ref:r,className:_("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",a),...t}));Be.displayName=Sa.displayName;const vi=d.forwardRef(({className:a,children:e,checked:t,...r},n)=>s.jsxs(Na,{ref:n,className:_("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:t,...r,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(ka,{children:s.jsx(qe,{className:"h-4 w-4"})})}),e]}));vi.displayName=Na.displayName;const Ci=d.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Ea,{ref:r,className:_("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(ka,{children:s.jsx(hr,{className:"h-2 w-2 fill-current"})})}),e]}));Ci.displayName=Ea.displayName;const ji=d.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(Da,{ref:r,className:_("px-2 py-1.5 text-sm font-semibold",e&&"pl-8",a),...t}));ji.displayName=Da.displayName;const Ms=d.forwardRef(({className:a,...e},t)=>s.jsx(Ra,{ref:t,className:_("-mx-1 my-1 h-px bg-muted",a),...e}));Ms.displayName=Ra.displayName;const js=[{emoji:"😀",name:"grinning"},{emoji:"😃",name:"smiley"},{emoji:"😄",name:"smile"},{emoji:"😁",name:"grin"},{emoji:"😆",name:"laughing"},{emoji:"😅",name:"sweat_smile"},{emoji:"🤣",name:"rofl"},{emoji:"😂",name:"joy"},{emoji:"🙂",name:"slightly_smiling_face"},{emoji:"🙃",name:"upside_down_face"},{emoji:"😉",name:"wink"},{emoji:"😊",name:"blush"},{emoji:"😇",name:"innocent"},{emoji:"🥰",name:"smiling_face_with_hearts"},{emoji:"😍",name:"heart_eyes"},{emoji:"🤩",name:"star_struck"},{emoji:"😘",name:"kissing_heart"},{emoji:"😗",name:"kissing"},{emoji:"😚",name:"kissing_closed_eyes"},{emoji:"😙",name:"kissing_smiling_eyes"},{emoji:"🥲",name:"smiling_face_with_tear"},{emoji:"😋",name:"yum"},{emoji:"😛",name:"stuck_out_tongue"},{emoji:"😜",name:"stuck_out_tongue_winking_eye"},{emoji:"🤪",name:"zany_face"},{emoji:"😝",name:"stuck_out_tongue_closed_eyes"},{emoji:"🤑",name:"money_mouth_face"},{emoji:"🤗",name:"hugs"},{emoji:"🤭",name:"hand_over_mouth"},{emoji:"🤫",name:"shushing_face"},{emoji:"🤔",name:"thinking"},{emoji:"🤐",name:"zipper_mouth_face"},{emoji:"🤨",name:"raised_eyebrow"},{emoji:"😐",name:"neutral_face"},{emoji:"😑",name:"expressionless"},{emoji:"😶",name:"no_mouth"},{emoji:"😏",name:"smirk"},{emoji:"😒",name:"unamused"},{emoji:"🙄",name:"roll_eyes"},{emoji:"😬",name:"grimacing"},{emoji:"🤥",name:"lying_face"},{emoji:"😔",name:"pensive"},{emoji:"😪",name:"sleepy"},{emoji:"🤤",name:"drooling_face"},{emoji:"😴",name:"sleeping"},{emoji:"😷",name:"mask"},{emoji:"🤒",name:"face_with_thermometer"},{emoji:"🤕",name:"face_with_head_bandage"},{emoji:"🤢",name:"nauseated_face"},{emoji:"🤮",name:"vomiting_face"},{emoji:"🤧",name:"sneezing_face"},{emoji:"🥵",name:"hot_face"},{emoji:"🥶",name:"cold_face"},{emoji:"🥴",name:"woozy_face"},{emoji:"😵",name:"dizzy_face"},{emoji:"🤯",name:"exploding_head"},{emoji:"🤠",name:"cowboy_hat_face"},{emoji:"🥳",name:"partying_face"},{emoji:"🥸",name:"disguised_face"},{emoji:"😎",name:"sunglasses"},{emoji:"🤓",name:"nerd_face"},{emoji:"🧐",name:"monocle_face"},{emoji:"😕",name:"confused"},{emoji:"😟",name:"worried"},{emoji:"🙁",name:"slightly_frowning_face"},{emoji:"☹️",name:"frowning_face"},{emoji:"😮",name:"open_mouth"},{emoji:"😯",name:"hushed"},{emoji:"😲",name:"astonished"},{emoji:"😳",name:"flushed"},{emoji:"🥺",name:"pleading_face"},{emoji:"😦",name:"frowning"},{emoji:"😧",name:"anguished"},{emoji:"😨",name:"fearful"},{emoji:"😰",name:"cold_sweat"},{emoji:"😥",name:"disappointed_relieved"},{emoji:"😢",name:"cry"},{emoji:"😭",name:"sob"},{emoji:"😱",name:"scream"},{emoji:"😖",name:"confounded"},{emoji:"😣",name:"persevere"},{emoji:"😞",name:"disappointed"},{emoji:"😓",name:"sweat"},{emoji:"😩",name:"weary"},{emoji:"😫",name:"tired_face"},{emoji:"🥱",name:"yawning_face"},{emoji:"😤",name:"triumph"},{emoji:"😡",name:"rage"},{emoji:"😠",name:"angry"},{emoji:"🤬",name:"cursing_face"},{emoji:"😈",name:"smiling_imp"},{emoji:"👿",name:"imp"},{emoji:"💀",name:"skull"},{emoji:"☠️",name:"skull_and_crossbones"},{emoji:"💩",name:"poop"},{emoji:"🤡",name:"clown_face"},{emoji:"👹",name:"ogre"},{emoji:"👺",name:"goblin"},{emoji:"👻",name:"ghost"},{emoji:"👽",name:"alien"},{emoji:"👾",name:"space_invader"},{emoji:"🤖",name:"robot"},{emoji:"😺",name:"smiley_cat"},{emoji:"😸",name:"smile_cat"},{emoji:"😹",name:"joy_cat"},{emoji:"😻",name:"heart_eyes_cat"},{emoji:"😼",name:"smirk_cat"},{emoji:"😽",name:"kissing_cat"},{emoji:"🙀",name:"scream_cat"},{emoji:"😿",name:"crying_cat_face"},{emoji:"😾",name:"pouting_cat"},{emoji:"👋",name:"wave"},{emoji:"🤚",name:"raised_back_of_hand"},{emoji:"🖐️",name:"raised_hand_with_fingers_splayed"},{emoji:"✋",name:"hand"},{emoji:"🖖",name:"vulcan_salute"},{emoji:"👌",name:"ok_hand"},{emoji:"🤌",name:"pinched_fingers"},{emoji:"🤏",name:"pinching_hand"},{emoji:"✌️",name:"v"},{emoji:"🤞",name:"crossed_fingers"},{emoji:"🤟",name:"love_you_gesture"},{emoji:"🤘",name:"metal"},{emoji:"🤙",name:"call_me_hand"},{emoji:"👈",name:"point_left"},{emoji:"👉",name:"point_right"},{emoji:"👆",name:"point_up_2"},{emoji:"🖕",name:"middle_finger"},{emoji:"👇",name:"point_down"},{emoji:"☝️",name:"point_up"},{emoji:"👍",name:"thumbsup"},{emoji:"👎",name:"thumbsdown"},{emoji:"✊",name:"fist"},{emoji:"👊",name:"facepunch"},{emoji:"🤛",name:"fist_left"},{emoji:"🤜",name:"fist_right"},{emoji:"👏",name:"clap"},{emoji:"🙌",name:"raised_hands"},{emoji:"👐",name:"open_hands"},{emoji:"🤲",name:"palms_up_together"},{emoji:"🤝",name:"handshake"},{emoji:"🙏",name:"pray"},{emoji:"❤️",name:"heart"},{emoji:"🧡",name:"orange_heart"},{emoji:"💛",name:"yellow_heart"},{emoji:"💚",name:"green_heart"},{emoji:"💙",name:"blue_heart"},{emoji:"💜",name:"purple_heart"},{emoji:"🖤",name:"black_heart"},{emoji:"🤍",name:"white_heart"},{emoji:"🤎",name:"brown_heart"},{emoji:"💔",name:"broken_heart"},{emoji:"❣️",name:"heavy_heart_exclamation"},{emoji:"💕",name:"two_hearts"},{emoji:"💞",name:"revolving_hearts"},{emoji:"💓",name:"heartbeat"},{emoji:"💗",name:"heartpulse"},{emoji:"💖",name:"sparkling_heart"},{emoji:"💘",name:"cupid"},{emoji:"💝",name:"gift_heart"},{emoji:"💟",name:"heart_decoration"},{emoji:"☮️",name:"peace_symbol"},{emoji:"✝️",name:"latin_cross"},{emoji:"☪️",name:"star_and_crescent"},{emoji:"🕉️",name:"om"},{emoji:"☸️",name:"wheel_of_dharma"},{emoji:"✡️",name:"star_of_david"},{emoji:"🔯",name:"six_pointed_star"},{emoji:"🕎",name:"menorah"},{emoji:"☯️",name:"yin_yang"},{emoji:"☦️",name:"orthodox_cross"},{emoji:"🛐",name:"place_of_worship"},{emoji:"⛎",name:"ophiuchus"},{emoji:"♈",name:"aries"},{emoji:"♉",name:"taurus"},{emoji:"♊",name:"gemini"},{emoji:"♋",name:"cancer"},{emoji:"♌",name:"leo"},{emoji:"♍",name:"virgo"},{emoji:"♎",name:"libra"},{emoji:"♏",name:"scorpius"},{emoji:"♐",name:"sagittarius"},{emoji:"♑",name:"capricorn"},{emoji:"♒",name:"aquarius"},{emoji:"♓",name:"pisces"},{emoji:"🆔",name:"id"},{emoji:"⚡",name:"zap"},{emoji:"💥",name:"boom"},{emoji:"💫",name:"dizzy"},{emoji:"💦",name:"sweat_drops"},{emoji:"💨",name:"dash"},{emoji:"🕳️",name:"hole"},{emoji:"💣",name:"bomb"},{emoji:"💬",name:"speech_balloon"},{emoji:"👁️‍🗨️",name:"eye_speech_bubble"},{emoji:"🗨️",name:"left_speech_bubble"},{emoji:"🗯️",name:"right_anger_bubble"},{emoji:"💭",name:"thought_balloon"},{emoji:"💤",name:"zzz"}];function Si({onEmojiSelect:a,onClose:e,query:t="",position:r}){const[n,o]=d.useState(js);d.useEffect(()=>{if(t&&t.trim()){const c=t.toLowerCase().trim(),x=js.filter(h=>h.name.toLowerCase().includes(c)||h.emoji.includes(t)||h.name.toLowerCase().startsWith(c));o(x.slice(0,20))}else o(js.slice(0,40))},[t]);const i=c=>{a(c),e()},l=c=>{c.key==="Escape"&&e()},u=()=>{if(!r)return{};const c=window.innerWidth,x=window.innerHeight,h=320,f=240;let C=r.x,j=r.y;return C+h>c&&(C=c-h-20),j+f>x&&(j=r.y-f-10),{left:Math.max(10,C),top:Math.max(10,j)}},m=s.jsxs("div",{className:"fixed bg-white border border-border rounded-lg shadow-xl p-3 w-80",style:{...u(),zIndex:2147483647},onKeyDown:l,children:[t&&s.jsxs("div",{className:"text-xs text-blue-600 mb-2 font-medium",children:['"',t,'"']}),s.jsx("div",{className:"grid grid-cols-10 gap-1 max-h-52 overflow-y-auto",children:n.map((c,x)=>s.jsx(L,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 hover:bg-blue-50 text-lg transition-colors",onClick:()=>i(c.emoji),title:c.name,children:c.emoji},`${c.emoji}-${x}`))}),n.length===0&&t&&s.jsx("div",{className:"text-center text-muted-foreground text-sm py-6",children:"No emojis found"})]});return Qt.createPortal(m,document.body)}function Ni({content:a,placeholder:e="Start typing...",onUpdate:t,onSave:r,onCancel:n,className:o,autoFocus:i=!1}){const[l,u]=d.useState(!1),[m,c]=d.useState(""),[x,h]=d.useState(null),f=d.useRef(null),C=$o({extensions:[zo.configure({strike:!1,code:!1,blockquote:!1}),Bo.configure({html:!0,transformPastedText:!0,transformCopiedText:!1}),Uo,Vo.configure({nested:!0}),Wo.configure({openOnClick:!1,HTMLAttributes:{class:"text-blue-600 underline hover:text-blue-800 cursor-pointer",target:"_blank",rel:"noopener noreferrer"},protocols:["http","https","ftp","mailto"],validate:g=>/^https?:\/\//.test(g)}),Ho.configure({HTMLAttributes:{class:"border-l-4 border-gray-300 pl-4 italic"}}),Go.configure({HTMLAttributes:{class:"inline-code"}}),Ko.configure({HTMLAttributes:{class:"code-block"}}),Yo.configure({HTMLAttributes:{class:"line-through"}}),qo.configure({inline:!0,allowBase64:!0,HTMLAttributes:{class:"rounded-md max-w-full h-auto"}}),Jo.configure({placeholder:e})],content:a,onUpdate:({editor:g})=>{t(g.getHTML())},editorProps:{attributes:{class:"tiptap-editor text-sm leading-relaxed focus:outline-none min-h-[100px] w-full"},handleKeyDown:(g,p)=>{if(p.key==="/"&&!l){const{selection:y}=g.state,{from:b}=y,E=g.state.doc.resolve(b),w=E.parent.textBetween(0,E.parentOffset);if(!w.trim()||w.endsWith(" ")){const T=g.coordsAtPos(b);return h({x:T.left,y:T.bottom+5}),u(!0),c(""),p.preventDefault(),!0}}if(l){if(p.key==="Escape")return u(!1),c(""),!0;if(p.key==="Backspace")return m.length>0?c(y=>y.slice(0,-1)):u(!1),!0;if(p.key.length===1&&!p.ctrlKey&&!p.metaKey&&p.key!==" ")return c(y=>y+p.key),!0;if(p.key===" ")return u(!1),c(""),!0}return!1}}}),j=d.useCallback(()=>{const g=document.createElement("input");g.type="file",g.accept="image/*",g.onchange=p=>{const y=p.target.files?.[0];if(y&&C){const b=new FileReader;b.onload=E=>{const w=E.target?.result;C.chain().focus().setImage({src:w}).run()},b.readAsDataURL(y)}},g.click()},[C]);d.useEffect(()=>{if(!C)return;const g=y=>{const b=y.clipboardData?.items;if(b)for(let E=0;E<b.length;E++){const w=b[E];if(w.type.indexOf("image")!==-1){y.preventDefault();const k=w.getAsFile();if(k){const T=new FileReader;T.onload=$=>{const A=$.target?.result;C.chain().focus().setImage({src:A}).run()},T.readAsDataURL(k)}}}},p=C.view.dom;return p.addEventListener("paste",g),()=>{p.removeEventListener("paste",g)}},[C]);const N=d.useCallback(g=>{C&&C.chain().focus().insertContent(g).run(),u(!1),c("")},[C]),v=d.useCallback(()=>{u(!1),c("")},[]);return d.useEffect(()=>{if(!C)return;const g=y=>{y.key==="Escape"?l?(u(!1),c("")):n():y.key==="Enter"&&(y.ctrlKey||y.metaKey)&&r()},p=C.view.dom;return p.addEventListener("keydown",g),()=>{p.removeEventListener("keydown",g)}},[C,r,n,l]),d.useEffect(()=>{C&&i&&C.commands.focus()},[C,i]),C?s.jsxs("div",{className:_("relative z-20",o),ref:f,children:[s.jsxs("div",{className:"relative p-2 -m-2",children:[s.jsx(Xo,{editor:C,className:"min-h-[100px]"}),s.jsxs("div",{className:"absolute top-0 right-0 flex gap-1 opacity-60 hover:opacity-100 transition-opacity",children:[s.jsx(L,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white/90 hover:bg-white shadow-sm rounded",onClick:()=>u(!l),title:"Insert Emoji (Press / to open)",children:s.jsx(mo,{className:"h-3 w-3"})}),s.jsx(L,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white/90 hover:bg-white shadow-sm rounded",onClick:j,title:"Insert Image",children:s.jsx(pr,{className:"h-3 w-3"})})]})]}),l&&s.jsx(Si,{onEmojiSelect:N,onClose:v,query:m,position:x||void 0}),s.jsxs("div",{className:"flex justify-end gap-2 mt-2 pt-2 border-t border-border/30",children:[s.jsxs(L,{size:"sm",variant:"ghost",onClick:n,className:"h-7 px-3 text-xs",children:[s.jsx(at,{className:"h-3 w-3 mr-1"}),"Cancel"]}),s.jsxs(L,{size:"sm",onClick:r,className:"h-7 px-3 text-xs",children:[s.jsx(qe,{className:"h-3 w-3 mr-1"}),"Accept"]})]}),C&&s.jsxs("div",{className:"absolute top-0 right-0 text-xs text-muted-foreground bg-white/90 px-2 py-1 rounded shadow-sm opacity-0 hover:opacity-100 transition-opacity pointer-events-none z-10 max-w-xs",children:["**bold** *italic* # heading - list ",">"," quote `code` ~~strike~~ [link](url) [] task / emoji"]})]}):null}function ki({content:a,onUpdate:e,onSave:t,onCancel:r,className:n,autoFocus:o=!1}){const[i,l]=d.useState(a),u=d.useRef(null);d.useEffect(()=>{l(a)},[a]),d.useEffect(()=>{o&&u.current&&(u.current.focus(),u.current.select())},[o]);const m=x=>{l(x.target.value),e(x.target.value)},c=x=>{x.key==="Enter"?t():x.key==="Escape"&&r()};return s.jsxs("div",{className:_("relative",n),children:[s.jsx("input",{ref:u,type:"text",value:i,onChange:m,onKeyDown:c,className:"w-full bg-transparent border-none outline-none text-lg font-semibold resize-none pr-16",placeholder:"Card title..."}),s.jsxs("div",{className:"absolute right-0 top-0 flex gap-1",children:[s.jsx(L,{size:"sm",variant:"ghost",onClick:r,className:"h-6 w-6 p-0 bg-white/80 hover:bg-white shadow-sm",children:s.jsx(at,{className:"h-3 w-3"})}),s.jsx(L,{size:"sm",onClick:t,className:"h-6 w-6 p-0 bg-white/80 hover:bg-white shadow-sm",children:s.jsx(qe,{className:"h-3 w-3"})})]})]})}const Ei=a=>{const e=["#3b82f6","#8b5cf6","#10b981","#f59e0b","#ef4444","#06b6d4","#8b5a2b","#6b7280","#ec4899","#84cc16","#f97316","#6366f1"];let t=0;for(let r=0;r<a.length;r++)t=a.charCodeAt(r)+((t<<5)-t);return e[Math.abs(t)%e.length]},Di=({tags:a,className:e,maxTags:t=5,size:r="sm"})=>{if(!a||a.length===0)return null;const n=a.slice(0,t),o=a.length-t,i={sm:"text-xs px-2 py-1",md:"text-sm px-2.5 py-1.5",lg:"text-base px-3 py-2"};return s.jsxs("div",{className:_("flex flex-wrap gap-1.5 mt-3",e),children:[n.map((l,u)=>s.jsx("span",{className:_("inline-flex items-center rounded-full font-medium text-white","shadow-sm transition-all duration-200 hover:scale-105",i[r]),style:{backgroundColor:Ei(l),fontSize:r==="sm"?"0.75rem":r==="md"?"0.875rem":"1rem"},children:l},`${l}-${u}`)),o>0&&s.jsxs("span",{className:_("inline-flex items-center rounded-full bg-gray-500 text-white font-medium",i[r]),children:["+",o]})]})};function Ri({card:a,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onStyleChange:l,onTagsChange:u,onMoveToFolder:m,className:c,size:x="md"}){const[h,f]=d.useState(!1),[C,j]=d.useState(!1),[N,v]=d.useState(null),[g,p]=d.useState(null),[y,b]=d.useState(null),[E,w]=d.useState(!1),k=d.useRef(null),T=a.isFlipped?a.backContent:a.frontContent,$={sm:"w-full",md:"w-full",lg:"w-full"},A={sm:"p-3",md:"p-4",lg:"p-5"},G=()=>{const{style:B}=a,R={borderRadius:"1rem",fontFamily:B.fontFamily,fontSize:B.fontSize==="sm"?"0.875rem":B.fontSize==="lg"?"1.125rem":"1rem",fontWeight:B.fontWeight,color:B.textColor,borderWidth:B.borderWidth||0,borderColor:B.borderColor};let D="";return B.type==="gradient"&&B.gradientColors?(R.background=`linear-gradient(135deg, ${B.gradientColors.join(", ")})`,B.gradientColors.includes("#8a2be2")&&B.gradientColors.includes("#00ffff")?(D="gradient-wave-animation",R.position="relative"):B.gradientColors.includes("#ee7752")&&B.gradientColors.includes("#23d5ab")?D="moving-gradient-animation":B.gradientColors.includes("#667eea")&&(D="gradient-mesh-animation")):B.type==="glass"?(R.background=B.backgroundColor||"rgba(255, 255, 255, 0.15)",R.backdropFilter="blur(20px) saturate(180%)",R.WebkitBackdropFilter="blur(20px) saturate(180%)",R.border=`1px solid ${B.borderColor||"rgba(255, 255, 255, 0.18)"}`,D="glass-morphism"):B.backgroundColor&&B.backgroundColor.includes("linear-gradient")?(R.background=B.backgroundColor,R.backgroundSize="400% 400%",B.backgroundColor.includes("#667eea")&&(D="gradient-mesh-animation")):(R.backgroundColor=B.backgroundColor,B.backgroundColor==="#1a1a2e"&&B.borderColor==="#4361ee"?D="pulse-border-animation":B.backgroundColor==="#0f172a"&&(D="glow-hover-animation")),{style:R,shadowClass:{sm:"shadow-sm",md:"shadow-md",lg:"shadow-lg",xl:"shadow-xl",none:"","2xl":"shadow-2xl",glass:"shadow-lg"}[B.shadow||"md"]||"shadow-md",specialClasses:D}},{style:te,shadowClass:W,specialClasses:ee}=G(),ae=d.useCallback(B=>{B.stopPropagation(),B.preventDefault(),!E&&(w(!0),e(a.id),setTimeout(()=>{w(!1)},600))},[a.id,e,E]),re=B=>{B.stopPropagation(),z("content")},fe=B=>{z(B)},z=B=>{p(T),b(T),v(B),j(!0)},Y=(B,R)=>{y&&b({...y,[B]:R,lastModified:new Date})},M=()=>{if(y){const R={[a.isFlipped?"backContent":"frontContent"]:y};t(a.id,R)}j(!1),v(null),p(null),b(null)},F=()=>{j(!1),v(null),p(null),b(null)},I=B=>{Y("title",B.target.value)},H=B=>{Y("text",B.target.value)},q=B=>{B.key==="Escape"&&F(),B.key==="Enter"&&B.ctrlKey&&M()};return s.jsx("div",{className:_("relative group",c),"data-card-id":a.id,onMouseEnter:()=>f(!0),onMouseLeave:()=>f(!1),children:s.jsx("div",{className:"flip-card-container",style:{perspective:"1000px",width:"100%",minHeight:"fit-content"},children:s.jsxs("div",{ref:k,className:_("flip-card-inner relative transition-all duration-700 ease-in-out",$[x]),style:{minHeight:"fit-content",width:"100%",transformStyle:"preserve-3d",transform:a.isFlipped?"rotateY(180deg)":"rotateY(0deg)"},children:[s.jsx("div",{className:_("flip-card-face flip-card-front w-full flex flex-col transition-all duration-300 relative",W,ee,A[x]),style:{...te,borderRadius:te.borderRadius,backfaceVisibility:"hidden",position:a.isFlipped?"absolute":"relative",opacity:a.isFlipped?0:1},children:s.jsx(ra,{content:y||a.frontContent,isEditing:C&&!a.isFlipped,editingField:N,onTitleChange:I,onTextChange:H,onTempContentUpdate:Y,onSaveEdit:M,onCancelEdit:F,onDoubleClick:fe,onKeyDown:q,sideLabel:"Front",isHovered:h,onEdit:re,onFlip:ae,onCopy:()=>r(a.id),onScreenshot:()=>n(a.id),onShare:()=>o(a.id),onDelete:()=>i(a.id),onStyleChange:l?()=>l(a.id):void 0,onTagsChange:u?()=>u(a.id):void 0,onMoveToFolder:m,card:a,isFlipping:E})}),s.jsx("div",{className:_("flip-card-face flip-card-back w-full flex flex-col transition-all duration-300 relative",W,ee,A[x]),style:{...te,borderRadius:te.borderRadius,backfaceVisibility:"hidden",transform:"rotateY(180deg)",position:a.isFlipped?"relative":"absolute",top:a.isFlipped?"auto":"0",opacity:a.isFlipped?1:0},children:s.jsx(ra,{content:y||a.backContent,isEditing:C&&a.isFlipped,editingField:N,onTitleChange:I,onTextChange:H,onTempContentUpdate:Y,onSaveEdit:M,onCancelEdit:F,onDoubleClick:fe,onKeyDown:q,sideLabel:"Back",isHovered:h,onEdit:re,onFlip:ae,onCopy:()=>r(a.id),onScreenshot:()=>n(a.id),onShare:()=>o(a.id),onDelete:()=>i(a.id),onStyleChange:l?()=>l(a.id):void 0,onTagsChange:u?()=>u(a.id):void 0,onMoveToFolder:m,card:a,isFlipping:E})})]})})})}function Ti({images:a}){const e=a.slice(0,4),t=e.length,r=o=>{switch(o){case 1:return"flex justify-center";case 2:return"grid grid-cols-2 gap-2";case 3:return"grid grid-cols-2 gap-2";case 4:default:return"grid grid-cols-2 gap-2"}},n=(o,i)=>{const l="relative aspect-video rounded-md overflow-hidden bg-muted transition-all duration-200 hover:scale-[1.02]";return o===1?`${l} max-w-xs w-full`:o===3&&i===2?`${l} col-span-2 max-w-xs mx-auto`:l};return s.jsx("div",{className:r(t),children:e.map((o,i)=>s.jsx("div",{className:n(t,i),children:s.jsx("img",{src:o.url,alt:o.alt||`Image ${i+1}`,className:"w-full h-full object-cover transition-transform duration-200",loading:"lazy"})},i))})}function ra({content:a,isEditing:e,editingField:t,onTitleChange:r,onTextChange:n,onTempContentUpdate:o,onSaveEdit:i,onCancelEdit:l,onDoubleClick:u,onKeyDown:m,sideLabel:c,isHovered:x,onEdit:h,onFlip:f,onCopy:C,onScreenshot:j,onShare:N,onDelete:v,onStyleChange:g,onTagsChange:p,onMoveToFolder:y,card:b,isFlipping:E}){return s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsxs("div",{className:"flex items-start justify-between mb-3",children:[s.jsx("div",{className:"flex-1 mr-2",children:e&&t==="title"?s.jsx(ki,{content:a.title,onUpdate:w=>o("title",w),onSave:i,onCancel:l,autoFocus:!0}):s.jsx("h3",{className:"text-lg font-semibold text-left cursor-pointer hover:bg-black/5 rounded px-1 py-0.5 -mx-1 transition-colors",onDoubleClick:()=>u("title"),children:a.title||"Untitled Card"})}),s.jsxs("div",{className:_("flex gap-1 transition-all duration-200 flex-shrink-0",x||e?"opacity-100":"opacity-60"),children:[s.jsx(L,{size:"sm",variant:"ghost",className:_("h-7 w-7 p-0 rounded-md hover:bg-black/10 transition-all duration-200",E&&"animate-pulse"),onClick:f,title:`Flip to ${b.isFlipped?"Front":"Back"}`,disabled:E,children:s.jsx(fo,{className:_("h-3.5 w-3.5 transition-transform duration-200",E&&"scale-110")})}),s.jsxs(xi,{modal:!1,children:[s.jsx(yi,{asChild:!0,children:s.jsx("div",{className:"h-7 w-7 rounded-md hover:bg-black/10 flex items-center justify-center cursor-pointer transition-colors group",onMouseEnter:w=>{w.stopPropagation();const k=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});w.currentTarget.dispatchEvent(k)},onClick:w=>w.stopPropagation(),children:s.jsx(go,{className:"h-3.5 w-3.5"})})}),s.jsxs(Dr,{align:"end",className:"w-48",children:[s.jsxs(Be,{onClick:h,children:[s.jsx(ho,{className:"h-4 w-4 mr-2"}),"Edit Content"]}),s.jsxs(Be,{onClick:C,children:[s.jsx(po,{className:"h-4 w-4 mr-2"}),"Copy Text"]}),s.jsxs(Be,{onClick:j,children:[s.jsx(Rs,{className:"h-4 w-4 mr-2"}),"Screenshot"]}),s.jsxs(Be,{onClick:N,children:[s.jsx(xo,{className:"h-4 w-4 mr-2"}),"Share"]}),s.jsx(Ms,{}),g&&s.jsxs(Be,{onClick:g,children:[s.jsx(xr,{className:"h-4 w-4 mr-2"}),"Change Style"]}),p&&s.jsxs(Be,{onClick:p,children:[s.jsx(yr,{className:"h-4 w-4 mr-2"}),"Manage Tags"]}),y&&s.jsxs(Be,{onClick:y,children:[s.jsx(qt,{className:"h-4 w-4 mr-2"}),"Move to Folder"]}),s.jsx(Ms,{}),s.jsxs(Be,{onClick:v,className:"text-destructive focus:text-destructive",children:[s.jsx(Ls,{className:"h-4 w-4 mr-2"}),"Delete Card"]})]})]})]})]}),a.images.length>0&&s.jsxs("div",{className:"mb-3 flex-shrink-0",children:[s.jsx(Ti,{images:a.images}),a.images.length>4&&s.jsxs("div",{className:"text-xs text-muted-foreground mt-1 text-center",children:["+",a.images.length-4," more images"]})]}),s.jsx("div",{className:"flex-1 mb-3 relative z-10",children:e&&t==="content"?s.jsx(Ni,{content:a.text,placeholder:"Add your content here...",onUpdate:w=>o("text",w),onSave:i,onCancel:l,autoFocus:!0}):s.jsx("div",{className:"text-sm leading-relaxed text-left cursor-pointer hover:bg-black/5 rounded p-2 -m-2 transition-colors min-h-[100px] tiptap-editor relative z-10",onDoubleClick:w=>{w.target.tagName!=="A"&&u("content")},onClick:w=>{const k=w.target;if(k.tagName==="A"){w.stopPropagation();const T=k.getAttribute("href");T&&window.open(T,"_blank","noopener,noreferrer")}},children:s.jsx("div",{className:"whitespace-pre-wrap",dangerouslySetInnerHTML:{__html:a.text||'<span class="text-muted-foreground">Click to add content...</span>'}})})}),s.jsxs("div",{className:"mt-auto",children:[s.jsx(Di,{tags:a.tags,size:"sm"}),a.images.length>0&&s.jsx("div",{className:"flex items-center justify-end text-xs text-muted-foreground mt-2",children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(pr,{className:"h-3 w-3"}),s.jsx("span",{children:a.images.length})]})})]})]})}const Te=({title:a="Sample Card",content:e="This is a preview of how your card will look with this style.",style:t,isSelected:r=!1,onClick:n,className:o})=>{console.log("Rendering StylePreviewCard (Simplified):",{title:a,isSelected:r,style:t});const i=()=>{const l={minHeight:"60px",width:"100%",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",padding:"8px",borderRadius:"8px",cursor:"pointer",border:r?"2px solid #3b82f6":"1px solid #e5e7eb",position:"relative",fontSize:"10px",textAlign:"center",boxShadow:r?"0 4px 12px rgba(59, 130, 246, 0.3)":"0 2px 4px rgba(0, 0, 0, 0.1)",transition:"all 0.2s ease",backgroundColor:"#ffffff"};if(typeof t=="object"&&t!==null){if("background"in t||"backgroundColor"in t)return{...l,...t,cursor:"pointer",border:r?"3px solid #3b82f6":t.border||"2px solid #e5e7eb",boxShadow:r?"0 4px 12px rgba(59, 130, 246, 0.3)":t.boxShadow||"0 2px 4px rgba(0, 0, 0, 0.1)",transition:"all 0.2s ease"};if("type"in t){if(t.type==="solid")return{...l,backgroundColor:t.backgroundColor||"#ffffff",color:t.textColor||"#374151"};if(t.type==="gradient"&&t.gradientColors){const m=`linear-gradient(${t.gradientDirection||"to bottom right"}, ${t.gradientColors.join(", ")})`;return{...l,background:m,color:t.textColor||"#ffffff"}}}}return l};return s.jsxs("div",{style:i(),onClick:n,className:o,children:[s.jsx("div",{style:{fontWeight:"600",marginBottom:"2px",fontSize:"11px"},children:a}),s.jsx("div",{style:{fontSize:"9px",opacity:.8,lineHeight:"1.1"},children:e})]})},Ai=({isSelected:a,onClick:e,className:t})=>{const r={background:"#ffffff",color:"#1f2937",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"400",borderRadius:"12px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",border:"1px solid #e5e7eb"};return s.jsx(Te,{title:"Classic White",content:"Clean and professional",style:r,isSelected:a,onClick:e,className:t})},Ii={id:"classic-white",name:"Classic White",category:"business",description:"Clean and professional white background with subtle shadows",style:{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"2xl",shadow:"md",borderWidth:1,borderColor:"#e5e7eb"},previewComponent:Ai},_i=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #1f2937 0%, #111827 50%, #030712 100%)",color:"#f9fafb",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"12px",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1)",border:"1px solid rgba(255, 255, 255, 0.1)"};return s.jsx(Te,{title:"Deep Dark",content:"Bold and mysterious",style:r,isSelected:a,onClick:e,className:t})},Mi={id:"deep-dark",name:"Deep Dark",category:"personality",description:"Bold dark gradient with mysterious depth",style:{type:"gradient",gradientColors:["#1f2937","#111827","#030712"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#f9fafb",borderRadius:"2xl",shadow:"2xl",borderWidth:1,borderColor:"rgba(255, 255, 255, 0.1)"},previewComponent:_i},Fi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #c084fc 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"20px",boxShadow:"0 20px 25px -5px rgba(139, 92, 246, 0.25), 0 10px 10px -5px rgba(139, 92, 246, 0.1)",border:"none"};return s.jsx(Te,{title:"Elegant Purple",content:"Artistic and inspiring",style:r,isSelected:a,onClick:e,className:t})},Oi={id:"elegant-purple",name:"Elegant Purple",category:"creative",description:"Artistic purple gradient with elegant curves and shadows",style:{type:"gradient",gradientColors:["#8b5cf6","#a855f7","#c084fc"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Fi},Pi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"16px",boxShadow:"0 20px 25px -5px rgba(16, 185, 129, 0.2), 0 10px 10px -5px rgba(16, 185, 129, 0.1)",border:"none"};return s.jsx(Te,{title:"Fresh Green",content:"Natural and harmonious",style:r,isSelected:a,onClick:e,className:t})},Li={id:"fresh-green",name:"Fresh Green",category:"natural",description:"Natural green gradient with organic harmony",style:{type:"gradient",gradientColors:["#10b981","#059669","#047857"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Pi},$i=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%)",backgroundSize:"400% 400%",animation:"gradientShift 8s ease infinite",color:"#ffffff",fontFamily:'"Inter", system-ui, -apple-system, sans-serif',fontSize:"14px",fontWeight:"500",borderRadius:"12px",boxShadow:"0 8px 32px rgba(102, 126, 234, 0.3), 0 4px 16px rgba(118, 75, 162, 0.2)",border:"none",position:"relative",overflow:"hidden"},n={position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%)",pointerEvents:"none"};return s.jsxs("div",{style:{position:"relative"},children:[s.jsx(Te,{title:"Gradient Mesh",content:"Dynamic gradient background",style:r,isSelected:a,onClick:e,className:t}),s.jsx("div",{style:n}),s.jsx("style",{jsx:!0,children:`
        @keyframes gradientShift {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
      `})]})},zi={id:"gradient-mesh",name:"Gradient Mesh",category:"creative",description:"Dynamic gradient background with animated mesh effect",style:{type:"solid",backgroundColor:"linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%)",fontFamily:"Inter",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"xl",borderWidth:0,borderColor:"transparent"},previewComponent:$i},Bi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(90deg, #fb923c 0%, #8b5cf6 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"24px",boxShadow:"0 25px 50px -12px rgba(251, 146, 60, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2)",border:"none"};return s.jsx(Te,{title:"Gradient Sunset",content:"Vibrant and expressive",style:r,isSelected:a,onClick:e,className:t})},Ui={id:"gradient-sunset",name:"Gradient Sunset",category:"personality",description:"Warm orange to violet gradient with magical sunset vibes",style:{type:"gradient",gradientColors:["#fb923c","#8b5cf6"],gradientDirection:"to-r",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Bi},Vi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #8a2be2 0%, #4b0082 25%, #9370db 50%, #00ffff 75%, #00bfff 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"24px",boxShadow:"0 25px 50px -12px rgba(138, 43, 226, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2)",border:"none",position:"relative",overflow:"hidden"};return s.jsx("div",{className:"relative",children:s.jsx(Te,{title:"Gradient Wave",content:"Dynamic wave effect",style:r,isSelected:a,onClick:e,className:`${t} gradient-wave-animation`})})},Wi={id:"gradient-wave",name:"Gradient Wave",category:"creative",description:"Purple to cyan gradient with dynamic wave effect",style:{type:"gradient",gradientColors:["#8a2be2","#4b0082","#9370db","#00ffff","#00bfff"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Vi},Hi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"16px",boxShadow:"0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1)",border:"none"};return s.jsx(Te,{title:"Modern Blue",content:"Contemporary gradient design",style:r,isSelected:a,onClick:e,className:t})},Gi={id:"modern-blue",name:"Modern Blue",category:"business",description:"Contemporary blue gradient with professional appeal",style:{type:"gradient",gradientColors:["#3b82f6","#1d4ed8","#1e40af"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"lg",borderWidth:0},previewComponent:Hi},Ki=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab)",backgroundSize:"400% 400%",color:"#ffffff",fontFamily:'"Poppins", system-ui, sans-serif',fontSize:"14px",fontWeight:"600",borderRadius:"16px",boxShadow:"0 15px 30px -10px rgba(0, 0, 0, 0.25)",border:"none",position:"relative",overflow:"hidden"};return s.jsx("div",{className:"relative",children:s.jsx(Te,{title:"Moving Gradient",content:"Flowing color effect",style:r,isSelected:a,onClick:e,className:`${t} moving-gradient-animation`})})},Yi={id:"moving-gradient",name:"Moving Gradient",category:"creative",description:"Colorful gradient with flowing animation effect",style:{type:"gradient",gradientColors:["#ee7752","#e73c7e","#23a6d5","#23d5ab"],gradientDirection:"to-br",fontFamily:"Poppins",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"xl",shadow:"xl",borderWidth:0},previewComponent:Ki},qi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(90deg, #34d399 0%, #0d9488 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"20px",boxShadow:"0 10px 15px -3px rgba(52, 211, 153, 0.3), 0 4px 6px -2px rgba(13, 148, 136, 0.1)",border:"1px solid rgba(52, 211, 153, 0.3)"};return s.jsx(Te,{title:"Ocean Breeze",content:"Fresh and refreshing",style:r,isSelected:a,onClick:e,className:t})},Ji={id:"ocean-breeze",name:"Ocean Breeze",category:"natural",description:"Fresh emerald to teal gradient with tropical vibes",style:{type:"gradient",gradientColors:["#34d399","#0d9488"],gradientDirection:"to-r",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"lg",borderWidth:1,borderColor:"rgba(52, 211, 153, 0.3)"},previewComponent:qi},Xi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(90deg, #fda4af 0%, #f87171 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"20px",boxShadow:"0 10px 15px -3px rgba(253, 164, 175, 0.3), 0 4px 6px -2px rgba(248, 113, 113, 0.1)",border:"1px solid rgba(253, 164, 175, 0.3)"};return s.jsx(Te,{title:"Soft Pink",content:"Gentle and soothing",style:r,isSelected:a,onClick:e,className:t})},Qi={id:"soft-pink",name:"Soft Pink",category:"natural",description:"Warm pink to red gradient with romantic tones",style:{type:"gradient",gradientColors:["#fda4af","#f87171"],gradientDirection:"to-r",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"lg",borderWidth:1,borderColor:"rgba(253, 164, 175, 0.3)"},previewComponent:Xi},Zi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"18px",boxShadow:"0 25px 50px -12px rgba(255, 126, 95, 0.25), 0 0 0 1px rgba(255, 126, 95, 0.1)",border:"none"};return s.jsx(Te,{title:"Warm Orange",content:"Energetic and vibrant",style:r,isSelected:a,onClick:e,className:t})},el={id:"warm-orange",name:"Warm Orange",category:"creative",description:"Energetic warm orange gradient with peachy tones",style:{type:"gradient",gradientColors:["#ff7e5f","#feb47b"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Zi};class ct{static instance;presets=new Map;categories=new Map;constructor(){this.initializeCategories()}static getInstance(){return ct.instance||(ct.instance=new ct),ct.instance}initializeCategories(){["business","creative","natural","personality"].forEach(t=>{this.categories.set(t,[])})}register(e){this.presets.set(e.id,e);const t=this.categories.get(e.category)||[];t.push(e),this.categories.set(e.category,t)}unregister(e){const t=this.presets.get(e);if(t){this.presets.delete(e);const n=(this.categories.get(t.category)||[]).filter(o=>o.id!==e);this.categories.set(t.category,n)}}getByCategory(e){return this.categories.get(e)||[]}getById(e){return this.presets.get(e)}getAll(){return Array.from(this.presets.values())}getAllByOrder(){const e=[];return["business","creative","natural","personality"].forEach(r=>{const n=this.getByCategory(r);e.push(...n)}),e}getCategoryCount(e){return this.categories.get(e)?.length||0}getTotalCount(){return this.presets.size}clear(){this.presets.clear(),this.initializeCategories()}}const Ws=ct.getInstance(),tl=()=>Ws.getAllByOrder();class dt{static instance;STORAGE_KEYS={USER_PREFERENCES:"cardall_style_preferences",RECENT_STYLES:"cardall_recent_styles",DEFAULT_STYLE:"cardall_default_style"};constructor(){}static getInstance(){return dt.instance||(dt.instance=new dt),dt.instance}saveUserPreference(e,t){try{const r=this.getUserPreferences();r[e]={styleId:t,appliedAt:new Date().toISOString()},localStorage.setItem(this.STORAGE_KEYS.USER_PREFERENCES,JSON.stringify(r)),this.addToRecentStyles(t)}catch(r){console.error("Failed to save user style preference:",r)}}getUserPreference(e){try{return this.getUserPreferences()[e]?.styleId||null}catch(t){return console.error("Failed to get user style preference:",t),null}}getRecentStyles(e=10){try{const t=localStorage.getItem(this.STORAGE_KEYS.RECENT_STYLES);return t?JSON.parse(t).slice(0,e):[]}catch(t){return console.error("Failed to get recent styles:",t),[]}}clearPreferences(){try{localStorage.removeItem(this.STORAGE_KEYS.USER_PREFERENCES),localStorage.removeItem(this.STORAGE_KEYS.RECENT_STYLES)}catch(e){console.error("Failed to clear style preferences:",e)}}setDefaultStyle(e){try{localStorage.setItem(this.STORAGE_KEYS.DEFAULT_STYLE,e)}catch(t){console.error("Failed to set default style:",t)}}getDefaultStyle(){try{return localStorage.getItem(this.STORAGE_KEYS.DEFAULT_STYLE)}catch(e){return console.error("Failed to get default style:",e),null}}getUserPreferences(){try{const e=localStorage.getItem(this.STORAGE_KEYS.USER_PREFERENCES);return e?JSON.parse(e):{}}catch(e){return console.error("Failed to parse user preferences:",e),{}}}addToRecentStyles(e){try{const r=this.getRecentStyles().filter(o=>o!==e),n=[e,...r].slice(0,10);localStorage.setItem(this.STORAGE_KEYS.RECENT_STYLES,JSON.stringify(n))}catch(t){console.error("Failed to update recent styles:",t)}}getStyleUsageStats(){try{const e=this.getUserPreferences(),t={};return Object.values(e).forEach(({styleId:r})=>{t[r]=(t[r]||0)+1}),t}catch(e){return console.error("Failed to get style usage stats:",e),{}}}getMostUsedStyles(e=5){try{const t=this.getStyleUsageStats();return Object.entries(t).sort(([,r],[,n])=>n-r).slice(0,e).map(([r])=>r)}catch(t){return console.error("Failed to get most used styles:",t),[]}}}const na=dt.getInstance(),sl=()=>{const a=[Ii,Gi,Oi,el,Li,Qi,Ji,Mi,Ui,zi,Wi,Yi];a.forEach(e=>{Ws.register(e)}),console.log(`Registered ${a.length} card style presets`)};sl();const al=({isOpen:a,onClose:e,context:t})=>{const[r,n]=d.useState(null),[o,i]=d.useState([]);d.useEffect(()=>{const m=tl();console.log("Loaded style presets:",m.length,m),i(m);const c=na.getUserPreference(t.targetCardId);c&&n(c)},[t.targetCardId]);const l=m=>{const c=Ws.getById(m);c&&(n(m),t.onStyleApply(c.style),na.saveUserPreference(t.targetCardId,m))},u=()=>{n(null),e()};return a?s.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",style:{backgroundColor:"rgba(0, 0, 0, 0.1)",backdropFilter:"blur(2px)"},children:[s.jsx("div",{className:"absolute inset-0",onClick:u}),s.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl border border-gray-200 p-6 w-full max-w-md sm:max-w-2xl lg:max-w-4xl",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Card Styles"}),s.jsx("button",{onClick:u,className:"p-1 rounded-lg hover:bg-gray-100 transition-colors",children:s.jsx(at,{className:"w-5 h-5 text-gray-500"})})]}),s.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 mb-6",style:{minHeight:"300px",maxHeight:"70vh",overflowY:"auto"},children:o.map(m=>{const c=m.previewComponent;return console.log("Rendering preset:",m.id,m.name,c),s.jsxs("div",{className:"relative",children:[s.jsx(c,{isSelected:r===m.id,onClick:()=>l(m.id),className:"w-full"}),s.jsxs("div",{className:"mt-2 text-center",children:[s.jsx("div",{className:"text-xs font-medium text-gray-700 truncate",children:m.name}),s.jsx("div",{className:"text-xs text-gray-500 capitalize",children:m.category})]})]},m.id)})}),s.jsxs("div",{className:"text-xs text-gray-400 text-center mb-2",children:["Loaded ",o.length," presets"]}),s.jsx("div",{className:"text-xs text-gray-500 text-center",children:"Click any style to apply it instantly to your card"})]})]}):null},Rr=d.createContext(void 0),rl=()=>{const a=d.useContext(Rr);if(!a)throw new Error("useStylePanel must be used within a StylePanelProvider");return a},nl=({children:a})=>{const[e,t]=d.useState({isOpen:!1,context:null}),r=i=>{t({isOpen:!0,context:i})},n=()=>{t({isOpen:!1,context:null})},o={openStylePanel:r,closeStylePanel:n,isOpen:e.isOpen};return s.jsxs(Rr.Provider,{value:o,children:[a,typeof window<"u"&&e.isOpen&&e.context&&Qt.createPortal(s.jsx(al,{isOpen:e.isOpen,onClose:n,context:e.context}),document.body)]})},Tr=d.createContext(void 0);function ol({children:a}){const[e,t]=d.useState(!1),[r,n]=d.useState(null),[o,i]=d.useState([]),[l,u]=d.useState(null),x={isOpen:e,currentCardId:r,currentCardTags:o,onTagsChange:l,openTagPanel:h=>{n(h.targetCardId),i(h.currentTags),u(()=>h.onTagsApply),t(!0)},closeTagPanel:()=>{t(!1),n(null),i([]),u(null)}};return s.jsx(Tr.Provider,{value:x,children:a})}function Ar(){const a=d.useContext(Tr);if(a===void 0)throw new Error("useTagPanel must be used within a TagPanelProvider");return a}const ve=d.forwardRef(({className:a,type:e,...t},r)=>s.jsx("input",{type:e,className:_("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",a),ref:r,...t}));ve.displayName="Input";const Ye=d.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Ta,{ref:r,className:_("relative overflow-hidden",a),...t,children:[s.jsx(Mn,{className:"h-full w-full rounded-[inherit]",children:e}),s.jsx(Ir,{}),s.jsx(Fn,{})]}));Ye.displayName=Ta.displayName;const Ir=d.forwardRef(({className:a,orientation:e="vertical",...t},r)=>s.jsx(Aa,{ref:r,orientation:e,className:_("flex touch-none select-none transition-colors",e==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",e==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",a),...t,children:s.jsx(On,{className:"relative flex-1 rounded-full bg-border"})}));Ir.displayName=Aa.displayName;const il=Zt("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function Z({className:a,variant:e,...t}){return s.jsx("div",{className:_(il({variant:e}),a),...t})}const st=$n,ll=Pn,_r=d.forwardRef(({className:a,...e},t)=>s.jsx(Ia,{ref:t,className:_("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...e}));_r.displayName=Ia.displayName;const Je=d.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(ll,{children:[s.jsx(_r,{}),s.jsxs(_a,{ref:r,className:_("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...t,children:[e,s.jsxs(Ln,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[s.jsx(at,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Je.displayName=_a.displayName;const wt=({className:a,...e})=>s.jsx("div",{className:_("flex flex-col space-y-1.5 text-center sm:text-left",a),...e});wt.displayName="DialogHeader";const bt=({className:a,...e})=>s.jsx("div",{className:_("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...e});bt.displayName="DialogFooter";const vt=d.forwardRef(({className:a,...e},t)=>s.jsx(Ma,{ref:t,className:_("text-lg font-semibold leading-none tracking-tight",a),...e}));vt.displayName=Ma.displayName;const ss=d.forwardRef(({className:a,...e},t)=>s.jsx(Fa,{ref:t,className:_("text-sm text-muted-foreground",a),...e}));ss.displayName=Fa.displayName;function cl({isOpen:a,onClose:e,currentCardId:t,currentFolderId:r,onFolderSelect:n}){const{folders:o,getFolderById:i}=Sr(),[l,u]=d.useState(""),[m,c]=d.useState(r);d.useEffect(()=>{a&&(c(r),u(""))},[a,r]);const x=o.filter(v=>v.name.toLowerCase().includes(l.toLowerCase())),h=r?i(r):null,f=v=>{c(v)},C=()=>{n&&n(m),e()},j=()=>{c(r),e()},N=m!==r;return s.jsx(st,{open:a,onOpenChange:e,children:s.jsxs(Je,{className:"sm:max-w-md",children:[s.jsx(wt,{children:s.jsxs(vt,{className:"flex items-center gap-2",children:[s.jsx(Ge,{className:"h-5 w-5"}),"Move Card to Folder"]})}),s.jsxs("div",{className:"space-y-4",children:[h&&s.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted rounded-lg",children:[s.jsx(qt,{className:"h-4 w-4 text-muted-foreground"}),s.jsx("span",{className:"text-sm text-muted-foreground",children:"Currently in:"}),s.jsx(Z,{variant:"secondary",children:h.name})]}),!h&&s.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted rounded-lg",children:[s.jsx(Js,{className:"h-4 w-4 text-muted-foreground"}),s.jsx("span",{className:"text-sm text-muted-foreground",children:"Currently in: Root"})]}),s.jsxs("div",{className:"relative",children:[s.jsx(ft,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{placeholder:"Search folders...",value:l,onChange:v=>u(v.target.value),className:"pl-10"})]}),s.jsx(Ye,{className:"h-64 w-full border rounded-md",children:s.jsxs("div",{className:"p-2 space-y-1",children:[s.jsxs("div",{className:_("flex items-center gap-3 p-2 rounded-md cursor-pointer transition-colors",m===null?"bg-primary text-primary-foreground":"hover:bg-muted"),onClick:()=>f(null),children:[s.jsx(Js,{className:"h-4 w-4 flex-shrink-0"}),s.jsx("span",{className:"flex-1",children:"Root"}),m===null&&s.jsx(qe,{className:"h-4 w-4 flex-shrink-0"}),r===null&&s.jsx(Z,{variant:"outline",className:"text-xs",children:"Current"})]}),x.map(v=>s.jsxs("div",{className:_("flex items-center gap-3 p-2 rounded-md cursor-pointer transition-colors",m===v.id?"bg-primary text-primary-foreground":"hover:bg-muted",r===v.id&&"opacity-60"),onClick:()=>f(v.id),children:[s.jsx(Ge,{className:"h-4 w-4 flex-shrink-0"}),s.jsx("span",{className:"flex-1",children:v.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Z,{variant:"outline",className:"text-xs",children:v.cardIds.length}),m===v.id&&s.jsx(qe,{className:"h-4 w-4 flex-shrink-0"}),r===v.id&&s.jsx(Z,{variant:"outline",className:"text-xs",children:"Current"})]})]},v.id)),x.length===0&&l&&s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx(Ge,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),s.jsx("p",{className:"text-sm",children:"No folders found"})]})]})})]}),s.jsxs(bt,{children:[s.jsx(L,{variant:"outline",onClick:j,children:"Cancel"}),s.jsx(L,{onClick:C,disabled:!N,children:N?"Move Card":"No Change"})]})]})})}const Mr=d.createContext(void 0);function dl({children:a}){const[e,t]=d.useState(!1),[r,n]=d.useState(null),[o,i]=d.useState(null),[l,u]=d.useState(null),m=h=>{n(h.targetCardId),i(h.currentFolderId||null),u(()=>h.onFolderApply),t(!0)},c=()=>{t(!1),n(null),i(null),u(null)},x={isOpen:e,currentCardId:r,currentFolderId:o,onFolderSelect:l,openFolderPanel:m,closeFolderPanel:c};return s.jsxs(Mr.Provider,{value:x,children:[a,typeof window<"u"&&e&&r&&Qt.createPortal(s.jsx(cl,{isOpen:e,onClose:c,currentCardId:r,currentFolderId:o,onFolderSelect:l}),document.body)]})}function ul(){const a=d.useContext(Mr);if(a===void 0)throw new Error("useFolderPanel must be used within a FolderPanelProvider");return a}function ml({card:a,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onMoveToFolder:l,className:u,size:m="md"}){const{openStylePanel:c}=rl(),{openTagPanel:x}=Ar(),{openFolderPanel:h}=ul(),f=(g,p)=>{t(g,{style:p,updatedAt:new Date})},C=()=>{c({targetCardId:a.id,currentStyle:a.style,onStyleApply:g=>f(a.id,g),onPanelClose:()=>{}})},j=(g,p)=>{const y=a.isFlipped?a.backContent:a.frontContent,b=a.isFlipped?"backContent":"frontContent";t(g,{[b]:{...y,tags:p,lastModified:new Date},updatedAt:new Date})},N=()=>{const g=a.isFlipped?a.backContent:a.frontContent;x({targetCardId:a.id,currentTags:g.tags,onTagsApply:p=>j(a.id,p),onPanelClose:()=>{}})},v=()=>{l&&h({targetCardId:a.id,currentFolderId:a.folderId,onFolderApply:g=>l(a.id,g),onPanelClose:()=>{}})};return s.jsx(Ri,{card:a,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onStyleChange:C,onTagsChange:N,onMoveToFolder:l?v:void 0,className:u,size:m})}function fl({items:a,gap:e=16,minColumnWidth:t=280,maxColumns:r=5,breakpoints:n={sm:640,md:768,lg:1024,xl:1280,"2xl":1536}}){const o=d.useRef(null),[i,l]=d.useState(new Map),[u,m]=d.useState(0),[c,x]=d.useState({columns:1,gap:e,containerWidth:0}),h=d.useCallback(v=>{if(v===0)return 1;let g=r;v<n.sm?g=1:v<n.md?g=2:v<n.lg?g=3:v<n.xl&&(g=4);const p=v-e,y=Math.floor(p/(t+e));return Math.min(Math.max(1,y),g)},[e,t,r,n]),f=d.useCallback((v,g,p,y)=>{if(g===0||p===0)return{positions:new Map,totalHeight:0};const b=y*(g-1),E=p-b,w=Math.floor(E/g),k=new Array(g).fill(0),T=new Map;v.forEach(A=>{const G=k.indexOf(Math.min(...k)),te=G*(w+y),W=k[G];T.set(A.id,{x:te,y:W,width:w,height:A.height}),k[G]+=A.height+y});const $=Math.max(...k)-y;return{positions:T,totalHeight:$}},[]),C=d.useCallback(v=>{const g=v[0];if(!g)return;const p=g.contentRect.width,y=h(p);x(b=>({...b,columns:y,containerWidth:p}))},[h]);d.useEffect(()=>{const v=o.current;if(!v)return;const g=new ResizeObserver(p=>{C(p)});return g.observe(v),()=>{g.disconnect()}},[C]),d.useEffect(()=>{if(a.length===0||c.containerWidth===0){l(new Map),m(0);return}const{positions:v,totalHeight:g}=f(a,c.columns,c.containerWidth,e);l(v),m(g)},[a,c,e,f]);const j=d.useCallback(v=>i.get(v),[i]),N=d.useCallback((v,g)=>{const p=a.findIndex(w=>w.id===v);if(p===-1)return;const y=[...a];y[p]={...y[p],height:g};const{positions:b,totalHeight:E}=f(y,c.columns,c.containerWidth,e);l(b),m(E)},[a,c,e,f]);return{containerRef:o,positions:i,containerHeight:u,config:c,getItemPosition:j,updateItemHeight:N}}function gl({cards:a,onCardFlip:e,onCardUpdate:t,onCardCopy:r,onCardScreenshot:n,onCardShare:o,onCardDelete:i,onMoveToFolder:l,onCardStyleChange:u,cardSize:m="md",className:c,gap:x=16,enableVirtualization:h=!0,overscan:f=5}){const[C,j]=d.useState(new Map),[N,v]=d.useState(!1),[g,p]=d.useState(0),[y,b]=d.useState(0),E=d.useRef(new Map),w=d.useRef(null),k=d.useMemo(()=>[...a].sort((z,Y)=>new Date(Y.createdAt).getTime()-new Date(z.createdAt).getTime()),[a]),T=d.useCallback(z=>{const M={sm:.8,md:1,lg:1.3}[m],F=200*M,I=Math.min(Math.ceil(z.frontContent.title.length/25),3)*24*M,H=Math.min(Math.ceil(z.frontContent.text.length/40),8)*18*M,q=z.frontContent.images.length>0?120*M:0,B=z.frontContent.tags.length>0?32*M:0,R=32*M;return Math.round(F+I+H+q+B+R)},[m]),$=d.useMemo(()=>k.map(z=>({id:z.id,height:C.get(z.id)||T(z)})),[k,C,T]),A=d.useMemo(()=>({sm:{minColumnWidth:240,maxColumns:5},md:{minColumnWidth:280,maxColumns:4},lg:{minColumnWidth:320,maxColumns:3}})[m],[m]),{containerRef:G,positions:te,containerHeight:W,updateItemHeight:ee}=fl({items:$,gap:x,...A,breakpoints:{sm:640,md:768,lg:1024,xl:1280,"2xl":1536}}),ae=d.useMemo(()=>{if(!h||!w.current)return k;const z=w.current.clientHeight,Y=g-f*100,M=g+z+f*100;return k.filter(F=>{const I=te.get(F.id);return I?I.y+I.height>=Y&&I.y<=M:!0})},[k,te,g,h,f]);d.useCallback(z=>{h&&p(z.currentTarget.scrollTop)},[h]);const re=d.useCallback(z=>{const Y=E.current.get(z);if(!Y)return;const M=new ResizeObserver(F=>{const I=F[0];if(I){const H=I.contentRect.height,q=C.get(z);Math.abs(H-(q||0))>3&&(j(B=>{const R=new Map(B);return R.set(z,H),R}),ee(z,H))}});return M.observe(Y),()=>M.disconnect()},[C,ee]);d.useEffect(()=>{if(!N&&k.length>0){const z=new Map;k.forEach(Y=>{z.set(Y.id,T(Y))}),j(z),v(!0)}},[k,T,N]),d.useEffect(()=>{const z=[];return ae.forEach(Y=>{const M=re(Y.id);M&&z.push(M)}),()=>{z.forEach(Y=>Y())}},[ae,re]);const fe=d.useCallback((z,Y)=>{Y?E.current.set(z,Y):E.current.delete(z)},[]);return d.useEffect(()=>{w.current&&b(w.current.clientHeight)},[]),k.length===0?s.jsx("div",{className:"flex-1 flex items-center justify-center p-12",children:s.jsxs("div",{className:"text-center space-y-4",children:[s.jsx("div",{className:"w-24 h-24 mx-auto rounded-full bg-muted flex items-center justify-center",children:s.jsx("div",{className:"w-12 h-12 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center",children:s.jsx("span",{className:"text-white font-bold text-lg",children:"+"})})}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h3",{className:"text-lg font-semibold",children:"No cards yet"}),s.jsx("p",{className:"text-muted-foreground max-w-sm",children:"Create your first knowledge card to get started. Click the + button to begin."})]})]})}):s.jsx("div",{ref:G,className:_("relative w-full",c),style:{height:W},children:ae.map(z=>{const Y=te.get(z.id);return Y?s.jsx("div",{ref:M=>fe(z.id,M),className:"absolute transition-all duration-300 ease-out",style:{transform:`translate3d(${Y.x}px, ${Y.y}px, 0)`,width:Y.width,willChange:"transform"},children:s.jsx(ml,{card:z,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onMoveToFolder:l,size:m,className:"w-full"})},z.id):null})})}const Fr=d.forwardRef(({className:a,...e},t)=>s.jsxs(Oa,{ref:t,className:_("relative flex w-full touch-none select-none items-center",a),...e,children:[s.jsx(zn,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:s.jsx(Bn,{className:"absolute h-full bg-primary"})}),s.jsx(Un,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));Fr.displayName=Oa.displayName;const hl=Zt("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),Ce=d.forwardRef(({className:a,...e},t)=>s.jsx(Pa,{ref:t,className:_(hl(),a),...e}));Ce.displayName=Pa.displayName;const ut=d.forwardRef(({className:a,orientation:e="horizontal",decorative:t=!0,...r},n)=>s.jsx(La,{ref:n,decorative:t,orientation:e,className:_("shrink-0 bg-border",e==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",a),...r}));ut.displayName=La.displayName;const Or=Wn,Pr=Hn,Hs=d.forwardRef(({className:a,align:e="center",sideOffset:t=4,...r},n)=>s.jsx(Vn,{children:s.jsx($a,{ref:n,align:e,sideOffset:t,className:_("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...r})}));Hs.displayName=$a.displayName;function oa(a){if(!a)return"";try{const e=new DOMParser().parseFromString(a,"text/html");e.querySelectorAll("img").forEach(i=>i.remove()),e.querySelectorAll("br").forEach(i=>{i.replaceWith(`
`)}),e.querySelectorAll("p, div, h1, h2, h3, h4, h5, h6, li, blockquote").forEach(i=>{i.insertAdjacentText("afterend",`
`)});let o=e.body.textContent||e.body.innerText||"";return o=o.replace(/[ \t]+/g," ").replace(/[ \t]*\n[ \t]*/g,`
`).replace(/\n{3,}/g,`

`).trim(),o}catch(e){return console.warn("Failed to parse HTML, falling back to regex cleanup:",e),a.replace(/<img[^>]*>/gi,"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/?(p|div|h[1-6]|li|blockquote)[^>]*>/gi,`
`).replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/[ \t]+/g," ").replace(/[ \t]*\n[ \t]*/g,`
`).replace(/\n{3,}/g,`

`).trim()}}function pl(a,e){const t=oa(a),r=oa(e);return`${t}

${r}`}async function xl(a){try{if(navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(a),!0;{const e=document.createElement("textarea");e.value=a,e.style.position="fixed",e.style.left="-999999px",e.style.top="-999999px",document.body.appendChild(e),e.focus(),e.select();const t=document.execCommand("copy");return document.body.removeChild(e),t}}catch(e){return console.error("Failed to copy text to clipboard:",e),!1}}function yl(a,e){return a[13]=1,a[14]=e>>8,a[15]=e&255,a[16]=e>>8,a[17]=e&255,a}const Lr=112,$r=72,zr=89,Br=115;let Ss;function wl(){const a=new Int32Array(256);for(let e=0;e<256;e++){let t=e;for(let r=0;r<8;r++)t=t&1?3988292384^t>>>1:t>>>1;a[e]=t}return a}function bl(a){let e=-1;Ss||(Ss=wl());for(let t=0;t<a.length;t++)e=Ss[(e^a[t])&255]^e>>>8;return e^-1}function vl(a){const e=a.length-1;for(let t=e;t>=4;t--)if(a[t-4]===9&&a[t-3]===Lr&&a[t-2]===$r&&a[t-1]===zr&&a[t]===Br)return t-3;return 0}function Cl(a,e,t=!1){const r=new Uint8Array(13);e*=39.3701,r[0]=Lr,r[1]=$r,r[2]=zr,r[3]=Br,r[4]=e>>>24,r[5]=e>>>16,r[6]=e>>>8,r[7]=e&255,r[8]=r[4],r[9]=r[5],r[10]=r[6],r[11]=r[7],r[12]=1;const n=bl(r),o=new Uint8Array(4);if(o[0]=n>>>24,o[1]=n>>>16,o[2]=n>>>8,o[3]=n&255,t){const i=vl(a);return a.set(r,i),a.set(o,i+13),a}else{const i=new Uint8Array(4);i[0]=0,i[1]=0,i[2]=0,i[3]=9;const l=new Uint8Array(54);return l.set(a,0),l.set(i,33),l.set(r,37),l.set(o,50),l}}const jl="AAlwSFlz",Sl="AAAJcEhZ",Nl="AAAACXBI";function kl(a){let e=a.indexOf(jl);return e===-1&&(e=a.indexOf(Sl)),e===-1&&(e=a.indexOf(Nl)),e}const Ur="[modern-screenshot]",Xe=typeof window<"u",El=Xe&&"Worker"in window,Dl=Xe&&"atob"in window,Rl=Xe&&"btoa"in window,Gs=Xe?window.navigator?.userAgent:"",Vr=Gs.includes("Chrome"),Xt=Gs.includes("AppleWebKit")&&!Vr,Ks=Gs.includes("Firefox"),Tl=a=>a&&"__CONTEXT__"in a,Al=a=>a.constructor.name==="CSSFontFaceRule",Il=a=>a.constructor.name==="CSSImportRule",Pe=a=>a.nodeType===1,Lt=a=>typeof a.className=="object",Wr=a=>a.tagName==="image",_l=a=>a.tagName==="use",Ft=a=>Pe(a)&&typeof a.style<"u"&&!Lt(a),Ml=a=>a.nodeType===8,Fl=a=>a.nodeType===3,yt=a=>a.tagName==="IMG",as=a=>a.tagName==="VIDEO",Ol=a=>a.tagName==="CANVAS",Pl=a=>a.tagName==="TEXTAREA",Ll=a=>a.tagName==="INPUT",$l=a=>a.tagName==="STYLE",zl=a=>a.tagName==="SCRIPT",Bl=a=>a.tagName==="SELECT",Ul=a=>a.tagName==="SLOT",Vl=a=>a.tagName==="IFRAME",Wl=(...a)=>console.warn(Ur,...a);function Hl(a){const e=a?.createElement?.("canvas");return e&&(e.height=e.width=1),!!e&&"toDataURL"in e&&!!e.toDataURL("image/webp").includes("image/webp")}const Fs=a=>a.startsWith("data:");function Hr(a,e){if(a.match(/^[a-z]+:\/\//i))return a;if(Xe&&a.match(/^\/\//))return window.location.protocol+a;if(a.match(/^[a-z]+:/i)||!Xe)return a;const t=rs().implementation.createHTMLDocument(),r=t.createElement("base"),n=t.createElement("a");return t.head.appendChild(r),t.body.appendChild(n),e&&(r.href=e),n.href=a,n.href}function rs(a){return(a&&Pe(a)?a?.ownerDocument:a)??window.document}const ns="http://www.w3.org/2000/svg";function Gl(a,e,t){const r=rs(t).createElementNS(ns,"svg");return r.setAttributeNS(null,"width",a.toString()),r.setAttributeNS(null,"height",e.toString()),r.setAttributeNS(null,"viewBox",`0 0 ${a} ${e}`),r}function Kl(a,e){let t=new XMLSerializer().serializeToString(a);return e&&(t=t.replace(/[\u0000-\u0008\v\f\u000E-\u001F\uD800-\uDFFF\uFFFE\uFFFF]/gu,"")),`data:image/svg+xml;charset=utf-8,${encodeURIComponent(t)}`}function Yl(a,e){return new Promise((t,r)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=()=>r(n.error),n.onabort=()=>r(new Error(`Failed read blob to ${e}`)),n.readAsDataURL(a)})}const ql=a=>Yl(a,"dataUrl");function ht(a,e){const t=rs(e).createElement("img");return t.decoding="sync",t.loading="eager",t.src=a,t}function Ot(a,e){return new Promise(t=>{const{timeout:r,ownerDocument:n,onError:o,onWarn:i}=e??{},l=typeof a=="string"?ht(a,rs(n)):a;let u=null,m=null;function c(){t(l),u&&clearTimeout(u),m?.()}if(r&&(u=setTimeout(c,r)),as(l)){const x=l.currentSrc||l.src;if(!x)return l.poster?Ot(l.poster,e).then(t):c();if(l.readyState>=2)return c();const h=c,f=C=>{i?.("Failed video load",x,C),o?.(C),c()};m=()=>{l.removeEventListener("loadeddata",h),l.removeEventListener("error",f)},l.addEventListener("loadeddata",h,{once:!0}),l.addEventListener("error",f,{once:!0})}else{const x=Wr(l)?l.href.baseVal:l.currentSrc||l.src;if(!x)return c();const h=async()=>{if(yt(l)&&"decode"in l)try{await l.decode()}catch(C){i?.("Failed to decode image, trying to render anyway",l.dataset.originalSrc||x,C)}c()},f=C=>{i?.("Failed image load",l.dataset.originalSrc||x,C),c()};if(yt(l)&&l.complete)return h();m=()=>{l.removeEventListener("load",h),l.removeEventListener("error",f)},l.addEventListener("load",h,{once:!0}),l.addEventListener("error",f,{once:!0})}})}async function Jl(a,e){Ft(a)&&(yt(a)||as(a)?await Ot(a,e):await Promise.all(["img","video"].flatMap(t=>Array.from(a.querySelectorAll(t)).map(r=>Ot(r,e)))))}const Gr=function(){let e=0;const t=()=>`0000${(Math.random()*36**4<<0).toString(36)}`.slice(-4);return()=>(e+=1,`u${t()}${e}`)}();function Kr(a){return a?.split(",").map(e=>e.trim().replace(/"|'/g,"").toLowerCase()).filter(Boolean)}let ia=0;function Xl(a){const e=`${Ur}[#${ia}]`;return ia++,{time:t=>a&&console.time(`${e} ${t}`),timeEnd:t=>a&&console.timeEnd(`${e} ${t}`),warn:(...t)=>a&&Wl(...t)}}function Ql(a){return{cache:a?"no-cache":"force-cache"}}async function os(a,e){return Tl(a)?a:Zl(a,{...e,autoDestruct:!0})}async function Zl(a,e){const{scale:t=1,workerUrl:r,workerNumber:n=1}=e||{},o=!!e?.debug,i=e?.features??!0,l=a.ownerDocument??(Xe?window.document:void 0),u=a.ownerDocument?.defaultView??(Xe?window:void 0),m=new Map,c={width:0,height:0,quality:1,type:"image/png",scale:t,backgroundColor:null,style:null,filter:null,maximumCanvasSize:0,timeout:3e4,progress:null,debug:o,fetch:{requestInit:Ql(e?.fetch?.bypassingCache),placeholderImage:"data:image/png;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",bypassingCache:!1,...e?.fetch},fetchFn:null,font:{},drawImageInterval:100,workerUrl:null,workerNumber:n,onCloneEachNode:null,onCloneNode:null,onEmbedNode:null,onCreateForeignObjectSvg:null,includeStyleProperties:null,autoDestruct:!1,...e,__CONTEXT__:!0,log:Xl(o),node:a,ownerDocument:l,ownerWindow:u,dpi:t===1?null:96*t,svgStyleElement:Yr(l),svgDefsElement:l?.createElementNS(ns,"defs"),svgStyles:new Map,defaultComputedStyles:new Map,workers:[...Array.from({length:El&&r&&n?n:0})].map(()=>{try{const f=new Worker(r);return f.onmessage=async C=>{const{url:j,result:N}=C.data;N?m.get(j)?.resolve?.(N):m.get(j)?.reject?.(new Error(`Error receiving message from worker: ${j}`))},f.onmessageerror=C=>{const{url:j}=C.data;m.get(j)?.reject?.(new Error(`Error receiving message from worker: ${j}`))},f}catch(f){return c.log.warn("Failed to new Worker",f),null}}).filter(Boolean),fontFamilies:new Map,fontCssTexts:new Map,acceptOfImage:`${[Hl(l)&&"image/webp","image/svg+xml","image/*","*/*"].filter(Boolean).join(",")};q=0.8`,requests:m,drawImageCount:0,tasks:[],features:i,isEnable:f=>f==="restoreScrollPosition"?typeof i=="boolean"?!1:i[f]??!1:typeof i=="boolean"?i:i[f]??!0,shadowRoots:[]};c.log.time("wait until load"),await Jl(a,{timeout:c.timeout,onWarn:c.log.warn}),c.log.timeEnd("wait until load");const{width:x,height:h}=ec(a,c);return c.width=x,c.height=h,c}function Yr(a){if(!a)return;const e=a.createElement("style"),t=e.ownerDocument.createTextNode(`
.______background-clip--text {
  background-clip: text;
  -webkit-background-clip: text;
}
`);return e.appendChild(t),e}function ec(a,e){let{width:t,height:r}=e;if(Pe(a)&&(!t||!r)){const n=a.getBoundingClientRect();t=t||n.width||Number(a.getAttribute("width"))||0,r=r||n.height||Number(a.getAttribute("height"))||0}return{width:t,height:r}}async function tc(a,e){const{log:t,timeout:r,drawImageCount:n,drawImageInterval:o}=e;t.time("image to canvas");const i=await Ot(a,{timeout:r,onWarn:e.log.warn}),{canvas:l,context2d:u}=sc(a.ownerDocument,e),m=()=>{try{u?.drawImage(i,0,0,l.width,l.height)}catch(c){e.log.warn("Failed to drawImage",c)}};if(m(),e.isEnable("fixSvgXmlDecode"))for(let c=0;c<n;c++)await new Promise(x=>{setTimeout(()=>{u?.clearRect(0,0,l.width,l.height),m(),x()},c+o)});return e.drawImageCount=0,t.timeEnd("image to canvas"),l}function sc(a,e){const{width:t,height:r,scale:n,backgroundColor:o,maximumCanvasSize:i}=e,l=a.createElement("canvas");l.width=Math.floor(t*n),l.height=Math.floor(r*n),l.style.width=`${t}px`,l.style.height=`${r}px`,i&&(l.width>i||l.height>i)&&(l.width>i&&l.height>i?l.width>l.height?(l.height*=i/l.width,l.width=i):(l.width*=i/l.height,l.height=i):l.width>i?(l.height*=i/l.width,l.width=i):(l.width*=i/l.height,l.height=i));const u=l.getContext("2d");return u&&o&&(u.fillStyle=o,u.fillRect(0,0,l.width,l.height)),{canvas:l,context2d:u}}function qr(a,e){if(a.ownerDocument)try{const o=a.toDataURL();if(o!=="data:,")return ht(o,a.ownerDocument)}catch(o){e.log.warn("Failed to clone canvas",o)}const t=a.cloneNode(!1),r=a.getContext("2d"),n=t.getContext("2d");try{return r&&n&&n.putImageData(r.getImageData(0,0,a.width,a.height),0,0),t}catch(o){e.log.warn("Failed to clone canvas",o)}return t}function ac(a,e){try{if(a?.contentDocument?.body)return Ys(a.contentDocument.body,e)}catch(t){e.log.warn("Failed to clone iframe",t)}return a.cloneNode(!1)}function rc(a){const e=a.cloneNode(!1);return a.currentSrc&&a.currentSrc!==a.src&&(e.src=a.currentSrc,e.srcset=""),e.loading==="lazy"&&(e.loading="eager"),e}async function nc(a,e){if(a.ownerDocument&&!a.currentSrc&&a.poster)return ht(a.poster,a.ownerDocument);const t=a.cloneNode(!1);t.crossOrigin="anonymous",a.currentSrc&&a.currentSrc!==a.src&&(t.src=a.currentSrc);const r=t.ownerDocument;if(r){let n=!0;if(await Ot(t,{onError:()=>n=!1,onWarn:e.log.warn}),!n)return a.poster?ht(a.poster,a.ownerDocument):t;t.currentTime=a.currentTime,await new Promise(i=>{t.addEventListener("seeked",i,{once:!0})});const o=r.createElement("canvas");o.width=a.offsetWidth,o.height=a.offsetHeight;try{const i=o.getContext("2d");i&&i.drawImage(t,0,0,o.width,o.height)}catch(i){return e.log.warn("Failed to clone video",i),a.poster?ht(a.poster,a.ownerDocument):t}return qr(o,e)}return t}function oc(a,e){return Ol(a)?qr(a,e):Vl(a)?ac(a,e):yt(a)?rc(a):as(a)?nc(a,e):a.cloneNode(!1)}function ic(a){let e=a.sandbox;if(!e){const{ownerDocument:t}=a;try{t&&(e=t.createElement("iframe"),e.id=`__SANDBOX__${Gr()}`,e.width="0",e.height="0",e.style.visibility="hidden",e.style.position="fixed",t.body.appendChild(e),e.srcdoc='<!DOCTYPE html><meta charset="UTF-8"><title></title><body>',a.sandbox=e)}catch(r){a.log.warn("Failed to getSandBox",r)}}return e}const lc=["width","height","-webkit-text-fill-color"],cc=["stroke","fill"];function Jr(a,e,t){const{defaultComputedStyles:r}=t,n=a.nodeName.toLowerCase(),o=Lt(a)&&n!=="svg",i=o?cc.map(j=>[j,a.getAttribute(j)]).filter(([,j])=>j!==null):[],l=[o&&"svg",n,i.map((j,N)=>`${j}=${N}`).join(","),e].filter(Boolean).join(":");if(r.has(l))return r.get(l);const m=ic(t)?.contentWindow;if(!m)return new Map;const c=m?.document;let x,h;o?(x=c.createElementNS(ns,"svg"),h=x.ownerDocument.createElementNS(x.namespaceURI,n),i.forEach(([j,N])=>{h.setAttributeNS(null,j,N)}),x.appendChild(h)):x=h=c.createElement(n),h.textContent=" ",c.body.appendChild(x);const f=m.getComputedStyle(h,e),C=new Map;for(let j=f.length,N=0;N<j;N++){const v=f.item(N);lc.includes(v)||C.set(v,f.getPropertyValue(v))}return c.body.removeChild(x),r.set(l,C),C}function Xr(a,e,t){const r=new Map,n=[],o=new Map;if(t)for(const l of t)i(l);else for(let l=a.length,u=0;u<l;u++){const m=a.item(u);i(m)}for(let l=n.length,u=0;u<l;u++)o.get(n[u])?.forEach((m,c)=>r.set(c,m));function i(l){const u=a.getPropertyValue(l),m=a.getPropertyPriority(l),c=l.lastIndexOf("-"),x=c>-1?l.substring(0,c):void 0;if(x){let h=o.get(x);h||(h=new Map,o.set(x,h)),h.set(l,[u,m])}e.get(l)===u&&!m||(x?n.push(x):r.set(l,[u,m]))}return r}function dc(a,e,t,r){const{ownerWindow:n,includeStyleProperties:o,currentParentNodeStyle:i}=r,l=e.style,u=n.getComputedStyle(a),m=Jr(a,null,r);i?.forEach((x,h)=>{m.delete(h)});const c=Xr(u,m,o);c.delete("transition-property"),c.delete("all"),c.delete("d"),c.delete("content"),t&&(c.delete("margin-top"),c.delete("margin-right"),c.delete("margin-bottom"),c.delete("margin-left"),c.delete("margin-block-start"),c.delete("margin-block-end"),c.delete("margin-inline-start"),c.delete("margin-inline-end"),c.set("box-sizing",["border-box",""])),c.get("background-clip")?.[0]==="text"&&e.classList.add("______background-clip--text"),Vr&&(c.has("font-kerning")||c.set("font-kerning",["normal",""]),(c.get("overflow-x")?.[0]==="hidden"||c.get("overflow-y")?.[0]==="hidden")&&c.get("text-overflow")?.[0]==="ellipsis"&&a.scrollWidth===a.clientWidth&&c.set("text-overflow",["clip",""]));for(let x=l.length,h=0;h<x;h++)l.removeProperty(l.item(h));return c.forEach(([x,h],f)=>{l.setProperty(f,x,h)}),c}function uc(a,e){(Pl(a)||Ll(a)||Bl(a))&&e.setAttribute("value",a.value)}const mc=[":before",":after"],fc=[":-webkit-scrollbar",":-webkit-scrollbar-button",":-webkit-scrollbar-thumb",":-webkit-scrollbar-track",":-webkit-scrollbar-track-piece",":-webkit-scrollbar-corner",":-webkit-resizer"];function gc(a,e,t,r,n){const{ownerWindow:o,svgStyleElement:i,svgStyles:l,currentNodeStyle:u}=r;if(!i||!o)return;function m(c){const x=o.getComputedStyle(a,c);let h=x.getPropertyValue("content");if(!h||h==="none")return;n?.(h),h=h.replace(/(')|(")|(counter\(.+\))/g,"");const f=[Gr()],C=Jr(a,c,r);u?.forEach((p,y)=>{C.delete(y)});const j=Xr(x,C,r.includeStyleProperties);j.delete("content"),j.delete("-webkit-locale"),j.get("background-clip")?.[0]==="text"&&e.classList.add("______background-clip--text");const N=[`content: '${h}';`];if(j.forEach(([p,y],b)=>{N.push(`${b}: ${p}${y?" !important":""};`)}),N.length===1)return;try{e.className=[e.className,...f].join(" ")}catch(p){r.log.warn("Failed to copyPseudoClass",p);return}const v=N.join(`
  `);let g=l.get(v);g||(g=[],l.set(v,g)),g.push(`.${f[0]}:${c}`)}mc.forEach(m),t&&fc.forEach(m)}const la=new Set(["symbol"]);async function ca(a,e,t,r,n){if(Pe(t)&&($l(t)||zl(t))||r.filter&&!r.filter(t))return;la.has(e.nodeName)||la.has(t.nodeName)?r.currentParentNodeStyle=void 0:r.currentParentNodeStyle=r.currentNodeStyle;const o=await Ys(t,r,!1,n);r.isEnable("restoreScrollPosition")&&hc(a,o),e.appendChild(o)}async function da(a,e,t,r){let n=a.firstChild;Pe(a)&&a.shadowRoot&&(n=a.shadowRoot?.firstChild,t.shadowRoots.push(a.shadowRoot));for(let o=n;o;o=o.nextSibling)if(!Ml(o))if(Pe(o)&&Ul(o)&&typeof o.assignedNodes=="function"){const i=o.assignedNodes();for(let l=0;l<i.length;l++)await ca(a,e,i[l],t,r)}else await ca(a,e,o,t,r)}function hc(a,e){if(!Ft(a)||!Ft(e))return;const{scrollTop:t,scrollLeft:r}=a;if(!t&&!r)return;const{transform:n}=e.style,o=new DOMMatrix(n),{a:i,b:l,c:u,d:m}=o;o.a=1,o.b=0,o.c=0,o.d=1,o.translateSelf(-r,-t),o.a=i,o.b=l,o.c=u,o.d=m,e.style.transform=o.toString()}function pc(a,e){const{backgroundColor:t,width:r,height:n,style:o}=e,i=a.style;if(t&&i.setProperty("background-color",t,"important"),r&&i.setProperty("width",`${r}px`,"important"),n&&i.setProperty("height",`${n}px`,"important"),o)for(const l in o)i[l]=o[l]}const xc=/^[\w-:]+$/;async function Ys(a,e,t=!1,r){const{ownerDocument:n,ownerWindow:o,fontFamilies:i,onCloneEachNode:l}=e;if(n&&Fl(a))return r&&/\S/.test(a.data)&&r(a.data),n.createTextNode(a.data);if(n&&o&&Pe(a)&&(Ft(a)||Lt(a))){const m=await oc(a,e);if(e.isEnable("removeAbnormalAttributes")){const j=m.getAttributeNames();for(let N=j.length,v=0;v<N;v++){const g=j[v];xc.test(g)||m.removeAttribute(g)}}const c=e.currentNodeStyle=dc(a,m,t,e);t&&pc(m,e);let x=!1;if(e.isEnable("copyScrollbar")){const j=[c.get("overflow-x")?.[0],c.get("overflow-y")?.[0]];x=j.includes("scroll")||(j.includes("auto")||j.includes("overlay"))&&(a.scrollHeight>a.clientHeight||a.scrollWidth>a.clientWidth)}const h=c.get("text-transform")?.[0],f=Kr(c.get("font-family")?.[0]),C=f?j=>{h==="uppercase"?j=j.toUpperCase():h==="lowercase"?j=j.toLowerCase():h==="capitalize"&&(j=j[0].toUpperCase()+j.substring(1)),f.forEach(N=>{let v=i.get(N);v||i.set(N,v=new Set),j.split("").forEach(g=>v.add(g))})}:void 0;return gc(a,m,x,e,C),uc(a,m),as(a)||await da(a,m,e,C),await l?.(m),m}const u=a.cloneNode(!1);return await da(a,u,e),await l?.(u),u}function yc(a){if(a.ownerDocument=void 0,a.ownerWindow=void 0,a.svgStyleElement=void 0,a.svgDefsElement=void 0,a.svgStyles.clear(),a.defaultComputedStyles.clear(),a.sandbox){try{a.sandbox.remove()}catch(e){a.log.warn("Failed to destroyContext",e)}a.sandbox=void 0}a.workers=[],a.fontFamilies.clear(),a.fontCssTexts.clear(),a.requests.clear(),a.tasks=[],a.shadowRoots=[]}function wc(a){const{url:e,timeout:t,responseType:r,...n}=a,o=new AbortController,i=t?setTimeout(()=>o.abort(),t):void 0;return fetch(e,{signal:o.signal,...n}).then(l=>{if(!l.ok)throw new Error("Failed fetch, not 2xx response",{cause:l});switch(r){case"arrayBuffer":return l.arrayBuffer();case"dataUrl":return l.blob().then(ql);case"text":default:return l.text()}}).finally(()=>clearTimeout(i))}function Pt(a,e){const{url:t,requestType:r="text",responseType:n="text",imageDom:o}=e;let i=t;const{timeout:l,acceptOfImage:u,requests:m,fetchFn:c,fetch:{requestInit:x,bypassingCache:h,placeholderImage:f},font:C,workers:j,fontFamilies:N}=a;r==="image"&&(Xt||Ks)&&a.drawImageCount++;let v=m.get(t);if(!v){h&&h instanceof RegExp&&h.test(i)&&(i+=(/\?/.test(i)?"&":"?")+new Date().getTime());const g=r.startsWith("font")&&C&&C.minify,p=new Set;g&&r.split(";")[1].split(",").forEach(w=>{N.has(w)&&N.get(w).forEach(k=>p.add(k))});const y=g&&p.size,b={url:i,timeout:l,responseType:y?"arrayBuffer":n,headers:r==="image"?{accept:u}:void 0,...x};v={type:r,resolve:void 0,reject:void 0,response:null},v.response=(async()=>{if(c&&r==="image"){const E=await c(t);if(E)return E}return!Xt&&t.startsWith("http")&&j.length?new Promise((E,w)=>{j[m.size&j.length-1].postMessage({rawUrl:t,...b}),v.resolve=E,v.reject=w}):wc(b)})().catch(E=>{if(m.delete(t),r==="image"&&f)return a.log.warn("Failed to fetch image base64, trying to use placeholder image",i),typeof f=="string"?f:f(o);throw E}),m.set(t,v)}return v.response}async function Qr(a,e,t,r){if(!Zr(a))return a;for(const[n,o]of bc(a,e))try{const i=await Pt(t,{url:o,requestType:r?"image":"text",responseType:"dataUrl"});a=a.replace(vc(n),`$1${i}$3`)}catch(i){t.log.warn("Failed to fetch css data url",n,i)}return a}function Zr(a){return/url\((['"]?)([^'"]+?)\1\)/.test(a)}const en=/url\((['"]?)([^'"]+?)\1\)/g;function bc(a,e){const t=[];return a.replace(en,(r,n,o)=>(t.push([o,Hr(o,e)]),r)),t.filter(([r])=>!Fs(r))}function vc(a){const e=a.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1");return new RegExp(`(url\\(['"]?)(${e})(['"]?\\))`,"g")}const Cc=["background-image","border-image-source","-webkit-border-image","-webkit-mask-image","list-style-image"];function jc(a,e){return Cc.map(t=>{const r=a.getPropertyValue(t);return!r||r==="none"?null:((Xt||Ks)&&e.drawImageCount++,Qr(r,null,e,!0).then(n=>{!n||r===n||a.setProperty(t,n,a.getPropertyPriority(t))}))}).filter(Boolean)}function Sc(a,e){if(yt(a)){const t=a.currentSrc||a.src;if(!Fs(t))return[Pt(e,{url:t,imageDom:a,requestType:"image",responseType:"dataUrl"}).then(r=>{r&&(a.srcset="",a.dataset.originalSrc=t,a.src=r||"")})];(Xt||Ks)&&e.drawImageCount++}else if(Lt(a)&&!Fs(a.href.baseVal)){const t=a.href.baseVal;return[Pt(e,{url:t,imageDom:a,requestType:"image",responseType:"dataUrl"}).then(r=>{r&&(a.dataset.originalSrc=t,a.href.baseVal=r||"")})]}return[]}function Nc(a,e){const{ownerDocument:t,svgDefsElement:r}=e,n=a.getAttribute("href")??a.getAttribute("xlink:href");if(!n)return[];const[o,i]=n.split("#");if(i){const l=`#${i}`,u=e.shadowRoots.reduce((m,c)=>m??c.querySelector(`svg ${l}`),t?.querySelector(`svg ${l}`));if(o&&a.setAttribute("href",l),r?.querySelector(l))return[];if(u)return r?.appendChild(u.cloneNode(!0)),[];if(o)return[Pt(e,{url:o,responseType:"text"}).then(m=>{r?.insertAdjacentHTML("beforeend",m)})]}return[]}function tn(a,e){const{tasks:t}=e;Pe(a)&&((yt(a)||Wr(a))&&t.push(...Sc(a,e)),_l(a)&&t.push(...Nc(a,e))),Ft(a)&&t.push(...jc(a.style,e)),a.childNodes.forEach(r=>{tn(r,e)})}async function kc(a,e){const{ownerDocument:t,svgStyleElement:r,fontFamilies:n,fontCssTexts:o,tasks:i,font:l}=e;if(!(!t||!r||!n.size))if(l&&l.cssText){const u=ma(l.cssText,e);r.appendChild(t.createTextNode(`${u}
`))}else{const u=Array.from(t.styleSheets).filter(c=>{try{return"cssRules"in c&&!!c.cssRules.length}catch(x){return e.log.warn(`Error while reading CSS rules from ${c.href}`,x),!1}});await Promise.all(u.flatMap(c=>Array.from(c.cssRules).map(async(x,h)=>{if(Il(x)){let f=h+1;const C=x.href;let j="";try{j=await Pt(e,{url:C,requestType:"text",responseType:"text"})}catch(v){e.log.warn(`Error fetch remote css import from ${C}`,v)}const N=j.replace(en,(v,g,p)=>v.replace(p,Hr(p,C)));for(const v of Dc(N))try{c.insertRule(v,v.startsWith("@import")?f+=1:c.cssRules.length)}catch(g){e.log.warn("Error inserting rule from remote css import",{rule:v,error:g})}}}))),u.flatMap(c=>Array.from(c.cssRules)).filter(c=>Al(c)&&Zr(c.style.getPropertyValue("src"))&&Kr(c.style.getPropertyValue("font-family"))?.some(x=>n.has(x))).forEach(c=>{const x=c,h=o.get(x.cssText);h?r.appendChild(t.createTextNode(`${h}
`)):i.push(Qr(x.cssText,x.parentStyleSheet?x.parentStyleSheet.href:null,e).then(f=>{f=ma(f,e),o.set(x.cssText,f),r.appendChild(t.createTextNode(`${f}
`))}))})}}const Ec=/(\/\*[\s\S]*?\*\/)/g,ua=/((@.*?keyframes [\s\S]*?){([\s\S]*?}\s*?)})/gi;function Dc(a){if(a==null)return[];const e=[];let t=a.replace(Ec,"");for(;;){const o=ua.exec(t);if(!o)break;e.push(o[0])}t=t.replace(ua,"");const r=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,n=new RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");for(;;){let o=r.exec(t);if(o)n.lastIndex=r.lastIndex;else if(o=n.exec(t),o)r.lastIndex=n.lastIndex;else break;e.push(o[0])}return e}const Rc=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,Tc=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function ma(a,e){const{font:t}=e,r=t?t?.preferredFormat:void 0;return r?a.replace(Tc,n=>{for(;;){const[o,,i]=Rc.exec(n)||[];if(!i)return"";if(i===r)return`src: ${o};`}}):a}async function Ac(a,e){const t=await os(a,e);if(Pe(t.node)&&Lt(t.node))return t.node;const{ownerDocument:r,log:n,tasks:o,svgStyleElement:i,svgDefsElement:l,svgStyles:u,font:m,progress:c,autoDestruct:x,onCloneNode:h,onEmbedNode:f,onCreateForeignObjectSvg:C}=t;n.time("clone node");const j=await Ys(t.node,t,!0);if(i&&r){let y="";u.forEach((b,E)=>{y+=`${b.join(`,
`)} {
  ${E}
}
`}),i.appendChild(r.createTextNode(y))}n.timeEnd("clone node"),await h?.(j),m!==!1&&Pe(j)&&(n.time("embed web font"),await kc(j,t),n.timeEnd("embed web font")),n.time("embed node"),tn(j,t);const N=o.length;let v=0;const g=async()=>{for(;;){const y=o.pop();if(!y)break;try{await y}catch(b){t.log.warn("Failed to run task",b)}c?.(++v,N)}};c?.(v,N),await Promise.all([...Array.from({length:4})].map(g)),n.timeEnd("embed node"),await f?.(j);const p=Ic(j,t);return l&&p.insertBefore(l,p.children[0]),i&&p.insertBefore(i,p.children[0]),x&&yc(t),await C?.(p),p}function Ic(a,e){const{width:t,height:r}=e,n=Gl(t,r,a.ownerDocument),o=n.ownerDocument.createElementNS(n.namespaceURI,"foreignObject");return o.setAttributeNS(null,"x","0%"),o.setAttributeNS(null,"y","0%"),o.setAttributeNS(null,"width","100%"),o.setAttributeNS(null,"height","100%"),o.append(a),n.appendChild(o),n}async function _c(a,e){const t=await os(a,e),r=await Ac(t),n=Kl(r,t.isEnable("removeControlCharacter"));t.autoDestruct||(t.svgStyleElement=Yr(t.ownerDocument),t.svgDefsElement=t.ownerDocument?.createElementNS(ns,"defs"),t.svgStyles.clear());const o=ht(n,r.ownerDocument);return await tc(o,t)}async function Mc(a,e){const t=await os(a,e),{log:r,quality:n,type:o,dpi:i}=t,l=await _c(t);r.time("canvas to data url");let u=l.toDataURL(o,n);if(["image/png","image/jpeg"].includes(o)&&i&&Dl&&Rl){const[m,c]=u.split(",");let x=0,h=!1;if(o==="image/png"){const p=kl(c);p>=0?(x=Math.ceil((p+28)/3)*4,h=!0):x=33/3*4}else o==="image/jpeg"&&(x=18/3*4);const f=c.substring(0,x),C=c.substring(x),j=window.atob(f),N=new Uint8Array(j.length);for(let p=0;p<N.length;p++)N[p]=j.charCodeAt(p);const v=o==="image/png"?Cl(N,i,h):yl(N,i),g=window.btoa(String.fromCharCode(...v));u=[m,",",g,C].join("")}return r.timeEnd("canvas to data url"),u}async function Fc(a,e){return Mc(await os(a,{...e,type:"image/png"}))}function Oc(a,e=30){if(!a||a.trim()==="")return"untitled-card";let t=a.replace(/[^\w\s\u4e00-\u9fff\u3400-\u4dbf\u20000-\u2a6df\u2a700-\u2b73f\u2b740-\u2b81f\u2b820-\u2ceaf\uf900-\ufaff\u3300-\u33ff-]/g,"").replace(/\s+/g," ").trim();return t?(t.length>e&&(t=t.substring(0,e).trim()),t):"untitled-card"}async function Pc(a,e={}){const{quality:t=1,pixelRatio:r=2,backgroundColor:n="transparent",includeStyles:o=!0}=e;try{const i=await Fc(a,{quality:t,pixelRatio:r,backgroundColor:n,style:o?void 0:{},filter:u=>{if(u instanceof HTMLElement){const m=u.classList;return!m.contains("tooltip")&&!m.contains("dropdown-menu")&&!m.contains("popover")}return!0}});return await(await fetch(i)).blob()}catch(i){throw console.error("Screenshot capture failed:",i),new Error("Failed to capture screenshot")}}function Lc(a,e){const t=URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download=`${e}.png`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t)}async function $c(a,e,t={}){const r=Oc(e);return{blob:await Pc(a,{quality:1,pixelRatio:2,backgroundColor:"transparent",...t}),fileName:r}}function zc(a={}){const[e,t]=d.useState(!1),[r,n]=d.useState(!1),[o,i]=d.useState(null),[l,u]=d.useState(!1),[m,c]=d.useState(null),x=d.useCallback(async(j,N)=>{t(!0),c(null);try{const{blob:v,fileName:g}=await $c(j,N),p=URL.createObjectURL(v);i({blob:v,fileName:g,previewUrl:p}),u(!0)}catch(v){const g=v instanceof Error?v:new Error("Screenshot failed");c(g.message),a.onError?.(g)}finally{t(!1)}},[a]),h=d.useCallback(async()=>{if(o){n(!0);try{await new Promise(j=>setTimeout(j,500)),Lc(o.blob,o.fileName),a.onSuccess?.(o.fileName),u(!1),setTimeout(()=>{o.previewUrl&&URL.revokeObjectURL(o.previewUrl),i(null)},100)}catch(j){const N=j instanceof Error?j:new Error("Download failed");c(N.message),a.onError?.(N)}finally{n(!1)}}},[o,a]),f=d.useCallback(()=>{u(!1),setTimeout(()=>{o?.previewUrl&&URL.revokeObjectURL(o.previewUrl),i(null)},100)},[o]),C=d.useCallback(()=>{c(null)},[]);return{isCapturing:e,isDownloading:r,showPreview:l,previewData:o,error:m,captureScreenshot:x,confirmDownload:h,cancelPreview:f,clearError:C}}function Bc({isOpen:a,onClose:e,onConfirm:t,previewUrl:r,fileName:n,isDownloading:o=!1}){const[i,l]=d.useState(!1),u=()=>{l(!0),setTimeout(()=>{t(),l(!1)},800)};return s.jsx(st,{open:a,onOpenChange:e,children:s.jsxs(Je,{className:"max-w-2xl max-h-[90vh] overflow-hidden",children:[s.jsx(wt,{children:s.jsxs(vt,{className:"flex items-center gap-2",children:[s.jsx(Rs,{className:"h-5 w-5"}),"Screenshot Preview"]})}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"flex items-center justify-between",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(Z,{variant:"secondary",className:"font-mono text-xs",children:[n,".png"]}),s.jsx(Z,{variant:"outline",className:"text-xs",children:"High Quality"})]})}),s.jsx("div",{className:"relative bg-checkered rounded-lg overflow-hidden border",children:r?s.jsxs("div",{className:"relative",children:[s.jsx("img",{src:r,alt:"Screenshot preview",className:_("w-full h-auto max-h-[60vh] object-contain transition-all duration-300",i&&"scale-95 opacity-80")}),i&&s.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/20 to-purple-600/20 flex items-center justify-center",children:s.jsx("div",{className:"bg-white/90 backdrop-blur-sm rounded-full p-6 shadow-lg animate-pulse",children:s.jsxs("div",{className:"relative",children:[s.jsx(gt,{className:"h-8 w-8 text-blue-600 animate-bounce"}),s.jsx(Xs,{className:"h-4 w-4 text-purple-500 absolute -top-1 -right-1 animate-spin"})]})})})]}):s.jsx("div",{className:"h-64 flex items-center justify-center text-muted-foreground",children:s.jsxs("div",{className:"text-center space-y-2",children:[s.jsx(Rs,{className:"h-12 w-12 mx-auto opacity-50"}),s.jsx("p",{children:"Loading preview..."})]})})}),o&&s.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-muted-foreground",children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent"}),"Preparing download..."]})]}),s.jsxs(bt,{className:"gap-2",children:[s.jsxs(L,{variant:"outline",onClick:e,disabled:i||o,children:[s.jsx(at,{className:"h-4 w-4 mr-2"}),"Cancel"]}),s.jsx(L,{onClick:u,disabled:i||o||!r,className:_("relative overflow-hidden",i&&"bg-gradient-to-r from-blue-500 to-purple-600"),children:i?s.jsxs(s.Fragment,{children:[s.jsx(Xs,{className:"h-4 w-4 mr-2 animate-spin"}),"Downloading..."]}):s.jsxs(s.Fragment,{children:[s.jsx(gt,{className:"h-4 w-4 mr-2"}),"Download PNG"]})})]})]})})}const Uc=`
.bg-checkered {
  background-image: 
    linear-gradient(45deg, #f1f5f9 25%, transparent 25%), 
    linear-gradient(-45deg, #f1f5f9 25%, transparent 25%), 
    linear-gradient(45deg, transparent 75%, #f1f5f9 75%), 
    linear-gradient(-45deg, transparent 75%, #f1f5f9 75%);
  background-size: 20px 20px;
  background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}
`;if(typeof document<"u"){const a=document.createElement("style");a.textContent=Uc,document.head.appendChild(a)}const Vc=1,Wc=1e6;let Ns=0;function Hc(){return Ns=(Ns+1)%Number.MAX_SAFE_INTEGER,Ns.toString()}const ks=new Map,fa=a=>{if(ks.has(a))return;const e=setTimeout(()=>{ks.delete(a),It({type:"REMOVE_TOAST",toastId:a})},Wc);ks.set(a,e)},Gc=(a,e)=>{switch(e.type){case"ADD_TOAST":return{...a,toasts:[e.toast,...a.toasts].slice(0,Vc)};case"UPDATE_TOAST":return{...a,toasts:a.toasts.map(t=>t.id===e.toast.id?{...t,...e.toast}:t)};case"DISMISS_TOAST":{const{toastId:t}=e;return t?fa(t):a.toasts.forEach(r=>{fa(r.id)}),{...a,toasts:a.toasts.map(r=>r.id===t||t===void 0?{...r,open:!1}:r)}}case"REMOVE_TOAST":return e.toastId===void 0?{...a,toasts:[]}:{...a,toasts:a.toasts.filter(t=>t.id!==e.toastId)}}},Kt=[];let Yt={toasts:[]};function It(a){Yt=Gc(Yt,a),Kt.forEach(e=>{e(Yt)})}function Kc({...a}){const e=Hc(),t=n=>It({type:"UPDATE_TOAST",toast:{...n,id:e}}),r=()=>It({type:"DISMISS_TOAST",toastId:e});return It({type:"ADD_TOAST",toast:{...a,id:e,open:!0,onOpenChange:n=>{n||r()}}}),{id:e,dismiss:r,update:t}}function Yc(){const[a,e]=d.useState(Yt);return d.useEffect(()=>(Kt.push(e),()=>{const t=Kt.indexOf(e);t>-1&&Kt.splice(t,1)}),[a]),{...a,toast:Kc,dismiss:t=>It({type:"DISMISS_TOAST",toastId:t})}}const sn=d.forwardRef(({className:a,...e},t)=>s.jsx(za,{ref:t,className:_("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",a),...e}));sn.displayName=za.displayName;const an=d.forwardRef(({className:a,...e},t)=>s.jsx(Ba,{ref:t,className:_("aspect-square h-full w-full",a),...e}));an.displayName=Ba.displayName;const rn=d.forwardRef(({className:a,...e},t)=>s.jsx(Ua,{ref:t,className:_("flex h-full w-full items-center justify-center rounded-full bg-muted",a),...e}));rn.displayName=Ua.displayName;const nn=["from-violet-500 to-pink-500","from-blue-500 to-purple-600","from-green-500 to-teal-600","from-orange-500 to-red-600","from-pink-500 to-rose-600","from-indigo-500 to-blue-600","from-yellow-500 to-orange-600","from-purple-500 to-pink-600","from-teal-500 to-green-600","from-red-500 to-pink-600","from-cyan-500 to-blue-600"];function qc(a){let e=0;for(let t=0;t<a.length;t++){const r=a.charCodeAt(t);e=(e<<5)-e+r,e=e&e}return Math.abs(e)%nn.length}function Jc(a){return a?a.username?a.username.charAt(0).toUpperCase():a.email?a.email.charAt(0).toUpperCase():"?":"?"}function Xc(a){return a&&(a.username||a.email)||"anonymous"}function on({user:a,size:e="md",className:t,onClick:r,showHoverEffect:n=!0}){const o=Jc(a),i=Xc(a),l=qc(i),u=nn[l],c=_({sm:"h-6 w-6 text-xs",md:"h-8 w-8 text-sm",lg:"h-10 w-10 text-base"}[e],n&&r&&"cursor-pointer transition-transform hover:scale-105",t),x=_("bg-gradient-to-br text-white font-semibold flex items-center justify-center",u,n&&r&&"transition-all duration-200 hover:shadow-md");return s.jsxs(sn,{className:c,onClick:r,children:[s.jsx(an,{src:a?.avatar_url,alt:a?.username||a?.email||"User"}),s.jsx(rn,{className:x,children:o})]})}const ln=Kn,cn=Yn,Qc=d.forwardRef(({className:a,inset:e,children:t,...r},n)=>s.jsxs(Va,{ref:n,className:_("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",e&&"pl-8",a),...r,children:[t,s.jsx(es,{className:"ml-auto h-4 w-4"})]}));Qc.displayName=Va.displayName;const Zc=d.forwardRef(({className:a,...e},t)=>s.jsx(Wa,{ref:t,className:_("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e}));Zc.displayName=Wa.displayName;const qs=d.forwardRef(({className:a,...e},t)=>s.jsx(Gn,{children:s.jsx(Ha,{ref:t,className:_("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e})}));qs.displayName=Ha.displayName;const pt=d.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(Ga,{ref:r,className:_("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",e&&"pl-8",a),...t}));pt.displayName=Ga.displayName;const ed=d.forwardRef(({className:a,children:e,checked:t,...r},n)=>s.jsxs(Ka,{ref:n,className:_("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:t,...r,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(Ya,{children:s.jsx(qe,{className:"h-4 w-4"})})}),e]}));ed.displayName=Ka.displayName;const td=d.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(qa,{ref:r,className:_("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(Ya,{children:s.jsx(hr,{className:"h-2 w-2 fill-current"})})}),e]}));td.displayName=qa.displayName;const sd=d.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(Ja,{ref:r,className:_("px-2 py-1.5 text-sm font-semibold text-foreground",e&&"pl-8",a),...t}));sd.displayName=Ja.displayName;const dn=d.forwardRef(({className:a,...e},t)=>s.jsx(Xa,{ref:t,className:_("-mx-1 my-1 h-px bg-border",a),...e}));dn.displayName=Xa.displayName;function ga({children:a,folderId:e,folderName:t,onRename:r,onDelete:n,onCreateSubfolder:o,disabled:i=!1}){return i?s.jsx(s.Fragment,{children:a}):s.jsxs(ln,{children:[s.jsx(cn,{asChild:!0,children:a}),s.jsxs(qs,{className:"w-48",children:[s.jsxs(pt,{onClick:()=>r(e),children:[s.jsx(wr,{className:"h-4 w-4 mr-2"}),"Rename Folder"]}),s.jsxs(pt,{onClick:()=>o(e),children:[s.jsx(Ts,{className:"h-4 w-4 mr-2"}),"New Subfolder"]}),s.jsx(dn,{}),s.jsxs(pt,{onClick:()=>n(e),className:"text-destructive focus:text-destructive",children:[s.jsx(Ls,{className:"h-4 w-4 mr-2"}),"Delete Folder"]})]})]})}const ad=eo,rd=to,un=d.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Qa,{ref:r,className:_("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",a),...t,children:[e,s.jsx(qn,{asChild:!0,children:s.jsx($s,{className:"h-4 w-4 opacity-50"})})]}));un.displayName=Qa.displayName;const mn=d.forwardRef(({className:a,...e},t)=>s.jsx(Za,{ref:t,className:_("flex cursor-default items-center justify-center py-1",a),...e,children:s.jsx(yo,{className:"h-4 w-4"})}));mn.displayName=Za.displayName;const fn=d.forwardRef(({className:a,...e},t)=>s.jsx(er,{ref:t,className:_("flex cursor-default items-center justify-center py-1",a),...e,children:s.jsx($s,{className:"h-4 w-4"})}));fn.displayName=er.displayName;const gn=d.forwardRef(({className:a,children:e,position:t="popper",...r},n)=>s.jsx(Jn,{children:s.jsxs(tr,{ref:n,className:_("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:t,...r,children:[s.jsx(mn,{}),s.jsx(Xn,{className:_("p-1",t==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:e}),s.jsx(fn,{})]})}));gn.displayName=tr.displayName;const nd=d.forwardRef(({className:a,...e},t)=>s.jsx(sr,{ref:t,className:_("py-1.5 pl-8 pr-2 text-sm font-semibold",a),...e}));nd.displayName=sr.displayName;const hn=d.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(ar,{ref:r,className:_("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(Qn,{children:s.jsx(qe,{className:"h-4 w-4"})})}),s.jsx(Zn,{children:e})]}));hn.displayName=ar.displayName;const od=d.forwardRef(({className:a,...e},t)=>s.jsx(rr,{ref:t,className:_("-mx-1 my-1 h-px bg-muted",a),...e}));od.displayName=rr.displayName;const id=[{value:"#3b82f6",label:"Blue"},{value:"#8b5cf6",label:"Purple"},{value:"#10b981",label:"Green"},{value:"#f59e0b",label:"Orange"},{value:"#ef4444",label:"Red"},{value:"#06b6d4",label:"Cyan"},{value:"#84cc16",label:"Lime"},{value:"#f97316",label:"Orange"}],Es=[{value:"Folder",label:"Folder",icon:Ge},{value:"Code",label:"Code",icon:wo},{value:"Palette",label:"Design",icon:xr},{value:"BookOpen",label:"Learning",icon:bo},{value:"Star",label:"Favorites",icon:vo},{value:"Heart",label:"Personal",icon:Co},{value:"Zap",label:"Quick",icon:br},{value:"Target",label:"Goals",icon:jo},{value:"Lightbulb",label:"Ideas",icon:So},{value:"Coffee",label:"Work",icon:No}];function ld({isOpen:a,onClose:e,onConfirm:t,parentId:r,initialData:n,mode:o="create"}){const[i,l]=d.useState(""),[u,m]=d.useState("#3b82f6"),[c,x]=d.useState("Folder");d.useEffect(()=>{a&&(n?(l(n.name),m(n.color),x(n.icon)):(l(""),m("#3b82f6"),x("Folder")))},[a]),d.useEffect(()=>{a&&n&&(l(n.name),m(n.color),x(n.icon))},[n,a]);const h=C=>{C.preventDefault(),i.trim()&&(t({name:i.trim(),color:u,icon:c,parentId:r}),e())},f=Es.find(C=>C.value===c)?.icon||Ge;return s.jsx(st,{open:a,onOpenChange:e,children:s.jsxs(Je,{className:"sm:max-w-md",children:[s.jsxs(wt,{children:[s.jsx(vt,{children:o==="create"?"Create New Folder":"Edit Folder"}),s.jsx(ss,{children:o==="create"?"Create a new folder to organize your cards.":"Update folder details."})]}),s.jsxs("form",{onSubmit:h,className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"folder-name",children:"Folder Name"}),s.jsx(ve,{id:"folder-name",value:i,onChange:C=>l(C.target.value),placeholder:"Enter folder name...",autoFocus:!0})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{children:"Color"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:id.map(C=>s.jsx("button",{type:"button",onClick:()=>m(C.value),className:`w-8 h-8 rounded-full border-2 transition-all ${u===C.value?"border-foreground scale-110":"border-muted hover:scale-105"}`,style:{backgroundColor:C.value},title:C.label},C.value))})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{children:"Icon"}),s.jsxs(ad,{value:c,onValueChange:x,children:[s.jsx(un,{children:s.jsx(rd,{children:s.jsxs("div",{className:"flex items-center gap-2",children:[V.createElement(f,{className:"h-4 w-4",style:{color:u}}),Es.find(C=>C.value===c)?.label]})})}),s.jsx(gn,{children:Es.map(C=>{const j=C.icon;return s.jsx(hn,{value:C.value,children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(j,{className:"h-4 w-4"}),C.label]})},C.value)})})]})]}),r&&s.jsx("div",{className:"flex items-center gap-2",children:s.jsx(Z,{variant:"secondary",children:"Subfolder"})}),s.jsxs(bt,{children:[s.jsx(L,{type:"button",variant:"outline",onClick:e,children:"Cancel"}),s.jsx(L,{type:"submit",disabled:!i.trim(),children:o==="create"?"Create Folder":"Save Changes"})]})]})]})})}const cd=ao,dd=so,pn=d.forwardRef(({className:a,...e},t)=>s.jsx(nr,{className:_("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...e,ref:t}));pn.displayName=nr.displayName;const xn=d.forwardRef(({className:a,...e},t)=>s.jsxs(dd,{children:[s.jsx(pn,{}),s.jsx(or,{ref:t,className:_("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...e})]}));xn.displayName=or.displayName;const yn=({className:a,...e})=>s.jsx("div",{className:_("flex flex-col space-y-2 text-center sm:text-left",a),...e});yn.displayName="AlertDialogHeader";const wn=({className:a,...e})=>s.jsx("div",{className:_("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...e});wn.displayName="AlertDialogFooter";const bn=d.forwardRef(({className:a,...e},t)=>s.jsx(ir,{ref:t,className:_("text-lg font-semibold",a),...e}));bn.displayName=ir.displayName;const vn=d.forwardRef(({className:a,...e},t)=>s.jsx(lr,{ref:t,className:_("text-sm text-muted-foreground",a),...e}));vn.displayName=lr.displayName;const Cn=d.forwardRef(({className:a,...e},t)=>s.jsx(cr,{ref:t,className:_(Vs(),a),...e}));Cn.displayName=cr.displayName;const jn=d.forwardRef(({className:a,...e},t)=>s.jsx(dr,{ref:t,className:_(Vs({variant:"outline"}),"mt-2 sm:mt-0",a),...e}));jn.displayName=dr.displayName;function ud({isOpen:a,onClose:e,onConfirm:t,folderName:r,cardCount:n,hasSubfolders:o=!1,subfolderCount:i=0}){const l=()=>{t(),e()};return s.jsx(cd,{open:a,onOpenChange:e,children:s.jsxs(xn,{children:[s.jsxs(yn,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(De,{className:"h-5 w-5 text-destructive"}),s.jsx(bn,{children:"Delete Folder"})]}),s.jsxs(vn,{className:"space-y-3",children:[s.jsxs("p",{children:["Are you sure you want to delete the folder ",s.jsxs("strong",{children:['"',r,'"']}),"?"]}),s.jsxs("div",{className:"bg-destructive/10 p-3 rounded-lg space-y-2",children:[s.jsx("p",{className:"text-sm font-medium text-destructive",children:"This action will permanently delete:"}),s.jsxs("div",{className:"flex flex-wrap gap-2",children:[n>0&&s.jsxs(Z,{variant:"destructive",children:[n," card",n!==1?"s":""]}),o&&i>0&&s.jsxs(Z,{variant:"destructive",children:[i," subfolder",i!==1?"s":""]})]})]}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"This action cannot be undone."})]})]}),s.jsxs(wn,{children:[s.jsx(jn,{children:"Cancel"}),s.jsx(Cn,{onClick:l,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete Forever"})]})]})})}function md({children:a,tagName:e,onRename:t,onDelete:r,disabled:n=!1}){const o=()=>{n||t(e)},i=()=>{n||r(e)};return n?s.jsx(s.Fragment,{children:a}):s.jsxs(ln,{children:[s.jsx(cn,{asChild:!0,children:a}),s.jsxs(qs,{className:"w-48",children:[s.jsxs(pt,{onClick:o,className:"flex items-center gap-2",children:[s.jsx(wr,{className:"h-4 w-4"}),"Rename Tag"]}),s.jsxs(pt,{onClick:i,className:"flex items-center gap-2 text-destructive focus:text-destructive",children:[s.jsx(Ls,{className:"h-4 w-4"}),"Delete Tag"]})]})]})}function fd({isOpen:a,onClose:e,onConfirm:t,tagName:r,existingTags:n}){const[o,i]=d.useState(""),[l,u]=d.useState("");d.useEffect(()=>{a&&(i(r),u(""))},[a,r]);const m=h=>{const f=h.trim();return f?f===r?"Please enter a different name":n.includes(f)?"A tag with this name already exists":f.length>50?"Tag name must be less than 50 characters":"":"Tag name cannot be empty"},c=()=>{const h=o.trim(),f=m(h);if(f){u(f);return}t(r,h),e()},x=h=>{h.key==="Enter"&&c()};return s.jsx(st,{open:a,onOpenChange:e,children:s.jsxs(Je,{className:"sm:max-w-md",children:[s.jsxs(wt,{children:[s.jsx(vt,{children:"Rename Tag"}),s.jsxs(ss,{children:['Enter a new name for the tag "',r,'". This will update all cards using this tag.']})]}),s.jsx("div",{className:"space-y-4 py-4",children:s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"tag-name",children:"Tag Name"}),s.jsx(ve,{id:"tag-name",value:o,onChange:h=>{i(h.target.value),l&&u("")},onKeyPress:x,placeholder:"Enter tag name...",autoFocus:!0}),l&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[s.jsx(Se,{className:"h-4 w-4"}),l]})]})}),s.jsxs(bt,{children:[s.jsx(L,{variant:"outline",onClick:e,children:"Cancel"}),s.jsx(L,{onClick:c,disabled:!!l||!o.trim(),children:"Rename Tag"})]})]})})}function gd({isOpen:a,onClose:e,onConfirm:t,tagName:r,cardCount:n}){return s.jsx(st,{open:a,onOpenChange:e,children:s.jsxs(Je,{className:"sm:max-w-md",children:[s.jsxs(wt,{children:[s.jsxs(vt,{className:"flex items-center gap-2",children:[s.jsx(De,{className:"h-5 w-5 text-destructive"}),"Delete Tag"]}),s.jsxs(ss,{children:['Are you sure you want to delete the tag "',r,'"?']})]}),s.jsx("div",{className:"py-4",children:s.jsxs("div",{className:"rounded-lg bg-destructive/10 p-4 border border-destructive/20",children:[s.jsx("p",{className:"text-sm text-destructive font-medium mb-2",children:"This action cannot be undone."}),s.jsxs("p",{className:"text-sm text-muted-foreground",children:["This tag will be removed from ",s.jsx("strong",{children:n})," ",n===1?"card":"cards","."]})]})}),s.jsxs(bt,{children:[s.jsx(L,{variant:"outline",onClick:e,children:"Cancel"}),s.jsx(L,{variant:"destructive",onClick:t,children:"Delete Tag"})]})]})})}const hd=({tag:a,isSelected:e,onClick:t,className:r,showCount:n=!0})=>s.jsxs("button",{onClick:()=>t(a),className:_("relative flex items-center justify-between px-3 py-2 rounded-xl border transition-all duration-300 ease-out","hover:shadow-lg hover:shadow-black/10 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-blue-500/30","backdrop-blur-sm group",e?"bg-gradient-to-r from-blue-500 to-blue-600 border-blue-500 text-white shadow-md shadow-blue-500/25":"bg-white/80 border-gray-200/60 text-gray-700 hover:bg-white hover:border-gray-300/80",r),style:{boxShadow:e?"0 4px 20px -4px rgba(59, 130, 246, 0.3), 0 0 0 1px rgba(59, 130, 246, 0.1)":void 0},children:[s.jsxs("div",{className:"flex items-center gap-2.5 flex-1 min-w-0",children:[s.jsx("div",{className:_("w-2 h-2 rounded-full flex-shrink-0 transition-all duration-300",e?"bg-white/90 shadow-sm":"shadow-sm"),style:{backgroundColor:e?"rgba(255, 255, 255, 0.9)":a.color,boxShadow:e?"0 1px 3px rgba(0, 0, 0, 0.1)":`0 1px 3px ${a.color}40`}}),s.jsx("span",{className:_("text-sm font-medium truncate transition-all duration-300",e?"text-white":"text-gray-700 group-hover:text-gray-900"),children:a.name}),e&&s.jsx(qe,{className:"w-3.5 h-3.5 text-white/90 flex-shrink-0 animate-in fade-in-0 zoom-in-95 duration-200"})]}),n&&s.jsx("span",{className:_("text-xs font-medium px-2 py-0.5 rounded-full ml-2 flex-shrink-0 transition-all duration-300",e?"text-blue-600 bg-white/90 shadow-sm":"text-gray-500 bg-gray-100/80 group-hover:bg-gray-200/80 group-hover:text-gray-600"),children:a.count})]}),pd=({tags:a,selectedTags:e,onTagClick:t,className:r,emptyMessage:n="No tags found"})=>a.length===0?s.jsx("div",{className:_("text-center py-8 text-gray-500",r),children:s.jsx("p",{className:"text-sm",children:n})}):s.jsx("div",{className:_("grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2",r),children:a.map(o=>s.jsx(hd,{tag:o,isSelected:e.includes(o.name),onClick:t},o.id))}),xd=({onSearch:a,onCreateTag:e,searchResults:t,searchQuery:r,className:n})=>{const[o,i]=d.useState(r);d.useEffect(()=>{i(r)},[r]);const l=c=>{const x=c.target.value;i(x),a(x)},u=()=>{o.trim()&&(e(o.trim()),i(""),a(""))},m=o.trim()&&t.length===0&&!t.some(c=>c.name.toLowerCase()===o.toLowerCase());return s.jsxs("div",{className:_("space-y-3",n),children:[s.jsxs("div",{className:"relative",children:[s.jsx(ft,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),s.jsx(ve,{placeholder:"Search tags or create new...",value:o,onChange:l,className:"pl-11 pr-4 py-3 rounded-2xl border-gray-200/60 bg-gray-50/50 backdrop-blur-sm focus:bg-white focus:border-blue-300 transition-all duration-300"})]}),m&&s.jsxs(L,{onClick:u,variant:"outline",className:"w-full justify-start text-left rounded-xl border-dashed border-2 border-gray-300 hover:border-blue-400 hover:bg-blue-50/50 transition-all duration-300 py-3",children:[s.jsx(Gt,{className:"h-4 w-4 mr-2 text-blue-500"}),s.jsxs("span",{className:"text-gray-700",children:['Create tag "',s.jsx("span",{className:"font-medium text-blue-600",children:o}),'"']})]})]})},yd=({isOpen:a,onClose:e,currentCardTags:t,onTagsChange:r})=>{const{tags:n,searchTags:o,dispatch:i,createTagIfNotExists:l}=Nr(),[u,m]=d.useState(""),[c,x]=d.useState([]),[h,f]=d.useState(t);d.useEffect(()=>{if(u.trim()){const g=o(u);x(g)}else{const g=[...n].sort((p,y)=>y.count-p.count);x(g)}},[u,n,o]),d.useEffect(()=>{f(t)},[t]);const C=g=>{m(g)},j=g=>{i({type:"CREATE_TAG",payload:{name:g,color:"#3b82f6"}});const p=[...h,g];f(p),r(p),m("")},N=g=>{const p=h.includes(g.name);let y;p?y=h.filter(b=>b!==g.name):y=[...h,g.name],f(y),r(y)},v=()=>{m(""),e()};return a?s.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",style:{backgroundColor:"rgba(0, 0, 0, 0.15)",backdropFilter:"blur(8px)"},children:[s.jsx("div",{className:"absolute inset-0",onClick:v}),s.jsxs("div",{className:"relative bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 p-6 w-full max-w-sm sm:max-w-md lg:max-w-2xl max-h-[85vh] flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Manage Tags"}),s.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Select tags for this card"})]}),s.jsx("button",{onClick:v,className:"p-1 rounded-lg hover:bg-gray-100 transition-colors",children:s.jsx(at,{className:"w-5 h-5 text-gray-500"})})]}),s.jsx(xd,{onSearch:C,onCreateTag:j,searchResults:c,searchQuery:u,className:"mb-4"}),h.length>0&&s.jsxs("div",{className:"mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-100/50",children:[s.jsxs("p",{className:"text-sm font-medium text-blue-700 mb-3",children:["Selected tags (",h.length,"):"]}),s.jsx("div",{className:"flex flex-wrap gap-1.5",children:h.map(g=>s.jsx("span",{className:"inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-sm",children:g},g))})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx(pd,{tags:c,selectedTags:h,onTagClick:N,emptyMessage:u?`No tags found for "${u}"`:"No tags available"})}),s.jsx("div",{className:"text-xs text-gray-400 text-center mt-4 pt-4 border-t border-gray-100",children:s.jsxs("div",{className:"flex items-center justify-center gap-2",children:[s.jsx("div",{className:"w-1 h-1 rounded-full bg-gray-300"}),s.jsx("span",{children:"Click tags to add/remove them from this card"}),s.jsx("div",{className:"w-1 h-1 rounded-full bg-gray-300"})]})})]})]}):null},wd=()=>{const{isOpen:a,currentCardTags:e,onTagsChange:t,closeTagPanel:r}=Ar();return!a||!t?null:s.jsx(yd,{isOpen:a,onClose:r,currentCardTags:e,onTagsChange:t})};class bd{static generateSuggestions(e){const t=[];switch(e.type){case"card_content":t.push(...this.generateCardContentSuggestions(e));break;case"folder_name":t.push(...this.generateFolderNameSuggestions(e));break;case"tag_rename":t.push(...this.generateTagRenameSuggestions(e));break;default:t.push(this.getDefaultSuggestion())}return t.sort((r,n)=>n.confidence-r.confidence)}static generateCardContentSuggestions(e){const t=[],{localVersion:r,remoteVersion:n}=e,o=this.calculateSimilarity(r.content.frontContent.title,n.content.frontContent.title),i=this.calculateSimilarity(r.content.frontContent.text,n.content.frontContent.text),u=Math.abs(r.updatedAt.getTime()-n.updatedAt.getTime())<5*60*1e3,m=r.content.frontContent.text.length,c=n.content.frontContent.text.length,x=Math.max(m,c)/Math.min(m,c);o>.8&&i>.6&&u&&t.push({type:"merge",confidence:.9,reason:"内容高度相似，建议智能合并保留最佳内容",preview:{mergedTitle:this.mergeTitles(r.content.frontContent.title,n.content.frontContent.title),mergedLength:Math.max(m,c)}}),n.updatedAt.getTime()>r.updatedAt.getTime()&&x>2&&c>m&&t.push({type:"keep_remote",confidence:.8,reason:"远程版本内容更丰富且更新时间更近"});const h=new Set(r.content.frontContent.tags),f=new Set(n.content.frontContent.tags),C=[...h].filter(N=>!f.has(N));C.length>0&&C.length/h.size>.3&&t.push({type:"keep_local",confidence:.7,reason:"本地版本包含独特标签，可能包含重要分类信息"});const j=r.updatedAt.getTime()>n.updatedAt.getTime()?"local":"remote";return t.push({type:j==="local"?"keep_local":"keep_remote",confidence:.6,reason:`保留最新版本（${j==="local"?"本地":"远程"}设备）`}),t}static generateFolderNameSuggestions(e){const t=[],{localVersion:r,remoteVersion:n}=e,o=r.name.toLowerCase(),i=n.name.toLowerCase();if(o===i)return[];if(this.calculateSimilarity(r.name,n.name)>.8&&t.push({type:"merge",confidence:.9,reason:"文件夹名称相似，建议统一命名"}),o.includes(i)||i.includes(o)){const m=r.name.length>n.name.length?"local":"remote";t.push({type:m==="local"?"keep_local":"keep_remote",confidence:.8,reason:"保留更具描述性的文件夹名称"})}const u=r.updatedAt.getTime()>n.updatedAt.getTime()?"local":"remote";return t.push({type:u==="local"?"keep_local":"keep_remote",confidence:.6,reason:`保留最新修改的版本（${u==="local"?"本地":"远程"}）`}),t}static generateTagRenameSuggestions(e){const t=[],{localVersion:r,remoteVersion:n}=e,o=r.count/Math.max(n.count,1);o>2?t.push({type:"keep_local",confidence:.9,reason:`本地标签使用频率更高（${r.count}次 vs ${n.count}次）`}):o<.5&&t.push({type:"keep_remote",confidence:.9,reason:`远程标签使用频率更高（${n.count}次 vs ${r.count}次）`});const i=this.evaluateTagNameQuality(r.name),l=this.evaluateTagNameQuality(n.name);if(Math.abs(i-l)>.3){const m=i>l?"local":"remote";t.push({type:m==="local"?"keep_local":"keep_remote",confidence:.8,reason:`${m==="local"?"本地":"远程"}标签名称质量更好`})}const u=r.updatedAt.getTime()>n.updatedAt.getTime()?"local":"remote";return t.push({type:u==="local"?"keep_local":"keep_remote",confidence:.6,reason:"保留最新修改的版本"}),t}static calculateSimilarity(e,t){if(!e||!t)return 0;const r=e.toLowerCase().trim(),n=t.toLowerCase().trim();if(r===n)return 1;const o=Math.max(r.length,n.length);return o===0?1:1-this.levenshteinDistance(r,n)/o}static levenshteinDistance(e,t){const r=Array(t.length+1).fill(null).map(()=>Array(e.length+1).fill(null));for(let n=0;n<=e.length;n+=1)r[0][n]=n;for(let n=0;n<=t.length;n+=1)r[n][0]=n;for(let n=1;n<=t.length;n+=1)for(let o=1;o<=e.length;o+=1){const i=e[o-1]===t[n-1]?0:1;r[n][o]=Math.min(r[n][o-1]+1,r[n-1][o]+1,r[n-1][o-1]+i)}return r[t.length][e.length]}static mergeTitles(e,t){if(e===t||e.includes(t)&&e.length>t.length)return e;if(t.includes(e)&&t.length>e.length)return t;const r=new Set(e.toLowerCase().split(/\s+/)),n=new Set(t.toLowerCase().split(/\s+/)),o=new Set([...r,...n]),i=e.split(/\s+/),l=t.split(/\s+/),u=[];return i.forEach(m=>{!u.includes(m)&&o.has(m.toLowerCase())&&u.push(m)}),l.forEach(m=>{!u.includes(m)&&o.has(m.toLowerCase())&&u.push(m)}),u.join(" ")}static evaluateTagNameQuality(e){let t=.5;e.length>=3&&e.length<=20&&(t+=.2),e.length>30&&(t-=.1),/^[a-zA-Z0-9\u4e00-\u9fff\s\-_]+$/.test(e)&&(t+=.2),(e===e.toLowerCase()||/^[A-Z][a-z]+([A-Z][a-z]*)*$/.test(e))&&(t+=.1);const n=e.match(/[^a-zA-Z0-9\u4e00-\u9fff\s]/g);return n&&n.length>2&&(t-=.1),Math.max(0,Math.min(1,t))}static getDefaultSuggestion(){return{type:"manual",confidence:.5,reason:"无法自动确定最佳解决方案，建议手动处理"}}static applyResolution(e,t){switch(t.type){case"keep_local":return this.getLocalVersion(e);case"keep_remote":return this.getRemoteVersion(e);case"merge":return this.mergeVersions(e,t.mergedData);case"manual":return t.mergedData||t.manualChanges;default:throw new Error(`Unknown resolution type: ${t.type}`)}}static getLocalVersion(e){return e.entityType==="card",e.localVersion}static getRemoteVersion(e){return e.entityType==="card",e.remoteVersion}static mergeVersions(e,t){return t||this.smartMerge(e)}static smartMerge(e){if(e.entityType==="card"){const t=e,r=t.localVersion,n=t.remoteVersion;return{content:{frontContent:{title:this.mergeTitles(r.content.frontContent.title,n.content.frontContent.title),text:this.mergeText(r.content.frontContent.text,n.content.frontContent.text),tags:[...new Set([...r.content.frontContent.tags,...n.content.frontContent.tags])],lastModified:new Date},backContent:{title:this.mergeTitles(r.content.backContent.title,n.content.backContent.title),text:this.mergeText(r.content.backContent.text,n.content.backContent.text),tags:[...new Set([...r.content.backContent.tags,...n.content.backContent.tags])],lastModified:new Date}},style:r.style,folderId:r.folderId,isFlipped:r.isFlipped,updatedAt:new Date}}return this.getLocalVersion(e)}static mergeText(e,t){if(e===t)return e;const r=e.split(/[.!?]+/).filter(i=>i.trim()),n=t.split(/[.!?]+/).filter(i=>i.trim()),o=new Set([...r.map(i=>i.trim()),...n.map(i=>i.trim())]);return`${Array.from(o).filter(i=>i.length>0).join(". ")}.`}}function is(){const[a,e]=d.useState([]),[t,r]=d.useState(null),[n,o]=d.useState(!1),[i,l]=d.useState(!1),[u,m]=d.useState(null),[c,x]=d.useState(null),[h,f]=d.useState(null),C=d.useRef({totalConflicts:0,resolvedConflicts:0,pendingConflicts:0,conflictsByType:{},conflictsBySeverity:{},averageResolutionTime:0});d.useEffect(()=>{const M={totalConflicts:a.length,resolvedConflicts:a.filter(F=>F.status==="resolved").length,pendingConflicts:a.filter(F=>F.status==="pending").length,conflictsByType:{},conflictsBySeverity:{},averageResolutionTime:b()};a.forEach(F=>{M.conflictsByType[F.type]=(M.conflictsByType[F.type]||0)+1,M.conflictsBySeverity[F.severity]=(M.conflictsBySeverity[F.severity]||0)+1}),C.current=M},[a]),d.useEffect(()=>{j();const M=setInterval(()=>{E()},5e3);return()=>{clearInterval(M)}},[]);const j=async()=>{l(!0);try{await N(),await E(),m(null)}catch(M){console.error("Failed to initialize conflict management:",M),m(M instanceof Error?M.message:"Unknown error")}finally{l(!1)}},N=async()=>{try{const M=de.getConflicts(),F=v(M);return e(F),F}catch(M){return console.error("Failed to load conflicts from service:",M),[]}},v=M=>M.map(F=>{const I={id:F.id,type:g(F.conflictType),entityType:F.entityType,entityId:F.entityId,timestamp:F.detectedAt||new Date,sourceDevice:F.sourceDevice||"Unknown",severity:F.severity,status:p(F.status),createdAt:F.detectedAt||new Date,resolvedAt:F.resolvedAt,resolvedBy:F.resolvedBy,resolution:F.resolution?y(F.resolution):void 0};switch(F.entityType){case"card":return{...I,type:"card_content",localVersion:F.localData,remoteVersion:F.cloudData,conflictFields:F.conflictFields||[],suggestions:F.suggestions?.map(H=>({type:H.type,confidence:H.confidence,reason:H.reasoning||H.reason,preview:H.preview}))};case"folder":return{...I,type:"folder_name",localVersion:F.localData,remoteVersion:F.cloudData,affectedCards:F.conflictDetails?.affectedEntities||[]};case"tag":return{...I,type:"tag_rename",localVersion:F.localData,remoteVersion:F.cloudData,affectedCards:F.conflictDetails?.affectedEntities||[]};default:throw new Error(`Unknown entity type: ${F.entityType}`)}}),g=M=>({content:"card_content",version:"card_content",structure:"folder_structure",delete:"tag_delete",field:"card_content"})[M]||"card_content",p=M=>({pending:"pending",resolving:"reviewing",resolved:"resolved",manual_required:"pending"})[M]||"pending",y=M=>({type:M.type,mergedData:M.mergedData,reason:M.reasoning,manualChanges:M.manualChanges}),b=()=>{const M=a.filter(I=>I.status==="resolved"&&I.resolvedAt);return M.length===0?0:M.reduce((I,H)=>I+(H.resolvedAt.getTime()-H.createdAt.getTime()),0)/M.length},E=async()=>{try{const M=de.getStatus();f(M),M.isSyncing===!1&&M.networkStatus?.online&&await w()}catch(M){console.error("Failed to update sync status:",M)}},w=async()=>{try{const M=await N();M.filter(I=>I.status==="pending").length>a.filter(I=>I.status==="pending").length&&e(M)}catch(M){console.error("Failed to detect new conflicts:",M)}},k=d.useCallback(M=>a.find(F=>F.id===M),[a]),T=d.useCallback(()=>a.filter(M=>M.status==="pending"),[a]),$=d.useCallback(()=>a.filter(M=>M.severity==="high"||M.severity==="critical"),[a]),A=d.useCallback(()=>({...C.current}),[]),G=d.useCallback(async(M,F)=>{o(!0),m(null);try{if(await de.resolveConflict(M,F.type,F.mergedData))return e(H=>H.map(q=>q.id===M?{...q,status:"resolved",resolvedAt:new Date,resolvedBy:"user",resolution:F}:q)),r(null),await E(),!0;throw new Error("Failed to resolve conflict via sync service")}catch(I){return console.error("Failed to resolve conflict:",I),m(I instanceof Error?I.message:"Unknown error"),!1}finally{o(!1)}},[]),te=d.useCallback(async M=>{try{if(!a.find(I=>I.id===M))return;e(I=>I.map(H=>H.id===M?{...H,status:"ignored"}:H)),r(null)}catch(F){console.error("Failed to ignore conflict:",F),m(F instanceof Error?F.message:"Unknown error")}},[a]),W=d.useCallback(async(M,F)=>{o(!0),m(null);try{const I=await Promise.allSettled(M.map(B=>de.resolveConflict(B,F.type,F.mergedData))),H=I.filter(B=>B.status==="fulfilled").length,q=I.filter(B=>B.status==="rejected").length;if(H>0&&e(B=>B.map(R=>M.includes(R.id)?{...R,status:"resolved",resolvedAt:new Date,resolvedBy:"user",resolution:F}:R)),q>0)throw new Error(`${q} conflicts failed to resolve`);return await E(),!0}catch(I){return console.error("Failed to batch resolve conflicts:",I),m(I instanceof Error?I.message:"Unknown error"),!1}finally{o(!1)}},[]),ee=d.useCallback(M=>{const F=k(M);if(!F)return[];const I=bd.generateSuggestions(F),H=de.getConflict(M)?.suggestions||[];return[...I,...H.map(B=>({type:B.type,confidence:B.confidence,reason:B.reasoning||B.reason,preview:B.preview}))].sort((B,R)=>R.confidence-B.confidence)},[k]),ae=d.useCallback(async()=>{l(!0);try{const M=await de.sync({type:"incremental",direction:"bidirectional"}),F=await N(),I=F.filter(H=>H.status==="pending");return e(F),I}catch(M){return console.error("Failed to detect conflicts:",M),m(M instanceof Error?M.message:"Unknown error"),[]}finally{l(!1)}},[]),re=d.useCallback(async()=>{o(!0);try{const M=await de.autoResolveConflicts();return await N(),await E(),M}catch(M){return console.error("Failed to auto-resolve conflicts:",M),m(M instanceof Error?M.message:"Unknown error"),0}finally{o(!1)}},[]),fe=d.useCallback(async M=>{try{const F=k(M);if(!F)return null;const I=de.getConflict(M);return{...F,syncDetails:I,suggestions:ee(M)}}catch(F){return console.error("Failed to get conflict details:",F),null}},[k,ee]),z=d.useCallback(async()=>{l(!0);try{await N(),await E(),m(null)}catch(M){console.error("Failed to refresh conflicts:",M),m(M instanceof Error?M.message:"Unknown error")}finally{l(!1)}},[]),Y=d.useCallback(()=>{m(null)},[]);return{conflicts:a,selectedConflict:t,setSelectedConflict:r,isResolving:n,isLoading:i,error:u,syncStatus:h,metrics:c,stats:{...C.current},getConflictById:k,getPendingConflicts:T,getHighPriorityConflicts:$,getStats:A,resolveConflict:G,ignoreConflict:te,batchResolveConflicts:W,getSuggestions:ee,detectConflicts:ae,autoResolveConflicts:re,getConflictDetails:fe,refreshConflicts:z,clearError:Y}}const vd=Zt("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),tt=d.forwardRef(({className:a,variant:e,...t},r)=>s.jsx("div",{ref:r,role:"alert",className:_(vd({variant:e}),a),...t}));tt.displayName="Alert";const Sn=d.forwardRef(({className:a,...e},t)=>s.jsx("h5",{ref:t,className:_("mb-1 font-medium leading-none tracking-tight",a),...e}));Sn.displayName="AlertTitle";const xt=d.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:_("text-sm [&_p]:leading-relaxed",a),...e}));xt.displayName="AlertDescription";function Cd({className:a,onOpenConflictPanel:e}){const{stats:t,getHighPriorityConflicts:r,detectConflicts:n,setSelectedConflict:o}=is(),i=r();if(!(t.pendingConflicts>0))return null;const u=async()=>{await n()},m=x=>{o(x),e?.()},c=x=>{switch(x){case"critical":return"bg-red-500 text-white";case"high":return"bg-orange-500 text-white";case"medium":return"bg-yellow-500 text-white";case"low":return"bg-blue-500 text-white";default:return"bg-gray-500 text-white"}};return s.jsxs("div",{className:_("space-y-2",a),children:[s.jsxs(tt,{className:"border-orange-200 bg-orange-50",children:[s.jsx(De,{className:"h-4 w-4 text-orange-600"}),s.jsx(Sn,{className:"text-orange-800",children:"检测到数据冲突"}),s.jsxs(xt,{className:"text-orange-700",children:["发现 ",t.pendingConflicts," 个待解决的数据冲突，建议及时处理以避免数据丢失。",i.length>0&&s.jsxs("span",{className:"ml-2 font-medium",children:["其中 ",i.length," 个需要立即处理。"]})]}),s.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(L,{variant:"outline",size:"sm",onClick:e,className:"text-orange-700 border-orange-300 hover:bg-orange-100",children:[s.jsx(Qs,{className:"h-4 w-4 mr-2"}),"查看所有冲突"]}),s.jsxs(L,{variant:"ghost",size:"sm",onClick:u,className:"text-orange-600 hover:bg-orange-100",children:[s.jsx(Re,{className:"h-4 w-4 mr-2"}),"刷新检测"]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(Z,{variant:"secondary",className:"text-orange-700 bg-orange-100",children:["总计: ",t.totalConflicts]}),s.jsxs(Z,{variant:"destructive",className:"bg-red-100 text-red-700",children:["待解决: ",t.pendingConflicts]})]})]})]}),i.length>0&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h4",{className:"text-sm font-medium text-red-700",children:"高优先级冲突"}),s.jsxs(Z,{variant:"destructive",className:"text-xs",children:[i.length," 个"]})]}),i.slice(0,3).map(x=>s.jsx(tt,{className:"border-red-200 bg-red-50 cursor-pointer hover:bg-red-100 transition-colors",onClick:()=>m(x.id),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(Z,{variant:"outline",className:_("text-xs",c(x.severity)),children:x.severity}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-red-800",children:jd(x)}),s.jsx("p",{className:"text-xs text-red-600",children:Sd(x)})]})]}),s.jsx(L,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-red-600 hover:bg-red-100",onClick:h=>{h.stopPropagation(),m(x.id)},children:s.jsx(Qs,{className:"h-4 w-4"})})]})},x.id)),i.length>3&&s.jsxs(L,{variant:"ghost",size:"sm",onClick:e,className:"w-full text-red-600 hover:bg-red-100",children:["查看剩余 ",i.length-3," 个高优先级冲突"]})]})]})}function jd(a){switch(a.type){case"card_content":return"卡片内容冲突";case"card_style":return"卡片样式冲突";case"card_tags":return"卡片标签冲突";case"card_folder":return"卡片文件夹冲突";case"folder_name":return"文件夹名称冲突";case"folder_structure":return"文件夹结构冲突";case"tag_rename":return"标签重命名冲突";case"tag_delete":return"标签删除冲突";case"tag_color":return"标签颜色冲突";default:return"数据冲突"}}function Sd(a){switch(a.type){case"card_content":return`卡片 "${a.localVersion.content.frontContent.title}" 在多设备上被同时编辑`;case"folder_name":return`文件夹 "${a.localVersion.name}" 与远程版本名称不一致`;case"tag_rename":return`标签 "${a.localVersion.name}" 重命名冲突`;default:return"数据版本不一致，需要手动解决"}}const ie=d.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:_("rounded-lg border bg-card text-card-foreground shadow-sm",a),...e}));ie.displayName="Card";const Fe=d.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:_("flex flex-col space-y-1.5 p-6",a),...e}));Fe.displayName="CardHeader";const Oe=d.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:_("text-2xl font-semibold leading-none tracking-tight",a),...e}));Oe.displayName="CardTitle";const Nn=d.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:_("text-sm text-muted-foreground",a),...e}));Nn.displayName="CardDescription";const le=d.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:_("p-6 pt-0",a),...e}));le.displayName="CardContent";const Nd=d.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:_("flex items-center p-6 pt-0",a),...e}));Nd.displayName="CardFooter";const He=d.forwardRef(({className:a,value:e,...t},r)=>s.jsx(ur,{ref:r,className:_("relative h-4 w-full overflow-hidden rounded-full bg-secondary",a),...t,children:s.jsx(ro,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(e||0)}%)`}})}));He.displayName=ur.displayName;class mt{static instance;metrics=[];alerts=[];observers=[];sessionId;startTime;constructor(){this.sessionId=this.generateSessionId(),this.startTime=performance.now(),this.initializeObservers()}static getInstance(){return mt.instance||(mt.instance=new mt),mt.instance}initializeObservers(){"PerformanceObserver"in window&&(this.observePaintTiming(),this.observeLayoutShift(),this.observeInteraction()),this.observeMemoryUsage(),this.observeNetworkPerformance(),this.observeErrors(),this.startPeriodicCollection()}observePaintTiming(){try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(n=>{n.name==="first-paint"?this.updateMetric("firstPaint",n.startTime):n.name==="first-contentful-paint"&&this.updateMetric("firstContentfulPaint",n.startTime)})});e.observe({entryTypes:["paint"]}),this.observers.push(e)}catch(e){console.warn("Failed to observe paint timing:",e)}}observeLayoutShift(){try{const e=new PerformanceObserver(t=>{const r=t.getEntries();let n=0;r.forEach(o=>{o instanceof LayoutShift&&(n+=o.value)}),this.updateMetric("cumulativeLayoutShift",n)});e.observe({entryTypes:["layout-shift"]}),this.observers.push(e)}catch(e){console.warn("Failed to observe layout shift:",e)}}observeInteraction(){try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(n=>{n instanceof PerformanceEventTiming&&(this.updateMetric("interactionTime",n.duration),this.updateMetric("firstInputDelay",n.processingStart-n.startTime))})});e.observe({entryTypes:["first-input","event"]}),this.observers.push(e)}catch(e){console.warn("Failed to observe interactions:",e)}}observeMemoryUsage(){setInterval(()=>{if("memory"in performance){const e=performance.memory;this.updateMetric("memoryUsage",e.usedJSHeapSize),e.jsHeapSizeLimit-e.usedJSHeapSize<e.jsHeapSizeLimit*.1&&this.createAlert({type:"warning",category:"memory",message:"High memory usage detected",severity:"medium",suggestions:["Check for memory leaks","Consider garbage collection"]})}},5e3)}observeNetworkPerformance(){const e=window.fetch;window.fetch=async(...t)=>{const r=performance.now();try{const n=await e(...t),o=performance.now();return this.updateMetric("requestTime",o-r),n}catch(n){const o=performance.now();throw this.updateMetric("requestTime",o-r),n}}}observeErrors(){window.addEventListener("error",e=>{this.createAlert({type:"error",category:"performance",message:`JavaScript error: ${e.message}`,severity:"high",context:{filename:e.filename,lineno:e.lineno,colno:e.colno}})}),window.addEventListener("unhandledrejection",e=>{this.createAlert({type:"error",category:"performance",message:`Unhandled promise rejection: ${e.reason}`,severity:"high"})})}startPeriodicCollection(){setInterval(()=>{this.collectMetrics()},3e4)}collectMetrics(){const e={renderTime:this.calculateRenderTime(),firstPaint:this.getMetric("firstPaint")||0,firstContentfulPaint:this.getMetric("firstContentfulPaint")||0,largestContentfulPaint:this.getLCP(),cumulativeLayoutShift:this.getMetric("cumulativeLayoutShift")||0,firstInputDelay:this.getMetric("firstInputDelay")||0,interactionTime:this.getMetric("interactionTime")||0,clickLatency:this.measureClickLatency(),scrollPerformance:this.measureScrollPerformance(),inputResponsiveness:this.measureInputResponsiveness(),memoryUsage:this.getMemoryUsage(),memoryLeakDetected:this.detectMemoryLeak(),garbageCollectionTime:this.measureGarbageCollection(),networkLatency:this.measureNetworkLatency(),requestTime:this.getMetric("requestTime")||0,resourceLoadTime:this.measureResourceLoadTime(),conflictDetectionTime:this.getMetric("conflictDetectionTime")||0,conflictResolutionTime:this.getMetric("conflictResolutionTime")||0,batchOperationTime:this.getMetric("batchOperationTime")||0,perceivedPerformance:this.calculatePerceivedPerformance(),errorRate:this.calculateErrorRate(),crashRate:this.calculateCrashRate(),userSatisfaction:this.calculateUserSatisfaction(),timestamp:new Date,sessionId:this.sessionId};this.metrics.push(e),this.analyzeMetrics(e)}startConflictDetection(){const e=performance.now();return()=>{const t=performance.now();this.updateMetric("conflictDetectionTime",t-e)}}startConflictResolution(){const e=performance.now();return()=>{const t=performance.now();this.updateMetric("conflictResolutionTime",t-e)}}startBatchOperation(){const e=performance.now();return()=>{const t=performance.now();this.updateMetric("batchOperationTime",t-e)}}trackUserInteraction(e,t,r){this.updateMetric(`${e}Duration`,t),r||this.createAlert({type:"warning",category:"ux",message:`User interaction failed: ${e}`,severity:"medium"})}trackUserSatisfaction(e,t){this.updateMetric("userSatisfaction",e),t&&console.log("User feedback:",t)}analyzeMetrics(e){e.renderTime>100&&this.createAlert({type:"warning",category:"performance",message:"Slow render time detected",severity:"medium",suggestions:["Optimize component rendering","Consider virtualization"]}),e.memoryUsage>100*1024*1024&&this.createAlert({type:"warning",category:"memory",message:"High memory usage detected",severity:"medium",suggestions:["Check for memory leaks","Optimize data structures"]}),e.networkLatency>1e3&&this.createAlert({type:"warning",category:"network",message:"High network latency detected",severity:"medium",suggestions:["Check network connection","Optimize API calls"]}),e.conflictResolutionTime>5e3&&this.createAlert({type:"warning",category:"performance",message:"Slow conflict resolution detected",severity:"medium",suggestions:["Optimize conflict resolution algorithm","Consider caching"]})}generateReport(e=36e5){const t=new Date,r=new Date(t.getTime()-e),n=this.metrics.filter(i=>i.timestamp>=r&&i.timestamp<=t),o=this.calculateUserExperienceMetrics(n);return{period:{start:r,end:t},metrics:n,userExperience:o,alerts:this.alerts.filter(i=>i.timestamp>=r),summary:{averagePerformance:this.calculateAveragePerformance(n),performanceTrend:this.calculatePerformanceTrend(n),criticalIssues:this.alerts.filter(i=>i.severity==="critical").length,recommendations:this.generateRecommendations(n,o)}}}updateMetric(e,t){const r=this.metrics[this.metrics.length-1];r&&(r[e]=t)}getMetric(e){const t=this.metrics[this.metrics.length-1];return t?t[e]:null}calculateRenderTime(){const e=performance.getEntriesByType("navigation")[0];return e?e.loadEventEnd-e.loadEventStart:0}getLCP(){const e=performance.getEntriesByType("largest-contentful-paint")[0];return e?e.startTime:0}measureClickLatency(){return 0}measureScrollPerformance(){return 0}measureInputResponsiveness(){return 0}getMemoryUsage(){return"memory"in performance?performance.memory.usedJSHeapSize:0}detectMemoryLeak(){return!1}measureGarbageCollection(){return 0}measureNetworkLatency(){return 0}measureResourceLoadTime(){return 0}calculatePerceivedPerformance(){return 85}calculateErrorRate(){return .01}calculateCrashRate(){return .001}calculateUserSatisfaction(){return 85}calculateUserExperienceMetrics(e){return{averageTaskCompletionTime:0,taskSuccessRate:.95,clickCount:0,scrollDepth:0,timeOnPage:0,bounceRate:.1,conflictResolutionSuccess:.9,conflictResolutionAttempts:0,averageResolutionTime:0,userPreferredResolution:"auto",interfaceResponsiveness:85,loadingTime:0,errorEncounterRate:.02,satisfactionScore:85,feedbackCount:0,commonComplaints:[]}}calculateAveragePerformance(e){return e.length===0?0:e.reduce((r,n)=>r+n.perceivedPerformance,0)/e.length}calculatePerformanceTrend(e){if(e.length<2)return"stable";const t=e.slice(-10),r=e.slice(-20,-10),n=t.reduce((i,l)=>i+l.perceivedPerformance,0)/t.length,o=r.reduce((i,l)=>i+l.perceivedPerformance,0)/r.length;return n>o+5?"improving":n<o-5?"declining":"stable"}generateRecommendations(e,t){const r=[];return t.conflictResolutionSuccess<.8&&r.push("Improve conflict resolution algorithms"),t.interfaceResponsiveness<70&&r.push("Optimize UI responsiveness"),t.errorEncounterRate>.05&&r.push("Reduce error rates in user interactions"),r}createAlert(e){const t={...e,id:this.generateAlertId(),timestamp:new Date};this.alerts.push(t),console.warn("Performance Alert:",t)}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateAlertId(){return`alert_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getMetrics(){return[...this.metrics]}getAlerts(){return[...this.alerts]}clearMetrics(){this.metrics=[],this.alerts=[]}getRealtimeMetrics(){return{renderTime:this.calculateRenderTime(),memoryUsage:this.getMemoryUsage(),networkLatency:this.measureNetworkLatency(),perceivedPerformance:this.calculatePerceivedPerformance()}}}const Ne=mt.getInstance();function kn({className:a,showDetails:e=!1,compact:t=!1}){const[r,n]=d.useState(!0),[o,i]=d.useState(!1),[l,u]=d.useState(null),[m,c]=d.useState([]),[x,h]=d.useState({lastSyncTime:null,totalOperations:0,successfulOperations:0,failedOperations:0,averageSyncTime:0,networkLatency:0,serverResponseTime:0,dataTransferRate:0}),[f,C]=d.useState(!1);d.useEffect(()=>{const w=()=>n(!0),k=()=>n(!1);return window.addEventListener("online",w),window.addEventListener("offline",k),n(navigator.onLine),()=>{window.removeEventListener("online",w),window.removeEventListener("offline",k)}},[]),d.useEffect(()=>{const w=async()=>{try{const G=de.getStatus();u(G),i(G.isSyncing),G.lastSyncTime&&h(W=>({...W,lastSyncTime:new Date(G.lastSyncTime),totalOperations:G.totalSyncs||0,successfulOperations:G.successfulSyncs||0,failedOperations:G.failedSyncs||0}));const te=Ne.getRealtimeMetrics();h(W=>({...W,networkLatency:te.networkLatency||0}))}catch(G){console.error("Failed to update sync status:",G)}};w();const k=setInterval(w,2e3),T=()=>{i(!0),j({type:"upload",entity:"批量同步",status:"in_progress",progress:0,startTime:new Date})},$=()=>{i(!1),N("completed"),w()},A=G=>{i(!1),N("failed",G.message)};return de.on("sync:start",T),de.on("sync:complete",$),de.on("sync:error",A),()=>{clearInterval(k),de.off("sync:start",T),de.off("sync:complete",$),de.off("sync:error",A)}},[]);const j=w=>{const k={...w,id:`op_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};c(T=>[k,...T.slice(0,9)]),h(T=>({...T,totalOperations:T.totalOperations+1}))},N=(w,k)=>{c(T=>T.map($=>$.status==="in_progress"?{...$,status:w,endTime:new Date,error:k,progress:w==="completed"?100:$.progress}:$)),w==="completed"?h(T=>({...T,successfulOperations:T.successfulOperations+1})):w==="failed"&&h(T=>({...T,failedOperations:T.failedOperations+1}))},v=async()=>{try{i(!0),await de.sync({type:"incremental",direction:"bidirectional"})}catch(w){console.error("Manual sync failed:",w)}finally{i(!1)}},g=()=>r?o?"text-yellow-500 animate-pulse":l?.hasConflicts?"text-orange-500":"text-green-500":"text-red-500",p=()=>r?o?s.jsx(Re,{className:"h-4 w-4 animate-spin"}):l?.hasConflicts?s.jsx(De,{className:"h-4 w-4"}):s.jsx(ts,{className:"h-4 w-4"}):s.jsx(zs,{className:"h-4 w-4"}),y=()=>r?o?"同步中...":l?.hasConflicts?"需要解决冲突":"已同步":"离线",b=w=>{if(!w)return"从未";const T=new Date().getTime()-w.getTime(),$=Math.floor(T/6e4);return $<1?"刚刚":$<60?`${$}分钟前`:$<1440?`${Math.floor($/60)}小时前`:`${Math.floor($/1440)}天前`},E=x.totalOperations>0?(x.successfulOperations/x.totalOperations*100).toFixed(1):"0.0";return t?s.jsxs("div",{className:_("flex items-center gap-2 text-sm",a),children:[s.jsxs("div",{className:_("flex items-center gap-1",g()),children:[p(),s.jsx("span",{children:y()})]}),l?.pendingOperations>0&&s.jsxs(Z,{variant:"secondary",className:"text-xs",children:[l.pendingOperations," 待同步"]}),s.jsx(L,{variant:"ghost",size:"sm",onClick:v,disabled:o||!r,children:s.jsx(Re,{className:_("h-3 w-3",o&&"animate-spin")})})]}):s.jsxs(ie,{className:_("w-full",a),children:[s.jsxs(Fe,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Oe,{className:"text-lg",children:"同步状态"}),s.jsxs("div",{className:_("flex items-center gap-1 text-sm",g()),children:[p(),s.jsx("span",{children:y()})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[l?.pendingOperations>0&&s.jsxs(Z,{variant:"outline",children:[l.pendingOperations," 待同步"]}),s.jsxs(L,{variant:"outline",size:"sm",onClick:v,disabled:o||!r,children:[s.jsx(Re,{className:_("h-4 w-4 mr-2",o&&"animate-spin")}),"立即同步"]}),e&&s.jsx(L,{variant:"ghost",size:"sm",onClick:()=>C(!f),children:f?"收起":"详情"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"网络状态:"}),s.jsx("span",{className:"ml-2 font-medium",children:r?"在线":"离线"})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"最后同步:"}),s.jsx("span",{className:"ml-2 font-medium",children:b(x.lastSyncTime)})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"成功率:"}),s.jsxs("span",{className:"ml-2 font-medium",children:[E,"%"]})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"延迟:"}),s.jsxs("span",{className:"ml-2 font-medium",children:[x.networkLatency,"ms"]})]})]}),o&&m.length>0&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between text-sm",children:[s.jsx("span",{children:"同步进度"}),s.jsxs("span",{children:[m.find(w=>w.status==="in_progress")?.progress||0,"%"]})]}),s.jsx(He,{value:m.find(w=>w.status==="in_progress")?.progress||0,className:"h-2"})]})]}),f&&e&&s.jsxs(le,{className:"space-y-4",children:[s.jsx(ut,{}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(vr,{className:"h-4 w-4 text-blue-500"}),s.jsx("span",{className:"font-medium",children:"操作统计"})]}),s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"总操作数:"}),s.jsx("span",{children:x.totalOperations})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"成功:"}),s.jsx("span",{className:"text-green-600",children:x.successfulOperations})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"失败:"}),s.jsx("span",{className:"text-red-600",children:x.failedOperations})]})]})]})}),s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(ko,{className:"h-4 w-4 text-green-500"}),s.jsx("span",{className:"font-medium",children:"性能指标"})]}),s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"平均同步时间:"}),s.jsxs("span",{children:[x.averageSyncTime,"ms"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"服务器响应:"}),s.jsxs("span",{children:[x.serverResponseTime,"ms"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"传输速率:"}),s.jsxs("span",{children:[x.dataTransferRate,"KB/s"]})]})]})]})}),s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(Eo,{className:"h-4 w-4 text-purple-500"}),s.jsx("span",{className:"font-medium",children:"同步状态"})]}),s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"待同步操作:"}),s.jsx("span",{children:l?.pendingOperations||0})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"冲突数量:"}),s.jsx("span",{children:l?.conflicts?.length||0})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"同步模式:"}),s.jsx("span",{children:"自动"})]})]})]})})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"最近操作"}),s.jsx(Ye,{className:"h-48 border rounded-md p-2",children:s.jsx("div",{className:"space-y-2",children:m.length===0?s.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"暂无操作记录"}):m.map(w=>s.jsxs("div",{className:"flex items-center justify-between text-sm p-2 rounded border",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[w.status==="completed"&&s.jsx(Ke,{className:"h-3 w-3 text-green-500"}),w.status==="failed"&&s.jsx(_t,{className:"h-3 w-3 text-red-500"}),w.status==="in_progress"&&s.jsx(Mt,{className:"h-3 w-3 text-yellow-500 animate-spin"}),w.status==="pending"&&s.jsx(Mt,{className:"h-3 w-3 text-gray-500"}),s.jsx("span",{children:w.entity}),s.jsx(Z,{variant:"outline",className:"text-xs",children:w.type==="upload"?"上传":w.type==="download"?"下载":w.type==="conflict_resolution"?"冲突解决":"合并"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[w.status==="in_progress"&&s.jsx(He,{value:w.progress,className:"w-16 h-1"}),s.jsx("span",{className:"text-xs text-muted-foreground",children:b(w.startTime)})]})]},w.id))})})]})]})]})}function kd({isOpen:a,onClose:e,className:t}){const{conflicts:r,setSelectedConflict:n,getStats:o,getPendingConflicts:i,getHighPriorityConflicts:l,resolveConflict:u,ignoreConflict:m,batchResolveConflicts:c,refreshConflicts:x,isResolving:h,isLoading:f,error:C,syncStatus:j}=is(),[N,v]=d.useState("all"),[g,p]=d.useState(""),[y,b]=d.useState(new Set),[E,w]=d.useState(new Set),[k,T]=d.useState(!1),[$,A]=d.useState(null),G=o(),te=i(),W=l(),ee=V.useMemo(()=>{let I=r;switch(N){case"pending":I=te;break;case"high":I=W;break;case"resolved":I=r.filter(H=>H.status==="resolved");break}if(g){const H=g.toLowerCase();I=I.filter(q=>{switch(q.entityType){case"card":return q.localVersion.content.frontContent.title.toLowerCase().includes(H);case"folder":return q.localVersion.name.toLowerCase().includes(H);case"tag":return q.localVersion.name.toLowerCase().includes(H);default:return!1}})}return I.sort((H,q)=>{const B={critical:4,high:3,medium:2,low:1},R=B[q.severity]-B[H.severity];return R!==0?-R:q.timestamp.getTime()-H.timestamp.getTime()})},[r,N,g,te,W]),ae=I=>{b(H=>{const q=new Set(H);return q.has(I)?q.delete(I):q.add(I),q})},re=I=>{w(H=>{const q=new Set(H);return q.has(I)?q.delete(I):q.add(I),q})},fe=I=>{A(I),T(!0)},z=()=>{E.size===ee.length?w(new Set):w(new Set(ee.map(I=>I.id)))},Y=async I=>{if(E.size===0)return;const H=Array.from(E);await c(H,{type:I,reason:`批量选择${I==="keep_local"?"本地":"远程"}版本`}),w(new Set)},M=I=>{switch(I){case"critical":return"text-red-600 bg-red-50 border-red-200";case"high":return"text-orange-600 bg-orange-50 border-orange-200";case"medium":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"low":return"text-blue-600 bg-blue-50 border-blue-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}},F=I=>{switch(I){case"resolved":return s.jsx(Ke,{className:"h-4 w-4 text-green-500"});case"ignored":return s.jsx(_t,{className:"h-4 w-4 text-gray-500"});default:return s.jsx(Mt,{className:"h-4 w-4 text-yellow-500"})}};return a?s.jsx("div",{className:_("fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",t),children:s.jsxs(ie,{className:"w-full max-w-4xl max-h-[90vh] flex flex-col",children:[s.jsxs(Fe,{className:"pb-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(De,{className:"h-5 w-5 text-orange-500"}),s.jsx(Oe,{className:"text-xl",children:"冲突管理中心"}),s.jsxs(Z,{variant:"outline",className:"ml-2",children:[G.pendingConflicts," 待解决"]})]}),s.jsx(L,{variant:"ghost",size:"sm",onClick:e,children:"×"})]}),s.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[s.jsxs("span",{children:["总计: ",G.totalConflicts]}),s.jsxs("span",{children:["已解决: ",G.resolvedConflicts]}),s.jsxs("span",{children:["待处理: ",G.pendingConflicts]}),s.jsxs("span",{children:["高优先级: ",W.length]}),j&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:`w-2 h-2 rounded-full ${j.isSyncing?"bg-yellow-500 animate-pulse":j.networkStatus?.online?"bg-green-500":"bg-red-500"}`}),s.jsx("span",{children:j.isSyncing?"同步中...":j.networkStatus?.online?"在线":"离线"})]}),j.pendingOperations>0&&s.jsxs("span",{children:["待同步: ",j.pendingOperations]})]})]}),s.jsx(kn,{showDetails:!0,compact:!1,className:"mb-4"}),C&&s.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-red-600",children:C}),s.jsx(L,{variant:"ghost",size:"sm",onClick:()=>window.location.reload(),children:"重试"})]})})]}),s.jsxs(le,{className:"flex-1 flex flex-col space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"relative flex-1",children:[s.jsx(ft,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx("input",{type:"text",placeholder:"搜索冲突...",value:g,onChange:I=>p(I.target.value),className:"w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(L,{variant:N==="all"?"default":"outline",size:"sm",onClick:()=>v("all"),children:"全部"}),s.jsx(L,{variant:N==="pending"?"default":"outline",size:"sm",onClick:()=>v("pending"),children:"待解决"}),s.jsx(L,{variant:N==="high"?"default":"outline",size:"sm",onClick:()=>v("high"),children:"高优先级"}),s.jsx(L,{variant:N==="resolved"?"default":"outline",size:"sm",onClick:()=>v("resolved"),children:"已解决"})]}),s.jsxs(L,{variant:"outline",size:"sm",onClick:x,disabled:f,children:[s.jsx(Re,{className:`h-4 w-4 mr-2 ${f?"animate-spin":""}`}),"刷新"]})]}),E.size>0&&s.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{className:"text-sm font-medium",children:["已选择 ",E.size," 个冲突"]}),s.jsx(L,{variant:"ghost",size:"sm",onClick:z,children:E.size===ee.length?"取消全选":"全选"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(L,{variant:"outline",size:"sm",onClick:()=>Y("keep_local"),disabled:h,children:"批量保留本地"}),s.jsx(L,{variant:"outline",size:"sm",onClick:()=>Y("keep_remote"),disabled:h,children:"批量保留远程"})]})]}),s.jsx(Ye,{className:"flex-1",children:s.jsx("div",{className:"space-y-3",children:f?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(Re,{className:"h-8 w-8 animate-spin mx-auto mb-4 text-muted-foreground"}),s.jsx("p",{className:"text-muted-foreground",children:"加载冲突信息..."})]}):ee.length===0?s.jsx("div",{className:"text-center py-8 text-muted-foreground",children:g?"没有找到匹配的冲突":"暂无冲突"}):ee.map(I=>s.jsx(Ed,{conflict:I,isExpanded:y.has(I.id),isSelected:E.has(I.id),onToggleExpand:()=>ae(I.id),onToggleSelect:()=>re(I.id),onSelect:()=>n(I.id),onViewDetail:()=>fe(I.id),onResolve:H=>u(I.id,H),onIgnore:()=>m(I.id),getSeverityColor:M,getStatusIcon:F,isResolving:h},I.id))})})]})]})}):null}function Ed({conflict:a,isExpanded:e,isSelected:t,onToggleExpand:r,onToggleSelect:n,onSelect:o,onViewDetail:i,onResolve:l,onIgnore:u,getSeverityColor:m,getStatusIcon:c,isResolving:x}){return s.jsx(ie,{className:_("transition-all duration-200 cursor-pointer hover:shadow-md",m(a.severity),t&&"ring-2 ring-blue-500"),onClick:o,children:s.jsx(le,{className:"p-4",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[s.jsx("input",{type:"checkbox",checked:t,onChange:n,onClick:h=>h.stopPropagation(),className:"mt-1"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c(a.status),s.jsx(Z,{variant:"outline",className:"text-xs",children:a.severity}),s.jsx(Z,{variant:"secondary",className:"text-xs",children:Dd(a.type)}),s.jsx("span",{className:"text-xs text-muted-foreground",children:ha(a.timestamp)})]}),s.jsx("h4",{className:"font-medium mb-1",children:Rd(a)}),s.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:Td(a)}),e&&s.jsxs("div",{className:"mt-3 pt-3 border-t space-y-2",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"font-medium",children:"来源设备:"}),s.jsx("span",{className:"ml-2",children:a.sourceDevice})]}),s.jsxs("div",{children:[s.jsx("span",{className:"font-medium",children:"冲突时间:"}),s.jsx("span",{className:"ml-2",children:ha(a.timestamp)})]})]}),s.jsxs("div",{className:"flex gap-2 pt-2",children:[s.jsx(L,{variant:"default",size:"sm",onClick:h=>{h.stopPropagation(),i()},children:"查看详情"}),s.jsx(L,{variant:"outline",size:"sm",onClick:h=>{h.stopPropagation(),l({type:"keep_local",reason:"保留本地版本"})},disabled:x,children:"保留本地"}),s.jsx(L,{variant:"outline",size:"sm",onClick:h=>{h.stopPropagation(),l({type:"keep_remote",reason:"保留远程版本"})},disabled:x,children:"保留远程"}),s.jsx(L,{variant:"ghost",size:"sm",onClick:h=>{h.stopPropagation(),u()},children:"忽略"})]})]})]})]}),s.jsx(L,{variant:"ghost",size:"sm",onClick:h=>{h.stopPropagation(),r()},className:"ml-2",children:e?s.jsx($s,{className:"h-4 w-4"}):s.jsx(es,{className:"h-4 w-4"})})]})})})}function Dd(a){return{card_content:"卡片内容",card_style:"卡片样式",card_tags:"卡片标签",card_folder:"卡片文件夹",folder_name:"文件夹名称",folder_structure:"文件夹结构",tag_rename:"标签重命名",tag_delete:"标签删除",tag_color:"标签颜色"}[a]||a}function Rd(a){switch(a.entityType){case"card":return a.localVersion.content.frontContent.title;case"folder":return a.localVersion.name;case"tag":return a.localVersion.name;default:return"未知冲突"}}function Td(a){switch(a.type){case"card_content":return"卡片内容在多设备上被同时编辑";case"folder_name":return"文件夹名称与远程版本不一致";case"tag_rename":return"标签重命名冲突";default:return"数据版本不一致"}}function ha(a){const t=new Date().getTime()-a.getTime(),r=Math.floor(t/6e4);return r<1?"刚刚":r<60?`${r}分钟前`:r<1440?`${Math.floor(r/60)}小时前`:`${Math.floor(r/1440)}天前`}const Ad=no,En=d.forwardRef(({className:a,...e},t)=>s.jsx(mr,{ref:t,className:_("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",a),...e}));En.displayName=mr.displayName;const Tt=d.forwardRef(({className:a,...e},t)=>s.jsx(fr,{ref:t,className:_("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",a),...e}));Tt.displayName=fr.displayName;const At=d.forwardRef(({className:a,...e},t)=>s.jsx(gr,{ref:t,className:_("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",a),...e}));At.displayName=gr.displayName;const Dn=d.forwardRef(({className:a,...e},t)=>s.jsx("textarea",{className:_("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",a),ref:t,...e}));Dn.displayName="Textarea";function Id({conflictId:a,onClose:e,className:t}){const{getConflictById:r,resolveConflict:n,ignoreConflict:o,getSuggestions:i,isResolving:l}=is(),[u,m]=d.useState("compare"),[c,x]=d.useState("local"),[h,f]=d.useState({}),[C,j]=d.useState(!0),N=r(a),v=i(a);if(!N)return s.jsx(ie,{className:_("w-full max-w-6xl max-h-[90vh]",t),children:s.jsxs(le,{className:"p-8 text-center",children:[s.jsx(_t,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"冲突不存在"}),s.jsx("p",{className:"text-muted-foreground mb-4",children:"指定的冲突ID未找到或已被解决"}),s.jsx(L,{onClick:e,children:"关闭"})]})});const g=async()=>{let w;switch(c){case"local":w={type:"keep_local",reason:"用户选择保留本地版本"};break;case"remote":w={type:"keep_remote",reason:"用户选择保留远程版本"};break;case"merge":w={type:"merge",reason:"用户选择智能合并",mergedData:p()};break;case"manual":w={type:"manual",reason:"用户手动编辑",mergedData:h,manualChanges:Object.entries(h).map(([T,$])=>({field:T,value:$,source:"custom"}))};break}await n(a,w)&&e()},p=()=>N.entityType==="card"?{content:{frontContent:y(N.localVersion.content.frontContent,N.remoteVersion.content.frontContent),backContent:y(N.localVersion.content.backContent,N.remoteVersion.content.backContent)},style:N.localVersion.style}:N.localVersion,y=(w,k)=>({title:w.title.length>k.title.length?w.title:k.title,text:`${w.text}

${k.text}`,tags:[...new Set([...w.tags,...k.tags])],lastModified:new Date}),E=N.type==="card_content"?[{field:"title",label:"标题",local:N.localVersion.content.frontContent.title,remote:N.remoteVersion.content.frontContent.title},{field:"frontText",label:"正面内容",local:N.localVersion.content.frontContent.text,remote:N.remoteVersion.content.frontContent.text},{field:"backText",label:"背面内容",local:N.localVersion.content.backContent.text,remote:N.remoteVersion.content.backContent.text},{field:"tags",label:"标签",local:N.localVersion.content.frontContent.tags,remote:N.remoteVersion.content.frontContent.tags}]:[];return s.jsxs(ie,{className:_("w-full max-w-6xl max-h-[90vh] flex flex-col",t),children:[s.jsxs(Fe,{className:"pb-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(De,{className:_("h-5 w-5",Od(N.severity))}),s.jsxs("div",{children:[s.jsx(Oe,{className:"text-xl",children:_d(N)}),s.jsx("p",{className:"text-sm text-muted-foreground",children:Md(N)})]})]}),s.jsx(L,{variant:"ghost",size:"sm",onClick:e,children:"×"})]}),s.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[s.jsxs("span",{children:["类型: ",Fd(N.type)]}),s.jsxs("span",{children:["优先级: ",N.severity]}),s.jsxs("span",{children:["来源: ",N.sourceDevice]}),s.jsxs("span",{children:["时间: ",it(N.timestamp)]}),s.jsx(Z,{variant:"outline",children:N.status==="pending"?"待解决":N.status==="resolved"?"已解决":"已忽略"})]})]}),s.jsxs(le,{className:"flex-1 flex flex-col",children:[s.jsxs(Ad,{value:u,onValueChange:m,className:"flex-1 flex flex-col",children:[s.jsxs(En,{className:"grid w-full grid-cols-4",children:[s.jsx(Tt,{value:"compare",children:"对比视图"}),s.jsx(Tt,{value:"suggestions",children:"智能建议"}),s.jsx(Tt,{value:"history",children:"历史记录"}),s.jsx(Tt,{value:"manual",children:"手动合并"})]}),s.jsxs("div",{className:"flex-1 mt-4",children:[s.jsx(At,{value:"compare",className:"h-full",children:s.jsxs("div",{className:"grid grid-cols-2 gap-4 h-full",children:[s.jsxs(ie,{className:"border-green-200",children:[s.jsxs(Fe,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(Oe,{className:"text-base flex items-center gap-2",children:[s.jsx(Do,{className:"h-4 w-4 text-green-600"}),"本地版本"]}),s.jsx(Z,{variant:"outline",className:"text-green-600 border-green-200",children:"本地设备"})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["更新时间: ",it(N.localVersion.updatedAt)]})]}),s.jsx(le,{className:"p-4",children:s.jsx(Ye,{className:"h-96",children:pa(N,"local")})})]}),s.jsxs(ie,{className:"border-blue-200",children:[s.jsxs(Fe,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(Oe,{className:"text-base flex items-center gap-2",children:[s.jsx(Ro,{className:"h-4 w-4 text-blue-600"}),"远程版本"]}),s.jsx(Z,{variant:"outline",className:"text-blue-600 border-blue-200",children:N.sourceDevice})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["更新时间: ",it(N.remoteVersion.updatedAt)]})]}),s.jsx(le,{className:"p-4",children:s.jsx(Ye,{className:"h-96",children:pa(N,"remote")})})]})]})}),s.jsx(At,{value:"suggestions",className:"h-full",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(To,{className:"h-5 w-5 text-blue-500"}),s.jsx("h3",{className:"text-lg font-semibold",children:"智能解决建议"})]}),v.length>0?s.jsx("div",{className:"grid gap-3",children:v.map((w,k)=>s.jsx(ie,{className:"cursor-pointer hover:shadow-md transition-shadow",children:s.jsx(le,{className:"p-4",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(Z,{variant:w.type==="merge"?"default":"secondary",children:Pd(w.type)}),s.jsxs(Z,{variant:"outline",children:["置信度: ",Math.round(w.confidence*100),"%"]})]}),s.jsx("p",{className:"text-sm mb-2",children:w.reason}),w.preview&&s.jsxs("div",{className:"text-xs text-muted-foreground bg-gray-50 p-2 rounded",children:["预览: ",JSON.stringify(w.preview)]})]}),s.jsx(L,{variant:"outline",size:"sm",onClick:()=>x(w.type),children:"应用建议"})]})})},k))}):s.jsx(ie,{children:s.jsxs(le,{className:"p-8 text-center",children:[s.jsx(_t,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-muted-foreground",children:"暂无智能建议，请手动选择解决方案"})]})})]})}),s.jsx(At,{value:"history",className:"h-full",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Mt,{className:"h-5 w-5 text-blue-500"}),s.jsx("h3",{className:"text-lg font-semibold",children:"冲突历史"})]}),s.jsx(ie,{children:s.jsx(le,{className:"p-4",children:s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:"冲突检测"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:it(N.timestamp)})]}),s.jsx(Z,{variant:"destructive",children:"冲突"})]}),s.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:"本地版本更新"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:it(N.localVersion.updatedAt)})]}),s.jsx(Z,{variant:"outline",children:"本地"})]}),s.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:"远程版本更新"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:it(N.remoteVersion.updatedAt)})]}),s.jsx(Z,{variant:"outline",children:"远程"})]})]})})})]})}),s.jsx(At,{value:"manual",className:"h-full",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Jt,{className:"h-5 w-5 text-blue-500"}),s.jsx("h3",{className:"text-lg font-semibold",children:"手动合并"}),s.jsxs(L,{variant:"outline",size:"sm",onClick:()=>j(!C),children:[C?s.jsx(As,{className:"h-4 w-4 mr-1"}):s.jsx(Jt,{className:"h-4 w-4 mr-1"}),C?"隐藏差异":"显示差异"]})]}),s.jsx(Ye,{className:"h-96",children:s.jsx("div",{className:"space-y-4",children:E.map(w=>s.jsxs(ie,{children:[s.jsx(Fe,{className:"pb-3",children:s.jsx(Oe,{className:"text-base",children:w.label})}),s.jsxs(le,{className:"space-y-3",children:[C&&s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsxs("div",{className:"p-2 bg-green-50 rounded text-sm",children:[s.jsx("p",{className:"font-medium text-green-700 mb-1",children:"本地:"}),s.jsx("p",{children:w.local})]}),s.jsxs("div",{className:"p-2 bg-blue-50 rounded text-sm",children:[s.jsx("p",{className:"font-medium text-blue-700 mb-1",children:"远程:"}),s.jsx("p",{children:w.remote})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"text-sm font-medium mb-1 block",children:"合并结果:"}),w.field==="tags"?s.jsxs("div",{className:"flex flex-wrap gap-2",children:[Array.isArray(w.local)&&w.local.map(k=>s.jsx(Z,{variant:"secondary",children:k},k)),Array.isArray(w.remote)&&w.remote.map(k=>s.jsx(Z,{variant:"outline",children:k},k))]}):s.jsx(Dn,{value:h[w.field]||w.local,onChange:k=>f(T=>({...T,[w.field]:k.target.value})),className:"min-h-[100px]"})]})]})]},w.field))})})]})})]})]}),s.jsx("div",{className:"mt-6 pt-6 border-t",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"text-sm font-medium",children:"解决方案:"}),s.jsx("div",{className:"flex gap-2",children:["local","remote","merge","manual"].map(w=>s.jsx(L,{variant:c===w?"default":"outline",size:"sm",onClick:()=>x(w),children:Ld(w)},w))})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(L,{variant:"outline",onClick:e,children:"取消"}),s.jsx(L,{variant:"ghost",onClick:()=>o(a),children:"忽略冲突"}),s.jsx(L,{onClick:g,disabled:l,children:l?"解决中...":"应用解决方案"})]})]})})]})]})}function pa(a,e){const t=e==="local"?a.localVersion:a.remoteVersion;return a.entityType==="card"?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"正面内容"}),s.jsxs("div",{className:"bg-gray-50 p-3 rounded",children:[s.jsx("h5",{className:"font-semibold mb-2",children:t.content.frontContent.title}),s.jsx("p",{className:"text-sm text-gray-600",children:t.content.frontContent.text}),s.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:t.content.frontContent.tags.map(r=>s.jsx(Z,{variant:"secondary",className:"text-xs",children:r},r))})]})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"背面内容"}),s.jsxs("div",{className:"bg-gray-50 p-3 rounded",children:[s.jsx("h5",{className:"font-semibold mb-2",children:t.content.backContent.title}),s.jsx("p",{className:"text-sm text-gray-600",children:t.content.backContent.text}),s.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:t.content.backContent.tags.map(r=>s.jsx(Z,{variant:"secondary",className:"text-xs",children:r},r))})]})]})]}):s.jsx("pre",{className:"text-sm",children:JSON.stringify(t,null,2)})}function _d(a){switch(a.entityType){case"card":return a.localVersion.content.frontContent.title;case"folder":return a.localVersion.name;case"tag":return a.localVersion.name;default:return"未知冲突"}}function Md(a){switch(a.type){case"card_content":return"卡片内容在多设备上被同时编辑，需要选择保留的版本";case"folder_name":return"文件夹名称与远程版本不一致";case"tag_rename":return"标签重命名冲突";default:return"数据版本不一致，需要手动解决"}}function Fd(a){return{card_content:"卡片内容",card_style:"卡片样式",card_tags:"卡片标签",card_folder:"卡片文件夹",folder_name:"文件夹名称",folder_structure:"文件夹结构",tag_rename:"标签重命名",tag_delete:"标签删除",tag_color:"标签颜色"}[a]||a}function Od(a){switch(a){case"critical":return"text-red-600";case"high":return"text-orange-600";case"medium":return"text-yellow-600";case"low":return"text-blue-600";default:return"text-gray-600"}}function Pd(a){return{keep_local:"保留本地",keep_remote:"保留远程",merge:"智能合并",manual:"手动处理"}[a]||a}function Ld(a){return{local:"保留本地",remote:"保留远程",merge:"智能合并",manual:"手动合并"}[a]||a}function it(a){const t=new Date().getTime()-a.getTime(),r=Math.floor(t/6e4);return r<1?"刚刚":r<60?`${r}分钟前`:r<1440?`${Math.floor(r/60)}小时前`:`${Math.floor(r/1440)}天前`}function $d({className:a,showLabel:e=!0,showDetails:t=!0,onSync:r}){const[n,o]=d.useState({isOnline:!0,isSyncing:!1,hasConflicts:!1,pendingOperations:0,lastSyncTime:null,conflicts:[]});d.useEffect(()=>{const f=()=>{o(j=>({...j,isOnline:!0}))},C=()=>{o(j=>({...j,isOnline:!1}))};return window.addEventListener("online",f),window.addEventListener("offline",C),o(j=>({...j,isOnline:navigator.onLine})),()=>{window.removeEventListener("online",f),window.removeEventListener("offline",C)}},[]),d.useEffect(()=>{const f=async()=>{try{const g=de.getStatus();o(p=>({...p,isSyncing:g.isSyncing,hasConflicts:g.hasConflicts,pendingOperations:g.pendingOperations||0,lastSyncTime:g.lastSyncTime?new Date(g.lastSyncTime):null,conflicts:g.conflicts||[]}))}catch(g){console.error("Failed to update sync status:",g)}};f();const C=setInterval(f,3e3),j=()=>{o(g=>({...g,isSyncing:!0}))},N=()=>{o(g=>({...g,isSyncing:!1})),f()},v=()=>{o(g=>({...g,isSyncing:!1}))};return de.on("sync:start",j),de.on("sync:complete",N),de.on("sync:error",v),()=>{clearInterval(C),de.off("sync:start",j),de.off("sync:complete",N),de.off("sync:error",v)}},[]);const i=()=>n.isOnline?n.isSyncing?"text-yellow-500 animate-pulse":n.hasConflicts?"text-orange-500":"text-green-500":"text-red-500",l=()=>n.isOnline?n.isSyncing?s.jsx(Re,{className:"h-4 w-4 animate-spin"}):n.hasConflicts?s.jsx(De,{className:"h-4 w-4"}):s.jsx(ts,{className:"h-4 w-4"}):s.jsx(zs,{className:"h-4 w-4"}),u=()=>n.isOnline?n.isSyncing?"同步中...":n.hasConflicts?"有冲突":"已同步":"离线",m=f=>{if(!f)return"从未";const j=new Date().getTime()-f.getTime(),N=Math.floor(j/6e4);return N<1?"刚刚":N<60?`${N}分钟前`:N<1440?`${Math.floor(N/60)}小时前`:`${Math.floor(N/1440)}天前`},c=async()=>{if(r){r();return}try{await de.sync({type:"incremental",direction:"bidirectional"})}catch(f){console.error("Manual sync failed:",f)}},x=()=>s.jsxs("div",{className:_("flex items-center gap-2",a),children:[s.jsxs("div",{className:_("flex items-center gap-1",i()),children:[l(),e&&s.jsx("span",{className:"text-sm",children:u()})]}),n.pendingOperations>0&&s.jsx(Z,{variant:"secondary",className:"text-xs",children:n.pendingOperations}),n.conflicts.length>0&&s.jsx(Z,{variant:"destructive",className:"text-xs",children:n.conflicts.length}),s.jsx(L,{variant:"ghost",size:"sm",onClick:c,disabled:n.isSyncing||!n.isOnline,className:"h-6 w-6 p-0",children:s.jsx(Re,{className:_("h-3 w-3",n.isSyncing&&"animate-spin")})})]}),h=()=>s.jsxs(Or,{children:[s.jsx(Pr,{asChild:!0,children:s.jsxs("div",{className:_("flex items-center gap-2 cursor-pointer hover:bg-accent rounded-md p-2",a),children:[s.jsxs("div",{className:_("flex items-center gap-1",i()),children:[l(),e&&s.jsx("span",{className:"text-sm font-medium",children:u()})]}),n.pendingOperations>0&&s.jsxs(Z,{variant:"outline",className:"text-xs",children:[n.pendingOperations," 待同步"]}),n.conflicts.length>0&&s.jsxs(Z,{variant:"destructive",className:"text-xs",children:[n.conflicts.length," 冲突"]}),s.jsx("span",{className:"text-xs text-muted-foreground",children:m(n.lastSyncTime)}),s.jsx(L,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),c()},disabled:n.isSyncing||!n.isOnline,className:"h-6 w-6 p-0 ml-auto",children:s.jsx(Re,{className:_("h-3 w-3",n.isSyncing&&"animate-spin")})})]})}),s.jsx(Hs,{className:"w-96 p-0",align:"end",children:s.jsx(kn,{showDetails:!0,compact:!1})})]});return t?s.jsx(h,{}):s.jsx(x,{})}function zd(a={}){const{enableMetricsCollection:e=!0,enableUserTracking:t=!0,enableConflictMonitoring:r=!0,reportInterval:n=3e4}=a,o=d.useRef({averageRenderTime:0,averageMemoryUsage:0,averageNetworkLatency:0,conflictResolutionTime:0,userSatisfaction:0,errorRate:0,totalOperations:0,successfulOperations:0}),i=d.useRef([]),l=d.useRef([]);d.useEffect(()=>{if(!e)return;Ne.clearMetrics();const k=setInterval(()=>{u()},n);return()=>{clearInterval(k)}},[e,n]);const u=d.useCallback(()=>{const k=Ne.getMetrics();if(k.length===0)return;const T=k.slice(-10),$=m(T);o.current={averageRenderTime:$.renderTime,averageMemoryUsage:$.memoryUsage,averageNetworkLatency:$.networkLatency,conflictResolutionTime:$.conflictResolutionTime,userSatisfaction:$.userSatisfaction,errorRate:c(T),totalOperations:T.length,successfulOperations:T.filter(A=>A.errorRate<.05).length},i.current=k},[]),m=d.useCallback(k=>k.length===0?{renderTime:0,memoryUsage:0,networkLatency:0,conflictResolutionTime:0,userSatisfaction:0,errorRate:0}:{renderTime:k.reduce((T,$)=>T+$.renderTime,0)/k.length,memoryUsage:k.reduce((T,$)=>T+$.memoryUsage,0)/k.length,networkLatency:k.reduce((T,$)=>T+$.networkLatency,0)/k.length,conflictResolutionTime:k.reduce((T,$)=>T+$.conflictResolutionTime,0)/k.length,userSatisfaction:k.reduce((T,$)=>T+$.userSatisfaction,0)/k.length,errorRate:k.reduce((T,$)=>T+$.errorRate,0)/k.length},[]),c=d.useCallback(k=>k.reduce(($,A)=>$+A.errorRate,0)/k.length,[]),x=d.useCallback(()=>r?Ne.startConflictDetection():()=>{},[r]),h=d.useCallback(()=>r?Ne.startConflictResolution():()=>{},[r]),f=d.useCallback(()=>r?Ne.startBatchOperation():()=>{},[r]),C=d.useCallback((k,T,$)=>{t&&(Ne.trackUserInteraction(k,T,$),l.current.push({action:k,duration:T,success:$,timestamp:new Date}),l.current.length>100&&(l.current=l.current.slice(-100)))},[t]),j=d.useCallback((k,T)=>{t&&Ne.trackUserSatisfaction(k,T)},[t]),N=d.useCallback((k=36e5)=>Ne.generateReport(k),[]),v=d.useCallback(()=>Ne.getRealtimeMetrics(),[]),g=d.useCallback(()=>Ne.getAlerts(),[]),p=d.useCallback((k=20)=>l.current.slice(-k),[]),y=d.useCallback(()=>({...o.current}),[]),b=d.useCallback(()=>{Ne.clearMetrics(),i.current=[],l.current=[],o.current={averageRenderTime:0,averageMemoryUsage:0,averageNetworkLatency:0,conflictResolutionTime:0,userSatisfaction:0,errorRate:0,totalOperations:0,successfulOperations:0}},[]),E=d.useCallback(()=>{const k=o.current;let T=100;return k.averageRenderTime>100&&(T-=20),k.averageRenderTime>200&&(T-=30),k.averageMemoryUsage>100*1024*1024&&(T-=15),k.averageMemoryUsage>200*1024*1024&&(T-=25),k.averageNetworkLatency>1e3&&(T-=10),k.averageNetworkLatency>2e3&&(T-=20),k.errorRate>.05&&(T-=15),k.errorRate>.1&&(T-=25),k.conflictResolutionTime>5e3&&(T-=10),k.conflictResolutionTime>1e4&&(T-=20),{healthScore:Math.max(0,T),status:T>=80?"good":T>=60?"warning":"critical",issues:w(k)}},[]),w=d.useCallback(k=>{const T=[];return k.averageRenderTime>100&&T.push("渲染时间过长，可能影响用户体验"),k.averageMemoryUsage>100*1024*1024&&T.push("内存使用较高，建议检查内存泄漏"),k.averageNetworkLatency>1e3&&T.push("网络延迟较高，可能影响同步性能"),k.errorRate>.05&&T.push("错误率较高，需要关注错误处理"),k.conflictResolutionTime>5e3&&T.push("冲突解决时间过长，建议优化算法"),T},[]);return{startConflictDetection:x,startConflictResolution:h,startBatchOperation:f,trackUserInteraction:C,trackUserSatisfaction:j,getPerformanceReport:N,getRealtimeMetrics:v,getPerformanceAlerts:g,getUserActionHistory:p,getPerformanceStats:y,clearPerformanceData:b,getPerformanceHealth:E,stats:o.current,isMonitoring:e}}function Bd({className:a,showDetails:e=!0,compact:t=!1,autoRefresh:r=!0}){const[n,o]=d.useState(!1),[i,l]=d.useState("overview"),[u,m]=d.useState(0),{stats:c,getRealtimeMetrics:x,getPerformanceAlerts:h,getUserActionHistory:f,getPerformanceHealth:C,getPerformanceReport:j,isMonitoring:N}=zd({enableMetricsCollection:!0,enableUserTracking:!0,enableConflictMonitoring:!0,reportInterval:1e4}),[v,g]=d.useState({}),[p,y]=d.useState([]),[b,E]=d.useState([]),[w,k]=d.useState(null),T=()=>{g(x()),y(h()),E(f(20)),k(C()),m(W=>W+1)};d.useEffect(()=>{if(!r||!n)return;T();const W=setInterval(T,5e3);return()=>clearInterval(W)},[r,n,u]),d.useEffect(()=>{n&&T()},[n]);const $=W=>{if(W===0)return"0 B";const ee=1024,ae=["B","KB","MB","GB"],re=Math.floor(Math.log(W)/Math.log(ee));return`${parseFloat((W/Math.pow(ee,re)).toFixed(2))} ${ae[re]}`},A=W=>W<1e3?`${W.toFixed(0)}ms`:W<6e4?`${(W/1e3).toFixed(1)}s`:`${(W/6e4).toFixed(1)}min`,G=W=>{switch(W){case"good":return"text-green-500";case"warning":return"text-yellow-500";case"critical":return"text-red-500";default:return"text-gray-500"}},te=W=>{switch(W){case"good":return s.jsx(Ke,{className:"h-4 w-4 text-green-500"});case"warning":return s.jsx(De,{className:"h-4 w-4 text-yellow-500"});case"critical":return s.jsx(_t,{className:"h-4 w-4 text-red-500"});default:return s.jsx(Zs,{className:"h-4 w-4 text-gray-500"})}};return t?s.jsxs("div",{className:_("flex items-center gap-2",a),children:[s.jsxs("div",{className:_("flex items-center gap-1",G(w?.status||"unknown")),children:[te(w?.status||"unknown"),s.jsxs("span",{className:"text-sm font-medium",children:[w?.healthScore||0,"/100"]})]}),p.length>0&&s.jsx(Z,{variant:"destructive",className:"text-xs",children:p.length}),s.jsx(L,{variant:"ghost",size:"sm",onClick:()=>o(!n),children:s.jsx(Ao,{className:"h-4 w-4"})})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:_("flex items-center gap-2 cursor-pointer",a),onClick:()=>o(!n),children:[s.jsxs("div",{className:_("flex items-center gap-1",G(w?.status||"unknown")),children:[te(w?.status||"unknown"),s.jsxs("span",{className:"text-sm font-medium",children:["性能: ",w?.healthScore||0,"/100"]})]}),p.length>0&&s.jsxs(Z,{variant:"destructive",className:"text-xs",children:[p.length," 警报"]}),s.jsx(L,{variant:"ghost",size:"sm",children:n?"隐藏":"显示"})]}),n&&s.jsxs(ie,{className:"w-full max-w-4xl max-h-[80vh]",children:[s.jsxs(Fe,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(Oe,{className:"text-lg flex items-center gap-2",children:[s.jsx(Zs,{className:"h-5 w-5"}),"性能监控",s.jsx(Z,{variant:N?"default":"secondary",children:N?"监控中":"已停止"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(L,{variant:"outline",size:"sm",onClick:T,children:[s.jsx(Re,{className:"h-4 w-4 mr-2"}),"刷新"]}),s.jsxs(L,{variant:"outline",size:"sm",onClick:()=>{const W=j();console.log("Performance Report:",W)},children:[s.jsx(gt,{className:"h-4 w-4 mr-2"}),"报告"]}),s.jsx(L,{variant:"ghost",size:"sm",onClick:()=>o(!1),children:"×"})]})]}),w&&s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"健康状态:"}),s.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[te(w.status),s.jsxs("span",{className:_("font-medium",G(w.status)),children:[w.healthScore,"/100 (",w.status,")"]})]})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"渲染时间:"}),s.jsx("span",{className:"ml-2 font-medium",children:A(v.renderTime||0)})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"内存使用:"}),s.jsx("span",{className:"ml-2 font-medium",children:$(v.memoryUsage||0)})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"网络延迟:"}),s.jsxs("span",{className:"ml-2 font-medium",children:[v.networkLatency||0,"ms"]})]})]})]}),s.jsxs(le,{children:[s.jsx("div",{className:"flex gap-2 mb-4",children:["overview","metrics","alerts","actions"].map(W=>s.jsxs(L,{variant:i===W?"default":"outline",size:"sm",onClick:()=>l(W),children:[W==="overview"&&"概览",W==="metrics"&&"指标",W==="alerts"&&"警报",W==="actions"&&"用户行为"]},W))}),s.jsxs(Ye,{className:"h-96",children:[i==="overview"&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(br,{className:"h-4 w-4 text-yellow-500"}),s.jsx("span",{className:"font-medium",children:"渲染性能"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"平均渲染时间:"}),s.jsx("span",{children:A(c.averageRenderTime)})]}),s.jsx(He,{value:Math.min(100,c.averageRenderTime/100*100),className:"h-2"})]})]})}),s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(vr,{className:"h-4 w-4 text-blue-500"}),s.jsx("span",{className:"font-medium",children:"内存使用"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"内存使用:"}),s.jsx("span",{children:$(c.averageMemoryUsage)})]}),s.jsx(He,{value:Math.min(100,c.averageMemoryUsage/(100*1024*1024)*100),className:"h-2"})]})]})}),s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(ts,{className:"h-4 w-4 text-green-500"}),s.jsx("span",{className:"font-medium",children:"网络性能"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"平均延迟:"}),s.jsxs("span",{children:[c.averageNetworkLatency,"ms"]})]}),s.jsx(He,{value:Math.min(100,c.averageNetworkLatency/1e3*100),className:"h-2"})]})]})}),s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(Io,{className:"h-4 w-4 text-purple-500"}),s.jsx("span",{className:"font-medium",children:"用户体验"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"满意度:"}),s.jsxs("span",{children:[c.userSatisfaction.toFixed(1),"%"]})]}),s.jsx(He,{value:c.userSatisfaction,className:"h-2"})]})]})})]}),w?.issues&&w.issues.length>0&&s.jsx(ie,{children:s.jsxs(le,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(De,{className:"h-4 w-4 text-orange-500"}),s.jsx("span",{className:"font-medium",children:"性能问题"})]}),s.jsx("div",{className:"space-y-1 text-sm",children:w.issues.map((W,ee)=>s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx("div",{className:"w-1 h-1 bg-orange-500 rounded-full mt-2 flex-shrink-0"}),s.jsx("span",{children:W})]},ee))})]})})]}),i==="metrics"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("h4",{className:"font-medium",children:"实时性能指标"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"渲染时间:"}),s.jsx("span",{children:A(v.renderTime||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"首次绘制:"}),s.jsx("span",{children:A(v.firstPaint||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"内容绘制:"}),s.jsx("span",{children:A(v.firstContentfulPaint||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"最大内容绘制:"}),s.jsx("span",{children:A(v.largestContentfulPaint||0)})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"内存使用:"}),s.jsx("span",{children:$(v.memoryUsage||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"网络延迟:"}),s.jsxs("span",{children:[v.networkLatency||0,"ms"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"冲突检测时间:"}),s.jsx("span",{children:A(v.conflictDetectionTime||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"冲突解决时间:"}),s.jsx("span",{children:A(v.conflictResolutionTime||0)})]})]})]})]}),i==="alerts"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("h4",{className:"font-medium",children:"性能警报"}),p.length===0?s.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"暂无性能警报"}):s.jsx("div",{className:"space-y-2",children:p.map((W,ee)=>s.jsx(ie,{className:"border-l-4 border-l-red-500",children:s.jsxs(le,{className:"p-3",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(De,{className:"h-4 w-4 text-red-500"}),s.jsx("span",{className:"font-medium text-sm",children:W.type}),s.jsx(Z,{variant:"outline",className:"text-xs",children:W.severity})]}),s.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(W.timestamp).toLocaleTimeString()})]}),s.jsx("p",{className:"text-sm mb-2",children:W.message}),W.suggestions&&W.suggestions.length>0&&s.jsxs("div",{className:"space-y-1",children:[s.jsx("span",{className:"text-xs font-medium",children:"建议:"}),W.suggestions.map((ae,re)=>s.jsxs("div",{className:"text-xs text-muted-foreground",children:["• ",ae]},re))]})]})},ee))})]}),i==="actions"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("h4",{className:"font-medium",children:"用户行为历史"}),b.length===0?s.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"暂无用户行为记录"}):s.jsx("div",{className:"space-y-2",children:b.map((W,ee)=>s.jsx(ie,{children:s.jsx(le,{className:"p-3",children:s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-medium text-sm",children:W.action}),s.jsx(Z,{variant:W.success?"default":"destructive",className:"text-xs",children:W.success?"成功":"失败"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[s.jsx(Mt,{className:"h-3 w-3"}),s.jsx("span",{children:new Date(W.timestamp).toLocaleTimeString()}),s.jsxs("span",{children:["(",A(W.duration),")"]})]})]})})},ee))})]})]})]})]})]})}function Ud({className:a}){const[e,t]=d.useState({user:null,session:null,loading:!1,error:null}),{openModal:r}=Er(),{cards:n,filter:o,setFilter:i,viewSettings:l,setViewSettings:u,dispatch:m,getAllTags:c,updateTagsInAllCards:x,getCardsWithTag:h}=hi(),{folderTree:f,selectedFolderId:C,setSelectedFolderId:j,dispatch:N,getFolderById:v,folders:g}=Sr(),{tags:p,popularTags:y,renameTag:b,deleteTagByName:E,getAllTagNames:w}=Nr(),{toast:k}=Yc(),[T,$]=d.useState(!1),[A,G]=d.useState(!1),[te,W]=d.useState({gap:16,showLayoutControls:!1}),{stats:ee,selectedConflict:ae,setSelectedConflict:re}=is(),[fe,z]=d.useState(!1),[Y,M]=d.useState(!1);d.useEffect(()=>Ee.onAuthStateChange(t),[]);const[F,I]=d.useState(!1),[H,q]=d.useState(!1),[B,R]=d.useState(null),[D,S]=d.useState(null),[U,J]=d.useState(),[ue,me]=d.useState(!1),[he,pe]=d.useState(!1),[$t,Ct]=d.useState(""),[je,jt]=d.useState(null),{isDownloading:zt,showPreview:Qe,previewData:St,captureScreenshot:Le,confirmDownload:ls,cancelPreview:cs}=zc({onSuccess:O=>{k({title:"Screenshot saved!",description:`${O}.png has been downloaded successfully.`})},onError:O=>{k({title:"Screenshot failed",description:O.message,variant:"destructive"})}}),we=O=>{m({type:"FLIP_CARD",payload:O})},Ve=(O,K)=>{m({type:"UPDATE_CARD",payload:{id:O,updates:K}})},ds=async O=>{const K=n.find(se=>se.id===O);if(K){const se=K.isFlipped?K.backContent:K.frontContent,xe=pl(se.title,se.text);await xl(xe)?console.log("Card content copied to clipboard"):console.error("Failed to copy card content")}},us=async O=>{const K=n.find(ge=>ge.id===O);if(!K)return;const se=document.querySelector(`[data-card-id="${O}"]`);if(!se){k({title:"Screenshot failed",description:"Could not find card element. Please try again.",variant:"destructive"});return}const ye=(K.isFlipped?K.backContent:K.frontContent).title||"Untitled Card";await Le(se,ye)},rt=O=>{console.log("Share card:",O)},ms=O=>{m({type:"DELETE_CARD",payload:O})},Bt=(O,K)=>{const se=n.find(ge=>ge.id===O);if(!se)return;const xe=se.folderId;if(m({type:"UPDATE_CARD",payload:{id:O,updates:{folderId:K||void 0}}}),xe){const ge=v(xe);ge&&N({type:"UPDATE_FOLDER",payload:{id:xe,updates:{cardIds:ge.cardIds.filter(Rn=>Rn!==O)}}})}if(K){const ge=v(K);ge&&N({type:"UPDATE_FOLDER",payload:{id:K,updates:{cardIds:[...ge.cardIds,O]}}})}const ye=K?v(K)?.name:"Root";k({title:"Card moved",description:`Card has been moved to "${ye}".`})},Ze=()=>{m({type:"CREATE_CARD",payload:{frontContent:{title:"New Card",text:"Click to edit this card...",images:[],tags:[],lastModified:new Date},backContent:{title:"Back Side",text:"Add additional content here...",images:[],tags:[],lastModified:new Date},style:{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:!1,folderId:C||void 0}})},$e=()=>{J(void 0),R(null),I(!0)},Nt=O=>{J(O),R(null),I(!0)},ze=O=>{const K=v(O);K&&(R({id:O,name:K.name,color:K.color,icon:K.icon||"Folder"}),J(void 0),I(!0))},Ut=O=>{const K=v(O);if(K){const se=g.filter(xe=>xe.parentId===O);S({id:O,name:K.name,cardCount:K.cardIds.length,hasSubfolders:se.length>0,subfolderCount:se.length}),q(!0)}},fs=O=>{B?(N({type:"UPDATE_FOLDER",payload:{id:B.id,updates:{name:O.name,color:O.color,icon:O.icon}}}),k({title:"Folder updated",description:`"${O.name}" has been updated successfully.`})):(N({type:"CREATE_FOLDER",payload:{name:O.name,color:O.color,icon:O.icon,cardIds:[],parentId:O.parentId,isExpanded:!0}}),k({title:"Folder created",description:`"${O.name}" has been created successfully.`}))},Vt=()=>{D&&(N({type:"DELETE_FOLDER",payload:D.id,onDeleteCards:O=>{O.forEach(K=>{m({type:"DELETE_CARD",payload:K})})}}),k({title:"Folder deleted",description:`"${D.name}" and ${D.cardCount} cards have been deleted.`}),C===D.id&&nt(null))},Wt=O=>{const K=o.tags.includes(O);i({...o,tags:K?o.tags.filter(se=>se!==O):[...o.tags,O]})},nt=O=>{j(O),i({...o,folderId:O||void 0})},kt=O=>{Ct(O),me(!0)},_e=O=>{const K=h(O);jt({name:O,cardCount:K.length}),pe(!0)},gs=(O,K)=>{b(O,K)?(x(O,K),k({title:"Tag renamed",description:`"${O}" has been renamed to "${K}".`}),me(!1),Ct("")):k({title:"Rename failed",description:"A tag with this name already exists.",variant:"destructive"})},Q=()=>{je&&E(je.name)&&(x(je.name),o.tags.includes(je.name)&&i({...o,tags:o.tags.filter(K=>K!==je.name)}),k({title:"Tag deleted",description:`"${je.name}" has been removed from ${je.cardCount} cards.`}),pe(!1),jt(null))},ne=(O,K=0)=>O.map(se=>s.jsxs("div",{style:{marginLeft:K*16},children:[s.jsx(ga,{folderId:se.id,folderName:se.name,onRename:ze,onDelete:Ut,onCreateSubfolder:Nt,children:s.jsxs(L,{variant:C===se.id?"secondary":"ghost",className:"w-full justify-start text-sm mb-1",onClick:()=>nt(se.id),children:[s.jsx(Ge,{className:"h-4 w-4 mr-2",style:{color:se.color}}),se.name,s.jsx(Z,{variant:"secondary",className:"ml-auto",children:se.cardIds.length})]})}),se.children&&se.children.length>0&&se.isExpanded&&s.jsx("div",{className:"ml-4",children:ne(se.children,K+1)})]},se.id)),oe=O=>O.map(K=>s.jsxs("div",{children:[s.jsx(ga,{folderId:K.id,folderName:K.name,onRename:ze,onDelete:Ut,onCreateSubfolder:Nt,children:s.jsx(L,{variant:C===K.id?"secondary":"ghost",className:"w-full h-10 p-0 mb-1",onClick:()=>nt(K.id),title:K.name,children:s.jsx(Ge,{className:"h-4 w-4",style:{color:K.color}})})}),K.children&&K.children.length>0&&K.isExpanded&&s.jsx("div",{children:oe(K.children)})]},K.id));return s.jsx(dl,{children:s.jsxs("div",{className:_("min-h-screen bg-background",a),children:[s.jsx("header",{className:"sticky top-0 z-40 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:s.jsxs("div",{className:"container flex h-16 items-center justify-between px-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"h-8 w-8 rounded-lg bg-gradient-to-br from-violet-500 to-pink-500 flex items-center justify-center",children:s.jsx("span",{className:"text-white font-bold text-sm",children:"CA"})}),s.jsxs("h1",{className:"text-xl font-bold",children:[s.jsx("span",{className:"text-violet-600",children:"Card"}),s.jsx("span",{className:"text-pink-500",children:"All"})]})]}),s.jsx("div",{className:"absolute left-1/2 transform -translate-x-1/2 hidden md:block",children:s.jsxs("div",{className:"relative",children:[s.jsx(ft,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{placeholder:"Search cards...",value:o.searchTerm,onChange:O=>i({...o,searchTerm:O.target.value}),className:"pl-10 rounded-full w-80"})]})}),s.jsx("div",{className:"md:hidden absolute left-1/2 transform -translate-x-1/2",children:s.jsxs("div",{className:"relative",children:[s.jsx(ft,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{placeholder:"Search...",value:o.searchTerm,onChange:O=>i({...o,searchTerm:O.target.value}),className:"pl-10 rounded-full w-60"})]})}),s.jsxs("div",{className:"flex items-center gap-2",children:[ee.pendingConflicts>0&&s.jsxs(L,{variant:"ghost",size:"sm",onClick:()=>z(!0),className:"relative text-orange-600 hover:bg-orange-50",children:[s.jsx(De,{className:"h-4 w-4"}),ee.pendingConflicts>0&&s.jsx(Z,{variant:"destructive",className:"absolute -top-2 -right-2 h-5 w-5 flex items-center justify-center p-0 text-xs",children:ee.pendingConflicts>99?"99+":ee.pendingConflicts}),s.jsx("span",{className:"sr-only",children:"Conflict Notifications"})]}),s.jsx($d,{showDetails:!0,showLabel:!1,className:"mr-1"}),s.jsx(Bd,{compact:!0,autoRefresh:!0}),s.jsxs(Or,{children:[s.jsx(Pr,{asChild:!0,children:s.jsx(L,{variant:"ghost",size:"sm",children:s.jsx(_o,{className:"h-4 w-4"})})}),s.jsx(Hs,{className:"w-80",align:"end",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx("h4",{className:"font-medium",children:"Layout Settings"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Customize the masonry layout appearance"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs(Ce,{children:["Gap Size: ",te.gap,"px"]}),s.jsx(Fr,{value:[te.gap],onValueChange:([O])=>W(K=>({...K,gap:O})),max:32,min:8,step:4,className:"w-full"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{children:"Card Size"}),s.jsx("div",{className:"flex gap-2",children:["small","medium","large"].map(O=>s.jsx(L,{variant:l.cardSize===O?"default":"outline",size:"sm",onClick:()=>u(K=>({...K,cardSize:O})),children:O.charAt(0).toUpperCase()+O.slice(1)},O))})]})]})})]}),s.jsxs(L,{onClick:Ze,variant:"ghost",size:"sm",className:"text-black font-bold hover:bg-gray-100 rounded-full w-10 h-10 p-0 flex items-center justify-center",children:[s.jsx(Gt,{className:"h-6 w-6"}),s.jsx("span",{className:"sr-only",children:"Add Card"})]}),s.jsx(L,{variant:"ghost",size:"sm",onClick:r,className:"flex items-center gap-2",children:e.user?s.jsxs(s.Fragment,{children:[s.jsx(on,{user:e.user,size:"sm",onClick:r,showHoverEffect:!0}),s.jsx("span",{className:"hidden sm:inline text-sm",children:e.user.username||"User"})]}):s.jsxs(s.Fragment,{children:[s.jsx(Mo,{className:"h-4 w-4"}),s.jsx("span",{className:"hidden sm:inline text-sm",children:"Login"})]})})]})]})}),s.jsxs("main",{className:"flex h-[calc(100vh-4rem)]",children:[s.jsx("div",{className:"absolute top-16 left-0 right-0 z-30 bg-background border-b",children:s.jsx(Cd,{onOpenConflictPanel:()=>z(!0)})}),s.jsxs("aside",{className:_("border-r transition-all duration-300 ease-in-out flex flex-col",A?"w-16":"w-72"),children:[s.jsx("div",{className:"p-3 flex items-center justify-end",children:s.jsx(L,{variant:"ghost",size:"sm",onClick:()=>G(!A),className:"h-8 w-8 p-0",children:A?s.jsx(es,{className:"h-4 w-4"}):s.jsx(Fo,{className:"h-4 w-4"})})}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsxs("div",{className:"p-3 space-y-4",children:[!A&&s.jsxs("div",{children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs(L,{className:"w-full justify-start",onClick:Ze,children:[s.jsx(Gt,{className:"h-4 w-4 mr-2"}),"New Card"]}),s.jsxs(L,{variant:"outline",className:"w-full justify-start",onClick:$e,children:[s.jsx(Ts,{className:"h-4 w-4 mr-2"}),"New Folder"]})]}),s.jsx(ut,{className:"my-4"})]}),A&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(L,{variant:"ghost",size:"sm",className:"w-full h-10 p-0",onClick:Ze,title:"New Card",children:s.jsx(Gt,{className:"h-4 w-4"})}),s.jsx(L,{variant:"ghost",size:"sm",className:"w-full h-10 p-0",onClick:$e,title:"New Folder",children:s.jsx(Ts,{className:"h-4 w-4"})}),s.jsx(ut,{className:"my-4"})]}),s.jsxs("div",{children:[!A&&s.jsx("h3",{className:"text-sm font-medium mb-3",children:"Folders"}),s.jsxs("div",{className:"space-y-1",children:[s.jsxs(L,{variant:C?"ghost":"secondary",className:_("w-full text-sm",A?"h-10 p-0":"justify-start"),onClick:()=>nt(null),title:A?"All Cards":void 0,children:[s.jsx(Ge,{className:"h-4 w-4"}),!A&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"ml-2",children:"All Cards"}),s.jsx(Z,{variant:"secondary",className:"ml-auto",children:n.length})]})]}),A?oe(f):ne(f)]})]}),s.jsx(ut,{}),s.jsxs("div",{children:[!A&&s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-medium",children:"Tags"}),o.tags.length>0&&s.jsx(L,{variant:"ghost",size:"sm",onClick:()=>i({...o,tags:[]}),className:"h-6 px-2 text-xs",children:"Clear"})]}),s.jsx("div",{className:"space-y-1",children:y(A?5:10).map(O=>s.jsx(md,{tagName:O.name,onRename:kt,onDelete:_e,disabled:A,children:s.jsxs(L,{variant:o.tags.includes(O.name)?"secondary":"ghost",className:_("w-full text-sm",A?"h-10 p-0":"justify-start"),onClick:()=>Wt(O.name),title:A?`${O.name} (Right-click to expand sidebar for tag management)`:O.name,children:[s.jsx(yr,{className:"h-3 w-3",style:{color:O.color}}),!A&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"ml-2",children:O.name}),s.jsx(Z,{variant:"secondary",className:"ml-auto",children:O.count})]})]})},O.id))})]}),!A&&(o.tags.length>0||o.searchTerm)&&s.jsxs(s.Fragment,{children:[s.jsx(ut,{}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-sm font-medium mb-3",children:"Active Filters"}),s.jsxs("div",{className:"space-y-2",children:[o.searchTerm&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ft,{className:"h-3 w-3"}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:['"',o.searchTerm,'"']})]}),o.tags.map(O=>s.jsx(Z,{variant:"secondary",className:"mr-1",children:O},O))]})]})]})]})})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx("div",{className:"p-4",children:s.jsx(gl,{cards:n,onCardFlip:we,onCardUpdate:Ve,onCardCopy:ds,onCardScreenshot:us,onCardShare:rt,onCardDelete:ms,onMoveToFolder:Bt,cardSize:l.cardSize==="small"?"sm":l.cardSize==="large"?"lg":"md",enableVirtualization:n.length>20,gap:te.gap,overscan:3})})})]}),s.jsx(Bc,{isOpen:Qe,onClose:cs,onConfirm:ls,previewUrl:St?.previewUrl||null,fileName:St?.fileName||"",isDownloading:zt}),s.jsx(ld,{isOpen:F,onClose:()=>{I(!1),R(null),J(void 0)},onConfirm:fs,parentId:U,initialData:d.useMemo(()=>B?{name:B.name,color:B.color,icon:B.icon}:void 0,[B]),mode:B?"edit":"create"}),s.jsx(ud,{isOpen:H,onClose:()=>{q(!1),S(null)},onConfirm:Vt,folderName:D?.name||"",cardCount:D?.cardCount||0,hasSubfolders:D?.hasSubfolders||!1,subfolderCount:D?.subfolderCount||0}),s.jsx(fd,{isOpen:ue,onClose:()=>{me(!1),Ct("")},onConfirm:gs,tagName:$t,existingTags:w()}),s.jsx(gd,{isOpen:he,onClose:()=>{pe(!1),jt(null)},onConfirm:Q,tagName:je?.name||"",cardCount:je?.cardCount||0}),s.jsx(wd,{}),s.jsx(kd,{isOpen:fe,onClose:()=>z(!1)}),ae&&s.jsx(Id,{conflictId:ae,onClose:()=>{M(!1),re(null)}})]})})}const Vd={theme:"system",setTheme:()=>null},Wd=d.createContext(Vd);function Hd({children:a,defaultTheme:e="system",storageKey:t="vite-ui-theme",...r}){const[n,o]=d.useState(()=>localStorage.getItem(t)||e);d.useEffect(()=>{const l=window.document.documentElement;if(l.classList.remove("light","dark"),n==="system"){const u=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";l.classList.add(u);return}l.classList.add(n)},[n]);const i={theme:n,setTheme:l=>{localStorage.setItem(t,l),o(l)}};return s.jsx(Wd.Provider,{...r,value:i,children:a})}var Gd=a=>{switch(a){case"success":return qd;case"info":return Xd;case"warning":return Jd;case"error":return Qd;default:return null}},Kd=Array(12).fill(0),Yd=({visible:a,className:e})=>V.createElement("div",{className:["sonner-loading-wrapper",e].filter(Boolean).join(" "),"data-visible":a},V.createElement("div",{className:"sonner-spinner"},Kd.map((t,r)=>V.createElement("div",{className:"sonner-loading-bar",key:`spinner-bar-${r}`})))),qd=V.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",height:"20",width:"20"},V.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z",clipRule:"evenodd"})),Jd=V.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",height:"20",width:"20"},V.createElement("path",{fillRule:"evenodd",d:"M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z",clipRule:"evenodd"})),Xd=V.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",height:"20",width:"20"},V.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z",clipRule:"evenodd"})),Qd=V.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",height:"20",width:"20"},V.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})),Zd=V.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"},V.createElement("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),V.createElement("line",{x1:"6",y1:"6",x2:"18",y2:"18"})),eu=()=>{let[a,e]=V.useState(document.hidden);return V.useEffect(()=>{let t=()=>{e(document.hidden)};return document.addEventListener("visibilitychange",t),()=>window.removeEventListener("visibilitychange",t)},[]),a},Os=1,tu=class{constructor(){this.subscribe=a=>(this.subscribers.push(a),()=>{let e=this.subscribers.indexOf(a);this.subscribers.splice(e,1)}),this.publish=a=>{this.subscribers.forEach(e=>e(a))},this.addToast=a=>{this.publish(a),this.toasts=[...this.toasts,a]},this.create=a=>{var e;let{message:t,...r}=a,n=typeof a?.id=="number"||((e=a.id)==null?void 0:e.length)>0?a.id:Os++,o=this.toasts.find(l=>l.id===n),i=a.dismissible===void 0?!0:a.dismissible;return this.dismissedToasts.has(n)&&this.dismissedToasts.delete(n),o?this.toasts=this.toasts.map(l=>l.id===n?(this.publish({...l,...a,id:n,title:t}),{...l,...a,id:n,dismissible:i,title:t}):l):this.addToast({title:t,...r,dismissible:i,id:n}),n},this.dismiss=a=>(this.dismissedToasts.add(a),a||this.toasts.forEach(e=>{this.subscribers.forEach(t=>t({id:e.id,dismiss:!0}))}),this.subscribers.forEach(e=>e({id:a,dismiss:!0})),a),this.message=(a,e)=>this.create({...e,message:a}),this.error=(a,e)=>this.create({...e,message:a,type:"error"}),this.success=(a,e)=>this.create({...e,type:"success",message:a}),this.info=(a,e)=>this.create({...e,type:"info",message:a}),this.warning=(a,e)=>this.create({...e,type:"warning",message:a}),this.loading=(a,e)=>this.create({...e,type:"loading",message:a}),this.promise=(a,e)=>{if(!e)return;let t;e.loading!==void 0&&(t=this.create({...e,promise:a,type:"loading",message:e.loading,description:typeof e.description!="function"?e.description:void 0}));let r=a instanceof Promise?a:a(),n=t!==void 0,o,i=r.then(async u=>{if(o=["resolve",u],V.isValidElement(u))n=!1,this.create({id:t,type:"default",message:u});else if(au(u)&&!u.ok){n=!1;let m=typeof e.error=="function"?await e.error(`HTTP error! status: ${u.status}`):e.error,c=typeof e.description=="function"?await e.description(`HTTP error! status: ${u.status}`):e.description;this.create({id:t,type:"error",message:m,description:c})}else if(e.success!==void 0){n=!1;let m=typeof e.success=="function"?await e.success(u):e.success,c=typeof e.description=="function"?await e.description(u):e.description;this.create({id:t,type:"success",message:m,description:c})}}).catch(async u=>{if(o=["reject",u],e.error!==void 0){n=!1;let m=typeof e.error=="function"?await e.error(u):e.error,c=typeof e.description=="function"?await e.description(u):e.description;this.create({id:t,type:"error",message:m,description:c})}}).finally(()=>{var u;n&&(this.dismiss(t),t=void 0),(u=e.finally)==null||u.call(e)}),l=()=>new Promise((u,m)=>i.then(()=>o[0]==="reject"?m(o[1]):u(o[1])).catch(m));return typeof t!="string"&&typeof t!="number"?{unwrap:l}:Object.assign(t,{unwrap:l})},this.custom=(a,e)=>{let t=e?.id||Os++;return this.create({jsx:a(t),id:t,...e}),t},this.getActiveToasts=()=>this.toasts.filter(a=>!this.dismissedToasts.has(a.id)),this.subscribers=[],this.toasts=[],this.dismissedToasts=new Set}},be=new tu,su=(a,e)=>{let t=e?.id||Os++;return be.addToast({title:a,...e,id:t}),t},au=a=>a&&typeof a=="object"&&"ok"in a&&typeof a.ok=="boolean"&&"status"in a&&typeof a.status=="number",ru=su,nu=()=>be.toasts,ou=()=>be.getActiveToasts();Object.assign(ru,{success:be.success,info:be.info,warning:be.warning,error:be.error,custom:be.custom,message:be.message,promise:be.promise,dismiss:be.dismiss,loading:be.loading},{getHistory:nu,getToasts:ou});function iu(a,{insertAt:e}={}){if(typeof document>"u")return;let t=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css",e==="top"&&t.firstChild?t.insertBefore(r,t.firstChild):t.appendChild(r),r.styleSheet?r.styleSheet.cssText=a:r.appendChild(document.createTextNode(a))}iu(`:where(html[dir="ltr"]),:where([data-sonner-toaster][dir="ltr"]){--toast-icon-margin-start: -3px;--toast-icon-margin-end: 4px;--toast-svg-margin-start: -1px;--toast-svg-margin-end: 0px;--toast-button-margin-start: auto;--toast-button-margin-end: 0;--toast-close-button-start: 0;--toast-close-button-end: unset;--toast-close-button-transform: translate(-35%, -35%)}:where(html[dir="rtl"]),:where([data-sonner-toaster][dir="rtl"]){--toast-icon-margin-start: 4px;--toast-icon-margin-end: -3px;--toast-svg-margin-start: 0px;--toast-svg-margin-end: -1px;--toast-button-margin-start: 0;--toast-button-margin-end: auto;--toast-close-button-start: unset;--toast-close-button-end: 0;--toast-close-button-transform: translate(35%, -35%)}:where([data-sonner-toaster]){position:fixed;width:var(--width);font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;--gray1: hsl(0, 0%, 99%);--gray2: hsl(0, 0%, 97.3%);--gray3: hsl(0, 0%, 95.1%);--gray4: hsl(0, 0%, 93%);--gray5: hsl(0, 0%, 90.9%);--gray6: hsl(0, 0%, 88.7%);--gray7: hsl(0, 0%, 85.8%);--gray8: hsl(0, 0%, 78%);--gray9: hsl(0, 0%, 56.1%);--gray10: hsl(0, 0%, 52.3%);--gray11: hsl(0, 0%, 43.5%);--gray12: hsl(0, 0%, 9%);--border-radius: 8px;box-sizing:border-box;padding:0;margin:0;list-style:none;outline:none;z-index:999999999;transition:transform .4s ease}:where([data-sonner-toaster][data-lifted="true"]){transform:translateY(-10px)}@media (hover: none) and (pointer: coarse){:where([data-sonner-toaster][data-lifted="true"]){transform:none}}:where([data-sonner-toaster][data-x-position="right"]){right:var(--offset-right)}:where([data-sonner-toaster][data-x-position="left"]){left:var(--offset-left)}:where([data-sonner-toaster][data-x-position="center"]){left:50%;transform:translate(-50%)}:where([data-sonner-toaster][data-y-position="top"]){top:var(--offset-top)}:where([data-sonner-toaster][data-y-position="bottom"]){bottom:var(--offset-bottom)}:where([data-sonner-toast]){--y: translateY(100%);--lift-amount: calc(var(--lift) * var(--gap));z-index:var(--z-index);position:absolute;opacity:0;transform:var(--y);filter:blur(0);touch-action:none;transition:transform .4s,opacity .4s,height .4s,box-shadow .2s;box-sizing:border-box;outline:none;overflow-wrap:anywhere}:where([data-sonner-toast][data-styled="true"]){padding:16px;background:var(--normal-bg);border:1px solid var(--normal-border);color:var(--normal-text);border-radius:var(--border-radius);box-shadow:0 4px 12px #0000001a;width:var(--width);font-size:13px;display:flex;align-items:center;gap:6px}:where([data-sonner-toast]:focus-visible){box-shadow:0 4px 12px #0000001a,0 0 0 2px #0003}:where([data-sonner-toast][data-y-position="top"]){top:0;--y: translateY(-100%);--lift: 1;--lift-amount: calc(1 * var(--gap))}:where([data-sonner-toast][data-y-position="bottom"]){bottom:0;--y: translateY(100%);--lift: -1;--lift-amount: calc(var(--lift) * var(--gap))}:where([data-sonner-toast]) :where([data-description]){font-weight:400;line-height:1.4;color:inherit}:where([data-sonner-toast]) :where([data-title]){font-weight:500;line-height:1.5;color:inherit}:where([data-sonner-toast]) :where([data-icon]){display:flex;height:16px;width:16px;position:relative;justify-content:flex-start;align-items:center;flex-shrink:0;margin-left:var(--toast-icon-margin-start);margin-right:var(--toast-icon-margin-end)}:where([data-sonner-toast][data-promise="true"]) :where([data-icon])>svg{opacity:0;transform:scale(.8);transform-origin:center;animation:sonner-fade-in .3s ease forwards}:where([data-sonner-toast]) :where([data-icon])>*{flex-shrink:0}:where([data-sonner-toast]) :where([data-icon]) svg{margin-left:var(--toast-svg-margin-start);margin-right:var(--toast-svg-margin-end)}:where([data-sonner-toast]) :where([data-content]){display:flex;flex-direction:column;gap:2px}[data-sonner-toast][data-styled=true] [data-button]{border-radius:4px;padding-left:8px;padding-right:8px;height:24px;font-size:12px;color:var(--normal-bg);background:var(--normal-text);margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end);border:none;cursor:pointer;outline:none;display:flex;align-items:center;flex-shrink:0;transition:opacity .4s,box-shadow .2s}:where([data-sonner-toast]) :where([data-button]):focus-visible{box-shadow:0 0 0 2px #0006}:where([data-sonner-toast]) :where([data-button]):first-of-type{margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end)}:where([data-sonner-toast]) :where([data-cancel]){color:var(--normal-text);background:rgba(0,0,0,.08)}:where([data-sonner-toast][data-theme="dark"]) :where([data-cancel]){background:rgba(255,255,255,.3)}:where([data-sonner-toast]) :where([data-close-button]){position:absolute;left:var(--toast-close-button-start);right:var(--toast-close-button-end);top:0;height:20px;width:20px;display:flex;justify-content:center;align-items:center;padding:0;color:var(--gray12);border:1px solid var(--gray4);transform:var(--toast-close-button-transform);border-radius:50%;cursor:pointer;z-index:1;transition:opacity .1s,background .2s,border-color .2s}[data-sonner-toast] [data-close-button]{background:var(--gray1)}:where([data-sonner-toast]) :where([data-close-button]):focus-visible{box-shadow:0 4px 12px #0000001a,0 0 0 2px #0003}:where([data-sonner-toast]) :where([data-disabled="true"]){cursor:not-allowed}:where([data-sonner-toast]):hover :where([data-close-button]):hover{background:var(--gray2);border-color:var(--gray5)}:where([data-sonner-toast][data-swiping="true"]):before{content:"";position:absolute;left:-50%;right:-50%;height:100%;z-index:-1}:where([data-sonner-toast][data-y-position="top"][data-swiping="true"]):before{bottom:50%;transform:scaleY(3) translateY(50%)}:where([data-sonner-toast][data-y-position="bottom"][data-swiping="true"]):before{top:50%;transform:scaleY(3) translateY(-50%)}:where([data-sonner-toast][data-swiping="false"][data-removed="true"]):before{content:"";position:absolute;inset:0;transform:scaleY(2)}:where([data-sonner-toast]):after{content:"";position:absolute;left:0;height:calc(var(--gap) + 1px);bottom:100%;width:100%}:where([data-sonner-toast][data-mounted="true"]){--y: translateY(0);opacity:1}:where([data-sonner-toast][data-expanded="false"][data-front="false"]){--scale: var(--toasts-before) * .05 + 1;--y: translateY(calc(var(--lift-amount) * var(--toasts-before))) scale(calc(-1 * var(--scale)));height:var(--front-toast-height)}:where([data-sonner-toast])>*{transition:opacity .4s}:where([data-sonner-toast][data-expanded="false"][data-front="false"][data-styled="true"])>*{opacity:0}:where([data-sonner-toast][data-visible="false"]){opacity:0;pointer-events:none}:where([data-sonner-toast][data-mounted="true"][data-expanded="true"]){--y: translateY(calc(var(--lift) * var(--offset)));height:var(--initial-height)}:where([data-sonner-toast][data-removed="true"][data-front="true"][data-swipe-out="false"]){--y: translateY(calc(var(--lift) * -100%));opacity:0}:where([data-sonner-toast][data-removed="true"][data-front="false"][data-swipe-out="false"][data-expanded="true"]){--y: translateY(calc(var(--lift) * var(--offset) + var(--lift) * -100%));opacity:0}:where([data-sonner-toast][data-removed="true"][data-front="false"][data-swipe-out="false"][data-expanded="false"]){--y: translateY(40%);opacity:0;transition:transform .5s,opacity .2s}:where([data-sonner-toast][data-removed="true"][data-front="false"]):before{height:calc(var(--initial-height) + 20%)}[data-sonner-toast][data-swiping=true]{transform:var(--y) translateY(var(--swipe-amount-y, 0px)) translate(var(--swipe-amount-x, 0px));transition:none}[data-sonner-toast][data-swiped=true]{user-select:none}[data-sonner-toast][data-swipe-out=true][data-y-position=bottom],[data-sonner-toast][data-swipe-out=true][data-y-position=top]{animation-duration:.2s;animation-timing-function:ease-out;animation-fill-mode:forwards}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=left]{animation-name:swipe-out-left}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=right]{animation-name:swipe-out-right}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=up]{animation-name:swipe-out-up}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=down]{animation-name:swipe-out-down}@keyframes swipe-out-left{0%{transform:var(--y) translate(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translate(calc(var(--swipe-amount-x) - 100%));opacity:0}}@keyframes swipe-out-right{0%{transform:var(--y) translate(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translate(calc(var(--swipe-amount-x) + 100%));opacity:0}}@keyframes swipe-out-up{0%{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) - 100%));opacity:0}}@keyframes swipe-out-down{0%{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) + 100%));opacity:0}}@media (max-width: 600px){[data-sonner-toaster]{position:fixed;right:var(--mobile-offset-right);left:var(--mobile-offset-left);width:100%}[data-sonner-toaster][dir=rtl]{left:calc(var(--mobile-offset-left) * -1)}[data-sonner-toaster] [data-sonner-toast]{left:0;right:0;width:calc(100% - var(--mobile-offset-left) * 2)}[data-sonner-toaster][data-x-position=left]{left:var(--mobile-offset-left)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--mobile-offset-bottom)}[data-sonner-toaster][data-y-position=top]{top:var(--mobile-offset-top)}[data-sonner-toaster][data-x-position=center]{left:var(--mobile-offset-left);right:var(--mobile-offset-right);transform:none}}[data-sonner-toaster][data-theme=light]{--normal-bg: #fff;--normal-border: var(--gray4);--normal-text: var(--gray12);--success-bg: hsl(143, 85%, 96%);--success-border: hsl(145, 92%, 91%);--success-text: hsl(140, 100%, 27%);--info-bg: hsl(208, 100%, 97%);--info-border: hsl(221, 91%, 91%);--info-text: hsl(210, 92%, 45%);--warning-bg: hsl(49, 100%, 97%);--warning-border: hsl(49, 91%, 91%);--warning-text: hsl(31, 92%, 45%);--error-bg: hsl(359, 100%, 97%);--error-border: hsl(359, 100%, 94%);--error-text: hsl(360, 100%, 45%)}[data-sonner-toaster][data-theme=light] [data-sonner-toast][data-invert=true]{--normal-bg: #000;--normal-border: hsl(0, 0%, 20%);--normal-text: var(--gray1)}[data-sonner-toaster][data-theme=dark] [data-sonner-toast][data-invert=true]{--normal-bg: #fff;--normal-border: var(--gray3);--normal-text: var(--gray12)}[data-sonner-toaster][data-theme=dark]{--normal-bg: #000;--normal-bg-hover: hsl(0, 0%, 12%);--normal-border: hsl(0, 0%, 20%);--normal-border-hover: hsl(0, 0%, 25%);--normal-text: var(--gray1);--success-bg: hsl(150, 100%, 6%);--success-border: hsl(147, 100%, 12%);--success-text: hsl(150, 86%, 65%);--info-bg: hsl(215, 100%, 6%);--info-border: hsl(223, 100%, 12%);--info-text: hsl(216, 87%, 65%);--warning-bg: hsl(64, 100%, 6%);--warning-border: hsl(60, 100%, 12%);--warning-text: hsl(46, 87%, 65%);--error-bg: hsl(358, 76%, 10%);--error-border: hsl(357, 89%, 16%);--error-text: hsl(358, 100%, 81%)}[data-sonner-toaster][data-theme=dark] [data-sonner-toast] [data-close-button]{background:var(--normal-bg);border-color:var(--normal-border);color:var(--normal-text)}[data-sonner-toaster][data-theme=dark] [data-sonner-toast] [data-close-button]:hover{background:var(--normal-bg-hover);border-color:var(--normal-border-hover)}[data-rich-colors=true][data-sonner-toast][data-type=success],[data-rich-colors=true][data-sonner-toast][data-type=success] [data-close-button]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=info],[data-rich-colors=true][data-sonner-toast][data-type=info] [data-close-button]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning],[data-rich-colors=true][data-sonner-toast][data-type=warning] [data-close-button]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=error],[data-rich-colors=true][data-sonner-toast][data-type=error] [data-close-button]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}.sonner-loading-wrapper{--size: 16px;height:var(--size);width:var(--size);position:absolute;inset:0;z-index:10}.sonner-loading-wrapper[data-visible=false]{transform-origin:center;animation:sonner-fade-out .2s ease forwards}.sonner-spinner{position:relative;top:50%;left:50%;height:var(--size);width:var(--size)}.sonner-loading-bar{animation:sonner-spin 1.2s linear infinite;background:var(--gray11);border-radius:6px;height:8%;left:-10%;position:absolute;top:-3.9%;width:24%}.sonner-loading-bar:nth-child(1){animation-delay:-1.2s;transform:rotate(.0001deg) translate(146%)}.sonner-loading-bar:nth-child(2){animation-delay:-1.1s;transform:rotate(30deg) translate(146%)}.sonner-loading-bar:nth-child(3){animation-delay:-1s;transform:rotate(60deg) translate(146%)}.sonner-loading-bar:nth-child(4){animation-delay:-.9s;transform:rotate(90deg) translate(146%)}.sonner-loading-bar:nth-child(5){animation-delay:-.8s;transform:rotate(120deg) translate(146%)}.sonner-loading-bar:nth-child(6){animation-delay:-.7s;transform:rotate(150deg) translate(146%)}.sonner-loading-bar:nth-child(7){animation-delay:-.6s;transform:rotate(180deg) translate(146%)}.sonner-loading-bar:nth-child(8){animation-delay:-.5s;transform:rotate(210deg) translate(146%)}.sonner-loading-bar:nth-child(9){animation-delay:-.4s;transform:rotate(240deg) translate(146%)}.sonner-loading-bar:nth-child(10){animation-delay:-.3s;transform:rotate(270deg) translate(146%)}.sonner-loading-bar:nth-child(11){animation-delay:-.2s;transform:rotate(300deg) translate(146%)}.sonner-loading-bar:nth-child(12){animation-delay:-.1s;transform:rotate(330deg) translate(146%)}@keyframes sonner-fade-in{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}@keyframes sonner-fade-out{0%{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.8)}}@keyframes sonner-spin{0%{opacity:1}to{opacity:.15}}@media (prefers-reduced-motion){[data-sonner-toast],[data-sonner-toast]>*,.sonner-loading-bar{transition:none!important;animation:none!important}}.sonner-loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transform-origin:center;transition:opacity .2s,transform .2s}.sonner-loader[data-visible=false]{opacity:0;transform:scale(.8) translate(-50%,-50%)}
`);function Ht(a){return a.label!==void 0}var lu=3,cu="32px",du="16px",xa=4e3,uu=356,mu=14,fu=20,gu=200;function Ae(...a){return a.filter(Boolean).join(" ")}function hu(a){let[e,t]=a.split("-"),r=[];return e&&r.push(e),t&&r.push(t),r}var pu=a=>{var e,t,r,n,o,i,l,u,m,c,x;let{invert:h,toast:f,unstyled:C,interacting:j,setHeights:N,visibleToasts:v,heights:g,index:p,toasts:y,expanded:b,removeToast:E,defaultRichColors:w,closeButton:k,style:T,cancelButtonStyle:$,actionButtonStyle:A,className:G="",descriptionClassName:te="",duration:W,position:ee,gap:ae,loadingIcon:re,expandByDefault:fe,classNames:z,icons:Y,closeButtonAriaLabel:M="Close toast",pauseWhenPageIsHidden:F}=a,[I,H]=V.useState(null),[q,B]=V.useState(null),[R,D]=V.useState(!1),[S,U]=V.useState(!1),[J,ue]=V.useState(!1),[me,he]=V.useState(!1),[pe,$t]=V.useState(!1),[Ct,je]=V.useState(0),[jt,zt]=V.useState(0),Qe=V.useRef(f.duration||W||xa),St=V.useRef(null),Le=V.useRef(null),ls=p===0,cs=p+1<=v,we=f.type,Ve=f.dismissible!==!1,ds=f.className||"",us=f.descriptionClassName||"",rt=V.useMemo(()=>g.findIndex(Q=>Q.toastId===f.id)||0,[g,f.id]),ms=V.useMemo(()=>{var Q;return(Q=f.closeButton)!=null?Q:k},[f.closeButton,k]),Bt=V.useMemo(()=>f.duration||W||xa,[f.duration,W]),Ze=V.useRef(0),$e=V.useRef(0),Nt=V.useRef(0),ze=V.useRef(null),[Ut,fs]=ee.split("-"),Vt=V.useMemo(()=>g.reduce((Q,ne,oe)=>oe>=rt?Q:Q+ne.height,0),[g,rt]),Wt=eu(),nt=f.invert||h,kt=we==="loading";$e.current=V.useMemo(()=>rt*ae+Vt,[rt,Vt]),V.useEffect(()=>{Qe.current=Bt},[Bt]),V.useEffect(()=>{D(!0)},[]),V.useEffect(()=>{let Q=Le.current;if(Q){let ne=Q.getBoundingClientRect().height;return zt(ne),N(oe=>[{toastId:f.id,height:ne,position:f.position},...oe]),()=>N(oe=>oe.filter(O=>O.toastId!==f.id))}},[N,f.id]),V.useLayoutEffect(()=>{if(!R)return;let Q=Le.current,ne=Q.style.height;Q.style.height="auto";let oe=Q.getBoundingClientRect().height;Q.style.height=ne,zt(oe),N(O=>O.find(K=>K.toastId===f.id)?O.map(K=>K.toastId===f.id?{...K,height:oe}:K):[{toastId:f.id,height:oe,position:f.position},...O])},[R,f.title,f.description,N,f.id]);let _e=V.useCallback(()=>{U(!0),je($e.current),N(Q=>Q.filter(ne=>ne.toastId!==f.id)),setTimeout(()=>{E(f)},gu)},[f,E,N,$e]);V.useEffect(()=>{if(f.promise&&we==="loading"||f.duration===1/0||f.type==="loading")return;let Q;return b||j||F&&Wt?(()=>{if(Nt.current<Ze.current){let ne=new Date().getTime()-Ze.current;Qe.current=Qe.current-ne}Nt.current=new Date().getTime()})():Qe.current!==1/0&&(Ze.current=new Date().getTime(),Q=setTimeout(()=>{var ne;(ne=f.onAutoClose)==null||ne.call(f,f),_e()},Qe.current)),()=>clearTimeout(Q)},[b,j,f,we,F,Wt,_e]),V.useEffect(()=>{f.delete&&_e()},[_e,f.delete]);function gs(){var Q,ne,oe;return Y!=null&&Y.loading?V.createElement("div",{className:Ae(z?.loader,(Q=f?.classNames)==null?void 0:Q.loader,"sonner-loader"),"data-visible":we==="loading"},Y.loading):re?V.createElement("div",{className:Ae(z?.loader,(ne=f?.classNames)==null?void 0:ne.loader,"sonner-loader"),"data-visible":we==="loading"},re):V.createElement(Yd,{className:Ae(z?.loader,(oe=f?.classNames)==null?void 0:oe.loader),visible:we==="loading"})}return V.createElement("li",{tabIndex:0,ref:Le,className:Ae(G,ds,z?.toast,(e=f?.classNames)==null?void 0:e.toast,z?.default,z?.[we],(t=f?.classNames)==null?void 0:t[we]),"data-sonner-toast":"","data-rich-colors":(r=f.richColors)!=null?r:w,"data-styled":!(f.jsx||f.unstyled||C),"data-mounted":R,"data-promise":!!f.promise,"data-swiped":pe,"data-removed":S,"data-visible":cs,"data-y-position":Ut,"data-x-position":fs,"data-index":p,"data-front":ls,"data-swiping":J,"data-dismissible":Ve,"data-type":we,"data-invert":nt,"data-swipe-out":me,"data-swipe-direction":q,"data-expanded":!!(b||fe&&R),style:{"--index":p,"--toasts-before":p,"--z-index":y.length-p,"--offset":`${S?Ct:$e.current}px`,"--initial-height":fe?"auto":`${jt}px`,...T,...f.style},onDragEnd:()=>{ue(!1),H(null),ze.current=null},onPointerDown:Q=>{kt||!Ve||(St.current=new Date,je($e.current),Q.target.setPointerCapture(Q.pointerId),Q.target.tagName!=="BUTTON"&&(ue(!0),ze.current={x:Q.clientX,y:Q.clientY}))},onPointerUp:()=>{var Q,ne,oe,O;if(me||!Ve)return;ze.current=null;let K=Number(((Q=Le.current)==null?void 0:Q.style.getPropertyValue("--swipe-amount-x").replace("px",""))||0),se=Number(((ne=Le.current)==null?void 0:ne.style.getPropertyValue("--swipe-amount-y").replace("px",""))||0),xe=new Date().getTime()-((oe=St.current)==null?void 0:oe.getTime()),ye=I==="x"?K:se,ge=Math.abs(ye)/xe;if(Math.abs(ye)>=fu||ge>.11){je($e.current),(O=f.onDismiss)==null||O.call(f,f),B(I==="x"?K>0?"right":"left":se>0?"down":"up"),_e(),he(!0),$t(!1);return}ue(!1),H(null)},onPointerMove:Q=>{var ne,oe,O,K;if(!ze.current||!Ve||((ne=window.getSelection())==null?void 0:ne.toString().length)>0)return;let se=Q.clientY-ze.current.y,xe=Q.clientX-ze.current.x,ye=(oe=a.swipeDirections)!=null?oe:hu(ee);!I&&(Math.abs(xe)>1||Math.abs(se)>1)&&H(Math.abs(xe)>Math.abs(se)?"x":"y");let ge={x:0,y:0};I==="y"?(ye.includes("top")||ye.includes("bottom"))&&(ye.includes("top")&&se<0||ye.includes("bottom")&&se>0)&&(ge.y=se):I==="x"&&(ye.includes("left")||ye.includes("right"))&&(ye.includes("left")&&xe<0||ye.includes("right")&&xe>0)&&(ge.x=xe),(Math.abs(ge.x)>0||Math.abs(ge.y)>0)&&$t(!0),(O=Le.current)==null||O.style.setProperty("--swipe-amount-x",`${ge.x}px`),(K=Le.current)==null||K.style.setProperty("--swipe-amount-y",`${ge.y}px`)}},ms&&!f.jsx?V.createElement("button",{"aria-label":M,"data-disabled":kt,"data-close-button":!0,onClick:kt||!Ve?()=>{}:()=>{var Q;_e(),(Q=f.onDismiss)==null||Q.call(f,f)},className:Ae(z?.closeButton,(n=f?.classNames)==null?void 0:n.closeButton)},(o=Y?.close)!=null?o:Zd):null,f.jsx||d.isValidElement(f.title)?f.jsx?f.jsx:typeof f.title=="function"?f.title():f.title:V.createElement(V.Fragment,null,we||f.icon||f.promise?V.createElement("div",{"data-icon":"",className:Ae(z?.icon,(i=f?.classNames)==null?void 0:i.icon)},f.promise||f.type==="loading"&&!f.icon?f.icon||gs():null,f.type!=="loading"?f.icon||Y?.[we]||Gd(we):null):null,V.createElement("div",{"data-content":"",className:Ae(z?.content,(l=f?.classNames)==null?void 0:l.content)},V.createElement("div",{"data-title":"",className:Ae(z?.title,(u=f?.classNames)==null?void 0:u.title)},typeof f.title=="function"?f.title():f.title),f.description?V.createElement("div",{"data-description":"",className:Ae(te,us,z?.description,(m=f?.classNames)==null?void 0:m.description)},typeof f.description=="function"?f.description():f.description):null),d.isValidElement(f.cancel)?f.cancel:f.cancel&&Ht(f.cancel)?V.createElement("button",{"data-button":!0,"data-cancel":!0,style:f.cancelButtonStyle||$,onClick:Q=>{var ne,oe;Ht(f.cancel)&&Ve&&((oe=(ne=f.cancel).onClick)==null||oe.call(ne,Q),_e())},className:Ae(z?.cancelButton,(c=f?.classNames)==null?void 0:c.cancelButton)},f.cancel.label):null,d.isValidElement(f.action)?f.action:f.action&&Ht(f.action)?V.createElement("button",{"data-button":!0,"data-action":!0,style:f.actionButtonStyle||A,onClick:Q=>{var ne,oe;Ht(f.action)&&((oe=(ne=f.action).onClick)==null||oe.call(ne,Q),!Q.defaultPrevented&&_e())},className:Ae(z?.actionButton,(x=f?.classNames)==null?void 0:x.actionButton)},f.action.label):null))};function ya(){if(typeof window>"u"||typeof document>"u")return"ltr";let a=document.documentElement.getAttribute("dir");return a==="auto"||!a?window.getComputedStyle(document.documentElement).direction:a}function xu(a,e){let t={};return[a,e].forEach((r,n)=>{let o=n===1,i=o?"--mobile-offset":"--offset",l=o?du:cu;function u(m){["top","right","bottom","left"].forEach(c=>{t[`${i}-${c}`]=typeof m=="number"?`${m}px`:m})}typeof r=="number"||typeof r=="string"?u(r):typeof r=="object"?["top","right","bottom","left"].forEach(m=>{r[m]===void 0?t[`${i}-${m}`]=l:t[`${i}-${m}`]=typeof r[m]=="number"?`${r[m]}px`:r[m]}):u(l)}),t}var yu=d.forwardRef(function(a,e){let{invert:t,position:r="bottom-right",hotkey:n=["altKey","KeyT"],expand:o,closeButton:i,className:l,offset:u,mobileOffset:m,theme:c="light",richColors:x,duration:h,style:f,visibleToasts:C=lu,toastOptions:j,dir:N=ya(),gap:v=mu,loadingIcon:g,icons:p,containerAriaLabel:y="Notifications",pauseWhenPageIsHidden:b}=a,[E,w]=V.useState([]),k=V.useMemo(()=>Array.from(new Set([r].concat(E.filter(F=>F.position).map(F=>F.position)))),[E,r]),[T,$]=V.useState([]),[A,G]=V.useState(!1),[te,W]=V.useState(!1),[ee,ae]=V.useState(c!=="system"?c:typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),re=V.useRef(null),fe=n.join("+").replace(/Key/g,"").replace(/Digit/g,""),z=V.useRef(null),Y=V.useRef(!1),M=V.useCallback(F=>{w(I=>{var H;return(H=I.find(q=>q.id===F.id))!=null&&H.delete||be.dismiss(F.id),I.filter(({id:q})=>q!==F.id)})},[]);return V.useEffect(()=>be.subscribe(F=>{if(F.dismiss){w(I=>I.map(H=>H.id===F.id?{...H,delete:!0}:H));return}setTimeout(()=>{oo.flushSync(()=>{w(I=>{let H=I.findIndex(q=>q.id===F.id);return H!==-1?[...I.slice(0,H),{...I[H],...F},...I.slice(H+1)]:[F,...I]})})})}),[]),V.useEffect(()=>{if(c!=="system"){ae(c);return}if(c==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?ae("dark"):ae("light")),typeof window>"u")return;let F=window.matchMedia("(prefers-color-scheme: dark)");try{F.addEventListener("change",({matches:I})=>{ae(I?"dark":"light")})}catch{F.addListener(({matches:H})=>{try{ae(H?"dark":"light")}catch(q){console.error(q)}})}},[c]),V.useEffect(()=>{E.length<=1&&G(!1)},[E]),V.useEffect(()=>{let F=I=>{var H,q;n.every(B=>I[B]||I.code===B)&&(G(!0),(H=re.current)==null||H.focus()),I.code==="Escape"&&(document.activeElement===re.current||(q=re.current)!=null&&q.contains(document.activeElement))&&G(!1)};return document.addEventListener("keydown",F),()=>document.removeEventListener("keydown",F)},[n]),V.useEffect(()=>{if(re.current)return()=>{z.current&&(z.current.focus({preventScroll:!0}),z.current=null,Y.current=!1)}},[re.current]),V.createElement("section",{ref:e,"aria-label":`${y} ${fe}`,tabIndex:-1,"aria-live":"polite","aria-relevant":"additions text","aria-atomic":"false",suppressHydrationWarning:!0},k.map((F,I)=>{var H;let[q,B]=F.split("-");return E.length?V.createElement("ol",{key:F,dir:N==="auto"?ya():N,tabIndex:-1,ref:re,className:l,"data-sonner-toaster":!0,"data-theme":ee,"data-y-position":q,"data-lifted":A&&E.length>1&&!o,"data-x-position":B,style:{"--front-toast-height":`${((H=T[0])==null?void 0:H.height)||0}px`,"--width":`${uu}px`,"--gap":`${v}px`,...f,...xu(u,m)},onBlur:R=>{Y.current&&!R.currentTarget.contains(R.relatedTarget)&&(Y.current=!1,z.current&&(z.current.focus({preventScroll:!0}),z.current=null))},onFocus:R=>{R.target instanceof HTMLElement&&R.target.dataset.dismissible==="false"||Y.current||(Y.current=!0,z.current=R.relatedTarget)},onMouseEnter:()=>G(!0),onMouseMove:()=>G(!0),onMouseLeave:()=>{te||G(!1)},onDragEnd:()=>G(!1),onPointerDown:R=>{R.target instanceof HTMLElement&&R.target.dataset.dismissible==="false"||W(!0)},onPointerUp:()=>W(!1)},E.filter(R=>!R.position&&I===0||R.position===F).map((R,D)=>{var S,U;return V.createElement(pu,{key:R.id,icons:p,index:D,toast:R,defaultRichColors:x,duration:(S=j?.duration)!=null?S:h,className:j?.className,descriptionClassName:j?.descriptionClassName,invert:t,visibleToasts:C,closeButton:(U=j?.closeButton)!=null?U:i,interacting:te,position:F,style:j?.style,unstyled:j?.unstyled,classNames:j?.classNames,cancelButtonStyle:j?.cancelButtonStyle,actionButtonStyle:j?.actionButtonStyle,removeToast:M,toasts:E.filter(J=>J.position==R.position),heights:T.filter(J=>J.position==R.position),setHeights:$,expandByDefault:o,gap:v,loadingIcon:g,expanded:A,pauseWhenPageIsHidden:b,swipeDirections:a.swipeDirections})})):null}))});const wu=({...a})=>s.jsx(yu,{theme:"light",className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"group-[.toast]:text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...a});function bu({open:a,onOpenChange:e}){const[t,r]=d.useState({user:null,session:null,loading:!1,error:null}),[n,o]=d.useState("main"),[i,l]=d.useState(!1),[u,m]=d.useState({email:"",password:"",confirmPassword:"",name:""}),[c,x]=d.useState({}),[h,f]=d.useState(!1);d.useEffect(()=>Ee.onAuthStateChange(r),[]);const C=()=>{m({email:"",password:"",confirmPassword:"",name:""}),x({}),f(!1),l(!1)},j=A=>{const G={};return(A==="email-login"||A==="email-signup"||A==="forgot-password")&&(u.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(u.email)||(G.email="请输入有效的邮箱地址"):G.email="请输入邮箱地址"),(A==="email-login"||A==="email-signup")&&(u.password?u.password.length<6&&(G.password="密码至少需要6个字符"):G.password="请输入密码"),A==="email-signup"&&(u.name||(G.name="请输入姓名"),u.password!==u.confirmPassword&&(G.confirmPassword="两次输入的密码不一致")),x(G),Object.keys(G).length===0},N=async()=>{f(!0);const{error:A}=await Ee.signInWithGitHub();A&&console.error("GitHub登录失败:",A),f(!1)},v=async()=>{if(!j("email-login"))return;f(!0);const{error:A}=await Ee.signInWithEmail(u.email,u.password);A?x({general:A.message}):(e(!1),C(),o("main")),f(!1)},g=async()=>{if(!j("email-signup"))return;f(!0);const{error:A}=await Ee.signUpWithEmail(u.email,u.password,{name:u.name});A?x({general:A.message}):o("check-email"),f(!1)},p=async()=>{if(!j("forgot-password"))return;f(!0);const{error:A}=await Ee.resetPassword(u.email);A?x({general:A.message}):o("check-email"),f(!1)},y=async()=>{const{error:A}=await Ee.signOut();A&&console.error("登出失败:",A)},b=async()=>{await io.performFullSync()};if(t.user)return s.jsx(st,{open:a,onOpenChange:e,children:s.jsx(Je,{className:"sm:max-w-md border-0 shadow-2xl",children:s.jsxs("div",{className:"space-y-6 p-2",children:[s.jsx(ie,{className:"border-0 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/20 dark:to-indigo-950/20",children:s.jsx(le,{className:"p-6",children:s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsxs("div",{className:"relative",children:[s.jsx(on,{user:t.user,size:"lg",className:"h-16 w-16 shadow-lg",showHoverEffect:!1}),s.jsx("div",{className:"absolute -bottom-1 -right-1 h-5 w-5 bg-green-500 rounded-full border-2 border-white"})]}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{className:"font-semibold text-lg",children:t.user.username||"用户"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:t.user.email}),s.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[s.jsx(Ke,{className:"h-3 w-3 text-green-500"}),s.jsx("span",{className:"text-xs text-green-600",children:"云端同步已启用"})]})]})]})})}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs(L,{onClick:b,variant:"outline",className:"w-full h-12 rounded-2xl border-2 hover:bg-blue-50 transition-all duration-200",disabled:t.loading,children:[t.loading?s.jsx(Et,{className:"h-5 w-5 mr-2 animate-spin"}):s.jsx(Ke,{className:"h-5 w-5 mr-2 text-blue-500"}),"立即同步数据"]}),s.jsx(L,{onClick:y,variant:"ghost",className:"w-full h-12 rounded-2xl hover:bg-red-50 hover:text-red-600 transition-all duration-200",disabled:t.loading,children:"退出登录"})]})]})})});const E=()=>s.jsxs("div",{className:"space-y-6 p-2",children:[s.jsxs("div",{className:"text-center space-y-2",children:[s.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent",children:"欢迎使用 CardAll"}),s.jsx("p",{className:"text-muted-foreground",children:"选择您的登录方式"})]}),s.jsxs(L,{onClick:N,disabled:h,className:"w-full h-14 rounded-2xl bg-gray-900 hover:bg-gray-800 text-white shadow-lg transition-all duration-200 transform hover:scale-[1.02]",size:"lg",children:[h?s.jsx(Et,{className:"h-5 w-5 mr-3 animate-spin"}):s.jsx(Oo,{className:"h-5 w-5 mr-3"}),"使用 GitHub 登录"]}),s.jsxs("div",{className:"relative",children:[s.jsx("div",{className:"absolute inset-0 flex items-center",children:s.jsx("span",{className:"w-full border-t border-gray-200"})}),s.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:s.jsx("span",{className:"bg-background px-4 text-muted-foreground",children:"或"})})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs(L,{onClick:()=>o("email-login"),variant:"outline",className:"w-full h-14 rounded-2xl border-2 hover:bg-blue-50 transition-all duration-200 transform hover:scale-[1.02]",size:"lg",children:[s.jsx(Dt,{className:"h-5 w-5 mr-3 text-blue-500"}),"使用邮箱登录"]}),s.jsxs(L,{onClick:()=>o("email-signup"),variant:"ghost",className:"w-full h-12 rounded-2xl hover:bg-green-50 hover:text-green-600 transition-all duration-200",children:[s.jsx(ea,{className:"h-4 w-4 mr-2"}),"创建新账户"]})]}),s.jsxs("div",{className:"text-xs text-muted-foreground text-center space-y-1 pt-4",children:[s.jsx("p",{children:"登录后可享受云端同步功能"}),s.jsx("p",{children:"即使不登录也可正常使用本地功能"})]})]}),w=()=>s.jsxs("div",{className:"space-y-6 p-2",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(L,{variant:"ghost",size:"sm",onClick:()=>o("main"),className:"rounded-full p-2",children:s.jsx(ps,{className:"h-4 w-4"})}),s.jsx("h2",{className:"text-xl font-semibold",children:"邮箱登录"})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"email",children:"邮箱地址"}),s.jsxs("div",{className:"relative",children:[s.jsx(Dt,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"email",type:"email",placeholder:"输入您的邮箱地址",value:u.email,onChange:A=>m(G=>({...G,email:A.target.value})),className:"pl-10 h-12 rounded-2xl border-2"})]}),c.email&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),c.email]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"password",children:"密码"}),s.jsxs("div",{className:"relative",children:[s.jsx(xs,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"password",type:i?"text":"password",placeholder:"输入您的密码",value:u.password,onChange:A=>m(G=>({...G,password:A.target.value})),className:"pl-10 pr-10 h-12 rounded-2xl border-2"}),s.jsx(L,{type:"button",variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-10 w-10 rounded-xl",onClick:()=>l(!i),children:i?s.jsx(As,{className:"h-4 w-4"}):s.jsx(Jt,{className:"h-4 w-4"})})]}),c.password&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),c.password]})]}),s.jsx("div",{className:"text-right",children:s.jsx(L,{variant:"link",size:"sm",onClick:()=>o("forgot-password"),className:"text-blue-600 hover:text-blue-700 p-0 h-auto",children:"忘记密码？"})}),c.general&&s.jsxs("div",{className:"text-sm text-red-500 text-center bg-red-50 p-3 rounded-2xl flex items-center justify-center gap-2",children:[s.jsx(Se,{className:"h-4 w-4"}),c.general]}),s.jsxs(L,{onClick:v,disabled:h,className:"w-full h-12 rounded-2xl bg-blue-600 hover:bg-blue-700 transition-all duration-200",children:[h?s.jsx(Et,{className:"h-4 w-4 mr-2 animate-spin"}):null,"登录"]})]})]}),k=()=>s.jsxs("div",{className:"space-y-6 p-2",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(L,{variant:"ghost",size:"sm",onClick:()=>o("main"),className:"rounded-full p-2",children:s.jsx(ps,{className:"h-4 w-4"})}),s.jsx("h2",{className:"text-xl font-semibold",children:"创建账户"})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"name",children:"姓名"}),s.jsxs("div",{className:"relative",children:[s.jsx(ea,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"name",type:"text",placeholder:"输入您的姓名",value:u.name,onChange:A=>m(G=>({...G,name:A.target.value})),className:"pl-10 h-12 rounded-2xl border-2"})]}),c.name&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),c.name]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"signup-email",children:"邮箱地址"}),s.jsxs("div",{className:"relative",children:[s.jsx(Dt,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"signup-email",type:"email",placeholder:"输入您的邮箱地址",value:u.email,onChange:A=>m(G=>({...G,email:A.target.value})),className:"pl-10 h-12 rounded-2xl border-2"})]}),c.email&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),c.email]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"signup-password",children:"密码"}),s.jsxs("div",{className:"relative",children:[s.jsx(xs,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"signup-password",type:i?"text":"password",placeholder:"设置您的密码（至少6个字符）",value:u.password,onChange:A=>m(G=>({...G,password:A.target.value})),className:"pl-10 pr-10 h-12 rounded-2xl border-2"}),s.jsx(L,{type:"button",variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-10 w-10 rounded-xl",onClick:()=>l(!i),children:i?s.jsx(As,{className:"h-4 w-4"}):s.jsx(Jt,{className:"h-4 w-4"})})]}),c.password&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),c.password]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"confirm-password",children:"确认密码"}),s.jsxs("div",{className:"relative",children:[s.jsx(xs,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"confirm-password",type:i?"text":"password",placeholder:"再次输入密码",value:u.confirmPassword,onChange:A=>m(G=>({...G,confirmPassword:A.target.value})),className:"pl-10 h-12 rounded-2xl border-2"})]}),c.confirmPassword&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),c.confirmPassword]})]}),c.general&&s.jsxs("div",{className:"text-sm text-red-500 text-center bg-red-50 p-3 rounded-2xl flex items-center justify-center gap-2",children:[s.jsx(Se,{className:"h-4 w-4"}),c.general]}),s.jsxs(L,{onClick:g,disabled:h,className:"w-full h-12 rounded-2xl bg-green-600 hover:bg-green-700 transition-all duration-200",children:[h?s.jsx(Et,{className:"h-4 w-4 mr-2 animate-spin"}):null,"创建账户"]}),s.jsx("div",{className:"text-xs text-muted-foreground text-center",children:s.jsx("p",{children:"注册即表示您同意我们的服务条款和隐私政策"})})]})]}),T=()=>s.jsxs("div",{className:"space-y-6 p-2",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(L,{variant:"ghost",size:"sm",onClick:()=>o("email-login"),className:"rounded-full p-2",children:s.jsx(ps,{className:"h-4 w-4"})}),s.jsx("h2",{className:"text-xl font-semibold",children:"重置密码"})]}),s.jsx("div",{className:"text-center space-y-2",children:s.jsx("p",{className:"text-muted-foreground",children:"输入您的邮箱地址，我们将发送重置密码的链接"})}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(Ce,{htmlFor:"reset-email",children:"邮箱地址"}),s.jsxs("div",{className:"relative",children:[s.jsx(Dt,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),s.jsx(ve,{id:"reset-email",type:"email",placeholder:"输入您的邮箱地址",value:u.email,onChange:A=>m(G=>({...G,email:A.target.value})),className:"pl-10 h-12 rounded-2xl border-2"})]}),c.email&&s.jsxs("p",{className:"text-sm text-red-500 flex items-center gap-1",children:[s.jsx(Se,{className:"h-3 w-3"}),c.email]})]}),c.general&&s.jsxs("div",{className:"text-sm text-red-500 text-center bg-red-50 p-3 rounded-2xl flex items-center justify-center gap-2",children:[s.jsx(Se,{className:"h-4 w-4"}),c.general]}),s.jsxs(L,{onClick:p,disabled:h,className:"w-full h-12 rounded-2xl bg-blue-600 hover:bg-blue-700 transition-all duration-200",children:[h?s.jsx(Et,{className:"h-4 w-4 mr-2 animate-spin"}):null,"发送重置链接"]})]})]}),$=()=>s.jsxs("div",{className:"space-y-6 p-2 text-center",children:[s.jsx("div",{className:"flex justify-center",children:s.jsx("div",{className:"h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center",children:s.jsx(Dt,{className:"h-8 w-8 text-blue-600"})})}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h2",{className:"text-xl font-semibold",children:"检查您的邮箱"}),s.jsxs("p",{className:"text-muted-foreground",children:["我们已向 ",s.jsx("span",{className:"font-medium",children:u.email})," 发送了一封邮件"]}),s.jsxs("p",{className:"text-sm text-muted-foreground",children:["请点击邮件中的链接来完成",n==="check-email"?"账户激活":"密码重置"]})]}),s.jsx(L,{onClick:()=>{o("main"),C()},variant:"outline",className:"w-full h-12 rounded-2xl border-2",children:"返回登录"})]});return s.jsx(st,{open:a,onOpenChange:A=>{e(A),A||(o("main"),C())},children:s.jsxs(Je,{className:"sm:max-w-md border-0 shadow-2xl rounded-3xl",children:[n==="main"&&E(),n==="email-login"&&w(),n==="email-signup"&&k(),n==="forgot-password"&&T(),n==="check-email"&&$()]})})}const vu=({onClose:a})=>{const[e,t]=d.useState(null),[r,n]=d.useState(!1),[o,i]=d.useState(!1),[l,u]=d.useState(navigator.onLine);d.useEffect(()=>{const x=()=>{window.matchMedia("(display-mode: standalone)").matches&&i(!0)},h=N=>{N.preventDefault(),t(N),setTimeout(()=>{o||n(!0)},3e3)},f=()=>{i(!0),n(!1),t(null),console.log("PWA was installed")},C=()=>u(!0),j=()=>u(!1);return x(),window.addEventListener("beforeinstallprompt",h),window.addEventListener("appinstalled",f),window.addEventListener("online",C),window.addEventListener("offline",j),()=>{window.removeEventListener("beforeinstallprompt",h),window.removeEventListener("appinstalled",f),window.removeEventListener("online",C),window.removeEventListener("offline",j)}},[o]);const m=async()=>{if(e)try{await e.prompt();const{outcome:x}=await e.userChoice;console.log(x==="accepted"?"User accepted the install prompt":"User dismissed the install prompt"),t(null),n(!1)}catch(x){console.error("Error during installation:",x)}},c=()=>{n(!1),a?.()};return!r||o?null:s.jsx("div",{className:"fixed bottom-4 right-4 z-50 max-w-sm",children:s.jsxs(ie,{className:"shadow-lg border-2 border-blue-200 bg-gradient-to-br from-blue-50 to-white",children:[s.jsxs(Fe,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(gt,{className:"h-5 w-5 text-blue-600"}),s.jsx(Oe,{className:"text-lg",children:"安装 CardAll"})]}),s.jsx(L,{variant:"ghost",size:"sm",onClick:c,className:"h-6 w-6 p-0",children:s.jsx(at,{className:"h-4 w-4"})})]}),s.jsx(Nn,{children:"将 CardAll 安装到您的设备上，享受更好的体验"})]}),s.jsxs(le,{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[s.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[l?s.jsx(ts,{className:"h-4 w-4"}):s.jsx(zs,{className:"h-4 w-4"}),s.jsx("span",{children:l?"在线使用":"离线可用"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-blue-600",children:[s.jsx(Po,{className:"h-4 w-4"}),s.jsx("span",{children:"移动优化"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-purple-600",children:[s.jsx(Lo,{className:"h-4 w-4"}),s.jsx("span",{children:"桌面应用"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-orange-600",children:[s.jsx(gt,{className:"h-4 w-4"}),s.jsx("span",{children:"快速启动"})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h4",{className:"font-medium text-sm",children:"安装后您将获得："}),s.jsxs("ul",{className:"text-xs text-gray-600 space-y-1",children:[s.jsx("li",{children:"• 完全离线功能"}),s.jsx("li",{children:"• 更快的加载速度"}),s.jsx("li",{children:"• 桌面快捷方式"}),s.jsx("li",{children:"• 推送通知支持"})]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(L,{onClick:m,className:"flex-1 bg-blue-600 hover:bg-blue-700",disabled:!e,children:[s.jsx(gt,{className:"h-4 w-4 mr-2"}),"立即安装"]}),s.jsx(L,{variant:"outline",onClick:c,className:"px-3",children:"稍后"})]})]})]})})};function Cu({initializationError:a}){const{isOpen:e,closeModal:t}=Er();return s.jsxs("div",{className:"min-h-screen bg-background",children:[a&&s.jsx("div",{className:"border-b bg-destructive/5",children:s.jsx("div",{className:"container mx-auto px-4 py-2",children:s.jsxs(tt,{variant:"destructive",className:"mb-0",children:[s.jsx(De,{className:"h-4 w-4"}),s.jsx(xt,{children:a})]})})}),s.jsx(gi,{children:s.jsx(nl,{children:s.jsx(ol,{children:s.jsx(Ud,{})})})}),s.jsx(vu,{}),s.jsx(bu,{open:e,onOpenChange:t}),s.jsx(wu,{})]})}function wa({initializationError:a}){return s.jsx(Hd,{defaultTheme:"light",storageKey:"cardall-theme",children:s.jsx(pi,{children:s.jsx(Cu,{initializationError:a})})})}class ju{async hasLegacyData(){const e=!!localStorage.getItem("cardall-cards"),t=!!localStorage.getItem("cardall-folders"),r=!!localStorage.getItem("cardall-tags");return e||t||r}async migrateFromLocalStorage(){const e={success:!1,migratedCards:0,migratedFolders:0,migratedTags:0,migratedImages:0,errors:[]};try{console.log("Starting migration from localStorage...");const t=await this.migrateFolders();e.migratedFolders=t.length;const r=await this.migrateTags();e.migratedTags=r.length;const{cards:n,images:o}=await this.migrateCards();e.migratedCards=n.length,e.migratedImages=o,e.success=!0,console.log("Migration completed successfully:",e),await this.backupLegacyData()}catch(t){console.error("Migration failed:",t),e.errors.push(t instanceof Error?t.message:"Unknown error")}return e}async migrateFolders(){const e=localStorage.getItem("cardall-folders");if(!e)return[];try{const r=JSON.parse(e).map(n=>({...n,syncVersion:1,pendingSync:!0}));return await P.folders.bulkAdd(r),console.log(`Migrated ${r.length} folders`),r}catch(t){throw console.error("Failed to migrate folders:",t),t}}async migrateTags(){const e=localStorage.getItem("cardall-tags");if(!e)return[];try{const r=JSON.parse(e).map(n=>({...n,syncVersion:1,pendingSync:!0}));return await P.tags.bulkAdd(r),console.log(`Migrated ${r.length} tags`),r}catch(t){throw console.error("Failed to migrate tags:",t),t}}async migrateCards(){const e=localStorage.getItem("cardall-cards");if(!e)return{cards:[],images:0};try{const t=JSON.parse(e),r=[];let n=0;for(const o of t){const i=await this.migrateCardImages(o.frontContent.images,o.id,o.folderId),l=await this.migrateCardImages(o.backContent.images,o.id,o.folderId);n+=i.length+l.length;const u={...o,frontContent:{...o.frontContent,images:i},backContent:{...o.backContent,images:l},syncVersion:1,pendingSync:!0};r.push(u)}return await P.cards.bulkAdd(r),console.log(`Migrated ${r.length} cards with ${n} images`),{cards:r,images:n}}catch(t){throw console.error("Failed to migrate cards:",t),t}}async migrateCardImages(e,t,r){const n=[];for(const o of e)try{if(o.url&&o.url.startsWith("data:")){const i=await this.base64ToBlob(o.url),l=new File([i],o.alt||"migrated-image.jpg",{type:i.type}),u=await et.saveImage(l,t,r);n.push({id:u.id,url:u.filePath,alt:o.alt,width:u.metadata.width,height:u.metadata.height,position:o.position,size:o.size,aspectRatio:u.metadata.width/u.metadata.height})}else n.push(o)}catch(i){console.error("Failed to migrate image:",i),n.push(o)}return n}async base64ToBlob(e){return(await fetch(e)).blob()}async backupLegacyData(){const e={cards:localStorage.getItem("cardall-cards"),folders:localStorage.getItem("cardall-folders"),tags:localStorage.getItem("cardall-tags"),hiddenTags:localStorage.getItem("cardall-hidden-tags"),timestamp:new Date().toISOString()};await P.settings.add({key:"legacy_backup",value:e,updatedAt:new Date}),console.log("Legacy data backed up successfully")}async cleanupLegacyData(){["cardall-cards","cardall-folders","cardall-tags","cardall-hidden-tags"].forEach(t=>localStorage.removeItem(t)),console.log("Legacy localStorage data cleaned up")}async restoreFromBackup(){try{const e=await P.settings.where("key").equals("legacy_backup").first();if(!e)return console.log("No backup data found"),!1;const t=e.value;return t.cards&&localStorage.setItem("cardall-cards",t.cards),t.folders&&localStorage.setItem("cardall-folders",t.folders),t.tags&&localStorage.setItem("cardall-tags",t.tags),t.hiddenTags&&localStorage.setItem("cardall-hidden-tags",t.hiddenTags),console.log("Backup data restored to localStorage"),!0}catch(e){return console.error("Failed to restore backup:",e),!1}}async getMigrationStatus(){const e=await this.hasLegacyData(),t=await P.getStats(),r=t.cards>0||t.folders>0||t.tags>0;return{hasLegacyData:e,hasMigratedData:r,migrationNeeded:e&&!r}}}const Ds=new ju;class Su{listeners=[];onStatusChange(e){return this.listeners.push(e),()=>{const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}}updateStatus(e){this.listeners.forEach(t=>t(e))}async initialize(){console.log("开始应用初始化...");const e={success:!1,fileSystemAccess:!1};try{console.log("步骤1: 开始初始化数据库..."),this.updateStatus({step:"database",progress:10,message:"正在初始化数据库...",isComplete:!1,hasError:!1}),console.log("调用 initializeDatabase()...");try{await lo(),console.log("数据库初始化完成"),this.updateStatus({step:"database",progress:20,message:"数据库初始化完成",isComplete:!0,hasError:!1})}catch(t){throw console.error("数据库初始化失败:",t),new Error(`数据库初始化失败: ${t instanceof Error?t.message:"未知错误"}`)}this.updateStatus({step:"migration-check",progress:25,message:"检查数据迁移需求...",isComplete:!1,hasError:!1});try{if((await Ds.getMigrationStatus()).migrationNeeded&&(this.updateStatus({step:"migration",progress:40,message:"正在迁移现有数据...",isComplete:!1,hasError:!1}),e.migrationResult=await Ds.migrateFromLocalStorage(),!e.migrationResult.success))throw new Error(`数据迁移失败: ${e.migrationResult.errors.join(", ")}`)}catch(t){console.error("数据迁移检查失败:",t),this.updateStatus({step:"migration-check",progress:30,message:"数据迁移检查失败，跳过迁移",isComplete:!0,hasError:!1})}if(this.updateStatus({step:"filesystem",progress:60,message:"配置文件系统访问权限...",isComplete:!1,hasError:!1}),et.isFileSystemAccessSupported())try{await et.getStorageStrategy()==="filesystem"?(e.fileSystemAccess=await et.requestDirectoryAccess(),e.fileSystemAccess||console.warn("文件系统访问权限未获得，将使用IndexedDB存储")):(console.info("使用已配置的IndexedDB存储策略"),e.fileSystemAccess=!1)}catch(t){console.warn("文件系统访问请求失败，使用降级存储:",t),e.fileSystemAccess=!1}else console.info("浏览器不支持File System Access API，使用IndexedDB存储"),e.fileSystemAccess=!1;this.updateStatus({step:"sync",progress:80,message:"初始化同步服务...",isComplete:!1,hasError:!1});try{Ie.setAuthService(Ee),Ee.isAuthenticated()&&await Ie.performFullSync()}catch(t){console.error("同步服务初始化失败:",t),this.updateStatus({step:"sync",progress:85,message:"同步服务初始化失败，使用离线模式",isComplete:!0,hasError:!1})}this.updateStatus({step:"complete",progress:100,message:"应用初始化完成",isComplete:!0,hasError:!1}),e.success=!0,console.log("应用初始化成功:",e)}catch(t){console.error("应用初始化失败:",t),this.updateStatus({step:"error",progress:0,message:`初始化失败: ${t instanceof Error?t.message:"未知错误"}`,isComplete:!1,hasError:!0,error:t instanceof Error?t.message:"未知错误"}),e.success=!1,e.error=t instanceof Error?t.message:"未知错误"}return e}async reinitialize(){return console.log("重新初始化应用..."),this.initialize()}async checkInitializationStatus(){try{const e=await Ds.getMigrationStatus();return{databaseReady:!0,syncServiceReady:Ie.getCurrentStatus()!==null,fileSystemAccess:et.isFileSystemAccessSupported(),migrationNeeded:e.migrationNeeded}}catch(e){return console.error("检查初始化状态失败:",e),{databaseReady:!1,syncServiceReady:!1,fileSystemAccess:!1,migrationNeeded:!1}}}}const ba=new Su;function Nu({onInitialized:a,onError:e,onSkipInitialization:t}){const[r,n]=d.useState({step:"starting",progress:0,message:"准备初始化...",isComplete:!1,hasError:!1}),[o,i]=d.useState(!1),[l,u]=d.useState(null),m=async()=>{console.log("开始初始化流程..."),console.log("时间戳:",new Date().toISOString()),i(!0),u(null);try{console.log("调用appInitService.initialize()...");const h=await ba.initialize();console.log("初始化结果:",h),console.log("结果详情:",JSON.stringify(h,null,2)),u(h),h.success?(console.log("初始化成功，准备进入应用..."),console.log("成功时间戳:",new Date().toISOString()),setTimeout(()=>{a(h)},1e3)):(console.log("初始化失败:",h.error),console.log("失败时间戳:",new Date().toISOString()))}catch(h){console.error("初始化过程出错:",h),console.error("错误时间戳:",new Date().toISOString()),e&&e(h instanceof Error?h.message:"初始化失败")}finally{i(!1)}};d.useEffect(()=>{console.log("设置状态监听器...");const h=ba.onStatusChange(f=>{console.log("收到状态更新:",f),n(f)});return console.log("状态监听器设置完成"),h},[]),d.useEffect(()=>{m()},[]);const c=(h,f,C)=>f?s.jsx(Se,{className:"h-5 w-5 text-destructive"}):C?s.jsx(Ke,{className:"h-5 w-5 text-green-500"}):s.jsx(Re,{className:"h-5 w-5 animate-spin text-blue-500"}),x=h=>({database:"初始化本地数据库，设置数据存储结构","migration-check":"检查是否有需要从localStorage迁移的数据",migration:"将现有数据迁移到新的数据库结构",filesystem:"请求文件系统访问权限以支持本地文件存储",sync:"初始化同步服务，准备离线和在线数据同步",complete:"所有组件初始化完成，应用准备就绪"})[h]||"正在处理...";return s.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4",children:s.jsxs(ie,{className:"w-full max-w-md",children:[s.jsx(Fe,{className:"text-center",children:s.jsxs(Oe,{className:"flex items-center justify-center gap-2",children:[s.jsx(qt,{className:"h-6 w-6 text-blue-600"}),"CardAll 初始化"]})}),s.jsxs(le,{className:"space-y-6",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{children:"初始化进度"}),s.jsxs("span",{children:[r.progress,"%"]})]}),s.jsx(He,{value:r.progress,className:"h-2"})]}),s.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted rounded-lg",children:[c(r.step,r.hasError,r.isComplete),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-medium",children:r.message}),s.jsx("div",{className:"text-sm text-muted-foreground",children:x(r.step)})]})]}),r.hasError&&r.error&&s.jsxs(tt,{variant:"destructive",children:[s.jsx(Se,{className:"h-4 w-4"}),s.jsx(xt,{children:r.error})]}),l?.migrationResult&&s.jsxs(tt,{children:[s.jsx(Ke,{className:"h-4 w-4"}),s.jsxs(xt,{children:["数据迁移完成: ",l.migrationResult.migratedCards," 张卡片, "," ",l.migrationResult.migratedFolders," 个文件夹, "," ",l.migrationResult.migratedTags," 个标签, "," ",l.migrationResult.migratedImages," 张图片"]})]}),l&&s.jsxs(tt,{variant:l.fileSystemAccess?"default":"destructive",children:[s.jsx(qt,{className:"h-4 w-4"}),s.jsx(xt,{children:l.fileSystemAccess?"文件系统访问权限已获得，支持本地文件存储":"未获得文件系统访问权限，将使用浏览器内置存储"})]}),s.jsxs("div",{className:"flex gap-2",children:[r.hasError&&s.jsxs(s.Fragment,{children:[s.jsx(L,{onClick:m,disabled:o,className:"flex-1",children:o?s.jsxs(s.Fragment,{children:[s.jsx(Re,{className:"h-4 w-4 mr-2 animate-spin"}),"重试中..."]}):"重试初始化"}),t&&s.jsx(L,{onClick:t,variant:"outline",className:"flex-1",children:"跳过初始化"})]}),l?.success&&s.jsxs(L,{onClick:()=>a(l),className:"flex-1",children:[s.jsx(Ke,{className:"h-4 w-4 mr-2"}),"进入应用"]})]}),s.jsxs("div",{className:"text-xs text-muted-foreground text-center space-y-1",children:[s.jsx("p",{children:"首次启动需要初始化数据库和同步服务"}),s.jsx("p",{children:"如果有现有数据，将自动迁移到新的存储结构"})]})]})]})})}function ku(){const[a,e]=d.useState({isInitialized:!1,hasError:!1,canSkip:!1}),t=o=>{console.log("应用初始化完成:",o),e({isInitialized:!0,hasError:!1,canSkip:!1})},r=o=>{console.error("应用初始化失败:",o),e(i=>({...i,hasError:!0,error:o,canSkip:!0}))},n=()=>{console.warn("用户选择跳过初始化，应用将以降级模式运行"),e({isInitialized:!0,hasError:!0,canSkip:!1,error:"应用以降级模式运行，某些功能可能不可用"})};return!a.isInitialized||a.hasError&&!a.canSkip?s.jsx(Nu,{onInitialized:t,onError:r,onSkipInitialization:a.canSkip?n:void 0}):a.hasError?s.jsx(wa,{initializationError:a.error}):s.jsx(wa,{})}Is.createRoot(document.getElementById("root")).render(s.jsx(V.StrictMode,{children:s.jsx(ku,{})}));
