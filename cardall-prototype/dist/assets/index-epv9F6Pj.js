const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/sync-Bq-7cJrZ.js","assets/supabase-BJjf9Ixn.js","assets/vendor-DBpFvjuy.js","assets/database-Ddn5sgg-.js"])))=>i.map(i=>d[i]);
import{j as s,S as xn,a as ha,b as pa,P as wn,C as ya,I as xa,c as wa,d as ba,R as va,L as Ca,e as ja,f as bn,T as vn,g as Sa,V as Cn,h as jn,i as Na,k as Sn,O as ka,l as Nn,m as Ea,n as kn,o as Da,D as Ra,p as En,q as Ta,r as Dn,s as Rn,t as Tn,u as Aa,v as Ia,w as An,x as _a,y as In,z as _n,A as Ma,B as Fa,F as Oa,E as Pa,G as La,H as Mn,J as $a,K as za,M as Ba,N as Ua,Q as Va,U as Wa,W as Ha,X as Fn,Y as On,Z as Ga,_ as Pn,$ as Ka,a0 as Ya,a1 as Ln,a2 as qa,a3 as $n,a4 as Ja,a5 as Xa,a6 as zn,a7 as Bn,a8 as Qa,a9 as Un,aa as Vn,ab as Za,ac as Wn,ad as er,ae as tr,af as sr,ag as ar,ah as rr,ai as Hn,aj as nr,ak as Gn,al as or,am as ir,an as lr,ao as Kn}from"./radix-w2nuJgPN.js";import{a as Jt,r as c,R as U,v as Yn}from"./vendor-DBpFvjuy.js";import{_ as Is}from"./supabase-BJjf9Ixn.js";import{d as L,u as Ee,a as Rt,t as Vt,b as ye,i as qn}from"./sync-Bq-7cJrZ.js";import{t as Jn,c as Xn,a as Xt}from"./utils--BulIq_u.js";import{C as Qt,a as Ke,b as cr,S as Qn,I as dr,X as tt,c as Zn,E as eo,P as to,d as so,e as js,f as ao,g as ur,T as mr,F as Yt,h as _s,i as He,H as Ws,j as ut,D as mt,k as Hs,l as gr,m as Ss,n as Ms,o as ro,p as no,B as oo,q as io,r as lo,Z as fr,s as co,L as uo,t as mo,u as De,v as Ns,w as Ht,x as Gs,R as ze,y as hr,z as go,A as fo,G as gt,J as Tt,K as At,W as pr,M as Fs,N as ho,O as po,Q as yo,U as Ks,V as xo,Y as wo,_ as Ys,$ as bo,a0 as vo,a1 as Co,a2 as jo,a3 as So}from"./icons-BeqAji3n.js";import{u as No,i as ko,M as Eo,a as Do,b as Ro,c as To,d as Ao,e as Io,f as _o,g as Mo,h as Fo,j as Oo,E as Po}from"./editor-yCnBQ_u8.js";import"./database-Ddn5sgg-.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();var ks={},qs=Jt;ks.createRoot=qs.createRoot,ks.hydrateRoot=qs.hydrateRoot;class Nt{static PREFIX="cardall_";static VERSION="1.0";static setItem(e,t,r={}){try{const n=this.PREFIX+e,o={version:this.VERSION,timestamp:Date.now(),data:t,meta:{ttl:r.ttl,encrypted:r.encrypt||!1,compressed:r.compress||!1}};if(r.validate){const l=this.validateData(t);if(!l.isValid)return console.warn("Storage validation failed:",l.errors),!1}let i;try{i=this.serializeData(o)}catch(l){return console.error("Data serialization failed:",l),!1}return r.encrypt&&(i=this.encryptData(i)),r.compress&&(i=this.compressData(i)),localStorage.setItem(n,i),!0}catch(n){return console.error("Failed to store data securely:",n),!1}}static getItem(e,t={}){try{const r=this.PREFIX+e,n=localStorage.getItem(r);if(!n)return null;let o=n;t.compress&&(o=this.decompressData(o)),t.encrypt&&(o=this.decryptData(o));const i=this.deserializeData(o);if(i.version!==this.VERSION)return console.warn("Storage data version mismatch"),null;if(i.meta.ttl&&Date.now()-i.timestamp>i.meta.ttl)return console.log("Storage data expired, removing"),this.removeItem(e),null;if(t.validate){const l=this.validateData(i.data);if(!l.isValid)return console.warn("Retrieved data validation failed:",l.errors),null}return i.data}catch(r){return console.error("Failed to retrieve data securely:",r),null}}static removeItem(e){try{const t=this.PREFIX+e;localStorage.removeItem(t)}catch(t){console.error("Failed to remove storage item:",t)}}static clearAppData(){try{Object.keys(localStorage).forEach(t=>{t.startsWith(this.PREFIX)&&localStorage.removeItem(t)})}catch(e){console.error("Failed to clear app data:",e)}}static validateData(e){const t={isValid:!0,errors:[],warnings:[],sanitized:e};return e==null?t:this.hasPrototypePollution(e)?(t.isValid=!1,t.errors.push("Potential prototype pollution detected"),t):(this.hasCircularReference(e)&&(t.warnings.push("Circular reference detected in data"),t.sanitized=this.removeCircularReferences(e)),this.hasDangerousFunctions(e)?(t.isValid=!1,t.errors.push("Dangerous functions detected in data"),t):(this.estimateDataSize(e)>5*1024*1024&&t.warnings.push("Large data size may impact performance"),t))}static hasPrototypePollution(e){if(typeof e!="object"||e===null)return!1;const t=e;return["__proto__","constructor","prototype"].some(n=>n in t)}static hasCircularReference(e,t=new WeakSet){return typeof e!="object"||e===null?!1:t.has(e)?!0:(t.add(e),Array.isArray(e)?e.some(r=>this.hasCircularReference(r,t)):Object.values(e).some(r=>typeof r=="object"&&this.hasCircularReference(r,t)))}static removeCircularReferences(e,t=new WeakSet){if(typeof e!="object"||e===null)return e;if(t.has(e))return"[Circular]";if(t.add(e),Array.isArray(e))return e.map(n=>this.removeCircularReferences(n,t));const r={};for(const[n,o]of Object.entries(e))r[n]=this.removeCircularReferences(o,t);return r}static hasDangerousFunctions(e){if(typeof e!="object"||e===null)return!1;const t=e;if(Object.values(t).some(o=>typeof o=="function"))return!0;const r=["eval","Function","setTimeout","setInterval","document","window","global","process"],n=JSON.stringify(t).toLowerCase();return r.some(o=>n.includes(o.toLowerCase()))}static estimateDataSize(e){return new Blob([JSON.stringify(e)]).size}static serializeData(e){return JSON.stringify(e,(r,n)=>{if(typeof n!="function")return n===void 0?null:n instanceof Date?{__type:"Date",value:n.toISOString()}:n instanceof RegExp?{__type:"RegExp",value:n.toString()}:n})}static deserializeData(e){return JSON.parse(e,(r,n)=>{if(typeof n=="object"&&n!==null){const o=n;if(o.__type==="Date"&&typeof o.value=="string")return new Date(o.value);if(o.__type==="RegExp"&&typeof o.value=="string"){const i=o.value.match(/^\/(.*)\/([gim]*)$/);if(i)return new RegExp(i[1],i[2])}}return n})}static encryptData(e){const t="cardall-secure-key";let r="";for(let n=0;n<e.length;n++){const o=e.charCodeAt(n)^t.charCodeAt(n%t.length);r+=String.fromCharCode(o)}return btoa(r)}static decryptData(e){const t="cardall-secure-key",r=atob(e);let n="";for(let o=0;o<r.length;o++){const i=r.charCodeAt(o)^t.charCodeAt(o%t.length);n+=String.fromCharCode(i)}return n}static compressData(e){return e}static decompressData(e){return e}static getStorageStats(){try{const t=Object.keys(localStorage).filter(o=>o.startsWith(this.PREFIX));let r=0;const n=[];return t.forEach(o=>{const i=localStorage.getItem(o);if(i){const l=new Blob([i]).size;r+=l,n.push({key:o.replace(this.PREFIX,""),size:l,lastModified:Date.now()})}}),{totalSize:r,itemCount:t.length,items:n}}catch(e){return console.error("Failed to get storage stats:",e),{totalSize:0,itemCount:0,items:[]}}}}const X={set:(a,e,t)=>Nt.setItem(a,e,t),get:(a,e)=>Nt.getItem(a,e),remove:a=>Nt.removeItem(a),clear:()=>Nt.clearAppData(),getStats:()=>Nt.getStorageStats()};class je{static dbCardToCard(e){const{userId:t,syncVersion:r,lastSyncAt:n,pendingSync:o,...i}=e;return{...i,id:i.id||"",createdAt:this.ensureDate(i.createdAt),updatedAt:this.ensureDate(i.updatedAt)}}static cardToDbCard(e,t){return{id:e.id,frontContent:e.frontContent,backContent:e.backContent,style:e.style,isFlipped:e.isFlipped,createdAt:this.ensureDate(e.createdAt),updatedAt:this.ensureDate(e.updatedAt),userId:t,syncVersion:1,pendingSync:!0,lastSyncAt:void 0}}static bulkDbCardsToCards(e){return e.map(t=>this.dbCardToCard(t))}static bulkCardsToDbCards(e,t){return e.map(r=>this.cardToDbCard(r,t))}static ensureDate(e){if(!e)return new Date;if(e instanceof Date)return e;try{return new Date(e)}catch{return new Date}}static validateCard(e){const t=[];return e.id||t.push("Card ID is required"),e.frontContent?.title||t.push("Front content title is required"),e.backContent?.title||t.push("Back content title is required"),e.createdAt||t.push("Created date is required"),e.updatedAt||t.push("Updated date is required"),{valid:t.length===0,errors:t}}static sanitizeCard(e){const t={};return e.id&&(t.id=e.id),e.frontContent&&(t.frontContent={title:String(e.frontContent.title||"").trim(),text:String(e.frontContent.text||"").trim(),images:Array.isArray(e.frontContent.images)?e.frontContent.images:[],tags:Array.isArray(e.frontContent.tags)?e.frontContent.tags.map(r=>String(r).trim()).filter(r=>r.length>0):[],lastModified:e.frontContent.lastModified||new Date}),e.backContent&&(t.backContent={title:String(e.backContent.title||"").trim(),text:String(e.backContent.text||"").trim(),images:Array.isArray(e.backContent.images)?e.backContent.images:[],tags:Array.isArray(e.backContent.tags)?e.backContent.tags.map(r=>String(r).trim()).filter(r=>r.length>0):[],lastModified:e.backContent.lastModified||new Date}),e.style&&(t.style={type:e.style.type||"solid",backgroundColor:e.style.backgroundColor||"#ffffff",fontFamily:e.style.fontFamily||"system-ui",fontSize:e.style.fontSize||"base",fontWeight:e.style.fontWeight||"normal",textColor:e.style.textColor||"#000000",borderRadius:e.style.borderRadius||"md",shadow:e.style.shadow||"none",borderWidth:e.style.borderWidth||0,gradientColors:e.style.gradientColors||void 0,gradientDirection:e.style.gradientDirection||"to-r"}),e.createdAt&&(t.createdAt=this.ensureDate(e.createdAt)),e.updatedAt&&(t.updatedAt=this.ensureDate(e.updatedAt)),t}static loadFromLocalStorage(){try{const e=X.get("cards",{validate:!0,encrypt:!0});if(!e)return[];const t=[];for(const r of e){const n=this.sanitizeCard(r),o=this.validateCard(n);o.valid?t.push(n):console.warn("Invalid card in localStorage:",r,o.errors)}return t}catch(e){return console.error("Failed to load cards from localStorage:",e),[]}}static saveToLocalStorage(e){try{const t=e.map(r=>this.sanitizeCard(r)).filter(r=>this.validateCard(r).valid);X.set("cards",t)}catch(t){throw console.error("Failed to save cards to localStorage:",t),new Error(`Failed to save to localStorage: ${t instanceof Error?t.message:String(t)}`)}}static areCardsEqual(e,t){const r=JSON.stringify(this.sanitizeCard(e)),n=JSON.stringify(this.sanitizeCard(t));return r===n}static detectCardChanges(e,t){const r=new Map(e.map(m=>[m.id,m])),n=new Map(t.map(m=>[m.id,m])),o=[],i=[],l=[];for(const[m,u]of n){const d=r.get(m);d?this.areCardsEqual(d,u)||i.push(u):o.push(u)}for(const[m,u]of r)n.has(m)||l.push(u);return{added:o,updated:i,deleted:l}}static migrateLegacyData(e){try{if(this.isStandardCardFormat(e))return Array.isArray(e)?e:[e];const t=[];if(Array.isArray(e))for(const r of e){const n=this.migrateLegacyCard(r);n&&t.push(n)}else{const r=this.migrateLegacyCard(e);r&&t.push(r)}return t}catch(t){return console.error("Failed to migrate legacy data:",t),[]}}static migrateLegacyCard(e){try{const t={id:e.id||crypto.randomUUID(),frontContent:{title:e.frontTitle||e.title||"",text:e.frontText||e.text||"",images:e.frontImages||e.images||[],tags:e.frontTags||e.tags||[],lastModified:e.lastModified||new Date},backContent:{title:e.backTitle||e.backTitle||"",text:e.backText||e.backText||"",images:e.backImages||[],tags:e.backTags||[],lastModified:e.lastModified||new Date},style:e.style||{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#000000",borderRadius:"md",shadow:"none",borderWidth:0},isFlipped:e.isFlipped||!1,createdAt:this.ensureDate(e.createdAt||e.created||new Date),updatedAt:this.ensureDate(e.updatedAt||e.updated||new Date)},r=this.sanitizeCard(t);return this.validateCard(r).valid?r:null}catch(t){return console.error("Failed to migrate legacy card:",t),null}}static isStandardCardFormat(e){return!e||typeof e!="object"?!1:["id","frontContent","backContent","createdAt","updatedAt"].every(r=>r in e)}static generateCardChecksum(e){const t=this.sanitizeCard(e),r=JSON.stringify(t);let n=0;for(let o=0;o<r.length;o++){const i=r.charCodeAt(o);n=(n<<5)-n+i,n=n&n}return Math.abs(n).toString(16)}static compressCardData(e){const t=e.map(r=>{const n=this.sanitizeCard(r);return{i:n.id,ft:n.frontContent.title,ftx:n.frontContent.text,ftg:n.frontContent.tags,bt:n.backContent.title,btx:n.backContent.text,btg:n.backContent.tags,s:n.style,f:n.isFlipped,ca:n.createdAt.getTime(),ua:n.updatedAt.getTime()}});return JSON.stringify(t)}static decompressCardData(e){try{return JSON.parse(e).map(r=>({id:r.i,frontContent:{title:r.ft||"",text:r.ftx||"",images:[],tags:r.ftg||[],lastModified:new Date},backContent:{title:r.bt||"",text:r.btx||"",images:[],tags:r.btg||[],lastModified:new Date},style:r.s||{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#000000",borderRadius:"md",shadow:"none",borderWidth:0},isFlipped:r.f||!1,createdAt:new Date(r.ca),updatedAt:new Date(r.ua)}))}catch(t){return console.error("Failed to decompress card data:",t),[]}}}const Os={autoMigration:!0,backupOnMigration:!0,compressionEnabled:!0,cacheEnabled:!0,cacheSize:1e3,syncEnabled:!0,debugMode:!1,performanceMonitoring:!0,maxRetries:3,timeout:3e4};function yr(a){const e={...Os,...a},t=[],r=[];return(e.cacheSize<0||e.cacheSize>1e4)&&t.push("cacheSize must be between 0 and 10000"),(e.timeout<1e3||e.timeout>3e5)&&r.push("timeout should be between 1000ms and 300000ms"),(e.maxRetries<0||e.maxRetries>10)&&t.push("maxRetries must be between 0 and 10"),{valid:t.length===0,errors:t,warnings:r,config:e}}function ce(a,e,t){return{code:a,message:e,details:t,timestamp:new Date,stack:new Error().stack}}class Es{static instance=null;static async create(e){if(this.instance)return this.instance;const t=yr(e||{});if(!t.valid)throw ce("INVALID_CONFIG","Invalid storage configuration",{errors:t.errors});try{const{UniversalStorageAdapter:r}=await Is(async()=>{const{UniversalStorageAdapter:n}=await Promise.resolve().then(()=>$o);return{UniversalStorageAdapter:n}},void 0);this.instance=new r(t.config)}catch(r){throw ce("IMPORT_ERROR","Failed to import storage adapter implementation",{importError:r instanceof Error?r.message:String(r)})}return this.instance}static getInstance(){return this.instance}static resetInstance(){this.instance=null}}const Lo=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_STORAGE_CONFIG:Os,StorageAdapterFactory:Es,createStorageError:ce,validateStorageConfig:yr},Symbol.toStringTag,{value:"Module"}));class Ve{name="UniversalStorageAdapter";version="1.0.0";static instance;storageMode="localStorage";config;eventListeners=new Map;STORAGE_MODE_KEY="cardall_storage_mode";MIGRATION_STATUS_KEY="cardall_migration_status";progressCallbacks=new Set;cancelToken=null;constructor(e=Os){this.config=e,this.initializeStorageMode(),this.setupEventListeners()}static getInstance(){return Ve.instance||(Ve.instance=new Ve),Ve.instance}initializeStorageMode(){try{const e=X.get(this.STORAGE_MODE_KEY);e?this.storageMode=e:(this.storageMode="localStorage",this.saveStorageMode())}catch(e){console.warn("Failed to initialize storage mode:",e),this.storageMode="localStorage"}}saveStorageMode(){try{X.set(this.STORAGE_MODE_KEY,this.storageMode),this.emitEvent({type:"storageModeChanged",timestamp:new Date,data:{mode:this.storageMode}})}catch(e){console.error("Failed to save storage mode:",e)}}getStorageMode(){return this.storageMode}async switchStorageMode(e,t){if(this.storageMode===e)return this.notifyProgress({phase:"completed",percentage:100,message:`Already in ${e} mode`,timestamp:new Date}),{success:!0,message:"Already in requested mode",fromMode:this.storageMode,toMode:e,dataMigrated:!1,rollbackPerformed:!1,validation:{isValid:!0,issues:[]}};const r=this.storageMode,n=Date.now();let o,i=!1,l=!1;const m=[];t?.onProgress&&this.progressCallbacks.add(t.onProgress),this.cancelToken={cancelled:!1};try{this.notifyProgress({phase:"preparing",percentage:5,message:`准备从 ${r} 切换到 ${e}...`,timestamp:new Date}),this.notifyProgress({phase:"validating",percentage:15,message:"验证切换条件...",timestamp:new Date});const u=await this.validatePreSwitchConditions(e);if(!u.isValid)throw this.notifyProgress({phase:"failed",percentage:20,message:`切换前验证失败: ${u.issues.join(", ")}`,details:{issues:u.issues},timestamp:new Date}),new Error(`Pre-switch validation failed: ${u.issues.join(", ")}`);if(this.checkCancellation())throw new Error("Switch cancelled by user");this.config.backupOnMigration&&!t?.skipBackup&&(this.notifyProgress({phase:"backing-up",percentage:30,message:"创建数据备份...",timestamp:new Date}),o=await this.backupData(),this.notifyProgress({phase:"backing-up",percentage:45,message:`备份创建成功: ${o.id}`,details:{backupId:o.id},timestamp:new Date}));const d=e==="indexeddb"&&(await this.hasDataToMigrate()||t?.forceMigration);if(d){this.notifyProgress({phase:"migrating",percentage:50,message:"开始数据迁移...",timestamp:new Date});const S=await this.migrateFromLocalStorage();if(!S.success)throw this.notifyProgress({phase:"failed",percentage:60,message:`数据迁移失败: ${S.errors.join(", ")}`,details:{errors:S.errors},timestamp:new Date}),new Error(`Migration failed: ${S.errors.join(", ")}`);i=!0,this.notifyProgress({phase:"migrating",percentage:70,message:`数据迁移完成: ${S.migratedCards} 张卡片`,details:{migratedCards:S.migratedCards,totalCards:S.totalCards},timestamp:new Date})}if(this.checkCancellation())throw new Error("Switch cancelled by user");this.notifyProgress({phase:"switching",percentage:80,message:`切换存储模式到 ${e}...`,timestamp:new Date}),this.storageMode=e,this.saveStorageMode(),this.notifyProgress({phase:"validating-after",percentage:85,message:"验证切换后数据完整性...",timestamp:new Date});const y=await this.validatePostSwitchConditions(e,r);if(!y.isValid)throw this.notifyProgress({phase:"failed",percentage:90,message:`切换后验证失败: ${y.issues.join(", ")}`,details:{issues:y.issues},timestamp:new Date}),new Error(`Post-switch validation failed: ${y.issues.join(", ")}`);d&&i&&(this.notifyProgress({phase:"cleaning-up",percentage:95,message:"清理旧数据...",timestamp:new Date}),await this.cleanupOldData(r));const h=Date.now()-n;this.notifyProgress({phase:"completed",percentage:100,message:`存储模式切换成功完成，耗时 ${h}ms`,details:{duration:h,dataMigrated:i,fromMode:r,toMode:e},timestamp:new Date}),this.emitEvent({type:"storageModeChanged",timestamp:new Date,data:{fromMode:r,toMode:e,dataMigrated:i,duration:h}});const g={success:!0,message:`Successfully switched from ${r} to ${e}`,fromMode:r,toMode:e,dataMigrated:i,rollbackPerformed:l,duration:h,backup:o,validation:y,progress:m};return this.recordSwitchHistory(g),g}catch(u){if(console.error("Storage mode switch failed:",u),this.notifyProgress({phase:"failed",percentage:0,message:`存储模式切换失败: ${u instanceof Error?u.message:String(u)}`,timestamp:new Date}),o){this.notifyProgress({phase:"rolling-back",percentage:50,message:"正在回滚到原始状态...",timestamp:new Date}),console.log("Attempting rollback...");const h=await this.performRollback(r,o);l=h,h?(this.notifyProgress({phase:"rolled-back",percentage:100,message:"回滚成功",timestamp:new Date}),console.log("Rollback completed successfully")):(this.notifyProgress({phase:"rollback-failed",percentage:100,message:"回滚失败 - 可能需要手动干预",timestamp:new Date}),console.error("Rollback failed - manual intervention may be required"))}else console.log("No backup available, reverting to original mode..."),this.storageMode=r,this.saveStorageMode();const d=u instanceof Error?u.message:String(u);this.emitEvent({type:"error",timestamp:new Date,data:{error:"StorageModeSwitchFailed",details:{fromMode:r,toMode:e,error:d,rollbackPerformed:l}},error:u instanceof Error?u:new Error(d)});const y={success:!1,message:`Failed to switch storage mode: ${d}`,fromMode:r,toMode:e,dataMigrated:i,rollbackPerformed:l,validation:{isValid:!1,issues:[d]},progress:m};throw this.recordSwitchHistory(y),ce("STORAGE_MODE_SWITCH_FAILED",`Failed to switch storage mode: ${d}`,{fromMode:r,toMode:e,error:d,rollbackPerformed:l})}finally{t?.onProgress&&this.progressCallbacks.delete(t.onProgress),this.cancelToken=null}}async setStorageMode(e){try{const t=await this.switchStorageMode(e);if(!t.success)throw new Error(t.message)}catch(t){throw this.storageMode!==e&&(this.storageMode=e==="indexeddb"?"localStorage":"indexeddb",this.saveStorageMode()),t}}cancelStorageModeSwitch(e="用户取消"){this.cancelToken&&(this.cancelToken.cancelled=!0,this.cancelToken.reason=e,this.notifyProgress({phase:"cancelled",percentage:0,message:`操作已取消: ${e}`,timestamp:new Date}))}checkCancellation(){return this.cancelToken?.cancelled||!1}notifyProgress(e){this.progressCallbacks.forEach(t=>{try{t(e)}catch(r){console.warn("Progress callback error:",r)}}),this.emitEvent({type:"storageModeSwitchProgress",timestamp:new Date,data:e})}isSwitchInProgress(){return this.cancelToken!==null}async getStorageModeStats(){try{const e=X.get("storage_switch_history",[])||[],t=e.length,r=e[e.length-1],n=e.filter(y=>y.success===!1).length,o=typeof localStorage<"u",i=await this.isIndexedDBAvailable();let l=0,m=0,u=0,d=0;try{const y=X.get("cards",{validate:!0,encrypt:!0});y&&(l=y.length,u=JSON.stringify(y).length)}catch(y){console.warn("Failed to check localStorage data:",y)}try{if(i){m=await L.cards.count();const y=await L.cards.toArray();d=JSON.stringify(y).length}}catch(y){console.warn("Failed to check IndexedDB data:",y)}return{currentMode:this.storageMode,switchCount:t,lastSwitchTime:r?.timestamp?new Date(r.timestamp):void 0,lastSwitchDuration:r?.duration,failedSwitches:n,availableStorage:{localStorage:o,indexedDB:i},dataDistribution:{localStorageCards:l,indexedDBCards:m,localStorageSize:u,indexedDBSize:d}}}catch(e){throw console.error("Failed to get storage mode stats:",e),ce("GET_STORAGE_STATS_FAILED","Failed to get storage mode statistics",{error:e instanceof Error?e.message:String(e)})}}recordSwitchHistory(e){try{const t=X.get("storage_switch_history",[])||[];t.push({timestamp:new Date().toISOString(),fromMode:e.fromMode,toMode:e.toMode,success:e.success,duration:e.duration,dataMigrated:e.dataMigrated,rollbackPerformed:e.rollbackPerformed,message:e.message}),t.length>50&&t.splice(0,t.length-50),X.set("storage_switch_history",t)}catch(t){console.warn("Failed to record switch history:",t)}}clearSwitchHistory(){try{X.remove("storage_switch_history"),console.log("Storage switch history cleared")}catch(e){console.warn("Failed to clear switch history:",e)}}async getRecommendedStorageMode(){const e=[];try{const t=await this.getStorageModeStats(),r=t.availableStorage.indexedDB,n=t.availableStorage.localStorage;return r?t.dataDistribution.localStorageSize+t.dataDistribution.indexedDBSize>5*1024*1024?{recommendedMode:"indexeddb",reason:"Large data volume detected, IndexedDB is more suitable",confidence:"high",issues:[]}:t.failedSwitches===0||t.failedSwitches/t.switchCount<.2?{recommendedMode:t.currentMode,reason:"Current storage mode is working well",confidence:"medium",issues:[]}:{recommendedMode:"indexeddb",reason:"IndexedDB offers better performance and reliability",confidence:"medium",issues:[]}:{recommendedMode:"localStorage",reason:"IndexedDB is not available in this browser",confidence:"high",issues:["IndexedDB not supported"]}}catch(t){return e.push(`Failed to analyze storage recommendations: ${t instanceof Error?t.message:String(t)}`),{recommendedMode:"localStorage",reason:"Failed to analyze, using safe option",confidence:"low",issues:e}}}async validatePreSwitchConditions(e){const t=[],r=[],n={};try{if(e==="indexeddb"){const l=await this.isIndexedDBAvailable();l||t.push("IndexedDB is not available in this environment"),n.indexedDBAvailable=l}const o=await this.validateDataIntegrity();if(o.isValid||(t.push("Current data integrity check failed"),t.push(...o.issues)),n.currentDataValidation=o,e==="indexeddb"&&await this.hasDataToMigrate()){const l=await this.getCards(),m=JSON.stringify(l).length;if(navigator.storage&&navigator.storage.estimate)try{const u=await navigator.storage.estimate(),d=(u.quota||0)-(u.usage||0);d<m*2&&r.push("Available storage space may be insufficient"),n.storageQuota={total:u.quota,used:u.usage,available:d,required:m}}catch{r.push("Unable to estimate storage space")}}const i=this.checkBrowserCompatibility(e);return i.compatible||t.push(...i.issues),n.browserCompatibility=i,{isValid:t.length===0,issues:t,warnings:r.length>0?r:void 0,details:n}}catch(o){return{isValid:!1,issues:[`Pre-switch validation error: ${o instanceof Error?o.message:String(o)}`],warnings:r.length>0?r:void 0,details:n}}}async validatePostSwitchConditions(e,t){const r=[],n=[],o={};try{const i=Date.now();await this.getCards(),o.dataAccessTime=Date.now()-i;const l=await this.validateDataIntegrity(e);if(l.isValid||(r.push("New mode data integrity check failed"),r.push(...l.issues)),o.newDataValidation=l,t==="localStorage"&&e==="indexeddb"){const u=await this.validateMigrationConsistency();u.isValid||(r.push("Data consistency check failed"),r.push(...u.issues)),o.consistencyCheck=u}const m=await this.validateStoragePerformance(e);return m.warnings.length>0&&n.push(...m.warnings),o.performanceCheck=m,{isValid:r.length===0,issues:r,warnings:n.length>0?n:void 0,details:o}}catch(i){return{isValid:!1,issues:[`Post-switch validation error: ${i instanceof Error?i.message:String(i)}`],warnings:n.length>0?n:void 0,details:o}}}async performRollback(e,t){const r=Date.now();console.log(`Starting enhanced rollback to ${e}...`);try{console.log("Phase 1: Pre-rollback state check...");const n=this.storageMode,o=await this.getStats();console.log(`Current state: ${n}, ${o.totalCards} cards`),console.log("Phase 2: Creating pre-rollback safety backup...");const i=await this.createSafetyBackup();console.log(`Safety backup created: ${i?.id||"N/A"}`),console.log("Phase 3: Setting temporary storage mode...");const l=n;this.storageMode="rollback_temp",this.saveStorageMode(),console.log("Phase 4: Validating backup integrity...");const m=await this.validateBackupIntegrity(t);if(!m.isValid)throw new Error(`Backup integrity validation failed: ${m.issues.join(", ")}`);console.log("Phase 5: Restoring storage mode..."),this.storageMode=e,this.saveStorageMode(),console.log("Phase 6: Restoring data...");const u=await this.enhancedRestoreData(t);if(!u.success)throw new Error(`Data restoration failed: ${u.issues.join(", ")}`);console.log(`Restored ${u.restoredCards} cards`),console.log("Phase 7: Post-rollback validation...");const d=await this.validateDataIntegrity(e);if(!d.isValid&&(console.warn(`Post-rollback validation issues: ${d.issues.join(", ")}`),d.corruptedCards.length>0)){console.log("Attempting data repair...");const h=await this.repairDataIntegrity();if(console.log(`Repair result: ${h.repaired?"SUCCESS":"FAILED"}`),!h.repaired)throw new Error(`Post-rollback data repair failed: ${h.issues.join(", ")}`)}i&&(console.log("Phase 8: Cleaning up safety backup..."),await this.cleanupSafetyBackup(i.id));const y=Date.now()-r;return console.log(`Enhanced rollback completed successfully in ${y}ms`),this.emitEvent({type:"backupRestored",timestamp:new Date,data:{backupId:t.id,rollback:!0,duration:y,restoredCards:u.restoredCards,targetMode:e}}),!0}catch(n){const o=`Rollback failed: ${n instanceof Error?n.message:String(n)}`;console.error(o);try{console.log("Attempting emergency recovery..."),this.storageMode=e,this.saveStorageMode(),this.emitEvent({type:"error",timestamp:new Date,data:{error:"RollbackFailed",details:{targetMode:e,error:o,emergencyRecovery:!0}},error:n instanceof Error?n:new Error(o)})}catch(i){console.error("Emergency recovery also failed:",i)}return!1}}async createSafetyBackup(){try{const e=await this.getCards(),t={timestamp:new Date().toISOString(),version:this.version,purpose:"rollback_safety",cards:e},r=JSON.stringify(t),n=`safety_backup_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;X.set(n,t);const o=await this.calculateChecksum(r);return{id:n,data:r,timestamp:new Date,version:this.version,cardCount:e.length,checksum:o}}catch(e){return console.warn("Failed to create safety backup:",e),null}}async validateBackupIntegrity(e){const t=[],r={};try{const n=await this.calculateChecksum(e.data);r.checksumMatch=n===e.checksum,r.backupChecksum=e.checksum,r.currentChecksum=n,n!==e.checksum&&t.push("Backup checksum mismatch - data may be corrupted");try{const i=JSON.parse(e.data);if(r.dataFormatValid=!0,!i.cards||!Array.isArray(i.cards))t.push("Invalid backup data format - missing or invalid cards array"),r.cardsValid=!1;else{r.cardsValid=!0,r.cardCount=i.cards.length;const l=Math.min(5,i.cards.length),m=i.cards.slice(0,l),u=[];for(let d=0;d<m.length;d++){const y=m[d],h=this.validateCardStructure(y);h.length>0&&u.push(`Card at index ${d}: ${h.join(", ")}`)}u.length>0?(t.push(`Card structure issues found: ${u.join("; ")}`),r.structureIssues=u):r.structureValid=!0}}catch(i){t.push(`Backup data parsing failed: ${i instanceof Error?i.message:String(i)}`),r.dataFormatValid=!1}const o=Date.now()-e.timestamp.getTime();return r.backupAgeMs=o,r.backupAgeHours=o/(1e3*60*60),o>24*60*60*1e3&&t.push("Backup is more than 24 hours old"),{isValid:t.length===0,issues:t,details:r}}catch(n){return t.push(`Backup validation failed: ${n instanceof Error?n.message:String(n)}`),{isValid:!1,issues:t,details:r}}}async enhancedRestoreData(e){const t=[];let r=0;try{const n=JSON.parse(e.data);if(!n.cards||!Array.isArray(n.cards))throw new Error("Invalid backup data format");if(console.log("Clearing current data..."),this.storageMode==="indexeddb"&&await L.cards.clear(),X.remove("cards"),console.log(`Restoring ${n.cards.length} cards...`),this.storageMode==="indexeddb"){const i=n.cards.map(l=>this.convertToDbCard(l));try{await L.cards.bulkAdd(i),r=i.length}catch(l){console.warn("Bulk restore failed, trying individual restore..."),t.push(`Bulk restore failed: ${l instanceof Error?l.message:String(l)}`),r=0;for(const m of n.cards)try{const u=this.convertToDbCard(m);await L.cards.add(u),r++}catch(u){t.push(`Failed to restore card ${m.id}: ${u instanceof Error?u.message:String(u)}`)}}}else X.set("cards",n.cards),r=n.cards.length;const o=await this.validateDataIntegrity(this.storageMode);return o.isValid?console.log(`Data integrity check passed for ${o.cardCount} cards`):t.push(...o.issues.map(i=>`Validation: ${i}`)),{success:t.length===0||r>0&&t.length<r*.1,restoredCards:r,issues:t}}catch(n){return t.push(`Enhanced restore failed: ${n instanceof Error?n.message:String(n)}`),{success:!1,restoredCards:r,issues:t}}}async cleanupSafetyBackup(e){try{X.remove(e),console.log(`Safety backup ${e} cleaned up`)}catch(t){console.warn(`Failed to cleanup safety backup ${e}:`,t)}}async cleanupOldData(e){try{if(e==="localStorage"){const t=X.get("cards",{validate:!0,encrypt:!0});t&&t.length>0&&(console.log("Cleaning up localStorage data..."),X.remove("cards"),console.log("localStorage data cleaned up"))}else e==="indexeddb"&&await this.hasIndexedDBData()&&(console.log("Cleaning up IndexedDB data..."),await L.cards.clear(),console.log("IndexedDB data cleaned up"))}catch(t){console.warn("Failed to cleanup old data:",t)}}async validateMigrationConsistency(){const e=[],t=[],r={};try{console.log("Starting migration consistency validation...");const n=await L.cards.count();r.indexedDBCount=n;const o=X.get("cards",{validate:!0,encrypt:!0});if(r.localStorageCards=o?.length||0,o&&o.length>0){n!==o.length&&e.push(`Card count mismatch: IndexedDB has ${n}, localStorage had ${o.length}`);const l=Math.min(10,o.length),m=o.slice(0,l),u={};for(const g of m){const S={id:g.id,title:g.frontContent.title,found:!1,contentMatch:!1,tagsMatch:!1,timestampMatch:!1};try{const N=await L.cards.get(g.id);if(!N){e.push(`Card ${g.id} not found in IndexedDB`),S.found=!1,u[g.id]=S;continue}S.found=!0;const E=this.convertFromDbCard(N),v=E.frontContent.title===g.frontContent.title,f=E.backContent.title===g.backContent.title;S.contentMatch=v&&f;const p=E.frontContent.text===g.frontContent.text&&E.backContent.text===g.backContent.text;S.contentMatch=S.contentMatch&&p;const x=JSON.stringify(E.frontContent.tags.sort())===JSON.stringify(g.frontContent.tags.sort()),b=JSON.stringify(E.backContent.tags.sort())===JSON.stringify(g.backContent.tags.sort());S.tagsMatch=x&&b;const C=E.createdAt.getTime()===g.createdAt.getTime()&&E.updatedAt.getTime()===g.updatedAt.getTime();S.timestampMatch=C,u[g.id]=S,S.found||e.push(`Card ${g.id} missing in IndexedDB`),S.contentMatch||e.push(`Content mismatch for card ${g.id}`),S.tagsMatch||t.push(`Tags mismatch for card ${g.id}`),S.timestampMatch||t.push(`Timestamp mismatch for card ${g.id}`)}catch(N){console.warn(`Error validating card ${g.id}:`,N),e.push(`Validation error for card ${g.id}: ${N instanceof Error?N.message:String(N)}`)}}r.sampleValidation=u;const d=Object.keys(u).length*4,y=Object.values(u).reduce((g,S)=>g+(S.found?1:0)+(S.contentMatch?1:0)+(S.tagsMatch?1:0)+(S.timestampMatch?1:0),0),h=d>0?y/d*100:0;r.consistencyScore=h,h<95&&t.push(`Migration consistency score is ${h.toFixed(1)}%`);try{const g=await L.cards.toArray(),S=new Set,N=new Set;g.forEach(E=>{S.has(E.id)?N.add(E.id):S.add(E.id)}),N.size>0&&e.push(`Found duplicate card IDs: ${Array.from(N).join(", ")}`)}catch(g){t.push(`Could not validate ID uniqueness: ${g instanceof Error?g.message:String(g)}`)}try{const g=await L.cards.toArray(),S=await this.validateDatabaseStructure(g);S.length>0&&e.push(...S)}catch(g){t.push(`Structure validation failed: ${g instanceof Error?g.message:String(g)}`)}}else o===null&&t.push("Original localStorage data not available for comparison");const i=e.length===0;return console.log(`Migration consistency validation completed: ${i?"PASS":"FAIL"}`),i||console.warn(`Found ${e.length} issues and ${t.length} warnings`),{isValid:i,issues:e,warnings:t.length>0?t:void 0,details:r}}catch(n){const o=`Migration consistency check failed: ${n instanceof Error?n.message:String(n)}`;return console.error(o),{isValid:!1,issues:[o],warnings:t.length>0?t:void 0,details:r}}}async validateDatabaseStructure(e){const t=[];try{for(let r=0;r<e.length;r++){const n=e[r],o=["id","frontContent","backContent","createdAt","updatedAt"];for(const i of o)i in n||t.push(`Card at index ${r} missing required field: ${i}`);if(typeof n.id!="string"&&t.push(`Card ${n.id} has invalid ID type`),n.frontContent&&typeof n.frontContent!="object"&&t.push(`Card ${n.id} has invalid frontContent type`),n.backContent&&typeof n.backContent!="object"&&t.push(`Card ${n.id} has invalid backContent type`),n.createdAt)try{new Date(n.createdAt)}catch{t.push(`Card ${n.id} has invalid createdAt format`)}if(n.updatedAt)try{new Date(n.updatedAt)}catch{t.push(`Card ${n.id} has invalid updatedAt format`)}}}catch(r){t.push(`Structure validation error: ${r instanceof Error?r.message:String(r)}`)}return t}async validateStoragePerformance(e){const t=[],r={};try{const n=Date.now();await this.getCards(),r.readTime=Date.now()-n;const o=await this.createCard({frontContent:{title:"Performance Test",text:"Test content",tags:[]},backContent:{title:"Performance Test Back",text:"Test back content",tags:[]},style:{type:"solid"},isFlipped:!1}),i=Date.now();return await this.updateCard(o.id,{frontContent:{...o.frontContent,text:"Updated test content"}}),r.writeTime=Date.now()-i,await this.deleteCard(o.id),e==="indexeddb"&&r.readTime>1e3&&t.push("IndexedDB read performance is slow"),e==="localStorage"&&r.readTime>500&&t.push("LocalStorage read performance is slow"),{warnings:t,metrics:r}}catch(n){return t.push(`Performance validation failed: ${n instanceof Error?n.message:String(n)}`),{warnings:t,metrics:r}}}checkBrowserCompatibility(e){const t=[],r={};try{if(r.localStorageSupported=typeof localStorage<"u",r.indexedDBSupported=typeof indexedDB<"u",r.serviceWorkerSupported="serviceWorker"in navigator,e==="indexeddb"){r.indexedDBSupported||t.push("IndexedDB is not supported in this browser");try{const n=indexedDB.open("test_db",1);r.indexedDBOpenable=!0,n.onsuccess=()=>{n.result.close(),indexedDB.deleteDatabase("test_db")}}catch{r.indexedDBOpenable=!1,t.push("IndexedDB cannot be opened in this browser")}}return e==="localStorage"&&!r.localStorageSupported&&t.push("LocalStorage is not supported in this browser"),{compatible:t.length===0,issues:t,details:r}}catch(n){return{compatible:!1,issues:[`Browser compatibility check failed: ${n instanceof Error?n.message:String(n)}`],details:r}}}async hasDataToMigrate(){if(this.storageMode==="indexeddb")return!1;const e=X.get("cards",{validate:!0,encrypt:!0});return e?e.length>0:!1}async migrateFromLocalStorage(){const e=Date.now();this.emitEvent({type:"migrationStarted",timestamp:new Date});try{if(!await this.hasDataToMigrate()){const l={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:[],duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationCompleted",timestamp:new Date,data:l}),l}const r=X.get("cards",{validate:!0,encrypt:!0});if(!r||r.length===0){const l={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:[],duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationCompleted",timestamp:new Date,data:l}),l}let n;this.config.backupOnMigration&&(n=await this.backupData());const o=await this.performMigration(r);if(await this.validateMigration(r.length)&&o.success){await this.setStorageMode("indexeddb"),o.errors.length===0&&this.cleanupLocalStorage();const l={...o,totalCards:r.length,duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationCompleted",timestamp:new Date,data:l}),l}else{n&&await this.restoreData(n);const l={success:!1,migratedCards:0,totalCards:r.length,errors:["Migration validation failed"],warnings:o.warnings,duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationFailed",timestamp:new Date,data:l,error:new Error("Migration validation failed")}),l}}catch(t){const r={success:!1,migratedCards:0,totalCards:0,errors:[t instanceof Error?t.message:"Unknown migration error"],warnings:[],duration:Date.now()-e,timestamp:new Date};return this.emitEvent({type:"migrationFailed",timestamp:new Date,data:r,error:t instanceof Error?t:new Error(String(t))}),r}}async performMigration(e){const t=[],r=[];let n=0;try{const o=e.map(i=>this.convertToDbCard(i));return await L.cards.bulkAdd(o),n=o.length,{success:!0,migratedCards:n,totalCards:e.length,errors:[],warnings:r,duration:0,timestamp:new Date}}catch(o){console.error("Bulk migration failed:",o);for(const l of e)try{const m=this.convertToDbCard(l);await L.cards.add(m),n++}catch(m){console.error(`Failed to migrate card ${l.id}:`,m),t.push(l.id)}const i=t.length===0;return i||r.push(`Some cards failed to migrate: ${t.length} out of ${e.length}`),{success:i,migratedCards:n,totalCards:e.length,errors:t,warnings:r,duration:0,timestamp:new Date}}}async validateMigration(e){try{return await L.cards.count()===e}catch(t){return console.error("Migration validation failed:",t),!1}}cleanupLocalStorage(){try{X.remove("cards")}catch(e){console.warn("Failed to cleanup localStorage:",e)}}async backupData(){const e=await this.getCards(),t={timestamp:new Date().toISOString(),version:this.version,cards:e},r=JSON.stringify(t),n=`backup_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;X.set(n,t);const o=await this.calculateChecksum(r),i={id:n,data:r,timestamp:new Date,version:this.version,cardCount:e.length,checksum:o};return this.emitEvent({type:"backupCreated",timestamp:new Date,data:i}),i}async restoreData(e){try{if(await this.calculateChecksum(e.data)!==e.checksum)throw new Error("Backup data integrity check failed");const r=JSON.parse(e.data);if(!r.cards||!Array.isArray(r.cards))throw new Error("Invalid backup data format");if(this.storageMode==="indexeddb"){const n=r.cards.map(o=>this.convertToDbCard(o));await L.cards.clear(),await L.cards.bulkAdd(n)}else X.set("cards",r.cards);return this.emitEvent({type:"backupRestored",timestamp:new Date,data:{backupId:e.id,cardCount:e.cardCount}}),!0}catch(t){return console.error("Restore failed:",t),!1}}async calculateChecksum(e){let t=0;for(let r=0;r<e.length;r++){const n=e.charCodeAt(r);t=(t<<5)-t+n,t=t&t}return Math.abs(t).toString(16)}convertToDbCard(e){return{id:e.id,frontContent:e.frontContent,backContent:e.backContent,style:e.style,createdAt:e.createdAt,updatedAt:e.updatedAt,userId:void 0,syncVersion:1,pendingSync:!0,lastSyncAt:void 0}}convertFromDbCard(e){const{userId:t,syncVersion:r,lastSyncAt:n,pendingSync:o,...i}=e;return{...i,id:i.id||"",isFlipped:!1,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)}}async getCards(e){try{if(this.storageMode==="indexeddb"){const r=(await L.cards.toArray()).map(n=>this.convertFromDbCard(n));return e?this.applyFilter(r,e):r}else{const t=X.get("cards",{validate:!0,encrypt:!0})||[];return e?this.applyFilter(t,e):t}}catch(t){throw ce("GET_CARDS_FAILED","Failed to get cards",{error:t instanceof Error?t.message:String(t)})}}applyFilter(e,t){return e.filter(r=>{if(t.searchTerm){const n=t.searchTerm.toLowerCase(),o=r.frontContent.title.toLowerCase().includes(n)||r.backContent.title.toLowerCase().includes(n),i=r.frontContent.text.toLowerCase().includes(n)||r.backContent.text.toLowerCase().includes(n);if(!o&&!i)return!1}if(t.tags&&t.tags.length>0){const n=[...r.frontContent.tags,...r.backContent.tags];if(!t.tags.some(i=>n.includes(i)))return!1}return!0})}async getCardById(e){try{if(this.storageMode==="indexeddb"){const t=await L.cards.get(e);return t?this.convertFromDbCard(t):null}else return(await this.getCards()).find(r=>r.id===e)||null}catch(t){throw ce("GET_CARD_FAILED",`Failed to get card ${e}`,{error:t instanceof Error?t.message:String(t)})}}async createCard(e){const t=new Date,r={...e,id:crypto.randomUUID(),createdAt:t,updatedAt:t};try{if(this.storageMode==="indexeddb"){const n=this.convertToDbCard(r);await L.cards.add(n)}else{const n=await this.getCards();n.push(r),await this.saveCards(n)}return this.emitEvent({type:"cardCreated",timestamp:new Date,data:{card:r}}),r}catch(n){throw ce("CREATE_CARD_FAILED","Failed to create card",{error:n instanceof Error?n.message:String(n)})}}async updateCard(e,t){try{if(this.storageMode==="indexeddb"){const r=await L.cards.get(e);if(!r)throw ce("CARD_NOT_FOUND",`Card ${e} not found`);const n={...r,...t,updatedAt:new Date};return await L.cards.put(n),this.convertFromDbCard(n)}else{const r=await this.getCards(),n=r.findIndex(o=>o.id===e);if(n===-1)throw ce("CARD_NOT_FOUND",`Card ${e} not found`);return r[n]={...r[n],...t,updatedAt:new Date},await this.saveCards(r),r[n]}}catch(r){throw ce("UPDATE_CARD_FAILED",`Failed to update card ${e}`,{error:r instanceof Error?r.message:String(r)})}}async deleteCard(e){try{if(this.storageMode==="indexeddb")await L.cards.delete(e);else{const r=(await this.getCards()).filter(n=>n.id!==e);await this.saveCards(r)}return this.emitEvent({type:"cardDeleted",timestamp:new Date,data:{cardId:e}}),!0}catch(t){throw ce("DELETE_CARD_FAILED",`Failed to delete card ${e}`,{error:t instanceof Error?t.message:String(t)})}}async saveCards(e){try{if(this.storageMode==="indexeddb"){const t=e.map(r=>this.convertToDbCard(r));await L.cards.clear(),await L.cards.bulkAdd(t)}else X.set("cards",e);this.emitEvent({type:"cardsChanged",timestamp:new Date,data:{cardCount:e.length}})}catch(t){throw ce("SAVE_CARDS_FAILED","Failed to save cards",{error:t instanceof Error?t.message:String(t)})}}async createCards(e){const t=new Date,r=e.map(n=>({...n,id:crypto.randomUUID(),createdAt:t,updatedAt:t}));try{if(this.storageMode==="indexeddb"){const n=r.map(o=>this.convertToDbCard(o));await L.cards.bulkAdd(n)}else{const n=await this.getCards();n.push(...r),await this.saveCards(n)}return r}catch(n){throw ce("CREATE_CARDS_FAILED","Failed to create cards",{error:n instanceof Error?n.message:String(n)})}}async updateCards(e){const t=[];try{if(this.storageMode==="indexeddb")for(const{id:r,updates:n}of e){const o=await this.updateCard(r,n);t.push(o)}else{const r=await this.getCards();for(const{id:n,updates:o}of e){const i=r.findIndex(l=>l.id===n);i!==-1&&(r[i]={...r[i],...o,updatedAt:new Date},t.push(r[i]))}await this.saveCards(r)}return t}catch(r){throw ce("UPDATE_CARDS_FAILED","Failed to update cards",{error:r instanceof Error?r.message:String(r)})}}async deleteCards(e){try{if(this.storageMode==="indexeddb")await L.cards.bulkDelete(e);else{const r=(await this.getCards()).filter(n=>!e.includes(n.id));await this.saveCards(r)}return!0}catch(t){throw ce("DELETE_CARDS_FAILED","Failed to delete cards",{error:t instanceof Error?t.message:String(t)})}}async searchCards(e,t){const r={...t,searchTerm:e};return this.getCards(r)}async getCardsByTag(e){const t={searchTerm:"",tags:[e]};return this.getCards(t)}async getCardsByFolder(e){return(await this.getCards()).filter(r=>r.folderId===e)}async getStats(){try{let e=0,t=0,r=0;if(this.storageMode==="indexeddb"){e=await L.cards.count();const i=await L.cards.toArray();r=JSON.stringify(i).length}else{const i=await this.getCards();e=i.length,t=JSON.stringify(i).length}const n=Math.max(t,r);return{totalCards:e,totalFolders:0,totalTags:0,totalSize:n,lastUpdated:new Date,storageMode:this.storageMode,indexedDBSize:r>0?r:void 0,localStorageSize:t>0?t:void 0}}catch(e){throw ce("GET_STATS_FAILED","Failed to get storage stats",{error:e instanceof Error?e.message:String(e)})}}async healthCheck(){const e=[],t=[];let r=100;try{if(await this.getCards(),this.storageMode==="indexeddb")try{await L.cards.count()}catch(n){e.push({level:"error",code:"INDEXEDDB_ACCESS_FAILED",message:"Cannot access IndexedDB",details:{error:n instanceof Error?n.message:String(n)}}),r-=40}try{X.get("test")}catch(n){e.push({level:"warning",code:"LOCALSTORAGE_ACCESS_FAILED",message:"Cannot access localStorage",details:{error:n instanceof Error?n.message:String(n)}}),r-=20}if(this.storageMode==="indexeddb"){const n=await this.getStats();n.totalSize>50*1024*1024&&(e.push({level:"warning",code:"LARGE_STORAGE_SIZE",message:"Storage size is large",details:{size:n.totalSize}}),r-=10,t.push("Consider archiving old cards"))}return{healthy:r>=70,score:Math.max(0,r),issues:e,recommendations:t,timestamp:new Date}}catch(n){return{healthy:!1,score:0,issues:[{level:"error",code:"HEALTH_CHECK_FAILED",message:"Health check failed",details:{error:n instanceof Error?n.message:String(n)}}],recommendations:["Check storage permissions and browser compatibility"],timestamp:new Date}}}getConfig(){return{...this.config}}async isIndexedDBAvailable(){try{if(typeof window>"u")return console.warn("IndexedDB not available: not in browser environment"),!1;if(!("indexedDB"in window))return console.warn("IndexedDB not available: indexedDB not supported in this browser"),!1;if(!window.indexedDB||typeof window.indexedDB.open!="function")return console.warn("IndexedDB not available: IDBFactory interface not available"),!1;try{const e="cardall_availability_test",t=window.indexedDB.open(e,1);return new Promise(r=>{let n;const o=()=>{n&&clearTimeout(n);try{window.indexedDB.deleteDatabase(e)}catch(i){console.debug("Failed to cleanup test database:",i)}};n=window.setTimeout(()=>{console.warn("IndexedDB availability test timed out"),o(),r(!1)},5e3),t.onerror=i=>{console.warn("IndexedDB availability test failed:",i),o(),r(!1)},t.onblocked=()=>{console.warn("IndexedDB availability test blocked"),o(),r(!1)},t.onsuccess=()=>{const i=t.result;try{i.close(),o(),console.debug("IndexedDB availability test passed"),r(!0)}catch(l){console.warn("Failed to close test database:",l),o(),r(!1)}},t.onupgradeneeded=i=>{console.debug("IndexedDB upgrade needed during availability test")}})}catch(e){return console.warn("IndexedDB availability test error:",e),!1}}catch(e){return console.warn("IndexedDB not available:",e),!1}}async hasIndexedDBData(){try{if(!await this.isIndexedDBAvailable())return console.debug("IndexedDB data check: IndexedDB not available"),!1;try{if(!L.isOpen())try{await L.open()}catch(n){return console.warn("Failed to open database for data check:",n),!1}let t;try{t=await L.cards.count(),console.debug(`IndexedDB card count: ${t}`)}catch(n){return console.warn("Failed to get card count:",n),!1}return t>0||await this.checkOtherDataTables()?!0:(console.debug("IndexedDB data check: no data found"),!1)}catch(t){return console.warn("Database operation failed during data check:",t),!1}}catch(e){return console.warn("Failed to check IndexedDB data:",e),!1}}async checkOtherDataTables(){try{try{const e=await L.folders.count();if(e>0)return console.debug(`Found ${e} folders in IndexedDB`),!0}catch(e){console.debug("Failed to check folders:",e)}try{const e=await L.tags.count();if(e>0)return console.debug(`Found ${e} tags in IndexedDB`),!0}catch(e){console.debug("Failed to check tags:",e)}try{const e=await L.images.count();if(e>0)return console.debug(`Found ${e} images in IndexedDB`),!0}catch(e){console.debug("Failed to check images:",e)}try{const e=await L.settings.count();if(e>0)return console.debug(`Found ${e} settings in IndexedDB`),!0}catch(e){console.debug("Failed to check settings:",e)}return!1}catch(e){return console.debug("Error checking other data tables:",e),!1}}async validateDataIntegrity(e){const t=e||this.storageMode,r=[],n=[];try{console.log(`Validating data integrity for ${t}...`);const o=await this.getCards();if(!Array.isArray(o))return r.push("Cards data is not an array"),{isValid:!1,issues:r,cardCount:0,corruptedCards:n};for(const m of o){const u=this.validateCardStructure(m);u.length>0&&(n.push(m.id||"unknown"),r.push(`Card ${m.id||"unknown"} has issues: ${u.join(", ")}`))}if(t==="indexeddb"){const m=await L.cards.toArray();m.length!==o.length&&r.push(`Card count mismatch: IndexedDB has ${m.length}, adapter returned ${o.length}`)}const i=this.validateTimestamps(o);r.push(...i);const l=r.length===0;return console.log(`Data integrity validation completed: ${l?"PASS":"FAIL"}`),l||console.warn(`Found ${r.length} issues`),{isValid:l,issues:r,cardCount:o.length,corruptedCards:n}}catch(o){const i=`Data integrity validation failed: ${o instanceof Error?o.message:String(o)}`;return r.push(i),console.error(i),{isValid:!1,issues:r,cardCount:0,corruptedCards:n}}}validateCardStructure(e){const t=[];return(!e.id||typeof e.id!="string")&&t.push("Missing or invalid id"),!e.frontContent||typeof e.frontContent!="object"?t.push("Missing or invalid frontContent"):((!e.frontContent.title||typeof e.frontContent.title!="string")&&t.push("Missing or invalid frontContent.title"),typeof e.frontContent.text!="string"&&t.push("Invalid frontContent.text type")),!e.backContent||typeof e.backContent!="object"?t.push("Missing or invalid backContent"):((!e.backContent.title||typeof e.backContent.title!="string")&&t.push("Missing or invalid backContent.title"),typeof e.backContent.text!="string"&&t.push("Invalid backContent.text type")),(!e.createdAt||!(e.createdAt instanceof Date))&&t.push("Missing or invalid createdAt"),(!e.updatedAt||!(e.updatedAt instanceof Date))&&t.push("Missing or invalid updatedAt"),e.style&&typeof e.style!="object"&&t.push("Invalid style type"),e.frontContent.tags&&!Array.isArray(e.frontContent.tags)&&t.push("Invalid frontContent.tags type"),e.backContent.tags&&!Array.isArray(e.backContent.tags)&&t.push("Invalid backContent.tags type"),t}validateTimestamps(e){const t=[];for(const r of e){r.createdAt>new Date&&t.push(`Card ${r.id} has creation date in the future`),r.updatedAt>new Date&&t.push(`Card ${r.id} has update date in the future`),r.updatedAt<r.createdAt&&t.push(`Card ${r.id} has update date before creation date`);const n=new Date("2000-01-01");(r.createdAt<n||r.updatedAt<n)&&t.push(`Card ${r.id} has suspiciously old timestamps`)}return t}async repairDataIntegrity(){console.log("Starting data integrity repair...");const e=[],t=[],r=[];try{const n=await this.validateDataIntegrity();if(n.isValid)return console.log("No integrity issues found"),{repaired:!0,repairedCards:0,issues:[],failedRepairs:[]};console.log(`Found ${n.issues.length} issues to repair`);const o=await this.getCards(),i=[];for(const l of o){const m=this.validateCardStructure(l);if(m.length>0){const u=this.repairCard(l);this.validateCardStructure(u).length===0?(i.push(u),e.push(l.id||"unknown"),console.log(`Successfully repaired card ${l.id}`)):(t.push(l.id||"unknown"),r.push(`Failed to repair card ${l.id}: ${m.join(", ")}`))}else i.push(l)}return i.length!==o.length&&(await this.saveCards(i),console.log(`Repaired ${e.length} cards`)),{repaired:t.length===0,repairedCards:e.length,issues:r,failedRepairs:t}}catch(n){const o=`Data repair failed: ${n instanceof Error?n.message:String(n)}`;return console.error(o),{repaired:!1,repairedCards:0,issues:[o],failedRepairs:e}}}repairCard(e){const t={id:e.id||crypto.randomUUID(),frontContent:{title:e.frontContent?.title||"Untitled",text:e.frontContent?.text||"",tags:Array.isArray(e.frontContent?.tags)?e.frontContent.tags:[]},backContent:{title:e.backContent?.title||"Untitled",text:e.backContent?.text||"",tags:Array.isArray(e.backContent?.tags)?e.backContent.tags:[]},style:typeof e.style=="object"?e.style:{type:"solid"},isFlipped:typeof e.isFlipped=="boolean"?e.isFlipped:!1,createdAt:e.createdAt instanceof Date?e.createdAt:new Date,updatedAt:new Date};return t.createdAt>new Date&&(t.createdAt=new Date),t.updatedAt<t.createdAt&&(t.updatedAt=t.createdAt),t}async updateConfig(e){const{validateStorageConfig:t}=await Is(async()=>{const{validateStorageConfig:n}=await Promise.resolve().then(()=>Lo);return{validateStorageConfig:n}},void 0),r=t({...this.config,...e});if(!r.valid)throw ce("INVALID_CONFIG","Invalid storage configuration",{errors:r.errors});this.config=r.config}setupEventListeners(){if(this.storageMode==="indexeddb")try{L.cards.hook("creating",(e,t,r)=>{this.emitEvent({type:"cardCreated",timestamp:new Date,data:{cardId:e}})}),L.cards.hook("updating",(e,t,r,n)=>{this.emitEvent({type:"cardUpdated",timestamp:new Date,data:{cardId:t}})}),L.cards.hook("deleting",(e,t,r)=>{this.emitEvent({type:"cardDeleted",timestamp:new Date,data:{cardId:e}})})}catch(e){console.warn("Failed to setup IndexedDB event listeners:",e)}}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}removeEventListener(e,t){const r=this.eventListeners.get(e);if(r){const n=r.indexOf(t);n>-1&&r.splice(n,1)}}emitEvent(e){const t=this.eventListeners.get(e.type);t&&t.forEach(r=>{try{r(e)}catch(n){console.error(`Event listener error for ${e.type}:`,n)}})}}const $o=Object.freeze(Object.defineProperty({__proto__:null,UniversalStorageAdapter:Ve},Symbol.toStringTag,{value:"Module"}));class ot{static instance;errorListeners=[];recoveryStrategies=new Map;static getInstance(){return ot.instance||(ot.instance=new ot),ot.instance}onError(e){return this.errorListeners.push(e),()=>{const t=this.errorListeners.indexOf(e);t>-1&&this.errorListeners.splice(t,1)}}registerRecoveryStrategy(e,t){this.recoveryStrategies.set(e,t)}async handleError(e,t){const r=this.normalizeError(e,t);this.errorListeners.forEach(o=>o(r));const n=this.recoveryStrategies.get(r.type);if(n?.canRecover)try{await n.recover()}catch(o){console.error("错误恢复失败:",o)}return r}normalizeError(e,t){if(e instanceof Error){const r=this.classifyError(e),n=this.getSeverity(r),o=this.isRecoverable(e);return{type:r,message:t?`${t}: ${e.message}`:e.message,details:e.stack,timestamp:new Date,recoverable:o,severity:n,userMessage:this.getUserMessage(r),retryCount:0,maxRetries:this.getMaxRetries(r)}}return{type:"UNKNOWN_ERROR",message:t?`${t}: 未知错误`:"未知错误",details:e,timestamp:new Date,recoverable:!1,severity:"critical",userMessage:"发生了未知错误，请联系技术支持",retryCount:0,maxRetries:0}}classifyError(e){const t=e.message.toLowerCase(),r=e.stack?.toLowerCase()||"";return t.includes("storage")||t.includes("localstorage")||t.includes("indexeddb")?t.includes("quota")||t.includes("exceeded")||t.includes("full")||t.includes("quota exceeded")?"STORAGE_QUOTA_ERROR":t.includes("permission")||t.includes("access denied")||t.includes("security")||t.includes("security error")?"STORAGE_PERMISSION_ERROR":t.includes("corruption")||t.includes("corrupted")||t.includes("invalid data")||t.includes("data error")?"STORAGE_CORRUPTION_ERROR":t.includes("read-only")||t.includes("readonly")||t.includes("blocked")?"STORAGE_PERMISSION_ERROR":"STORAGE_TEMPORARY_ERROR":t.includes("network")||t.includes("fetch")||t.includes("ajax")||t.includes("xhr")?t.includes("offline")||t.includes("no internet")||t.includes("connection")||t.includes("networkerror")?"NETWORK_OFFLINE_ERROR":t.includes("timeout")||t.includes("timed out")||t.includes("timeout error")?"NETWORK_TIMEOUT_ERROR":t.includes("server")||t.includes("500")||t.includes("502")||t.includes("503")||t.includes("504")||t.includes("bad gateway")||t.includes("cors")||t.includes("cross-origin")||t.includes("origin")?"NETWORK_SERVER_ERROR":"NETWORK_ERROR":t.includes("validation")||t.includes("invalid")||t.includes("schema")||t.includes("type error")?t.includes("structure")||t.includes("format")||t.includes("unexpected token")||t.includes("syntax error")?"VALIDATION_STRUCTURE_ERROR":t.includes("required")||t.includes("missing")||t.includes("undefined")||t.includes("null")?"VALIDATION_DATA_ERROR":"VALIDATION_ERROR":t.includes("migration")||t.includes("migrate")||t.includes("upgrade")?t.includes("legacy")||t.includes("old version")||t.includes("version mismatch")?"MIGRATION_LEGACY_ERROR":t.includes("version")||t.includes("compatibility")||t.includes("incompatible")?"MIGRATION_VERSION_ERROR":"MIGRATION_ERROR":t.includes("initialization")||t.includes("init")||t.includes("setup")||t.includes("configuration")?"INITIALIZATION_ERROR":r.includes("indexeddb")||r.includes("idb")?t.includes("version")||t.includes("upgrade")?"MIGRATION_VERSION_ERROR":"STORAGE_TEMPORARY_ERROR":t.includes("database")||t.includes("db")||t.includes("transaction")?t.includes("constraint")||t.includes("unique")?"VALIDATION_DATA_ERROR":"STORAGE_TEMPORARY_ERROR":t.includes("memory")||t.includes("heap")||t.includes("out of memory")?"STORAGE_QUOTA_ERROR":t.includes("file")||t.includes("directory")||t.includes("filesystem")?"STORAGE_TEMPORARY_ERROR":"UNKNOWN_ERROR"}isRecoverable(e){const t=e.message.toLowerCase(),n=["quota","permission","access denied","security","critical","readonly","blocked","insufficient","not supported"].some(o=>t.includes(o));return t.includes("temporary")||t.includes("transient")||t.includes("network")&&!t.includes("offline")||t.includes("timeout")?!0:!n}getSeverity(e){switch(e){case"STORAGE_QUOTA_ERROR":case"STORAGE_PERMISSION_ERROR":case"VALIDATION_STRUCTURE_ERROR":case"MIGRATION_VERSION_ERROR":case"UNKNOWN_ERROR":return"critical";case"INITIALIZATION_ERROR":case"STORAGE_CORRUPTION_ERROR":case"NETWORK_SERVER_ERROR":return"high";case"VALIDATION_DATA_ERROR":case"MIGRATION_LEGACY_ERROR":case"MIGRATION_ERROR":return"medium";case"STORAGE_TEMPORARY_ERROR":case"NETWORK_OFFLINE_ERROR":case"NETWORK_TIMEOUT_ERROR":case"NETWORK_ERROR":case"VALIDATION_ERROR":return"low";default:return"low"}}getUserMessage(e){switch(e){case"STORAGE_QUOTA_ERROR":return"存储空间已满。请清理一些旧的卡片或使用浏览器的存储管理功能释放空间。";case"STORAGE_PERMISSION_ERROR":return"无法访问存储。请检查浏览器隐私设置，确保允许网站使用本地存储。";case"STORAGE_CORRUPTION_ERROR":return"检测到数据损坏。系统正在自动修复，请稍候...";case"STORAGE_TEMPORARY_ERROR":return"存储暂时不可用。系统正在重试，请稍等片刻...";case"NETWORK_OFFLINE_ERROR":return"网络连接已断开。请检查您的网络连接，连接后系统会自动同步。";case"NETWORK_TIMEOUT_ERROR":return"网络响应超时。请检查网络连接并稍后重试。";case"NETWORK_SERVER_ERROR":return"服务器暂时不可用。请稍后重试，或联系技术支持。";case"VALIDATION_STRUCTURE_ERROR":return"数据格式有问题。系统正在尝试自动修复...";case"VALIDATION_DATA_ERROR":return"数据内容验证失败。系统正在清理无效数据...";case"MIGRATION_LEGACY_ERROR":return"旧版本数据迁移失败。部分数据可能需要手动重新输入。";case"MIGRATION_VERSION_ERROR":return"版本兼容性问题。请更新应用到最新版本。";case"INITIALIZATION_ERROR":return"系统初始化失败。请刷新页面重试，如持续出现问题请清除浏览器数据。";case"UNKNOWN_ERROR":return"发生了未知错误。请刷新页面重试，如问题持续请联系技术支持。";case"NETWORK_ERROR":return"网络连接出现问题。请检查网络设置后重试。";case"VALIDATION_ERROR":return"数据验证出现问题。系统正在处理...";case"MIGRATION_ERROR":return"数据迁移过程中出现问题。系统正在尝试解决...";default:return"发生了错误，请稍后重试。"}}getMaxRetries(e){switch(e){case"STORAGE_TEMPORARY_ERROR":case"NETWORK_TIMEOUT_ERROR":case"NETWORK_OFFLINE_ERROR":case"NETWORK_ERROR":return 5;case"STORAGE_CORRUPTION_ERROR":case"VALIDATION_DATA_ERROR":case"NETWORK_SERVER_ERROR":return 3;case"VALIDATION_STRUCTURE_ERROR":case"MIGRATION_LEGACY_ERROR":case"MIGRATION_ERROR":case"INITIALIZATION_ERROR":return 2;case"STORAGE_QUOTA_ERROR":case"STORAGE_PERMISSION_ERROR":case"MIGRATION_VERSION_ERROR":return 1;case"UNKNOWN_ERROR":case"VALIDATION_ERROR":return 2;default:return 0}}}const ms=async()=>{try{const a=`_storage_test_${Date.now()}`;if(localStorage.setItem(a,"test"),localStorage.removeItem(a),"indexedDB"in window){const e=indexedDB.open("_storage_test_db",1);await new Promise((t,r)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>r(e.error)}),indexedDB.deleteDatabase("_storage_test_db")}return!0}catch(a){return console.error("存储可用性检查失败:",a),!1}},Js=async()=>{try{const a="card_error_history",e=localStorage.getItem(a);if(e){const n=JSON.parse(e).slice(-20);localStorage.setItem(a,JSON.stringify(n))}const t=Object.keys(localStorage).filter(r=>r.startsWith("_temp_")||r.startsWith("_cache_"));t.forEach(r=>localStorage.removeItem(r)),console.log(`清理了 ${t.length} 个临时项`)}catch(a){throw console.error("存储空间清理失败:",a),a}},Xs=async()=>{try{const a=localStorage.getItem("cards");if(a){const t=JSON.parse(a).map(r=>({id:r.id,frontContent:{title:r.frontContent.title,text:r.frontContent.text,tags:r.frontContent.tags,lastModified:r.frontContent.lastModified},backContent:{title:r.backContent.title,text:r.backContent.text,tags:r.backContent.tags,lastModified:r.backContent.lastModified},style:r.style,createdAt:r.createdAt,updatedAt:r.updatedAt}));localStorage.setItem("cards",JSON.stringify(t))}console.log("数据压缩完成")}catch(a){throw console.error("数据压缩失败:",a),a}},zo=async()=>{try{const a=localStorage.getItem("cards");if(!a)return[];const e=JSON.parse(a);if(!Array.isArray(e))return[];const t=e.map(r=>{const n={id:r.id||Date.now().toString(),frontContent:{title:r.frontContent?.title||"未命名卡片",text:r.frontContent?.text||"",images:r.frontContent?.images||[],tags:r.frontContent?.tags||[],lastModified:r.frontContent?.lastModified?new Date(r.frontContent.lastModified):new Date},backContent:{title:r.backContent?.title||"背面",text:r.backContent?.text||"",images:r.backContent?.images||[],tags:r.backContent?.tags||[],lastModified:r.backContent?.lastModified?new Date(r.backContent.lastModified):new Date},style:r.style||{type:"solid",backgroundColor:"#f8fafc",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:r.isFlipped||!1,createdAt:r.createdAt?new Date(r.createdAt):new Date,updatedAt:r.updatedAt?new Date(r.updatedAt):new Date};return r.folderId&&(n.folderId=r.folderId),n});return localStorage.setItem("cards",JSON.stringify(t)),t}catch(a){return console.error("localStorage数据修复失败:",a),[]}},Bo=async()=>{try{return"indexedDB"in window?new Promise((a,e)=>{const t=indexedDB.open("CardAllDB",1);t.onsuccess=()=>{const r=t.result,i=r.transaction(["cards"],"readonly").objectStore("cards").getAll();i.onsuccess=()=>{const l=i.result||[];r.close(),a(l)},i.onerror=()=>{r.close(),e(i.error)}},t.onerror=()=>{e(t.error)}}):[]}catch(a){return console.error("IndexedDB数据恢复失败:",a),[]}},Uo=async()=>{try{if("caches"in window){const e=await(await caches.open("cardall-data")).match("/cards-data");if(e)return(await e.json()).cards||[]}return[]}catch(a){return console.error("浏览器缓存恢复失败:",a),[]}},Ie=a=>{try{return a&&typeof a.id=="string"&&a.frontContent&&typeof a.frontContent.title=="string"&&a.backContent&&typeof a.backContent.title=="string"&&a.style&&a.createdAt&&a.updatedAt}catch{return!1}},gs=async a=>a.map(e=>{const t={id:e.id||Date.now().toString(),frontContent:{title:e.frontContent?.title||"修复的卡片",text:e.frontContent?.text||"",images:Array.isArray(e.frontContent?.images)?e.frontContent.images:[],tags:Array.isArray(e.frontContent?.tags)?e.frontContent.tags:[],lastModified:e.frontContent?.lastModified?new Date(e.frontContent.lastModified):new Date},backContent:{title:e.backContent?.title||"背面",text:e.backContent?.text||"",images:Array.isArray(e.backContent?.images)?e.backContent.images:[],tags:Array.isArray(e.backContent?.tags)?e.backContent.tags:[],lastModified:e.backContent?.lastModified?new Date(e.backContent.lastModified):new Date},style:e.style||{type:"solid",backgroundColor:"#f8fafc",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:typeof e.isFlipped=="boolean"?e.isFlipped:!1,createdAt:e.createdAt?new Date(e.createdAt):new Date,updatedAt:new Date};return e.folderId&&(t.folderId=e.folderId),t}),fs=async()=>{try{const a=Date.now(),e=await fetch("/api/health",{method:"HEAD",cache:"no-cache"}),t=Date.now()-a;return{success:e.ok,latency:t}}catch{try{const e=Date.now(),t=await fetch("/",{method:"HEAD",cache:"no-cache"}),r=Date.now()-e;return{success:t.ok,latency:r}}catch{return{success:!1}}}},Vo=async()=>{try{const a=await fetch("/api/status",{method:"GET",headers:{"Content-Type":"application/json"}});return a.ok?{success:!0,message:(await a.json()).message||"服务器正常"}:{success:!1,message:`服务器响应错误: ${a.status}`}}catch{return{success:!1,message:"无法连接到服务器"}}},Wo=[{id:"1",frontContent:{title:"React Best Practices",text:"Key principles for writing maintainable React code including component composition, state management, and performance optimization.",images:[],tags:["react","frontend","best-practices"],lastModified:new Date},backContent:{title:"Implementation Details",text:"Use functional components with hooks, implement proper error boundaries, optimize with React.memo and useMemo for expensive calculations.",images:[],tags:["react","frontend","best-practices"],lastModified:new Date},style:{type:"solid",backgroundColor:"#f8fafc",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:!1,createdAt:new Date("2024-01-15"),updatedAt:new Date("2024-01-15")},{id:"2",frontContent:{title:"TypeScript Tips",text:"Advanced TypeScript patterns for better type safety and developer experience in large applications.",images:[],tags:["typescript","types","development"],lastModified:new Date},backContent:{title:"Advanced Patterns",text:"Utility types, conditional types, mapped types, and template literal types for complex type transformations.",images:[],tags:["typescript","types","development"],lastModified:new Date},style:{type:"gradient",gradientColors:["#667eea","#764ba2"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"xl",shadow:"lg",borderWidth:0},isFlipped:!1,createdAt:new Date("2024-01-16"),updatedAt:new Date("2024-01-16")}];function Ho(){const[a,e]=c.useState([]),[t,r]=c.useState(!1),[n,o]=c.useState({searchTerm:"",tags:[]}),[i,l]=c.useState({layout:"grid",cardSize:"medium",showTags:!0,showDates:!1,sortBy:"updated",sortOrder:"desc"}),[m,u]=c.useState([]),[d,y]=c.useState(null),[h,g]=c.useState([]),[S,N]=c.useState(!1),[E,v]=c.useState(!1),[f,p]=c.useState(null),x=ot.getInstance(),b=Ve.getInstance();c.useEffect(()=>{const M=x.onError(k=>{if(y(k),g(O=>[...O.slice(-9),k]),k.userMessage)switch(k.severity){case"critical":console.error("严重错误:",k.userMessage);break;case"high":console.warn("高级别错误:",k.userMessage);break;case"medium":console.warn("中等级别错误:",k.userMessage);break;case"low":console.info("低级别错误:",k.userMessage);break}});x.registerRecoveryStrategy("STORAGE_TEMPORARY_ERROR",{canRecover:!0,maxRetries:3,retryDelay:1e3,recover:async()=>{console.log("尝试恢复临时存储错误...");try{if(!await ms())throw new Error("存储不可用");await Js(),await new Promise(O=>setTimeout(O,1e3))}catch(k){throw console.error("临时存储恢复失败:",k),k}},fallback:()=>{console.log("临时存储恢复失败，使用空数据"),e([])},shouldUseMock:!1}),x.registerRecoveryStrategy("STORAGE_CORRUPTION_ERROR",{canRecover:!0,maxRetries:2,retryDelay:500,recover:async()=>{console.log("尝试修复数据损坏...");try{let k=[];const O=await zo();if(O.length>0&&(k=O),k.length===0){const Q=await Bo();Q.length>0&&(k=Q)}if(k.length===0){const Q=await Uo();Q.length>0&&(k=Q)}if(k.length>0)e(k),console.log(`成功恢复 ${k.length} 张卡片`);else throw new Error("无法从任何来源恢复数据")}catch(k){throw console.error("数据修复失败:",k),k}},fallback:()=>{console.log("数据修复失败，使用空数据"),e([])},shouldUseMock:!1}),x.registerRecoveryStrategy("VALIDATION_DATA_ERROR",{canRecover:!0,maxRetries:2,retryDelay:300,recover:async()=>{console.log("尝试修复数据验证错误...");try{const k=a.filter(O=>!Ie(O));if(k.length>0){console.log(`发现 ${k.length} 张无效卡片，尝试修复...`);const O=await gs(k);e(Q=>Q.map(ie=>O.find(he=>he.id===ie.id)||ie)),console.log(`成功修复 ${O.length} 张卡片`)}}catch(k){throw console.error("数据验证修复失败:",k),k}},fallback:()=>{console.log("数据验证修复失败，移除无效卡片"),e(k=>k.filter(O=>Ie(O)))},shouldUseMock:!1}),x.registerRecoveryStrategy("NETWORK_TIMEOUT_ERROR",{canRecover:!0,maxRetries:3,retryDelay:2e3,recover:async()=>{console.log("网络超时恢复策略...");try{if(!navigator.onLine)throw new Error("网络离线");if(!(await fs()).success)throw new Error("网络连接测试失败");console.log("网络连接已恢复")}catch(k){throw console.error("网络恢复失败:",k),k}},shouldUseMock:!1}),x.registerRecoveryStrategy("NETWORK_OFFLINE_ERROR",{canRecover:!0,maxRetries:3,retryDelay:3e3,recover:async()=>{console.log("网络离线恢复策略...");try{let k=0;const O=10;for(;k<O;){if(navigator.onLine&&(await fs()).success){console.log("网络连接已恢复");return}k++,await new Promise(Q=>setTimeout(Q,1e3))}throw new Error("网络连接未在预期时间内恢复")}catch(k){throw console.error("网络离线恢复失败:",k),k}},shouldUseMock:!1}),x.registerRecoveryStrategy("STORAGE_QUOTA_ERROR",{canRecover:!0,maxRetries:1,retryDelay:1e3,recover:async()=>{console.log("存储配额错误恢复策略...");try{await Js(),await Xs(),console.log("存储空间清理完成")}catch(k){throw console.error("存储配额恢复失败:",k),k}},fallback:()=>{console.log("存储空间不足，建议清理数据或使用云端同步"),alert("存储空间不足，请清理一些数据或使用云端同步功能")},shouldUseMock:!1}),x.registerRecoveryStrategy("INITIALIZATION_ERROR",{canRecover:!0,maxRetries:2,retryDelay:1e3,recover:async()=>{console.log("初始化错误恢复策略...");try{await b.reinitialize(),await C(),console.log("初始化恢复成功")}catch(k){throw console.error("初始化恢复失败:",k),k}},shouldUseMock:!1}),x.registerRecoveryStrategy("NETWORK_SERVER_ERROR",{canRecover:!0,maxRetries:3,retryDelay:2e3,recover:async()=>{console.log("服务器错误恢复策略...");try{if(await new Promise(O=>setTimeout(O,2e3)),!(await Vo()).success)throw new Error("服务器仍然不可用");console.log("服务器连接已恢复")}catch(k){throw console.error("服务器恢复失败:",k),k}},shouldUseMock:!1});const R=async k=>{console.log("存储数据变更:",k),k.type==="cardsChanged"&&k.data?.externalChange&&(console.log("检测到外部数据变更，重新加载..."),await C()),k.type==="cardsChanged"&&p(new Date)};return b.addEventListener("cardsChanged",R),b.addEventListener("cardCreated",R),b.addEventListener("cardUpdated",R),b.addEventListener("cardDeleted",R),()=>{M(),b.removeEventListener("cardsChanged",R),b.removeEventListener("cardCreated",R),b.removeEventListener("cardUpdated",R),b.removeEventListener("cardDeleted",R)}},[b]);const C=c.useCallback(async()=>{N(!0);try{let M=[],R=0;const k=3;for(;R<k;)try{M=await b.getCards();break}catch(O){if(R++,R===k)throw O;console.warn(`第 ${R} 次加载失败，等待重试...`),await new Promise(Q=>setTimeout(Q,1e3*R))}if(M.length>0){const O=M.filter(Ie);O.length!==M.length&&console.warn(`发现 ${M.length-O.length} 张无效卡片，已过滤`),e(O),console.log(`成功加载 ${O.length} 张有效卡片 (使用 ${b.getStorageMode()} 存储模式)`)}else console.log("没有找到数据，使用空数组"),e([]);r(!0)}catch(M){console.error("加载数据失败:",M),await x.handleError(M,"加载卡片数据失败");try{console.log("尝试回退到DataConverterAdapter...");const R=je.loadFromLocalStorage();if(R.length>0){const k=R.filter(Ie);e(k),console.log(`回退加载成功：${k.length} 张有效卡片`)}else e([])}catch(R){console.error("回退加载也失败:",R),await x.handleError(R,"回退加载失败"),e([])}r(!0)}finally{N(!1)}},[x]),w=c.useCallback(async()=>{if(!(!d||!d.recoverable)){N(!0),v(!0);try{const M=x.recoveryStrategies.get(d.type);if(M?.canRecover){const R=M.maxRetries||d.maxRetries||1,k=M.retryDelay||1e3;let O=null;for(let Q=1;Q<=R;Q++)try{console.log(`尝试恢复 ${d.type} - 第 ${Q} 次`),await M.recover(),await C(),y(null),console.log(`错误恢复成功：${d.type}`);break}catch(ie){if(O=ie,console.error(`恢复失败，第 ${Q} 次尝试:`,ie),Q<R){const me=k*Math.pow(2,Q-1);console.log(`等待 ${me}ms 后重试...`),await new Promise(he=>setTimeout(he,me))}}O&&M.fallback&&(console.log("所有恢复尝试失败，执行fallback策略"),M.fallback()),d&&M.shouldUseMock&&a.length===0&&(console.warn("所有恢复策略失败，使用mock数据作为最后手段"),e(Wo),y(null))}else console.warn(`错误类型 ${d.type} 没有可用的恢复策略`)}catch(M){console.error("错误恢复过程中发生异常:",M);const R=x.recoveryStrategies.get(d.type)?.fallback;R&&R()}finally{N(!1)}}},[d,x,a.length,C]),j=c.useCallback(()=>{const M=a.filter(R=>{if(n.searchTerm){const k=n.searchTerm.toLowerCase(),O=R.frontContent.title.toLowerCase().includes(k)||R.backContent.title.toLowerCase().includes(k),Q=R.frontContent.text.toLowerCase().includes(k)||R.backContent.text.toLowerCase().includes(k),ie=[...R.frontContent.tags,...R.backContent.tags].some(me=>me.toLowerCase().includes(k));if(!O&&!Q&&!ie)return!1}if(n.tags.length>0){const k=[...R.frontContent.tags,...R.backContent.tags];if(!n.tags.some(O=>k.includes(O)))return!1}if(n.folderId&&R.folderId!==n.folderId)return!1;if(n.dateRange){const k=new Date(R.updatedAt);if(k<n.dateRange.start||k>n.dateRange.end)return!1}return!(n.styleType&&R.style.type!==n.styleType||n.hasImages!==void 0&&(R.frontContent.images.length>0||R.backContent.images.length>0)!==n.hasImages)});return M.sort((R,k)=>{let O=0;switch(i.sortBy){case"created":O=new Date(R.createdAt).getTime()-new Date(k.createdAt).getTime();break;case"updated":O=new Date(R.updatedAt).getTime()-new Date(k.updatedAt).getTime();break;case"title":O=R.frontContent.title.localeCompare(k.frontContent.title);break;default:O=0}return i.sortOrder==="desc"?-O:O}),M},[a,n,i]),D=c.useCallback(M=>{e(R=>{switch(M.type){case"CREATE_CARD":{const k={...M.payload,id:Date.now().toString(),createdAt:new Date,updatedAt:new Date};return[...R,k]}case"UPDATE_CARD":return R.map(k=>k.id===M.payload.id?{...k,...M.payload.updates,updatedAt:new Date}:k);case"DELETE_CARD":return R.filter(k=>k.id!==M.payload);case"SELECT_CARD":return u(k=>k.includes(M.payload)?k.filter(O=>O!==M.payload):[...k,M.payload]),R;case"DESELECT_ALL":return u([]),R;case"DUPLICATE_CARD":{const k=R.find(Q=>Q.id===M.payload);if(!k)return R;const O={...k,id:Date.now().toString(),createdAt:new Date,updatedAt:new Date};return[...R,O]}case"MOVE_TO_FOLDER":return R.map(O=>O.id===M.payload.cardId?{...O,folderId:M.payload.folderId,updatedAt:new Date}:O);default:return R}})},[]),P=c.useCallback(M=>a.find(R=>R.id===M),[a]),$=c.useCallback(()=>a.filter(M=>m.includes(M.id)),[a,m]),K=c.useCallback(()=>{const M=new Set;return a.forEach(R=>{R.frontContent.tags.forEach(k=>M.add(k)),R.backContent.tags.forEach(k=>M.add(k))}),Array.from(M).sort()},[a]),se=c.useCallback(M=>{},[]),V=c.useCallback((M,R)=>{e(k=>k.map(O=>{const Q=he=>R?he.map(pe=>pe===M?R:pe):he.filter(pe=>pe!==M),ie=Q(O.frontContent.tags),me=Q(O.backContent.tags);return JSON.stringify(ie)!==JSON.stringify(O.frontContent.tags)||JSON.stringify(me)!==JSON.stringify(O.backContent.tags)?{...O,frontContent:{...O.frontContent,tags:ie,lastModified:new Date},backContent:{...O.backContent,tags:me,lastModified:new Date},updatedAt:new Date}:O}))},[]),re=c.useCallback(M=>a.filter(R=>R.frontContent.tags.includes(M)||R.backContent.tags.includes(M)),[a]);c.useEffect(()=>{if(t)return;(async()=>{N(!0);try{const R=await b.getCards();if(R.length>0){const k=R.map(O=>({...O,isFlipped:!1}));e(k),console.log(`成功加载 ${R.length} 张卡片 (使用 ${b.getStorageMode()} 存储模式)`)}else try{console.log("尝试从localStorage加载数据...");const k=je.loadFromLocalStorage();if(k.length>0){const O=k.map(Q=>({...Q,isFlipped:!1}));e(O),console.log(`从localStorage加载 ${k.length} 张卡片`),await b.saveCards(O),console.log("数据已迁移到UniversalStorageAdapter")}else console.log("没有找到数据，使用空数组"),e([])}catch(k){console.warn("从localStorage加载失败:",k),e([])}r(!0)}catch(R){console.error("加载卡片数据失败:",R),await x.handleError(R,"加载卡片数据失败"),await w()}finally{N(!1)}})()},[t,x,w,b]),c.useEffect(()=>{if(!t||S)return;const M=setTimeout(async()=>{try{const R=a.filter(ie=>!Ie(ie));if(R.length>0){console.warn(`发现 ${R.length} 张无效卡片，保存前尝试修复...`);const ie=await gs(R);ie.length>0&&e(me=>me.map(he=>ie.find(Ct=>Ct.id===he.id)||he))}const k=a.map(ie=>({...ie,isFlipped:!1}));let O=0;const Q=2;for(;O<Q;)try{await b.saveCards(k),console.log(`自动保存成功：${k.length} 张卡片 (使用 ${b.getStorageMode()} 存储模式)`);break}catch(ie){if(O++,O===Q)throw ie;console.warn(`第 ${O} 次保存失败，等待重试...`),await new Promise(me=>setTimeout(me,500*O))}}catch(R){console.error("保存卡片到持久化存储失败:",R),await x.handleError(R,"保存卡片数据失败");try{console.log("尝试回退到DataConverterAdapter..."),je.saveToLocalStorage(cardsForSave),console.log("回退保存成功")}catch(k){console.error("回退保存也失败:",k),await x.handleError(k,"回退保存失败")}}},2e3);return()=>clearTimeout(M)},[a,t,S,x,b]);const te={performPreventiveChecks:async()=>{try{if(!await ms())return console.warn("存储空间检查失败，可能即将出现问题"),!1;navigator.onLine&&((await fs()).success||console.warn("网络连接不稳定，可能影响数据同步"));const R=a.filter(k=>!Ie(k));return R.length>0&&console.warn(`发现 ${R.length} 张无效卡片，建议修复`),!0}catch(M){return console.error("预防性检查失败:",M),!1}},analyzeErrorTrends:()=>{const M=h.slice(-10),R=h.slice(-20,-10);if(M.length===0)return{trend:"improving",suggestions:["错误率正常，继续保持"]};const k=new Map;M.forEach(he=>{const pe=k.get(he.type)||0;k.set(he.type,pe+1)});const O=[];k.forEach((he,pe)=>{if(he>2)switch(pe){case"STORAGE_TEMPORARY_ERROR":O.push("频繁的存储临时错误，建议检查存储设备");break;case"NETWORK_TIMEOUT_ERROR":O.push("网络超时频繁，建议检查网络连接");break;case"VALIDATION_DATA_ERROR":O.push("数据验证错误增多，建议检查数据源");break}});const Q=M.length,ie=R.length;let me="stable";return Q<ie?me="improving":Q>ie&&(me="worsening"),O.length===0&&O.push("系统运行正常，继续保持"),{trend:me,suggestions:O}},runMaintenanceTasks:async()=>{try{console.log("开始运行维护任务..."),h.length>50&&(g(k=>k.slice(-30)),console.log("清理了错误历史记录")),await ms()||(await Xs(),console.log("执行了数据压缩"));const R=a.filter(k=>!Ie(k));if(R.length>0){const k=await gs(R);k.length>0&&console.log(`修复了 ${k.length} 张无效卡片`)}console.log("维护任务完成")}catch(M){console.error("维护任务执行失败:",M)}}},[ne,ge]=c.useState(new Set),z=c.useCallback(M=>(ge(R=>new Set(R).add(M)),()=>{ge(R=>{const k=new Set(R);return k.delete(M),k})}),[]),Y=c.useCallback((M,R)=>{ne.forEach(k=>{try{k(M,R)}catch(O){console.error("数据变更监听器执行失败:",O)}})},[ne]),_=c.useCallback(async(M=!1)=>{if(!M&&t&&a.length>0)return a;N(!0);try{let R=[];try{R=await b.getCards(),R.length>0&&console.log(`从UniversalStorageAdapter加载 ${R.length} 张卡片`)}catch(O){console.warn("UniversalStorageAdapter加载失败，尝试回退:",O)}if(R.length===0)try{const O=je.loadFromLocalStorage();O.length>0&&(R=O,console.log(`从localStorage加载 ${O.length} 张卡片`),await b.saveCards(O))}catch(O){console.warn("localStorage加载失败:",O)}const k=R.filter(Ie);return k.length!==R.length&&console.warn(`过滤了 ${R.length-k.length} 张无效卡片`),e(k),r(!0),Y("cardsLoaded",{cardCount:k.length}),k}catch(R){return console.error("加载卡片失败:",R),await x.handleError(R,"loadCards失败"),e([]),r(!0),[]}finally{N(!1)}},[t,a.length,b,x,Y]),A=c.useCallback(async(M=a)=>{try{const R=M.filter(Q=>!Ie(Q));R.length>0&&console.warn(`保存前发现 ${R.length} 张无效卡片`);const k=M.filter(Ie);return await b.saveCards(k)?(console.log(`成功保存 ${k.length} 张卡片`),Y("cardsSaved",{cardCount:k.length}),!0):!1}catch(R){console.error("保存卡片失败:",R),await x.handleError(R,"saveCards失败");try{return je.saveToLocalStorage(M),console.log("回退保存成功"),!0}catch(k){return console.error("回退保存失败:",k),!1}}},[a,b,x,Y]),T=c.useCallback(async(M,R)=>{N(!0);try{console.log(`开始批量操作: ${R}`);for(let k=0;k<M.length;k++)try{await M[k]()}catch(O){throw console.error(`批量操作第 ${k+1} 步失败:`,O),O}return await A(),console.log(`批量操作完成: ${R}`),Y("batchOperationCompleted",{description:R,operationCount:M.length}),!0}catch(k){return console.error(`批量操作失败: ${R}`,k),await x.handleError(k,`批量操作失败: ${R}`),!1}finally{N(!1)}},[A,x,Y]);c.useEffect(()=>{if(!t)return;const M=setInterval(async()=>{try{await te.runMaintenanceTasks()}catch(k){console.error("定期维护任务失败:",k)}},5*60*1e3),R=setInterval(async()=>{try{await te.performPreventiveChecks()}catch(k){console.error("预防性检查失败:",k)}},30*1e3);return()=>{clearInterval(M),clearInterval(R)}},[t,te]);const W=c.useCallback(async()=>{if(!d||!d.recoverable)return!1;console.log("开始增强的错误恢复流程..."),N(!0);try{const M=x.recoveryStrategies.get(d.type);return M?.canRecover?(await M.recover(),await C(),y(null),console.log("错误恢复成功"),!0):!1}catch(M){return console.error("错误恢复失败:",M),!1}finally{N(!1)}},[d,x,C]),J=c.useCallback(()=>{if(!d)return null;switch(d.severity){case"critical":return{level:"critical",message:"严重错误，需要立即关注"};case"high":return{level:"high",message:"高级别错误，建议尽快处理"};case"medium":return{level:"medium",message:"中等级别错误，可以稍后处理"};case"low":return{level:"low",message:"低级别错误，可以忽略"};default:return null}},[d]),B=c.useCallback(()=>d?d.userMessage||d.message:null,[d]),q=c.useCallback(()=>{},[]);return{cards:j(),allCards:a,filter:n,setFilter:o,viewSettings:i,setViewSettings:l,selectedCardIds:m,dispatch:D,flipCard:se,getCardById:P,getSelectedCards:$,getAllTags:K,updateTagsInAllCards:V,getCardsWithTag:re,isInitialized:t,error:d,errorHistory:h,isLoading:S,recoveryAttempted:E,recoverFromError:w,reloadData:C,clearError:()=>y(null),clearErrorHistory:()=>g([]),lastSyncTime:f,getUserErrorMessage:B,getErrorSeverityInfo:J,errorPrevention:te,loadCards:_,saveCards:A,onDataChange:z,performBatchOperation:T,enhancedRecoverFromError:W,useMockDataForDevelopment:q}}class Go{config;directoryHandle=null;isSupported;constructor(){this.config={baseDirectory:"CardAll",imageDirectory:"images",tempDirectory:"temp",cacheDirectory:"cache"},this.isSupported="showDirectoryPicker"in window}isFileSystemAccessSupported(){return this.isSupported}async requestDirectoryAccess(){if(!this.isSupported)return console.warn("File System Access API not supported, using fallback storage"),this.saveStorageStrategy("indexeddb"),!1;try{return this.directoryHandle=await window.showDirectoryPicker({mode:"readwrite",startIn:"documents"}),await this.ensureDirectoryStructure(),this.saveStorageStrategy("filesystem"),!0}catch(e){return e.name==="AbortError"?console.log("User cancelled directory selection, using fallback storage"):console.error("Failed to access directory:",e),this.saveStorageStrategy("indexeddb"),!1}}async saveStorageStrategy(e){try{await L.settings.put({key:"storageStrategy",value:e,updatedAt:new Date,scope:"global"})}catch(t){console.error("Failed to save storage strategy:",t)}}async getStorageStrategy(){try{return(await L.settings.get("storageStrategy"))?.value||"indexeddb"}catch{return"indexeddb"}}async ensureDirectoryStructure(){if(this.directoryHandle)try{await this.getOrCreateDirectory(this.config.imageDirectory),await this.getOrCreateDirectory(this.config.tempDirectory),await this.getOrCreateDirectory(this.config.cacheDirectory),console.log("Directory structure created successfully")}catch(e){console.error("Failed to create directory structure:",e)}}async getOrCreateDirectory(e){if(!this.directoryHandle)throw new Error("No directory handle available");try{return await this.directoryHandle.getDirectoryHandle(e)}catch{return await this.directoryHandle.getDirectoryHandle(e,{create:!0})}}async getOrCreateNestedDirectory(e){if(!this.directoryHandle)throw new Error("No directory handle available");const t=e.split("/");let r=this.directoryHandle;for(const n of t)if(n)try{r=await r.getDirectoryHandle(n)}catch{r=await r.getDirectoryHandle(n,{create:!0})}return r}generateImagePath(e,t){const r=t||"uncategorized";return`${this.config.imageDirectory}/${r}/${e}`}async saveImage(e,t,r){const n=`img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o=`${n}.webp`,l=`${this.generateImagePath(t,r)}/${o}`;try{const m=await this.processImage(e),u=await this.getImageMetadata(e,m);this.isSupported&&this.directoryHandle?await this.saveToFileSystem(l,m):await this.saveToIndexedDB(l,m);const d={id:n,cardId:t,fileName:o,filePath:l,metadata:u,createdAt:new Date,syncVersion:1,pendingSync:!0};return await L.images.add(d),{id:n,fileName:o,filePath:l,metadata:u}}catch(m){throw console.error("Failed to save image:",m),m}}async processImage(e){return new Promise((t,r)=>{const n=document.createElement("canvas"),o=n.getContext("2d"),i=new Image;i.onload=()=>{try{let{width:u,height:d}=i;if(u>1920||d>1080){const y=Math.min(1920/u,1080/d);u*=y,d*=y}n.width=u,n.height=d,o?.drawImage(i,0,0,u,d),n.toBlob(y=>{y?t(y):r(new Error("Failed to convert image"))},"image/webp",.8)}catch(l){r(l)}},i.onerror=()=>r(new Error("Failed to load image")),i.src=URL.createObjectURL(e)})}async getImageMetadata(e,t){return new Promise(r=>{const n=new Image;n.onload=()=>{r({originalName:e.name,size:t.size,width:n.width,height:n.height,format:"webp",compressed:!0})},n.src=URL.createObjectURL(t)})}async saveToFileSystem(e,t){if(!this.directoryHandle)throw new Error("No directory handle available");const r=e.split("/"),n=r.pop(),o=r.join("/"),m=await(await(await this.getOrCreateNestedDirectory(o)).getFileHandle(n,{create:!0})).createWritable();await m.write(t),await m.close()}async saveToIndexedDB(e,t){await t.arrayBuffer();const r=await this.blobToBase64(t);localStorage.setItem(`cardall_file_${e}`,r)}blobToBase64(e){return new Promise((t,r)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=r,n.readAsDataURL(e)})}async getImage(e){try{return this.isSupported&&this.directoryHandle?await this.getFromFileSystem(e):await this.getFromIndexedDB(e)}catch(t){throw console.error("Failed to get image:",t),t}}async getFromFileSystem(e){if(!this.directoryHandle)throw new Error("No directory handle available");const t=e.split("/"),r=t.pop(),n=t.join("/"),l=await(await(await this.getOrCreateNestedDirectory(n)).getFileHandle(r)).getFile();return URL.createObjectURL(l)}async getFromIndexedDB(e){const t=localStorage.getItem(`cardall_file_${e}`);if(!t)throw new Error("Image not found in storage");return t}async deleteImage(e){try{this.isSupported&&this.directoryHandle?await this.deleteFromFileSystem(e):await this.deleteFromIndexedDB(e),await L.images.where("filePath").equals(e).delete()}catch(t){throw console.error("Failed to delete image:",t),t}}async deleteFromFileSystem(e){if(this.directoryHandle)try{const t=e.split("/"),r=t.pop(),n=t.join("/");await(await this.getOrCreateNestedDirectory(n)).removeEntry(r)}catch(t){console.warn("Failed to delete file from filesystem:",t)}}async deleteFromIndexedDB(e){localStorage.removeItem(`cardall_file_${e}`)}async getStorageStats(){const e=await L.images.toArray(),t=e.reduce((r,n)=>r+n.metadata.size,0);return{totalImages:e.length,totalSize:t,storageMode:this.isSupported&&this.directoryHandle?"filesystem":"indexeddb"}}}const Xe=new Go,Ko=a=>{const{userId:e,syncVersion:t,lastSyncAt:r,pendingSync:n,...o}=a;return{...o,id:o.id||"",createdAt:new Date(o.createdAt),updatedAt:new Date(o.updatedAt)}},hs=()=>Rt.getCurrentUser()?.id||null;function Yo(){const[a,e]=c.useState([]),[t,r]=c.useState({searchTerm:"",tags:[]}),[n,o]=c.useState({layout:"grid",cardSize:"medium",showTags:!0,showDates:!1,sortBy:"updated",sortOrder:"desc"}),[i,l]=c.useState([]),[m,u]=c.useState(!0),d=c.useCallback(async()=>{try{u(!0);const x=(await L.cards.toArray()).map(Ko);e(x)}catch(p){console.error("Failed to load cards:",p)}finally{u(!1)}},[]);c.useEffect(()=>{d()},[d]),c.useEffect(()=>{const p=L.cards.hook("creating",(C,w,j)=>{console.log("Card creating:",C)}),x=L.cards.hook("updating",(C,w,j,D)=>{console.log("Card updating:",w)}),b=L.cards.hook("deleting",(C,w,j)=>{console.log("Card deleting:",C)});return()=>{p?.unsubscribe(),x?.unsubscribe(),b?.unsubscribe()}},[]);const y=c.useCallback(()=>{const p=a.filter(x=>{if(t.searchTerm){const b=t.searchTerm.toLowerCase(),C=x.frontContent.title.toLowerCase().includes(b)||x.backContent.title.toLowerCase().includes(b),w=x.frontContent.text.toLowerCase().includes(b)||x.backContent.text.toLowerCase().includes(b),j=[...x.frontContent.tags,...x.backContent.tags].some(D=>D.toLowerCase().includes(b));if(!C&&!w&&!j)return!1}if(t.tags.length>0){const b=[...x.frontContent.tags,...x.backContent.tags];if(!t.tags.some(C=>b.includes(C)))return!1}if(t.folderId&&x.folderId!==t.folderId)return!1;if(t.dateRange){const b=new Date(x.updatedAt);if(b<t.dateRange.start||b>t.dateRange.end)return!1}return!(t.styleType&&x.style.type!==t.styleType||t.hasImages!==void 0&&(x.frontContent.images.length>0||x.backContent.images.length>0)!==t.hasImages)});return p.sort((x,b)=>{let C=0;switch(n.sortBy){case"created":C=new Date(x.createdAt).getTime()-new Date(b.createdAt).getTime();break;case"updated":C=new Date(x.updatedAt).getTime()-new Date(b.updatedAt).getTime();break;case"title":C=x.frontContent.title.localeCompare(b.frontContent.title);break;default:C=0}return n.sortOrder==="desc"?-C:C}),p},[a,t,n]),h=c.useCallback(async p=>{const x=hs();try{switch(p.type){case"CREATE_CARD":{const b=crypto.randomUUID(),C={...p.payload,id:b,userId:x,createdAt:new Date,updatedAt:new Date,syncVersion:1,pendingSync:!0};await L.cards.add(C),await Ee.addOperation({type:"create",entity:"card",entityId:b,data:C,priority:"normal"}),await d();break}case"UPDATE_CARD":{const b={...p.payload.updates,userId:x,updatedAt:new Date,syncVersion:1,pendingSync:!0};await L.cards.update(p.payload.id,b),await Ee.addOperation({type:"update",entity:"card",entityId:p.payload.id,data:{...p.payload.updates,userId:x},priority:"normal"}),await d();break}case"DELETE_CARD":{const b=await L.cards.get(p.payload);if(b){const C=[...b.frontContent.images,...b.backContent.images];for(const w of C)if(w.url&&!w.url.startsWith("data:"))try{await Xe.deleteImage(w.url)}catch(j){console.warn("Failed to delete image:",j)}}await L.cards.delete(p.payload),await Ee.addOperation({type:"delete",entity:"card",entityId:p.payload,data:{userId:x},priority:"high"}),await d();break}case"FLIP_CARD":{const b=await L.cards.get(p.payload);if(b){const C={isFlipped:!b.isFlipped,updatedAt:new Date,syncVersion:(b.syncVersion||0)+1,pendingSync:!0};await L.cards.update(p.payload,C),await Ee.addOperation({type:"update",table:"cards",data:C,localId:p.payload}),await d()}break}case"SELECT_CARD":l(b=>b.includes(p.payload)?b.filter(C=>C!==p.payload):[...b,p.payload]);break;case"DESELECT_ALL":l([]);break;case"DUPLICATE_CARD":{const b=await L.cards.get(p.payload);if(b){const C=crypto.randomUUID(),w={...b,id:C,userId:x,createdAt:new Date,updatedAt:new Date,syncVersion:1,pendingSync:!0};await L.cards.add(w),await Ee.addOperation({type:"create",table:"cards",data:w,localId:C}),await d()}break}case"MOVE_TO_FOLDER":{const b={folderId:p.payload.folderId,userId:x,updatedAt:new Date,syncVersion:1,pendingSync:!0};await L.cards.update(p.payload.cardId,b),await Ee.addOperation({type:"update",table:"cards",data:b,localId:p.payload.cardId}),await d();break}default:console.warn("Unknown card action:",p)}}catch(b){throw console.error("Card operation failed:",b),b}},[d]),g=c.useCallback(p=>a.find(x=>x.id===p),[a]),S=c.useCallback(()=>a.filter(p=>i.includes(p.id)),[a,i]),N=c.useCallback(()=>{const p=new Set;return a.forEach(x=>{x.frontContent.tags.forEach(b=>p.add(b)),x.backContent.tags.forEach(b=>p.add(b))}),Array.from(p).sort()},[a]),E=c.useCallback(async(p,x)=>{const b=hs();try{const C=await L.cards.filter(w=>w.frontContent.tags.includes(p)||w.backContent.tags.includes(p)).toArray();for(const w of C){const j=K=>x?K.map(se=>se===p?x:se):K.filter(se=>se!==p),D=j(w.frontContent.tags),P=j(w.backContent.tags),$={frontContent:{...w.frontContent,tags:D,lastModified:new Date},backContent:{...w.backContent,tags:P,lastModified:new Date},userId:b,updatedAt:new Date,syncVersion:(w.syncVersion||0)+1,pendingSync:!0};await L.cards.update(w.id,$),await Ee.addOperation({type:"update",table:"cards",data:$,localId:w.id})}await d()}catch(C){throw console.error("Failed to update tags in cards:",C),C}},[d]),v=c.useCallback(p=>a.filter(x=>x.frontContent.tags.includes(p)||x.backContent.tags.includes(p)),[a]),f=c.useCallback(async(p,x)=>{const b=hs();try{const C=await L.cards.get(x);if(!C)throw new Error("Card not found");const w=await Xe.saveImage(p,x,C.folderId),j={id:w.id,url:w.filePath,alt:p.name,width:w.metadata.width,height:w.metadata.height,aspectRatio:w.metadata.width/w.metadata.height},D=C.isFlipped?"backContent":"frontContent",P=[...C[D].images,j];return await L.cards.update(x,$=>{D==="frontContent"?$.frontContent={...$.frontContent,images:P,lastModified:new Date}:$.backContent={...$.backContent,images:P,lastModified:new Date},$.userId=b,$.updatedAt=new Date,$.syncVersion=($.syncVersion||0)+1,$.pendingSync=!0}),await Ee.addOperation({type:"update",table:"cards",data:{[D]:{images:P},userId:b,updatedAt:new Date},localId:x}),await d(),j}catch(C){throw console.error("Failed to upload image:",C),C}},[d]);return{cards:y(),allCards:a,filter:t,setFilter:r,viewSettings:n,setViewSettings:o,selectedCardIds:i,isLoading:m,dispatch:h,getCardById:g,getSelectedCards:S,getAllTags:N,updateTagsInAllCards:E,getCardsWithTag:v,handleImageUpload:f,loadCards:d}}class $e{static instance=null;MIGRATION_STATUS_KEY="cardall_migration_status";BACKUP_PREFIX="cardall_backup_";static getInstance(){return $e.instance||($e.instance=new $e),$e.instance}async needsMigration(){try{return!(this.getMigrationStatus()?.completed||!X.get("cards")||await L.cards.count()>0)}catch(e){return console.error("Failed to check migration status:",e),!1}}async migrate(e={}){const{createBackup:t=!0,validateData:r=!0,cleanupAfterSuccess:n=!0,progressCallback:o}=e,i=Date.now();try{if(!await this.needsMigration()){const h={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:[],duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"completed",progress:100,message:"No migration needed"}),h}this.reportProgress(o,{stage:"starting",progress:0,message:"Starting migration..."}),this.setMigrationStatus({started:!0,startTime:new Date,stage:"starting"}),this.reportProgress(o,{stage:"loading",progress:10,message:"Loading data from localStorage..."});const m=this.loadLocalStorageData();if(m.length===0){const h={success:!0,migratedCards:0,totalCards:0,errors:[],warnings:["No data found in localStorage"],duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"completed",progress:100,message:"No data to migrate"}),h}let u;if(t&&(this.reportProgress(o,{stage:"backup",progress:20,message:"Creating backup..."}),u=await this.createBackup(m)),r){this.reportProgress(o,{stage:"validation",progress:30,message:"Validating data integrity..."});const h=this.validateMigrationData(m);if(!h.valid)throw ce("VALIDATION_FAILED","Data validation failed",{errors:h.errors})}this.reportProgress(o,{stage:"migration",progress:50,message:`Migrating ${m.length} cards...`});const d=await this.performMigration(m,(h,g)=>{this.reportProgress(o,{stage:"migration",progress:50+h*.4,message:g})});if(r){this.reportProgress(o,{stage:"verification",progress:90,message:"Verifying migration results..."});const h=await this.verifyMigrationResults(m.length);if(!h.success)throw ce("VERIFICATION_FAILED","Migration verification failed",{details:h.errors})}n&&d.errors.length===0&&(this.reportProgress(o,{stage:"cleanup",progress:95,message:"Cleaning up original data..."}),this.cleanupLocalStorage()),this.setMigrationStatus({completed:!0,completedAt:new Date,success:!0,migratedCards:d.migratedCards,totalCards:m.length});const y={success:d.success,migratedCards:d.migratedCards,totalCards:m.length,errors:d.errors,warnings:d.warnings,duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"completed",progress:100,message:`Migration completed successfully: ${d.migratedCards}/${m.length} cards migrated`}),y}catch(l){this.setMigrationStatus({completed:!0,completedAt:new Date,success:!1,error:l instanceof Error?l.message:String(l)});const m={success:!1,migratedCards:0,totalCards:0,errors:[l instanceof Error?l.message:"Unknown migration error"],warnings:[],duration:Date.now()-i,timestamp:new Date};return this.reportProgress(o,{stage:"error",progress:0,message:`Migration failed: ${l instanceof Error?l.message:"Unknown error"}`}),m}}loadLocalStorageData(){try{return je.loadFromLocalStorage()}catch(e){throw ce("LOAD_DATA_FAILED","Failed to load data from localStorage",{error:e instanceof Error?e.message:String(e)})}}async createBackup(e){try{return await(await Es.create()).backupData()}catch(t){throw ce("BACKUP_FAILED","Failed to create backup",{error:t instanceof Error?t.message:String(t)})}}validateMigrationData(e){const t=[];return Array.isArray(e)?(e.forEach((r,n)=>{const o=je.validateCard(r);o.valid||t.push(`Card at index ${n}: ${o.errors.join(", ")}`)}),{valid:t.length===0,errors:t}):(t.push("Data is not an array"),{valid:!1,errors:t})}async performMigration(e,t){const r=[],n=[];let o=0;try{const i=je.bulkCardsToDbCards(e);return t&&t(.1,"Starting batch migration..."),await L.cards.bulkAdd(i),o=i.length,t&&t(1,"Batch migration completed"),{migratedCards:o,errors:r,warnings:n}}catch(i){console.warn("Bulk migration failed, trying individual migration:",i);const l=e.length;for(let u=0;u<e.length;u++){const d=e[u];try{const y=je.cardToDbCard(d);if(await L.cards.add(y),o++,t){const h=(u+1)/l;t(h,`Migrated card ${u+1}/${l}: ${d.frontContent.title}`)}}catch(y){console.error(`Failed to migrate card ${d.id}:`,y),r.push(d.id)}}return r.length===0||n.push(`Some cards failed to migrate: ${r.length} out of ${l}`),{migratedCards:o,errors:r,warnings:n}}}async verifyMigrationResults(e){const t=[];try{const r=await L.cards.count();if(r!==e&&t.push(`Record count mismatch: expected ${e}, got ${r}`),r>0){const n=await L.cards.limit(10).toArray();for(const o of n){const i=je.dbCardToCard(o),l=je.validateCard(i);l.valid||t.push(`Data integrity issue with card ${i.id}: ${l.errors.join(", ")}`)}}return{success:t.length===0,errors:t}}catch(r){return t.push(`Verification failed: ${r instanceof Error?r.message:String(r)}`),{success:!1,errors:t}}}cleanupLocalStorage(){try{X.remove("cards")}catch(e){console.warn("Failed to cleanup localStorage:",e)}}async rollback(){try{const e=this.getAvailableBackups();if(e.length===0)throw ce("NO_BACKUP","No backup available for rollback");const t=e[0];return await(await Es.create()).restoreData(t)?(this.setMigrationStatus({rolledBack:!0,rolledBackAt:new Date,backupId:t.id}),await L.cards.clear(),!0):!1}catch(e){throw ce("ROLLBACK_FAILED","Failed to rollback migration",{error:e instanceof Error?e.message:String(e)})}}getAvailableBackups(){const e=[];try{for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t);if(r&&r.startsWith(this.BACKUP_PREFIX))try{const n=X.get(r);n&&e.push({id:r,data:JSON.stringify(n),timestamp:new Date(n.timestamp),version:n.version||"1.0.0",cardCount:n.cards?.length||0,checksum:""})}catch(n){console.warn(`Failed to parse backup ${r}:`,n)}}}catch(t){console.error("Failed to get available backups:",t)}return e.sort((t,r)=>r.timestamp.getTime()-t.timestamp.getTime())}getMigrationStatus(){try{return X.get(this.MIGRATION_STATUS_KEY)}catch{return null}}setMigrationStatus(e){try{const t=this.getMigrationStatus()||{};X.set(this.MIGRATION_STATUS_KEY,{...t,...e})}catch(t){console.error("Failed to set migration status:",t)}}reportProgress(e,t){if(e)try{e(t)}catch(r){console.error("Progress callback error:",r)}}async getMigrationStats(){try{const e=this.getMigrationStatus(),t=this.getAvailableBackups();return{migrationNeeded:await this.needsMigration(),migrationCompleted:e?.completed||!1,migrationSuccessful:e?.success||!1,lastMigrationTime:e?.completedAt||null,availableBackups:t.length,localStorageCardCount:await this.getLocalStorageCardCount(),indexedDBCardCount:await L.cards.count()}}catch(e){throw ce("GET_STATS_FAILED","Failed to get migration stats",{error:e instanceof Error?e.message:String(e)})}}async getLocalStorageCardCount(){try{return je.loadFromLocalStorage().length}catch{return 0}}}$e.getInstance();async function qo(){const a=new Ve;try{const e=await a.isIndexedDBAvailable();let t=!1,r=0;if(e&&(t=await a.hasIndexedDBData(),t))try{const i=await Is(()=>import("./sync-Bq-7cJrZ.js").then(l=>l.c),__vite__mapDeps([0,1,2,3])).then(l=>l.db);if(i&&i.isOpen()){r=await i.cards.count();const[l,m,u]=await Promise.all([i.folders.count().catch(()=>0),i.tags.count().catch(()=>0),i.images.count().catch(()=>0)]);r+=l+m+u,console.debug(`IndexedDB data count: ${r} (cards: ${await i.cards.count()}, folders: ${l}, tags: ${m}, images: ${u})`)}}catch(i){console.debug("Failed to get IndexedDB data count:",i)}let n=!1,o=0;try{const i=localStorage.getItem("cards");if(i){const m=JSON.parse(i);Array.isArray(m)&&m.length>0&&(n=!0,o=m.length,console.debug(`localStorage data count: ${o}`))}const l=["folders","tags","settings"];for(const m of l){const u=localStorage.getItem(m);if(u)try{const d=JSON.parse(u);Array.isArray(d)&&d.length>0&&(n=!0,o+=d.length)}catch(d){console.debug(`Failed to parse localStorage ${m}:`,d)}}}catch(i){console.debug("Failed to check localStorage data:",i)}if(!e)return console.debug("IndexedDB not available, using localStorage"),"localStorage";if(t&&!n)return console.debug("Only IndexedDB has data, using IndexedDB"),"indexeddb";if(!t&&n)return console.debug("Only localStorage has data, using localStorage"),"localStorage";if(t&&n)return r>o?(console.debug(`Both have data, IndexedDB has more (${r} > ${o}), using IndexedDB`),"indexeddb"):o>r?(console.debug(`Both have data, localStorage has more (${o} > ${r}), using localStorage`),"localStorage"):(console.debug("Both have equal data, preferring IndexedDB"),"indexeddb");try{const i=localStorage.getItem("preferredStorageMode");if(i==="indexeddb"&&e)return console.debug("User prefers IndexedDB, using IndexedDB"),"indexeddb";if(i==="localStorage")return console.debug("User prefers localStorage, using localStorage"),"localStorage"}catch(i){console.debug("Failed to get user preference:",i)}return e?(console.debug("Default: IndexedDB available, using IndexedDB"),"indexeddb"):(console.debug("Default: using localStorage"),"localStorage")}catch(e){return console.error("Error determining storage mode:",e),"localStorage"}}function Jo(){const[a,e]=c.useState({mode:"localStorage",isReady:!1}),t=Ho(),r=Yo();c.useEffect(()=>{(async()=>{try{e(y=>({...y,mode:"migrating",isReady:!1}));const m=$e.getInstance();await m.needsMigration()&&await m.migrate({createBackup:!0,validateData:!0,cleanupAfterSuccess:!0,progressCallback:y=>{e(h=>({...h,migrationProgress:{stage:y.stage,progress:y.progress,message:y.message}}))}});const d=await qo();e({mode:d,isReady:!0})}catch(m){console.error("Failed to initialize adapter:",m),e({mode:"localStorage",isReady:!0})}})()},[]);const n=a.mode==="indexeddb"?r:t,o=c.useCallback(async()=>{e(l=>({...l,mode:"migrating",isReady:!1}));try{const m=await $e.getInstance().migrate({createBackup:!0,validateData:!0,cleanupAfterSuccess:!0,progressCallback:u=>{e(d=>({...d,migrationProgress:{stage:u.stage,progress:u.progress,message:u.message}}))}});e(m?{mode:"indexeddb",isReady:!0}:{mode:"localStorage",isReady:!0})}catch(l){console.error("Migration retry failed:",l),e({mode:"localStorage",isReady:!0})}},[]),i=c.useCallback(async()=>{try{await $e.getInstance().rollback()&&e({mode:"localStorage",isReady:!0})}catch(l){console.error("Rollback failed:",l)}},[]);return{...n,adapterState:a,storageMode:a.mode,isReady:a.isReady,migrationProgress:a.migrationProgress,retryMigration:o,rollbackMigration:i,isUsingLocalStorage:a.mode==="localStorage",isUsingIndexedDB:a.mode==="indexeddb",isMigrating:a.mode==="migrating"}}const ps=[{id:"folder-1",name:"Development",color:"#3b82f6",icon:"Code",cardIds:["1"],isExpanded:!0,createdAt:new Date("2024-01-10"),updatedAt:new Date("2024-01-15")},{id:"folder-2",name:"Design Resources",color:"#8b5cf6",icon:"Palette",cardIds:[],isExpanded:!1,createdAt:new Date("2024-01-12"),updatedAt:new Date("2024-01-12")},{id:"folder-3",name:"Learning Notes",color:"#10b981",icon:"BookOpen",cardIds:["2"],parentId:"folder-1",isExpanded:!0,createdAt:new Date("2024-01-14"),updatedAt:new Date("2024-01-16")}];function Xo(){const[a,e]=c.useState(()=>{try{return X.get("folders_state_backup",{validate:!0,encrypt:!0})||[]}catch{return[]}}),[t,r]=c.useState(!1),[n,o]=c.useState(null),[i,l]=c.useState(!0),m=c.useCallback(()=>{const f=a.filter(x=>!x.parentId),p=x=>x.map(b=>{const C=p(a.filter(D=>D.parentId===b.id)),w=C.length>0,j=b.isExpanded!==void 0?b.isExpanded:!!w;return{...b,isExpanded:j,children:C}});return p(f)},[a]),u=c.useCallback(f=>{console.log("🎯 Folder Action dispatched:",f.type,f.payload),e(x=>{try{switch(f.type){case"CREATE_FOLDER":console.log("➕ Creating new folder...");const C=Rt.getCurrentUser()?.id||"default",w={...f.payload,id:`folder-${Date.now()}`,cardIds:[],syncVersion:1,pendingSync:!0,userId:C,createdAt:new Date,updatedAt:new Date};return console.log("✅ New folder created:",w.id,w.name),[...x,w];case"UPDATE_FOLDER":console.log("📝 Updating folder:",f.payload.id);const j=x.map($=>$.id===f.payload.id?{...$,...f.payload.updates,updatedAt:new Date,syncVersion:($.syncVersion||1)+1,pendingSync:!0}:$);return console.log("✅ Folder updated:",f.payload.id),j;case"DELETE_FOLDER":if(console.log("🗑️ Deleting folder:",f.payload),x.find($=>$.id===f.payload)){const $=te=>{const ne=x.filter(Y=>Y.parentId===te),ge=ne.map(Y=>Y.id),z=ne.flatMap(Y=>$(Y.id));return[...ge,...z]},K=$(f.payload),se=[f.payload,...K],V=x.filter(te=>se.includes(te.id)).flatMap(te=>te.cardIds);console.log("📋 Folders to delete:",se.length),console.log("📋 Cards to delete:",V.length),"onDeleteCards"in f&&f.onDeleteCards&&V.length>0&&(console.log("🔄 Triggering card deletion callback..."),f.onDeleteCards(V));const re=x.filter(te=>!se.includes(te.id));return console.log("✅ Folder deleted successfully. Remaining folders:",re.length),re}return console.warn("⚠️ Folder to delete not found:",f.payload),x.filter($=>$.id!==f.payload);case"TOGGLE_FOLDER":console.log("🔄 Toggling folder expansion:",f.payload);const P=x.map($=>$.id===f.payload?{...$,isExpanded:$.isExpanded!==void 0?!$.isExpanded:!0,updatedAt:new Date,syncVersion:($.syncVersion||1)+1,pendingSync:!0}:$);return console.log("✅ Folder toggled:",f.payload),P;default:return console.warn("⚠️ Unknown folder action:",f.type),x}}catch(b){return console.error("❌ Error in folder dispatch:",b),x}}),setTimeout(()=>{try{f.type==="CREATE_FOLDER"?(console.log("☁️ 触发文件夹创建同步..."),Vt("create",f.payload)):f.type==="UPDATE_FOLDER"?(console.log("☁️ 触发文件夹更新同步..."),Vt("update",{id:f.payload.id,updates:f.payload.updates})):f.type==="DELETE_FOLDER"?(console.log("☁️ 触发文件夹删除同步..."),Vt("delete",f.payload)):f.type==="TOGGLE_FOLDER"&&(console.log("☁️ 触发文件夹展开状态同步..."),Vt("toggle",{id:f.payload,isExpanded:!d(f.payload)?.isExpanded}))}catch(x){console.error("❌ 触发同步失败:",x)}},50)},[]),d=c.useCallback(f=>a.find(p=>p.id===f),[a]),y=c.useCallback(f=>{const p=[];let x=d(f);for(;x;)p.unshift(x),x=x.parentId?d(x.parentId):null;return p},[a,d]),h=c.useCallback((f,p)=>{u({type:"UPDATE_FOLDER",payload:{id:p,updates:{cardIds:[...d(p)?.cardIds||[],f]}}})},[u,d]),g=c.useCallback((f,p)=>{const x=d(p);x&&u({type:"UPDATE_FOLDER",payload:{id:p,updates:{cardIds:x.cardIds.filter(b=>b!==f)}}})},[u,d]),S=c.useCallback((f,p,x)=>{p&&g(f,p),x&&h(f,x)},[h,g]),N=c.useCallback((f,p)=>{if(f===p)return!1;let x=p;for(;x;){if(x===f)return!1;x=d(x)?.parentId??null}return!0},[d]),E=c.useCallback(async()=>{try{if(a.length===0)return console.log("📋 没有文件夹数据，跳过一致性检查"),l(!0),!0;console.log("🔍 开始检查文件夹数据一致性...");const f=await L.folders.toArray(),p=new Set(f.map(D=>D.id)),x=new Set(a.map(D=>D.id));console.log("📊 数据统计:"),console.log("  - 内存中文件夹:",a.length),console.log("  - IndexedDB中文件夹:",f.length);let b=!0;a.length>0&&f.length===0&&console.warn("⚠️ 内存中有数据但IndexedDB为空，可能正在同步中");const C=a.filter(D=>!p.has(D.id)),w=f.filter(D=>!x.has(D.id));if(C.length>0&&(console.warn("❌ 发现IndexedDB中缺失的文件夹:",C.map(D=>D.id)),b=!1),w.length>0&&w.length>3&&(console.warn("⚠️ 发现IndexedDB中多余的文件夹:",w.map(D=>D.id)),b=!1),a.length>0){const D=a.filter(P=>!P.syncVersion||P.pendingSync===void 0);if(D.length>0){console.warn("⚠️ 发现缺少同步字段的文件夹:",D.map($=>$.id));const P=a.map($=>({...$,syncVersion:$.syncVersion||1,pendingSync:$.pendingSync||!1,userId:$.userId||"default"}));JSON.stringify(P)!==JSON.stringify(a)&&(e(P),console.log("✅ 自动修复同步字段完成"))}}if(X.get("folder_data_needs_restore",{validate:!0})&&a.length===0){console.log("🔄 发现需要恢复的文件夹数据，且当前无数据");const D=X.get("folders_backup",{validate:!0,encrypt:!0});if(D&&D.length>0){console.log("💾 从备份恢复文件夹数据:",D.length),e(D),X.remove("folder_data_needs_restore"),X.remove("folders_backup");try{await L.folders.clear(),await L.folders.bulkAdd(D),console.log("✅ 恢复的文件夹数据已保存到IndexedDB"),b=!0}catch(P){console.error("❌ 恢复数据保存失败:",P)}}}return l(b),console.log("🎯 文件夹数据一致性检查完成:",b?"✅ 一致":"❌ 不一致"),b}catch(f){return console.error("❌ 数据一致性检查失败:",f),l(!1),!1}},[a]),v=c.useCallback(async()=>{try{return console.log("开始强制修复文件夹数据..."),X.set("folders_repair_backup",a,{validate:!0,encrypt:!0}),await L.folders.clear(),await L.folders.bulkAdd(a),X.remove("folder_data_needs_restore"),X.remove("folders_backup"),X.set("folder_migration_complete",!0,{validate:!0}),console.log("文件夹数据强制修复完成"),l(!0),!0}catch(f){return console.error("强制修复文件夹数据失败:",f),!1}},[a]);return c.useEffect(()=>{(async()=>{if(t){console.log("📁 文件夹数据已初始化，跳过加载");return}try{console.log("🔄 开始加载文件夹数据...");let p=[];if(a.length>0)console.log("📋 使用内存中的文件夹数据:",a.length),p=a;else try{const x=await L.folders.toArray();if(console.log("📊 从 IndexedDB 查找到文件夹:",x.length),x.length>0)p=x.map(b=>{const w=x.filter(j=>j.parentId===b.id).length>0;return{...b,cardIds:b.cardIds||[],syncVersion:b.syncVersion||1,pendingSync:b.pendingSync||!1,userId:b.userId||"default",isExpanded:b.isExpanded!==void 0?b.isExpanded:!!w}}),console.log("✅ 使用 IndexedDB 中的文件夹数据"),e(p);else{if(X.get("folder_migration_complete",{validate:!0})){console.log("🔄 迁移已完成但无数据，可能数据被清空，保持空状态"),r(!0);return}console.log("🎯 首次使用，初始化默认文件夹数据"),p=ps.map(C=>({...C,syncVersion:1,pendingSync:!1,userId:"default",isExpanded:C.isExpanded!==void 0?C.isExpanded:!0})),await L.folders.clear(),await L.folders.bulkAdd(p),X.set("folder_migration_complete",!0,{validate:!0}),console.log("✅ 默认文件夹数据已保存到 IndexedDB"),e(p)}}catch(x){console.error("❌ 从 IndexedDB 加载失败:",x);try{const b=X.get("folders_state_backup",{validate:!0,encrypt:!0});b&&b.length>0?(console.log("💾 从localStorage备份恢复文件夹数据:",b.length),p=b.map(C=>({...C,isExpanded:C.isExpanded!==void 0?C.isExpanded:!0})),e(p)):(p=ps.map(C=>({...C,syncVersion:1,pendingSync:!1,userId:"default",isExpanded:C.isExpanded!==void 0?C.isExpanded:!0})),console.log("🚨 使用默认文件夹数据作为应急方案"),e(p))}catch(b){console.error("❌ 从备份恢复失败:",b),p=ps.map(C=>({...C,syncVersion:1,pendingSync:!1,userId:"default",isExpanded:C.isExpanded!==void 0?C.isExpanded:!0})),e(p)}}r(!0),console.log("🎉 文件夹数据加载完成，共",p.length,"个文件夹"),setTimeout(async()=>{try{await E()||(console.warn("⚠️ 数据一致性检查失败，尝试修复..."),await v()),console.log("📁 文件夹数据加载完成，解耦同步服务将自动处理云端同步")}catch(x){console.error("❌ 后台数据处理失败:",x)}},1e3)}catch(p){console.error("❌ 加载文件夹数据失败:",p),r(!0)}})()},[t]),c.useEffect(()=>{if(!t){console.log("⏳ 数据初始化未完成，跳过保存操作");return}if(a.length===0){console.log("📋 没有文件夹数据，跳过保存操作");return}const p=setTimeout(async()=>{try{console.log("💾 开始保存文件夹数据到IndexedDB...");const x=await L.folders.toArray(),b=new Set(x.map(j=>j.id)),C=new Set(a.map(j=>j.id));if(x.length>0&&a.length===0){console.warn("⚠️ 检测到数据可能被清空，跳过保存以避免覆盖");return}const w=a.map(j=>{const P=a.filter($=>$.parentId===j.id).length>0;return{...j,syncVersion:j.syncVersion||1,pendingSync:j.pendingSync||!1,userId:j.userId||"default",isExpanded:j.isExpanded!==void 0?j.isExpanded:!!P,updatedAt:new Date}});await L.transaction("rw",L.folders,async()=>{if(C.size>0){const P=x.filter($=>!C.has($.id));P.length>0&&(await L.folders.bulkDelete(P.map($=>$.id)),console.log("🗑️ 删除已不存在的文件夹:",P.length))}const j=w.filter(P=>b.has(P.id));for(const P of j)await L.folders.update(P.id,P);console.log("📝 更新现有文件夹:",j.length);const D=w.filter(P=>!b.has(P.id));D.length>0&&(await L.folders.bulkAdd(D),console.log("➕ 添加新文件夹:",D.length))});try{X.set("folders_state_backup",a,{validate:!0,encrypt:!0}),console.log("💾 文件夹状态已备份到localStorage")}catch(j){console.warn("⚠️ 备份到localStorage失败:",j)}console.log("✅ 文件夹数据保存成功，共",w.length,"个文件夹"),setTimeout(async()=>{try{const j=await L.folders.toArray();console.log("🔍 验证保存结果: IndexedDB中现有",j.length,"个文件夹"),j.length!==w.length&&console.warn("⚠️ 保存的数据数量不匹配"),await E()||console.warn("⚠️ 保存后数据一致性检查失败")}catch(j){console.error("❌ 验证保存结果失败:",j)}},500)}catch(x){console.error("❌ 保存文件夹数据到IndexedDB失败:",x),console.warn("🔄 尝试重新保存文件夹数据...");try{const b=a.map(w=>{const D=a.filter(P=>P.parentId===w.id).length>0;return{...w,syncVersion:w.syncVersion||1,pendingSync:w.pendingSync||!1,userId:w.userId||"default",isExpanded:w.isExpanded!==void 0?w.isExpanded:!!D,updatedAt:new Date}});if((await L.folders.toArray()).length>0&&a.length>0){for(const w of b)await L.folders.put(w);console.log("✅ 文件夹数据更新保存成功")}else await L.folders.clear(),await L.folders.bulkAdd(b),console.log("✅ 文件夹数据重新保存成功")}catch(b){console.error("❌ 重新保存文件夹数据失败:",b),console.warn("💾 将文件夹数据临时保存到localStorage"),X.set("folders_backup",a,{validate:!0,encrypt:!0}),X.set("folder_data_needs_restore",!0,{validate:!0}),console.error("🚨 文件夹数据保存失败，已创建备份")}}},500);return()=>clearTimeout(p)},[a.length,t,a]),c.useEffect(()=>{const f=setInterval(async()=>{i&&await E()},3e4);return()=>clearInterval(f)},[i,E]),{folders:a,folderTree:m(),selectedFolderId:n,setSelectedFolderId:o,dispatch:u,getFolderById:d,getFolderPath:y,addCardToFolder:h,removeCardFromFolder:g,moveCardBetweenFolders:S,canMoveFolder:N,isConsistent:i,checkDataConsistency:E,forceDataRepair:v}}const Qo=[{id:"tag-1",name:"react",color:"#3b82f6",count:1,createdAt:new Date("2024-01-15")},{id:"tag-2",name:"frontend",color:"#8b5cf6",count:1,createdAt:new Date("2024-01-15")},{id:"tag-3",name:"best-practices",color:"#10b981",count:1,createdAt:new Date("2024-01-15")},{id:"tag-4",name:"typescript",color:"#f59e0b",count:1,createdAt:new Date("2024-01-16")},{id:"tag-5",name:"types",color:"#ef4444",count:1,createdAt:new Date("2024-01-16")},{id:"tag-6",name:"development",color:"#06b6d4",count:1,createdAt:new Date("2024-01-16")}],rt=["#3b82f6","#8b5cf6","#10b981","#f59e0b","#ef4444","#06b6d4","#8b5a2b","#6b7280","#ec4899","#84cc16","#f97316","#6366f1"];function Zo(){const[a,e]=c.useState(Qo),[t,r]=c.useState([]),n=c.useCallback(()=>a.filter(v=>!t.includes(v.id)),[a,t]),o=c.useCallback(v=>{const f=[...n()].sort((p,x)=>x.count-p.count);return v?f.slice(0,v):f},[n]),i=c.useCallback(v=>{e(f=>{switch(v.type){case"CREATE_TAG":const p=f.find(b=>b.name.toLowerCase()===v.payload.name.toLowerCase());if(p)return f.map(b=>b.id===p.id?{...b,count:b.count+1}:b);const x={...v.payload,id:`tag-${Date.now()}`,count:1,color:v.payload.color||rt[f.length%rt.length],createdAt:new Date};return[...f,x];case"UPDATE_TAG":return f.map(b=>b.id===v.payload.id?{...b,...v.payload.updates}:b);case"DELETE_TAG":return f.filter(b=>b.id!==v.payload);case"TOGGLE_TAG_VISIBILITY":return r(b=>b.includes(v.payload)?b.filter(C=>C!==v.payload):[...b,v.payload]),f;default:return f}})},[]),l=c.useCallback(v=>a.find(f=>f.id===v),[a]),m=c.useCallback(v=>a.find(f=>f.name.toLowerCase()===v.toLowerCase()),[a]),u=c.useCallback((v,f)=>{const p=m(v);return p||(i({type:"CREATE_TAG",payload:{name:v,color:f||rt[a.length%rt.length]}}),null)},[i,m,a.length]),d=c.useCallback((v,f)=>{const p=m(v);if(p){const x=Math.max(0,p.count+f);i(x===0?{type:"DELETE_TAG",payload:p.id}:{type:"UPDATE_TAG",payload:{id:p.id,updates:{count:x}}})}},[i,m]),y=c.useCallback(v=>{const f=v.reduce((C,w)=>(C[w]=(C[w]||0)+1,C),{}),p=a.map(C=>({...C,count:f[C.name]||0})),x=new Set(a.map(C=>C.name));Object.entries(f).forEach(([C,w])=>{if(!x.has(C)){const j={id:`tag-${Date.now()}-${Math.random()}`,name:C,color:rt[p.length%rt.length],count:w,createdAt:new Date};p.push(j)}});const b=p.filter(C=>C.count>0);e(b)},[a]),h=c.useCallback(v=>{if(!v.trim())return n();const f=v.toLowerCase();return n().filter(p=>p.name.toLowerCase().includes(f))},[n]),g=c.useCallback((v,f=5)=>v.trim()?h(v).slice(0,f):o(f),[h,o]),S=c.useCallback((v,f)=>{const p=m(v);if(!p)return!1;const x=m(f);return x&&x.id!==p.id?!1:(i({type:"UPDATE_TAG",payload:{id:p.id,updates:{name:f.trim()}}}),!0)},[i,m]),N=c.useCallback(v=>{const f=m(v);return f?(i({type:"DELETE_TAG",payload:f.id}),!0):!1},[i,m]),E=c.useCallback(()=>a.map(v=>v.name),[a]);return c.useEffect(()=>{const v=setTimeout(()=>{X.set("tags",a,{validate:!0,encrypt:!0}),X.set("hidden-tags",t,{validate:!0,encrypt:!0})},1e3);return()=>clearTimeout(v)},[a,t]),c.useEffect(()=>{const v=X.get("tags",{validate:!0,encrypt:!0});v&&e(v);const f=X.get("hidden-tags",{validate:!0,encrypt:!0});f&&r(f)},[]),{tags:n(),allTags:a,hiddenTags:t,popularTags:o,dispatch:i,getTagById:l,getTagByName:m,createTagIfNotExists:u,updateTagCount:d,syncTagsWithCards:y,searchTags:h,getTagSuggestions:g,renameTag:S,deleteTagByName:N,getAllTagNames:E}}const xr=c.createContext(null);function ei({children:a}){const e=Jo(),t=Xo(),r=Zo();U.useEffect(()=>{if(e.isReady&&!e.isMigrating){const o=[];e.allCards.forEach(i=>{o.push(...i.frontContent.tags,...i.backContent.tags)}),r.syncTagsWithCards(o)}},[e.allCards,e.isReady,e.isMigrating,r.syncTagsWithCards]);const n={cards:e,folders:t,tags:r};return s.jsx(xr.Provider,{value:n,children:a})}function Ps(){const a=c.useContext(xr);if(!a)throw new Error("useCardAll must be used within a CardAllProvider");return a}function ti(){return Ps().cards}function wr(){return Ps().folders}function br(){return Ps().tags}const vr=c.createContext(void 0);function si({children:a}){const[e,t]=c.useState(!1),r=()=>t(!0),n=()=>t(!1);return s.jsx(vr.Provider,{value:{isOpen:e,openModal:r,closeModal:n},children:a})}function Cr(){const a=c.useContext(vr);if(a===void 0)throw new Error("useAuthModal must be used within an AuthModalProvider");return a}function I(...a){return Jn(Xn(a))}const Ls=Xt("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),H=c.forwardRef(({className:a,variant:e,size:t,asChild:r=!1,...n},o)=>{const i=r?xn:"button";return s.jsx(i,{className:I(Ls({variant:e,size:t,className:a})),ref:o,...n})});H.displayName="Button";const ai=bn,ri=vn,ni=c.forwardRef(({className:a,inset:e,children:t,...r},n)=>s.jsxs(ha,{ref:n,className:I("flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",a),...r,children:[t,s.jsx(Qt,{className:"ml-auto"})]}));ni.displayName=ha.displayName;const oi=c.forwardRef(({className:a,...e},t)=>s.jsx(pa,{ref:t,className:I("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e}));oi.displayName=pa.displayName;const jr=c.forwardRef(({className:a,sideOffset:e=4,...t},r)=>s.jsx(wn,{children:s.jsx(ya,{ref:r,sideOffset:e,className:I("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...t})}));jr.displayName=ya.displayName;const Le=c.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(xa,{ref:r,className:I("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",a),...t}));Le.displayName=xa.displayName;const ii=c.forwardRef(({className:a,children:e,checked:t,...r},n)=>s.jsxs(wa,{ref:n,className:I("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:t,...r,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(ba,{children:s.jsx(Ke,{className:"h-4 w-4"})})}),e]}));ii.displayName=wa.displayName;const li=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(va,{ref:r,className:I("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(ba,{children:s.jsx(cr,{className:"h-2 w-2 fill-current"})})}),e]}));li.displayName=va.displayName;const ci=c.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(Ca,{ref:r,className:I("px-2 py-1.5 text-sm font-semibold",e&&"pl-8",a),...t}));ci.displayName=Ca.displayName;const Ds=c.forwardRef(({className:a,...e},t)=>s.jsx(ja,{ref:t,className:I("-mx-1 my-1 h-px bg-muted",a),...e}));Ds.displayName=ja.displayName;const ys=[{emoji:"😀",name:"grinning"},{emoji:"😃",name:"smiley"},{emoji:"😄",name:"smile"},{emoji:"😁",name:"grin"},{emoji:"😆",name:"laughing"},{emoji:"😅",name:"sweat_smile"},{emoji:"🤣",name:"rofl"},{emoji:"😂",name:"joy"},{emoji:"🙂",name:"slightly_smiling_face"},{emoji:"🙃",name:"upside_down_face"},{emoji:"😉",name:"wink"},{emoji:"😊",name:"blush"},{emoji:"😇",name:"innocent"},{emoji:"🥰",name:"smiling_face_with_hearts"},{emoji:"😍",name:"heart_eyes"},{emoji:"🤩",name:"star_struck"},{emoji:"😘",name:"kissing_heart"},{emoji:"😗",name:"kissing"},{emoji:"😚",name:"kissing_closed_eyes"},{emoji:"😙",name:"kissing_smiling_eyes"},{emoji:"🥲",name:"smiling_face_with_tear"},{emoji:"😋",name:"yum"},{emoji:"😛",name:"stuck_out_tongue"},{emoji:"😜",name:"stuck_out_tongue_winking_eye"},{emoji:"🤪",name:"zany_face"},{emoji:"😝",name:"stuck_out_tongue_closed_eyes"},{emoji:"🤑",name:"money_mouth_face"},{emoji:"🤗",name:"hugs"},{emoji:"🤭",name:"hand_over_mouth"},{emoji:"🤫",name:"shushing_face"},{emoji:"🤔",name:"thinking"},{emoji:"🤐",name:"zipper_mouth_face"},{emoji:"🤨",name:"raised_eyebrow"},{emoji:"😐",name:"neutral_face"},{emoji:"😑",name:"expressionless"},{emoji:"😶",name:"no_mouth"},{emoji:"😏",name:"smirk"},{emoji:"😒",name:"unamused"},{emoji:"🙄",name:"roll_eyes"},{emoji:"😬",name:"grimacing"},{emoji:"🤥",name:"lying_face"},{emoji:"😔",name:"pensive"},{emoji:"😪",name:"sleepy"},{emoji:"🤤",name:"drooling_face"},{emoji:"😴",name:"sleeping"},{emoji:"😷",name:"mask"},{emoji:"🤒",name:"face_with_thermometer"},{emoji:"🤕",name:"face_with_head_bandage"},{emoji:"🤢",name:"nauseated_face"},{emoji:"🤮",name:"vomiting_face"},{emoji:"🤧",name:"sneezing_face"},{emoji:"🥵",name:"hot_face"},{emoji:"🥶",name:"cold_face"},{emoji:"🥴",name:"woozy_face"},{emoji:"😵",name:"dizzy_face"},{emoji:"🤯",name:"exploding_head"},{emoji:"🤠",name:"cowboy_hat_face"},{emoji:"🥳",name:"partying_face"},{emoji:"🥸",name:"disguised_face"},{emoji:"😎",name:"sunglasses"},{emoji:"🤓",name:"nerd_face"},{emoji:"🧐",name:"monocle_face"},{emoji:"😕",name:"confused"},{emoji:"😟",name:"worried"},{emoji:"🙁",name:"slightly_frowning_face"},{emoji:"☹️",name:"frowning_face"},{emoji:"😮",name:"open_mouth"},{emoji:"😯",name:"hushed"},{emoji:"😲",name:"astonished"},{emoji:"😳",name:"flushed"},{emoji:"🥺",name:"pleading_face"},{emoji:"😦",name:"frowning"},{emoji:"😧",name:"anguished"},{emoji:"😨",name:"fearful"},{emoji:"😰",name:"cold_sweat"},{emoji:"😥",name:"disappointed_relieved"},{emoji:"😢",name:"cry"},{emoji:"😭",name:"sob"},{emoji:"😱",name:"scream"},{emoji:"😖",name:"confounded"},{emoji:"😣",name:"persevere"},{emoji:"😞",name:"disappointed"},{emoji:"😓",name:"sweat"},{emoji:"😩",name:"weary"},{emoji:"😫",name:"tired_face"},{emoji:"🥱",name:"yawning_face"},{emoji:"😤",name:"triumph"},{emoji:"😡",name:"rage"},{emoji:"😠",name:"angry"},{emoji:"🤬",name:"cursing_face"},{emoji:"😈",name:"smiling_imp"},{emoji:"👿",name:"imp"},{emoji:"💀",name:"skull"},{emoji:"☠️",name:"skull_and_crossbones"},{emoji:"💩",name:"poop"},{emoji:"🤡",name:"clown_face"},{emoji:"👹",name:"ogre"},{emoji:"👺",name:"goblin"},{emoji:"👻",name:"ghost"},{emoji:"👽",name:"alien"},{emoji:"👾",name:"space_invader"},{emoji:"🤖",name:"robot"},{emoji:"😺",name:"smiley_cat"},{emoji:"😸",name:"smile_cat"},{emoji:"😹",name:"joy_cat"},{emoji:"😻",name:"heart_eyes_cat"},{emoji:"😼",name:"smirk_cat"},{emoji:"😽",name:"kissing_cat"},{emoji:"🙀",name:"scream_cat"},{emoji:"😿",name:"crying_cat_face"},{emoji:"😾",name:"pouting_cat"},{emoji:"👋",name:"wave"},{emoji:"🤚",name:"raised_back_of_hand"},{emoji:"🖐️",name:"raised_hand_with_fingers_splayed"},{emoji:"✋",name:"hand"},{emoji:"🖖",name:"vulcan_salute"},{emoji:"👌",name:"ok_hand"},{emoji:"🤌",name:"pinched_fingers"},{emoji:"🤏",name:"pinching_hand"},{emoji:"✌️",name:"v"},{emoji:"🤞",name:"crossed_fingers"},{emoji:"🤟",name:"love_you_gesture"},{emoji:"🤘",name:"metal"},{emoji:"🤙",name:"call_me_hand"},{emoji:"👈",name:"point_left"},{emoji:"👉",name:"point_right"},{emoji:"👆",name:"point_up_2"},{emoji:"🖕",name:"middle_finger"},{emoji:"👇",name:"point_down"},{emoji:"☝️",name:"point_up"},{emoji:"👍",name:"thumbsup"},{emoji:"👎",name:"thumbsdown"},{emoji:"✊",name:"fist"},{emoji:"👊",name:"facepunch"},{emoji:"🤛",name:"fist_left"},{emoji:"🤜",name:"fist_right"},{emoji:"👏",name:"clap"},{emoji:"🙌",name:"raised_hands"},{emoji:"👐",name:"open_hands"},{emoji:"🤲",name:"palms_up_together"},{emoji:"🤝",name:"handshake"},{emoji:"🙏",name:"pray"},{emoji:"❤️",name:"heart"},{emoji:"🧡",name:"orange_heart"},{emoji:"💛",name:"yellow_heart"},{emoji:"💚",name:"green_heart"},{emoji:"💙",name:"blue_heart"},{emoji:"💜",name:"purple_heart"},{emoji:"🖤",name:"black_heart"},{emoji:"🤍",name:"white_heart"},{emoji:"🤎",name:"brown_heart"},{emoji:"💔",name:"broken_heart"},{emoji:"❣️",name:"heavy_heart_exclamation"},{emoji:"💕",name:"two_hearts"},{emoji:"💞",name:"revolving_hearts"},{emoji:"💓",name:"heartbeat"},{emoji:"💗",name:"heartpulse"},{emoji:"💖",name:"sparkling_heart"},{emoji:"💘",name:"cupid"},{emoji:"💝",name:"gift_heart"},{emoji:"💟",name:"heart_decoration"},{emoji:"☮️",name:"peace_symbol"},{emoji:"✝️",name:"latin_cross"},{emoji:"☪️",name:"star_and_crescent"},{emoji:"🕉️",name:"om"},{emoji:"☸️",name:"wheel_of_dharma"},{emoji:"✡️",name:"star_of_david"},{emoji:"🔯",name:"six_pointed_star"},{emoji:"🕎",name:"menorah"},{emoji:"☯️",name:"yin_yang"},{emoji:"☦️",name:"orthodox_cross"},{emoji:"🛐",name:"place_of_worship"},{emoji:"⛎",name:"ophiuchus"},{emoji:"♈",name:"aries"},{emoji:"♉",name:"taurus"},{emoji:"♊",name:"gemini"},{emoji:"♋",name:"cancer"},{emoji:"♌",name:"leo"},{emoji:"♍",name:"virgo"},{emoji:"♎",name:"libra"},{emoji:"♏",name:"scorpius"},{emoji:"♐",name:"sagittarius"},{emoji:"♑",name:"capricorn"},{emoji:"♒",name:"aquarius"},{emoji:"♓",name:"pisces"},{emoji:"🆔",name:"id"},{emoji:"⚡",name:"zap"},{emoji:"💥",name:"boom"},{emoji:"💫",name:"dizzy"},{emoji:"💦",name:"sweat_drops"},{emoji:"💨",name:"dash"},{emoji:"🕳️",name:"hole"},{emoji:"💣",name:"bomb"},{emoji:"💬",name:"speech_balloon"},{emoji:"👁️‍🗨️",name:"eye_speech_bubble"},{emoji:"🗨️",name:"left_speech_bubble"},{emoji:"🗯️",name:"right_anger_bubble"},{emoji:"💭",name:"thought_balloon"},{emoji:"💤",name:"zzz"}];function di({onEmojiSelect:a,onClose:e,query:t="",position:r}){const[n,o]=c.useState(ys);c.useEffect(()=>{if(t&&t.trim()){const d=t.toLowerCase().trim(),y=ys.filter(h=>h.name.toLowerCase().includes(d)||h.emoji.includes(t)||h.name.toLowerCase().startsWith(d));o(y.slice(0,20))}else o(ys.slice(0,40))},[t]);const i=d=>{a(d),e()},l=d=>{d.key==="Escape"&&e()},m=()=>{if(!r)return{};const d=window.innerWidth,y=window.innerHeight,h=320,g=240;let S=r.x,N=r.y;return S+h>d&&(S=d-h-20),N+g>y&&(N=r.y-g-10),{left:Math.max(10,S),top:Math.max(10,N)}},u=s.jsxs("div",{className:"fixed bg-white border border-border rounded-lg shadow-xl p-3 w-80",style:{...m(),zIndex:2147483647},onKeyDown:l,children:[t&&s.jsxs("div",{className:"text-xs text-blue-600 mb-2 font-medium",children:['"',t,'"']}),s.jsx("div",{className:"grid grid-cols-10 gap-1 max-h-52 overflow-y-auto",children:n.map((d,y)=>s.jsx(H,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 hover:bg-blue-50 text-lg transition-colors",onClick:()=>i(d.emoji),title:d.name,children:d.emoji},`${d.emoji}-${y}`))}),n.length===0&&t&&s.jsx("div",{className:"text-center text-muted-foreground text-sm py-6",children:"No emojis found"})]});return Jt.createPortal(u,document.body)}function ui({content:a,placeholder:e="Start typing...",onUpdate:t,onSave:r,onCancel:n,className:o,autoFocus:i=!1}){const[l,m]=c.useState(!1),[u,d]=c.useState(""),[y,h]=c.useState(null),g=c.useRef(null),S=No({extensions:[ko.configure({strike:!1,code:!1,blockquote:!1}),Eo.configure({html:!0,transformPastedText:!0,transformCopiedText:!1}),Do,Ro.configure({nested:!0}),To.configure({openOnClick:!1,HTMLAttributes:{class:"text-blue-600 underline hover:text-blue-800 cursor-pointer",target:"_blank",rel:"noopener noreferrer"},protocols:["http","https","ftp","mailto"],validate:f=>/^https?:\/\//.test(f)}),Ao.configure({HTMLAttributes:{class:"border-l-4 border-gray-300 pl-4 italic"}}),Io.configure({HTMLAttributes:{class:"inline-code"}}),_o.configure({HTMLAttributes:{class:"code-block"}}),Mo.configure({HTMLAttributes:{class:"line-through"}}),Fo.configure({inline:!0,allowBase64:!0,HTMLAttributes:{class:"rounded-md max-w-full h-auto"}}),Oo.configure({placeholder:e})],content:a,onUpdate:({editor:f})=>{t(f.getHTML())},editorProps:{attributes:{class:"tiptap-editor text-sm leading-relaxed focus:outline-none min-h-[100px] w-full"},handleKeyDown:(f,p)=>{if(p.key==="/"&&!l){const{selection:x}=f.state,{from:b}=x,C=f.state.doc.resolve(b),w=C.parent.textBetween(0,C.parentOffset);if(!w.trim()||w.endsWith(" ")){const D=f.coordsAtPos(b);return h({x:D.left,y:D.bottom+5}),m(!0),d(""),p.preventDefault(),!0}}if(l){if(p.key==="Escape")return m(!1),d(""),!0;if(p.key==="Backspace")return u.length>0?d(x=>x.slice(0,-1)):m(!1),!0;if(p.key.length===1&&!p.ctrlKey&&!p.metaKey&&p.key!==" ")return d(x=>x+p.key),!0;if(p.key===" ")return m(!1),d(""),!0}return!1}}}),N=c.useCallback(()=>{const f=document.createElement("input");f.type="file",f.accept="image/*",f.onchange=p=>{const x=p.target.files?.[0];if(x&&S){const b=new FileReader;b.onload=C=>{const w=C.target?.result;S.chain().focus().setImage({src:w}).run()},b.readAsDataURL(x)}},f.click()},[S]);c.useEffect(()=>{if(!S)return;const f=x=>{const b=x.clipboardData?.items;if(b)for(let C=0;C<b.length;C++){const w=b[C];if(w.type.indexOf("image")!==-1){x.preventDefault();const j=w.getAsFile();if(j){const D=new FileReader;D.onload=P=>{const $=P.target?.result;S.chain().focus().setImage({src:$}).run()},D.readAsDataURL(j)}}}},p=S.view.dom;return p.addEventListener("paste",f),()=>{p.removeEventListener("paste",f)}},[S]);const E=c.useCallback(f=>{S&&S.chain().focus().insertContent(f).run(),m(!1),d("")},[S]),v=c.useCallback(()=>{m(!1),d("")},[]);return c.useEffect(()=>{if(!S)return;const f=x=>{x.key==="Escape"?l?(m(!1),d("")):n():x.key==="Enter"&&(x.ctrlKey||x.metaKey)&&r()},p=S.view.dom;return p.addEventListener("keydown",f),()=>{p.removeEventListener("keydown",f)}},[S,r,n,l]),c.useEffect(()=>{S&&i&&S.commands.focus()},[S,i]),S?s.jsxs("div",{className:I("relative z-20",o),ref:g,children:[s.jsxs("div",{className:"relative p-2 -m-2",children:[s.jsx(Po,{editor:S,className:"min-h-[100px]"}),s.jsxs("div",{className:"absolute top-0 right-0 flex gap-1 opacity-60 hover:opacity-100 transition-opacity",children:[s.jsx(H,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white/90 hover:bg-white shadow-sm rounded",onClick:()=>m(!l),title:"Insert Emoji (Press / to open)",children:s.jsx(Qn,{className:"h-3 w-3"})}),s.jsx(H,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 bg-white/90 hover:bg-white shadow-sm rounded",onClick:N,title:"Insert Image",children:s.jsx(dr,{className:"h-3 w-3"})})]})]}),l&&s.jsx(di,{onEmojiSelect:E,onClose:v,query:u,position:y||void 0}),s.jsxs("div",{className:"flex justify-end gap-2 mt-2 pt-2 border-t border-border/30",children:[s.jsxs(H,{size:"sm",variant:"ghost",onClick:n,className:"h-7 px-3 text-xs",children:[s.jsx(tt,{className:"h-3 w-3 mr-1"}),"Cancel"]}),s.jsxs(H,{size:"sm",onClick:r,className:"h-7 px-3 text-xs",children:[s.jsx(Ke,{className:"h-3 w-3 mr-1"}),"Accept"]})]}),S&&s.jsxs("div",{className:"absolute top-0 right-0 text-xs text-muted-foreground bg-white/90 px-2 py-1 rounded shadow-sm opacity-0 hover:opacity-100 transition-opacity pointer-events-none z-10 max-w-xs",children:["**bold** *italic* # heading - list ",">"," quote `code` ~~strike~~ [link](url) [] task / emoji"]})]}):null}function mi({content:a,onUpdate:e,onSave:t,onCancel:r,className:n,autoFocus:o=!1}){const[i,l]=c.useState(a),m=c.useRef(null);c.useEffect(()=>{l(a)},[a]),c.useEffect(()=>{o&&m.current&&(m.current.focus(),m.current.select())},[o]);const u=y=>{l(y.target.value),e(y.target.value)},d=y=>{y.key==="Enter"?t():y.key==="Escape"&&r()};return s.jsxs("div",{className:I("relative",n),children:[s.jsx("input",{ref:m,type:"text",value:i,onChange:u,onKeyDown:d,className:"w-full bg-transparent border-none outline-none text-lg font-semibold resize-none pr-16",placeholder:"Card title..."}),s.jsxs("div",{className:"absolute right-0 top-0 flex gap-1",children:[s.jsx(H,{size:"sm",variant:"ghost",onClick:r,className:"h-6 w-6 p-0 bg-white/80 hover:bg-white shadow-sm",children:s.jsx(tt,{className:"h-3 w-3"})}),s.jsx(H,{size:"sm",onClick:t,className:"h-6 w-6 p-0 bg-white/80 hover:bg-white shadow-sm",children:s.jsx(Ke,{className:"h-3 w-3"})})]})]})}const gi=a=>{const e=["#3b82f6","#8b5cf6","#10b981","#f59e0b","#ef4444","#06b6d4","#8b5a2b","#6b7280","#ec4899","#84cc16","#f97316","#6366f1"];let t=0;for(let r=0;r<a.length;r++)t=a.charCodeAt(r)+((t<<5)-t);return e[Math.abs(t)%e.length]},fi=({tags:a,className:e,maxTags:t=5,size:r="sm"})=>{if(!a||a.length===0)return null;const n=a.slice(0,t),o=a.length-t,i={sm:"text-xs px-2 py-1",md:"text-sm px-2.5 py-1.5",lg:"text-base px-3 py-2"};return s.jsxs("div",{className:I("flex flex-wrap gap-1.5 mt-3",e),children:[n.map((l,m)=>s.jsx("span",{className:I("inline-flex items-center rounded-full font-medium text-white","shadow-sm transition-all duration-200 hover:scale-105",i[r]),style:{backgroundColor:gi(l),fontSize:r==="sm"?"0.75rem":r==="md"?"0.875rem":"1rem"},children:l},`${l}-${m}`)),o>0&&s.jsxs("span",{className:I("inline-flex items-center rounded-full bg-gray-500 text-white font-medium",i[r]),children:["+",o]})]})};function hi({card:a,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onStyleChange:l,onTagsChange:m,onMoveToFolder:u,className:d,size:y="md"}){const[h,g]=c.useState(!1),[S,N]=c.useState(!1),[E,v]=c.useState(null),[f,p]=c.useState(null),[x,b]=c.useState(!1),[C,w]=c.useState(!1),j=c.useRef(null),D=C?a.backContent:a.frontContent,P={sm:"w-full",md:"w-full",lg:"w-full"},$={sm:"p-3",md:"p-4",lg:"p-5"},K=()=>{const{style:B}=a,q={borderRadius:"1rem",fontFamily:B.fontFamily,fontSize:B.fontSize==="sm"?"0.875rem":B.fontSize==="lg"?"1.125rem":"1rem",fontWeight:B.fontWeight,color:B.textColor,borderWidth:B.borderWidth||0,borderColor:B.borderColor};let M="";return B.type==="gradient"&&B.gradientColors?(q.background=`linear-gradient(135deg, ${B.gradientColors.join(", ")})`,B.gradientColors.includes("#8a2be2")&&B.gradientColors.includes("#00ffff")?(M="gradient-wave-animation",q.position="relative"):B.gradientColors.includes("#ee7752")&&B.gradientColors.includes("#23d5ab")?M="moving-gradient-animation":B.gradientColors.includes("#667eea")&&(M="gradient-mesh-animation")):B.type==="glass"?(q.background=B.backgroundColor||"rgba(255, 255, 255, 0.15)",q.backdropFilter="blur(20px) saturate(180%)",q.WebkitBackdropFilter="blur(20px) saturate(180%)",q.border=`1px solid ${B.borderColor||"rgba(255, 255, 255, 0.18)"}`,M="glass-morphism"):B.backgroundColor&&B.backgroundColor.includes("linear-gradient")?(q.background=B.backgroundColor,q.backgroundSize="400% 400%",B.backgroundColor.includes("#667eea")&&(M="gradient-mesh-animation")):(q.backgroundColor=B.backgroundColor,B.backgroundColor==="#1a1a2e"&&B.borderColor==="#4361ee"?M="pulse-border-animation":B.backgroundColor==="#0f172a"&&(M="glow-hover-animation")),{style:q,shadowClass:{sm:"shadow-sm",md:"shadow-md",lg:"shadow-lg",xl:"shadow-xl",none:"","2xl":"shadow-2xl",glass:"shadow-lg"}[B.shadow||"md"]||"shadow-md",specialClasses:M}},{style:se,shadowClass:V,specialClasses:re}=K(),te=c.useCallback(B=>{B.stopPropagation(),B.preventDefault(),!x&&(b(!0),w(!C),e(a.id),setTimeout(()=>{b(!1)},600))},[a.id,e,x,C]),ne=B=>{B.stopPropagation(),z("content")},ge=B=>{z(B)},z=B=>{p(D),v(B),N(!0)},Y=(B,q)=>{f&&p({...f,[B]:q,lastModified:new Date})},_=()=>{if(f){const q={[C?"backContent":"frontContent"]:f};t(a.id,q)}N(!1),v(null),p(null)},A=()=>{N(!1),v(null),p(null)},T=B=>{Y("title",B.target.value)},W=B=>{Y("text",B.target.value)},J=B=>{B.key==="Escape"&&A(),B.key==="Enter"&&B.ctrlKey&&_()};return s.jsx("div",{className:I("relative group",d),"data-card-id":a.id,onMouseEnter:()=>g(!0),onMouseLeave:()=>g(!1),children:s.jsx("div",{className:"flip-card-container",style:{perspective:"1000px",width:"100%",minHeight:"fit-content"},children:s.jsxs("div",{ref:j,className:I("flip-card-inner relative transition-all duration-700 ease-in-out",P[y]),style:{minHeight:"fit-content",width:"100%",transformStyle:"preserve-3d",transform:C?"rotateY(180deg)":"rotateY(0deg)"},children:[s.jsx("div",{className:I("flip-card-face flip-card-front w-full flex flex-col transition-all duration-300 relative",V,re,$[y]),style:{...se,borderRadius:se.borderRadius,backfaceVisibility:"hidden",position:C?"absolute":"relative",opacity:C?0:1},children:s.jsx(Qs,{content:f||a.frontContent,isEditing:S&&!C,editingField:E,onTitleChange:T,onTextChange:W,onTempContentUpdate:Y,onSaveEdit:_,onCancelEdit:A,onDoubleClick:ge,onKeyDown:J,sideLabel:"Front",isHovered:h,onEdit:ne,onFlip:te,onCopy:()=>r(a.id),onScreenshot:()=>n(a.id),onShare:()=>o(a.id),onDelete:()=>i(a.id),onStyleChange:l?()=>l(a.id):void 0,onTagsChange:m?()=>m(a.id):void 0,onMoveToFolder:u,card:a,isFlipping:x,isCurrentlyFlipped:C})}),s.jsx("div",{className:I("flip-card-face flip-card-back w-full flex flex-col transition-all duration-300 relative",V,re,$[y]),style:{...se,borderRadius:se.borderRadius,backfaceVisibility:"hidden",transform:"rotateY(180deg)",position:C?"relative":"absolute",top:C?"auto":"0",opacity:C?1:0},children:s.jsx(Qs,{content:f||a.backContent,isEditing:S&&C,editingField:E,onTitleChange:T,onTextChange:W,onTempContentUpdate:Y,onSaveEdit:_,onCancelEdit:A,onDoubleClick:ge,onKeyDown:J,sideLabel:"Back",isHovered:h,onEdit:ne,onFlip:te,onCopy:()=>r(a.id),onScreenshot:()=>n(a.id),onShare:()=>o(a.id),onDelete:()=>i(a.id),onStyleChange:l?()=>l(a.id):void 0,onTagsChange:m?()=>m(a.id):void 0,onMoveToFolder:u,card:a,isFlipping:x,isCurrentlyFlipped:C})})]})})})}function pi({images:a}){const e=a.slice(0,4),t=e.length,r=o=>{switch(o){case 1:return"flex justify-center";case 2:return"grid grid-cols-2 gap-2";case 3:return"grid grid-cols-2 gap-2";case 4:default:return"grid grid-cols-2 gap-2"}},n=(o,i)=>{const l="relative aspect-video rounded-md overflow-hidden bg-muted transition-all duration-200 hover:scale-[1.02]";return o===1?`${l} max-w-xs w-full`:o===3&&i===2?`${l} col-span-2 max-w-xs mx-auto`:l};return s.jsx("div",{className:r(t),children:e.map((o,i)=>s.jsx("div",{className:n(t,i),children:s.jsx("img",{src:o.url,alt:o.alt||`Image ${i+1}`,className:"w-full h-full object-cover transition-transform duration-200",loading:"lazy"})},i))})}function Qs({content:a,isEditing:e,editingField:t,onTempContentUpdate:r,onSaveEdit:n,onCancelEdit:o,onDoubleClick:i,isHovered:l,onEdit:m,onFlip:u,onCopy:d,onScreenshot:y,onShare:h,onDelete:g,onStyleChange:S,onTagsChange:N,onMoveToFolder:E,isFlipping:v,isCurrentlyFlipped:f,_onTitleChange:p,_onTextChange:x,_onKeyDown:b,_sideLabel:C,_card:w}){return s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsxs("div",{className:"flex items-start justify-between mb-3",children:[s.jsx("div",{className:"flex-1 mr-2",children:e&&t==="title"?s.jsx(mi,{content:a.title,onUpdate:j=>r("title",j),onSave:n,onCancel:o,autoFocus:!0}):s.jsx("h3",{className:"text-lg font-semibold text-left cursor-pointer hover:bg-black/5 rounded px-1 py-0.5 -mx-1 transition-colors",onDoubleClick:()=>i("title"),children:a.title||"Untitled Card"})}),s.jsxs("div",{className:I("flex gap-1 transition-all duration-200 flex-shrink-0",l||e?"opacity-100":"opacity-60"),children:[s.jsx(H,{size:"sm",variant:"ghost",className:I("h-7 w-7 p-0 rounded-md hover:bg-black/10 transition-all duration-200",v&&"animate-pulse"),onClick:u,title:`Flip to ${f?"Front":"Back"}`,disabled:v,children:s.jsx(Zn,{className:I("h-3.5 w-3.5 transition-transform duration-200",v&&"scale-110")})}),s.jsxs(ai,{children:[s.jsx(ri,{asChild:!0,children:s.jsx(H,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 rounded-md hover:bg-black/10 transition-all duration-200",onClick:j=>j.stopPropagation(),children:s.jsx(eo,{className:"h-3.5 w-3.5"})})}),s.jsxs(jr,{align:"end",className:"w-48",children:[s.jsxs(Le,{onClick:m,children:[s.jsx(to,{className:"h-4 w-4 mr-2"}),"Edit Content"]}),s.jsxs(Le,{onClick:d,children:[s.jsx(so,{className:"h-4 w-4 mr-2"}),"Copy Text"]}),s.jsxs(Le,{onClick:y,children:[s.jsx(js,{className:"h-4 w-4 mr-2"}),"Screenshot"]}),s.jsxs(Le,{onClick:h,children:[s.jsx(ao,{className:"h-4 w-4 mr-2"}),"Share"]}),s.jsx(Ds,{}),S&&s.jsxs(Le,{onClick:S,children:[s.jsx(ur,{className:"h-4 w-4 mr-2"}),"Change Style"]}),N&&s.jsxs(Le,{onClick:N,children:[s.jsx(mr,{className:"h-4 w-4 mr-2"}),"Manage Tags"]}),E&&s.jsxs(Le,{onClick:E,children:[s.jsx(Yt,{className:"h-4 w-4 mr-2"}),"Move to Folder"]}),s.jsx(Ds,{}),s.jsxs(Le,{onClick:g,className:"text-destructive focus:text-destructive",children:[s.jsx(_s,{className:"h-4 w-4 mr-2"}),"Delete Card"]})]})]})]})]}),a.images.length>0&&s.jsxs("div",{className:"mb-3 flex-shrink-0",children:[s.jsx(pi,{images:a.images}),a.images.length>4&&s.jsxs("div",{className:"text-xs text-muted-foreground mt-1 text-center",children:["+",a.images.length-4," more images"]})]}),s.jsx("div",{className:"flex-1 mb-3 relative z-10",children:e&&t==="content"?s.jsx(ui,{content:a.text,placeholder:"Add your content here...",onUpdate:j=>r("text",j),onSave:n,onCancel:o,autoFocus:!0}):s.jsx("div",{className:"text-sm leading-relaxed text-left cursor-pointer hover:bg-black/5 rounded p-2 -m-2 transition-colors min-h-[100px] tiptap-editor relative z-10",onDoubleClick:j=>{j.target.tagName!=="A"&&i("content")},onClick:j=>{const D=j.target;if(D.tagName==="A"){j.stopPropagation();const P=D.getAttribute("href");P&&window.open(P,"_blank","noopener,noreferrer")}},children:s.jsx("div",{className:"whitespace-pre-wrap",dangerouslySetInnerHTML:{__html:a.text||'<span class="text-muted-foreground">Click to add content...</span>'}})})}),s.jsxs("div",{className:"mt-auto",children:[s.jsx(fi,{tags:a.tags,size:"sm"}),a.images.length>0&&s.jsx("div",{className:"flex items-center justify-end text-xs text-muted-foreground mt-2",children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(dr,{className:"h-3 w-3"}),s.jsx("span",{children:a.images.length})]})})]})]})}const Se=({title:a="Sample Card",content:e="This is a preview of how your card will look with this style.",style:t,isSelected:r=!1,onClick:n,className:o})=>{console.log("Rendering StylePreviewCard (Simplified):",{title:a,isSelected:r,style:t});const i=()=>{const l={minHeight:"60px",width:"100%",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",padding:"8px",borderRadius:"8px",cursor:"pointer",border:r?"2px solid #3b82f6":"1px solid #e5e7eb",position:"relative",fontSize:"10px",textAlign:"center",boxShadow:r?"0 4px 12px rgba(59, 130, 246, 0.3)":"0 2px 4px rgba(0, 0, 0, 0.1)",transition:"all 0.2s ease",backgroundColor:"#ffffff"};if(typeof t=="object"&&t!==null){if("background"in t||"backgroundColor"in t)return{...l,...t,cursor:"pointer",border:r?"3px solid #3b82f6":t.border||"2px solid #e5e7eb",boxShadow:r?"0 4px 12px rgba(59, 130, 246, 0.3)":t.boxShadow||"0 2px 4px rgba(0, 0, 0, 0.1)",transition:"all 0.2s ease"};if("type"in t){if(t.type==="solid")return{...l,backgroundColor:t.backgroundColor||"#ffffff",color:t.textColor||"#374151"};if(t.type==="gradient"&&t.gradientColors){const u=`linear-gradient(${t.gradientDirection||"to bottom right"}, ${t.gradientColors.join(", ")})`;return{...l,background:u,color:t.textColor||"#ffffff"}}}}return l};return s.jsxs("div",{style:i(),onClick:n,className:o,children:[s.jsx("div",{style:{fontWeight:"600",marginBottom:"2px",fontSize:"11px"},children:a}),s.jsx("div",{style:{fontSize:"9px",opacity:.8,lineHeight:"1.1"},children:e})]})},yi=({isSelected:a,onClick:e,className:t})=>{const r={background:"#ffffff",color:"#1f2937",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"400",borderRadius:"12px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",border:"1px solid #e5e7eb"};return s.jsx(Se,{title:"Classic White",content:"Clean and professional",style:r,isSelected:a,onClick:e,className:t})},xi={id:"classic-white",name:"Classic White",category:"business",description:"Clean and professional white background with subtle shadows",style:{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"2xl",shadow:"md",borderWidth:1,borderColor:"#e5e7eb"},previewComponent:yi},wi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #1f2937 0%, #111827 50%, #030712 100%)",color:"#f9fafb",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"12px",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1)",border:"1px solid rgba(255, 255, 255, 0.1)"};return s.jsx(Se,{title:"Deep Dark",content:"Bold and mysterious",style:r,isSelected:a,onClick:e,className:t})},bi={id:"deep-dark",name:"Deep Dark",category:"personality",description:"Bold dark gradient with mysterious depth",style:{type:"gradient",gradientColors:["#1f2937","#111827","#030712"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#f9fafb",borderRadius:"2xl",shadow:"2xl",borderWidth:1,borderColor:"rgba(255, 255, 255, 0.1)"},previewComponent:wi},vi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #c084fc 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"20px",boxShadow:"0 20px 25px -5px rgba(139, 92, 246, 0.25), 0 10px 10px -5px rgba(139, 92, 246, 0.1)",border:"none"};return s.jsx(Se,{title:"Elegant Purple",content:"Artistic and inspiring",style:r,isSelected:a,onClick:e,className:t})},Ci={id:"elegant-purple",name:"Elegant Purple",category:"creative",description:"Artistic purple gradient with elegant curves and shadows",style:{type:"gradient",gradientColors:["#8b5cf6","#a855f7","#c084fc"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:vi},ji=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"16px",boxShadow:"0 20px 25px -5px rgba(16, 185, 129, 0.2), 0 10px 10px -5px rgba(16, 185, 129, 0.1)",border:"none"};return s.jsx(Se,{title:"Fresh Green",content:"Natural and harmonious",style:r,isSelected:a,onClick:e,className:t})},Si={id:"fresh-green",name:"Fresh Green",category:"natural",description:"Natural green gradient with organic harmony",style:{type:"gradient",gradientColors:["#10b981","#059669","#047857"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:ji},Ni=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%)",backgroundSize:"400% 400%",animation:"gradientShift 8s ease infinite",color:"#ffffff",fontFamily:'"Inter", system-ui, -apple-system, sans-serif',fontSize:"14px",fontWeight:"500",borderRadius:"12px",boxShadow:"0 8px 32px rgba(102, 126, 234, 0.3), 0 4px 16px rgba(118, 75, 162, 0.2)",border:"none",position:"relative",overflow:"hidden"},n={position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%)",pointerEvents:"none"};return s.jsxs("div",{style:{position:"relative"},children:[s.jsx(Se,{title:"Gradient Mesh",content:"Dynamic gradient background",style:r,isSelected:a,onClick:e,className:t}),s.jsx("div",{style:n}),s.jsx("style",{jsx:!0,children:`
        @keyframes gradientShift {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
      `})]})},ki={id:"gradient-mesh",name:"Gradient Mesh",category:"creative",description:"Dynamic gradient background with animated mesh effect",style:{type:"solid",backgroundColor:"linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%)",fontFamily:"Inter",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"xl",borderWidth:0,borderColor:"transparent"},previewComponent:Ni},Ei=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(90deg, #fb923c 0%, #8b5cf6 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"24px",boxShadow:"0 25px 50px -12px rgba(251, 146, 60, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2)",border:"none"};return s.jsx(Se,{title:"Gradient Sunset",content:"Vibrant and expressive",style:r,isSelected:a,onClick:e,className:t})},Di={id:"gradient-sunset",name:"Gradient Sunset",category:"personality",description:"Warm orange to violet gradient with magical sunset vibes",style:{type:"gradient",gradientColors:["#fb923c","#8b5cf6"],gradientDirection:"to-r",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Ei},Ri=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #8a2be2 0%, #4b0082 25%, #9370db 50%, #00ffff 75%, #00bfff 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"24px",boxShadow:"0 25px 50px -12px rgba(138, 43, 226, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2)",border:"none",position:"relative",overflow:"hidden"};return s.jsx("div",{className:"relative",children:s.jsx(Se,{title:"Gradient Wave",content:"Dynamic wave effect",style:r,isSelected:a,onClick:e,className:`${t} gradient-wave-animation`})})},Ti={id:"gradient-wave",name:"Gradient Wave",category:"creative",description:"Purple to cyan gradient with dynamic wave effect",style:{type:"gradient",gradientColors:["#8a2be2","#4b0082","#9370db","#00ffff","#00bfff"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:Ri},Ai=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"16px",boxShadow:"0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1)",border:"none"};return s.jsx(Se,{title:"Modern Blue",content:"Contemporary gradient design",style:r,isSelected:a,onClick:e,className:t})},Ii={id:"modern-blue",name:"Modern Blue",category:"business",description:"Contemporary blue gradient with professional appeal",style:{type:"gradient",gradientColors:["#3b82f6","#1d4ed8","#1e40af"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"lg",borderWidth:0},previewComponent:Ai},_i=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab)",backgroundSize:"400% 400%",color:"#ffffff",fontFamily:'"Poppins", system-ui, sans-serif',fontSize:"14px",fontWeight:"600",borderRadius:"16px",boxShadow:"0 15px 30px -10px rgba(0, 0, 0, 0.25)",border:"none",position:"relative",overflow:"hidden"};return s.jsx("div",{className:"relative",children:s.jsx(Se,{title:"Moving Gradient",content:"Flowing color effect",style:r,isSelected:a,onClick:e,className:`${t} moving-gradient-animation`})})},Mi={id:"moving-gradient",name:"Moving Gradient",category:"creative",description:"Colorful gradient with flowing animation effect",style:{type:"gradient",gradientColors:["#ee7752","#e73c7e","#23a6d5","#23d5ab"],gradientDirection:"to-br",fontFamily:"Poppins",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"xl",shadow:"xl",borderWidth:0},previewComponent:_i},Fi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(90deg, #34d399 0%, #0d9488 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"20px",boxShadow:"0 10px 15px -3px rgba(52, 211, 153, 0.3), 0 4px 6px -2px rgba(13, 148, 136, 0.1)",border:"1px solid rgba(52, 211, 153, 0.3)"};return s.jsx(Se,{title:"Ocean Breeze",content:"Fresh and refreshing",style:r,isSelected:a,onClick:e,className:t})},Oi={id:"ocean-breeze",name:"Ocean Breeze",category:"natural",description:"Fresh emerald to teal gradient with tropical vibes",style:{type:"gradient",gradientColors:["#34d399","#0d9488"],gradientDirection:"to-r",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"lg",borderWidth:1,borderColor:"rgba(52, 211, 153, 0.3)"},previewComponent:Fi},Pi=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(90deg, #fda4af 0%, #f87171 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"500",borderRadius:"20px",boxShadow:"0 10px 15px -3px rgba(253, 164, 175, 0.3), 0 4px 6px -2px rgba(248, 113, 113, 0.1)",border:"1px solid rgba(253, 164, 175, 0.3)"};return s.jsx(Se,{title:"Soft Pink",content:"Gentle and soothing",style:r,isSelected:a,onClick:e,className:t})},Li={id:"soft-pink",name:"Soft Pink",category:"natural",description:"Warm pink to red gradient with romantic tones",style:{type:"gradient",gradientColors:["#fda4af","#f87171"],gradientDirection:"to-r",fontFamily:"system-ui",fontSize:"base",fontWeight:"medium",textColor:"#ffffff",borderRadius:"2xl",shadow:"lg",borderWidth:1,borderColor:"rgba(253, 164, 175, 0.3)"},previewComponent:Pi},$i=({isSelected:a,onClick:e,className:t})=>{const r={background:"linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%)",color:"#ffffff",fontFamily:"system-ui, -apple-system, sans-serif",fontSize:"14px",fontWeight:"600",borderRadius:"18px",boxShadow:"0 25px 50px -12px rgba(255, 126, 95, 0.25), 0 0 0 1px rgba(255, 126, 95, 0.1)",border:"none"};return s.jsx(Se,{title:"Warm Orange",content:"Energetic and vibrant",style:r,isSelected:a,onClick:e,className:t})},zi={id:"warm-orange",name:"Warm Orange",category:"creative",description:"Energetic warm orange gradient with peachy tones",style:{type:"gradient",gradientColors:["#ff7e5f","#feb47b"],gradientDirection:"to-br",fontFamily:"system-ui",fontSize:"base",fontWeight:"semibold",textColor:"#ffffff",borderRadius:"2xl",shadow:"2xl",borderWidth:0},previewComponent:$i};class it{static instance;presets=new Map;categories=new Map;constructor(){this.initializeCategories()}static getInstance(){return it.instance||(it.instance=new it),it.instance}initializeCategories(){["business","creative","natural","personality"].forEach(t=>{this.categories.set(t,[])})}register(e){this.presets.set(e.id,e);const t=this.categories.get(e.category)||[];t.push(e),this.categories.set(e.category,t)}unregister(e){const t=this.presets.get(e);if(t){this.presets.delete(e);const n=(this.categories.get(t.category)||[]).filter(o=>o.id!==e);this.categories.set(t.category,n)}}getByCategory(e){return this.categories.get(e)||[]}getById(e){return this.presets.get(e)}getAll(){return Array.from(this.presets.values())}getAllByOrder(){const e=[];return["business","creative","natural","personality"].forEach(r=>{const n=this.getByCategory(r);e.push(...n)}),e}getCategoryCount(e){return this.categories.get(e)?.length||0}getTotalCount(){return this.presets.size}clear(){this.presets.clear(),this.initializeCategories()}}const $s=it.getInstance(),Bi=()=>$s.getAllByOrder();class lt{static instance;STORAGE_KEYS={USER_PREFERENCES:"cardall_style_preferences",RECENT_STYLES:"cardall_recent_styles",DEFAULT_STYLE:"cardall_default_style"};constructor(){}static getInstance(){return lt.instance||(lt.instance=new lt),lt.instance}saveUserPreference(e,t){try{const r=this.getUserPreferences();r[e]={styleId:t,appliedAt:new Date().toISOString()},localStorage.setItem(this.STORAGE_KEYS.USER_PREFERENCES,JSON.stringify(r)),this.addToRecentStyles(t)}catch(r){console.error("Failed to save user style preference:",r)}}getUserPreference(e){try{return this.getUserPreferences()[e]?.styleId||null}catch(t){return console.error("Failed to get user style preference:",t),null}}getRecentStyles(e=10){try{const t=localStorage.getItem(this.STORAGE_KEYS.RECENT_STYLES);return t?JSON.parse(t).slice(0,e):[]}catch(t){return console.error("Failed to get recent styles:",t),[]}}clearPreferences(){try{localStorage.removeItem(this.STORAGE_KEYS.USER_PREFERENCES),localStorage.removeItem(this.STORAGE_KEYS.RECENT_STYLES)}catch(e){console.error("Failed to clear style preferences:",e)}}setDefaultStyle(e){try{localStorage.setItem(this.STORAGE_KEYS.DEFAULT_STYLE,e)}catch(t){console.error("Failed to set default style:",t)}}getDefaultStyle(){try{return localStorage.getItem(this.STORAGE_KEYS.DEFAULT_STYLE)}catch(e){return console.error("Failed to get default style:",e),null}}getUserPreferences(){try{const e=localStorage.getItem(this.STORAGE_KEYS.USER_PREFERENCES);return e?JSON.parse(e):{}}catch(e){return console.error("Failed to parse user preferences:",e),{}}}addToRecentStyles(e){try{const r=this.getRecentStyles().filter(o=>o!==e),n=[e,...r].slice(0,10);localStorage.setItem(this.STORAGE_KEYS.RECENT_STYLES,JSON.stringify(n))}catch(t){console.error("Failed to update recent styles:",t)}}getStyleUsageStats(){try{const e=this.getUserPreferences(),t={};return Object.values(e).forEach(({styleId:r})=>{t[r]=(t[r]||0)+1}),t}catch(e){return console.error("Failed to get style usage stats:",e),{}}}getMostUsedStyles(e=5){try{const t=this.getStyleUsageStats();return Object.entries(t).sort(([,r],[,n])=>n-r).slice(0,e).map(([r])=>r)}catch(t){return console.error("Failed to get most used styles:",t),[]}}}const Zs=lt.getInstance(),Ui=()=>{const a=[xi,Ii,Ci,zi,Si,Li,Oi,bi,Di,ki,Ti,Mi];a.forEach(e=>{$s.register(e)}),console.log(`Registered ${a.length} card style presets`)};Ui();const Vi=({isOpen:a,onClose:e,context:t})=>{const[r,n]=c.useState(null),[o,i]=c.useState([]);c.useEffect(()=>{const u=Bi();console.log("Loaded style presets:",u.length,u),i(u);const d=Zs.getUserPreference(t.targetCardId);d&&n(d)},[t.targetCardId]);const l=u=>{const d=$s.getById(u);d&&(n(u),t.onStyleApply(d.style),Zs.saveUserPreference(t.targetCardId,u))},m=()=>{n(null),e()};return a?s.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",style:{backgroundColor:"rgba(0, 0, 0, 0.1)",backdropFilter:"blur(2px)"},children:[s.jsx("div",{className:"absolute inset-0",onClick:m}),s.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl border border-gray-200 p-6 w-full max-w-md sm:max-w-2xl lg:max-w-4xl",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Card Styles"}),s.jsx("button",{onClick:m,className:"p-1 rounded-lg hover:bg-gray-100 transition-colors",children:s.jsx(tt,{className:"w-5 h-5 text-gray-500"})})]}),s.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 mb-6",style:{minHeight:"300px",maxHeight:"70vh",overflowY:"auto"},children:o.map(u=>{const d=u.previewComponent;return console.log("Rendering preset:",u.id,u.name,d),s.jsxs("div",{className:"relative",children:[s.jsx(d,{isSelected:r===u.id,onClick:()=>l(u.id),className:"w-full"}),s.jsxs("div",{className:"mt-2 text-center",children:[s.jsx("div",{className:"text-xs font-medium text-gray-700 truncate",children:u.name}),s.jsx("div",{className:"text-xs text-gray-500 capitalize",children:u.category})]})]},u.id)})}),s.jsxs("div",{className:"text-xs text-gray-400 text-center mb-2",children:["Loaded ",o.length," presets"]}),s.jsx("div",{className:"text-xs text-gray-500 text-center",children:"Click any style to apply it instantly to your card"})]})]}):null},Sr=c.createContext(void 0),Wi=()=>{const a=c.useContext(Sr);if(!a)throw new Error("useStylePanel must be used within a StylePanelProvider");return a},Hi=({children:a})=>{const[e,t]=c.useState({isOpen:!1,context:null}),r=i=>{t({isOpen:!0,context:i})},n=()=>{t({isOpen:!1,context:null})},o={openStylePanel:r,closeStylePanel:n,isOpen:e.isOpen};return s.jsxs(Sr.Provider,{value:o,children:[a,typeof window<"u"&&e.isOpen&&e.context&&Jt.createPortal(s.jsx(Vi,{isOpen:e.isOpen,onClose:n,context:e.context}),document.body)]})},Nr=c.createContext(void 0);function Gi({children:a}){const[e,t]=c.useState(!1),[r,n]=c.useState(null),[o,i]=c.useState([]),[l,m]=c.useState(null),y={isOpen:e,currentCardId:r,currentCardTags:o,onTagsChange:l,openTagPanel:h=>{n(h.targetCardId),i(h.currentTags),m(()=>h.onTagsApply),t(!0)},closeTagPanel:()=>{t(!1),n(null),i([]),m(null)}};return s.jsx(Nr.Provider,{value:y,children:a})}function kr(){const a=c.useContext(Nr);if(a===void 0)throw new Error("useTagPanel must be used within a TagPanelProvider");return a}const et=c.forwardRef(({className:a,type:e,...t},r)=>s.jsx("input",{type:e,className:I("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",a),ref:r,...t}));et.displayName="Input";const Ge=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Sa,{ref:r,className:I("relative overflow-hidden",a),...t,children:[s.jsx(Cn,{className:"h-full w-full rounded-[inherit]",children:e}),s.jsx(Er,{}),s.jsx(jn,{})]}));Ge.displayName=Sa.displayName;const Er=c.forwardRef(({className:a,orientation:e="vertical",...t},r)=>s.jsx(Na,{ref:r,orientation:e,className:I("flex touch-none select-none transition-colors",e==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",e==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",a),...t,children:s.jsx(Sn,{className:"relative flex-1 rounded-full bg-border"})}));Er.displayName=Na.displayName;const Ki=Xt("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function ee({className:a,variant:e,...t}){return s.jsx("div",{className:I(Ki({variant:e}),a),...t})}const Ft=En,Yi=Nn,Dr=c.forwardRef(({className:a,...e},t)=>s.jsx(ka,{ref:t,className:I("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...e}));Dr.displayName=ka.displayName;const xt=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Yi,{children:[s.jsx(Dr,{}),s.jsxs(Ea,{ref:r,className:I("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...t,children:[e,s.jsxs(kn,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[s.jsx(tt,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));xt.displayName=Ea.displayName;const wt=({className:a,...e})=>s.jsx("div",{className:I("flex flex-col space-y-1.5 text-center sm:text-left",a),...e});wt.displayName="DialogHeader";const bt=({className:a,...e})=>s.jsx("div",{className:I("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...e});bt.displayName="DialogFooter";const vt=c.forwardRef(({className:a,...e},t)=>s.jsx(Da,{ref:t,className:I("text-lg font-semibold leading-none tracking-tight",a),...e}));vt.displayName=Da.displayName;const Zt=c.forwardRef(({className:a,...e},t)=>s.jsx(Ra,{ref:t,className:I("text-sm text-muted-foreground",a),...e}));Zt.displayName=Ra.displayName;function qi({isOpen:a,onClose:e,currentCardId:t,currentFolderId:r,onFolderSelect:n}){const{folders:o,getFolderById:i}=wr(),[l,m]=c.useState(""),[u,d]=c.useState(r);c.useEffect(()=>{a&&(d(r),m(""))},[a,r]);const y=o.filter(v=>v.name.toLowerCase().includes(l.toLowerCase())),h=r?i(r):null,g=v=>{d(v)},S=()=>{n&&n(u),e()},N=()=>{d(r),e()},E=u!==r;return s.jsx(Ft,{open:a,onOpenChange:e,children:s.jsxs(xt,{className:"sm:max-w-md",children:[s.jsx(wt,{children:s.jsxs(vt,{className:"flex items-center gap-2",children:[s.jsx(He,{className:"h-5 w-5"}),"Move Card to Folder"]})}),s.jsxs("div",{className:"space-y-4",children:[h&&s.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted rounded-lg",children:[s.jsx(Yt,{className:"h-4 w-4 text-muted-foreground"}),s.jsx("span",{className:"text-sm text-muted-foreground",children:"Currently in:"}),s.jsx(ee,{variant:"secondary",children:h.name})]}),!h&&s.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted rounded-lg",children:[s.jsx(Ws,{className:"h-4 w-4 text-muted-foreground"}),s.jsx("span",{className:"text-sm text-muted-foreground",children:"Currently in: Root"})]}),s.jsxs("div",{className:"relative",children:[s.jsx(ut,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(et,{placeholder:"Search folders...",value:l,onChange:v=>m(v.target.value),className:"pl-10"})]}),s.jsx(Ge,{className:"h-64 w-full border rounded-md",children:s.jsxs("div",{className:"p-2 space-y-1",children:[s.jsxs("div",{className:I("flex items-center gap-3 p-2 rounded-md cursor-pointer transition-colors",u===null?"bg-primary text-primary-foreground":"hover:bg-muted"),onClick:()=>g(null),children:[s.jsx(Ws,{className:"h-4 w-4 flex-shrink-0"}),s.jsx("span",{className:"flex-1",children:"Root"}),u===null&&s.jsx(Ke,{className:"h-4 w-4 flex-shrink-0"}),r===null&&s.jsx(ee,{variant:"outline",className:"text-xs",children:"Current"})]}),y.map(v=>s.jsxs("div",{className:I("flex items-center gap-3 p-2 rounded-md cursor-pointer transition-colors",u===v.id?"bg-primary text-primary-foreground":"hover:bg-muted",r===v.id&&"opacity-60"),onClick:()=>g(v.id),children:[s.jsx(He,{className:"h-4 w-4 flex-shrink-0"}),s.jsx("span",{className:"flex-1",children:v.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ee,{variant:"outline",className:"text-xs",children:v.cardIds.length}),u===v.id&&s.jsx(Ke,{className:"h-4 w-4 flex-shrink-0"}),r===v.id&&s.jsx(ee,{variant:"outline",className:"text-xs",children:"Current"})]})]},v.id)),y.length===0&&l&&s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx(He,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),s.jsx("p",{className:"text-sm",children:"No folders found"})]})]})})]}),s.jsxs(bt,{children:[s.jsx(H,{variant:"outline",onClick:N,children:"Cancel"}),s.jsx(H,{onClick:S,disabled:!E,children:E?"Move Card":"No Change"})]})]})})}const Rr=c.createContext(void 0);function Ji({children:a}){const[e,t]=c.useState(!1),[r,n]=c.useState(null),[o,i]=c.useState(null),[l,m]=c.useState(null),u=h=>{n(h.targetCardId),i(h.currentFolderId||null),m(()=>h.onFolderApply),t(!0)},d=()=>{t(!1),n(null),i(null),m(null)},y={isOpen:e,currentCardId:r,currentFolderId:o,onFolderSelect:l,openFolderPanel:u,closeFolderPanel:d};return s.jsxs(Rr.Provider,{value:y,children:[a,typeof window<"u"&&e&&r&&Jt.createPortal(s.jsx(qi,{isOpen:e,onClose:d,currentCardId:r,currentFolderId:o,onFolderSelect:l}),document.body)]})}function Xi(){const a=c.useContext(Rr);if(a===void 0)throw new Error("useFolderPanel must be used within a FolderPanelProvider");return a}function Qi({card:a,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onMoveToFolder:l,className:m,size:u="md"}){const{openStylePanel:d}=Wi(),{openTagPanel:y}=kr(),{openFolderPanel:h}=Xi(),g=()=>{d({targetCardId:a.id,currentStyle:a.style,onStyleApply:E=>{t(a.id,{style:E,updatedAt:new Date})},onPanelClose:()=>{}})},S=()=>{const E=a.isFlipped?a.backContent:a.frontContent,v=a.isFlipped?"backContent":"frontContent";y({targetCardId:a.id,currentTags:E.tags,onTagsApply:f=>{t(a.id,{[v]:{...E,tags:f,lastModified:new Date},updatedAt:new Date})},onPanelClose:()=>{}})},N=()=>{l&&h({targetCardId:a.id,currentFolderId:a.folderId,onFolderApply:E=>l(a.id,E),onPanelClose:()=>{}})};return s.jsx(hi,{card:a,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onStyleChange:g,onTagsChange:S,onMoveToFolder:l?N:void 0,className:m,size:u})}function Zi({items:a,gap:e=16,minColumnWidth:t=280,maxColumns:r=5,breakpoints:n={sm:640,md:768,lg:1024,xl:1280,"2xl":1536}}){const o=c.useRef(null),[i,l]=c.useState(new Map),[m,u]=c.useState(0),[d,y]=c.useState({columns:1,gap:e,containerWidth:0}),h=c.useCallback(v=>{if(v===0)return 1;let f=r;v<n.sm?f=1:v<n.md?f=2:v<n.lg?f=3:v<n.xl&&(f=4);const p=v-e,x=Math.floor(p/(t+e));return Math.min(Math.max(1,x),f)},[e,t,r,n]),g=c.useCallback((v,f,p,x)=>{if(f===0||p===0)return{positions:new Map,totalHeight:0};const b=x*(f-1),C=p-b,w=Math.floor(C/f),j=new Array(f).fill(0),D=new Map;v.forEach($=>{const K=j.indexOf(Math.min(...j)),se=K*(w+x),V=j[K];D.set($.id,{x:se,y:V,width:w,height:$.height}),j[K]+=$.height+x});const P=Math.max(...j)-x;return{positions:D,totalHeight:P}},[]),S=c.useCallback(v=>{const f=v[0];if(!f)return;const p=f.contentRect.width,x=h(p);y(b=>({...b,columns:x,containerWidth:p}))},[h]);c.useEffect(()=>{const v=o.current;if(!v)return;const f=new ResizeObserver(p=>{S(p)});return f.observe(v),()=>{f.disconnect()}},[S]),c.useEffect(()=>{if(a.length===0||d.containerWidth===0){l(new Map),u(0);return}const{positions:v,totalHeight:f}=g(a,d.columns,d.containerWidth,e);l(v),u(f)},[a,d,e,g]);const N=c.useCallback(v=>i.get(v),[i]),E=c.useCallback((v,f)=>{const p=a.findIndex(w=>w.id===v);if(p===-1)return;const x=[...a];x[p]={...x[p],height:f};const{positions:b,totalHeight:C}=g(x,d.columns,d.containerWidth,e);l(b),u(C)},[a,d,e,g]);return{containerRef:o,positions:i,containerHeight:m,config:d,getItemPosition:N,updateItemHeight:E}}function el({cards:a,onCardFlip:e,onCardUpdate:t,onCardCopy:r,onCardScreenshot:n,onCardShare:o,onCardDelete:i,onMoveToFolder:l,onCardStyleChange:m,cardSize:u="md",className:d,gap:y=16,enableVirtualization:h=!0,overscan:g=5}){const[S,N]=c.useState(new Map),[E,v]=c.useState(!1),[f,p]=c.useState(0),[x,b]=c.useState(0),C=c.useRef(new Map),w=c.useRef(null),j=c.useMemo(()=>[...a].sort((z,Y)=>new Date(Y.createdAt).getTime()-new Date(z.createdAt).getTime()),[a]),D=c.useCallback(z=>{const _={sm:.8,md:1,lg:1.3}[u],A=200*_,T=Math.min(Math.ceil(z.frontContent.title.length/25),3)*24*_,W=Math.min(Math.ceil(z.frontContent.text.length/40),8)*18*_,J=z.frontContent.images.length>0?120*_:0,B=z.frontContent.tags.length>0?32*_:0,q=32*_;return Math.round(A+T+W+J+B+q)},[u]),P=c.useMemo(()=>j.map(z=>({id:z.id,height:S.get(z.id)||D(z)})),[j,S,D]),$=c.useMemo(()=>({sm:{minColumnWidth:240,maxColumns:5},md:{minColumnWidth:280,maxColumns:4},lg:{minColumnWidth:320,maxColumns:3}})[u],[u]),{containerRef:K,positions:se,containerHeight:V,updateItemHeight:re}=Zi({items:P,gap:y,...$,breakpoints:{sm:640,md:768,lg:1024,xl:1280,"2xl":1536}}),te=c.useMemo(()=>{if(!h||!w.current)return j;const z=w.current.clientHeight,Y=f-g*100,_=f+z+g*100;return j.filter(A=>{const T=se.get(A.id);return T?T.y+T.height>=Y&&T.y<=_:!0})},[j,se,f,h,g]);c.useCallback(z=>{h&&p(z.currentTarget.scrollTop)},[h]);const ne=c.useCallback(z=>{const Y=C.current.get(z);if(!Y)return;const _=new ResizeObserver(A=>{const T=A[0];if(T){const W=T.contentRect.height,J=S.get(z);Math.abs(W-(J||0))>3&&(N(B=>{const q=new Map(B);return q.set(z,W),q}),re(z,W))}});return _.observe(Y),()=>_.disconnect()},[S,re]);c.useEffect(()=>{if(!E&&j.length>0){const z=new Map;j.forEach(Y=>{z.set(Y.id,D(Y))}),N(z),v(!0)}},[j,D,E]),c.useEffect(()=>{const z=[];return te.forEach(Y=>{const _=ne(Y.id);_&&z.push(_)}),()=>{z.forEach(Y=>Y())}},[te,ne]);const ge=c.useCallback((z,Y)=>{Y?C.current.set(z,Y):C.current.delete(z)},[]);return c.useEffect(()=>{w.current&&b(w.current.clientHeight)},[]),j.length===0?s.jsx("div",{className:"flex-1 flex items-center justify-center p-12",children:s.jsxs("div",{className:"text-center space-y-4",children:[s.jsx("div",{className:"w-24 h-24 mx-auto rounded-full bg-muted flex items-center justify-center",children:s.jsx("div",{className:"w-12 h-12 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center",children:s.jsx("span",{className:"text-white font-bold text-lg",children:"+"})})}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h3",{className:"text-lg font-semibold",children:"No cards yet"}),s.jsx("p",{className:"text-muted-foreground max-w-sm",children:"Create your first knowledge card to get started. Click the + button to begin."})]})]})}):s.jsx("div",{ref:K,className:I("relative w-full",d),style:{height:V},children:te.map(z=>{const Y=se.get(z.id);return Y?s.jsx("div",{ref:_=>ge(z.id,_),className:"absolute transition-all duration-300 ease-out",style:{transform:`translate3d(${Y.x}px, ${Y.y}px, 0)`,width:Y.width,willChange:"transform"},children:s.jsx(Qi,{card:z,onFlip:e,onUpdate:t,onCopy:r,onScreenshot:n,onShare:o,onDelete:i,onMoveToFolder:l,size:u,className:"w-full"})},z.id):null})})}const Tr=c.forwardRef(({className:a,...e},t)=>s.jsxs(Ta,{ref:t,className:I("relative flex w-full touch-none select-none items-center",a),...e,children:[s.jsx(Dn,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:s.jsx(Rn,{className:"absolute h-full bg-primary"})}),s.jsx(Tn,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));Tr.displayName=Ta.displayName;const tl=Xt("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),Qe=c.forwardRef(({className:a,...e},t)=>s.jsx(Aa,{ref:t,className:I(tl(),a),...e}));Qe.displayName=Aa.displayName;const ct=c.forwardRef(({className:a,orientation:e="horizontal",decorative:t=!0,...r},n)=>s.jsx(Ia,{ref:n,decorative:t,orientation:e,className:I("shrink-0 bg-border",e==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",a),...r}));ct.displayName=Ia.displayName;const sl=In,al=_n,Ar=c.forwardRef(({className:a,align:e="center",sideOffset:t=4,...r},n)=>s.jsx(An,{children:s.jsx(_a,{ref:n,align:e,sideOffset:t,className:I("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...r})}));Ar.displayName=_a.displayName;function ea(a){if(!a)return"";try{const e=new DOMParser().parseFromString(a,"text/html");e.querySelectorAll("img").forEach(i=>i.remove()),e.querySelectorAll("br").forEach(i=>{i.replaceWith(`
`)}),e.querySelectorAll("p, div, h1, h2, h3, h4, h5, h6, li, blockquote").forEach(i=>{i.insertAdjacentText("afterend",`
`)});let o=e.body.textContent||e.body.innerText||"";return o=o.replace(/[ \t]+/g," ").replace(/[ \t]*\n[ \t]*/g,`
`).replace(/\n{3,}/g,`

`).trim(),o}catch(e){return console.warn("Failed to parse HTML, falling back to regex cleanup:",e),a.replace(/<img[^>]*>/gi,"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/?(p|div|h[1-6]|li|blockquote)[^>]*>/gi,`
`).replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/[ \t]+/g," ").replace(/[ \t]*\n[ \t]*/g,`
`).replace(/\n{3,}/g,`

`).trim()}}function rl(a,e){const t=ea(a),r=ea(e);return`${t}

${r}`}async function nl(a){try{if(navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(a),!0;{const e=document.createElement("textarea");e.value=a,e.style.position="fixed",e.style.left="-999999px",e.style.top="-999999px",document.body.appendChild(e),e.focus(),e.select();const t=document.execCommand("copy");return document.body.removeChild(e),t}}catch(e){return console.error("Failed to copy text to clipboard:",e),!1}}function ol(a,e){return a[13]=1,a[14]=e>>8,a[15]=e&255,a[16]=e>>8,a[17]=e&255,a}const Ir=112,_r=72,Mr=89,Fr=115;let xs;function il(){const a=new Int32Array(256);for(let e=0;e<256;e++){let t=e;for(let r=0;r<8;r++)t=t&1?3988292384^t>>>1:t>>>1;a[e]=t}return a}function ll(a){let e=-1;xs||(xs=il());for(let t=0;t<a.length;t++)e=xs[(e^a[t])&255]^e>>>8;return e^-1}function cl(a){const e=a.length-1;for(let t=e;t>=4;t--)if(a[t-4]===9&&a[t-3]===Ir&&a[t-2]===_r&&a[t-1]===Mr&&a[t]===Fr)return t-3;return 0}function dl(a,e,t=!1){const r=new Uint8Array(13);e*=39.3701,r[0]=Ir,r[1]=_r,r[2]=Mr,r[3]=Fr,r[4]=e>>>24,r[5]=e>>>16,r[6]=e>>>8,r[7]=e&255,r[8]=r[4],r[9]=r[5],r[10]=r[6],r[11]=r[7],r[12]=1;const n=ll(r),o=new Uint8Array(4);if(o[0]=n>>>24,o[1]=n>>>16,o[2]=n>>>8,o[3]=n&255,t){const i=cl(a);return a.set(r,i),a.set(o,i+13),a}else{const i=new Uint8Array(4);i[0]=0,i[1]=0,i[2]=0,i[3]=9;const l=new Uint8Array(54);return l.set(a,0),l.set(i,33),l.set(r,37),l.set(o,50),l}}const ul="AAlwSFlz",ml="AAAJcEhZ",gl="AAAACXBI";function fl(a){let e=a.indexOf(ul);return e===-1&&(e=a.indexOf(ml)),e===-1&&(e=a.indexOf(gl)),e}const Or="[modern-screenshot]",Ye=typeof window<"u",hl=Ye&&"Worker"in window,pl=Ye&&"atob"in window,yl=Ye&&"btoa"in window,zs=Ye?window.navigator?.userAgent:"",Pr=zs.includes("Chrome"),qt=zs.includes("AppleWebKit")&&!Pr,Bs=zs.includes("Firefox"),xl=a=>a&&"__CONTEXT__"in a,wl=a=>a.constructor.name==="CSSFontFaceRule",bl=a=>a.constructor.name==="CSSImportRule",Fe=a=>a.nodeType===1,Ot=a=>typeof a.className=="object",Lr=a=>a.tagName==="image",vl=a=>a.tagName==="use",It=a=>Fe(a)&&typeof a.style<"u"&&!Ot(a),Cl=a=>a.nodeType===8,jl=a=>a.nodeType===3,yt=a=>a.tagName==="IMG",es=a=>a.tagName==="VIDEO",Sl=a=>a.tagName==="CANVAS",Nl=a=>a.tagName==="TEXTAREA",kl=a=>a.tagName==="INPUT",El=a=>a.tagName==="STYLE",Dl=a=>a.tagName==="SCRIPT",Rl=a=>a.tagName==="SELECT",Tl=a=>a.tagName==="SLOT",Al=a=>a.tagName==="IFRAME",Il=(...a)=>console.warn(Or,...a);function _l(a){const e=a?.createElement?.("canvas");return e&&(e.height=e.width=1),!!e&&"toDataURL"in e&&!!e.toDataURL("image/webp").includes("image/webp")}const Rs=a=>a.startsWith("data:");function $r(a,e){if(a.match(/^[a-z]+:\/\//i))return a;if(Ye&&a.match(/^\/\//))return window.location.protocol+a;if(a.match(/^[a-z]+:/i)||!Ye)return a;const t=ts().implementation.createHTMLDocument(),r=t.createElement("base"),n=t.createElement("a");return t.head.appendChild(r),t.body.appendChild(n),e&&(r.href=e),n.href=a,n.href}function ts(a){return(a&&Fe(a)?a?.ownerDocument:a)??window.document}const ss="http://www.w3.org/2000/svg";function Ml(a,e,t){const r=ts(t).createElementNS(ss,"svg");return r.setAttributeNS(null,"width",a.toString()),r.setAttributeNS(null,"height",e.toString()),r.setAttributeNS(null,"viewBox",`0 0 ${a} ${e}`),r}function Fl(a,e){let t=new XMLSerializer().serializeToString(a);return e&&(t=t.replace(/[\u0000-\u0008\v\f\u000E-\u001F\uD800-\uDFFF\uFFFE\uFFFF]/gu,"")),`data:image/svg+xml;charset=utf-8,${encodeURIComponent(t)}`}function Ol(a,e){return new Promise((t,r)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=()=>r(n.error),n.onabort=()=>r(new Error(`Failed read blob to ${e}`)),n.readAsDataURL(a)})}const Pl=a=>Ol(a,"dataUrl");function ft(a,e){const t=ts(e).createElement("img");return t.decoding="sync",t.loading="eager",t.src=a,t}function _t(a,e){return new Promise(t=>{const{timeout:r,ownerDocument:n,onError:o,onWarn:i}=e??{},l=typeof a=="string"?ft(a,ts(n)):a;let m=null,u=null;function d(){t(l),m&&clearTimeout(m),u?.()}if(r&&(m=setTimeout(d,r)),es(l)){const y=l.currentSrc||l.src;if(!y)return l.poster?_t(l.poster,e).then(t):d();if(l.readyState>=2)return d();const h=d,g=S=>{i?.("Failed video load",y,S),o?.(S),d()};u=()=>{l.removeEventListener("loadeddata",h),l.removeEventListener("error",g)},l.addEventListener("loadeddata",h,{once:!0}),l.addEventListener("error",g,{once:!0})}else{const y=Lr(l)?l.href.baseVal:l.currentSrc||l.src;if(!y)return d();const h=async()=>{if(yt(l)&&"decode"in l)try{await l.decode()}catch(S){i?.("Failed to decode image, trying to render anyway",l.dataset.originalSrc||y,S)}d()},g=S=>{i?.("Failed image load",l.dataset.originalSrc||y,S),d()};if(yt(l)&&l.complete)return h();u=()=>{l.removeEventListener("load",h),l.removeEventListener("error",g)},l.addEventListener("load",h,{once:!0}),l.addEventListener("error",g,{once:!0})}})}async function Ll(a,e){It(a)&&(yt(a)||es(a)?await _t(a,e):await Promise.all(["img","video"].flatMap(t=>Array.from(a.querySelectorAll(t)).map(r=>_t(r,e)))))}const zr=function(){let e=0;const t=()=>`0000${(Math.random()*36**4<<0).toString(36)}`.slice(-4);return()=>(e+=1,`u${t()}${e}`)}();function Br(a){return a?.split(",").map(e=>e.trim().replace(/"|'/g,"").toLowerCase()).filter(Boolean)}let ta=0;function $l(a){const e=`${Or}[#${ta}]`;return ta++,{time:t=>a&&console.time(`${e} ${t}`),timeEnd:t=>a&&console.timeEnd(`${e} ${t}`),warn:(...t)=>a&&Il(...t)}}function zl(a){return{cache:a?"no-cache":"force-cache"}}async function as(a,e){return xl(a)?a:Bl(a,{...e,autoDestruct:!0})}async function Bl(a,e){const{scale:t=1,workerUrl:r,workerNumber:n=1}=e||{},o=!!e?.debug,i=e?.features??!0,l=a.ownerDocument??(Ye?window.document:void 0),m=a.ownerDocument?.defaultView??(Ye?window:void 0),u=new Map,d={width:0,height:0,quality:1,type:"image/png",scale:t,backgroundColor:null,style:null,filter:null,maximumCanvasSize:0,timeout:3e4,progress:null,debug:o,fetch:{requestInit:zl(e?.fetch?.bypassingCache),placeholderImage:"data:image/png;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",bypassingCache:!1,...e?.fetch},fetchFn:null,font:{},drawImageInterval:100,workerUrl:null,workerNumber:n,onCloneEachNode:null,onCloneNode:null,onEmbedNode:null,onCreateForeignObjectSvg:null,includeStyleProperties:null,autoDestruct:!1,...e,__CONTEXT__:!0,log:$l(o),node:a,ownerDocument:l,ownerWindow:m,dpi:t===1?null:96*t,svgStyleElement:Ur(l),svgDefsElement:l?.createElementNS(ss,"defs"),svgStyles:new Map,defaultComputedStyles:new Map,workers:[...Array.from({length:hl&&r&&n?n:0})].map(()=>{try{const g=new Worker(r);return g.onmessage=async S=>{const{url:N,result:E}=S.data;E?u.get(N)?.resolve?.(E):u.get(N)?.reject?.(new Error(`Error receiving message from worker: ${N}`))},g.onmessageerror=S=>{const{url:N}=S.data;u.get(N)?.reject?.(new Error(`Error receiving message from worker: ${N}`))},g}catch(g){return d.log.warn("Failed to new Worker",g),null}}).filter(Boolean),fontFamilies:new Map,fontCssTexts:new Map,acceptOfImage:`${[_l(l)&&"image/webp","image/svg+xml","image/*","*/*"].filter(Boolean).join(",")};q=0.8`,requests:u,drawImageCount:0,tasks:[],features:i,isEnable:g=>g==="restoreScrollPosition"?typeof i=="boolean"?!1:i[g]??!1:typeof i=="boolean"?i:i[g]??!0,shadowRoots:[]};d.log.time("wait until load"),await Ll(a,{timeout:d.timeout,onWarn:d.log.warn}),d.log.timeEnd("wait until load");const{width:y,height:h}=Ul(a,d);return d.width=y,d.height=h,d}function Ur(a){if(!a)return;const e=a.createElement("style"),t=e.ownerDocument.createTextNode(`
.______background-clip--text {
  background-clip: text;
  -webkit-background-clip: text;
}
`);return e.appendChild(t),e}function Ul(a,e){let{width:t,height:r}=e;if(Fe(a)&&(!t||!r)){const n=a.getBoundingClientRect();t=t||n.width||Number(a.getAttribute("width"))||0,r=r||n.height||Number(a.getAttribute("height"))||0}return{width:t,height:r}}async function Vl(a,e){const{log:t,timeout:r,drawImageCount:n,drawImageInterval:o}=e;t.time("image to canvas");const i=await _t(a,{timeout:r,onWarn:e.log.warn}),{canvas:l,context2d:m}=Wl(a.ownerDocument,e),u=()=>{try{m?.drawImage(i,0,0,l.width,l.height)}catch(d){e.log.warn("Failed to drawImage",d)}};if(u(),e.isEnable("fixSvgXmlDecode"))for(let d=0;d<n;d++)await new Promise(y=>{setTimeout(()=>{m?.clearRect(0,0,l.width,l.height),u(),y()},d+o)});return e.drawImageCount=0,t.timeEnd("image to canvas"),l}function Wl(a,e){const{width:t,height:r,scale:n,backgroundColor:o,maximumCanvasSize:i}=e,l=a.createElement("canvas");l.width=Math.floor(t*n),l.height=Math.floor(r*n),l.style.width=`${t}px`,l.style.height=`${r}px`,i&&(l.width>i||l.height>i)&&(l.width>i&&l.height>i?l.width>l.height?(l.height*=i/l.width,l.width=i):(l.width*=i/l.height,l.height=i):l.width>i?(l.height*=i/l.width,l.width=i):(l.width*=i/l.height,l.height=i));const m=l.getContext("2d");return m&&o&&(m.fillStyle=o,m.fillRect(0,0,l.width,l.height)),{canvas:l,context2d:m}}function Vr(a,e){if(a.ownerDocument)try{const o=a.toDataURL();if(o!=="data:,")return ft(o,a.ownerDocument)}catch(o){e.log.warn("Failed to clone canvas",o)}const t=a.cloneNode(!1),r=a.getContext("2d"),n=t.getContext("2d");try{return r&&n&&n.putImageData(r.getImageData(0,0,a.width,a.height),0,0),t}catch(o){e.log.warn("Failed to clone canvas",o)}return t}function Hl(a,e){try{if(a?.contentDocument?.body)return Us(a.contentDocument.body,e)}catch(t){e.log.warn("Failed to clone iframe",t)}return a.cloneNode(!1)}function Gl(a){const e=a.cloneNode(!1);return a.currentSrc&&a.currentSrc!==a.src&&(e.src=a.currentSrc,e.srcset=""),e.loading==="lazy"&&(e.loading="eager"),e}async function Kl(a,e){if(a.ownerDocument&&!a.currentSrc&&a.poster)return ft(a.poster,a.ownerDocument);const t=a.cloneNode(!1);t.crossOrigin="anonymous",a.currentSrc&&a.currentSrc!==a.src&&(t.src=a.currentSrc);const r=t.ownerDocument;if(r){let n=!0;if(await _t(t,{onError:()=>n=!1,onWarn:e.log.warn}),!n)return a.poster?ft(a.poster,a.ownerDocument):t;t.currentTime=a.currentTime,await new Promise(i=>{t.addEventListener("seeked",i,{once:!0})});const o=r.createElement("canvas");o.width=a.offsetWidth,o.height=a.offsetHeight;try{const i=o.getContext("2d");i&&i.drawImage(t,0,0,o.width,o.height)}catch(i){return e.log.warn("Failed to clone video",i),a.poster?ft(a.poster,a.ownerDocument):t}return Vr(o,e)}return t}function Yl(a,e){return Sl(a)?Vr(a,e):Al(a)?Hl(a,e):yt(a)?Gl(a):es(a)?Kl(a,e):a.cloneNode(!1)}function ql(a){let e=a.sandbox;if(!e){const{ownerDocument:t}=a;try{t&&(e=t.createElement("iframe"),e.id=`__SANDBOX__${zr()}`,e.width="0",e.height="0",e.style.visibility="hidden",e.style.position="fixed",t.body.appendChild(e),e.srcdoc='<!DOCTYPE html><meta charset="UTF-8"><title></title><body>',a.sandbox=e)}catch(r){a.log.warn("Failed to getSandBox",r)}}return e}const Jl=["width","height","-webkit-text-fill-color"],Xl=["stroke","fill"];function Wr(a,e,t){const{defaultComputedStyles:r}=t,n=a.nodeName.toLowerCase(),o=Ot(a)&&n!=="svg",i=o?Xl.map(N=>[N,a.getAttribute(N)]).filter(([,N])=>N!==null):[],l=[o&&"svg",n,i.map((N,E)=>`${N}=${E}`).join(","),e].filter(Boolean).join(":");if(r.has(l))return r.get(l);const u=ql(t)?.contentWindow;if(!u)return new Map;const d=u?.document;let y,h;o?(y=d.createElementNS(ss,"svg"),h=y.ownerDocument.createElementNS(y.namespaceURI,n),i.forEach(([N,E])=>{h.setAttributeNS(null,N,E)}),y.appendChild(h)):y=h=d.createElement(n),h.textContent=" ",d.body.appendChild(y);const g=u.getComputedStyle(h,e),S=new Map;for(let N=g.length,E=0;E<N;E++){const v=g.item(E);Jl.includes(v)||S.set(v,g.getPropertyValue(v))}return d.body.removeChild(y),r.set(l,S),S}function Hr(a,e,t){const r=new Map,n=[],o=new Map;if(t)for(const l of t)i(l);else for(let l=a.length,m=0;m<l;m++){const u=a.item(m);i(u)}for(let l=n.length,m=0;m<l;m++)o.get(n[m])?.forEach((u,d)=>r.set(d,u));function i(l){const m=a.getPropertyValue(l),u=a.getPropertyPriority(l),d=l.lastIndexOf("-"),y=d>-1?l.substring(0,d):void 0;if(y){let h=o.get(y);h||(h=new Map,o.set(y,h)),h.set(l,[m,u])}e.get(l)===m&&!u||(y?n.push(y):r.set(l,[m,u]))}return r}function Ql(a,e,t,r){const{ownerWindow:n,includeStyleProperties:o,currentParentNodeStyle:i}=r,l=e.style,m=n.getComputedStyle(a),u=Wr(a,null,r);i?.forEach((y,h)=>{u.delete(h)});const d=Hr(m,u,o);d.delete("transition-property"),d.delete("all"),d.delete("d"),d.delete("content"),t&&(d.delete("margin-top"),d.delete("margin-right"),d.delete("margin-bottom"),d.delete("margin-left"),d.delete("margin-block-start"),d.delete("margin-block-end"),d.delete("margin-inline-start"),d.delete("margin-inline-end"),d.set("box-sizing",["border-box",""])),d.get("background-clip")?.[0]==="text"&&e.classList.add("______background-clip--text"),Pr&&(d.has("font-kerning")||d.set("font-kerning",["normal",""]),(d.get("overflow-x")?.[0]==="hidden"||d.get("overflow-y")?.[0]==="hidden")&&d.get("text-overflow")?.[0]==="ellipsis"&&a.scrollWidth===a.clientWidth&&d.set("text-overflow",["clip",""]));for(let y=l.length,h=0;h<y;h++)l.removeProperty(l.item(h));return d.forEach(([y,h],g)=>{l.setProperty(g,y,h)}),d}function Zl(a,e){(Nl(a)||kl(a)||Rl(a))&&e.setAttribute("value",a.value)}const ec=[":before",":after"],tc=[":-webkit-scrollbar",":-webkit-scrollbar-button",":-webkit-scrollbar-thumb",":-webkit-scrollbar-track",":-webkit-scrollbar-track-piece",":-webkit-scrollbar-corner",":-webkit-resizer"];function sc(a,e,t,r,n){const{ownerWindow:o,svgStyleElement:i,svgStyles:l,currentNodeStyle:m}=r;if(!i||!o)return;function u(d){const y=o.getComputedStyle(a,d);let h=y.getPropertyValue("content");if(!h||h==="none")return;n?.(h),h=h.replace(/(')|(")|(counter\(.+\))/g,"");const g=[zr()],S=Wr(a,d,r);m?.forEach((p,x)=>{S.delete(x)});const N=Hr(y,S,r.includeStyleProperties);N.delete("content"),N.delete("-webkit-locale"),N.get("background-clip")?.[0]==="text"&&e.classList.add("______background-clip--text");const E=[`content: '${h}';`];if(N.forEach(([p,x],b)=>{E.push(`${b}: ${p}${x?" !important":""};`)}),E.length===1)return;try{e.className=[e.className,...g].join(" ")}catch(p){r.log.warn("Failed to copyPseudoClass",p);return}const v=E.join(`
  `);let f=l.get(v);f||(f=[],l.set(v,f)),f.push(`.${g[0]}:${d}`)}ec.forEach(u),t&&tc.forEach(u)}const sa=new Set(["symbol"]);async function aa(a,e,t,r,n){if(Fe(t)&&(El(t)||Dl(t))||r.filter&&!r.filter(t))return;sa.has(e.nodeName)||sa.has(t.nodeName)?r.currentParentNodeStyle=void 0:r.currentParentNodeStyle=r.currentNodeStyle;const o=await Us(t,r,!1,n);r.isEnable("restoreScrollPosition")&&ac(a,o),e.appendChild(o)}async function ra(a,e,t,r){let n=a.firstChild;Fe(a)&&a.shadowRoot&&(n=a.shadowRoot?.firstChild,t.shadowRoots.push(a.shadowRoot));for(let o=n;o;o=o.nextSibling)if(!Cl(o))if(Fe(o)&&Tl(o)&&typeof o.assignedNodes=="function"){const i=o.assignedNodes();for(let l=0;l<i.length;l++)await aa(a,e,i[l],t,r)}else await aa(a,e,o,t,r)}function ac(a,e){if(!It(a)||!It(e))return;const{scrollTop:t,scrollLeft:r}=a;if(!t&&!r)return;const{transform:n}=e.style,o=new DOMMatrix(n),{a:i,b:l,c:m,d:u}=o;o.a=1,o.b=0,o.c=0,o.d=1,o.translateSelf(-r,-t),o.a=i,o.b=l,o.c=m,o.d=u,e.style.transform=o.toString()}function rc(a,e){const{backgroundColor:t,width:r,height:n,style:o}=e,i=a.style;if(t&&i.setProperty("background-color",t,"important"),r&&i.setProperty("width",`${r}px`,"important"),n&&i.setProperty("height",`${n}px`,"important"),o)for(const l in o)i[l]=o[l]}const nc=/^[\w-:]+$/;async function Us(a,e,t=!1,r){const{ownerDocument:n,ownerWindow:o,fontFamilies:i,onCloneEachNode:l}=e;if(n&&jl(a))return r&&/\S/.test(a.data)&&r(a.data),n.createTextNode(a.data);if(n&&o&&Fe(a)&&(It(a)||Ot(a))){const u=await Yl(a,e);if(e.isEnable("removeAbnormalAttributes")){const N=u.getAttributeNames();for(let E=N.length,v=0;v<E;v++){const f=N[v];nc.test(f)||u.removeAttribute(f)}}const d=e.currentNodeStyle=Ql(a,u,t,e);t&&rc(u,e);let y=!1;if(e.isEnable("copyScrollbar")){const N=[d.get("overflow-x")?.[0],d.get("overflow-y")?.[0]];y=N.includes("scroll")||(N.includes("auto")||N.includes("overlay"))&&(a.scrollHeight>a.clientHeight||a.scrollWidth>a.clientWidth)}const h=d.get("text-transform")?.[0],g=Br(d.get("font-family")?.[0]),S=g?N=>{h==="uppercase"?N=N.toUpperCase():h==="lowercase"?N=N.toLowerCase():h==="capitalize"&&(N=N[0].toUpperCase()+N.substring(1)),g.forEach(E=>{let v=i.get(E);v||i.set(E,v=new Set),N.split("").forEach(f=>v.add(f))})}:void 0;return sc(a,u,y,e,S),Zl(a,u),es(a)||await ra(a,u,e,S),await l?.(u),u}const m=a.cloneNode(!1);return await ra(a,m,e),await l?.(m),m}function oc(a){if(a.ownerDocument=void 0,a.ownerWindow=void 0,a.svgStyleElement=void 0,a.svgDefsElement=void 0,a.svgStyles.clear(),a.defaultComputedStyles.clear(),a.sandbox){try{a.sandbox.remove()}catch(e){a.log.warn("Failed to destroyContext",e)}a.sandbox=void 0}a.workers=[],a.fontFamilies.clear(),a.fontCssTexts.clear(),a.requests.clear(),a.tasks=[],a.shadowRoots=[]}function ic(a){const{url:e,timeout:t,responseType:r,...n}=a,o=new AbortController,i=t?setTimeout(()=>o.abort(),t):void 0;return fetch(e,{signal:o.signal,...n}).then(l=>{if(!l.ok)throw new Error("Failed fetch, not 2xx response",{cause:l});switch(r){case"arrayBuffer":return l.arrayBuffer();case"dataUrl":return l.blob().then(Pl);case"text":default:return l.text()}}).finally(()=>clearTimeout(i))}function Mt(a,e){const{url:t,requestType:r="text",responseType:n="text",imageDom:o}=e;let i=t;const{timeout:l,acceptOfImage:m,requests:u,fetchFn:d,fetch:{requestInit:y,bypassingCache:h,placeholderImage:g},font:S,workers:N,fontFamilies:E}=a;r==="image"&&(qt||Bs)&&a.drawImageCount++;let v=u.get(t);if(!v){h&&h instanceof RegExp&&h.test(i)&&(i+=(/\?/.test(i)?"&":"?")+new Date().getTime());const f=r.startsWith("font")&&S&&S.minify,p=new Set;f&&r.split(";")[1].split(",").forEach(w=>{E.has(w)&&E.get(w).forEach(j=>p.add(j))});const x=f&&p.size,b={url:i,timeout:l,responseType:x?"arrayBuffer":n,headers:r==="image"?{accept:m}:void 0,...y};v={type:r,resolve:void 0,reject:void 0,response:null},v.response=(async()=>{if(d&&r==="image"){const C=await d(t);if(C)return C}return!qt&&t.startsWith("http")&&N.length?new Promise((C,w)=>{N[u.size&N.length-1].postMessage({rawUrl:t,...b}),v.resolve=C,v.reject=w}):ic(b)})().catch(C=>{if(u.delete(t),r==="image"&&g)return a.log.warn("Failed to fetch image base64, trying to use placeholder image",i),typeof g=="string"?g:g(o);throw C}),u.set(t,v)}return v.response}async function Gr(a,e,t,r){if(!Kr(a))return a;for(const[n,o]of lc(a,e))try{const i=await Mt(t,{url:o,requestType:r?"image":"text",responseType:"dataUrl"});a=a.replace(cc(n),`$1${i}$3`)}catch(i){t.log.warn("Failed to fetch css data url",n,i)}return a}function Kr(a){return/url\((['"]?)([^'"]+?)\1\)/.test(a)}const Yr=/url\((['"]?)([^'"]+?)\1\)/g;function lc(a,e){const t=[];return a.replace(Yr,(r,n,o)=>(t.push([o,$r(o,e)]),r)),t.filter(([r])=>!Rs(r))}function cc(a){const e=a.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1");return new RegExp(`(url\\(['"]?)(${e})(['"]?\\))`,"g")}const dc=["background-image","border-image-source","-webkit-border-image","-webkit-mask-image","list-style-image"];function uc(a,e){return dc.map(t=>{const r=a.getPropertyValue(t);return!r||r==="none"?null:((qt||Bs)&&e.drawImageCount++,Gr(r,null,e,!0).then(n=>{!n||r===n||a.setProperty(t,n,a.getPropertyPriority(t))}))}).filter(Boolean)}function mc(a,e){if(yt(a)){const t=a.currentSrc||a.src;if(!Rs(t))return[Mt(e,{url:t,imageDom:a,requestType:"image",responseType:"dataUrl"}).then(r=>{r&&(a.srcset="",a.dataset.originalSrc=t,a.src=r||"")})];(qt||Bs)&&e.drawImageCount++}else if(Ot(a)&&!Rs(a.href.baseVal)){const t=a.href.baseVal;return[Mt(e,{url:t,imageDom:a,requestType:"image",responseType:"dataUrl"}).then(r=>{r&&(a.dataset.originalSrc=t,a.href.baseVal=r||"")})]}return[]}function gc(a,e){const{ownerDocument:t,svgDefsElement:r}=e,n=a.getAttribute("href")??a.getAttribute("xlink:href");if(!n)return[];const[o,i]=n.split("#");if(i){const l=`#${i}`,m=e.shadowRoots.reduce((u,d)=>u??d.querySelector(`svg ${l}`),t?.querySelector(`svg ${l}`));if(o&&a.setAttribute("href",l),r?.querySelector(l))return[];if(m)return r?.appendChild(m.cloneNode(!0)),[];if(o)return[Mt(e,{url:o,responseType:"text"}).then(u=>{r?.insertAdjacentHTML("beforeend",u)})]}return[]}function qr(a,e){const{tasks:t}=e;Fe(a)&&((yt(a)||Lr(a))&&t.push(...mc(a,e)),vl(a)&&t.push(...gc(a,e))),It(a)&&t.push(...uc(a.style,e)),a.childNodes.forEach(r=>{qr(r,e)})}async function fc(a,e){const{ownerDocument:t,svgStyleElement:r,fontFamilies:n,fontCssTexts:o,tasks:i,font:l}=e;if(!(!t||!r||!n.size))if(l&&l.cssText){const m=oa(l.cssText,e);r.appendChild(t.createTextNode(`${m}
`))}else{const m=Array.from(t.styleSheets).filter(d=>{try{return"cssRules"in d&&!!d.cssRules.length}catch(y){return e.log.warn(`Error while reading CSS rules from ${d.href}`,y),!1}});await Promise.all(m.flatMap(d=>Array.from(d.cssRules).map(async(y,h)=>{if(bl(y)){let g=h+1;const S=y.href;let N="";try{N=await Mt(e,{url:S,requestType:"text",responseType:"text"})}catch(v){e.log.warn(`Error fetch remote css import from ${S}`,v)}const E=N.replace(Yr,(v,f,p)=>v.replace(p,$r(p,S)));for(const v of pc(E))try{d.insertRule(v,v.startsWith("@import")?g+=1:d.cssRules.length)}catch(f){e.log.warn("Error inserting rule from remote css import",{rule:v,error:f})}}}))),m.flatMap(d=>Array.from(d.cssRules)).filter(d=>wl(d)&&Kr(d.style.getPropertyValue("src"))&&Br(d.style.getPropertyValue("font-family"))?.some(y=>n.has(y))).forEach(d=>{const y=d,h=o.get(y.cssText);h?r.appendChild(t.createTextNode(`${h}
`)):i.push(Gr(y.cssText,y.parentStyleSheet?y.parentStyleSheet.href:null,e).then(g=>{g=oa(g,e),o.set(y.cssText,g),r.appendChild(t.createTextNode(`${g}
`))}))})}}const hc=/(\/\*[\s\S]*?\*\/)/g,na=/((@.*?keyframes [\s\S]*?){([\s\S]*?}\s*?)})/gi;function pc(a){if(a==null)return[];const e=[];let t=a.replace(hc,"");for(;;){const o=na.exec(t);if(!o)break;e.push(o[0])}t=t.replace(na,"");const r=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,n=new RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");for(;;){let o=r.exec(t);if(o)n.lastIndex=r.lastIndex;else if(o=n.exec(t),o)r.lastIndex=n.lastIndex;else break;e.push(o[0])}return e}const yc=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,xc=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function oa(a,e){const{font:t}=e,r=t?t?.preferredFormat:void 0;return r?a.replace(xc,n=>{for(;;){const[o,,i]=yc.exec(n)||[];if(!i)return"";if(i===r)return`src: ${o};`}}):a}async function wc(a,e){const t=await as(a,e);if(Fe(t.node)&&Ot(t.node))return t.node;const{ownerDocument:r,log:n,tasks:o,svgStyleElement:i,svgDefsElement:l,svgStyles:m,font:u,progress:d,autoDestruct:y,onCloneNode:h,onEmbedNode:g,onCreateForeignObjectSvg:S}=t;n.time("clone node");const N=await Us(t.node,t,!0);if(i&&r){let x="";m.forEach((b,C)=>{x+=`${b.join(`,
`)} {
  ${C}
}
`}),i.appendChild(r.createTextNode(x))}n.timeEnd("clone node"),await h?.(N),u!==!1&&Fe(N)&&(n.time("embed web font"),await fc(N,t),n.timeEnd("embed web font")),n.time("embed node"),qr(N,t);const E=o.length;let v=0;const f=async()=>{for(;;){const x=o.pop();if(!x)break;try{await x}catch(b){t.log.warn("Failed to run task",b)}d?.(++v,E)}};d?.(v,E),await Promise.all([...Array.from({length:4})].map(f)),n.timeEnd("embed node"),await g?.(N);const p=bc(N,t);return l&&p.insertBefore(l,p.children[0]),i&&p.insertBefore(i,p.children[0]),y&&oc(t),await S?.(p),p}function bc(a,e){const{width:t,height:r}=e,n=Ml(t,r,a.ownerDocument),o=n.ownerDocument.createElementNS(n.namespaceURI,"foreignObject");return o.setAttributeNS(null,"x","0%"),o.setAttributeNS(null,"y","0%"),o.setAttributeNS(null,"width","100%"),o.setAttributeNS(null,"height","100%"),o.append(a),n.appendChild(o),n}async function vc(a,e){const t=await as(a,e),r=await wc(t),n=Fl(r,t.isEnable("removeControlCharacter"));t.autoDestruct||(t.svgStyleElement=Ur(t.ownerDocument),t.svgDefsElement=t.ownerDocument?.createElementNS(ss,"defs"),t.svgStyles.clear());const o=ft(n,r.ownerDocument);return await Vl(o,t)}async function Cc(a,e){const t=await as(a,e),{log:r,quality:n,type:o,dpi:i}=t,l=await vc(t);r.time("canvas to data url");let m=l.toDataURL(o,n);if(["image/png","image/jpeg"].includes(o)&&i&&pl&&yl){const[u,d]=m.split(",");let y=0,h=!1;if(o==="image/png"){const p=fl(d);p>=0?(y=Math.ceil((p+28)/3)*4,h=!0):y=33/3*4}else o==="image/jpeg"&&(y=18/3*4);const g=d.substring(0,y),S=d.substring(y),N=window.atob(g),E=new Uint8Array(N.length);for(let p=0;p<E.length;p++)E[p]=N.charCodeAt(p);const v=o==="image/png"?dl(E,i,h):ol(E,i),f=window.btoa(String.fromCharCode(...v));m=[u,",",f,S].join("")}return r.timeEnd("canvas to data url"),m}async function jc(a,e){return Cc(await as(a,{...e,type:"image/png"}))}function Sc(a,e=30){if(!a||a.trim()==="")return"untitled-card";let t=a.replace(/[^\w\s\u4e00-\u9fff\u3400-\u4dbf\u20000-\u2a6df\u2a700-\u2b73f\u2b740-\u2b81f\u2b820-\u2ceaf\uf900-\ufaff\u3300-\u33ff-]/g,"").replace(/\s+/g," ").trim();return t?(t.length>e&&(t=t.substring(0,e).trim()),t):"untitled-card"}async function Nc(a,e={}){const{quality:t=1,pixelRatio:r=2,backgroundColor:n="transparent",includeStyles:o=!0}=e;try{const i=await jc(a,{quality:t,pixelRatio:r,backgroundColor:n,style:o?void 0:{},filter:m=>{if(m instanceof HTMLElement){const u=m.classList;return!u.contains("tooltip")&&!u.contains("dropdown-menu")&&!u.contains("popover")}return!0}});return await(await fetch(i)).blob()}catch(i){throw console.error("Screenshot capture failed:",i),new Error("Failed to capture screenshot")}}function kc(a,e){const t=URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download=`${e}.png`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t)}async function Ec(a,e,t={}){const r=Sc(e);return{blob:await Nc(a,{quality:1,pixelRatio:2,backgroundColor:"transparent",...t}),fileName:r}}function Dc(a={}){const[e,t]=c.useState(!1),[r,n]=c.useState(!1),[o,i]=c.useState(null),[l,m]=c.useState(!1),[u,d]=c.useState(null),y=c.useCallback(async(N,E)=>{t(!0),d(null);try{const{blob:v,fileName:f}=await Ec(N,E),p=URL.createObjectURL(v);i({blob:v,fileName:f,previewUrl:p}),m(!0)}catch(v){const f=v instanceof Error?v:new Error("Screenshot failed");d(f.message),a.onError?.(f)}finally{t(!1)}},[a]),h=c.useCallback(async()=>{if(o){n(!0);try{await new Promise(N=>setTimeout(N,500)),kc(o.blob,o.fileName),a.onSuccess?.(o.fileName),m(!1),setTimeout(()=>{o.previewUrl&&URL.revokeObjectURL(o.previewUrl),i(null)},100)}catch(N){const E=N instanceof Error?N:new Error("Download failed");d(E.message),a.onError?.(E)}finally{n(!1)}}},[o,a]),g=c.useCallback(()=>{m(!1),setTimeout(()=>{o?.previewUrl&&URL.revokeObjectURL(o.previewUrl),i(null)},100)},[o]),S=c.useCallback(()=>{d(null)},[]);return{isCapturing:e,isDownloading:r,showPreview:l,previewData:o,error:u,captureScreenshot:y,confirmDownload:h,cancelPreview:g,clearError:S}}function Rc({isOpen:a,onClose:e,onConfirm:t,previewUrl:r,fileName:n,isDownloading:o=!1}){const[i,l]=c.useState(!1),m=()=>{l(!0),setTimeout(()=>{t(),l(!1)},800)};return s.jsx(Ft,{open:a,onOpenChange:e,children:s.jsxs(xt,{className:"max-w-2xl max-h-[90vh] overflow-hidden",children:[s.jsx(wt,{children:s.jsxs(vt,{className:"flex items-center gap-2",children:[s.jsx(js,{className:"h-5 w-5"}),"Screenshot Preview"]})}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"flex items-center justify-between",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(ee,{variant:"secondary",className:"font-mono text-xs",children:[n,".png"]}),s.jsx(ee,{variant:"outline",className:"text-xs",children:"High Quality"})]})}),s.jsx("div",{className:"relative bg-checkered rounded-lg overflow-hidden border",children:r?s.jsxs("div",{className:"relative",children:[s.jsx("img",{src:r,alt:"Screenshot preview",className:I("w-full h-auto max-h-[60vh] object-contain transition-all duration-300",i&&"scale-95 opacity-80")}),i&&s.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/20 to-purple-600/20 flex items-center justify-center",children:s.jsx("div",{className:"bg-white/90 backdrop-blur-sm rounded-full p-6 shadow-lg animate-pulse",children:s.jsxs("div",{className:"relative",children:[s.jsx(mt,{className:"h-8 w-8 text-blue-600 animate-bounce"}),s.jsx(Hs,{className:"h-4 w-4 text-purple-500 absolute -top-1 -right-1 animate-spin"})]})})})]}):s.jsx("div",{className:"h-64 flex items-center justify-center text-muted-foreground",children:s.jsxs("div",{className:"text-center space-y-2",children:[s.jsx(js,{className:"h-12 w-12 mx-auto opacity-50"}),s.jsx("p",{children:"Loading preview..."})]})})}),o&&s.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-muted-foreground",children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent"}),"Preparing download..."]})]}),s.jsxs(bt,{className:"gap-2",children:[s.jsxs(H,{variant:"outline",onClick:e,disabled:i||o,children:[s.jsx(tt,{className:"h-4 w-4 mr-2"}),"Cancel"]}),s.jsx(H,{onClick:m,disabled:i||o||!r,className:I("relative overflow-hidden",i&&"bg-gradient-to-r from-blue-500 to-purple-600"),children:i?s.jsxs(s.Fragment,{children:[s.jsx(Hs,{className:"h-4 w-4 mr-2 animate-spin"}),"Downloading..."]}):s.jsxs(s.Fragment,{children:[s.jsx(mt,{className:"h-4 w-4 mr-2"}),"Download PNG"]})})]})]})})}const Tc=`
.bg-checkered {
  background-image: 
    linear-gradient(45deg, #f1f5f9 25%, transparent 25%), 
    linear-gradient(-45deg, #f1f5f9 25%, transparent 25%), 
    linear-gradient(45deg, transparent 75%, #f1f5f9 75%), 
    linear-gradient(-45deg, transparent 75%, #f1f5f9 75%);
  background-size: 20px 20px;
  background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}
`;if(typeof document<"u"){const a=document.createElement("style");a.textContent=Tc,document.head.appendChild(a)}const Ac=1,Ic=1e6;let ws=0;function _c(){return ws=(ws+1)%Number.MAX_SAFE_INTEGER,ws.toString()}const bs=new Map,ia=a=>{if(bs.has(a))return;const e=setTimeout(()=>{bs.delete(a),Dt({type:"REMOVE_TOAST",toastId:a})},Ic);bs.set(a,e)},Mc=(a,e)=>{switch(e.type){case"ADD_TOAST":return{...a,toasts:[e.toast,...a.toasts].slice(0,Ac)};case"UPDATE_TOAST":return{...a,toasts:a.toasts.map(t=>t.id===e.toast.id?{...t,...e.toast}:t)};case"DISMISS_TOAST":{const{toastId:t}=e;return t?ia(t):a.toasts.forEach(r=>{ia(r.id)}),{...a,toasts:a.toasts.map(r=>r.id===t||t===void 0?{...r,open:!1}:r)}}case"REMOVE_TOAST":return e.toastId===void 0?{...a,toasts:[]}:{...a,toasts:a.toasts.filter(t=>t.id!==e.toastId)}}},Gt=[];let Kt={toasts:[]};function Dt(a){Kt=Mc(Kt,a),Gt.forEach(e=>{e(Kt)})}function Fc({...a}){const e=_c(),t=n=>Dt({type:"UPDATE_TOAST",toast:{...n,id:e}}),r=()=>Dt({type:"DISMISS_TOAST",toastId:e});return Dt({type:"ADD_TOAST",toast:{...a,id:e,open:!0,onOpenChange:n=>{n||r()}}}),{id:e,dismiss:r,update:t}}function Oc(){const[a,e]=c.useState(Kt);return c.useEffect(()=>(Gt.push(e),()=>{const t=Gt.indexOf(e);t>-1&&Gt.splice(t,1)}),[a]),{...a,toast:Fc,dismiss:t=>Dt({type:"DISMISS_TOAST",toastId:t})}}const Pc=c.forwardRef(({className:a,...e},t)=>s.jsx(Ma,{ref:t,className:I("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",a),...e}));Pc.displayName=Ma.displayName;const Lc=c.forwardRef(({className:a,...e},t)=>s.jsx(Fa,{ref:t,className:I("aspect-square h-full w-full",a),...e}));Lc.displayName=Fa.displayName;const $c=c.forwardRef(({className:a,...e},t)=>s.jsx(Oa,{ref:t,className:I("flex h-full w-full items-center justify-center rounded-full bg-muted",a),...e}));$c.displayName=Oa.displayName;const Jr=Fn,Xr=On,zc=c.forwardRef(({className:a,inset:e,children:t,...r},n)=>s.jsxs(Pa,{ref:n,className:I("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",e&&"pl-8",a),...r,children:[t,s.jsx(Qt,{className:"ml-auto h-4 w-4"})]}));zc.displayName=Pa.displayName;const Bc=c.forwardRef(({className:a,...e},t)=>s.jsx(La,{ref:t,className:I("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e}));Bc.displayName=La.displayName;const Vs=c.forwardRef(({className:a,...e},t)=>s.jsx(Mn,{children:s.jsx($a,{ref:t,className:I("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e})}));Vs.displayName=$a.displayName;const ht=c.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(za,{ref:r,className:I("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",e&&"pl-8",a),...t}));ht.displayName=za.displayName;const Uc=c.forwardRef(({className:a,children:e,checked:t,...r},n)=>s.jsxs(Ba,{ref:n,className:I("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:t,...r,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(Ua,{children:s.jsx(Ke,{className:"h-4 w-4"})})}),e]}));Uc.displayName=Ba.displayName;const Vc=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Va,{ref:r,className:I("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(Ua,{children:s.jsx(cr,{className:"h-2 w-2 fill-current"})})}),e]}));Vc.displayName=Va.displayName;const Wc=c.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(Wa,{ref:r,className:I("px-2 py-1.5 text-sm font-semibold text-foreground",e&&"pl-8",a),...t}));Wc.displayName=Wa.displayName;const Qr=c.forwardRef(({className:a,...e},t)=>s.jsx(Ha,{ref:t,className:I("-mx-1 my-1 h-px bg-border",a),...e}));Qr.displayName=Ha.displayName;function la({children:a,folderId:e,folderName:t,onRename:r,onDelete:n,onCreateSubfolder:o,disabled:i=!1}){return i?s.jsx(s.Fragment,{children:a}):s.jsxs(Jr,{children:[s.jsx(Xr,{asChild:!0,children:a}),s.jsxs(Vs,{className:"w-48",children:[s.jsxs(ht,{onClick:()=>r(e),children:[s.jsx(gr,{className:"h-4 w-4 mr-2"}),"Rename Folder"]}),s.jsxs(ht,{onClick:()=>o(e),children:[s.jsx(Ss,{className:"h-4 w-4 mr-2"}),"New Subfolder"]}),s.jsx(Qr,{}),s.jsxs(ht,{onClick:()=>n(e),className:"text-destructive focus:text-destructive",children:[s.jsx(_s,{className:"h-4 w-4 mr-2"}),"Delete Folder"]})]})]})}const Hc=Un,Gc=Vn,Zr=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Ga,{ref:r,className:I("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",a),...t,children:[e,s.jsx(Pn,{asChild:!0,children:s.jsx(Ms,{className:"h-4 w-4 opacity-50"})})]}));Zr.displayName=Ga.displayName;const en=c.forwardRef(({className:a,...e},t)=>s.jsx(Ka,{ref:t,className:I("flex cursor-default items-center justify-center py-1",a),...e,children:s.jsx(ro,{className:"h-4 w-4"})}));en.displayName=Ka.displayName;const tn=c.forwardRef(({className:a,...e},t)=>s.jsx(Ya,{ref:t,className:I("flex cursor-default items-center justify-center py-1",a),...e,children:s.jsx(Ms,{className:"h-4 w-4"})}));tn.displayName=Ya.displayName;const sn=c.forwardRef(({className:a,children:e,position:t="popper",...r},n)=>s.jsx(Ln,{children:s.jsxs(qa,{ref:n,className:I("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:t,...r,children:[s.jsx(en,{}),s.jsx($n,{className:I("p-1",t==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:e}),s.jsx(tn,{})]})}));sn.displayName=qa.displayName;const Kc=c.forwardRef(({className:a,...e},t)=>s.jsx(Ja,{ref:t,className:I("py-1.5 pl-8 pr-2 text-sm font-semibold",a),...e}));Kc.displayName=Ja.displayName;const an=c.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(Xa,{ref:r,className:I("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(zn,{children:s.jsx(Ke,{className:"h-4 w-4"})})}),s.jsx(Bn,{children:e})]}));an.displayName=Xa.displayName;const Yc=c.forwardRef(({className:a,...e},t)=>s.jsx(Qa,{ref:t,className:I("-mx-1 my-1 h-px bg-muted",a),...e}));Yc.displayName=Qa.displayName;const qc=[{value:"#3b82f6",label:"Blue"},{value:"#8b5cf6",label:"Purple"},{value:"#10b981",label:"Green"},{value:"#f59e0b",label:"Orange"},{value:"#ef4444",label:"Red"},{value:"#06b6d4",label:"Cyan"},{value:"#84cc16",label:"Lime"},{value:"#f97316",label:"Orange"}],vs=[{value:"Folder",label:"Folder",icon:He},{value:"Code",label:"Code",icon:no},{value:"Palette",label:"Design",icon:ur},{value:"BookOpen",label:"Learning",icon:oo},{value:"Star",label:"Favorites",icon:io},{value:"Heart",label:"Personal",icon:lo},{value:"Zap",label:"Quick",icon:fr},{value:"Target",label:"Goals",icon:co},{value:"Lightbulb",label:"Ideas",icon:uo},{value:"Coffee",label:"Work",icon:mo}];function Jc({isOpen:a,onClose:e,onConfirm:t,parentId:r,initialData:n,mode:o="create"}){const[i,l]=c.useState(""),[m,u]=c.useState("#3b82f6"),[d,y]=c.useState("Folder");c.useEffect(()=>{a&&(n?(l(n.name),u(n.color),y(n.icon)):(l(""),u("#3b82f6"),y("Folder")))},[a]),c.useEffect(()=>{a&&n&&(l(n.name),u(n.color),y(n.icon))},[n,a]);const h=S=>{S.preventDefault(),i.trim()&&(t({name:i.trim(),color:m,icon:d,parentId:r}),e())},g=vs.find(S=>S.value===d)?.icon||He;return s.jsx(Ft,{open:a,onOpenChange:e,children:s.jsxs(xt,{className:"sm:max-w-md",children:[s.jsxs(wt,{children:[s.jsx(vt,{children:o==="create"?"Create New Folder":"Edit Folder"}),s.jsx(Zt,{children:o==="create"?"Create a new folder to organize your cards.":"Update folder details."})]}),s.jsxs("form",{onSubmit:h,className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(Qe,{htmlFor:"folder-name",children:"Folder Name"}),s.jsx(et,{id:"folder-name",value:i,onChange:S=>l(S.target.value),placeholder:"Enter folder name...",autoFocus:!0})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Qe,{children:"Color"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:qc.map(S=>s.jsx("button",{type:"button",onClick:()=>u(S.value),className:`w-8 h-8 rounded-full border-2 transition-all ${m===S.value?"border-foreground scale-110":"border-muted hover:scale-105"}`,style:{backgroundColor:S.value},title:S.label},S.value))})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Qe,{children:"Icon"}),s.jsxs(Hc,{value:d,onValueChange:y,children:[s.jsx(Zr,{children:s.jsx(Gc,{children:s.jsxs("div",{className:"flex items-center gap-2",children:[U.createElement(g,{className:"h-4 w-4",style:{color:m}}),vs.find(S=>S.value===d)?.label]})})}),s.jsx(sn,{children:vs.map(S=>{const N=S.icon;return s.jsx(an,{value:S.value,children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(N,{className:"h-4 w-4"}),S.label]})},S.value)})})]})]}),r&&s.jsx("div",{className:"flex items-center gap-2",children:s.jsx(ee,{variant:"secondary",children:"Subfolder"})}),s.jsxs(bt,{children:[s.jsx(H,{type:"button",variant:"outline",onClick:e,children:"Cancel"}),s.jsx(H,{type:"submit",disabled:!i.trim(),children:o==="create"?"Create Folder":"Save Changes"})]})]})]})})}const Xc=Hn,Qc=Wn,rn=c.forwardRef(({className:a,...e},t)=>s.jsx(Za,{className:I("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...e,ref:t}));rn.displayName=Za.displayName;const nn=c.forwardRef(({className:a,...e},t)=>s.jsxs(Qc,{children:[s.jsx(rn,{}),s.jsx(er,{ref:t,className:I("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...e})]}));nn.displayName=er.displayName;const on=({className:a,...e})=>s.jsx("div",{className:I("flex flex-col space-y-2 text-center sm:text-left",a),...e});on.displayName="AlertDialogHeader";const ln=({className:a,...e})=>s.jsx("div",{className:I("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...e});ln.displayName="AlertDialogFooter";const cn=c.forwardRef(({className:a,...e},t)=>s.jsx(tr,{ref:t,className:I("text-lg font-semibold",a),...e}));cn.displayName=tr.displayName;const dn=c.forwardRef(({className:a,...e},t)=>s.jsx(sr,{ref:t,className:I("text-sm text-muted-foreground",a),...e}));dn.displayName=sr.displayName;const un=c.forwardRef(({className:a,...e},t)=>s.jsx(ar,{ref:t,className:I(Ls(),a),...e}));un.displayName=ar.displayName;const mn=c.forwardRef(({className:a,...e},t)=>s.jsx(rr,{ref:t,className:I(Ls({variant:"outline"}),"mt-2 sm:mt-0",a),...e}));mn.displayName=rr.displayName;function Zc({isOpen:a,onClose:e,onConfirm:t,folderName:r,cardCount:n,hasSubfolders:o=!1,subfolderCount:i=0}){const l=()=>{t(),e()};return s.jsx(Xc,{open:a,onOpenChange:e,children:s.jsxs(nn,{children:[s.jsxs(on,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(De,{className:"h-5 w-5 text-destructive"}),s.jsx(cn,{children:"Delete Folder"})]}),s.jsxs(dn,{className:"space-y-3",children:[s.jsxs("p",{children:["Are you sure you want to delete the folder ",s.jsxs("strong",{children:['"',r,'"']}),"?"]}),s.jsxs("div",{className:"bg-destructive/10 p-3 rounded-lg space-y-2",children:[s.jsx("p",{className:"text-sm font-medium text-destructive",children:"This action will permanently delete:"}),s.jsxs("div",{className:"flex flex-wrap gap-2",children:[n>0&&s.jsxs(ee,{variant:"destructive",children:[n," card",n!==1?"s":""]}),o&&i>0&&s.jsxs(ee,{variant:"destructive",children:[i," subfolder",i!==1?"s":""]})]})]}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"This action cannot be undone."})]})]}),s.jsxs(ln,{children:[s.jsx(mn,{children:"Cancel"}),s.jsx(un,{onClick:l,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete Forever"})]})]})})}function ed({children:a,tagName:e,onRename:t,onDelete:r,disabled:n=!1}){const o=()=>{n||t(e)},i=()=>{n||r(e)};return n?s.jsx(s.Fragment,{children:a}):s.jsxs(Jr,{children:[s.jsx(Xr,{asChild:!0,children:a}),s.jsxs(Vs,{className:"w-48",children:[s.jsxs(ht,{onClick:o,className:"flex items-center gap-2",children:[s.jsx(gr,{className:"h-4 w-4"}),"Rename Tag"]}),s.jsxs(ht,{onClick:i,className:"flex items-center gap-2 text-destructive focus:text-destructive",children:[s.jsx(_s,{className:"h-4 w-4"}),"Delete Tag"]})]})]})}function td({isOpen:a,onClose:e,onConfirm:t,tagName:r,existingTags:n}){const[o,i]=c.useState(""),[l,m]=c.useState("");c.useEffect(()=>{a&&(i(r),m(""))},[a,r]);const u=h=>{const g=h.trim();return g?g===r?"Please enter a different name":n.includes(g)?"A tag with this name already exists":g.length>50?"Tag name must be less than 50 characters":"":"Tag name cannot be empty"},d=()=>{const h=o.trim(),g=u(h);if(g){m(g);return}t(r,h),e()},y=h=>{h.key==="Enter"&&d()};return s.jsx(Ft,{open:a,onOpenChange:e,children:s.jsxs(xt,{className:"sm:max-w-md",children:[s.jsxs(wt,{children:[s.jsx(vt,{children:"Rename Tag"}),s.jsxs(Zt,{children:['Enter a new name for the tag "',r,'". This will update all cards using this tag.']})]}),s.jsx("div",{className:"space-y-4 py-4",children:s.jsxs("div",{className:"space-y-2",children:[s.jsx(Qe,{htmlFor:"tag-name",children:"Tag Name"}),s.jsx(et,{id:"tag-name",value:o,onChange:h=>{i(h.target.value),l&&m("")},onKeyPress:y,placeholder:"Enter tag name...",autoFocus:!0}),l&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[s.jsx(Ns,{className:"h-4 w-4"}),l]})]})}),s.jsxs(bt,{children:[s.jsx(H,{variant:"outline",onClick:e,children:"Cancel"}),s.jsx(H,{onClick:d,disabled:!!l||!o.trim(),children:"Rename Tag"})]})]})})}function sd({isOpen:a,onClose:e,onConfirm:t,tagName:r,cardCount:n}){return s.jsx(Ft,{open:a,onOpenChange:e,children:s.jsxs(xt,{className:"sm:max-w-md",children:[s.jsxs(wt,{children:[s.jsxs(vt,{className:"flex items-center gap-2",children:[s.jsx(De,{className:"h-5 w-5 text-destructive"}),"Delete Tag"]}),s.jsxs(Zt,{children:['Are you sure you want to delete the tag "',r,'"?']})]}),s.jsx("div",{className:"py-4",children:s.jsxs("div",{className:"rounded-lg bg-destructive/10 p-4 border border-destructive/20",children:[s.jsx("p",{className:"text-sm text-destructive font-medium mb-2",children:"This action cannot be undone."}),s.jsxs("p",{className:"text-sm text-muted-foreground",children:["This tag will be removed from ",s.jsx("strong",{children:n})," ",n===1?"card":"cards","."]})]})}),s.jsxs(bt,{children:[s.jsx(H,{variant:"outline",onClick:e,children:"Cancel"}),s.jsx(H,{variant:"destructive",onClick:t,children:"Delete Tag"})]})]})})}const ad=({tag:a,isSelected:e,onClick:t,className:r,showCount:n=!0})=>s.jsxs("button",{onClick:()=>t(a),className:I("relative flex items-center justify-between px-3 py-2 rounded-xl border transition-all duration-300 ease-out","hover:shadow-lg hover:shadow-black/10 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-blue-500/30","backdrop-blur-sm group",e?"bg-gradient-to-r from-blue-500 to-blue-600 border-blue-500 text-white shadow-md shadow-blue-500/25":"bg-white/80 border-gray-200/60 text-gray-700 hover:bg-white hover:border-gray-300/80",r),style:{boxShadow:e?"0 4px 20px -4px rgba(59, 130, 246, 0.3), 0 0 0 1px rgba(59, 130, 246, 0.1)":void 0},children:[s.jsxs("div",{className:"flex items-center gap-2.5 flex-1 min-w-0",children:[s.jsx("div",{className:I("w-2 h-2 rounded-full flex-shrink-0 transition-all duration-300",e?"bg-white/90 shadow-sm":"shadow-sm"),style:{backgroundColor:e?"rgba(255, 255, 255, 0.9)":a.color,boxShadow:e?"0 1px 3px rgba(0, 0, 0, 0.1)":`0 1px 3px ${a.color}40`}}),s.jsx("span",{className:I("text-sm font-medium truncate transition-all duration-300",e?"text-white":"text-gray-700 group-hover:text-gray-900"),children:a.name}),e&&s.jsx(Ke,{className:"w-3.5 h-3.5 text-white/90 flex-shrink-0 animate-in fade-in-0 zoom-in-95 duration-200"})]}),n&&s.jsx("span",{className:I("text-xs font-medium px-2 py-0.5 rounded-full ml-2 flex-shrink-0 transition-all duration-300",e?"text-blue-600 bg-white/90 shadow-sm":"text-gray-500 bg-gray-100/80 group-hover:bg-gray-200/80 group-hover:text-gray-600"),children:a.count})]}),rd=({tags:a,selectedTags:e,onTagClick:t,className:r,emptyMessage:n="No tags found"})=>a.length===0?s.jsx("div",{className:I("text-center py-8 text-gray-500",r),children:s.jsx("p",{className:"text-sm",children:n})}):s.jsx("div",{className:I("grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2",r),children:a.map(o=>s.jsx(ad,{tag:o,isSelected:e.includes(o.name),onClick:t},o.id))}),nd=({onSearch:a,onCreateTag:e,searchResults:t,searchQuery:r,className:n})=>{const[o,i]=c.useState(r);c.useEffect(()=>{i(r)},[r]);const l=d=>{const y=d.target.value;i(y),a(y)},m=()=>{o.trim()&&(e(o.trim()),i(""),a(""))},u=o.trim()&&t.length===0&&!t.some(d=>d.name.toLowerCase()===o.toLowerCase());return s.jsxs("div",{className:I("space-y-3",n),children:[s.jsxs("div",{className:"relative",children:[s.jsx(ut,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),s.jsx(et,{placeholder:"Search tags or create new...",value:o,onChange:l,className:"pl-11 pr-4 py-3 rounded-2xl border-gray-200/60 bg-gray-50/50 backdrop-blur-sm focus:bg-white focus:border-blue-300 transition-all duration-300"})]}),u&&s.jsxs(H,{onClick:m,variant:"outline",className:"w-full justify-start text-left rounded-xl border-dashed border-2 border-gray-300 hover:border-blue-400 hover:bg-blue-50/50 transition-all duration-300 py-3",children:[s.jsx(Ht,{className:"h-4 w-4 mr-2 text-blue-500"}),s.jsxs("span",{className:"text-gray-700",children:['Create tag "',s.jsx("span",{className:"font-medium text-blue-600",children:o}),'"']})]})]})},od=({isOpen:a,onClose:e,currentCardTags:t,onTagsChange:r})=>{const{tags:n,searchTags:o,dispatch:i,createTagIfNotExists:l}=br(),[m,u]=c.useState(""),[d,y]=c.useState([]),[h,g]=c.useState(t);c.useEffect(()=>{if(m.trim()){const f=o(m);y(f)}else{const f=[...n].sort((p,x)=>x.count-p.count);y(f)}},[m,n,o]),c.useEffect(()=>{g(t)},[t]);const S=f=>{u(f)},N=f=>{i({type:"CREATE_TAG",payload:{name:f,color:"#3b82f6"}});const p=[...h,f];g(p),r(p),u("")},E=f=>{const p=h.includes(f.name);let x;p?x=h.filter(b=>b!==f.name):x=[...h,f.name],g(x),r(x)},v=()=>{u(""),e()};return a?s.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",style:{backgroundColor:"rgba(0, 0, 0, 0.15)",backdropFilter:"blur(8px)"},children:[s.jsx("div",{className:"absolute inset-0",onClick:v}),s.jsxs("div",{className:"relative bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 p-6 w-full max-w-sm sm:max-w-md lg:max-w-2xl max-h-[85vh] flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Manage Tags"}),s.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Select tags for this card"})]}),s.jsx("button",{onClick:v,className:"p-1 rounded-lg hover:bg-gray-100 transition-colors",children:s.jsx(tt,{className:"w-5 h-5 text-gray-500"})})]}),s.jsx(nd,{onSearch:S,onCreateTag:N,searchResults:d,searchQuery:m,className:"mb-4"}),h.length>0&&s.jsxs("div",{className:"mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-100/50",children:[s.jsxs("p",{className:"text-sm font-medium text-blue-700 mb-3",children:["Selected tags (",h.length,"):"]}),s.jsx("div",{className:"flex flex-wrap gap-1.5",children:h.map(f=>s.jsx("span",{className:"inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-sm",children:f},f))})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx(rd,{tags:d,selectedTags:h,onTagClick:E,emptyMessage:m?`No tags found for "${m}"`:"No tags available"})}),s.jsx("div",{className:"text-xs text-gray-400 text-center mt-4 pt-4 border-t border-gray-100",children:s.jsxs("div",{className:"flex items-center justify-center gap-2",children:[s.jsx("div",{className:"w-1 h-1 rounded-full bg-gray-300"}),s.jsx("span",{children:"Click tags to add/remove them from this card"}),s.jsx("div",{className:"w-1 h-1 rounded-full bg-gray-300"})]})})]})]}):null},id=()=>{const{isOpen:a,currentCardTags:e,onTagsChange:t,closeTagPanel:r}=kr();return!a||!t?null:s.jsx(od,{isOpen:a,onClose:r,currentCardTags:e,onTagsChange:t})};class ld{static generateSuggestions(e){const t=[];switch(e.type){case"card_content":t.push(...this.generateCardContentSuggestions(e));break;case"folder_name":t.push(...this.generateFolderNameSuggestions(e));break;case"tag_rename":t.push(...this.generateTagRenameSuggestions(e));break;default:t.push(this.getDefaultSuggestion())}return t.sort((r,n)=>n.confidence-r.confidence)}static generateCardContentSuggestions(e){const t=[],{localVersion:r,remoteVersion:n}=e,o=this.calculateSimilarity(r.content.frontContent.title,n.content.frontContent.title),i=this.calculateSimilarity(r.content.frontContent.text,n.content.frontContent.text),m=Math.abs(r.updatedAt.getTime()-n.updatedAt.getTime())<5*60*1e3,u=r.content.frontContent.text.length,d=n.content.frontContent.text.length,y=Math.max(u,d)/Math.min(u,d);o>.8&&i>.6&&m&&t.push({type:"merge",confidence:.9,reason:"内容高度相似，建议智能合并保留最佳内容",preview:{mergedTitle:this.mergeTitles(r.content.frontContent.title,n.content.frontContent.title),mergedLength:Math.max(u,d)}}),n.updatedAt.getTime()>r.updatedAt.getTime()&&y>2&&d>u&&t.push({type:"keep_remote",confidence:.8,reason:"远程版本内容更丰富且更新时间更近"});const h=new Set(r.content.frontContent.tags),g=new Set(n.content.frontContent.tags),S=[...h].filter(E=>!g.has(E));S.length>0&&S.length/h.size>.3&&t.push({type:"keep_local",confidence:.7,reason:"本地版本包含独特标签，可能包含重要分类信息"});const N=r.updatedAt.getTime()>n.updatedAt.getTime()?"local":"remote";return t.push({type:N==="local"?"keep_local":"keep_remote",confidence:.6,reason:`保留最新版本（${N==="local"?"本地":"远程"}设备）`}),t}static generateFolderNameSuggestions(e){const t=[],{localVersion:r,remoteVersion:n}=e,o=r.name.toLowerCase(),i=n.name.toLowerCase();if(o===i)return[];if(this.calculateSimilarity(r.name,n.name)>.8&&t.push({type:"merge",confidence:.9,reason:"文件夹名称相似，建议统一命名"}),o.includes(i)||i.includes(o)){const u=r.name.length>n.name.length?"local":"remote";t.push({type:u==="local"?"keep_local":"keep_remote",confidence:.8,reason:"保留更具描述性的文件夹名称"})}const m=r.updatedAt.getTime()>n.updatedAt.getTime()?"local":"remote";return t.push({type:m==="local"?"keep_local":"keep_remote",confidence:.6,reason:`保留最新修改的版本（${m==="local"?"本地":"远程"}）`}),t}static generateTagRenameSuggestions(e){const t=[],{localVersion:r,remoteVersion:n}=e,o=r.count/Math.max(n.count,1);o>2?t.push({type:"keep_local",confidence:.9,reason:`本地标签使用频率更高（${r.count}次 vs ${n.count}次）`}):o<.5&&t.push({type:"keep_remote",confidence:.9,reason:`远程标签使用频率更高（${n.count}次 vs ${r.count}次）`});const i=this.evaluateTagNameQuality(r.name),l=this.evaluateTagNameQuality(n.name);if(Math.abs(i-l)>.3){const u=i>l?"local":"remote";t.push({type:u==="local"?"keep_local":"keep_remote",confidence:.8,reason:`${u==="local"?"本地":"远程"}标签名称质量更好`})}const m=r.updatedAt.getTime()>n.updatedAt.getTime()?"local":"remote";return t.push({type:m==="local"?"keep_local":"keep_remote",confidence:.6,reason:"保留最新修改的版本"}),t}static calculateSimilarity(e,t){if(!e||!t)return 0;const r=e.toLowerCase().trim(),n=t.toLowerCase().trim();if(r===n)return 1;const o=Math.max(r.length,n.length);return o===0?1:1-this.levenshteinDistance(r,n)/o}static levenshteinDistance(e,t){const r=Array(t.length+1).fill(null).map(()=>Array(e.length+1).fill(null));for(let n=0;n<=e.length;n+=1)r[0][n]=n;for(let n=0;n<=t.length;n+=1)r[n][0]=n;for(let n=1;n<=t.length;n+=1)for(let o=1;o<=e.length;o+=1){const i=e[o-1]===t[n-1]?0:1;r[n][o]=Math.min(r[n][o-1]+1,r[n-1][o]+1,r[n-1][o-1]+i)}return r[t.length][e.length]}static mergeTitles(e,t){if(e===t||e.includes(t)&&e.length>t.length)return e;if(t.includes(e)&&t.length>e.length)return t;const r=new Set(e.toLowerCase().split(/\s+/)),n=new Set(t.toLowerCase().split(/\s+/)),o=new Set([...r,...n]),i=e.split(/\s+/),l=t.split(/\s+/),m=[];return i.forEach(u=>{!m.includes(u)&&o.has(u.toLowerCase())&&m.push(u)}),l.forEach(u=>{!m.includes(u)&&o.has(u.toLowerCase())&&m.push(u)}),m.join(" ")}static evaluateTagNameQuality(e){let t=.5;e.length>=3&&e.length<=20&&(t+=.2),e.length>30&&(t-=.1),/^[a-zA-Z0-9\u4e00-\u9fff\s\-_]+$/.test(e)&&(t+=.2),(e===e.toLowerCase()||/^[A-Z][a-z]+([A-Z][a-z]*)*$/.test(e))&&(t+=.1);const n=e.match(/[^a-zA-Z0-9\u4e00-\u9fff\s]/g);return n&&n.length>2&&(t-=.1),Math.max(0,Math.min(1,t))}static getDefaultSuggestion(){return{type:"manual",confidence:.5,reason:"无法自动确定最佳解决方案，建议手动处理"}}static applyResolution(e,t){switch(t.type){case"keep_local":return this.getLocalVersion(e);case"keep_remote":return this.getRemoteVersion(e);case"merge":return this.mergeVersions(e,t.mergedData);case"manual":return t.mergedData||t.manualChanges;default:throw new Error(`Unknown resolution type: ${t.type}`)}}static getLocalVersion(e){return e.entityType==="card",e.localVersion}static getRemoteVersion(e){return e.entityType==="card",e.remoteVersion}static mergeVersions(e,t){return t||this.smartMerge(e)}static smartMerge(e){if(e.entityType==="card"){const t=e,r=t.localVersion,n=t.remoteVersion;return{content:{frontContent:{title:this.mergeTitles(r.content.frontContent.title,n.content.frontContent.title),text:this.mergeText(r.content.frontContent.text,n.content.frontContent.text),tags:[...new Set([...r.content.frontContent.tags,...n.content.frontContent.tags])],lastModified:new Date},backContent:{title:this.mergeTitles(r.content.backContent.title,n.content.backContent.title),text:this.mergeText(r.content.backContent.text,n.content.backContent.text),tags:[...new Set([...r.content.backContent.tags,...n.content.backContent.tags])],lastModified:new Date}},style:r.style,folderId:r.folderId,isFlipped:r.isFlipped,updatedAt:new Date}}return this.getLocalVersion(e)}static mergeText(e,t){if(e===t)return e;const r=e.split(/[.!?]+/).filter(i=>i.trim()),n=t.split(/[.!?]+/).filter(i=>i.trim()),o=new Set([...r.map(i=>i.trim()),...n.map(i=>i.trim())]);return`${Array.from(o).filter(i=>i.length>0).join(". ")}.`}}function rs(){const[a,e]=c.useState([]),[t,r]=c.useState(null),[n,o]=c.useState(!1),[i,l]=c.useState(!1),[m,u]=c.useState(null),[d,y]=c.useState(null),[h,g]=c.useState(null),S=c.useRef({totalConflicts:0,resolvedConflicts:0,pendingConflicts:0,conflictsByType:{},conflictsBySeverity:{},averageResolutionTime:0});c.useEffect(()=>{const _={totalConflicts:a.length,resolvedConflicts:a.filter(A=>A.status==="resolved").length,pendingConflicts:a.filter(A=>A.status==="pending").length,conflictsByType:{},conflictsBySeverity:{},averageResolutionTime:b()};a.forEach(A=>{_.conflictsByType[A.type]=(_.conflictsByType[A.type]||0)+1,_.conflictsBySeverity[A.severity]=(_.conflictsBySeverity[A.severity]||0)+1}),S.current=_},[a]),c.useEffect(()=>{N();const _=setInterval(()=>{C()},5e3);return()=>{clearInterval(_)}},[]);const N=async()=>{l(!0);try{await E(),await C(),u(null)}catch(_){console.error("Failed to initialize conflict management:",_),u(_ instanceof Error?_.message:"Unknown error")}finally{l(!1)}},E=async()=>{try{const _=ye.getConflicts(),A=v(_);return e(A),A}catch(_){return console.error("Failed to load conflicts from service:",_),[]}},v=_=>_.map(A=>{const T={id:A.id,type:f(A.conflictType),entityType:A.entityType,entityId:A.entityId,timestamp:A.detectedAt||new Date,sourceDevice:A.sourceDevice||"Unknown",severity:A.severity,status:p(A.status),createdAt:A.detectedAt||new Date,resolvedAt:A.resolvedAt,resolvedBy:A.resolvedBy,resolution:A.resolution?x(A.resolution):void 0};switch(A.entityType){case"card":return{...T,type:"card_content",localVersion:A.localData,remoteVersion:A.cloudData,conflictFields:A.conflictFields||[],suggestions:A.suggestions?.map(W=>({type:W.type,confidence:W.confidence,reason:W.reasoning||W.reason,preview:W.preview}))};case"folder":return{...T,type:"folder_name",localVersion:A.localData,remoteVersion:A.cloudData,affectedCards:A.conflictDetails?.affectedEntities||[]};case"tag":return{...T,type:"tag_rename",localVersion:A.localData,remoteVersion:A.cloudData,affectedCards:A.conflictDetails?.affectedEntities||[]};default:throw new Error(`Unknown entity type: ${A.entityType}`)}}),f=_=>({content:"card_content",version:"card_content",structure:"folder_structure",delete:"tag_delete",field:"card_content"})[_]||"card_content",p=_=>({pending:"pending",resolving:"reviewing",resolved:"resolved",manual_required:"pending"})[_]||"pending",x=_=>({type:_.type,mergedData:_.mergedData,reason:_.reasoning,manualChanges:_.manualChanges}),b=()=>{const _=a.filter(T=>T.status==="resolved"&&T.resolvedAt);return _.length===0?0:_.reduce((T,W)=>T+(W.resolvedAt.getTime()-W.createdAt.getTime()),0)/_.length},C=async()=>{try{const _=ye.getStatus();g(_),_.isSyncing===!1&&_.networkStatus?.online&&await w()}catch(_){console.error("Failed to update sync status:",_)}},w=async()=>{try{const _=await E();_.filter(T=>T.status==="pending").length>a.filter(T=>T.status==="pending").length&&e(_)}catch(_){console.error("Failed to detect new conflicts:",_)}},j=c.useCallback(_=>a.find(A=>A.id===_),[a]),D=c.useCallback(()=>a.filter(_=>_.status==="pending"),[a]),P=c.useCallback(()=>a.filter(_=>_.severity==="high"||_.severity==="critical"),[a]),$=c.useCallback(()=>({...S.current}),[]),K=c.useCallback(async(_,A)=>{o(!0),u(null);try{if(await ye.resolveConflict(_,A.type,A.mergedData))return e(W=>W.map(J=>J.id===_?{...J,status:"resolved",resolvedAt:new Date,resolvedBy:"user",resolution:A}:J)),r(null),await C(),!0;throw new Error("Failed to resolve conflict via sync service")}catch(T){return console.error("Failed to resolve conflict:",T),u(T instanceof Error?T.message:"Unknown error"),!1}finally{o(!1)}},[]),se=c.useCallback(async _=>{try{if(!a.find(T=>T.id===_))return;e(T=>T.map(W=>W.id===_?{...W,status:"ignored"}:W)),r(null)}catch(A){console.error("Failed to ignore conflict:",A),u(A instanceof Error?A.message:"Unknown error")}},[a]),V=c.useCallback(async(_,A)=>{o(!0),u(null);try{const T=await Promise.allSettled(_.map(B=>ye.resolveConflict(B,A.type,A.mergedData))),W=T.filter(B=>B.status==="fulfilled").length,J=T.filter(B=>B.status==="rejected").length;if(W>0&&e(B=>B.map(q=>_.includes(q.id)?{...q,status:"resolved",resolvedAt:new Date,resolvedBy:"user",resolution:A}:q)),J>0)throw new Error(`${J} conflicts failed to resolve`);return await C(),!0}catch(T){return console.error("Failed to batch resolve conflicts:",T),u(T instanceof Error?T.message:"Unknown error"),!1}finally{o(!1)}},[]),re=c.useCallback(_=>{const A=j(_);if(!A)return[];const T=ld.generateSuggestions(A),W=ye.getConflict(_)?.suggestions||[];return[...T,...W.map(B=>({type:B.type,confidence:B.confidence,reason:B.reasoning||B.reason,preview:B.preview}))].sort((B,q)=>q.confidence-B.confidence)},[j]),te=c.useCallback(async()=>{l(!0);try{const _=await ye.sync({type:"incremental",direction:"bidirectional"}),A=await E(),T=A.filter(W=>W.status==="pending");return e(A),T}catch(_){return console.error("Failed to detect conflicts:",_),u(_ instanceof Error?_.message:"Unknown error"),[]}finally{l(!1)}},[]),ne=c.useCallback(async()=>{o(!0);try{const _=await ye.autoResolveConflicts();return await E(),await C(),_}catch(_){return console.error("Failed to auto-resolve conflicts:",_),u(_ instanceof Error?_.message:"Unknown error"),0}finally{o(!1)}},[]),ge=c.useCallback(async _=>{try{const A=j(_);if(!A)return null;const T=ye.getConflict(_);return{...A,syncDetails:T,suggestions:re(_)}}catch(A){return console.error("Failed to get conflict details:",A),null}},[j,re]),z=c.useCallback(async()=>{l(!0);try{await E(),await C(),u(null)}catch(_){console.error("Failed to refresh conflicts:",_),u(_ instanceof Error?_.message:"Unknown error")}finally{l(!1)}},[]),Y=c.useCallback(()=>{u(null)},[]);return{conflicts:a,selectedConflict:t,setSelectedConflict:r,isResolving:n,isLoading:i,error:m,syncStatus:h,metrics:d,stats:{...S.current},getConflictById:j,getPendingConflicts:D,getHighPriorityConflicts:P,getStats:$,resolveConflict:K,ignoreConflict:se,batchResolveConflicts:V,getSuggestions:re,detectConflicts:te,autoResolveConflicts:ne,getConflictDetails:ge,refreshConflicts:z,clearError:Y}}const cd=Xt("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),Ze=c.forwardRef(({className:a,variant:e,...t},r)=>s.jsx("div",{ref:r,role:"alert",className:I(cd({variant:e}),a),...t}));Ze.displayName="Alert";const gn=c.forwardRef(({className:a,...e},t)=>s.jsx("h5",{ref:t,className:I("mb-1 font-medium leading-none tracking-tight",a),...e}));gn.displayName="AlertTitle";const pt=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:I("text-sm [&_p]:leading-relaxed",a),...e}));pt.displayName="AlertDescription";function dd({className:a,onOpenConflictPanel:e}){const{stats:t,getHighPriorityConflicts:r,detectConflicts:n,setSelectedConflict:o}=rs(),i=r();if(!(t.pendingConflicts>0))return null;const m=async()=>{await n()},u=y=>{o(y),e?.()},d=y=>{switch(y){case"critical":return"bg-red-500 text-white";case"high":return"bg-orange-500 text-white";case"medium":return"bg-yellow-500 text-white";case"low":return"bg-blue-500 text-white";default:return"bg-gray-500 text-white"}};return s.jsxs("div",{className:I("space-y-2",a),children:[s.jsxs(Ze,{className:"border-orange-200 bg-orange-50",children:[s.jsx(De,{className:"h-4 w-4 text-orange-600"}),s.jsx(gn,{className:"text-orange-800",children:"检测到数据冲突"}),s.jsxs(pt,{className:"text-orange-700",children:["发现 ",t.pendingConflicts," 个待解决的数据冲突，建议及时处理以避免数据丢失。",i.length>0&&s.jsxs("span",{className:"ml-2 font-medium",children:["其中 ",i.length," 个需要立即处理。"]})]}),s.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(H,{variant:"outline",size:"sm",onClick:e,className:"text-orange-700 border-orange-300 hover:bg-orange-100",children:[s.jsx(Gs,{className:"h-4 w-4 mr-2"}),"查看所有冲突"]}),s.jsxs(H,{variant:"ghost",size:"sm",onClick:m,className:"text-orange-600 hover:bg-orange-100",children:[s.jsx(ze,{className:"h-4 w-4 mr-2"}),"刷新检测"]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(ee,{variant:"secondary",className:"text-orange-700 bg-orange-100",children:["总计: ",t.totalConflicts]}),s.jsxs(ee,{variant:"destructive",className:"bg-red-100 text-red-700",children:["待解决: ",t.pendingConflicts]})]})]})]}),i.length>0&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h4",{className:"text-sm font-medium text-red-700",children:"高优先级冲突"}),s.jsxs(ee,{variant:"destructive",className:"text-xs",children:[i.length," 个"]})]}),i.slice(0,3).map(y=>s.jsx(Ze,{className:"border-red-200 bg-red-50 cursor-pointer hover:bg-red-100 transition-colors",onClick:()=>u(y.id),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(ee,{variant:"outline",className:I("text-xs",d(y.severity)),children:y.severity}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-red-800",children:ud(y)}),s.jsx("p",{className:"text-xs text-red-600",children:md(y)})]})]}),s.jsx(H,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-red-600 hover:bg-red-100",onClick:h=>{h.stopPropagation(),u(y.id)},children:s.jsx(Gs,{className:"h-4 w-4"})})]})},y.id)),i.length>3&&s.jsxs(H,{variant:"ghost",size:"sm",onClick:e,className:"w-full text-red-600 hover:bg-red-100",children:["查看剩余 ",i.length-3," 个高优先级冲突"]})]})]})}function ud(a){switch(a.type){case"card_content":return"卡片内容冲突";case"card_style":return"卡片样式冲突";case"card_tags":return"卡片标签冲突";case"card_folder":return"卡片文件夹冲突";case"folder_name":return"文件夹名称冲突";case"folder_structure":return"文件夹结构冲突";case"tag_rename":return"标签重命名冲突";case"tag_delete":return"标签删除冲突";case"tag_color":return"标签颜色冲突";default:return"数据冲突"}}function md(a){switch(a.type){case"card_content":return`卡片 "${a.localVersion.content.frontContent.title}" 在多设备上被同时编辑`;case"folder_name":return`文件夹 "${a.localVersion.name}" 与远程版本名称不一致`;case"tag_rename":return`标签 "${a.localVersion.name}" 重命名冲突`;default:return"数据版本不一致，需要手动解决"}}const de=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:I("rounded-lg border bg-card text-card-foreground shadow-sm",a),...e}));de.displayName="Card";const _e=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:I("flex flex-col space-y-1.5 p-6",a),...e}));_e.displayName="CardHeader";const Me=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:I("text-2xl font-semibold leading-none tracking-tight",a),...e}));Me.displayName="CardTitle";const fn=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:I("text-sm text-muted-foreground",a),...e}));fn.displayName="CardDescription";const ue=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:I("p-6 pt-0",a),...e}));ue.displayName="CardContent";const gd=c.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:I("flex items-center p-6 pt-0",a),...e}));gd.displayName="CardFooter";const We=c.forwardRef(({className:a,value:e,...t},r)=>s.jsx(nr,{ref:r,className:I("relative h-4 w-full overflow-hidden rounded-full bg-secondary",a),...t,children:s.jsx(Gn,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(e||0)}%)`}})}));We.displayName=nr.displayName;class dt{static instance;metrics=[];alerts=[];observers=[];sessionId;startTime;constructor(){this.sessionId=this.generateSessionId(),this.startTime=performance.now(),this.initializeObservers()}static getInstance(){return dt.instance||(dt.instance=new dt),dt.instance}initializeObservers(){"PerformanceObserver"in window&&(this.observePaintTiming(),this.observeLayoutShift(),this.observeInteraction()),this.observeMemoryUsage(),this.observeNetworkPerformance(),this.observeErrors(),this.startPeriodicCollection()}observePaintTiming(){try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(n=>{n.name==="first-paint"?this.updateMetric("firstPaint",n.startTime):n.name==="first-contentful-paint"&&this.updateMetric("firstContentfulPaint",n.startTime)})});e.observe({entryTypes:["paint"]}),this.observers.push(e)}catch(e){console.warn("Failed to observe paint timing:",e)}}observeLayoutShift(){try{const e=new PerformanceObserver(t=>{const r=t.getEntries();let n=0;r.forEach(o=>{o instanceof LayoutShift&&(n+=o.value)}),this.updateMetric("cumulativeLayoutShift",n)});e.observe({entryTypes:["layout-shift"]}),this.observers.push(e)}catch(e){console.warn("Failed to observe layout shift:",e)}}observeInteraction(){try{const e=new PerformanceObserver(t=>{t.getEntries().forEach(n=>{n instanceof PerformanceEventTiming&&(this.updateMetric("interactionTime",n.duration),this.updateMetric("firstInputDelay",n.processingStart-n.startTime))})});e.observe({entryTypes:["first-input","event"]}),this.observers.push(e)}catch(e){console.warn("Failed to observe interactions:",e)}}observeMemoryUsage(){setInterval(()=>{if("memory"in performance){const e=performance.memory;this.updateMetric("memoryUsage",e.usedJSHeapSize),e.jsHeapSizeLimit-e.usedJSHeapSize<e.jsHeapSizeLimit*.1&&this.createAlert({type:"warning",category:"memory",message:"High memory usage detected",severity:"medium",suggestions:["Check for memory leaks","Consider garbage collection"]})}},5e3)}observeNetworkPerformance(){const e=window.fetch;window.fetch=async(...t)=>{const r=performance.now();try{const n=await e(...t),o=performance.now();return this.updateMetric("requestTime",o-r),n}catch(n){const o=performance.now();throw this.updateMetric("requestTime",o-r),n}}}observeErrors(){window.addEventListener("error",e=>{this.createAlert({type:"error",category:"performance",message:`JavaScript error: ${e.message}`,severity:"high",context:{filename:e.filename,lineno:e.lineno,colno:e.colno}})}),window.addEventListener("unhandledrejection",e=>{this.createAlert({type:"error",category:"performance",message:`Unhandled promise rejection: ${e.reason}`,severity:"high"})})}startPeriodicCollection(){setInterval(()=>{this.collectMetrics()},3e4)}collectMetrics(){const e={renderTime:this.calculateRenderTime(),firstPaint:this.getMetric("firstPaint")||0,firstContentfulPaint:this.getMetric("firstContentfulPaint")||0,largestContentfulPaint:this.getLCP(),cumulativeLayoutShift:this.getMetric("cumulativeLayoutShift")||0,firstInputDelay:this.getMetric("firstInputDelay")||0,interactionTime:this.getMetric("interactionTime")||0,clickLatency:this.measureClickLatency(),scrollPerformance:this.measureScrollPerformance(),inputResponsiveness:this.measureInputResponsiveness(),memoryUsage:this.getMemoryUsage(),memoryLeakDetected:this.detectMemoryLeak(),garbageCollectionTime:this.measureGarbageCollection(),networkLatency:this.measureNetworkLatency(),requestTime:this.getMetric("requestTime")||0,resourceLoadTime:this.measureResourceLoadTime(),conflictDetectionTime:this.getMetric("conflictDetectionTime")||0,conflictResolutionTime:this.getMetric("conflictResolutionTime")||0,batchOperationTime:this.getMetric("batchOperationTime")||0,perceivedPerformance:this.calculatePerceivedPerformance(),errorRate:this.calculateErrorRate(),crashRate:this.calculateCrashRate(),userSatisfaction:this.calculateUserSatisfaction(),timestamp:new Date,sessionId:this.sessionId};this.metrics.push(e),this.analyzeMetrics(e)}startConflictDetection(){const e=performance.now();return()=>{const t=performance.now();this.updateMetric("conflictDetectionTime",t-e)}}startConflictResolution(){const e=performance.now();return()=>{const t=performance.now();this.updateMetric("conflictResolutionTime",t-e)}}startBatchOperation(){const e=performance.now();return()=>{const t=performance.now();this.updateMetric("batchOperationTime",t-e)}}trackUserInteraction(e,t,r){this.updateMetric(`${e}Duration`,t),r||this.createAlert({type:"warning",category:"ux",message:`User interaction failed: ${e}`,severity:"medium"})}trackUserSatisfaction(e,t){this.updateMetric("userSatisfaction",e),t&&console.log("User feedback:",t)}analyzeMetrics(e){e.renderTime>100&&this.createAlert({type:"warning",category:"performance",message:"Slow render time detected",severity:"medium",suggestions:["Optimize component rendering","Consider virtualization"]}),e.memoryUsage>100*1024*1024&&this.createAlert({type:"warning",category:"memory",message:"High memory usage detected",severity:"medium",suggestions:["Check for memory leaks","Optimize data structures"]}),e.networkLatency>1e3&&this.createAlert({type:"warning",category:"network",message:"High network latency detected",severity:"medium",suggestions:["Check network connection","Optimize API calls"]}),e.conflictResolutionTime>5e3&&this.createAlert({type:"warning",category:"performance",message:"Slow conflict resolution detected",severity:"medium",suggestions:["Optimize conflict resolution algorithm","Consider caching"]})}generateReport(e=36e5){const t=new Date,r=new Date(t.getTime()-e),n=this.metrics.filter(i=>i.timestamp>=r&&i.timestamp<=t),o=this.calculateUserExperienceMetrics(n);return{period:{start:r,end:t},metrics:n,userExperience:o,alerts:this.alerts.filter(i=>i.timestamp>=r),summary:{averagePerformance:this.calculateAveragePerformance(n),performanceTrend:this.calculatePerformanceTrend(n),criticalIssues:this.alerts.filter(i=>i.severity==="critical").length,recommendations:this.generateRecommendations(n,o)}}}updateMetric(e,t){const r=this.metrics[this.metrics.length-1];r&&(r[e]=t)}getMetric(e){const t=this.metrics[this.metrics.length-1];return t?t[e]:null}calculateRenderTime(){const e=performance.getEntriesByType("navigation")[0];return e?e.loadEventEnd-e.loadEventStart:0}getLCP(){const e=performance.getEntriesByType("largest-contentful-paint")[0];return e?e.startTime:0}measureClickLatency(){return 0}measureScrollPerformance(){return 0}measureInputResponsiveness(){return 0}getMemoryUsage(){return"memory"in performance?performance.memory.usedJSHeapSize:0}detectMemoryLeak(){return!1}measureGarbageCollection(){return 0}measureNetworkLatency(){return 0}measureResourceLoadTime(){return 0}calculatePerceivedPerformance(){return 85}calculateErrorRate(){return .01}calculateCrashRate(){return .001}calculateUserSatisfaction(){return 85}calculateUserExperienceMetrics(e){return{averageTaskCompletionTime:0,taskSuccessRate:.95,clickCount:0,scrollDepth:0,timeOnPage:0,bounceRate:.1,conflictResolutionSuccess:.9,conflictResolutionAttempts:0,averageResolutionTime:0,userPreferredResolution:"auto",interfaceResponsiveness:85,loadingTime:0,errorEncounterRate:.02,satisfactionScore:85,feedbackCount:0,commonComplaints:[]}}calculateAveragePerformance(e){return e.length===0?0:e.reduce((r,n)=>r+n.perceivedPerformance,0)/e.length}calculatePerformanceTrend(e){if(e.length<2)return"stable";const t=e.slice(-10),r=e.slice(-20,-10),n=t.reduce((i,l)=>i+l.perceivedPerformance,0)/t.length,o=r.reduce((i,l)=>i+l.perceivedPerformance,0)/r.length;return n>o+5?"improving":n<o-5?"declining":"stable"}generateRecommendations(e,t){const r=[];return t.conflictResolutionSuccess<.8&&r.push("Improve conflict resolution algorithms"),t.interfaceResponsiveness<70&&r.push("Optimize UI responsiveness"),t.errorEncounterRate>.05&&r.push("Reduce error rates in user interactions"),r}createAlert(e){const t={...e,id:this.generateAlertId(),timestamp:new Date};this.alerts.push(t),console.warn("Performance Alert:",t)}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateAlertId(){return`alert_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getMetrics(){return[...this.metrics]}getAlerts(){return[...this.alerts]}clearMetrics(){this.metrics=[],this.alerts=[]}getRealtimeMetrics(){return{renderTime:this.calculateRenderTime(),memoryUsage:this.getMemoryUsage(),networkLatency:this.measureNetworkLatency(),perceivedPerformance:this.calculatePerceivedPerformance()}}}const Ce=dt.getInstance();function fd({className:a,showDetails:e=!1,compact:t=!1}){const[r,n]=c.useState(!0),[o,i]=c.useState(!1),[l,m]=c.useState(null),[u,d]=c.useState([]),[y,h]=c.useState({lastSyncTime:null,totalOperations:0,successfulOperations:0,failedOperations:0,averageSyncTime:0,networkLatency:0,serverResponseTime:0,dataTransferRate:0}),[g,S]=c.useState(!1);c.useEffect(()=>{const w=()=>n(!0),j=()=>n(!1);return window.addEventListener("online",w),window.addEventListener("offline",j),n(navigator.onLine),()=>{window.removeEventListener("online",w),window.removeEventListener("offline",j)}},[]),c.useEffect(()=>{const w=async()=>{try{const K=ye.getStatus();m(K),i(K.isSyncing),K.lastSyncTime&&h(V=>({...V,lastSyncTime:new Date(K.lastSyncTime),totalOperations:K.totalSyncs||0,successfulOperations:K.successfulSyncs||0,failedOperations:K.failedSyncs||0}));const se=Ce.getRealtimeMetrics();h(V=>({...V,networkLatency:se.networkLatency||0}))}catch(K){console.error("Failed to update sync status:",K)}};w();const j=setInterval(w,2e3),D=()=>{i(!0),N({type:"upload",entity:"批量同步",status:"in_progress",progress:0,startTime:new Date})},P=()=>{i(!1),E("completed"),w()},$=K=>{i(!1),E("failed",K.message)};return ye.on("sync:start",D),ye.on("sync:complete",P),ye.on("sync:error",$),()=>{clearInterval(j),ye.off("sync:start",D),ye.off("sync:complete",P),ye.off("sync:error",$)}},[]);const N=w=>{const j={...w,id:`op_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};d(D=>[j,...D.slice(0,9)]),h(D=>({...D,totalOperations:D.totalOperations+1}))},E=(w,j)=>{d(D=>D.map(P=>P.status==="in_progress"?{...P,status:w,endTime:new Date,error:j,progress:w==="completed"?100:P.progress}:P)),w==="completed"?h(D=>({...D,successfulOperations:D.successfulOperations+1})):w==="failed"&&h(D=>({...D,failedOperations:D.failedOperations+1}))},v=async()=>{try{i(!0),await ye.sync({type:"incremental",direction:"bidirectional"})}catch(w){console.error("Manual sync failed:",w)}finally{i(!1)}},f=()=>r?o?"text-yellow-500 animate-pulse":l?.hasConflicts?"text-orange-500":"text-green-500":"text-red-500",p=()=>r?o?s.jsx(ze,{className:"h-4 w-4 animate-spin"}):l?.hasConflicts?s.jsx(De,{className:"h-4 w-4"}):s.jsx(Fs,{className:"h-4 w-4"}):s.jsx(pr,{className:"h-4 w-4"}),x=()=>r?o?"同步中...":l?.hasConflicts?"需要解决冲突":"已同步":"离线",b=w=>{if(!w)return"从未";const D=new Date().getTime()-w.getTime(),P=Math.floor(D/6e4);return P<1?"刚刚":P<60?`${P}分钟前`:P<1440?`${Math.floor(P/60)}小时前`:`${Math.floor(P/1440)}天前`},C=y.totalOperations>0?(y.successfulOperations/y.totalOperations*100).toFixed(1):"0.0";return t?s.jsxs("div",{className:I("flex items-center gap-2 text-sm",a),children:[s.jsxs("div",{className:I("flex items-center gap-1",f()),children:[p(),s.jsx("span",{children:x()})]}),l?.pendingOperations>0&&s.jsxs(ee,{variant:"secondary",className:"text-xs",children:[l.pendingOperations," 待同步"]}),s.jsx(H,{variant:"ghost",size:"sm",onClick:v,disabled:o||!r,children:s.jsx(ze,{className:I("h-3 w-3",o&&"animate-spin")})})]}):s.jsxs(de,{className:I("w-full",a),children:[s.jsxs(_e,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Me,{className:"text-lg",children:"同步状态"}),s.jsxs("div",{className:I("flex items-center gap-1 text-sm",f()),children:[p(),s.jsx("span",{children:x()})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[l?.pendingOperations>0&&s.jsxs(ee,{variant:"outline",children:[l.pendingOperations," 待同步"]}),s.jsxs(H,{variant:"outline",size:"sm",onClick:v,disabled:o||!r,children:[s.jsx(ze,{className:I("h-4 w-4 mr-2",o&&"animate-spin")}),"立即同步"]}),e&&s.jsx(H,{variant:"ghost",size:"sm",onClick:()=>S(!g),children:g?"收起":"详情"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"网络状态:"}),s.jsx("span",{className:"ml-2 font-medium",children:r?"在线":"离线"})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"最后同步:"}),s.jsx("span",{className:"ml-2 font-medium",children:b(y.lastSyncTime)})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"成功率:"}),s.jsxs("span",{className:"ml-2 font-medium",children:[C,"%"]})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"延迟:"}),s.jsxs("span",{className:"ml-2 font-medium",children:[y.networkLatency,"ms"]})]})]}),o&&u.length>0&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between text-sm",children:[s.jsx("span",{children:"同步进度"}),s.jsxs("span",{children:[u.find(w=>w.status==="in_progress")?.progress||0,"%"]})]}),s.jsx(We,{value:u.find(w=>w.status==="in_progress")?.progress||0,className:"h-2"})]})]}),g&&e&&s.jsxs(ue,{className:"space-y-4",children:[s.jsx(ct,{}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[s.jsx(de,{children:s.jsxs(ue,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(hr,{className:"h-4 w-4 text-blue-500"}),s.jsx("span",{className:"font-medium",children:"操作统计"})]}),s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"总操作数:"}),s.jsx("span",{children:y.totalOperations})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"成功:"}),s.jsx("span",{className:"text-green-600",children:y.successfulOperations})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"失败:"}),s.jsx("span",{className:"text-red-600",children:y.failedOperations})]})]})]})}),s.jsx(de,{children:s.jsxs(ue,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(go,{className:"h-4 w-4 text-green-500"}),s.jsx("span",{className:"font-medium",children:"性能指标"})]}),s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"平均同步时间:"}),s.jsxs("span",{children:[y.averageSyncTime,"ms"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"服务器响应:"}),s.jsxs("span",{children:[y.serverResponseTime,"ms"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"传输速率:"}),s.jsxs("span",{children:[y.dataTransferRate,"KB/s"]})]})]})]})}),s.jsx(de,{children:s.jsxs(ue,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(fo,{className:"h-4 w-4 text-purple-500"}),s.jsx("span",{className:"font-medium",children:"同步状态"})]}),s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"待同步操作:"}),s.jsx("span",{children:l?.pendingOperations||0})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"冲突数量:"}),s.jsx("span",{children:l?.conflicts?.length||0})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"同步模式:"}),s.jsx("span",{children:"自动"})]})]})]})})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"最近操作"}),s.jsx(Ge,{className:"h-48 border rounded-md p-2",children:s.jsx("div",{className:"space-y-2",children:u.length===0?s.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"暂无操作记录"}):u.map(w=>s.jsxs("div",{className:"flex items-center justify-between text-sm p-2 rounded border",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[w.status==="completed"&&s.jsx(gt,{className:"h-3 w-3 text-green-500"}),w.status==="failed"&&s.jsx(Tt,{className:"h-3 w-3 text-red-500"}),w.status==="in_progress"&&s.jsx(At,{className:"h-3 w-3 text-yellow-500 animate-spin"}),w.status==="pending"&&s.jsx(At,{className:"h-3 w-3 text-gray-500"}),s.jsx("span",{children:w.entity}),s.jsx(ee,{variant:"outline",className:"text-xs",children:w.type==="upload"?"上传":w.type==="download"?"下载":w.type==="conflict_resolution"?"冲突解决":"合并"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[w.status==="in_progress"&&s.jsx(We,{value:w.progress,className:"w-16 h-1"}),s.jsx("span",{className:"text-xs text-muted-foreground",children:b(w.startTime)})]})]},w.id))})})]})]})]})}function hd({isOpen:a,onClose:e,className:t}){const{conflicts:r,setSelectedConflict:n,getStats:o,getPendingConflicts:i,getHighPriorityConflicts:l,resolveConflict:m,ignoreConflict:u,batchResolveConflicts:d,refreshConflicts:y,isResolving:h,isLoading:g,error:S,syncStatus:N}=rs(),[E,v]=c.useState("all"),[f,p]=c.useState(""),[x,b]=c.useState(new Set),[C,w]=c.useState(new Set),[j,D]=c.useState(!1),[P,$]=c.useState(null),K=o(),se=i(),V=l(),re=U.useMemo(()=>{let T=r;switch(E){case"pending":T=se;break;case"high":T=V;break;case"resolved":T=r.filter(W=>W.status==="resolved");break}if(f){const W=f.toLowerCase();T=T.filter(J=>{switch(J.entityType){case"card":return J.localVersion.content.frontContent.title.toLowerCase().includes(W);case"folder":return J.localVersion.name.toLowerCase().includes(W);case"tag":return J.localVersion.name.toLowerCase().includes(W);default:return!1}})}return T.sort((W,J)=>{const B={critical:4,high:3,medium:2,low:1},q=B[J.severity]-B[W.severity];return q!==0?-q:J.timestamp.getTime()-W.timestamp.getTime()})},[r,E,f,se,V]),te=T=>{b(W=>{const J=new Set(W);return J.has(T)?J.delete(T):J.add(T),J})},ne=T=>{w(W=>{const J=new Set(W);return J.has(T)?J.delete(T):J.add(T),J})},ge=T=>{$(T),D(!0)},z=()=>{C.size===re.length?w(new Set):w(new Set(re.map(T=>T.id)))},Y=async T=>{if(C.size===0)return;const W=Array.from(C);await d(W,{type:T,reason:`批量选择${T==="keep_local"?"本地":"远程"}版本`}),w(new Set)},_=T=>{switch(T){case"critical":return"text-red-600 bg-red-50 border-red-200";case"high":return"text-orange-600 bg-orange-50 border-orange-200";case"medium":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"low":return"text-blue-600 bg-blue-50 border-blue-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}},A=T=>{switch(T){case"resolved":return s.jsx(gt,{className:"h-4 w-4 text-green-500"});case"ignored":return s.jsx(Tt,{className:"h-4 w-4 text-gray-500"});default:return s.jsx(At,{className:"h-4 w-4 text-yellow-500"})}};return a?s.jsx("div",{className:I("fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",t),children:s.jsxs(de,{className:"w-full max-w-4xl max-h-[90vh] flex flex-col",children:[s.jsxs(_e,{className:"pb-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(De,{className:"h-5 w-5 text-orange-500"}),s.jsx(Me,{className:"text-xl",children:"冲突管理中心"}),s.jsxs(ee,{variant:"outline",className:"ml-2",children:[K.pendingConflicts," 待解决"]})]}),s.jsx(H,{variant:"ghost",size:"sm",onClick:e,children:"×"})]}),s.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[s.jsxs("span",{children:["总计: ",K.totalConflicts]}),s.jsxs("span",{children:["已解决: ",K.resolvedConflicts]}),s.jsxs("span",{children:["待处理: ",K.pendingConflicts]}),s.jsxs("span",{children:["高优先级: ",V.length]}),N&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:`w-2 h-2 rounded-full ${N.isSyncing?"bg-yellow-500 animate-pulse":N.networkStatus?.online?"bg-green-500":"bg-red-500"}`}),s.jsx("span",{children:N.isSyncing?"同步中...":N.networkStatus?.online?"在线":"离线"})]}),N.pendingOperations>0&&s.jsxs("span",{children:["待同步: ",N.pendingOperations]})]})]}),s.jsx(fd,{showDetails:!0,compact:!1,className:"mb-4"}),S&&s.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-red-600",children:S}),s.jsx(H,{variant:"ghost",size:"sm",onClick:()=>window.location.reload(),children:"重试"})]})})]}),s.jsxs(ue,{className:"flex-1 flex flex-col space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"relative flex-1",children:[s.jsx(ut,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx("input",{type:"text",placeholder:"搜索冲突...",value:f,onChange:T=>p(T.target.value),className:"w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(H,{variant:E==="all"?"default":"outline",size:"sm",onClick:()=>v("all"),children:"全部"}),s.jsx(H,{variant:E==="pending"?"default":"outline",size:"sm",onClick:()=>v("pending"),children:"待解决"}),s.jsx(H,{variant:E==="high"?"default":"outline",size:"sm",onClick:()=>v("high"),children:"高优先级"}),s.jsx(H,{variant:E==="resolved"?"default":"outline",size:"sm",onClick:()=>v("resolved"),children:"已解决"})]}),s.jsxs(H,{variant:"outline",size:"sm",onClick:y,disabled:g,children:[s.jsx(ze,{className:`h-4 w-4 mr-2 ${g?"animate-spin":""}`}),"刷新"]})]}),C.size>0&&s.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{className:"text-sm font-medium",children:["已选择 ",C.size," 个冲突"]}),s.jsx(H,{variant:"ghost",size:"sm",onClick:z,children:C.size===re.length?"取消全选":"全选"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(H,{variant:"outline",size:"sm",onClick:()=>Y("keep_local"),disabled:h,children:"批量保留本地"}),s.jsx(H,{variant:"outline",size:"sm",onClick:()=>Y("keep_remote"),disabled:h,children:"批量保留远程"})]})]}),s.jsx(Ge,{className:"flex-1",children:s.jsx("div",{className:"space-y-3",children:g?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(ze,{className:"h-8 w-8 animate-spin mx-auto mb-4 text-muted-foreground"}),s.jsx("p",{className:"text-muted-foreground",children:"加载冲突信息..."})]}):re.length===0?s.jsx("div",{className:"text-center py-8 text-muted-foreground",children:f?"没有找到匹配的冲突":"暂无冲突"}):re.map(T=>s.jsx(pd,{conflict:T,isExpanded:x.has(T.id),isSelected:C.has(T.id),onToggleExpand:()=>te(T.id),onToggleSelect:()=>ne(T.id),onSelect:()=>n(T.id),onViewDetail:()=>ge(T.id),onResolve:W=>m(T.id,W),onIgnore:()=>u(T.id),getSeverityColor:_,getStatusIcon:A,isResolving:h},T.id))})})]})]})}):null}function pd({conflict:a,isExpanded:e,isSelected:t,onToggleExpand:r,onToggleSelect:n,onSelect:o,onViewDetail:i,onResolve:l,onIgnore:m,getSeverityColor:u,getStatusIcon:d,isResolving:y}){return s.jsx(de,{className:I("transition-all duration-200 cursor-pointer hover:shadow-md",u(a.severity),t&&"ring-2 ring-blue-500"),onClick:o,children:s.jsx(ue,{className:"p-4",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[s.jsx("input",{type:"checkbox",checked:t,onChange:n,onClick:h=>h.stopPropagation(),className:"mt-1"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[d(a.status),s.jsx(ee,{variant:"outline",className:"text-xs",children:a.severity}),s.jsx(ee,{variant:"secondary",className:"text-xs",children:yd(a.type)}),s.jsx("span",{className:"text-xs text-muted-foreground",children:ca(a.timestamp)})]}),s.jsx("h4",{className:"font-medium mb-1",children:xd(a)}),s.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:wd(a)}),e&&s.jsxs("div",{className:"mt-3 pt-3 border-t space-y-2",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"font-medium",children:"来源设备:"}),s.jsx("span",{className:"ml-2",children:a.sourceDevice})]}),s.jsxs("div",{children:[s.jsx("span",{className:"font-medium",children:"冲突时间:"}),s.jsx("span",{className:"ml-2",children:ca(a.timestamp)})]})]}),s.jsxs("div",{className:"flex gap-2 pt-2",children:[s.jsx(H,{variant:"default",size:"sm",onClick:h=>{h.stopPropagation(),i()},children:"查看详情"}),s.jsx(H,{variant:"outline",size:"sm",onClick:h=>{h.stopPropagation(),l({type:"keep_local",reason:"保留本地版本"})},disabled:y,children:"保留本地"}),s.jsx(H,{variant:"outline",size:"sm",onClick:h=>{h.stopPropagation(),l({type:"keep_remote",reason:"保留远程版本"})},disabled:y,children:"保留远程"}),s.jsx(H,{variant:"ghost",size:"sm",onClick:h=>{h.stopPropagation(),m()},children:"忽略"})]})]})]})]}),s.jsx(H,{variant:"ghost",size:"sm",onClick:h=>{h.stopPropagation(),r()},className:"ml-2",children:e?s.jsx(Ms,{className:"h-4 w-4"}):s.jsx(Qt,{className:"h-4 w-4"})})]})})})}function yd(a){return{card_content:"卡片内容",card_style:"卡片样式",card_tags:"卡片标签",card_folder:"卡片文件夹",folder_name:"文件夹名称",folder_structure:"文件夹结构",tag_rename:"标签重命名",tag_delete:"标签删除",tag_color:"标签颜色"}[a]||a}function xd(a){switch(a.entityType){case"card":return a.localVersion.content.frontContent.title;case"folder":return a.localVersion.name;case"tag":return a.localVersion.name;default:return"未知冲突"}}function wd(a){switch(a.type){case"card_content":return"卡片内容在多设备上被同时编辑";case"folder_name":return"文件夹名称与远程版本不一致";case"tag_rename":return"标签重命名冲突";default:return"数据版本不一致"}}function ca(a){const t=new Date().getTime()-a.getTime(),r=Math.floor(t/6e4);return r<1?"刚刚":r<60?`${r}分钟前`:r<1440?`${Math.floor(r/60)}小时前`:`${Math.floor(r/1440)}天前`}const bd=Kn,hn=c.forwardRef(({className:a,...e},t)=>s.jsx(or,{ref:t,className:I("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",a),...e}));hn.displayName=or.displayName;const kt=c.forwardRef(({className:a,...e},t)=>s.jsx(ir,{ref:t,className:I("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",a),...e}));kt.displayName=ir.displayName;const Et=c.forwardRef(({className:a,...e},t)=>s.jsx(lr,{ref:t,className:I("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",a),...e}));Et.displayName=lr.displayName;const pn=c.forwardRef(({className:a,...e},t)=>s.jsx("textarea",{className:I("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",a),ref:t,...e}));pn.displayName="Textarea";function vd({conflictId:a,onClose:e,className:t}){const{getConflictById:r,resolveConflict:n,ignoreConflict:o,getSuggestions:i,isResolving:l}=rs(),[m,u]=c.useState("compare"),[d,y]=c.useState("local"),[h,g]=c.useState({}),[S,N]=c.useState(!0),E=r(a),v=i(a);if(!E)return s.jsx(de,{className:I("w-full max-w-6xl max-h-[90vh]",t),children:s.jsxs(ue,{className:"p-8 text-center",children:[s.jsx(Tt,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"冲突不存在"}),s.jsx("p",{className:"text-muted-foreground mb-4",children:"指定的冲突ID未找到或已被解决"}),s.jsx(H,{onClick:e,children:"关闭"})]})});const f=async()=>{let w;switch(d){case"local":w={type:"keep_local",reason:"用户选择保留本地版本"};break;case"remote":w={type:"keep_remote",reason:"用户选择保留远程版本"};break;case"merge":w={type:"merge",reason:"用户选择智能合并",mergedData:p()};break;case"manual":w={type:"manual",reason:"用户手动编辑",mergedData:h,manualChanges:Object.entries(h).map(([D,P])=>({field:D,value:P,source:"custom"}))};break}await n(a,w)&&e()},p=()=>E.entityType==="card"?{content:{frontContent:x(E.localVersion.content.frontContent,E.remoteVersion.content.frontContent),backContent:x(E.localVersion.content.backContent,E.remoteVersion.content.backContent)},style:E.localVersion.style}:E.localVersion,x=(w,j)=>({title:w.title.length>j.title.length?w.title:j.title,text:`${w.text}

${j.text}`,tags:[...new Set([...w.tags,...j.tags])],lastModified:new Date}),C=E.type==="card_content"?[{field:"title",label:"标题",local:E.localVersion.content.frontContent.title,remote:E.remoteVersion.content.frontContent.title},{field:"frontText",label:"正面内容",local:E.localVersion.content.frontContent.text,remote:E.remoteVersion.content.frontContent.text},{field:"backText",label:"背面内容",local:E.localVersion.content.backContent.text,remote:E.remoteVersion.content.backContent.text},{field:"tags",label:"标签",local:E.localVersion.content.frontContent.tags,remote:E.remoteVersion.content.frontContent.tags}]:[];return s.jsxs(de,{className:I("w-full max-w-6xl max-h-[90vh] flex flex-col",t),children:[s.jsxs(_e,{className:"pb-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(De,{className:I("h-5 w-5",Nd(E.severity))}),s.jsxs("div",{children:[s.jsx(Me,{className:"text-xl",children:Cd(E)}),s.jsx("p",{className:"text-sm text-muted-foreground",children:jd(E)})]})]}),s.jsx(H,{variant:"ghost",size:"sm",onClick:e,children:"×"})]}),s.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[s.jsxs("span",{children:["类型: ",Sd(E.type)]}),s.jsxs("span",{children:["优先级: ",E.severity]}),s.jsxs("span",{children:["来源: ",E.sourceDevice]}),s.jsxs("span",{children:["时间: ",nt(E.timestamp)]}),s.jsx(ee,{variant:"outline",children:E.status==="pending"?"待解决":E.status==="resolved"?"已解决":"已忽略"})]})]}),s.jsxs(ue,{className:"flex-1 flex flex-col",children:[s.jsxs(bd,{value:m,onValueChange:u,className:"flex-1 flex flex-col",children:[s.jsxs(hn,{className:"grid w-full grid-cols-4",children:[s.jsx(kt,{value:"compare",children:"对比视图"}),s.jsx(kt,{value:"suggestions",children:"智能建议"}),s.jsx(kt,{value:"history",children:"历史记录"}),s.jsx(kt,{value:"manual",children:"手动合并"})]}),s.jsxs("div",{className:"flex-1 mt-4",children:[s.jsx(Et,{value:"compare",className:"h-full",children:s.jsxs("div",{className:"grid grid-cols-2 gap-4 h-full",children:[s.jsxs(de,{className:"border-green-200",children:[s.jsxs(_e,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(Me,{className:"text-base flex items-center gap-2",children:[s.jsx(ho,{className:"h-4 w-4 text-green-600"}),"本地版本"]}),s.jsx(ee,{variant:"outline",className:"text-green-600 border-green-200",children:"本地设备"})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["更新时间: ",nt(E.localVersion.updatedAt)]})]}),s.jsx(ue,{className:"p-4",children:s.jsx(Ge,{className:"h-96",children:da(E,"local")})})]}),s.jsxs(de,{className:"border-blue-200",children:[s.jsxs(_e,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(Me,{className:"text-base flex items-center gap-2",children:[s.jsx(po,{className:"h-4 w-4 text-blue-600"}),"远程版本"]}),s.jsx(ee,{variant:"outline",className:"text-blue-600 border-blue-200",children:E.sourceDevice})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["更新时间: ",nt(E.remoteVersion.updatedAt)]})]}),s.jsx(ue,{className:"p-4",children:s.jsx(Ge,{className:"h-96",children:da(E,"remote")})})]})]})}),s.jsx(Et,{value:"suggestions",className:"h-full",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(yo,{className:"h-5 w-5 text-blue-500"}),s.jsx("h3",{className:"text-lg font-semibold",children:"智能解决建议"})]}),v.length>0?s.jsx("div",{className:"grid gap-3",children:v.map((w,j)=>s.jsx(de,{className:"cursor-pointer hover:shadow-md transition-shadow",children:s.jsx(ue,{className:"p-4",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(ee,{variant:w.type==="merge"?"default":"secondary",children:kd(w.type)}),s.jsxs(ee,{variant:"outline",children:["置信度: ",Math.round(w.confidence*100),"%"]})]}),s.jsx("p",{className:"text-sm mb-2",children:w.reason}),w.preview&&s.jsxs("div",{className:"text-xs text-muted-foreground bg-gray-50 p-2 rounded",children:["预览: ",JSON.stringify(w.preview)]})]}),s.jsx(H,{variant:"outline",size:"sm",onClick:()=>y(w.type),children:"应用建议"})]})})},j))}):s.jsx(de,{children:s.jsxs(ue,{className:"p-8 text-center",children:[s.jsx(Tt,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-muted-foreground",children:"暂无智能建议，请手动选择解决方案"})]})})]})}),s.jsx(Et,{value:"history",className:"h-full",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(At,{className:"h-5 w-5 text-blue-500"}),s.jsx("h3",{className:"text-lg font-semibold",children:"冲突历史"})]}),s.jsx(de,{children:s.jsx(ue,{className:"p-4",children:s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:"冲突检测"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:nt(E.timestamp)})]}),s.jsx(ee,{variant:"destructive",children:"冲突"})]}),s.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:"本地版本更新"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:nt(E.localVersion.updatedAt)})]}),s.jsx(ee,{variant:"outline",children:"本地"})]}),s.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:"远程版本更新"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:nt(E.remoteVersion.updatedAt)})]}),s.jsx(ee,{variant:"outline",children:"远程"})]})]})})})]})}),s.jsx(Et,{value:"manual",className:"h-full",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Ks,{className:"h-5 w-5 text-blue-500"}),s.jsx("h3",{className:"text-lg font-semibold",children:"手动合并"}),s.jsxs(H,{variant:"outline",size:"sm",onClick:()=>N(!S),children:[S?s.jsx(xo,{className:"h-4 w-4 mr-1"}):s.jsx(Ks,{className:"h-4 w-4 mr-1"}),S?"隐藏差异":"显示差异"]})]}),s.jsx(Ge,{className:"h-96",children:s.jsx("div",{className:"space-y-4",children:C.map(w=>s.jsxs(de,{children:[s.jsx(_e,{className:"pb-3",children:s.jsx(Me,{className:"text-base",children:w.label})}),s.jsxs(ue,{className:"space-y-3",children:[S&&s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsxs("div",{className:"p-2 bg-green-50 rounded text-sm",children:[s.jsx("p",{className:"font-medium text-green-700 mb-1",children:"本地:"}),s.jsx("p",{children:w.local})]}),s.jsxs("div",{className:"p-2 bg-blue-50 rounded text-sm",children:[s.jsx("p",{className:"font-medium text-blue-700 mb-1",children:"远程:"}),s.jsx("p",{children:w.remote})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"text-sm font-medium mb-1 block",children:"合并结果:"}),w.field==="tags"?s.jsxs("div",{className:"flex flex-wrap gap-2",children:[Array.isArray(w.local)&&w.local.map(j=>s.jsx(ee,{variant:"secondary",children:j},j)),Array.isArray(w.remote)&&w.remote.map(j=>s.jsx(ee,{variant:"outline",children:j},j))]}):s.jsx(pn,{value:h[w.field]||w.local,onChange:j=>g(D=>({...D,[w.field]:j.target.value})),className:"min-h-[100px]"})]})]})]},w.field))})})]})})]})]}),s.jsx("div",{className:"mt-6 pt-6 border-t",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"text-sm font-medium",children:"解决方案:"}),s.jsx("div",{className:"flex gap-2",children:["local","remote","merge","manual"].map(w=>s.jsx(H,{variant:d===w?"default":"outline",size:"sm",onClick:()=>y(w),children:Ed(w)},w))})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(H,{variant:"outline",onClick:e,children:"取消"}),s.jsx(H,{variant:"ghost",onClick:()=>o(a),children:"忽略冲突"}),s.jsx(H,{onClick:f,disabled:l,children:l?"解决中...":"应用解决方案"})]})]})})]})]})}function da(a,e){const t=e==="local"?a.localVersion:a.remoteVersion;return a.entityType==="card"?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"正面内容"}),s.jsxs("div",{className:"bg-gray-50 p-3 rounded",children:[s.jsx("h5",{className:"font-semibold mb-2",children:t.content.frontContent.title}),s.jsx("p",{className:"text-sm text-gray-600",children:t.content.frontContent.text}),s.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:t.content.frontContent.tags.map(r=>s.jsx(ee,{variant:"secondary",className:"text-xs",children:r},r))})]})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium mb-2",children:"背面内容"}),s.jsxs("div",{className:"bg-gray-50 p-3 rounded",children:[s.jsx("h5",{className:"font-semibold mb-2",children:t.content.backContent.title}),s.jsx("p",{className:"text-sm text-gray-600",children:t.content.backContent.text}),s.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:t.content.backContent.tags.map(r=>s.jsx(ee,{variant:"secondary",className:"text-xs",children:r},r))})]})]})]}):s.jsx("pre",{className:"text-sm",children:JSON.stringify(t,null,2)})}function Cd(a){switch(a.entityType){case"card":return a.localVersion.content.frontContent.title;case"folder":return a.localVersion.name;case"tag":return a.localVersion.name;default:return"未知冲突"}}function jd(a){switch(a.type){case"card_content":return"卡片内容在多设备上被同时编辑，需要选择保留的版本";case"folder_name":return"文件夹名称与远程版本不一致";case"tag_rename":return"标签重命名冲突";default:return"数据版本不一致，需要手动解决"}}function Sd(a){return{card_content:"卡片内容",card_style:"卡片样式",card_tags:"卡片标签",card_folder:"卡片文件夹",folder_name:"文件夹名称",folder_structure:"文件夹结构",tag_rename:"标签重命名",tag_delete:"标签删除",tag_color:"标签颜色"}[a]||a}function Nd(a){switch(a){case"critical":return"text-red-600";case"high":return"text-orange-600";case"medium":return"text-yellow-600";case"low":return"text-blue-600";default:return"text-gray-600"}}function kd(a){return{keep_local:"保留本地",keep_remote:"保留远程",merge:"智能合并",manual:"手动处理"}[a]||a}function Ed(a){return{local:"保留本地",remote:"保留远程",merge:"智能合并",manual:"手动合并"}[a]||a}function nt(a){const t=new Date().getTime()-a.getTime(),r=Math.floor(t/6e4);return r<1?"刚刚":r<60?`${r}分钟前`:r<1440?`${Math.floor(r/60)}小时前`:`${Math.floor(r/1440)}天前`}function Dd(a={}){const{enableMetricsCollection:e=!0,enableUserTracking:t=!0,enableConflictMonitoring:r=!0,reportInterval:n=3e4}=a,o=c.useRef({averageRenderTime:0,averageMemoryUsage:0,averageNetworkLatency:0,conflictResolutionTime:0,userSatisfaction:0,errorRate:0,totalOperations:0,successfulOperations:0}),i=c.useRef([]),l=c.useRef([]);c.useEffect(()=>{if(!e)return;Ce.clearMetrics();const j=setInterval(()=>{m()},n);return()=>{clearInterval(j)}},[e,n]);const m=c.useCallback(()=>{const j=Ce.getMetrics();if(j.length===0)return;const D=j.slice(-10),P=u(D);o.current={averageRenderTime:P.renderTime,averageMemoryUsage:P.memoryUsage,averageNetworkLatency:P.networkLatency,conflictResolutionTime:P.conflictResolutionTime,userSatisfaction:P.userSatisfaction,errorRate:d(D),totalOperations:D.length,successfulOperations:D.filter($=>$.errorRate<.05).length},i.current=j},[]),u=c.useCallback(j=>j.length===0?{renderTime:0,memoryUsage:0,networkLatency:0,conflictResolutionTime:0,userSatisfaction:0,errorRate:0}:{renderTime:j.reduce((D,P)=>D+P.renderTime,0)/j.length,memoryUsage:j.reduce((D,P)=>D+P.memoryUsage,0)/j.length,networkLatency:j.reduce((D,P)=>D+P.networkLatency,0)/j.length,conflictResolutionTime:j.reduce((D,P)=>D+P.conflictResolutionTime,0)/j.length,userSatisfaction:j.reduce((D,P)=>D+P.userSatisfaction,0)/j.length,errorRate:j.reduce((D,P)=>D+P.errorRate,0)/j.length},[]),d=c.useCallback(j=>j.reduce((P,$)=>P+$.errorRate,0)/j.length,[]),y=c.useCallback(()=>r?Ce.startConflictDetection():()=>{},[r]),h=c.useCallback(()=>r?Ce.startConflictResolution():()=>{},[r]),g=c.useCallback(()=>r?Ce.startBatchOperation():()=>{},[r]),S=c.useCallback((j,D,P)=>{t&&(Ce.trackUserInteraction(j,D,P),l.current.push({action:j,duration:D,success:P,timestamp:new Date}),l.current.length>100&&(l.current=l.current.slice(-100)))},[t]),N=c.useCallback((j,D)=>{t&&Ce.trackUserSatisfaction(j,D)},[t]),E=c.useCallback((j=36e5)=>Ce.generateReport(j),[]),v=c.useCallback(()=>Ce.getRealtimeMetrics(),[]),f=c.useCallback(()=>Ce.getAlerts(),[]),p=c.useCallback((j=20)=>l.current.slice(-j),[]),x=c.useCallback(()=>({...o.current}),[]),b=c.useCallback(()=>{Ce.clearMetrics(),i.current=[],l.current=[],o.current={averageRenderTime:0,averageMemoryUsage:0,averageNetworkLatency:0,conflictResolutionTime:0,userSatisfaction:0,errorRate:0,totalOperations:0,successfulOperations:0}},[]),C=c.useCallback(()=>{const j=o.current;let D=100;return j.averageRenderTime>100&&(D-=20),j.averageRenderTime>200&&(D-=30),j.averageMemoryUsage>100*1024*1024&&(D-=15),j.averageMemoryUsage>200*1024*1024&&(D-=25),j.averageNetworkLatency>1e3&&(D-=10),j.averageNetworkLatency>2e3&&(D-=20),j.errorRate>.05&&(D-=15),j.errorRate>.1&&(D-=25),j.conflictResolutionTime>5e3&&(D-=10),j.conflictResolutionTime>1e4&&(D-=20),{healthScore:Math.max(0,D),status:D>=80?"good":D>=60?"warning":"critical",issues:w(j)}},[]),w=c.useCallback(j=>{const D=[];return j.averageRenderTime>100&&D.push("渲染时间过长，可能影响用户体验"),j.averageMemoryUsage>100*1024*1024&&D.push("内存使用较高，建议检查内存泄漏"),j.averageNetworkLatency>1e3&&D.push("网络延迟较高，可能影响同步性能"),j.errorRate>.05&&D.push("错误率较高，需要关注错误处理"),j.conflictResolutionTime>5e3&&D.push("冲突解决时间过长，建议优化算法"),D},[]);return{startConflictDetection:y,startConflictResolution:h,startBatchOperation:g,trackUserInteraction:S,trackUserSatisfaction:N,getPerformanceReport:E,getRealtimeMetrics:v,getPerformanceAlerts:f,getUserActionHistory:p,getPerformanceStats:x,clearPerformanceData:b,getPerformanceHealth:C,stats:o.current,isMonitoring:e}}function Rd({className:a,showDetails:e=!0,compact:t=!1,autoRefresh:r=!0}){const[n,o]=c.useState(!1),[i,l]=c.useState("overview"),[m,u]=c.useState(0),{stats:d,getRealtimeMetrics:y,getPerformanceAlerts:h,getUserActionHistory:g,getPerformanceHealth:S,getPerformanceReport:N,isMonitoring:E}=Dd({enableMetricsCollection:!0,enableUserTracking:!0,enableConflictMonitoring:!0,reportInterval:1e4}),[v,f]=c.useState({}),[p,x]=c.useState([]),[b,C]=c.useState([]),[w,j]=c.useState(null),D=()=>{f(y()),x(h()),C(g(20)),j(S()),u(V=>V+1)};c.useEffect(()=>{if(!r||!n)return;D();const V=setInterval(D,5e3);return()=>clearInterval(V)},[r,n,m]),c.useEffect(()=>{n&&D()},[n]);const P=V=>{if(V===0)return"0 B";const re=1024,te=["B","KB","MB","GB"],ne=Math.floor(Math.log(V)/Math.log(re));return`${parseFloat((V/Math.pow(re,ne)).toFixed(2))} ${te[ne]}`},$=V=>V<1e3?`${V.toFixed(0)}ms`:V<6e4?`${(V/1e3).toFixed(1)}s`:`${(V/6e4).toFixed(1)}min`,K=V=>{switch(V){case"good":return"text-green-500";case"warning":return"text-yellow-500";case"critical":return"text-red-500";default:return"text-gray-500"}},se=V=>{switch(V){case"good":return s.jsx(gt,{className:"h-4 w-4 text-green-500"});case"warning":return s.jsx(De,{className:"h-4 w-4 text-yellow-500"});case"critical":return s.jsx(Tt,{className:"h-4 w-4 text-red-500"});default:return s.jsx(Ys,{className:"h-4 w-4 text-gray-500"})}};return t?s.jsxs("div",{className:I("flex items-center gap-2",a),children:[s.jsxs("div",{className:I("flex items-center gap-1",K(w?.status||"unknown")),children:[se(w?.status||"unknown"),s.jsxs("span",{className:"text-sm font-medium",children:[w?.healthScore||0,"/100"]})]}),p.length>0&&s.jsx(ee,{variant:"destructive",className:"text-xs",children:p.length}),s.jsx(H,{variant:"ghost",size:"sm",onClick:()=>o(!n),children:s.jsx(wo,{className:"h-4 w-4"})})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:I("flex items-center gap-2 cursor-pointer",a),onClick:()=>o(!n),children:[s.jsxs("div",{className:I("flex items-center gap-1",K(w?.status||"unknown")),children:[se(w?.status||"unknown"),s.jsxs("span",{className:"text-sm font-medium",children:["性能: ",w?.healthScore||0,"/100"]})]}),p.length>0&&s.jsxs(ee,{variant:"destructive",className:"text-xs",children:[p.length," 警报"]}),s.jsx(H,{variant:"ghost",size:"sm",children:n?"隐藏":"显示"})]}),n&&s.jsxs(de,{className:"w-full max-w-4xl max-h-[80vh]",children:[s.jsxs(_e,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(Me,{className:"text-lg flex items-center gap-2",children:[s.jsx(Ys,{className:"h-5 w-5"}),"性能监控",s.jsx(ee,{variant:E?"default":"secondary",children:E?"监控中":"已停止"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(H,{variant:"outline",size:"sm",onClick:D,children:[s.jsx(ze,{className:"h-4 w-4 mr-2"}),"刷新"]}),s.jsxs(H,{variant:"outline",size:"sm",onClick:()=>{const V=N();console.log("Performance Report:",V)},children:[s.jsx(mt,{className:"h-4 w-4 mr-2"}),"报告"]}),s.jsx(H,{variant:"ghost",size:"sm",onClick:()=>o(!1),children:"×"})]})]}),w&&s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"健康状态:"}),s.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[se(w.status),s.jsxs("span",{className:I("font-medium",K(w.status)),children:[w.healthScore,"/100 (",w.status,")"]})]})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"渲染时间:"}),s.jsx("span",{className:"ml-2 font-medium",children:$(v.renderTime||0)})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"内存使用:"}),s.jsx("span",{className:"ml-2 font-medium",children:P(v.memoryUsage||0)})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"网络延迟:"}),s.jsxs("span",{className:"ml-2 font-medium",children:[v.networkLatency||0,"ms"]})]})]})]}),s.jsxs(ue,{children:[s.jsx("div",{className:"flex gap-2 mb-4",children:["overview","metrics","alerts","actions"].map(V=>s.jsxs(H,{variant:i===V?"default":"outline",size:"sm",onClick:()=>l(V),children:[V==="overview"&&"概览",V==="metrics"&&"指标",V==="alerts"&&"警报",V==="actions"&&"用户行为"]},V))}),s.jsxs(Ge,{className:"h-96",children:[i==="overview"&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsx(de,{children:s.jsxs(ue,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(fr,{className:"h-4 w-4 text-yellow-500"}),s.jsx("span",{className:"font-medium",children:"渲染性能"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"平均渲染时间:"}),s.jsx("span",{children:$(d.averageRenderTime)})]}),s.jsx(We,{value:Math.min(100,d.averageRenderTime/100*100),className:"h-2"})]})]})}),s.jsx(de,{children:s.jsxs(ue,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(hr,{className:"h-4 w-4 text-blue-500"}),s.jsx("span",{className:"font-medium",children:"内存使用"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"内存使用:"}),s.jsx("span",{children:P(d.averageMemoryUsage)})]}),s.jsx(We,{value:Math.min(100,d.averageMemoryUsage/(100*1024*1024)*100),className:"h-2"})]})]})}),s.jsx(de,{children:s.jsxs(ue,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(Fs,{className:"h-4 w-4 text-green-500"}),s.jsx("span",{className:"font-medium",children:"网络性能"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"平均延迟:"}),s.jsxs("span",{children:[d.averageNetworkLatency,"ms"]})]}),s.jsx(We,{value:Math.min(100,d.averageNetworkLatency/1e3*100),className:"h-2"})]})]})}),s.jsx(de,{children:s.jsxs(ue,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(bo,{className:"h-4 w-4 text-purple-500"}),s.jsx("span",{className:"font-medium",children:"用户体验"})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"满意度:"}),s.jsxs("span",{children:[d.userSatisfaction.toFixed(1),"%"]})]}),s.jsx(We,{value:d.userSatisfaction,className:"h-2"})]})]})})]}),w?.issues&&w.issues.length>0&&s.jsx(de,{children:s.jsxs(ue,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(De,{className:"h-4 w-4 text-orange-500"}),s.jsx("span",{className:"font-medium",children:"性能问题"})]}),s.jsx("div",{className:"space-y-1 text-sm",children:w.issues.map((V,re)=>s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx("div",{className:"w-1 h-1 bg-orange-500 rounded-full mt-2 flex-shrink-0"}),s.jsx("span",{children:V})]},re))})]})})]}),i==="metrics"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("h4",{className:"font-medium",children:"实时性能指标"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"渲染时间:"}),s.jsx("span",{children:$(v.renderTime||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"首次绘制:"}),s.jsx("span",{children:$(v.firstPaint||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"内容绘制:"}),s.jsx("span",{children:$(v.firstContentfulPaint||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"最大内容绘制:"}),s.jsx("span",{children:$(v.largestContentfulPaint||0)})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"内存使用:"}),s.jsx("span",{children:P(v.memoryUsage||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"网络延迟:"}),s.jsxs("span",{children:[v.networkLatency||0,"ms"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"冲突检测时间:"}),s.jsx("span",{children:$(v.conflictDetectionTime||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"冲突解决时间:"}),s.jsx("span",{children:$(v.conflictResolutionTime||0)})]})]})]})]}),i==="alerts"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("h4",{className:"font-medium",children:"性能警报"}),p.length===0?s.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"暂无性能警报"}):s.jsx("div",{className:"space-y-2",children:p.map((V,re)=>s.jsx(de,{className:"border-l-4 border-l-red-500",children:s.jsxs(ue,{className:"p-3",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(De,{className:"h-4 w-4 text-red-500"}),s.jsx("span",{className:"font-medium text-sm",children:V.type}),s.jsx(ee,{variant:"outline",className:"text-xs",children:V.severity})]}),s.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(V.timestamp).toLocaleTimeString()})]}),s.jsx("p",{className:"text-sm mb-2",children:V.message}),V.suggestions&&V.suggestions.length>0&&s.jsxs("div",{className:"space-y-1",children:[s.jsx("span",{className:"text-xs font-medium",children:"建议:"}),V.suggestions.map((te,ne)=>s.jsxs("div",{className:"text-xs text-muted-foreground",children:["• ",te]},ne))]})]})},re))})]}),i==="actions"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("h4",{className:"font-medium",children:"用户行为历史"}),b.length===0?s.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"暂无用户行为记录"}):s.jsx("div",{className:"space-y-2",children:b.map((V,re)=>s.jsx(de,{children:s.jsx(ue,{className:"p-3",children:s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-medium text-sm",children:V.action}),s.jsx(ee,{variant:V.success?"default":"destructive",className:"text-xs",children:V.success?"成功":"失败"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[s.jsx(At,{className:"h-3 w-3"}),s.jsx("span",{children:new Date(V.timestamp).toLocaleTimeString()}),s.jsxs("span",{children:["(",$(V.duration),")"]})]})]})})},re))})]})]})]})]})]})}const Ts={enableCloudSync:!1,enableAuth:!1};function Td({className:a}){const[e,t]=c.useState({user:null,session:null,loading:!1,error:null}),{openModal:r}=Cr(),{cards:n,filter:o,setFilter:i,viewSettings:l,setViewSettings:m,dispatch:u,flipCard:d,getAllTags:y,updateTagsInAllCards:h,getCardsWithTag:g}=ti(),{folderTree:S,selectedFolderId:N,setSelectedFolderId:E,dispatch:v,getFolderById:f,folders:p}=wr(),{tags:x,popularTags:b,renameTag:C,deleteTagByName:w,getAllTagNames:j}=br(),{toast:D}=Oc(),[P,$]=c.useState(!1),[K,se]=c.useState(!1),[V,re]=c.useState({gap:16,showLayoutControls:!1}),{stats:te,selectedConflict:ne,setSelectedConflict:ge}=rs(),[z,Y]=c.useState(!1),[_,A]=c.useState(!1);c.useEffect(()=>Rt.onAuthStateChange(t),[]);const[T,W]=c.useState(!1),[J,B]=c.useState(!1),[q,M]=c.useState(null),[R,k]=c.useState(null),[O,Q]=c.useState(),[ie,me]=c.useState(!1),[he,pe]=c.useState(!1),[Ct,qe]=c.useState(""),[Ne,st]=c.useState(null),{isDownloading:Je,showPreview:Pt,previewData:Re,captureScreenshot:ns,confirmDownload:os,cancelPreview:xe}=Dc({onSuccess:F=>{D({title:"Screenshot saved!",description:`${F}.png has been downloaded successfully.`})},onError:F=>{D({title:"Screenshot failed",description:F.message,variant:"destructive"})}}),Be=F=>{d?d(F):u({type:"FLIP_CARD",payload:F})},is=(F,G)=>{u({type:"UPDATE_CARD",payload:{id:F,updates:G}})},ls=async F=>{const G=n.find(ae=>ae.id===F);if(G){const ae=G.isFlipped?G.backContent:G.frontContent,fe=rl(ae.title,ae.text);await nl(fe)?console.log("Card content copied to clipboard"):console.error("Failed to copy card content")}},at=async F=>{const G=n.find(Pe=>Pe.id===F);if(!G)return;const ae=document.querySelector(`[data-card-id="${F}"]`);if(!ae){D({title:"Screenshot failed",description:"Could not find card element. Please try again.",variant:"destructive"});return}const ve=(G.isFlipped?G.backContent:G.frontContent).title||"Untitled Card";await ns(ae,ve)},cs=F=>{console.log("Share card:",F)},Lt=F=>{u({type:"DELETE_CARD",payload:F})},jt=(F,G)=>{const ae=n.find(Pe=>Pe.id===F);if(!ae)return;const fe=ae.folderId;if(u({type:"UPDATE_CARD",payload:{id:F,updates:{folderId:G||void 0}}}),fe){const Pe=f(fe);Pe&&v({type:"UPDATE_FOLDER",payload:{id:fe,updates:{cardIds:Pe.cardIds.filter(yn=>yn!==F)}}})}if(G){const Pe=f(G);Pe&&v({type:"UPDATE_FOLDER",payload:{id:G,updates:{cardIds:[...Pe.cardIds,F]}}})}const ve=G?f(G)?.name:"Root";D({title:"Card moved",description:`Card has been moved to "${ve}".`})},Te=()=>{u({type:"CREATE_CARD",payload:{frontContent:{title:"New Card",text:"Click to edit this card...",images:[],tags:[],lastModified:new Date},backContent:{title:"Back Side",text:"Add additional content here...",images:[],tags:[],lastModified:new Date},style:{type:"solid",backgroundColor:"#ffffff",fontFamily:"system-ui",fontSize:"base",fontWeight:"normal",textColor:"#1f2937",borderRadius:"xl",shadow:"md",borderWidth:0},isFlipped:!1,folderId:N||void 0}})},St=()=>{Q(void 0),M(null),W(!0)},Oe=F=>{Q(F),M(null),W(!0)},$t=F=>{const G=f(F);G&&(M({id:F,name:G.name,color:G.color,icon:G.icon||"Folder"}),Q(void 0),W(!0))},zt=F=>{const G=f(F);if(G){const ae=p.filter(fe=>fe.parentId===F);k({id:F,name:G.name,cardCount:G.cardIds.length,hasSubfolders:ae.length>0,subfolderCount:ae.length}),B(!0)}},Bt=F=>{q?(v({type:"UPDATE_FOLDER",payload:{id:q.id,updates:{name:F.name,color:F.color,icon:F.icon}}}),D({title:"Folder updated",description:`"${F.name}" has been updated successfully.`})):(v({type:"CREATE_FOLDER",payload:{name:F.name,color:F.color,icon:F.icon,cardIds:[],parentId:F.parentId,isExpanded:!0}}),D({title:"Folder created",description:`"${F.name}" has been created successfully.`}))},Ut=()=>{R&&(v({type:"DELETE_FOLDER",payload:R.id,onDeleteCards:F=>{F.forEach(G=>{u({type:"DELETE_CARD",payload:G})})}}),D({title:"Folder deleted",description:`"${R.name}" and ${R.cardCount} cards have been deleted.`}),N===R.id&&Ue(null))},ds=F=>{const G=o.tags.includes(F);i({...o,tags:G?o.tags.filter(ae=>ae!==F):[...o.tags,F]})},Ue=F=>{E(F),i({...o,folderId:F||void 0})},Ae=F=>{qe(F),me(!0)},us=F=>{const G=g(F);st({name:F,cardCount:G.length}),pe(!0)},Z=(F,G)=>{C(F,G)?(h(F,G),D({title:"Tag renamed",description:`"${F}" has been renamed to "${G}".`}),me(!1),qe("")):D({title:"Rename failed",description:"A tag with this name already exists.",variant:"destructive"})},oe=()=>{Ne&&w(Ne.name)&&(h(Ne.name),o.tags.includes(Ne.name)&&i({...o,tags:o.tags.filter(G=>G!==Ne.name)}),D({title:"Tag deleted",description:`"${Ne.name}" has been removed from ${Ne.cardCount} cards.`}),pe(!1),st(null))},le=(F,G=0)=>F.map(ae=>s.jsxs("div",{style:{marginLeft:G*16},children:[s.jsx(la,{folderId:ae.id,folderName:ae.name,onRename:$t,onDelete:zt,onCreateSubfolder:Oe,children:s.jsxs(H,{variant:N===ae.id?"secondary":"ghost",className:"w-full justify-start text-sm mb-1",onClick:()=>Ue(ae.id),children:[s.jsx(He,{className:"h-4 w-4 mr-2",style:{color:ae.color}}),ae.name,s.jsx(ee,{variant:"secondary",className:"ml-auto",children:ae.cardIds.length})]})}),ae.children&&ae.children.length>0&&ae.isExpanded&&s.jsx("div",{className:"ml-4",children:le(ae.children,G+1)})]},ae.id)),we=F=>F.map(G=>s.jsxs("div",{children:[s.jsx(la,{folderId:G.id,folderName:G.name,onRename:$t,onDelete:zt,onCreateSubfolder:Oe,children:s.jsx(H,{variant:N===G.id?"secondary":"ghost",className:"w-full h-10 p-0 mb-1",onClick:()=>Ue(G.id),title:G.name,children:s.jsx(He,{className:"h-4 w-4",style:{color:G.color}})})}),G.children&&G.children.length>0&&G.isExpanded&&s.jsx("div",{children:we(G.children)})]},G.id));return s.jsx(Ji,{children:s.jsxs("div",{className:I("min-h-screen bg-background",a),children:[s.jsx("header",{className:"sticky top-0 z-40 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:s.jsxs("div",{className:"container flex h-16 items-center justify-between px-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"h-8 w-8 rounded-lg bg-gradient-to-br from-violet-500 to-pink-500 flex items-center justify-center",children:s.jsx("span",{className:"text-white font-bold text-sm",children:"CA"})}),s.jsxs("h1",{className:"text-xl font-bold",children:[s.jsx("span",{className:"text-violet-600",children:"Card"}),s.jsx("span",{className:"text-pink-500",children:"All"})]})]}),s.jsx("div",{className:"absolute left-1/2 transform -translate-x-1/2 hidden md:block",children:s.jsxs("div",{className:"relative",children:[s.jsx(ut,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(et,{placeholder:"Search cards...",value:o.searchTerm,onChange:F=>i({...o,searchTerm:F.target.value}),className:"pl-10 rounded-full w-80"})]})}),s.jsx("div",{className:"md:hidden absolute left-1/2 transform -translate-x-1/2",children:s.jsxs("div",{className:"relative",children:[s.jsx(ut,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(et,{placeholder:"Search...",value:o.searchTerm,onChange:F=>i({...o,searchTerm:F.target.value}),className:"pl-10 rounded-full w-60"})]})}),s.jsxs("div",{className:"flex items-center gap-2",children:[te.pendingConflicts>0&&s.jsxs(H,{variant:"ghost",size:"sm",onClick:()=>Y(!0),className:"relative text-orange-600 hover:bg-orange-50",children:[s.jsx(De,{className:"h-4 w-4"}),te.pendingConflicts>0&&s.jsx(ee,{variant:"destructive",className:"absolute -top-2 -right-2 h-5 w-5 flex items-center justify-center p-0 text-xs",children:te.pendingConflicts>99?"99+":te.pendingConflicts}),s.jsx("span",{className:"sr-only",children:"Conflict Notifications"})]}),Ts.enableCloudSync,s.jsx(Rd,{compact:!0,autoRefresh:!0}),s.jsxs(sl,{children:[s.jsx(al,{asChild:!0,children:s.jsx(H,{variant:"ghost",size:"sm",children:s.jsx(vo,{className:"h-4 w-4"})})}),s.jsx(Ar,{className:"w-80",align:"end",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx("h4",{className:"font-medium",children:"Layout Settings"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Customize the masonry layout appearance"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs(Qe,{children:["Gap Size: ",V.gap,"px"]}),s.jsx(Tr,{value:[V.gap],onValueChange:([F])=>re(G=>({...G,gap:F})),max:32,min:8,step:4,className:"w-full"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(Qe,{children:"Card Size"}),s.jsx("div",{className:"flex gap-2",children:["small","medium","large"].map(F=>s.jsx(H,{variant:l.cardSize===F?"default":"outline",size:"sm",onClick:()=>m(G=>({...G,cardSize:F})),children:F.charAt(0).toUpperCase()+F.slice(1)},F))})]})]})})]}),s.jsxs(H,{onClick:Te,variant:"ghost",size:"sm",className:"text-black font-bold hover:bg-gray-100 rounded-full w-10 h-10 p-0 flex items-center justify-center",children:[s.jsx(Ht,{className:"h-6 w-6"}),s.jsx("span",{className:"sr-only",children:"Add Card"})]}),Ts.enableAuth]})]})}),s.jsxs("main",{className:"flex h-[calc(100vh-4rem)]",children:[s.jsx("div",{className:"absolute top-16 left-0 right-0 z-30 bg-background border-b",children:s.jsx(dd,{onOpenConflictPanel:()=>Y(!0)})}),s.jsxs("aside",{className:I("border-r transition-all duration-300 ease-in-out flex flex-col",K?"w-16":"w-72"),children:[s.jsx("div",{className:"p-3 flex items-center justify-end",children:s.jsx(H,{variant:"ghost",size:"sm",onClick:()=>se(!K),className:"h-8 w-8 p-0",children:K?s.jsx(Qt,{className:"h-4 w-4"}):s.jsx(Co,{className:"h-4 w-4"})})}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsxs("div",{className:"p-3 space-y-4",children:[!K&&s.jsxs("div",{children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs(H,{className:"w-full justify-start",onClick:Te,children:[s.jsx(Ht,{className:"h-4 w-4 mr-2"}),"New Card"]}),s.jsxs(H,{variant:"outline",className:"w-full justify-start",onClick:St,children:[s.jsx(Ss,{className:"h-4 w-4 mr-2"}),"New Folder"]})]}),s.jsx(ct,{className:"my-4"})]}),K&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(H,{variant:"ghost",size:"sm",className:"w-full h-10 p-0",onClick:Te,title:"New Card",children:s.jsx(Ht,{className:"h-4 w-4"})}),s.jsx(H,{variant:"ghost",size:"sm",className:"w-full h-10 p-0",onClick:St,title:"New Folder",children:s.jsx(Ss,{className:"h-4 w-4"})}),s.jsx(ct,{className:"my-4"})]}),s.jsxs("div",{children:[!K&&s.jsx("h3",{className:"text-sm font-medium mb-3",children:"Folders"}),s.jsxs("div",{className:"space-y-1",children:[s.jsxs(H,{variant:N?"ghost":"secondary",className:I("w-full text-sm",K?"h-10 p-0":"justify-start"),onClick:()=>Ue(null),title:K?"All Cards":void 0,children:[s.jsx(He,{className:"h-4 w-4"}),!K&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"ml-2",children:"All Cards"}),s.jsx(ee,{variant:"secondary",className:"ml-auto",children:n.length})]})]}),K?we(S):le(S)]})]}),s.jsx(ct,{}),s.jsxs("div",{children:[!K&&s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-medium",children:"Tags"}),o.tags.length>0&&s.jsx(H,{variant:"ghost",size:"sm",onClick:()=>i({...o,tags:[]}),className:"h-6 px-2 text-xs",children:"Clear"})]}),s.jsx("div",{className:"space-y-1",children:b(K?5:10).map(F=>s.jsx(ed,{tagName:F.name,onRename:Ae,onDelete:us,disabled:K,children:s.jsxs(H,{variant:o.tags.includes(F.name)?"secondary":"ghost",className:I("w-full text-sm",K?"h-10 p-0":"justify-start"),onClick:()=>ds(F.name),title:K?`${F.name} (Right-click to expand sidebar for tag management)`:F.name,children:[s.jsx(mr,{className:"h-3 w-3",style:{color:F.color}}),!K&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"ml-2",children:F.name}),s.jsx(ee,{variant:"secondary",className:"ml-auto",children:F.count})]})]})},F.id))})]}),!K&&(o.tags.length>0||o.searchTerm)&&s.jsxs(s.Fragment,{children:[s.jsx(ct,{}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-sm font-medium mb-3",children:"Active Filters"}),s.jsxs("div",{className:"space-y-2",children:[o.searchTerm&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ut,{className:"h-3 w-3"}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:['"',o.searchTerm,'"']})]}),o.tags.map(F=>s.jsx(ee,{variant:"secondary",className:"mr-1",children:F},F))]})]})]})]})})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx("div",{className:"p-4",children:s.jsx(el,{cards:n,onCardFlip:Be,onCardUpdate:is,onCardCopy:ls,onCardScreenshot:at,onCardShare:cs,onCardDelete:Lt,onMoveToFolder:jt,cardSize:l.cardSize==="small"?"sm":l.cardSize==="large"?"lg":"md",enableVirtualization:n.length>20,gap:V.gap,overscan:3})})})]}),s.jsx(Rc,{isOpen:Pt,onClose:xe,onConfirm:os,previewUrl:Re?.previewUrl||null,fileName:Re?.fileName||"",isDownloading:Je}),s.jsx(Jc,{isOpen:T,onClose:()=>{W(!1),M(null),Q(void 0)},onConfirm:Bt,parentId:O,initialData:c.useMemo(()=>q?{name:q.name,color:q.color,icon:q.icon}:void 0,[q]),mode:q?"edit":"create"}),s.jsx(Zc,{isOpen:J,onClose:()=>{B(!1),k(null)},onConfirm:Ut,folderName:R?.name||"",cardCount:R?.cardCount||0,hasSubfolders:R?.hasSubfolders||!1,subfolderCount:R?.subfolderCount||0}),s.jsx(td,{isOpen:ie,onClose:()=>{me(!1),qe("")},onConfirm:Z,tagName:Ct,existingTags:j()}),s.jsx(sd,{isOpen:he,onClose:()=>{pe(!1),st(null)},onConfirm:oe,tagName:Ne?.name||"",cardCount:Ne?.cardCount||0}),s.jsx(id,{}),s.jsx(hd,{isOpen:z,onClose:()=>Y(!1)}),ne&&s.jsx(vd,{conflictId:ne,onClose:()=>{A(!1),ge(null)}})]})})}const Ad={theme:"system",setTheme:()=>null},Id=c.createContext(Ad);function _d({children:a,defaultTheme:e="system",storageKey:t="vite-ui-theme",...r}){const[n,o]=c.useState(()=>localStorage.getItem(t)||e);c.useEffect(()=>{const l=window.document.documentElement;if(l.classList.remove("light","dark"),n==="system"){const m=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";l.classList.add(m);return}l.classList.add(n)},[n]);const i={theme:n,setTheme:l=>{localStorage.setItem(t,l),o(l)}};return s.jsx(Id.Provider,{...r,value:i,children:a})}var Md=a=>{switch(a){case"success":return Pd;case"info":return $d;case"warning":return Ld;case"error":return zd;default:return null}},Fd=Array(12).fill(0),Od=({visible:a,className:e})=>U.createElement("div",{className:["sonner-loading-wrapper",e].filter(Boolean).join(" "),"data-visible":a},U.createElement("div",{className:"sonner-spinner"},Fd.map((t,r)=>U.createElement("div",{className:"sonner-loading-bar",key:`spinner-bar-${r}`})))),Pd=U.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",height:"20",width:"20"},U.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z",clipRule:"evenodd"})),Ld=U.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",height:"20",width:"20"},U.createElement("path",{fillRule:"evenodd",d:"M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z",clipRule:"evenodd"})),$d=U.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",height:"20",width:"20"},U.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z",clipRule:"evenodd"})),zd=U.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",height:"20",width:"20"},U.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})),Bd=U.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"},U.createElement("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),U.createElement("line",{x1:"6",y1:"6",x2:"18",y2:"18"})),Ud=()=>{let[a,e]=U.useState(document.hidden);return U.useEffect(()=>{let t=()=>{e(document.hidden)};return document.addEventListener("visibilitychange",t),()=>window.removeEventListener("visibilitychange",t)},[]),a},As=1,Vd=class{constructor(){this.subscribe=a=>(this.subscribers.push(a),()=>{let e=this.subscribers.indexOf(a);this.subscribers.splice(e,1)}),this.publish=a=>{this.subscribers.forEach(e=>e(a))},this.addToast=a=>{this.publish(a),this.toasts=[...this.toasts,a]},this.create=a=>{var e;let{message:t,...r}=a,n=typeof a?.id=="number"||((e=a.id)==null?void 0:e.length)>0?a.id:As++,o=this.toasts.find(l=>l.id===n),i=a.dismissible===void 0?!0:a.dismissible;return this.dismissedToasts.has(n)&&this.dismissedToasts.delete(n),o?this.toasts=this.toasts.map(l=>l.id===n?(this.publish({...l,...a,id:n,title:t}),{...l,...a,id:n,dismissible:i,title:t}):l):this.addToast({title:t,...r,dismissible:i,id:n}),n},this.dismiss=a=>(this.dismissedToasts.add(a),a||this.toasts.forEach(e=>{this.subscribers.forEach(t=>t({id:e.id,dismiss:!0}))}),this.subscribers.forEach(e=>e({id:a,dismiss:!0})),a),this.message=(a,e)=>this.create({...e,message:a}),this.error=(a,e)=>this.create({...e,message:a,type:"error"}),this.success=(a,e)=>this.create({...e,type:"success",message:a}),this.info=(a,e)=>this.create({...e,type:"info",message:a}),this.warning=(a,e)=>this.create({...e,type:"warning",message:a}),this.loading=(a,e)=>this.create({...e,type:"loading",message:a}),this.promise=(a,e)=>{if(!e)return;let t;e.loading!==void 0&&(t=this.create({...e,promise:a,type:"loading",message:e.loading,description:typeof e.description!="function"?e.description:void 0}));let r=a instanceof Promise?a:a(),n=t!==void 0,o,i=r.then(async m=>{if(o=["resolve",m],U.isValidElement(m))n=!1,this.create({id:t,type:"default",message:m});else if(Hd(m)&&!m.ok){n=!1;let u=typeof e.error=="function"?await e.error(`HTTP error! status: ${m.status}`):e.error,d=typeof e.description=="function"?await e.description(`HTTP error! status: ${m.status}`):e.description;this.create({id:t,type:"error",message:u,description:d})}else if(e.success!==void 0){n=!1;let u=typeof e.success=="function"?await e.success(m):e.success,d=typeof e.description=="function"?await e.description(m):e.description;this.create({id:t,type:"success",message:u,description:d})}}).catch(async m=>{if(o=["reject",m],e.error!==void 0){n=!1;let u=typeof e.error=="function"?await e.error(m):e.error,d=typeof e.description=="function"?await e.description(m):e.description;this.create({id:t,type:"error",message:u,description:d})}}).finally(()=>{var m;n&&(this.dismiss(t),t=void 0),(m=e.finally)==null||m.call(e)}),l=()=>new Promise((m,u)=>i.then(()=>o[0]==="reject"?u(o[1]):m(o[1])).catch(u));return typeof t!="string"&&typeof t!="number"?{unwrap:l}:Object.assign(t,{unwrap:l})},this.custom=(a,e)=>{let t=e?.id||As++;return this.create({jsx:a(t),id:t,...e}),t},this.getActiveToasts=()=>this.toasts.filter(a=>!this.dismissedToasts.has(a.id)),this.subscribers=[],this.toasts=[],this.dismissedToasts=new Set}},be=new Vd,Wd=(a,e)=>{let t=e?.id||As++;return be.addToast({title:a,...e,id:t}),t},Hd=a=>a&&typeof a=="object"&&"ok"in a&&typeof a.ok=="boolean"&&"status"in a&&typeof a.status=="number",Gd=Wd,Kd=()=>be.toasts,Yd=()=>be.getActiveToasts();Object.assign(Gd,{success:be.success,info:be.info,warning:be.warning,error:be.error,custom:be.custom,message:be.message,promise:be.promise,dismiss:be.dismiss,loading:be.loading},{getHistory:Kd,getToasts:Yd});function qd(a,{insertAt:e}={}){if(typeof document>"u")return;let t=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css",e==="top"&&t.firstChild?t.insertBefore(r,t.firstChild):t.appendChild(r),r.styleSheet?r.styleSheet.cssText=a:r.appendChild(document.createTextNode(a))}qd(`:where(html[dir="ltr"]),:where([data-sonner-toaster][dir="ltr"]){--toast-icon-margin-start: -3px;--toast-icon-margin-end: 4px;--toast-svg-margin-start: -1px;--toast-svg-margin-end: 0px;--toast-button-margin-start: auto;--toast-button-margin-end: 0;--toast-close-button-start: 0;--toast-close-button-end: unset;--toast-close-button-transform: translate(-35%, -35%)}:where(html[dir="rtl"]),:where([data-sonner-toaster][dir="rtl"]){--toast-icon-margin-start: 4px;--toast-icon-margin-end: -3px;--toast-svg-margin-start: 0px;--toast-svg-margin-end: -1px;--toast-button-margin-start: 0;--toast-button-margin-end: auto;--toast-close-button-start: unset;--toast-close-button-end: 0;--toast-close-button-transform: translate(35%, -35%)}:where([data-sonner-toaster]){position:fixed;width:var(--width);font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;--gray1: hsl(0, 0%, 99%);--gray2: hsl(0, 0%, 97.3%);--gray3: hsl(0, 0%, 95.1%);--gray4: hsl(0, 0%, 93%);--gray5: hsl(0, 0%, 90.9%);--gray6: hsl(0, 0%, 88.7%);--gray7: hsl(0, 0%, 85.8%);--gray8: hsl(0, 0%, 78%);--gray9: hsl(0, 0%, 56.1%);--gray10: hsl(0, 0%, 52.3%);--gray11: hsl(0, 0%, 43.5%);--gray12: hsl(0, 0%, 9%);--border-radius: 8px;box-sizing:border-box;padding:0;margin:0;list-style:none;outline:none;z-index:999999999;transition:transform .4s ease}:where([data-sonner-toaster][data-lifted="true"]){transform:translateY(-10px)}@media (hover: none) and (pointer: coarse){:where([data-sonner-toaster][data-lifted="true"]){transform:none}}:where([data-sonner-toaster][data-x-position="right"]){right:var(--offset-right)}:where([data-sonner-toaster][data-x-position="left"]){left:var(--offset-left)}:where([data-sonner-toaster][data-x-position="center"]){left:50%;transform:translate(-50%)}:where([data-sonner-toaster][data-y-position="top"]){top:var(--offset-top)}:where([data-sonner-toaster][data-y-position="bottom"]){bottom:var(--offset-bottom)}:where([data-sonner-toast]){--y: translateY(100%);--lift-amount: calc(var(--lift) * var(--gap));z-index:var(--z-index);position:absolute;opacity:0;transform:var(--y);filter:blur(0);touch-action:none;transition:transform .4s,opacity .4s,height .4s,box-shadow .2s;box-sizing:border-box;outline:none;overflow-wrap:anywhere}:where([data-sonner-toast][data-styled="true"]){padding:16px;background:var(--normal-bg);border:1px solid var(--normal-border);color:var(--normal-text);border-radius:var(--border-radius);box-shadow:0 4px 12px #0000001a;width:var(--width);font-size:13px;display:flex;align-items:center;gap:6px}:where([data-sonner-toast]:focus-visible){box-shadow:0 4px 12px #0000001a,0 0 0 2px #0003}:where([data-sonner-toast][data-y-position="top"]){top:0;--y: translateY(-100%);--lift: 1;--lift-amount: calc(1 * var(--gap))}:where([data-sonner-toast][data-y-position="bottom"]){bottom:0;--y: translateY(100%);--lift: -1;--lift-amount: calc(var(--lift) * var(--gap))}:where([data-sonner-toast]) :where([data-description]){font-weight:400;line-height:1.4;color:inherit}:where([data-sonner-toast]) :where([data-title]){font-weight:500;line-height:1.5;color:inherit}:where([data-sonner-toast]) :where([data-icon]){display:flex;height:16px;width:16px;position:relative;justify-content:flex-start;align-items:center;flex-shrink:0;margin-left:var(--toast-icon-margin-start);margin-right:var(--toast-icon-margin-end)}:where([data-sonner-toast][data-promise="true"]) :where([data-icon])>svg{opacity:0;transform:scale(.8);transform-origin:center;animation:sonner-fade-in .3s ease forwards}:where([data-sonner-toast]) :where([data-icon])>*{flex-shrink:0}:where([data-sonner-toast]) :where([data-icon]) svg{margin-left:var(--toast-svg-margin-start);margin-right:var(--toast-svg-margin-end)}:where([data-sonner-toast]) :where([data-content]){display:flex;flex-direction:column;gap:2px}[data-sonner-toast][data-styled=true] [data-button]{border-radius:4px;padding-left:8px;padding-right:8px;height:24px;font-size:12px;color:var(--normal-bg);background:var(--normal-text);margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end);border:none;cursor:pointer;outline:none;display:flex;align-items:center;flex-shrink:0;transition:opacity .4s,box-shadow .2s}:where([data-sonner-toast]) :where([data-button]):focus-visible{box-shadow:0 0 0 2px #0006}:where([data-sonner-toast]) :where([data-button]):first-of-type{margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end)}:where([data-sonner-toast]) :where([data-cancel]){color:var(--normal-text);background:rgba(0,0,0,.08)}:where([data-sonner-toast][data-theme="dark"]) :where([data-cancel]){background:rgba(255,255,255,.3)}:where([data-sonner-toast]) :where([data-close-button]){position:absolute;left:var(--toast-close-button-start);right:var(--toast-close-button-end);top:0;height:20px;width:20px;display:flex;justify-content:center;align-items:center;padding:0;color:var(--gray12);border:1px solid var(--gray4);transform:var(--toast-close-button-transform);border-radius:50%;cursor:pointer;z-index:1;transition:opacity .1s,background .2s,border-color .2s}[data-sonner-toast] [data-close-button]{background:var(--gray1)}:where([data-sonner-toast]) :where([data-close-button]):focus-visible{box-shadow:0 4px 12px #0000001a,0 0 0 2px #0003}:where([data-sonner-toast]) :where([data-disabled="true"]){cursor:not-allowed}:where([data-sonner-toast]):hover :where([data-close-button]):hover{background:var(--gray2);border-color:var(--gray5)}:where([data-sonner-toast][data-swiping="true"]):before{content:"";position:absolute;left:-50%;right:-50%;height:100%;z-index:-1}:where([data-sonner-toast][data-y-position="top"][data-swiping="true"]):before{bottom:50%;transform:scaleY(3) translateY(50%)}:where([data-sonner-toast][data-y-position="bottom"][data-swiping="true"]):before{top:50%;transform:scaleY(3) translateY(-50%)}:where([data-sonner-toast][data-swiping="false"][data-removed="true"]):before{content:"";position:absolute;inset:0;transform:scaleY(2)}:where([data-sonner-toast]):after{content:"";position:absolute;left:0;height:calc(var(--gap) + 1px);bottom:100%;width:100%}:where([data-sonner-toast][data-mounted="true"]){--y: translateY(0);opacity:1}:where([data-sonner-toast][data-expanded="false"][data-front="false"]){--scale: var(--toasts-before) * .05 + 1;--y: translateY(calc(var(--lift-amount) * var(--toasts-before))) scale(calc(-1 * var(--scale)));height:var(--front-toast-height)}:where([data-sonner-toast])>*{transition:opacity .4s}:where([data-sonner-toast][data-expanded="false"][data-front="false"][data-styled="true"])>*{opacity:0}:where([data-sonner-toast][data-visible="false"]){opacity:0;pointer-events:none}:where([data-sonner-toast][data-mounted="true"][data-expanded="true"]){--y: translateY(calc(var(--lift) * var(--offset)));height:var(--initial-height)}:where([data-sonner-toast][data-removed="true"][data-front="true"][data-swipe-out="false"]){--y: translateY(calc(var(--lift) * -100%));opacity:0}:where([data-sonner-toast][data-removed="true"][data-front="false"][data-swipe-out="false"][data-expanded="true"]){--y: translateY(calc(var(--lift) * var(--offset) + var(--lift) * -100%));opacity:0}:where([data-sonner-toast][data-removed="true"][data-front="false"][data-swipe-out="false"][data-expanded="false"]){--y: translateY(40%);opacity:0;transition:transform .5s,opacity .2s}:where([data-sonner-toast][data-removed="true"][data-front="false"]):before{height:calc(var(--initial-height) + 20%)}[data-sonner-toast][data-swiping=true]{transform:var(--y) translateY(var(--swipe-amount-y, 0px)) translate(var(--swipe-amount-x, 0px));transition:none}[data-sonner-toast][data-swiped=true]{user-select:none}[data-sonner-toast][data-swipe-out=true][data-y-position=bottom],[data-sonner-toast][data-swipe-out=true][data-y-position=top]{animation-duration:.2s;animation-timing-function:ease-out;animation-fill-mode:forwards}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=left]{animation-name:swipe-out-left}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=right]{animation-name:swipe-out-right}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=up]{animation-name:swipe-out-up}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=down]{animation-name:swipe-out-down}@keyframes swipe-out-left{0%{transform:var(--y) translate(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translate(calc(var(--swipe-amount-x) - 100%));opacity:0}}@keyframes swipe-out-right{0%{transform:var(--y) translate(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translate(calc(var(--swipe-amount-x) + 100%));opacity:0}}@keyframes swipe-out-up{0%{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) - 100%));opacity:0}}@keyframes swipe-out-down{0%{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) + 100%));opacity:0}}@media (max-width: 600px){[data-sonner-toaster]{position:fixed;right:var(--mobile-offset-right);left:var(--mobile-offset-left);width:100%}[data-sonner-toaster][dir=rtl]{left:calc(var(--mobile-offset-left) * -1)}[data-sonner-toaster] [data-sonner-toast]{left:0;right:0;width:calc(100% - var(--mobile-offset-left) * 2)}[data-sonner-toaster][data-x-position=left]{left:var(--mobile-offset-left)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--mobile-offset-bottom)}[data-sonner-toaster][data-y-position=top]{top:var(--mobile-offset-top)}[data-sonner-toaster][data-x-position=center]{left:var(--mobile-offset-left);right:var(--mobile-offset-right);transform:none}}[data-sonner-toaster][data-theme=light]{--normal-bg: #fff;--normal-border: var(--gray4);--normal-text: var(--gray12);--success-bg: hsl(143, 85%, 96%);--success-border: hsl(145, 92%, 91%);--success-text: hsl(140, 100%, 27%);--info-bg: hsl(208, 100%, 97%);--info-border: hsl(221, 91%, 91%);--info-text: hsl(210, 92%, 45%);--warning-bg: hsl(49, 100%, 97%);--warning-border: hsl(49, 91%, 91%);--warning-text: hsl(31, 92%, 45%);--error-bg: hsl(359, 100%, 97%);--error-border: hsl(359, 100%, 94%);--error-text: hsl(360, 100%, 45%)}[data-sonner-toaster][data-theme=light] [data-sonner-toast][data-invert=true]{--normal-bg: #000;--normal-border: hsl(0, 0%, 20%);--normal-text: var(--gray1)}[data-sonner-toaster][data-theme=dark] [data-sonner-toast][data-invert=true]{--normal-bg: #fff;--normal-border: var(--gray3);--normal-text: var(--gray12)}[data-sonner-toaster][data-theme=dark]{--normal-bg: #000;--normal-bg-hover: hsl(0, 0%, 12%);--normal-border: hsl(0, 0%, 20%);--normal-border-hover: hsl(0, 0%, 25%);--normal-text: var(--gray1);--success-bg: hsl(150, 100%, 6%);--success-border: hsl(147, 100%, 12%);--success-text: hsl(150, 86%, 65%);--info-bg: hsl(215, 100%, 6%);--info-border: hsl(223, 100%, 12%);--info-text: hsl(216, 87%, 65%);--warning-bg: hsl(64, 100%, 6%);--warning-border: hsl(60, 100%, 12%);--warning-text: hsl(46, 87%, 65%);--error-bg: hsl(358, 76%, 10%);--error-border: hsl(357, 89%, 16%);--error-text: hsl(358, 100%, 81%)}[data-sonner-toaster][data-theme=dark] [data-sonner-toast] [data-close-button]{background:var(--normal-bg);border-color:var(--normal-border);color:var(--normal-text)}[data-sonner-toaster][data-theme=dark] [data-sonner-toast] [data-close-button]:hover{background:var(--normal-bg-hover);border-color:var(--normal-border-hover)}[data-rich-colors=true][data-sonner-toast][data-type=success],[data-rich-colors=true][data-sonner-toast][data-type=success] [data-close-button]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=info],[data-rich-colors=true][data-sonner-toast][data-type=info] [data-close-button]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning],[data-rich-colors=true][data-sonner-toast][data-type=warning] [data-close-button]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=error],[data-rich-colors=true][data-sonner-toast][data-type=error] [data-close-button]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}.sonner-loading-wrapper{--size: 16px;height:var(--size);width:var(--size);position:absolute;inset:0;z-index:10}.sonner-loading-wrapper[data-visible=false]{transform-origin:center;animation:sonner-fade-out .2s ease forwards}.sonner-spinner{position:relative;top:50%;left:50%;height:var(--size);width:var(--size)}.sonner-loading-bar{animation:sonner-spin 1.2s linear infinite;background:var(--gray11);border-radius:6px;height:8%;left:-10%;position:absolute;top:-3.9%;width:24%}.sonner-loading-bar:nth-child(1){animation-delay:-1.2s;transform:rotate(.0001deg) translate(146%)}.sonner-loading-bar:nth-child(2){animation-delay:-1.1s;transform:rotate(30deg) translate(146%)}.sonner-loading-bar:nth-child(3){animation-delay:-1s;transform:rotate(60deg) translate(146%)}.sonner-loading-bar:nth-child(4){animation-delay:-.9s;transform:rotate(90deg) translate(146%)}.sonner-loading-bar:nth-child(5){animation-delay:-.8s;transform:rotate(120deg) translate(146%)}.sonner-loading-bar:nth-child(6){animation-delay:-.7s;transform:rotate(150deg) translate(146%)}.sonner-loading-bar:nth-child(7){animation-delay:-.6s;transform:rotate(180deg) translate(146%)}.sonner-loading-bar:nth-child(8){animation-delay:-.5s;transform:rotate(210deg) translate(146%)}.sonner-loading-bar:nth-child(9){animation-delay:-.4s;transform:rotate(240deg) translate(146%)}.sonner-loading-bar:nth-child(10){animation-delay:-.3s;transform:rotate(270deg) translate(146%)}.sonner-loading-bar:nth-child(11){animation-delay:-.2s;transform:rotate(300deg) translate(146%)}.sonner-loading-bar:nth-child(12){animation-delay:-.1s;transform:rotate(330deg) translate(146%)}@keyframes sonner-fade-in{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}@keyframes sonner-fade-out{0%{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.8)}}@keyframes sonner-spin{0%{opacity:1}to{opacity:.15}}@media (prefers-reduced-motion){[data-sonner-toast],[data-sonner-toast]>*,.sonner-loading-bar{transition:none!important;animation:none!important}}.sonner-loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transform-origin:center;transition:opacity .2s,transform .2s}.sonner-loader[data-visible=false]{opacity:0;transform:scale(.8) translate(-50%,-50%)}
`);function Wt(a){return a.label!==void 0}var Jd=3,Xd="32px",Qd="16px",ua=4e3,Zd=356,eu=14,tu=20,su=200;function ke(...a){return a.filter(Boolean).join(" ")}function au(a){let[e,t]=a.split("-"),r=[];return e&&r.push(e),t&&r.push(t),r}var ru=a=>{var e,t,r,n,o,i,l,m,u,d,y;let{invert:h,toast:g,unstyled:S,interacting:N,setHeights:E,visibleToasts:v,heights:f,index:p,toasts:x,expanded:b,removeToast:C,defaultRichColors:w,closeButton:j,style:D,cancelButtonStyle:P,actionButtonStyle:$,className:K="",descriptionClassName:se="",duration:V,position:re,gap:te,loadingIcon:ne,expandByDefault:ge,classNames:z,icons:Y,closeButtonAriaLabel:_="Close toast",pauseWhenPageIsHidden:A}=a,[T,W]=U.useState(null),[J,B]=U.useState(null),[q,M]=U.useState(!1),[R,k]=U.useState(!1),[O,Q]=U.useState(!1),[ie,me]=U.useState(!1),[he,pe]=U.useState(!1),[Ct,qe]=U.useState(0),[Ne,st]=U.useState(0),Je=U.useRef(g.duration||V||ua),Pt=U.useRef(null),Re=U.useRef(null),ns=p===0,os=p+1<=v,xe=g.type,Be=g.dismissible!==!1,is=g.className||"",ls=g.descriptionClassName||"",at=U.useMemo(()=>f.findIndex(Z=>Z.toastId===g.id)||0,[f,g.id]),cs=U.useMemo(()=>{var Z;return(Z=g.closeButton)!=null?Z:j},[g.closeButton,j]),Lt=U.useMemo(()=>g.duration||V||ua,[g.duration,V]),jt=U.useRef(0),Te=U.useRef(0),St=U.useRef(0),Oe=U.useRef(null),[$t,zt]=re.split("-"),Bt=U.useMemo(()=>f.reduce((Z,oe,le)=>le>=at?Z:Z+oe.height,0),[f,at]),Ut=Ud(),ds=g.invert||h,Ue=xe==="loading";Te.current=U.useMemo(()=>at*te+Bt,[at,Bt]),U.useEffect(()=>{Je.current=Lt},[Lt]),U.useEffect(()=>{M(!0)},[]),U.useEffect(()=>{let Z=Re.current;if(Z){let oe=Z.getBoundingClientRect().height;return st(oe),E(le=>[{toastId:g.id,height:oe,position:g.position},...le]),()=>E(le=>le.filter(we=>we.toastId!==g.id))}},[E,g.id]),U.useLayoutEffect(()=>{if(!q)return;let Z=Re.current,oe=Z.style.height;Z.style.height="auto";let le=Z.getBoundingClientRect().height;Z.style.height=oe,st(le),E(we=>we.find(F=>F.toastId===g.id)?we.map(F=>F.toastId===g.id?{...F,height:le}:F):[{toastId:g.id,height:le,position:g.position},...we])},[q,g.title,g.description,E,g.id]);let Ae=U.useCallback(()=>{k(!0),qe(Te.current),E(Z=>Z.filter(oe=>oe.toastId!==g.id)),setTimeout(()=>{C(g)},su)},[g,C,E,Te]);U.useEffect(()=>{if(g.promise&&xe==="loading"||g.duration===1/0||g.type==="loading")return;let Z;return b||N||A&&Ut?(()=>{if(St.current<jt.current){let oe=new Date().getTime()-jt.current;Je.current=Je.current-oe}St.current=new Date().getTime()})():Je.current!==1/0&&(jt.current=new Date().getTime(),Z=setTimeout(()=>{var oe;(oe=g.onAutoClose)==null||oe.call(g,g),Ae()},Je.current)),()=>clearTimeout(Z)},[b,N,g,xe,A,Ut,Ae]),U.useEffect(()=>{g.delete&&Ae()},[Ae,g.delete]);function us(){var Z,oe,le;return Y!=null&&Y.loading?U.createElement("div",{className:ke(z?.loader,(Z=g?.classNames)==null?void 0:Z.loader,"sonner-loader"),"data-visible":xe==="loading"},Y.loading):ne?U.createElement("div",{className:ke(z?.loader,(oe=g?.classNames)==null?void 0:oe.loader,"sonner-loader"),"data-visible":xe==="loading"},ne):U.createElement(Od,{className:ke(z?.loader,(le=g?.classNames)==null?void 0:le.loader),visible:xe==="loading"})}return U.createElement("li",{tabIndex:0,ref:Re,className:ke(K,is,z?.toast,(e=g?.classNames)==null?void 0:e.toast,z?.default,z?.[xe],(t=g?.classNames)==null?void 0:t[xe]),"data-sonner-toast":"","data-rich-colors":(r=g.richColors)!=null?r:w,"data-styled":!(g.jsx||g.unstyled||S),"data-mounted":q,"data-promise":!!g.promise,"data-swiped":he,"data-removed":R,"data-visible":os,"data-y-position":$t,"data-x-position":zt,"data-index":p,"data-front":ns,"data-swiping":O,"data-dismissible":Be,"data-type":xe,"data-invert":ds,"data-swipe-out":ie,"data-swipe-direction":J,"data-expanded":!!(b||ge&&q),style:{"--index":p,"--toasts-before":p,"--z-index":x.length-p,"--offset":`${R?Ct:Te.current}px`,"--initial-height":ge?"auto":`${Ne}px`,...D,...g.style},onDragEnd:()=>{Q(!1),W(null),Oe.current=null},onPointerDown:Z=>{Ue||!Be||(Pt.current=new Date,qe(Te.current),Z.target.setPointerCapture(Z.pointerId),Z.target.tagName!=="BUTTON"&&(Q(!0),Oe.current={x:Z.clientX,y:Z.clientY}))},onPointerUp:()=>{var Z,oe,le,we;if(ie||!Be)return;Oe.current=null;let F=Number(((Z=Re.current)==null?void 0:Z.style.getPropertyValue("--swipe-amount-x").replace("px",""))||0),G=Number(((oe=Re.current)==null?void 0:oe.style.getPropertyValue("--swipe-amount-y").replace("px",""))||0),ae=new Date().getTime()-((le=Pt.current)==null?void 0:le.getTime()),fe=T==="x"?F:G,ve=Math.abs(fe)/ae;if(Math.abs(fe)>=tu||ve>.11){qe(Te.current),(we=g.onDismiss)==null||we.call(g,g),B(T==="x"?F>0?"right":"left":G>0?"down":"up"),Ae(),me(!0),pe(!1);return}Q(!1),W(null)},onPointerMove:Z=>{var oe,le,we,F;if(!Oe.current||!Be||((oe=window.getSelection())==null?void 0:oe.toString().length)>0)return;let G=Z.clientY-Oe.current.y,ae=Z.clientX-Oe.current.x,fe=(le=a.swipeDirections)!=null?le:au(re);!T&&(Math.abs(ae)>1||Math.abs(G)>1)&&W(Math.abs(ae)>Math.abs(G)?"x":"y");let ve={x:0,y:0};T==="y"?(fe.includes("top")||fe.includes("bottom"))&&(fe.includes("top")&&G<0||fe.includes("bottom")&&G>0)&&(ve.y=G):T==="x"&&(fe.includes("left")||fe.includes("right"))&&(fe.includes("left")&&ae<0||fe.includes("right")&&ae>0)&&(ve.x=ae),(Math.abs(ve.x)>0||Math.abs(ve.y)>0)&&pe(!0),(we=Re.current)==null||we.style.setProperty("--swipe-amount-x",`${ve.x}px`),(F=Re.current)==null||F.style.setProperty("--swipe-amount-y",`${ve.y}px`)}},cs&&!g.jsx?U.createElement("button",{"aria-label":_,"data-disabled":Ue,"data-close-button":!0,onClick:Ue||!Be?()=>{}:()=>{var Z;Ae(),(Z=g.onDismiss)==null||Z.call(g,g)},className:ke(z?.closeButton,(n=g?.classNames)==null?void 0:n.closeButton)},(o=Y?.close)!=null?o:Bd):null,g.jsx||c.isValidElement(g.title)?g.jsx?g.jsx:typeof g.title=="function"?g.title():g.title:U.createElement(U.Fragment,null,xe||g.icon||g.promise?U.createElement("div",{"data-icon":"",className:ke(z?.icon,(i=g?.classNames)==null?void 0:i.icon)},g.promise||g.type==="loading"&&!g.icon?g.icon||us():null,g.type!=="loading"?g.icon||Y?.[xe]||Md(xe):null):null,U.createElement("div",{"data-content":"",className:ke(z?.content,(l=g?.classNames)==null?void 0:l.content)},U.createElement("div",{"data-title":"",className:ke(z?.title,(m=g?.classNames)==null?void 0:m.title)},typeof g.title=="function"?g.title():g.title),g.description?U.createElement("div",{"data-description":"",className:ke(se,ls,z?.description,(u=g?.classNames)==null?void 0:u.description)},typeof g.description=="function"?g.description():g.description):null),c.isValidElement(g.cancel)?g.cancel:g.cancel&&Wt(g.cancel)?U.createElement("button",{"data-button":!0,"data-cancel":!0,style:g.cancelButtonStyle||P,onClick:Z=>{var oe,le;Wt(g.cancel)&&Be&&((le=(oe=g.cancel).onClick)==null||le.call(oe,Z),Ae())},className:ke(z?.cancelButton,(d=g?.classNames)==null?void 0:d.cancelButton)},g.cancel.label):null,c.isValidElement(g.action)?g.action:g.action&&Wt(g.action)?U.createElement("button",{"data-button":!0,"data-action":!0,style:g.actionButtonStyle||$,onClick:Z=>{var oe,le;Wt(g.action)&&((le=(oe=g.action).onClick)==null||le.call(oe,Z),!Z.defaultPrevented&&Ae())},className:ke(z?.actionButton,(y=g?.classNames)==null?void 0:y.actionButton)},g.action.label):null))};function ma(){if(typeof window>"u"||typeof document>"u")return"ltr";let a=document.documentElement.getAttribute("dir");return a==="auto"||!a?window.getComputedStyle(document.documentElement).direction:a}function nu(a,e){let t={};return[a,e].forEach((r,n)=>{let o=n===1,i=o?"--mobile-offset":"--offset",l=o?Qd:Xd;function m(u){["top","right","bottom","left"].forEach(d=>{t[`${i}-${d}`]=typeof u=="number"?`${u}px`:u})}typeof r=="number"||typeof r=="string"?m(r):typeof r=="object"?["top","right","bottom","left"].forEach(u=>{r[u]===void 0?t[`${i}-${u}`]=l:t[`${i}-${u}`]=typeof r[u]=="number"?`${r[u]}px`:r[u]}):m(l)}),t}var ou=c.forwardRef(function(a,e){let{invert:t,position:r="bottom-right",hotkey:n=["altKey","KeyT"],expand:o,closeButton:i,className:l,offset:m,mobileOffset:u,theme:d="light",richColors:y,duration:h,style:g,visibleToasts:S=Jd,toastOptions:N,dir:E=ma(),gap:v=eu,loadingIcon:f,icons:p,containerAriaLabel:x="Notifications",pauseWhenPageIsHidden:b}=a,[C,w]=U.useState([]),j=U.useMemo(()=>Array.from(new Set([r].concat(C.filter(A=>A.position).map(A=>A.position)))),[C,r]),[D,P]=U.useState([]),[$,K]=U.useState(!1),[se,V]=U.useState(!1),[re,te]=U.useState(d!=="system"?d:typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),ne=U.useRef(null),ge=n.join("+").replace(/Key/g,"").replace(/Digit/g,""),z=U.useRef(null),Y=U.useRef(!1),_=U.useCallback(A=>{w(T=>{var W;return(W=T.find(J=>J.id===A.id))!=null&&W.delete||be.dismiss(A.id),T.filter(({id:J})=>J!==A.id)})},[]);return U.useEffect(()=>be.subscribe(A=>{if(A.dismiss){w(T=>T.map(W=>W.id===A.id?{...W,delete:!0}:W));return}setTimeout(()=>{Yn.flushSync(()=>{w(T=>{let W=T.findIndex(J=>J.id===A.id);return W!==-1?[...T.slice(0,W),{...T[W],...A},...T.slice(W+1)]:[A,...T]})})})}),[]),U.useEffect(()=>{if(d!=="system"){te(d);return}if(d==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?te("dark"):te("light")),typeof window>"u")return;let A=window.matchMedia("(prefers-color-scheme: dark)");try{A.addEventListener("change",({matches:T})=>{te(T?"dark":"light")})}catch{A.addListener(({matches:W})=>{try{te(W?"dark":"light")}catch(J){console.error(J)}})}},[d]),U.useEffect(()=>{C.length<=1&&K(!1)},[C]),U.useEffect(()=>{let A=T=>{var W,J;n.every(B=>T[B]||T.code===B)&&(K(!0),(W=ne.current)==null||W.focus()),T.code==="Escape"&&(document.activeElement===ne.current||(J=ne.current)!=null&&J.contains(document.activeElement))&&K(!1)};return document.addEventListener("keydown",A),()=>document.removeEventListener("keydown",A)},[n]),U.useEffect(()=>{if(ne.current)return()=>{z.current&&(z.current.focus({preventScroll:!0}),z.current=null,Y.current=!1)}},[ne.current]),U.createElement("section",{ref:e,"aria-label":`${x} ${ge}`,tabIndex:-1,"aria-live":"polite","aria-relevant":"additions text","aria-atomic":"false",suppressHydrationWarning:!0},j.map((A,T)=>{var W;let[J,B]=A.split("-");return C.length?U.createElement("ol",{key:A,dir:E==="auto"?ma():E,tabIndex:-1,ref:ne,className:l,"data-sonner-toaster":!0,"data-theme":re,"data-y-position":J,"data-lifted":$&&C.length>1&&!o,"data-x-position":B,style:{"--front-toast-height":`${((W=D[0])==null?void 0:W.height)||0}px`,"--width":`${Zd}px`,"--gap":`${v}px`,...g,...nu(m,u)},onBlur:q=>{Y.current&&!q.currentTarget.contains(q.relatedTarget)&&(Y.current=!1,z.current&&(z.current.focus({preventScroll:!0}),z.current=null))},onFocus:q=>{q.target instanceof HTMLElement&&q.target.dataset.dismissible==="false"||Y.current||(Y.current=!0,z.current=q.relatedTarget)},onMouseEnter:()=>K(!0),onMouseMove:()=>K(!0),onMouseLeave:()=>{se||K(!1)},onDragEnd:()=>K(!1),onPointerDown:q=>{q.target instanceof HTMLElement&&q.target.dataset.dismissible==="false"||V(!0)},onPointerUp:()=>V(!1)},C.filter(q=>!q.position&&T===0||q.position===A).map((q,M)=>{var R,k;return U.createElement(ru,{key:q.id,icons:p,index:M,toast:q,defaultRichColors:y,duration:(R=N?.duration)!=null?R:h,className:N?.className,descriptionClassName:N?.descriptionClassName,invert:t,visibleToasts:S,closeButton:(k=N?.closeButton)!=null?k:i,interacting:se,position:A,style:N?.style,unstyled:N?.unstyled,classNames:N?.classNames,cancelButtonStyle:N?.cancelButtonStyle,actionButtonStyle:N?.actionButtonStyle,removeToast:_,toasts:C.filter(O=>O.position==q.position),heights:D.filter(O=>O.position==q.position),setHeights:P,expandByDefault:o,gap:v,loadingIcon:f,expanded:$,pauseWhenPageIsHidden:b,swipeDirections:a.swipeDirections})})):null}))});const iu=({...a})=>s.jsx(ou,{theme:"light",className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"group-[.toast]:text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...a}),lu=({onClose:a})=>{const[e,t]=c.useState(null),[r,n]=c.useState(!1),[o,i]=c.useState(!1),[l,m]=c.useState(navigator.onLine);c.useEffect(()=>{const y=()=>{window.matchMedia("(display-mode: standalone)").matches&&i(!0)},h=E=>{E.preventDefault(),t(E),setTimeout(()=>{o||n(!0)},3e3)},g=()=>{i(!0),n(!1),t(null),console.log("PWA was installed")},S=()=>m(!0),N=()=>m(!1);return y(),window.addEventListener("beforeinstallprompt",h),window.addEventListener("appinstalled",g),window.addEventListener("online",S),window.addEventListener("offline",N),()=>{window.removeEventListener("beforeinstallprompt",h),window.removeEventListener("appinstalled",g),window.removeEventListener("online",S),window.removeEventListener("offline",N)}},[o]);const u=async()=>{if(e)try{await e.prompt();const{outcome:y}=await e.userChoice;console.log(y==="accepted"?"User accepted the install prompt":"User dismissed the install prompt"),t(null),n(!1)}catch(y){console.error("Error during installation:",y)}},d=()=>{n(!1),a?.()};return!r||o?null:s.jsx("div",{className:"fixed bottom-4 right-4 z-50 max-w-sm",children:s.jsxs(de,{className:"shadow-lg border-2 border-blue-200 bg-gradient-to-br from-blue-50 to-white",children:[s.jsxs(_e,{className:"pb-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(mt,{className:"h-5 w-5 text-blue-600"}),s.jsx(Me,{className:"text-lg",children:"安装 CardAll"})]}),s.jsx(H,{variant:"ghost",size:"sm",onClick:d,className:"h-6 w-6 p-0",children:s.jsx(tt,{className:"h-4 w-4"})})]}),s.jsx(fn,{children:"将 CardAll 安装到您的设备上，享受更好的体验"})]}),s.jsxs(ue,{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[s.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[l?s.jsx(Fs,{className:"h-4 w-4"}):s.jsx(pr,{className:"h-4 w-4"}),s.jsx("span",{children:l?"在线使用":"离线可用"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-blue-600",children:[s.jsx(jo,{className:"h-4 w-4"}),s.jsx("span",{children:"移动优化"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-purple-600",children:[s.jsx(So,{className:"h-4 w-4"}),s.jsx("span",{children:"桌面应用"})]}),s.jsxs("div",{className:"flex items-center gap-2 text-orange-600",children:[s.jsx(mt,{className:"h-4 w-4"}),s.jsx("span",{children:"快速启动"})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h4",{className:"font-medium text-sm",children:"安装后您将获得："}),s.jsxs("ul",{className:"text-xs text-gray-600 space-y-1",children:[s.jsx("li",{children:"• 完全离线功能"}),s.jsx("li",{children:"• 更快的加载速度"}),s.jsx("li",{children:"• 桌面快捷方式"}),s.jsx("li",{children:"• 推送通知支持"})]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(H,{onClick:u,className:"flex-1 bg-blue-600 hover:bg-blue-700",disabled:!e,children:[s.jsx(mt,{className:"h-4 w-4 mr-2"}),"立即安装"]}),s.jsx(H,{variant:"outline",onClick:d,className:"px-3",children:"稍后"})]})]})]})})};function cu({initializationError:a}){const{isOpen:e,closeModal:t}=Cr();return s.jsxs("div",{className:"min-h-screen bg-background",children:[a&&s.jsx("div",{className:"border-b bg-destructive/5",children:s.jsx("div",{className:"container mx-auto px-4 py-2",children:s.jsxs(Ze,{variant:"destructive",className:"mb-0",children:[s.jsx(De,{className:"h-4 w-4"}),s.jsx(pt,{children:a})]})})}),s.jsx(ei,{children:s.jsx(Hi,{children:s.jsx(Gi,{children:s.jsx(Td,{})})})}),s.jsx(lu,{}),Ts.enableAuth,s.jsx(iu,{})]})}function ga({initializationError:a}){return s.jsx(_d,{defaultTheme:"light",storageKey:"cardall-theme",children:s.jsx(si,{children:s.jsx(cu,{initializationError:a})})})}class du{async hasLegacyData(){const e=!!localStorage.getItem("cardall-cards"),t=!!localStorage.getItem("cardall-folders"),r=!!localStorage.getItem("cardall-tags");return e||t||r}async migrateFromLocalStorage(){const e={success:!1,migratedCards:0,migratedFolders:0,migratedTags:0,migratedImages:0,errors:[]};try{console.log("Starting migration from localStorage...");const t=await this.migrateFolders();e.migratedFolders=t.length;const r=await this.migrateTags();e.migratedTags=r.length;const{cards:n,images:o}=await this.migrateCards();e.migratedCards=n.length,e.migratedImages=o,e.success=!0,console.log("Migration completed successfully:",e),await this.backupLegacyData()}catch(t){console.error("Migration failed:",t),e.errors.push(t instanceof Error?t.message:"Unknown error")}return e}async migrateFolders(){const e=localStorage.getItem("cardall-folders");if(!e)return[];try{const r=JSON.parse(e).map(n=>({...n,syncVersion:1,pendingSync:!0}));return await L.folders.bulkAdd(r),console.log(`Migrated ${r.length} folders`),r}catch(t){throw console.error("Failed to migrate folders:",t),t}}async migrateTags(){const e=localStorage.getItem("cardall-tags");if(!e)return[];try{const r=JSON.parse(e).map(n=>({...n,syncVersion:1,pendingSync:!0}));return await L.tags.bulkAdd(r),console.log(`Migrated ${r.length} tags`),r}catch(t){throw console.error("Failed to migrate tags:",t),t}}async migrateCards(){const e=localStorage.getItem("cardall-cards");if(!e)return{cards:[],images:0};try{const t=JSON.parse(e),r=[];let n=0;for(const o of t){const i=await this.migrateCardImages(o.frontContent.images,o.id,o.folderId),l=await this.migrateCardImages(o.backContent.images,o.id,o.folderId);n+=i.length+l.length;const m={...o,frontContent:{...o.frontContent,images:i},backContent:{...o.backContent,images:l},syncVersion:1,pendingSync:!0};r.push(m)}return await L.cards.bulkAdd(r),console.log(`Migrated ${r.length} cards with ${n} images`),{cards:r,images:n}}catch(t){throw console.error("Failed to migrate cards:",t),t}}async migrateCardImages(e,t,r){const n=[];for(const o of e)try{if(o.url&&o.url.startsWith("data:")){const i=await this.base64ToBlob(o.url),l=new File([i],o.alt||"migrated-image.jpg",{type:i.type}),m=await Xe.saveImage(l,t,r);n.push({id:m.id,url:m.filePath,alt:o.alt,width:m.metadata.width,height:m.metadata.height,position:o.position,size:o.size,aspectRatio:m.metadata.width/m.metadata.height})}else n.push(o)}catch(i){console.error("Failed to migrate image:",i),n.push(o)}return n}async base64ToBlob(e){return(await fetch(e)).blob()}async backupLegacyData(){const e={cards:localStorage.getItem("cardall-cards"),folders:localStorage.getItem("cardall-folders"),tags:localStorage.getItem("cardall-tags"),hiddenTags:localStorage.getItem("cardall-hidden-tags"),timestamp:new Date().toISOString()};await L.settings.add({key:"legacy_backup",value:e,updatedAt:new Date}),console.log("Legacy data backed up successfully")}async cleanupLegacyData(){["cardall-cards","cardall-folders","cardall-tags","cardall-hidden-tags"].forEach(t=>localStorage.removeItem(t)),console.log("Legacy localStorage data cleaned up")}async restoreFromBackup(){try{const e=await L.settings.where("key").equals("legacy_backup").first();if(!e)return console.log("No backup data found"),!1;const t=e.value;return t.cards&&localStorage.setItem("cardall-cards",t.cards),t.folders&&localStorage.setItem("cardall-folders",t.folders),t.tags&&localStorage.setItem("cardall-tags",t.tags),t.hiddenTags&&localStorage.setItem("cardall-hidden-tags",t.hiddenTags),console.log("Backup data restored to localStorage"),!0}catch(e){return console.error("Failed to restore backup:",e),!1}}async getMigrationStatus(){const e=await this.hasLegacyData(),t=await L.getStats(),r=t.cards>0||t.folders>0||t.tags>0;return{hasLegacyData:e,hasMigratedData:r,migrationNeeded:e&&!r}}}const Cs=new du;class uu{listeners=[];onStatusChange(e){return this.listeners.push(e),()=>{const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}}updateStatus(e){this.listeners.forEach(t=>t(e))}async initialize(){console.log("开始应用初始化...");const e={success:!1,fileSystemAccess:!1};try{console.log("步骤1: 开始初始化数据库..."),this.updateStatus({step:"database",progress:10,message:"正在初始化数据库...",isComplete:!1,hasError:!1}),console.log("调用 initializeDatabase()...");try{await qn(),console.log("数据库初始化完成"),this.updateStatus({step:"database",progress:20,message:"数据库初始化完成",isComplete:!0,hasError:!1})}catch(t){throw console.error("数据库初始化失败:",t),new Error(`数据库初始化失败: ${t instanceof Error?t.message:"未知错误"}`)}this.updateStatus({step:"migration-check",progress:25,message:"检查数据迁移需求...",isComplete:!1,hasError:!1});try{if((await Cs.getMigrationStatus()).migrationNeeded&&(this.updateStatus({step:"migration",progress:40,message:"正在迁移现有数据...",isComplete:!1,hasError:!1}),e.migrationResult=await Cs.migrateFromLocalStorage(),!e.migrationResult.success))throw new Error(`数据迁移失败: ${e.migrationResult.errors.join(", ")}`)}catch(t){console.error("数据迁移检查失败:",t),this.updateStatus({step:"migration-check",progress:30,message:"数据迁移检查失败，跳过迁移",isComplete:!0,hasError:!1})}if(this.updateStatus({step:"filesystem",progress:60,message:"配置文件系统访问权限...",isComplete:!1,hasError:!1}),Xe.isFileSystemAccessSupported())try{await Xe.getStorageStrategy()==="filesystem"?(e.fileSystemAccess=await Xe.requestDirectoryAccess(),e.fileSystemAccess||console.warn("文件系统访问权限未获得，将使用IndexedDB存储")):(console.info("使用已配置的IndexedDB存储策略"),e.fileSystemAccess=!1)}catch(t){console.warn("文件系统访问请求失败，使用降级存储:",t),e.fileSystemAccess=!1}else console.info("浏览器不支持File System Access API，使用IndexedDB存储"),e.fileSystemAccess=!1;this.updateStatus({step:"sync",progress:80,message:"初始化同步服务...",isComplete:!1,hasError:!1});try{Ee.setAuthService(Rt),Rt.isAuthenticated()&&await Ee.performFullSync()}catch(t){console.error("同步服务初始化失败:",t),this.updateStatus({step:"sync",progress:85,message:"同步服务初始化失败，使用离线模式",isComplete:!0,hasError:!1})}this.updateStatus({step:"complete",progress:100,message:"应用初始化完成",isComplete:!0,hasError:!1}),e.success=!0,console.log("应用初始化成功:",e)}catch(t){console.error("应用初始化失败:",t),this.updateStatus({step:"error",progress:0,message:`初始化失败: ${t instanceof Error?t.message:"未知错误"}`,isComplete:!1,hasError:!0,error:t instanceof Error?t.message:"未知错误"}),e.success=!1,e.error=t instanceof Error?t.message:"未知错误"}return e}async reinitialize(){return console.log("重新初始化应用..."),this.initialize()}async checkInitializationStatus(){try{const e=await Cs.getMigrationStatus();return{databaseReady:!0,syncServiceReady:Ee.getCurrentStatus()!==null,fileSystemAccess:Xe.isFileSystemAccessSupported(),migrationNeeded:e.migrationNeeded}}catch(e){return console.error("检查初始化状态失败:",e),{databaseReady:!1,syncServiceReady:!1,fileSystemAccess:!1,migrationNeeded:!1}}}}const fa=new uu;function mu({onInitialized:a,onError:e,onSkipInitialization:t}){const[r,n]=c.useState({step:"starting",progress:0,message:"准备初始化...",isComplete:!1,hasError:!1}),[o,i]=c.useState(!1),[l,m]=c.useState(null),u=async()=>{console.log("开始初始化流程..."),console.log("时间戳:",new Date().toISOString()),i(!0),m(null);try{console.log("调用appInitService.initialize()...");const h=await fa.initialize();console.log("初始化结果:",h),console.log("结果详情:",JSON.stringify(h,null,2)),m(h),h.success?(console.log("初始化成功，准备进入应用..."),console.log("成功时间戳:",new Date().toISOString()),setTimeout(()=>{a(h)},1e3)):(console.log("初始化失败:",h.error),console.log("失败时间戳:",new Date().toISOString()))}catch(h){console.error("初始化过程出错:",h),console.error("错误时间戳:",new Date().toISOString()),e&&e(h instanceof Error?h.message:"初始化失败")}finally{i(!1)}};c.useEffect(()=>{console.log("设置状态监听器...");const h=fa.onStatusChange(g=>{console.log("收到状态更新:",g),n(g)});return console.log("状态监听器设置完成"),h},[]),c.useEffect(()=>{u()},[]);const d=(h,g,S)=>g?s.jsx(Ns,{className:"h-5 w-5 text-destructive"}):S?s.jsx(gt,{className:"h-5 w-5 text-green-500"}):s.jsx(ze,{className:"h-5 w-5 animate-spin text-blue-500"}),y=h=>({database:"初始化本地数据库，设置数据存储结构","migration-check":"检查是否有需要从localStorage迁移的数据",migration:"将现有数据迁移到新的数据库结构",filesystem:"请求文件系统访问权限以支持本地文件存储",sync:"初始化同步服务，准备离线和在线数据同步",complete:"所有组件初始化完成，应用准备就绪"})[h]||"正在处理...";return s.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4",children:s.jsxs(de,{className:"w-full max-w-md",children:[s.jsx(_e,{className:"text-center",children:s.jsxs(Me,{className:"flex items-center justify-center gap-2",children:[s.jsx(Yt,{className:"h-6 w-6 text-blue-600"}),"CardAll 初始化"]})}),s.jsxs(ue,{className:"space-y-6",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{children:"初始化进度"}),s.jsxs("span",{children:[r.progress,"%"]})]}),s.jsx(We,{value:r.progress,className:"h-2"})]}),s.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted rounded-lg",children:[d(r.step,r.hasError,r.isComplete),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-medium",children:r.message}),s.jsx("div",{className:"text-sm text-muted-foreground",children:y(r.step)})]})]}),r.hasError&&r.error&&s.jsxs(Ze,{variant:"destructive",children:[s.jsx(Ns,{className:"h-4 w-4"}),s.jsx(pt,{children:r.error})]}),l?.migrationResult&&s.jsxs(Ze,{children:[s.jsx(gt,{className:"h-4 w-4"}),s.jsxs(pt,{children:["数据迁移完成: ",l.migrationResult.migratedCards," 张卡片, "," ",l.migrationResult.migratedFolders," 个文件夹, "," ",l.migrationResult.migratedTags," 个标签, "," ",l.migrationResult.migratedImages," 张图片"]})]}),l&&s.jsxs(Ze,{variant:l.fileSystemAccess?"default":"destructive",children:[s.jsx(Yt,{className:"h-4 w-4"}),s.jsx(pt,{children:l.fileSystemAccess?"文件系统访问权限已获得，支持本地文件存储":"未获得文件系统访问权限，将使用浏览器内置存储"})]}),s.jsxs("div",{className:"flex gap-2",children:[r.hasError&&s.jsxs(s.Fragment,{children:[s.jsx(H,{onClick:u,disabled:o,className:"flex-1",children:o?s.jsxs(s.Fragment,{children:[s.jsx(ze,{className:"h-4 w-4 mr-2 animate-spin"}),"重试中..."]}):"重试初始化"}),t&&s.jsx(H,{onClick:t,variant:"outline",className:"flex-1",children:"跳过初始化"})]}),l?.success&&s.jsxs(H,{onClick:()=>a(l),className:"flex-1",children:[s.jsx(gt,{className:"h-4 w-4 mr-2"}),"进入应用"]})]}),s.jsxs("div",{className:"text-xs text-muted-foreground text-center space-y-1",children:[s.jsx("p",{children:"首次启动需要初始化数据库和同步服务"}),s.jsx("p",{children:"如果有现有数据，将自动迁移到新的存储结构"})]})]})]})})}function gu(){const[a,e]=c.useState({isInitialized:!1,hasError:!1,canSkip:!1}),t=o=>{console.log("应用初始化完成:",o),e({isInitialized:!0,hasError:!1,canSkip:!1})},r=o=>{console.error("应用初始化失败:",o),e(i=>({...i,hasError:!0,error:o,canSkip:!0}))},n=()=>{console.warn("用户选择跳过初始化，应用将以降级模式运行"),e({isInitialized:!0,hasError:!0,canSkip:!1,error:"应用以降级模式运行，某些功能可能不可用"})};return!a.isInitialized||a.hasError&&!a.canSkip?s.jsx(mu,{onInitialized:t,onError:r,onSkipInitialization:a.canSkip?n:void 0}):a.hasError?s.jsx(ga,{initializationError:a.error}):s.jsx(ga,{})}ks.createRoot(document.getElementById("root")).render(s.jsx(U.StrictMode,{children:s.jsx(gu,{})}));
