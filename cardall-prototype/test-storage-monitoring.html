<!DOCTYPE html>
<html lang=\"zh-CN\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>存储监控功能测试</title>
    <script>
        // 模拟基本的环境
        window.global = window;
        window.process = { env: {} };
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .test-section h2 {
            color: #555;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .metric-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .metric-card h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #495057;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-entry.info {
            color: #007bff;
        }
        .log-entry.success {
            color: #28a745;
        }
        .log-entry.warning {
            color: #ffc107;
        }
        .log-entry.error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class=\"container\">
        <h1>存储监控功能测试</h1>

        <div id=\"app\">
            <!-- 基础测试 -->
            <div class=\"test-section\">
                <h2>基础功能测试</h2>
                <div class=\"controls\">
                    <button class=\"btn-primary\" onclick=\"startMonitoring()\">启动监控</button>
                    <button class=\"btn-danger\" onclick=\"stopMonitoring()\">停止监控</button>
                    <button class=\"btn-success\" onclick=\"getHealthStatus()\">获取健康状态</button>
                    <button class=\"btn-warning\" onclick=\"runDiagnostics()\">运行诊断</button>
                    <button class=\"btn-primary\" onclick=\"exportData()\">导出数据</button>
                </div>
                <div id=\"basic-status\"></div>
            </div>

            <!-- 操作测试 -->
            <div class=\"test-section\">
                <h2>存储操作测试</h2>
                <div class=\"controls\">
                    <button class=\"btn-primary\" onclick=\"simulateReadOperations()\">模拟读取操作</button>
                    <button class=\"btn-primary\" onclick=\"simulateWriteOperations()\">模拟写入操作</button>
                    <button class=\"btn-primary\" onclick=\"simulateErrorOperations()\">模拟错误操作</button>
                    <button class=\"btn-warning\" onclick=\"clearAllData()\">清除所有数据</button>
                </div>
                <div id=\"operation-status\"></div>
            </div>

            <!-- 性能指标 -->
            <div class=\"test-section\">
                <h2>性能指标</h2>
                <div class=\"controls\">
                    <button class=\"btn-success\" onclick=\"refreshMetrics()\">刷新指标</button>
                </div>
                <div id=\"metrics-container\"></div>
            </div>

            <!-- 事件日志 -->
            <div class=\"test-section\">
                <h2>事件日志</h2>
                <div class=\"controls\">
                    <button class=\"btn-warning\" onclick=\"clearLog()\">清除日志</button>
                </div>
                <div id=\"event-log\" class=\"log\"></div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let storageMonitor = null;
        let isMonitoring = false;

        // 日志系统
        function log(message, type = 'info') {
            const logContainer = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('event-log').innerHTML = '';
            log('日志已清除', 'info');
        }

        function showStatus(elementId, message, type = 'info') {
            const container = document.getElementById(elementId);
            container.innerHTML = `<div class=\"status status-${type}\">${message}</div>`;
        }

        // 模拟存储监控服务
        class MockStorageMonitor {
            constructor() {
                this.metrics = {
                    readOperations: 0,
                    writeOperations: 0,
                    deleteOperations: 0,
                    errorCount: 0,
                    averageReadTime: 0,
                    averageWriteTime: 0,
                    averageDeleteTime: 0,
                    totalDataSize: 0,
                    storageUtilization: 0,
                    successRate: 1,
                    errorRate: 0
                };
                this.events = [];
                this.issues = [];
                this.healthStatus = {
                    overall: 'good',
                    score: 85,
                    performance: 90,
                    reliability: 85,
                    availability: 80,
                    efficiency: 85,
                    issues: { critical: 0, warning: 0, info: 0 },
                    recommendations: ['系统运行正常']
                };
            }

            start() {
                isMonitoring = true;
                log('存储监控已启动', 'success');
                showStatus('basic-status', '监控已启动，正在收集数据...', 'success');

                // 模拟定期数据收集
                this.monitorInterval = setInterval(() => {
                    this.collectMetrics();
                }, 2000);
            }

            stop() {
                isMonitoring = false;
                if (this.monitorInterval) {
                    clearInterval(this.monitorInterval);
                }
                log('存储监控已停止', 'warning');
                showStatus('basic-status', '监控已停止', 'warning');
            }

            recordOperation(type, operation, duration, success, dataSize = 0, error = null) {
                const event = {
                    id: Date.now() + Math.random(),
                    type,
                    operation,
                    duration,
                    success,
                    dataSize,
                    error,
                    timestamp: new Date()
                };

                this.events.push(event);

                // 更新指标
                if (type === 'read') {
                    this.metrics.readOperations++;
                    this.metrics.averageReadTime = (this.metrics.averageReadTime + duration) / 2;
                } else if (type === 'write') {
                    this.metrics.writeOperations++;
                    this.metrics.averageWriteTime = (this.metrics.averageWriteTime + duration) / 2;
                    this.metrics.totalDataSize += dataSize;
                } else if (type === 'delete') {
                    this.metrics.deleteOperations++;
                    this.metrics.averageDeleteTime = (this.metrics.averageDeleteTime + duration) / 2;
                }

                if (!success) {
                    this.metrics.errorCount++;
                    this.recordIssue(operation, error || 'Unknown error');
                }

                // 更新成功率
                const totalOps = this.metrics.readOperations + this.metrics.writeOperations + this.metrics.deleteOperations;
                this.metrics.successRate = (totalOps - this.metrics.errorCount) / totalOps;
                this.metrics.errorRate = this.metrics.errorCount / totalOps;

                log(`记录操作: ${operation} (${type}) - ${success ? '成功' : '失败'} - ${duration}ms`, success ? 'success' : 'error');
            }

            recordIssue(operation, error) {
                const issue = {
                    id: Date.now() + Math.random(),
                    type: 'reliability',
                    severity: error.includes('critical') ? 'critical' : 'high',
                    title: `操作失败: ${operation}`,
                    description: error,
                    timestamp: new Date(),
                    resolved: false,
                    suggestions: ['检查网络连接', '重试操作', '检查存储空间']
                };

                this.issues.push(issue);
                log(`发现问题: ${issue.title} - ${issue.description}`, 'error');
            }

            collectMetrics() {
                // 模拟数据收集
                this.metrics.storageUtilization = Math.random() * 0.5 + 0.1; // 10-60%

                // 更新健康状态
                this.updateHealthStatus();

                log('收集监控指标', 'info');
            }

            updateHealthStatus() {
                const { successRate, errorCount, storageUtilization } = this.metrics;

                let score = 100;
                if (successRate < 0.95) score -= 20;
                if (errorCount > 5) score -= 15;
                if (storageUtilization > 0.8) score -= 25;

                this.healthStatus.score = Math.max(0, Math.min(100, score));

                if (score >= 90) this.healthStatus.overall = 'excellent';
                else if (score >= 75) this.healthStatus.overall = 'good';
                else if (score >= 60) this.healthStatus.overall = 'fair';
                else if (score >= 40) this.healthStatus.overall = 'poor';
                else this.healthStatus.overall = 'critical';

                this.healthStatus.issues.critical = this.issues.filter(i => i.severity === 'critical' && !i.resolved).length;
                this.healthStatus.issues.warning = this.issues.filter(i => i.severity === 'high' && !i.resolved).length;
            }

            getHealthStatus() {
                return this.healthStatus;
            }

            getMetrics() {
                return { ...this.metrics };
            }

            getEvents(hours = 24) {
                const cutoff = new Date(Date.now() - hours * 60 * 60 * 1000);
                return this.events.filter(e => e.timestamp >= cutoff);
            }

            getIssues(resolved = false) {
                return this.issues.filter(i => i.resolved === resolved);
            }

            async runDiagnostics() {
                log('开始运行诊断...', 'info');

                // 模拟诊断过程
                await new Promise(resolve => setTimeout(resolve, 2000));

                const report = {
                    id: Date.now(),
                    timestamp: new Date(),
                    duration: 2000,
                    summary: {
                        overallHealth: this.healthStatus.overall,
                        totalIssues: this.issues.length,
                        criticalIssues: this.healthStatus.issues.critical,
                        recommendations: ['系统运行正常']
                    },
                    analysis: {
                        performance: { overallScore: this.healthStatus.performance },
                        reliability: { overallScore: this.healthStatus.reliability },
                        availability: { overallScore: this.healthStatus.availability },
                        efficiency: { overallScore: this.healthStatus.efficiency }
                    },
                    issues: this.issues.filter(i => !i.resolved),
                    recommendations: [
                        {
                            id: '1',
                            priority: 'medium',
                            category: 'performance',
                            title: '优化性能',
                            description: '系统性能良好，建议继续保持',
                            impact: '提升用户体验',
                            effort: 'low',
                            steps: ['监控系统性能', '定期优化'],
                            expectedOutcome: '维持良好的系统性能'
                        }
                    ]
                };

                log('诊断完成', 'success');
                return report;
            }

            exportData() {
                const data = {
                    metrics: this.metrics,
                    events: this.events,
                    issues: this.issues,
                    healthStatus: this.healthStatus,
                    timestamp: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `storage-monitoring-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                log('数据已导出', 'success');
                return data;
            }

            clearAllData() {
                this.metrics = {
                    readOperations: 0,
                    writeOperations: 0,
                    deleteOperations: 0,
                    errorCount: 0,
                    averageReadTime: 0,
                    averageWriteTime: 0,
                    averageDeleteTime: 0,
                    totalDataSize: 0,
                    storageUtilization: 0,
                    successRate: 1,
                    errorRate: 0
                };
                this.events = [];
                this.issues = [];
                this.healthStatus = {
                    overall: 'excellent',
                    score: 100,
                    performance: 100,
                    reliability: 100,
                    availability: 100,
                    efficiency: 100,
                    issues: { critical: 0, warning: 0, info: 0 },
                    recommendations: ['系统已重置']
                };

                log('所有数据已清除', 'warning');
            }
        }

        // 初始化
        function init() {
            storageMonitor = new MockStorageMonitor();
            log('存储监控系统已初始化', 'success');
            showStatus('basic-status', '系统已初始化，点击"启动监控"开始', 'info');
        }

        // 基础功能
        function startMonitoring() {
            if (!isMonitoring) {
                storageMonitor.start();
            } else {
                log('监控已经在运行中', 'warning');
            }
        }

        function stopMonitoring() {
            if (isMonitoring) {
                storageMonitor.stop();
            } else {
                log('监控未运行', 'warning');
            }
        }

        function getHealthStatus() {
            const health = storageMonitor.getHealthStatus();
            const healthText = {
                'excellent': '优秀',
                'good': '良好',
                'fair': '一般',
                'poor': '较差',
                'critical': '严重'
            };

            const message = `
                健康状态: ${healthText[health.overall]} (${health.score}/100)
                性能: ${health.performance}/100
                可靠性: ${health.reliability}/100
                可用性: ${health.availability}/100
                效率: ${health.efficiency}/100
                问题: 严重(${health.issues.critical}) 警告(${health.issues.warning})
            `;

            showStatus('basic-status', message, health.overall === 'excellent' || health.overall === 'good' ? 'success' : 'warning');
            log(`健康状态检查: ${healthText[health.overall]}`, 'info');
        }

        async function runDiagnostics() {
            showStatus('basic-status', '正在运行诊断...', 'info');
            try {
                const report = await storageMonitor.runDiagnostics();
                const healthText = {
                    'excellent': '优秀',
                    'good': '良好',
                    'fair': '一般',
                    'poor': '较差',
                    'critical': '严重'
                };

                const message = `
                    诊断完成!
                    健康状态: ${healthText[report.summary.overallHealth]}
                    发现问题: ${report.summary.totalIssues} 个
                    严重问题: ${report.summary.criticalIssues} 个
                    诊断耗时: ${report.duration}ms
                `;

                showStatus('basic-status', message, 'success');
            } catch (error) {
                showStatus('basic-status', `诊断失败: ${error.message}`, 'error');
            }
        }

        function exportData() {
            try {
                storageMonitor.exportData();
                showStatus('basic-status', '数据导出成功', 'success');
            } catch (error) {
                showStatus('basic-status', `数据导出失败: ${error.message}`, 'error');
            }
        }

        // 操作测试
        function simulateReadOperations() {
            const operations = ['读取卡片', '读取文件夹', '读取标签', '读取设置'];

            operations.forEach(op => {
                const duration = Math.random() * 200 + 50; // 50-250ms
                const dataSize = Math.floor(Math.random() * 5000) + 100; // 100-5100 bytes
                storageMonitor.recordOperation('read', op, duration, true, dataSize);
            });

            showStatus('operation-status', '模拟读取操作已完成', 'success');
        }

        function simulateWriteOperations() {
            const operations = ['保存卡片', '保存文件夹', '保存标签', '更新设置'];

            operations.forEach(op => {
                const duration = Math.random() * 300 + 100; // 100-400ms
                const dataSize = Math.floor(Math.random() * 10000) + 500; // 500-10500 bytes
                storageMonitor.recordOperation('write', op, duration, true, dataSize);
            });

            showStatus('operation-status', '模拟写入操作已完成', 'success');
        }

        function simulateErrorOperations() {
            const operations = ['保存失败', '读取失败', '删除失败'];

            operations.forEach(op => {
                const duration = Math.random() * 500 + 200; // 200-700ms
                storageMonitor.recordOperation('write', op, duration, false, 0, '模拟的错误信息');
            });

            showStatus('operation-status', '模拟错误操作已完成', 'warning');
        }

        function clearAllData() {
            if (confirm('确定要清除所有监控数据吗？此操作不可撤销。')) {
                storageMonitor.clearAllData();
                showStatus('operation-status', '所有数据已清除', 'warning');
            }
        }

        // 性能指标
        function refreshMetrics() {
            const metrics = storageMonitor.getMetrics();

            const metricsHTML = `
                <div class=\"metrics\">
                    <div class=\"metric-card\">
                        <h3>读取操作</h3>
                        <div class=\"metric-value\">${metrics.readOperations}</div>
                        <small>平均时间: ${metrics.averageReadTime.toFixed(1)}ms</small>
                    </div>
                    <div class=\"metric-card\">
                        <h3>写入操作</h3>
                        <div class=\"metric-value\">${metrics.writeOperations}</div>
                        <small>平均时间: ${metrics.averageWriteTime.toFixed(1)}ms</small>
                    </div>
                    <div class=\"metric-card\">
                        <h3>删除操作</h3>
                        <div class=\"metric-value\">${metrics.deleteOperations}</div>
                        <small>平均时间: ${metrics.averageDeleteTime.toFixed(1)}ms</small>
                    </div>
                    <div class=\"metric-card\">
                        <h3>错误次数</h3>
                        <div class=\"metric-value\" style=\"color: ${metrics.errorCount > 0 ? '#dc3545' : '#28a745'}\">${metrics.errorCount}</div>
                    </div>
                    <div class=\"metric-card\">
                        <h3>成功率</h3>
                        <div class=\"metric-value\" style=\"color: ${metrics.successRate > 0.9 ? '#28a745' : '#ffc107'}\">${(metrics.successRate * 100).toFixed(1)}%</div>
                    </div>
                    <div class=\"metric-card\">
                        <h3>存储使用率</h3>
                        <div class=\"metric-value\" style=\"color: ${metrics.storageUtilization > 0.8 ? '#dc3545' : '#28a745'}\">${(metrics.storageUtilization * 100).toFixed(1)}%</div>
                    </div>
                    <div class=\"metric-card\">
                        <h3>总数据量</h3>
                        <div class=\"metric-value\">${(metrics.totalDataSize / 1024).toFixed(1)}KB</div>
                    </div>
                    <div class=\"metric-card\">
                        <h3>事件数量</h3>
                        <div class=\"metric-value\">${storageMonitor.getEvents().length}</div>
                    </div>
                </div>
            `;

            document.getElementById('metrics-container').innerHTML = metricsHTML;
            log('性能指标已刷新', 'info');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            init();
            refreshMetrics();
        });
    </script>
</body>
</html>