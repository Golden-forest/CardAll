<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge浏览器IndexedDB和存储权限测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #106ebe;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .storage-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .storage-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #0078d4;
        }
    </style>
</head>
<body>
    <h1>🔍 Edge浏览器IndexedDB和存储权限测试</h1>

    <div class="card">
        <h2>📊 浏览器支持检测</h2>
        <div id="browser-support"></div>
    </div>

    <div class="card">
        <h2>💾 存储权限检查</h2>
        <div id="storage-permissions"></div>
        <button onclick="checkStoragePermissions()">重新检查权限</button>
    </div>

    <div class="card">
        <h2>🧪 IndexedDB功能测试</h2>
        <div>
            <button onclick="testIndexedDB()">测试IndexedDB基本功能</button>
            <button onclick="testDexieLibrary()">测试Dexie库</button>
            <button onclick="testStorageQuota()">检查存储配额</button>
            <button onclick="clearTestData()">清除测试数据</button>
        </div>
        <div id="indexeddb-test"></div>
    </div>

    <div class="card">
        <h2>📋 存储使用情况</h2>
        <div id="storage-usage"></div>
        <button onclick="checkStorageUsage()">刷新存储信息</button>
    </div>

    <div class="card">
        <h2>🔧 开发者工具控制台命令</h2>
        <div class="info">
            <strong>在控制台中运行以下命令进行手动检查：</strong>
            <pre>// 检查IndexedDB支持
console.log('IndexedDB 支持:', 'indexedDB' in window);
console.log('IndexedDB 详细信息:', window.indexedDB);

// 检查存储估计
navigator.storage.estimate().then(estimate => {
    console.log('存储配额信息:', estimate);
});

// 检查持久化权限
navigator.storage.persisted().then(persisted => {
    console.log('持久化存储:', persisted);
});

// 列出所有数据库
window.indexedDB.databases().then(databases => {
    console.log('现有数据库:', databases);
});</pre>
        </div>
    </div>

    <div class="card">
        <h2>📝 实时日志</h2>
        <button onclick="clearLog()">清除日志</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        let testDB = null;

        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // 检查浏览器支持
        function checkBrowserSupport() {
            const supportDiv = document.getElementById('browser-support');
            const results = [];

            // 检查IndexedDB
            if ('indexedDB' in window) {
                results.push({ name: 'IndexedDB', status: '✅ 支持', details: `版本: ${window.indexedDB ? 'Available' : 'Unknown'}` });
            } else {
                results.push({ name: 'IndexedDB', status: '❌ 不支持', details: '网站将无法正常工作' });
            }

            // 检查Service Worker
            if ('serviceWorker' in navigator) {
                results.push({ name: 'Service Worker', status: '✅ 支持', details: '支持离线功能' });
            } else {
                results.push({ name: 'Service Worker', status: '❌ 不支持', details: '离线功能不可用' });
            }

            // 检查File System Access API
            if ('showOpenFilePicker' in window) {
                results.push({ name: 'File System Access API', status: '✅ 支持', details: '支持高级文件操作' });
            } else {
                results.push({ name: 'File System Access API', status: '❌ 不支持', details: '使用基本文件功能' });
            }

            // 检查存储管理API
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                results.push({ name: 'Storage API', status: '✅ 支持', details: '可以检查存储使用情况' });
            } else {
                results.push({ name: 'Storage API', status: '❌ 不支持', details: '无法检查存储使用情况' });
            }

            supportDiv.innerHTML = results.map(result => `
                <div class="status ${result.status.includes('✅') ? 'success' : 'error'}">
                    <strong>${result.name}:</strong> ${result.status}
                    <br><small>${result.details}</small>
                </div>
            `).join('');
        }

        // 检查存储权限
        async function checkStoragePermissions() {
            const permissionsDiv = document.getElementById('storage-permissions');
            permissionsDiv.innerHTML = '<div class="info">正在检查存储权限...</div>';

            try {
                // 检查持久化权限
                if ('storage' in navigator && 'persisted' in navigator.storage) {
                    const persisted = await navigator.storage.persisted();
                    const persistStatus = persisted ? '✅ 已持久化' : '⚠️ 未持久化';

                    permissionsDiv.innerHTML += `
                        <div class="status ${persisted ? 'success' : 'warning'}">
                            <strong>持久化存储状态:</strong> ${persistStatus}
                            <br><small>持久化存储意味着数据不会被浏览器自动清理</small>
                        </div>
                    `;
                }

                // 检查存储配额
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usage = estimate.usage || 0;
                    const quota = estimate.quota || 0;
                    const usagePercent = quota > 0 ? (usage / quota * 100).toFixed(2) : 0;

                    permissionsDiv.innerHTML += `
                        <div class="status info">
                            <strong>存储配额:</strong> ${formatBytes(usage)} / ${formatBytes(quota)} (${usagePercent}%)
                            <br><small>已使用 / 总配额</small>
                        </div>
                    `;
                }

                // 尝试请求持久化存储
                if ('storage' in navigator && 'persist' in navigator.storage) {
                    const persistButton = document.createElement('button');
                    persistButton.textContent = '请求持久化存储';
                    persistButton.onclick = async () => {
                        const isPersisted = await navigator.storage.persist();
                        log(`持久化存储请求: ${isPersisted ? '✅ 成功' : '❌ 被拒绝'}`);
                        checkStoragePermissions(); // 重新检查
                    };
                    permissionsDiv.appendChild(persistButton);
                }

            } catch (error) {
                permissionsDiv.innerHTML += `
                    <div class="status error">
                        <strong>权限检查失败:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // 测试IndexedDB基本功能
        async function testIndexedDB() {
            const testDiv = document.getElementById('indexeddb-test');
            testDiv.innerHTML = '<div class="info">正在测试IndexedDB基本功能...</div>';

            try {
                log('开始IndexedDB基本功能测试...');

                // 创建测试数据库
                const request = indexedDB.open('TestDatabase', 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('testStore')) {
                        db.createObjectStore('testStore', { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = async (event) => {
                    testDB = event.target.result;
                    log('✅ 测试数据库创建成功');

                    // 测试写入
                    const transaction = testDB.transaction(['testStore'], 'readwrite');
                    const store = transaction.objectStore('testStore');

                    const testData = { name: '测试数据', timestamp: new Date().toISOString() };
                    const addRequest = store.add(testData);

                    addRequest.onsuccess = () => {
                        log('✅ 数据写入成功');

                        // 测试读取
                        const getRequest = store.get(addRequest.result);
                        getRequest.onsuccess = () => {
                            log('✅ 数据读取成功: ' + JSON.stringify(getRequest.result));
                        };
                        getRequest.onerror = () => {
                            log('❌ 数据读取失败');
                        };
                    };

                    addRequest.onerror = () => {
                        log('❌ 数据写入失败');
                    };

                    transaction.oncomplete = () => {
                        testDiv.innerHTML += '<div class="status success">✅ IndexedDB基本功能测试通过</div>';
                    };
                };

                request.onerror = () => {
                    log('❌ 测试数据库创建失败');
                    testDiv.innerHTML += '<div class="status error">❌ IndexedDB基本功能测试失败</div>';
                };

            } catch (error) {
                log('❌ IndexedDB测试异常: ' + error.message);
                testDiv.innerHTML += `<div class="status error">❌ IndexedDB测试异常: ${error.message}</div>`;
            }
        }

        // 测试Dexie库
        async function testDexieLibrary() {
            const testDiv = document.getElementById('indexeddb-test');

            try {
                log('开始测试Dexie库...');

                // 动态导入Dexie
                const Dexie = await import('/node_modules/dexie/dist/dexie.min.js');

                class TestDB extends Dexie {
                    constructor() {
                        super('TestDexieDatabase');
                        this.version(1).stores({
                            friends: '++id, name, age'
                        });
                    }
                }

                const db = new TestDB();
                await db.open();
                log('✅ Dexie数据库创建成功');

                // 测试基本操作
                await db.friends.add({ name: '张三', age: 25 });
                log('✅ Dexie数据写入成功');

                const friends = await db.friends.toArray();
                log('✅ Dexie数据读取成功: ' + friends.length + ' 条记录');

                await db.delete();
                log('✅ Dexie数据库删除成功');

                testDiv.innerHTML += '<div class="status success">✅ Dexie库测试通过</div>';

            } catch (error) {
                log('❌ Dexie库测试失败: ' + error.message);
                testDiv.innerHTML += `<div class="status error">❌ Dexie库测试失败: ${error.message}</div>`;
            }
        }

        // 检查存储配额
        async function testStorageQuota() {
            const testDiv = document.getElementById('indexeddb-test');

            try {
                log('检查存储配额...');

                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usage = estimate.usage || 0;
                    const quota = estimate.quota || 0;
                    const usagePercent = quota > 0 ? (usage / quota * 100).toFixed(2) : 0;

                    log(`存储使用情况: ${formatBytes(usage)} / ${formatBytes(quota)} (${usagePercent}%)`);

                    testDiv.innerHTML += `
                        <div class="status info">
                            <strong>存储配额信息:</strong><br>
                            已使用: ${formatBytes(usage)}<br>
                            总配额: ${formatBytes(quota)}<br>
                            使用率: ${usagePercent}%<br>
                            <small>如果使用率接近100%，可能需要清理存储空间</small>
                        </div>
                    `;
                } else {
                    testDiv.innerHTML += '<div class="status warning">⚠️ 浏览器不支持存储配额检查</div>';
                }

            } catch (error) {
                testDiv.innerHTML += `<div class="status error">❌ 存储配额检查失败: ${error.message}</div>`;
            }
        }

        // 检查存储使用情况
        async function checkStorageUsage() {
            const usageDiv = document.getElementById('storage-usage');

            try {
                usageDiv.innerHTML = '<div class="info">正在检查存储使用情况...</div>';

                // 检查IndexedDB数据库
                if ('indexedDB' in window) {
                    const databases = await window.indexedDB.databases();
                    log(`发现 ${databases.length} 个IndexedDB数据库`);

                    let dbInfo = '<div class="storage-info">';
                    databases.forEach(db => {
                        dbInfo += `
                            <div class="storage-item">
                                <strong>📊 ${db.name}</strong><br>
                                版本: ${db.version || '未知'}<br>
                                <small>IndexedDB数据库</small>
                            </div>
                        `;
                    });
                    dbInfo += '</div>';
                    usageDiv.innerHTML += dbInfo;
                }

                // 检查LocalStorage
                const localStorageUsage = JSON.stringify(localStorage).length;
                usageDiv.innerHTML += `
                    <div class="storage-item">
                        <strong>💾 LocalStorage</strong><br>
                        大小: ${formatBytes(localStorageUsage)}<br>
                        项目数: ${localStorage.length}<br>
                        <small>本地存储数据</small>
                    </div>
                `;

                // 检查SessionStorage
                const sessionStorageUsage = JSON.stringify(sessionStorage).length;
                usageDiv.innerHTML += `
                    <div class="storage-item">
                        <strong>🔄 SessionStorage</strong><br>
                        大小: ${formatBytes(sessionStorageUsage)}<br>
                        项目数: ${sessionStorage.length}<br>
                        <small>会话存储数据</small>
                    </div>
                `;

            } catch (error) {
                usageDiv.innerHTML += `<div class="status error">❌ 存储使用情况检查失败: ${error.message}</div>`;
            }
        }

        // 清除测试数据
        async function clearTestData() {
            try {
                log('清除测试数据...');

                if (testDB) {
                    testDB.close();
                }

                // 删除测试数据库
                await new Promise((resolve, reject) => {
                    const request = indexedDB.deleteDatabase('TestDatabase');
                    request.onsuccess = resolve;
                    request.onerror = reject;
                });

                await new Promise((resolve, reject) => {
                    const request = indexedDB.deleteDatabase('TestDexieDatabase');
                    request.onsuccess = resolve;
                    request.onerror = reject;
                });

                log('✅ 测试数据已清除');

                // 重新检查存储使用情况
                checkStorageUsage();

            } catch (error) {
                log('❌ 清除测试数据失败: ' + error.message);
            }
        }

        // 格式化字节数
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // 页面加载完成后自动检查
        window.onload = function() {
            log('页面加载完成，开始自动检查...');
            checkBrowserSupport();
            checkStoragePermissions();
            checkStorageUsage();
            log('自动检查完成');
        };
    </script>
</body>
</html>