<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edgeæµè§ˆå™¨IndexedDBå’Œå­˜å‚¨æƒé™æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #106ebe;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .storage-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .storage-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #0078d4;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Edgeæµè§ˆå™¨IndexedDBå’Œå­˜å‚¨æƒé™æµ‹è¯•</h1>

    <div class="card">
        <h2>ğŸ“Š æµè§ˆå™¨æ”¯æŒæ£€æµ‹</h2>
        <div id="browser-support"></div>
    </div>

    <div class="card">
        <h2>ğŸ’¾ å­˜å‚¨æƒé™æ£€æŸ¥</h2>
        <div id="storage-permissions"></div>
        <button onclick="checkStoragePermissions()">é‡æ–°æ£€æŸ¥æƒé™</button>
    </div>

    <div class="card">
        <h2>ğŸ§ª IndexedDBåŠŸèƒ½æµ‹è¯•</h2>
        <div>
            <button onclick="testIndexedDB()">æµ‹è¯•IndexedDBåŸºæœ¬åŠŸèƒ½</button>
            <button onclick="testDexieLibrary()">æµ‹è¯•Dexieåº“</button>
            <button onclick="testStorageQuota()">æ£€æŸ¥å­˜å‚¨é…é¢</button>
            <button onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
        </div>
        <div id="indexeddb-test"></div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ å­˜å‚¨ä½¿ç”¨æƒ…å†µ</h2>
        <div id="storage-usage"></div>
        <button onclick="checkStorageUsage()">åˆ·æ–°å­˜å‚¨ä¿¡æ¯</button>
    </div>

    <div class="card">
        <h2>ğŸ”§ å¼€å‘è€…å·¥å…·æ§åˆ¶å°å‘½ä»¤</h2>
        <div class="info">
            <strong>åœ¨æ§åˆ¶å°ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ‰‹åŠ¨æ£€æŸ¥ï¼š</strong>
            <pre>// æ£€æŸ¥IndexedDBæ”¯æŒ
console.log('IndexedDB æ”¯æŒ:', 'indexedDB' in window);
console.log('IndexedDB è¯¦ç»†ä¿¡æ¯:', window.indexedDB);

// æ£€æŸ¥å­˜å‚¨ä¼°è®¡
navigator.storage.estimate().then(estimate => {
    console.log('å­˜å‚¨é…é¢ä¿¡æ¯:', estimate);
});

// æ£€æŸ¥æŒä¹…åŒ–æƒé™
navigator.storage.persisted().then(persisted => {
    console.log('æŒä¹…åŒ–å­˜å‚¨:', persisted);
});

// åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“
window.indexedDB.databases().then(databases => {
    console.log('ç°æœ‰æ•°æ®åº“:', databases);
});</pre>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“ å®æ—¶æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        let testDB = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        function checkBrowserSupport() {
            const supportDiv = document.getElementById('browser-support');
            const results = [];

            // æ£€æŸ¥IndexedDB
            if ('indexedDB' in window) {
                results.push({ name: 'IndexedDB', status: 'âœ… æ”¯æŒ', details: `ç‰ˆæœ¬: ${window.indexedDB ? 'Available' : 'Unknown'}` });
            } else {
                results.push({ name: 'IndexedDB', status: 'âŒ ä¸æ”¯æŒ', details: 'ç½‘ç«™å°†æ— æ³•æ­£å¸¸å·¥ä½œ' });
            }

            // æ£€æŸ¥Service Worker
            if ('serviceWorker' in navigator) {
                results.push({ name: 'Service Worker', status: 'âœ… æ”¯æŒ', details: 'æ”¯æŒç¦»çº¿åŠŸèƒ½' });
            } else {
                results.push({ name: 'Service Worker', status: 'âŒ ä¸æ”¯æŒ', details: 'ç¦»çº¿åŠŸèƒ½ä¸å¯ç”¨' });
            }

            // æ£€æŸ¥File System Access API
            if ('showOpenFilePicker' in window) {
                results.push({ name: 'File System Access API', status: 'âœ… æ”¯æŒ', details: 'æ”¯æŒé«˜çº§æ–‡ä»¶æ“ä½œ' });
            } else {
                results.push({ name: 'File System Access API', status: 'âŒ ä¸æ”¯æŒ', details: 'ä½¿ç”¨åŸºæœ¬æ–‡ä»¶åŠŸèƒ½' });
            }

            // æ£€æŸ¥å­˜å‚¨ç®¡ç†API
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                results.push({ name: 'Storage API', status: 'âœ… æ”¯æŒ', details: 'å¯ä»¥æ£€æŸ¥å­˜å‚¨ä½¿ç”¨æƒ…å†µ' });
            } else {
                results.push({ name: 'Storage API', status: 'âŒ ä¸æ”¯æŒ', details: 'æ— æ³•æ£€æŸ¥å­˜å‚¨ä½¿ç”¨æƒ…å†µ' });
            }

            supportDiv.innerHTML = results.map(result => `
                <div class="status ${result.status.includes('âœ…') ? 'success' : 'error'}">
                    <strong>${result.name}:</strong> ${result.status}
                    <br><small>${result.details}</small>
                </div>
            `).join('');
        }

        // æ£€æŸ¥å­˜å‚¨æƒé™
        async function checkStoragePermissions() {
            const permissionsDiv = document.getElementById('storage-permissions');
            permissionsDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥å­˜å‚¨æƒé™...</div>';

            try {
                // æ£€æŸ¥æŒä¹…åŒ–æƒé™
                if ('storage' in navigator && 'persisted' in navigator.storage) {
                    const persisted = await navigator.storage.persisted();
                    const persistStatus = persisted ? 'âœ… å·²æŒä¹…åŒ–' : 'âš ï¸ æœªæŒä¹…åŒ–';

                    permissionsDiv.innerHTML += `
                        <div class="status ${persisted ? 'success' : 'warning'}">
                            <strong>æŒä¹…åŒ–å­˜å‚¨çŠ¶æ€:</strong> ${persistStatus}
                            <br><small>æŒä¹…åŒ–å­˜å‚¨æ„å‘³ç€æ•°æ®ä¸ä¼šè¢«æµè§ˆå™¨è‡ªåŠ¨æ¸…ç†</small>
                        </div>
                    `;
                }

                // æ£€æŸ¥å­˜å‚¨é…é¢
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usage = estimate.usage || 0;
                    const quota = estimate.quota || 0;
                    const usagePercent = quota > 0 ? (usage / quota * 100).toFixed(2) : 0;

                    permissionsDiv.innerHTML += `
                        <div class="status info">
                            <strong>å­˜å‚¨é…é¢:</strong> ${formatBytes(usage)} / ${formatBytes(quota)} (${usagePercent}%)
                            <br><small>å·²ä½¿ç”¨ / æ€»é…é¢</small>
                        </div>
                    `;
                }

                // å°è¯•è¯·æ±‚æŒä¹…åŒ–å­˜å‚¨
                if ('storage' in navigator && 'persist' in navigator.storage) {
                    const persistButton = document.createElement('button');
                    persistButton.textContent = 'è¯·æ±‚æŒä¹…åŒ–å­˜å‚¨';
                    persistButton.onclick = async () => {
                        const isPersisted = await navigator.storage.persist();
                        log(`æŒä¹…åŒ–å­˜å‚¨è¯·æ±‚: ${isPersisted ? 'âœ… æˆåŠŸ' : 'âŒ è¢«æ‹’ç»'}`);
                        checkStoragePermissions(); // é‡æ–°æ£€æŸ¥
                    };
                    permissionsDiv.appendChild(persistButton);
                }

            } catch (error) {
                permissionsDiv.innerHTML += `
                    <div class="status error">
                        <strong>æƒé™æ£€æŸ¥å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // æµ‹è¯•IndexedDBåŸºæœ¬åŠŸèƒ½
        async function testIndexedDB() {
            const testDiv = document.getElementById('indexeddb-test');
            testDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•IndexedDBåŸºæœ¬åŠŸèƒ½...</div>';

            try {
                log('å¼€å§‹IndexedDBåŸºæœ¬åŠŸèƒ½æµ‹è¯•...');

                // åˆ›å»ºæµ‹è¯•æ•°æ®åº“
                const request = indexedDB.open('TestDatabase', 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('testStore')) {
                        db.createObjectStore('testStore', { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = async (event) => {
                    testDB = event.target.result;
                    log('âœ… æµ‹è¯•æ•°æ®åº“åˆ›å»ºæˆåŠŸ');

                    // æµ‹è¯•å†™å…¥
                    const transaction = testDB.transaction(['testStore'], 'readwrite');
                    const store = transaction.objectStore('testStore');

                    const testData = { name: 'æµ‹è¯•æ•°æ®', timestamp: new Date().toISOString() };
                    const addRequest = store.add(testData);

                    addRequest.onsuccess = () => {
                        log('âœ… æ•°æ®å†™å…¥æˆåŠŸ');

                        // æµ‹è¯•è¯»å–
                        const getRequest = store.get(addRequest.result);
                        getRequest.onsuccess = () => {
                            log('âœ… æ•°æ®è¯»å–æˆåŠŸ: ' + JSON.stringify(getRequest.result));
                        };
                        getRequest.onerror = () => {
                            log('âŒ æ•°æ®è¯»å–å¤±è´¥');
                        };
                    };

                    addRequest.onerror = () => {
                        log('âŒ æ•°æ®å†™å…¥å¤±è´¥');
                    };

                    transaction.oncomplete = () => {
                        testDiv.innerHTML += '<div class="status success">âœ… IndexedDBåŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡</div>';
                    };
                };

                request.onerror = () => {
                    log('âŒ æµ‹è¯•æ•°æ®åº“åˆ›å»ºå¤±è´¥');
                    testDiv.innerHTML += '<div class="status error">âŒ IndexedDBåŸºæœ¬åŠŸèƒ½æµ‹è¯•å¤±è´¥</div>';
                };

            } catch (error) {
                log('âŒ IndexedDBæµ‹è¯•å¼‚å¸¸: ' + error.message);
                testDiv.innerHTML += `<div class="status error">âŒ IndexedDBæµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•Dexieåº“
        async function testDexieLibrary() {
            const testDiv = document.getElementById('indexeddb-test');

            try {
                log('å¼€å§‹æµ‹è¯•Dexieåº“...');

                // åŠ¨æ€å¯¼å…¥Dexie
                const Dexie = await import('/node_modules/dexie/dist/dexie.min.js');

                class TestDB extends Dexie {
                    constructor() {
                        super('TestDexieDatabase');
                        this.version(1).stores({
                            friends: '++id, name, age'
                        });
                    }
                }

                const db = new TestDB();
                await db.open();
                log('âœ… Dexieæ•°æ®åº“åˆ›å»ºæˆåŠŸ');

                // æµ‹è¯•åŸºæœ¬æ“ä½œ
                await db.friends.add({ name: 'å¼ ä¸‰', age: 25 });
                log('âœ… Dexieæ•°æ®å†™å…¥æˆåŠŸ');

                const friends = await db.friends.toArray();
                log('âœ… Dexieæ•°æ®è¯»å–æˆåŠŸ: ' + friends.length + ' æ¡è®°å½•');

                await db.delete();
                log('âœ… Dexieæ•°æ®åº“åˆ é™¤æˆåŠŸ');

                testDiv.innerHTML += '<div class="status success">âœ… Dexieåº“æµ‹è¯•é€šè¿‡</div>';

            } catch (error) {
                log('âŒ Dexieåº“æµ‹è¯•å¤±è´¥: ' + error.message);
                testDiv.innerHTML += `<div class="status error">âŒ Dexieåº“æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥å­˜å‚¨é…é¢
        async function testStorageQuota() {
            const testDiv = document.getElementById('indexeddb-test');

            try {
                log('æ£€æŸ¥å­˜å‚¨é…é¢...');

                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usage = estimate.usage || 0;
                    const quota = estimate.quota || 0;
                    const usagePercent = quota > 0 ? (usage / quota * 100).toFixed(2) : 0;

                    log(`å­˜å‚¨ä½¿ç”¨æƒ…å†µ: ${formatBytes(usage)} / ${formatBytes(quota)} (${usagePercent}%)`);

                    testDiv.innerHTML += `
                        <div class="status info">
                            <strong>å­˜å‚¨é…é¢ä¿¡æ¯:</strong><br>
                            å·²ä½¿ç”¨: ${formatBytes(usage)}<br>
                            æ€»é…é¢: ${formatBytes(quota)}<br>
                            ä½¿ç”¨ç‡: ${usagePercent}%<br>
                            <small>å¦‚æœä½¿ç”¨ç‡æ¥è¿‘100%ï¼Œå¯èƒ½éœ€è¦æ¸…ç†å­˜å‚¨ç©ºé—´</small>
                        </div>
                    `;
                } else {
                    testDiv.innerHTML += '<div class="status warning">âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒå­˜å‚¨é…é¢æ£€æŸ¥</div>';
                }

            } catch (error) {
                testDiv.innerHTML += `<div class="status error">âŒ å­˜å‚¨é…é¢æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥å­˜å‚¨ä½¿ç”¨æƒ…å†µ
        async function checkStorageUsage() {
            const usageDiv = document.getElementById('storage-usage');

            try {
                usageDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥å­˜å‚¨ä½¿ç”¨æƒ…å†µ...</div>';

                // æ£€æŸ¥IndexedDBæ•°æ®åº“
                if ('indexedDB' in window) {
                    const databases = await window.indexedDB.databases();
                    log(`å‘ç° ${databases.length} ä¸ªIndexedDBæ•°æ®åº“`);

                    let dbInfo = '<div class="storage-info">';
                    databases.forEach(db => {
                        dbInfo += `
                            <div class="storage-item">
                                <strong>ğŸ“Š ${db.name}</strong><br>
                                ç‰ˆæœ¬: ${db.version || 'æœªçŸ¥'}<br>
                                <small>IndexedDBæ•°æ®åº“</small>
                            </div>
                        `;
                    });
                    dbInfo += '</div>';
                    usageDiv.innerHTML += dbInfo;
                }

                // æ£€æŸ¥LocalStorage
                const localStorageUsage = JSON.stringify(localStorage).length;
                usageDiv.innerHTML += `
                    <div class="storage-item">
                        <strong>ğŸ’¾ LocalStorage</strong><br>
                        å¤§å°: ${formatBytes(localStorageUsage)}<br>
                        é¡¹ç›®æ•°: ${localStorage.length}<br>
                        <small>æœ¬åœ°å­˜å‚¨æ•°æ®</small>
                    </div>
                `;

                // æ£€æŸ¥SessionStorage
                const sessionStorageUsage = JSON.stringify(sessionStorage).length;
                usageDiv.innerHTML += `
                    <div class="storage-item">
                        <strong>ğŸ”„ SessionStorage</strong><br>
                        å¤§å°: ${formatBytes(sessionStorageUsage)}<br>
                        é¡¹ç›®æ•°: ${sessionStorage.length}<br>
                        <small>ä¼šè¯å­˜å‚¨æ•°æ®</small>
                    </div>
                `;

            } catch (error) {
                usageDiv.innerHTML += `<div class="status error">âŒ å­˜å‚¨ä½¿ç”¨æƒ…å†µæ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ¸…é™¤æµ‹è¯•æ•°æ®
        async function clearTestData() {
            try {
                log('æ¸…é™¤æµ‹è¯•æ•°æ®...');

                if (testDB) {
                    testDB.close();
                }

                // åˆ é™¤æµ‹è¯•æ•°æ®åº“
                await new Promise((resolve, reject) => {
                    const request = indexedDB.deleteDatabase('TestDatabase');
                    request.onsuccess = resolve;
                    request.onerror = reject;
                });

                await new Promise((resolve, reject) => {
                    const request = indexedDB.deleteDatabase('TestDexieDatabase');
                    request.onsuccess = resolve;
                    request.onerror = reject;
                });

                log('âœ… æµ‹è¯•æ•°æ®å·²æ¸…é™¤');

                // é‡æ–°æ£€æŸ¥å­˜å‚¨ä½¿ç”¨æƒ…å†µ
                checkStorageUsage();

            } catch (error) {
                log('âŒ æ¸…é™¤æµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ ¼å¼åŒ–å­—èŠ‚æ•°
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æ£€æŸ¥...');
            checkBrowserSupport();
            checkStoragePermissions();
            checkStorageUsage();
            log('è‡ªåŠ¨æ£€æŸ¥å®Œæˆ');
        };
    </script>
</body>
</html>