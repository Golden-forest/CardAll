<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æŒä¹…æ€§ä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .results {
            font-family: monospace;
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .progress {
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ•°æ®æŒä¹…æ€§ä¿®å¤éªŒè¯æµ‹è¯•</h1>

        <div class="test-section">
            <h2>æµ‹è¯•ä»»åŠ¡1.1: UniversalStorageAdapterç¼ºå¤±æ–¹æ³•</h2>
            <button id="test-task1-1" onclick="testTask1_1()">æµ‹è¯•ç¼ºå¤±æ–¹æ³•</button>
            <div id="results-task1-1" class="results"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•ä»»åŠ¡1.2: æ•°æ®æºé€‰æ‹©é€»è¾‘ä¼˜åŒ–</h2>
            <button id="test-task1-2" onclick="testTask1_2()">æµ‹è¯•å­˜å‚¨æ¨¡å¼é€‰æ‹©</button>
            <div id="results-task1-2" class="results"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•ä»»åŠ¡1.3: æ•°æ®å®Œæ•´æ€§éªŒè¯</h2>
            <button id="test-task1-3" onclick="testTask1_3()">æµ‹è¯•æ•°æ®å®Œæ•´æ€§</button>
            <div id="results-task1-3" class="results"></div>
        </div>

        <div class="test-section">
            <h2>ç»¼åˆæµ‹è¯•</h2>
            <button id="test-all" onclick="testAll()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <div class="progress">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="progress-text">å‡†å¤‡å°±ç»ª</div>
            </div>
            <div id="results-all" class="results"></div>
        </div>

        <div class="test-section">
            <h2>åˆ›å»ºæµ‹è¯•æ•°æ®</h2>
            <button id="create-test-data" onclick="createTestData()">åˆ›å»ºæµ‹è¯•å¡ç‰‡</button>
            <button id="clear-test-data" onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
            <div id="results-data" class="results"></div>
        </div>
    </div>

    <script type="module">
        import { UniversalStorageAdapter } from './src/services/universal-storage-adapter.js'
        import { CardAllProviderAdapter } from './src/services/cardall-provider-adapter.js'
        import { CardAllProvider } from './src/contexts/cardall-provider.js'

        let storageAdapter = null
        let providerAdapter = null
        let testResults = {}

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId)
            const timestamp = new Date().toLocaleTimeString()
            const prefix = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'
            element.textContent += `${timestamp} ${prefix} ${message}\n`
            element.scrollTop = element.scrollHeight
            console.log(`[${type.toUpperCase()}] ${message}`)
        }

        function updateProgress(percent, text) {
            document.getElementById('progress-fill').style.width = `${percent}%`
            document.getElementById('progress-text').textContent = text
        }

        async function initializeAdapters() {
            try {
                if (!storageAdapter) {
                    storageAdapter = new UniversalStorageAdapter()
                }
                if (!providerAdapter) {
                    providerAdapter = CardAllProviderAdapter.getInstance(CardAllProvider)
                    await providerAdapter.initialize()
                }
                return true
            } catch (error) {
                log('results-all', `åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error')
                return false
            }
        }

        // æµ‹è¯•ä»»åŠ¡1.1: UniversalStorageAdapterç¼ºå¤±æ–¹æ³•
        async function testTask1_1() {
            const resultsElement = 'results-task1-1'
            log(resultsElement, 'å¼€å§‹æµ‹è¯•ä»»åŠ¡1.1: UniversalStorageAdapterç¼ºå¤±æ–¹æ³•')

            try {
                if (!await initializeAdapters()) return

                // æµ‹è¯• isIndexedDBAvailable
                log(resultsElement, 'æµ‹è¯• isIndexedDBAvailable()...')
                const indexedDBAvailable = await storageAdapter.isIndexedDBAvailable()
                log(resultsElement, `IndexedDB å¯ç”¨æ€§: ${indexedDBAvailable}`, indexedDBAvailable ? 'success' : 'warning')

                // æµ‹è¯• hasIndexedDBData
                log(resultsElement, 'æµ‹è¯• hasIndexedDBData()...')
                const hasIndexedDBData = await storageAdapter.hasIndexedDBData()
                log(resultsElement, `IndexedDB æ•°æ®å­˜åœ¨: ${hasIndexedDBData}`, hasIndexedDBData ? 'success' : 'info')

                testResults.task1_1 = {
                    indexedDBAvailable,
                    hasIndexedDBData,
                    success: true
                }

                log(resultsElement, 'âœ… ä»»åŠ¡1.1æµ‹è¯•å®Œæˆ!', 'success')

            } catch (error) {
                log(resultsElement, `âŒ ä»»åŠ¡1.1æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
                testResults.task1_1 = { success: false, error: error.message }
            }
        }

        // æµ‹è¯•ä»»åŠ¡1.2: æ•°æ®æºé€‰æ‹©é€»è¾‘ä¼˜åŒ–
        async function testTask1_2() {
            const resultsElement = 'results-task1-2'
            log(resultsElement, 'å¼€å§‹æµ‹è¯•ä»»åŠ¡1.2: æ•°æ®æºé€‰æ‹©é€»è¾‘ä¼˜åŒ–')

            try {
                if (!await initializeAdapters()) return

                // è·å–å½“å‰å­˜å‚¨æ¨¡å¼
                log(resultsElement, 'æ£€æŸ¥å½“å‰å­˜å‚¨æ¨¡å¼...')
                const state = providerAdapter.getState()
                log(resultsElement, `å½“å‰å­˜å‚¨æ¨¡å¼: ${state.storageMode}`, 'info')

                // æµ‹è¯•å­˜å‚¨æ¨¡å¼åˆ‡æ¢
                log(resultsElement, 'æµ‹è¯•å­˜å‚¨æ¨¡å¼åˆ‡æ¢...')
                const originalMode = state.storageMode

                // å°è¯•åˆ‡æ¢åˆ°IndexedDB
                if (originalMode !== 'indexeddb') {
                    log(resultsElement, 'å°è¯•åˆ‡æ¢åˆ°IndexedDB...')
                    await storageAdapter.setStorageMode('indexeddb')
                    log(resultsElement, 'å·²åˆ‡æ¢åˆ°IndexedDB', 'success')
                }

                // å°è¯•åˆ‡æ¢å›localStorage
                log(resultsElement, 'å°è¯•åˆ‡æ¢å›localStorage...')
                await storageAdapter.setStorageMode('localStorage')
                log(resultsElement, 'å·²åˆ‡æ¢å›localStorage', 'success')

                testResults.task1_2 = {
                    originalMode,
                    switchingWorks: true,
                    success: true
                }

                log(resultsElement, 'âœ… ä»»åŠ¡1.2æµ‹è¯•å®Œæˆ!', 'success')

            } catch (error) {
                log(resultsElement, `âŒ ä»»åŠ¡1.2æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
                testResults.task1_2 = { success: false, error: error.message }
            }
        }

        // æµ‹è¯•ä»»åŠ¡1.3: æ•°æ®å®Œæ•´æ€§éªŒè¯
        async function testTask1_3() {
            const resultsElement = 'results-task1-3'
            log(resultsElement, 'å¼€å§‹æµ‹è¯•ä»»åŠ¡1.3: æ•°æ®å®Œæ•´æ€§éªŒè¯')

            try {
                if (!await initializeAdapters()) return

                // æµ‹è¯•æ•°æ®å®Œæ•´æ€§éªŒè¯
                log(resultsElement, 'æµ‹è¯• validateDataIntegrity()...')
                const validation = await storageAdapter.validateDataIntegrity()
                log(resultsElement, `æ•°æ®å®Œæ•´æ€§éªŒè¯: ${validation.isValid ? 'é€šè¿‡' : 'å¤±è´¥'}`, validation.isValid ? 'success' : 'warning')
                log(resultsElement, `å‘ç° ${validation.issues.length} ä¸ªé—®é¢˜`)
                log(resultsElement, `å¡ç‰‡æ•°é‡: ${validation.cardCount}`)

                if (validation.issues.length > 0) {
                    validation.issues.forEach(issue => {
                        log(resultsElement, `é—®é¢˜: ${issue}`, 'warning')
                    })
                }

                // æµ‹è¯•æ•°æ®ä¿®å¤åŠŸèƒ½
                log(resultsElement, 'æµ‹è¯• repairDataIntegrity()...')
                const repair = await storageAdapter.repairDataIntegrity()
                log(resultsElement, `æ•°æ®ä¿®å¤: ${repair.repaired ? 'æˆåŠŸ' : 'å¤±è´¥'}`, repair.repaired ? 'success' : 'warning')
                log(resultsElement, `ä¿®å¤äº† ${repair.repairedCards} å¼ å¡ç‰‡`)

                if (repair.failedRepairs.length > 0) {
                    log(resultsElement, `ä¿®å¤å¤±è´¥çš„å¡ç‰‡: ${repair.failedRepairs.join(', ')}`, 'warning')
                }

                testResults.task1_3 = {
                    validation,
                    repair,
                    success: true
                }

                log(resultsElement, 'âœ… ä»»åŠ¡1.3æµ‹è¯•å®Œæˆ!', 'success')

            } catch (error) {
                log(resultsElement, `âŒ ä»»åŠ¡1.3æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
                testResults.task1_3 = { success: false, error: error.message }
            }
        }

        // ç»¼åˆæµ‹è¯•
        async function testAll() {
            const resultsElement = 'results-all'
            log(resultsElement, 'å¼€å§‹ç»¼åˆæµ‹è¯•...')
            updateProgress(0, 'åˆå§‹åŒ–...')

            try {
                updateProgress(10, 'æµ‹è¯•ä»»åŠ¡1.1...')
                await testTask1_1()
                updateProgress(40, 'æµ‹è¯•ä»»åŠ¡1.2...')
                await testTask1_2()
                updateProgress(70, 'æµ‹è¯•ä»»åŠ¡1.3...')
                await testTask1_3()
                updateProgress(90, 'ç”ŸæˆæŠ¥å‘Š...')

                // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
                const report = generateTestReport()
                log(resultsElement, '=== ç»¼åˆæµ‹è¯•æŠ¥å‘Š ===', 'success')
                log(resultsElement, report)

                updateProgress(100, 'æµ‹è¯•å®Œæˆ!')

                const allSuccess = Object.values(testResults).every(result => result.success)
                log(resultsElement, allSuccess ? 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡!' : 'âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥', allSuccess ? 'success' : 'warning')

            } catch (error) {
                log(resultsElement, `âŒ ç»¼åˆæµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
                updateProgress(100, 'æµ‹è¯•å¤±è´¥')
            }
        }

        function generateTestReport() {
            let report = ''

            if (testResults.task1_1) {
                report += `\nä»»åŠ¡1.1 - UniversalStorageAdapterç¼ºå¤±æ–¹æ³•: `
                report += testResults.task1_1.success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'
                if (testResults.task1_1.success) {
                    report += ` (IndexedDBå¯ç”¨: ${testResults.task1_1.indexedDBAvailable}, æ•°æ®å­˜åœ¨: ${testResults.task1_1.hasIndexedDBData})`
                }
            }

            if (testResults.task1_2) {
                report += `\nä»»åŠ¡1.2 - æ•°æ®æºé€‰æ‹©é€»è¾‘ä¼˜åŒ–: `
                report += testResults.task1_2.success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'
                if (testResults.task1_2.success) {
                    report += ` (åŸå§‹æ¨¡å¼: ${testResults.task1_2.originalMode}, åˆ‡æ¢åŠŸèƒ½: ${testResults.task1_2.switchingWorks ? 'æ­£å¸¸' : 'å¼‚å¸¸'})`
                }
            }

            if (testResults.task1_3) {
                report += `\nä»»åŠ¡1.3 - æ•°æ®å®Œæ•´æ€§éªŒè¯: `
                report += testResults.task1_3.success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'
                if (testResults.task1_3.success) {
                    report += ` (æ•°æ®å®Œæ•´: ${testResults.task1_3.validation.isValid}, ä¿®å¤åŠŸèƒ½: ${testResults.task1_3.repair.repaired ? 'æ­£å¸¸' : 'å¼‚å¸¸'})`
                }
            }

            return report
        }

        // åˆ›å»ºæµ‹è¯•æ•°æ®
        async function createTestData() {
            const resultsElement = 'results-data'
            log(resultsElement, 'åˆ›å»ºæµ‹è¯•æ•°æ®...')

            try {
                if (!await initializeAdapters()) return

                // åˆ›å»ºæµ‹è¯•å¡ç‰‡
                const testCard = {
                    frontContent: {
                        title: 'æµ‹è¯•å¡ç‰‡æ­£é¢',
                        text: 'è¿™æ˜¯æµ‹è¯•å¡ç‰‡çš„æ­£é¢å†…å®¹',
                        tags: ['æµ‹è¯•', 'ç¤ºä¾‹']
                    },
                    backContent: {
                        title: 'æµ‹è¯•å¡ç‰‡èƒŒé¢',
                        text: 'è¿™æ˜¯æµ‹è¯•å¡ç‰‡çš„èƒŒé¢å†…å®¹',
                        tags: ['æµ‹è¯•', 'èƒŒé¢']
                    },
                    style: { type: 'solid', color: '#007bff' },
                    isFlipped: false
                }

                const createdCard = await storageAdapter.createCard(testCard)
                log(resultsElement, `åˆ›å»ºæµ‹è¯•å¡ç‰‡æˆåŠŸ: ${createdCard.id}`, 'success')

                // åˆ›å»ºå¦ä¸€å¼ å¡ç‰‡
                const testCard2 = {
                    frontContent: {
                        title: 'ç¬¬äºŒå¼ æµ‹è¯•å¡ç‰‡',
                        text: 'è¿™æ˜¯ç¬¬äºŒå¼ æµ‹è¯•å¡ç‰‡',
                        tags: ['æµ‹è¯•2', 'ç¤ºä¾‹']
                    },
                    backContent: {
                        title: 'ç¬¬äºŒå¼ å¡ç‰‡èƒŒé¢',
                        text: 'ç¬¬äºŒå¼ å¡ç‰‡çš„èƒŒé¢å†…å®¹',
                        tags: ['æµ‹è¯•2', 'èƒŒé¢']
                    },
                    style: { type: 'gradient', colors: ['#ff6b6b', '#4ecdc4'] },
                    isFlipped: false
                }

                const createdCard2 = await storageAdapter.createCard(testCard2)
                log(resultsElement, `åˆ›å»ºç¬¬äºŒå¼ æµ‹è¯•å¡ç‰‡æˆåŠŸ: ${createdCard2.id}`, 'success')

                // è·å–æ‰€æœ‰å¡ç‰‡
                const allCards = await storageAdapter.getCards()
                log(resultsElement, `å½“å‰å…±æœ‰ ${allCards.length} å¼ å¡ç‰‡`, 'info')

            } catch (error) {
                log(resultsElement, `åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error')
            }
        }

        // æ¸…é™¤æµ‹è¯•æ•°æ®
        async function clearTestData() {
            const resultsElement = 'results-data'
            log(resultsElement, 'æ¸…é™¤æµ‹è¯•æ•°æ®...')

            try {
                if (!await initializeAdapters()) return

                const allCards = await storageAdapter.getCards()
                const testCardIds = allCards
                    .filter(card => card.frontContent.title.includes('æµ‹è¯•'))
                    .map(card => card.id)

                if (testCardIds.length > 0) {
                    await storageAdapter.deleteCards(testCardIds)
                    log(resultsElement, `åˆ é™¤äº† ${testCardIds.length} å¼ æµ‹è¯•å¡ç‰‡`, 'success')
                } else {
                    log(resultsElement, 'æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•å¡ç‰‡', 'info')
                }

                const remainingCards = await storageAdapter.getCards()
                log(resultsElement, `å‰©ä½™ ${remainingCards.length} å¼ å¡ç‰‡`, 'info')

            } catch (error) {
                log(resultsElement, `æ¸…é™¤æµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error')
            }
        }

        // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.testTask1_1 = testTask1_1
        window.testTask1_2 = testTask1_2
        window.testTask1_3 = testTask1_3
        window.testAll = testAll
        window.createTestData = createTestData
        window.clearTestData = clearTestData

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            log('results-all', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•...')
            await initializeAdapters()
            if (storageAdapter && providerAdapter) {
                log('results-all', 'âœ… é€‚é…å™¨åˆå§‹åŒ–æˆåŠŸ!', 'success')
            }
        })
    </script>
</body>
</html>