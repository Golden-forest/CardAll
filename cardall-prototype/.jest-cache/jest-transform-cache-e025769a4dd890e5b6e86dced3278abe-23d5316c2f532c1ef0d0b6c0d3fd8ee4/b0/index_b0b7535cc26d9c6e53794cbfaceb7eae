f93d96cf6ff54fcb3d446ee7e08bf58e
"use strict";
/*!
 * /**
 *  * Copyright (c) Meta Platforms, Inc. and affiliates.
 *  *
 *  * This source code is licensed under the MIT license found in the
 *  * LICENSE file in the root directory of this source tree.
 *  * /
 */
/******/ (() => {
    /******/ "use strict";
    var __webpack_exports__ = {};
    // This entry needs to be wrapped in an IIFE because it uses a non-standard name for the exports (exports).
    (() => {
        var exports = __webpack_exports__;
        Object.defineProperty(exports, "__esModule", ({
            value: true
        }));
        exports["default"] = void 0;
        function _fakeTimers() {
            const data = require("@jest/fake-timers");
            _fakeTimers = function () {
                return data;
            };
            return data;
        }
        function _jestMock() {
            const data = require("jest-mock");
            _jestMock = function () {
                return data;
            };
            return data;
        }
        function _jestUtil() {
            const data = require("jest-util");
            _jestUtil = function () {
                return data;
            };
            return data;
        }
        /**
         * Copyright (c) Meta Platforms, Inc. and affiliates.
         *
         * This source code is licensed under the MIT license found in the
         * LICENSE file in the root directory of this source tree.
         */
        // The `Window` interface does not have an `Error.stackTraceLimit` property, but
        // `JSDOMEnvironment` assumes it is there.
        function isString(value) {
            return typeof value === 'string';
        }
        class BaseJSDOMEnvironment {
            constructor(config, context, jsdomModule) {
                Object.defineProperty(this, "dom", {
                    enumerable: true,
                    configurable: true,
                    writable: true,
                    value: void 0
                });
                Object.defineProperty(this, "fakeTimers", {
                    enumerable: true,
                    configurable: true,
                    writable: true,
                    value: void 0
                });
                Object.defineProperty(this, "fakeTimersModern", {
                    enumerable: true,
                    configurable: true,
                    writable: true,
                    value: void 0
                });
                Object.defineProperty(this, "global", {
                    enumerable: true,
                    configurable: true,
                    writable: true,
                    value: void 0
                });
                Object.defineProperty(this, "errorEventListener", {
                    enumerable: true,
                    configurable: true,
                    writable: true,
                    value: void 0
                });
                Object.defineProperty(this, "moduleMocker", {
                    enumerable: true,
                    configurable: true,
                    writable: true,
                    value: void 0
                });
                Object.defineProperty(this, "customExportConditions", {
                    enumerable: true,
                    configurable: true,
                    writable: true,
                    value: ['browser']
                });
                Object.defineProperty(this, "_configuredExportConditions", {
                    enumerable: true,
                    configurable: true,
                    writable: true,
                    value: void 0
                });
                const { projectConfig } = config;
                const { JSDOM, ResourceLoader, VirtualConsole } = jsdomModule;
                const virtualConsole = new VirtualConsole();
                virtualConsole.sendTo(context.console, {
                    omitJSDOMErrors: true
                });
                virtualConsole.on('jsdomError', error => {
                    context.console.error(error);
                });
                this.dom = new JSDOM(typeof projectConfig.testEnvironmentOptions.html === 'string' ? projectConfig.testEnvironmentOptions.html : '<!DOCTYPE html>', {
                    pretendToBeVisual: true,
                    resources: typeof projectConfig.testEnvironmentOptions.userAgent === 'string' ? new ResourceLoader({
                        userAgent: projectConfig.testEnvironmentOptions.userAgent
                    }) : undefined,
                    runScripts: 'dangerously',
                    url: 'http://localhost/',
                    virtualConsole,
                    ...projectConfig.testEnvironmentOptions
                });
                const global = this.global = this.dom.window;
                if (global == null) {
                    throw new Error('JSDOM did not return a Window object');
                }
                // TODO: remove at some point - for "universal" code (code should use `globalThis`)
                global.global = global;
                // Node's error-message stack size is limited at 10, but it's pretty useful
                // to see more than that when a test fails.
                this.global.Error.stackTraceLimit = 100;
                (0, _jestUtil().installCommonGlobals)(global, projectConfig.globals);
                // TODO: remove this ASAP, but it currently causes tests to run really slow
                global.Buffer = Buffer;
                // Report uncaught errors.
                this.errorEventListener = event => {
                    if (userErrorListenerCount === 0 && event.error != null) {
                        process.emit('uncaughtException', event.error);
                    }
                };
                global.addEventListener('error', this.errorEventListener);
                // However, don't report them as uncaught if the user listens to 'error' event.
                // In that case, we assume the might have custom error handling logic.
                const originalAddListener = global.addEventListener.bind(global);
                const originalRemoveListener = global.removeEventListener.bind(global);
                let userErrorListenerCount = 0;
                global.addEventListener = function (...args) {
                    if (args[0] === 'error') {
                        userErrorListenerCount++;
                    }
                    return originalAddListener.apply(this, args);
                };
                global.removeEventListener = function (...args) {
                    if (args[0] === 'error') {
                        userErrorListenerCount--;
                    }
                    return originalRemoveListener.apply(this, args);
                };
                if ('customExportConditions' in projectConfig.testEnvironmentOptions) {
                    const { customExportConditions } = projectConfig.testEnvironmentOptions;
                    if (Array.isArray(customExportConditions) && customExportConditions.every(isString)) {
                        this._configuredExportConditions = customExportConditions;
                    }
                    else {
                        throw new Error('Custom export conditions specified but they are not an array of strings');
                    }
                }
                this.moduleMocker = new (_jestMock().ModuleMocker)(global);
                this.fakeTimers = new (_fakeTimers().LegacyFakeTimers)({
                    config: projectConfig,
                    global: global,
                    moduleMocker: this.moduleMocker,
                    timerConfig: {
                        idToRef: id => id,
                        refToId: ref => ref
                    }
                });
                this.fakeTimersModern = new (_fakeTimers().ModernFakeTimers)({
                    config: projectConfig,
                    global: global
                });
            }
            // eslint-disable-next-line @typescript-eslint/no-empty-function
            async setup() { }
            async teardown() {
                if (this.fakeTimers) {
                    this.fakeTimers.dispose();
                }
                if (this.fakeTimersModern) {
                    this.fakeTimersModern.dispose();
                }
                if (this.global != null) {
                    if (this.errorEventListener) {
                        this.global.removeEventListener('error', this.errorEventListener);
                    }
                    this.global.close();
                }
                this.errorEventListener = null;
                // @ts-expect-error: this.global not allowed to be `null`
                this.global = null;
                this.dom = null;
                this.fakeTimers = null;
                this.fakeTimersModern = null;
            }
            exportConditions() {
                return this._configuredExportConditions ?? this.customExportConditions;
            }
            getVmContext() {
                if (this.dom) {
                    return this.dom.getInternalVMContext();
                }
                return null;
            }
        }
        exports["default"] = BaseJSDOMEnvironment;
    })();
    module.exports = __webpack_exports__;
    /******/ 
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRDpcXFByb2plY3RzXFxDYXJkRXZlcnl0aGluZ1xcY2FyZGFsbC1wcm90b3R5cGVcXG5vZGVfbW9kdWxlc1xcQGplc3RcXGVudmlyb25tZW50LWpzZG9tLWFic3RyYWN0XFxidWlsZFxcaW5kZXguanMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7O0dBT0c7QUFDSCxRQUFRLENBQUMsQ0FBQyxHQUFHLEVBQUU7SUFDZixRQUFRLENBQUUsWUFBWSxDQUFDO0lBQ3ZCLElBQUksbUJBQW1CLEdBQUcsRUFBRSxDQUFDO0lBQzdCLDJHQUEyRztJQUMzRyxDQUFDLEdBQUcsRUFBRTtRQUNOLElBQUksT0FBTyxHQUFHLG1CQUFtQixDQUFDO1FBR2xDLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFlBQVksRUFBRSxDQUFDO1lBQzVDLEtBQUssRUFBRSxJQUFJO1NBQ1osQ0FBQyxDQUFDLENBQUM7UUFDSixPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFDNUIsU0FBUyxXQUFXO1lBQ2xCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQzFDLFdBQVcsR0FBRztnQkFDWixPQUFPLElBQUksQ0FBQztZQUNkLENBQUMsQ0FBQztZQUNGLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUNELFNBQVMsU0FBUztZQUNoQixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDbEMsU0FBUyxHQUFHO2dCQUNWLE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQyxDQUFDO1lBQ0YsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBQ0QsU0FBUyxTQUFTO1lBQ2hCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNsQyxTQUFTLEdBQUc7Z0JBQ1YsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDLENBQUM7WUFDRixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFDRDs7Ozs7V0FLRztRQUVILGdGQUFnRjtRQUNoRiwwQ0FBMEM7UUFFMUMsU0FBUyxRQUFRLENBQUMsS0FBSztZQUNyQixPQUFPLE9BQU8sS0FBSyxLQUFLLFFBQVEsQ0FBQztRQUNuQyxDQUFDO1FBQ0QsTUFBTSxvQkFBb0I7WUFTeEIsWUFBWSxNQUFNLEVBQUUsT0FBTyxFQUFFLFdBQVc7Z0JBUnhDOzs7OzttQkFBSTtnQkFDSjs7Ozs7bUJBQVc7Z0JBQ1g7Ozs7O21CQUFpQjtnQkFDakI7Ozs7O21CQUFPO2dCQUNQOzs7OzttQkFBbUI7Z0JBQ25COzs7OzttQkFBYTtnQkFDYjs7OzsyQkFBeUIsQ0FBQyxTQUFTLENBQUM7bUJBQUM7Z0JBQ3JDOzs7OzttQkFBNEI7Z0JBRTFCLE1BQU0sRUFDSixhQUFhLEVBQ2QsR0FBRyxNQUFNLENBQUM7Z0JBQ1gsTUFBTSxFQUNKLEtBQUssRUFDTCxjQUFjLEVBQ2QsY0FBYyxFQUNmLEdBQUcsV0FBVyxDQUFDO2dCQUNoQixNQUFNLGNBQWMsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO2dCQUM1QyxjQUFjLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7b0JBQ3JDLGVBQWUsRUFBRSxJQUFJO2lCQUN0QixDQUFDLENBQUM7Z0JBQ0gsY0FBYyxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLEVBQUU7b0JBQ3RDLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUMvQixDQUFDLENBQUMsQ0FBQztnQkFDSCxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sYUFBYSxDQUFDLHNCQUFzQixDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixFQUFFO29CQUNsSixpQkFBaUIsRUFBRSxJQUFJO29CQUN2QixTQUFTLEVBQUUsT0FBTyxhQUFhLENBQUMsc0JBQXNCLENBQUMsU0FBUyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxjQUFjLENBQUM7d0JBQ2pHLFNBQVMsRUFBRSxhQUFhLENBQUMsc0JBQXNCLENBQUMsU0FBUztxQkFDMUQsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTO29CQUNkLFVBQVUsRUFBRSxhQUFhO29CQUN6QixHQUFHLEVBQUUsbUJBQW1CO29CQUN4QixjQUFjO29CQUNkLEdBQUcsYUFBYSxDQUFDLHNCQUFzQjtpQkFDeEMsQ0FBQyxDQUFDO2dCQUNILE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7Z0JBQzdDLElBQUksTUFBTSxJQUFJLElBQUksRUFBRSxDQUFDO29CQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7Z0JBQzFELENBQUM7Z0JBRUQsbUZBQW1GO2dCQUNuRixNQUFNLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztnQkFFdkIsMkVBQTJFO2dCQUMzRSwyQ0FBMkM7Z0JBQzNDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGVBQWUsR0FBRyxHQUFHLENBQUM7Z0JBQ3hDLENBQUMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLG9CQUFvQixDQUFDLENBQUMsTUFBTSxFQUFFLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFFckUsMkVBQTJFO2dCQUMzRSxNQUFNLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztnQkFFdkIsMEJBQTBCO2dCQUMxQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDLEVBQUU7b0JBQ2hDLElBQUksc0JBQXNCLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxLQUFLLElBQUksSUFBSSxFQUFFLENBQUM7d0JBQ3hELE9BQU8sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUNqRCxDQUFDO2dCQUNILENBQUMsQ0FBQztnQkFDRixNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2dCQUUxRCwrRUFBK0U7Z0JBQy9FLHNFQUFzRTtnQkFDdEUsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNqRSxNQUFNLHNCQUFzQixHQUFHLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3ZFLElBQUksc0JBQXNCLEdBQUcsQ0FBQyxDQUFDO2dCQUMvQixNQUFNLENBQUMsZ0JBQWdCLEdBQUcsVUFBVSxHQUFHLElBQUk7b0JBQ3pDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLE9BQU8sRUFBRSxDQUFDO3dCQUN4QixzQkFBc0IsRUFBRSxDQUFDO29CQUMzQixDQUFDO29CQUNELE9BQU8sbUJBQW1CLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDL0MsQ0FBQyxDQUFDO2dCQUNGLE1BQU0sQ0FBQyxtQkFBbUIsR0FBRyxVQUFVLEdBQUcsSUFBSTtvQkFDNUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssT0FBTyxFQUFFLENBQUM7d0JBQ3hCLHNCQUFzQixFQUFFLENBQUM7b0JBQzNCLENBQUM7b0JBQ0QsT0FBTyxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNsRCxDQUFDLENBQUM7Z0JBQ0YsSUFBSSx3QkFBd0IsSUFBSSxhQUFhLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztvQkFDckUsTUFBTSxFQUNKLHNCQUFzQixFQUN2QixHQUFHLGFBQWEsQ0FBQyxzQkFBc0IsQ0FBQztvQkFDekMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLHNCQUFzQixDQUFDLElBQUksc0JBQXNCLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7d0JBQ3BGLElBQUksQ0FBQywyQkFBMkIsR0FBRyxzQkFBc0IsQ0FBQztvQkFDNUQsQ0FBQzt5QkFBTSxDQUFDO3dCQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMseUVBQXlFLENBQUMsQ0FBQztvQkFDN0YsQ0FBQztnQkFDSCxDQUFDO2dCQUNELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLFlBQVksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUMzRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO29CQUNyRCxNQUFNLEVBQUUsYUFBYTtvQkFDckIsTUFBTSxFQUFFLE1BQU07b0JBQ2QsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO29CQUMvQixXQUFXLEVBQUU7d0JBQ1gsT0FBTyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRTt3QkFDakIsT0FBTyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRztxQkFDcEI7aUJBQ0YsQ0FBQyxDQUFDO2dCQUNILElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztvQkFDM0QsTUFBTSxFQUFFLGFBQWE7b0JBQ3JCLE1BQU0sRUFBRSxNQUFNO2lCQUNmLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxnRUFBZ0U7WUFDaEUsS0FBSyxDQUFDLEtBQUssS0FBSSxDQUFDO1lBQ2hCLEtBQUssQ0FBQyxRQUFRO2dCQUNaLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO29CQUNwQixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUM1QixDQUFDO2dCQUNELElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7b0JBQzFCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDbEMsQ0FBQztnQkFDRCxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxFQUFFLENBQUM7b0JBQ3hCLElBQUksSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7d0JBQzVCLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO29CQUNwRSxDQUFDO29CQUNELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ3RCLENBQUM7Z0JBQ0QsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztnQkFDL0IseURBQXlEO2dCQUN6RCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztnQkFDbkIsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUM7Z0JBQ2hCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO2dCQUN2QixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1lBQy9CLENBQUM7WUFDRCxnQkFBZ0I7Z0JBQ2QsT0FBTyxJQUFJLENBQUMsMkJBQTJCLElBQUksSUFBSSxDQUFDLHNCQUFzQixDQUFDO1lBQ3pFLENBQUM7WUFDRCxZQUFZO2dCQUNWLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO29CQUNiLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO2dCQUN6QyxDQUFDO2dCQUNELE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQztTQUNGO1FBQ0QsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLG9CQUFvQixDQUFDO0lBQzFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFFTCxNQUFNLENBQUMsT0FBTyxHQUFHLG1CQUFtQixDQUFDO0lBQ3JDLFFBQVE7QUFBQyxDQUFDLENBQUMsRUFBRSxDQUNaIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkQ6XFxQcm9qZWN0c1xcQ2FyZEV2ZXJ5dGhpbmdcXGNhcmRhbGwtcHJvdG90eXBlXFxub2RlX21vZHVsZXNcXEBqZXN0XFxlbnZpcm9ubWVudC1qc2RvbS1hYnN0cmFjdFxcYnVpbGRcXGluZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogLyoqXG4gKiAgKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLlxuICogICpcbiAqICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICogICogL1xuICovXG4vKioqKioqLyAoKCkgPT4geyAvLyB3ZWJwYWNrQm9vdHN0cmFwXG4vKioqKioqLyBcdFwidXNlIHN0cmljdFwiO1xudmFyIF9fd2VicGFja19leHBvcnRzX18gPSB7fTtcbi8vIFRoaXMgZW50cnkgbmVlZHMgdG8gYmUgd3JhcHBlZCBpbiBhbiBJSUZFIGJlY2F1c2UgaXQgdXNlcyBhIG5vbi1zdGFuZGFyZCBuYW1lIGZvciB0aGUgZXhwb3J0cyAoZXhwb3J0cykuXG4oKCkgPT4ge1xudmFyIGV4cG9ydHMgPSBfX3dlYnBhY2tfZXhwb3J0c19fO1xuXG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgKHtcbiAgdmFsdWU6IHRydWVcbn0pKTtcbmV4cG9ydHNbXCJkZWZhdWx0XCJdID0gdm9pZCAwO1xuZnVuY3Rpb24gX2Zha2VUaW1lcnMoKSB7XG4gIGNvbnN0IGRhdGEgPSByZXF1aXJlKFwiQGplc3QvZmFrZS10aW1lcnNcIik7XG4gIF9mYWtlVGltZXJzID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuICByZXR1cm4gZGF0YTtcbn1cbmZ1bmN0aW9uIF9qZXN0TW9jaygpIHtcbiAgY29uc3QgZGF0YSA9IHJlcXVpcmUoXCJqZXN0LW1vY2tcIik7XG4gIF9qZXN0TW9jayA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcbiAgcmV0dXJuIGRhdGE7XG59XG5mdW5jdGlvbiBfamVzdFV0aWwoKSB7XG4gIGNvbnN0IGRhdGEgPSByZXF1aXJlKFwiamVzdC11dGlsXCIpO1xuICBfamVzdFV0aWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG4gIHJldHVybiBkYXRhO1xufVxuLyoqXG4gKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbi8vIFRoZSBgV2luZG93YCBpbnRlcmZhY2UgZG9lcyBub3QgaGF2ZSBhbiBgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0YCBwcm9wZXJ0eSwgYnV0XG4vLyBgSlNET01FbnZpcm9ubWVudGAgYXNzdW1lcyBpdCBpcyB0aGVyZS5cblxuZnVuY3Rpb24gaXNTdHJpbmcodmFsdWUpIHtcbiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZyc7XG59XG5jbGFzcyBCYXNlSlNET01FbnZpcm9ubWVudCB7XG4gIGRvbTtcbiAgZmFrZVRpbWVycztcbiAgZmFrZVRpbWVyc01vZGVybjtcbiAgZ2xvYmFsO1xuICBlcnJvckV2ZW50TGlzdGVuZXI7XG4gIG1vZHVsZU1vY2tlcjtcbiAgY3VzdG9tRXhwb3J0Q29uZGl0aW9ucyA9IFsnYnJvd3NlciddO1xuICBfY29uZmlndXJlZEV4cG9ydENvbmRpdGlvbnM7XG4gIGNvbnN0cnVjdG9yKGNvbmZpZywgY29udGV4dCwganNkb21Nb2R1bGUpIHtcbiAgICBjb25zdCB7XG4gICAgICBwcm9qZWN0Q29uZmlnXG4gICAgfSA9IGNvbmZpZztcbiAgICBjb25zdCB7XG4gICAgICBKU0RPTSxcbiAgICAgIFJlc291cmNlTG9hZGVyLFxuICAgICAgVmlydHVhbENvbnNvbGVcbiAgICB9ID0ganNkb21Nb2R1bGU7XG4gICAgY29uc3QgdmlydHVhbENvbnNvbGUgPSBuZXcgVmlydHVhbENvbnNvbGUoKTtcbiAgICB2aXJ0dWFsQ29uc29sZS5zZW5kVG8oY29udGV4dC5jb25zb2xlLCB7XG4gICAgICBvbWl0SlNET01FcnJvcnM6IHRydWVcbiAgICB9KTtcbiAgICB2aXJ0dWFsQ29uc29sZS5vbignanNkb21FcnJvcicsIGVycm9yID0+IHtcbiAgICAgIGNvbnRleHQuY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgfSk7XG4gICAgdGhpcy5kb20gPSBuZXcgSlNET00odHlwZW9mIHByb2plY3RDb25maWcudGVzdEVudmlyb25tZW50T3B0aW9ucy5odG1sID09PSAnc3RyaW5nJyA/IHByb2plY3RDb25maWcudGVzdEVudmlyb25tZW50T3B0aW9ucy5odG1sIDogJzwhRE9DVFlQRSBodG1sPicsIHtcbiAgICAgIHByZXRlbmRUb0JlVmlzdWFsOiB0cnVlLFxuICAgICAgcmVzb3VyY2VzOiB0eXBlb2YgcHJvamVjdENvbmZpZy50ZXN0RW52aXJvbm1lbnRPcHRpb25zLnVzZXJBZ2VudCA9PT0gJ3N0cmluZycgPyBuZXcgUmVzb3VyY2VMb2FkZXIoe1xuICAgICAgICB1c2VyQWdlbnQ6IHByb2plY3RDb25maWcudGVzdEVudmlyb25tZW50T3B0aW9ucy51c2VyQWdlbnRcbiAgICAgIH0pIDogdW5kZWZpbmVkLFxuICAgICAgcnVuU2NyaXB0czogJ2Rhbmdlcm91c2x5JyxcbiAgICAgIHVybDogJ2h0dHA6Ly9sb2NhbGhvc3QvJyxcbiAgICAgIHZpcnR1YWxDb25zb2xlLFxuICAgICAgLi4ucHJvamVjdENvbmZpZy50ZXN0RW52aXJvbm1lbnRPcHRpb25zXG4gICAgfSk7XG4gICAgY29uc3QgZ2xvYmFsID0gdGhpcy5nbG9iYWwgPSB0aGlzLmRvbS53aW5kb3c7XG4gICAgaWYgKGdsb2JhbCA9PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0pTRE9NIGRpZCBub3QgcmV0dXJuIGEgV2luZG93IG9iamVjdCcpO1xuICAgIH1cblxuICAgIC8vIFRPRE86IHJlbW92ZSBhdCBzb21lIHBvaW50IC0gZm9yIFwidW5pdmVyc2FsXCIgY29kZSAoY29kZSBzaG91bGQgdXNlIGBnbG9iYWxUaGlzYClcbiAgICBnbG9iYWwuZ2xvYmFsID0gZ2xvYmFsO1xuXG4gICAgLy8gTm9kZSdzIGVycm9yLW1lc3NhZ2Ugc3RhY2sgc2l6ZSBpcyBsaW1pdGVkIGF0IDEwLCBidXQgaXQncyBwcmV0dHkgdXNlZnVsXG4gICAgLy8gdG8gc2VlIG1vcmUgdGhhbiB0aGF0IHdoZW4gYSB0ZXN0IGZhaWxzLlxuICAgIHRoaXMuZ2xvYmFsLkVycm9yLnN0YWNrVHJhY2VMaW1pdCA9IDEwMDtcbiAgICAoMCwgX2plc3RVdGlsKCkuaW5zdGFsbENvbW1vbkdsb2JhbHMpKGdsb2JhbCwgcHJvamVjdENvbmZpZy5nbG9iYWxzKTtcblxuICAgIC8vIFRPRE86IHJlbW92ZSB0aGlzIEFTQVAsIGJ1dCBpdCBjdXJyZW50bHkgY2F1c2VzIHRlc3RzIHRvIHJ1biByZWFsbHkgc2xvd1xuICAgIGdsb2JhbC5CdWZmZXIgPSBCdWZmZXI7XG5cbiAgICAvLyBSZXBvcnQgdW5jYXVnaHQgZXJyb3JzLlxuICAgIHRoaXMuZXJyb3JFdmVudExpc3RlbmVyID0gZXZlbnQgPT4ge1xuICAgICAgaWYgKHVzZXJFcnJvckxpc3RlbmVyQ291bnQgPT09IDAgJiYgZXZlbnQuZXJyb3IgIT0gbnVsbCkge1xuICAgICAgICBwcm9jZXNzLmVtaXQoJ3VuY2F1Z2h0RXhjZXB0aW9uJywgZXZlbnQuZXJyb3IpO1xuICAgICAgfVxuICAgIH07XG4gICAgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgdGhpcy5lcnJvckV2ZW50TGlzdGVuZXIpO1xuXG4gICAgLy8gSG93ZXZlciwgZG9uJ3QgcmVwb3J0IHRoZW0gYXMgdW5jYXVnaHQgaWYgdGhlIHVzZXIgbGlzdGVucyB0byAnZXJyb3InIGV2ZW50LlxuICAgIC8vIEluIHRoYXQgY2FzZSwgd2UgYXNzdW1lIHRoZSBtaWdodCBoYXZlIGN1c3RvbSBlcnJvciBoYW5kbGluZyBsb2dpYy5cbiAgICBjb25zdCBvcmlnaW5hbEFkZExpc3RlbmVyID0gZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIuYmluZChnbG9iYWwpO1xuICAgIGNvbnN0IG9yaWdpbmFsUmVtb3ZlTGlzdGVuZXIgPSBnbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lci5iaW5kKGdsb2JhbCk7XG4gICAgbGV0IHVzZXJFcnJvckxpc3RlbmVyQ291bnQgPSAwO1xuICAgIGdsb2JhbC5hZGRFdmVudExpc3RlbmVyID0gZnVuY3Rpb24gKC4uLmFyZ3MpIHtcbiAgICAgIGlmIChhcmdzWzBdID09PSAnZXJyb3InKSB7XG4gICAgICAgIHVzZXJFcnJvckxpc3RlbmVyQ291bnQrKztcbiAgICAgIH1cbiAgICAgIHJldHVybiBvcmlnaW5hbEFkZExpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3MpO1xuICAgIH07XG4gICAgZ2xvYmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgICAgaWYgKGFyZ3NbMF0gPT09ICdlcnJvcicpIHtcbiAgICAgICAgdXNlckVycm9yTGlzdGVuZXJDb3VudC0tO1xuICAgICAgfVxuICAgICAgcmV0dXJuIG9yaWdpbmFsUmVtb3ZlTGlzdGVuZXIuYXBwbHkodGhpcywgYXJncyk7XG4gICAgfTtcbiAgICBpZiAoJ2N1c3RvbUV4cG9ydENvbmRpdGlvbnMnIGluIHByb2plY3RDb25maWcudGVzdEVudmlyb25tZW50T3B0aW9ucykge1xuICAgICAgY29uc3Qge1xuICAgICAgICBjdXN0b21FeHBvcnRDb25kaXRpb25zXG4gICAgICB9ID0gcHJvamVjdENvbmZpZy50ZXN0RW52aXJvbm1lbnRPcHRpb25zO1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3VzdG9tRXhwb3J0Q29uZGl0aW9ucykgJiYgY3VzdG9tRXhwb3J0Q29uZGl0aW9ucy5ldmVyeShpc1N0cmluZykpIHtcbiAgICAgICAgdGhpcy5fY29uZmlndXJlZEV4cG9ydENvbmRpdGlvbnMgPSBjdXN0b21FeHBvcnRDb25kaXRpb25zO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDdXN0b20gZXhwb3J0IGNvbmRpdGlvbnMgc3BlY2lmaWVkIGJ1dCB0aGV5IGFyZSBub3QgYW4gYXJyYXkgb2Ygc3RyaW5ncycpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLm1vZHVsZU1vY2tlciA9IG5ldyAoX2plc3RNb2NrKCkuTW9kdWxlTW9ja2VyKShnbG9iYWwpO1xuICAgIHRoaXMuZmFrZVRpbWVycyA9IG5ldyAoX2Zha2VUaW1lcnMoKS5MZWdhY3lGYWtlVGltZXJzKSh7XG4gICAgICBjb25maWc6IHByb2plY3RDb25maWcsXG4gICAgICBnbG9iYWw6IGdsb2JhbCxcbiAgICAgIG1vZHVsZU1vY2tlcjogdGhpcy5tb2R1bGVNb2NrZXIsXG4gICAgICB0aW1lckNvbmZpZzoge1xuICAgICAgICBpZFRvUmVmOiBpZCA9PiBpZCxcbiAgICAgICAgcmVmVG9JZDogcmVmID0+IHJlZlxuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMuZmFrZVRpbWVyc01vZGVybiA9IG5ldyAoX2Zha2VUaW1lcnMoKS5Nb2Rlcm5GYWtlVGltZXJzKSh7XG4gICAgICBjb25maWc6IHByb2plY3RDb25maWcsXG4gICAgICBnbG9iYWw6IGdsb2JhbFxuICAgIH0pO1xuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1mdW5jdGlvblxuICBhc3luYyBzZXR1cCgpIHt9XG4gIGFzeW5jIHRlYXJkb3duKCkge1xuICAgIGlmICh0aGlzLmZha2VUaW1lcnMpIHtcbiAgICAgIHRoaXMuZmFrZVRpbWVycy5kaXNwb3NlKCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmZha2VUaW1lcnNNb2Rlcm4pIHtcbiAgICAgIHRoaXMuZmFrZVRpbWVyc01vZGVybi5kaXNwb3NlKCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmdsb2JhbCAhPSBudWxsKSB7XG4gICAgICBpZiAodGhpcy5lcnJvckV2ZW50TGlzdGVuZXIpIHtcbiAgICAgICAgdGhpcy5nbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignZXJyb3InLCB0aGlzLmVycm9yRXZlbnRMaXN0ZW5lcik7XG4gICAgICB9XG4gICAgICB0aGlzLmdsb2JhbC5jbG9zZSgpO1xuICAgIH1cbiAgICB0aGlzLmVycm9yRXZlbnRMaXN0ZW5lciA9IG51bGw7XG4gICAgLy8gQHRzLWV4cGVjdC1lcnJvcjogdGhpcy5nbG9iYWwgbm90IGFsbG93ZWQgdG8gYmUgYG51bGxgXG4gICAgdGhpcy5nbG9iYWwgPSBudWxsO1xuICAgIHRoaXMuZG9tID0gbnVsbDtcbiAgICB0aGlzLmZha2VUaW1lcnMgPSBudWxsO1xuICAgIHRoaXMuZmFrZVRpbWVyc01vZGVybiA9IG51bGw7XG4gIH1cbiAgZXhwb3J0Q29uZGl0aW9ucygpIHtcbiAgICByZXR1cm4gdGhpcy5fY29uZmlndXJlZEV4cG9ydENvbmRpdGlvbnMgPz8gdGhpcy5jdXN0b21FeHBvcnRDb25kaXRpb25zO1xuICB9XG4gIGdldFZtQ29udGV4dCgpIHtcbiAgICBpZiAodGhpcy5kb20pIHtcbiAgICAgIHJldHVybiB0aGlzLmRvbS5nZXRJbnRlcm5hbFZNQ29udGV4dCgpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuZXhwb3J0c1tcImRlZmF1bHRcIl0gPSBCYXNlSlNET01FbnZpcm9ubWVudDtcbn0pKCk7XG5cbm1vZHVsZS5leHBvcnRzID0gX193ZWJwYWNrX2V4cG9ydHNfXztcbi8qKioqKiovIH0pKClcbjsiXSwidmVyc2lvbiI6M30=