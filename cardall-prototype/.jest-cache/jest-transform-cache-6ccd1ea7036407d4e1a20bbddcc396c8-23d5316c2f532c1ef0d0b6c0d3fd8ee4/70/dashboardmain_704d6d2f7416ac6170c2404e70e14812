d5dd9210c91ec50696e9b58e898c6225
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.Dashboard = Dashboard;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = __importStar(require("react"));
const cardall_context_1 = require("@/contexts/cardall-context");
const auth_1 = require("@/services/auth");
const folder_panel_context_1 = require("@/contexts/folder-panel-context");
const optimized_masonry_grid_1 = require("../card/optimized-masonry-grid");
const dashboard_header_1 = require("./dashboard-header");
const dashboard_sidebar_1 = require("./dashboard-sidebar");
const utils_1 = require("@/lib/utils");
function Dashboard({ className }) {
    // Authentication state
    const [authState, setAuthState] = (0, react_1.useState)({
        user: null,
        session: null,
        loading: false,
        error: null
    });
    // UI state
    const [sidebarCollapsed, setSidebarCollapsed] = (0, react_1.useState)(false);
    // Context hooks
    const { cards, filter, setFilter, viewSettings, setViewSettings } = (0, cardall_context_1.useCardAllCards)();
    const { selectedFolderId, setSelectedFolderId, folders, isLoading: foldersLoading } = (0, cardall_context_1.useCardAllFolders)();
    const { tags } = (0, cardall_context_1.useCardAllTags)();
    // Listen for auth state changes
    (0, react_1.useEffect)(() => {
        const unsubscribe = auth_1.authService.onAuthStateChange(setAuthState);
        return unsubscribe;
    }, []);
    // 计算过滤后的卡片
    const filteredCards = (0, react_1.useMemo)(() => {
        let cardsToShow = cards.allCards || [];
        // 按文件夹筛选
        if (selectedFolderId) {
            cardsToShow = cardsToShow.filter(card => card.folderId === selectedFolderId);
        }
        // 按标签筛选
        if (filter.tag) {
            cardsToShow = cardsToShow.filter(card => card.frontContent.tags?.includes(filter.tag) ||
                card.backContent.tags?.includes(filter.tag));
        }
        // 按搜索词筛选
        if (filter.search) {
            const searchLower = filter.search.toLowerCase();
            cardsToShow = cardsToShow.filter(card => {
                const searchableContent = [
                    ...extractTextFromContent(card.frontContent),
                    ...extractTextFromContent(card.backContent)
                ].join(' ').toLowerCase();
                return searchableContent.includes(searchLower);
            });
        }
        // 按创建时间倒序排序
        return cardsToShow.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
    }, [cards.allCards, selectedFolderId, filter.tag, filter.search]);
    // 提取文本内容的辅助函数
    const extractTextFromContent = (content) => {
        if (!content)
            return [];
        const texts = [];
        if (content.type === 'doc') {
            content.content?.forEach((node) => {
                if (node.type === 'paragraph') {
                    const paragraphText = node.content?.map((textNode) => textNode.text || '').join('') || '';
                    if (paragraphText.trim()) {
                        texts.push(paragraphText);
                    }
                }
                else if (node.type === 'heading') {
                    const headingText = node.content?.map((textNode) => textNode.text || '').join('') || '';
                    if (headingText.trim()) {
                        texts.push(headingText);
                    }
                }
            });
        }
        return texts;
    };
    // 切换侧边栏
    const toggleSidebar = () => {
        setSidebarCollapsed(!sidebarCollapsed);
    };
    return ((0, jsx_runtime_1.jsx)(folder_panel_context_1.FolderPanelProvider, { children: (0, jsx_runtime_1.jsxs)("div", { className: (0, utils_1.cn)('flex flex-col h-screen bg-background', className), children: [(0, jsx_runtime_1.jsx)(dashboard_header_1.DashboardHeader, { authState: authState }), (0, jsx_runtime_1.jsxs)("div", { className: "flex flex-1 overflow-hidden", children: [(0, jsx_runtime_1.jsx)(dashboard_sidebar_1.DashboardSidebar, { collapsed: sidebarCollapsed, onToggle: toggleSidebar }), (0, jsx_runtime_1.jsx)("main", { className: "flex-1 overflow-hidden p-6", children: (0, jsx_runtime_1.jsxs)("div", { className: "max-w-7xl mx-auto h-full", children: [(foldersLoading || cards.loading) && ((0, jsx_runtime_1.jsx)("div", { className: "flex items-center justify-center h-32", children: (0, jsx_runtime_1.jsxs)("div", { className: "text-center", children: [(0, jsx_runtime_1.jsx)("div", { className: "animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2" }), (0, jsx_runtime_1.jsx)("p", { className: "text-sm text-muted-foreground", children: "\u52A0\u8F7D\u4E2D..." })] }) })), !foldersLoading && !cards.loading && ((0, jsx_runtime_1.jsx)(optimized_masonry_grid_1.OptimizedMasonryGrid, { cards: filteredCards, gap: viewSettings.gap || 16, enableVirtualization: filteredCards.length > 50 })), !foldersLoading && !cards.loading && filteredCards.length === 0 && ((0, jsx_runtime_1.jsxs)("div", { className: "flex flex-col items-center justify-center h-64 text-center", children: [(0, jsx_runtime_1.jsx)("div", { className: "text-6xl mb-4", children: "\uD83D\uDCDD" }), (0, jsx_runtime_1.jsx)("h3", { className: "text-lg font-semibold mb-2", children: "\u8FD8\u6CA1\u6709\u5361\u7247" }), (0, jsx_runtime_1.jsx)("p", { className: "text-muted-foreground mb-4", children: selectedFolderId || filter.tag || filter.search
                                                    ? '没有找到符合条件的卡片'
                                                    : '创建你的第一张知识卡片吧！' })] }))] }) })] })] }) }));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRDpcXFByb2plY3RzXFxDYXJkRXZlcnl0aGluZ1xcY2FyZGFsbC1wcm90b3R5cGVcXHNyY1xcY29tcG9uZW50c1xcZGFzaGJvYXJkXFxkYXNoYm9hcmQtbWFpbi50c3giLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFhQSw4QkFpS0M7O0FBOUtELCtDQUEyRDtBQUMzRCxnRUFBK0Y7QUFDL0YsMENBQTZEO0FBQzdELDBFQUFxRTtBQUNyRSwyRUFBcUU7QUFDckUseURBQW9EO0FBQ3BELDJEQUFzRDtBQUN0RCx1Q0FBZ0M7QUFNaEMsU0FBZ0IsU0FBUyxDQUFDLEVBQUUsU0FBUyxFQUFrQjtJQUNyRCx1QkFBdUI7SUFDdkIsTUFBTSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsR0FBRyxJQUFBLGdCQUFRLEVBQVk7UUFDcEQsSUFBSSxFQUFFLElBQUk7UUFDVixPQUFPLEVBQUUsSUFBSTtRQUNiLE9BQU8sRUFBRSxLQUFLO1FBQ2QsS0FBSyxFQUFFLElBQUk7S0FDWixDQUFDLENBQUE7SUFFRixXQUFXO0lBQ1gsTUFBTSxDQUFDLGdCQUFnQixFQUFFLG1CQUFtQixDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFDLEtBQUssQ0FBQyxDQUFBO0lBRS9ELGdCQUFnQjtJQUNoQixNQUFNLEVBQ0osS0FBSyxFQUNMLE1BQU0sRUFDTixTQUFTLEVBQ1QsWUFBWSxFQUNaLGVBQWUsRUFDaEIsR0FBRyxJQUFBLGlDQUFlLEdBQUUsQ0FBQTtJQUVyQixNQUFNLEVBQ0osZ0JBQWdCLEVBQ2hCLG1CQUFtQixFQUNuQixPQUFPLEVBQ1AsU0FBUyxFQUFFLGNBQWMsRUFDMUIsR0FBRyxJQUFBLG1DQUFpQixHQUFFLENBQUE7SUFFdkIsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLElBQUEsZ0NBQWMsR0FBRSxDQUFBO0lBRWpDLGdDQUFnQztJQUNoQyxJQUFBLGlCQUFTLEVBQUMsR0FBRyxFQUFFO1FBQ2IsTUFBTSxXQUFXLEdBQUcsa0JBQVcsQ0FBQyxpQkFBaUIs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LHNDQUFXLElBQ25ELEdBQ0YsQ0FDUCxFQUdBLENBQUMsY0FBYyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sSUFBSSxDQUNwQyx1QkFBQyw2Q0FBb0IsSUFDbkIsS0FBSyxFQUFFLGFBQWEsRUFDcEIsR0FBRyxFQUFFLFlBQVksQ0FBQyxHQUFHLElBQUksRUFBRSxFQUMzQixvQkFBb0IsRUFBRSxhQUFhLENBQUMsTUFBTSxHQUFHLEVBQUUsR0FDL0MsQ0FDSCxFQUdBLENBQUMsY0FBYyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sSUFBSSxhQUFhLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUNsRSxpQ0FBSyxTQUFTLEVBQUMsNERBQTRELGFBQ3pFLGdDQUFLLFNBQVMsRUFBQyxlQUFlLDZCQUFTLEVBQ3ZDLCtCQUFJLFNBQVMsRUFBQyw0QkFBNEIsK0NBQVcsRUFDckQsOEJBQUcsU0FBUyxFQUFDLDRCQUE0QixZQUN0QyxnQkFBZ0IsSUFBSSxNQUFNLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxNQUFNO29EQUM5QyxDQUFDLENBQUMsYUFBYTtvREFDZixDQUFDLENBQUMsZUFBZSxHQUVqQixJQUNBLENBQ1AsSUFDRyxHQUNELElBQ0gsSUFDRixHQUNjLENBQ3ZCLENBQUE7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkQ6XFxQcm9qZWN0c1xcQ2FyZEV2ZXJ5dGhpbmdcXGNhcmRhbGwtcHJvdG90eXBlXFxzcmNcXGNvbXBvbmVudHNcXGRhc2hib2FyZFxcZGFzaGJvYXJkLW1haW4udHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VNZW1vIH0gZnJvbSAncmVhY3QnXHJcbmltcG9ydCB7IHVzZUNhcmRBbGxDYXJkcywgdXNlQ2FyZEFsbEZvbGRlcnMsIHVzZUNhcmRBbGxUYWdzIH0gZnJvbSAnQC9jb250ZXh0cy9jYXJkYWxsLWNvbnRleHQnXHJcbmltcG9ydCB7IGF1dGhTZXJ2aWNlLCB0eXBlIEF1dGhTdGF0ZSB9IGZyb20gJ0Avc2VydmljZXMvYXV0aCdcclxuaW1wb3J0IHsgRm9sZGVyUGFuZWxQcm92aWRlciB9IGZyb20gJ0AvY29udGV4dHMvZm9sZGVyLXBhbmVsLWNvbnRleHQnXHJcbmltcG9ydCB7IE9wdGltaXplZE1hc29ucnlHcmlkIH0gZnJvbSAnLi4vY2FyZC9vcHRpbWl6ZWQtbWFzb25yeS1ncmlkJ1xyXG5pbXBvcnQgeyBEYXNoYm9hcmRIZWFkZXIgfSBmcm9tICcuL2Rhc2hib2FyZC1oZWFkZXInXHJcbmltcG9ydCB7IERhc2hib2FyZFNpZGViYXIgfSBmcm9tICcuL2Rhc2hib2FyZC1zaWRlYmFyJ1xyXG5pbXBvcnQgeyBjbiB9IGZyb20gJ0AvbGliL3V0aWxzJ1xyXG5cclxuaW50ZXJmYWNlIERhc2hib2FyZFByb3BzIHtcclxuICBjbGFzc05hbWU/OiBzdHJpbmdcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIERhc2hib2FyZCh7IGNsYXNzTmFtZSB9OiBEYXNoYm9hcmRQcm9wcykge1xyXG4gIC8vIEF1dGhlbnRpY2F0aW9uIHN0YXRlXHJcbiAgY29uc3QgW2F1dGhTdGF0ZSwgc2V0QXV0aFN0YXRlXSA9IHVzZVN0YXRlPEF1dGhTdGF0ZT4oe1xyXG4gICAgdXNlcjogbnVsbCxcclxuICAgIHNlc3Npb246IG51bGwsXHJcbiAgICBsb2FkaW5nOiBmYWxzZSxcclxuICAgIGVycm9yOiBudWxsXHJcbiAgfSlcclxuXHJcbiAgLy8gVUkgc3RhdGVcclxuICBjb25zdCBbc2lkZWJhckNvbGxhcHNlZCwgc2V0U2lkZWJhckNvbGxhcHNlZF0gPSB1c2VTdGF0ZShmYWxzZSlcclxuXHJcbiAgLy8gQ29udGV4dCBob29rc1xyXG4gIGNvbnN0IHsgXHJcbiAgICBjYXJkcywgXHJcbiAgICBmaWx0ZXIsIFxyXG4gICAgc2V0RmlsdGVyLCBcclxuICAgIHZpZXdTZXR0aW5ncywgXHJcbiAgICBzZXRWaWV3U2V0dGluZ3MgXHJcbiAgfSA9IHVzZUNhcmRBbGxDYXJkcygpXHJcbiAgXHJcbiAgY29uc3QgeyBcclxuICAgIHNlbGVjdGVkRm9sZGVySWQsIFxyXG4gICAgc2V0U2VsZWN0ZWRGb2xkZXJJZCxcclxuICAgIGZvbGRlcnMsXHJcbiAgICBpc0xvYWRpbmc6IGZvbGRlcnNMb2FkaW5nXHJcbiAgfSA9IHVzZUNhcmRBbGxGb2xkZXJzKClcclxuICBcclxuICBjb25zdCB7IHRhZ3MgfSA9IHVzZUNhcmRBbGxUYWdzKClcclxuXHJcbiAgLy8gTGlzdGVuIGZvciBhdXRoIHN0YXRlIGNoYW5nZXNcclxuICB1c2VFZmZlY3QoKCkgPT4ge1xyXG4gICAgY29uc3QgdW5zdWJzY3JpYmUgPSBhdXRoU2VydmljZS5vbkF1dGhTdGF0ZUNoYW5nZShzZXRBdXRoU3RhdGUpXHJcbiAgICByZXR1cm4gdW5zdWJzY3JpYmVcclxuICB9LCBbXSlcclxuXHJcbiAgLy8g6K6h566X6L+H5ruk5ZCO55qE5Y2h54mHXHJcbiAgY29uc3QgZmlsdGVyZWRDYXJkcyA9IHVzZU1lbW8oKCkgPT4ge1xyXG4gICAgbGV0IGNhcmRzVG9TaG93ID0gY2FyZHMuYWxsQ2FyZHMgfHwgW11cclxuXHJcbiAgICAvLyDmjInmlofku7blpLnnrZvpgIlcclxuICAgIGlmIChzZWxlY3RlZEZvbGRlcklkKSB7XHJcbiAgICAgIGNhcmRzVG9TaG93ID0gY2FyZHNUb1Nob3cuZmlsdGVyKGNhcmQgPT4gY2FyZC5mb2xkZXJJZCA9PT0gc2VsZWN0ZWRGb2xkZXJJZClcclxuICAgIH1cclxuXHJcbiAgICAvLyDmjInmoIfnrb7nrZvpgIlcclxuICAgIGlmIChmaWx0ZXIudGFnKSB7XHJcbiAgICAgIGNhcmRzVG9TaG93ID0gY2FyZHNUb1Nob3cuZmlsdGVyKGNhcmQgPT4gXHJcbiAgICAgICAgY2FyZC5mcm9udENvbnRlbnQudGFncz8uaW5jbHVkZXMoZmlsdGVyLnRhZykgfHwgXHJcbiAgICAgICAgY2FyZC5iYWNrQ29udGVudC50YWdzPy5pbmNsdWRlcyhmaWx0ZXIudGFnKVxyXG4gICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgLy8g5oyJ5pCc57Si6K+N562b6YCJXHJcbiAgICBpZiAoZmlsdGVyLnNlYXJjaCkge1xyXG4gICAgICBjb25zdCBzZWFyY2hMb3dlciA9IGZpbHRlci5zZWFyY2gudG9Mb3dlckNhc2UoKVxyXG4gICAgICBjYXJkc1RvU2hvdyA9IGNhcmRzVG9TaG93LmZpbHRlcihjYXJkID0+IHtcclxuICAgICAgICBjb25zdCBzZWFyY2hhYmxlQ29udGVudCA9IFtcclxuICAgICAgICAgIC4uLmV4dHJhY3RUZXh0RnJvbUNvbnRlbnQoY2FyZC5mcm9udENvbnRlbnQpLFxyXG4gICAgICAgICAgLi4uZXh0cmFjdFRleHRGcm9tQ29udGVudChjYXJkLmJhY2tDb250ZW50KVxyXG4gICAgICAgIF0uam9pbignICcpLnRvTG93ZXJDYXNlKClcclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4gc2VhcmNoYWJsZUNvbnRlbnQuaW5jbHVkZXMoc2VhcmNoTG93ZXIpXHJcbiAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgLy8g5oyJ5Yib5bu65pe26Ze05YCS5bqP5o6S5bqPXHJcbiAgICByZXR1cm4gY2FyZHNUb1Nob3cuc29ydCgoYSwgYikgPT4gXHJcbiAgICAgIG5ldyBEYXRlKGIuY3JlYXRlZEF0KS5nZXRUaW1lKCkgLSBuZXcgRGF0ZShhLmNyZWF0ZWRBdCkuZ2V0VGltZSgpXHJcbiAgICApXHJcbiAgfSwgW2NhcmRzLmFsbENhcmRzLCBzZWxlY3RlZEZvbGRlcklkLCBmaWx0ZXIudGFnLCBmaWx0ZXIuc2VhcmNoXSlcclxuXHJcbiAgLy8g5o+Q5Y+W5paH5pys5YaF5a6555qE6L6F5Yqp5Ye95pWwXHJcbiAgY29uc3QgZXh0cmFjdFRleHRGcm9tQ29udGVudCA9IChjb250ZW50OiBhbnkpOiBzdHJpbmdbXSA9PiB7XHJcbiAgICBpZiAoIWNvbnRlbnQpIHJldHVybiBbXVxyXG4gICAgXHJcbiAgICBjb25zdCB0ZXh0czogc3RyaW5nW10gPSBbXVxyXG4gICAgXHJcbiAgICBpZiAoY29udGVudC50eXBlID09PSAnZG9jJykge1xyXG4gICAgICBjb250ZW50LmNvbnRlbnQ/LmZvckVhY2goKG5vZGU6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChub2RlLnR5cGUgPT09ICdwYXJhZ3JhcGgnKSB7XHJcbiAgICAgICAgICBjb25zdCBwYXJhZ3JhcGhUZXh0ID0gbm9kZS5jb250ZW50Py5tYXAoKHRleHROb2RlOiBhbnkpID0+IFxyXG4gICAgICAgICAgICB0ZXh0Tm9kZS50ZXh0IHx8ICcnXHJcbiAgICAgICAgICApLmpvaW4oJycpIHx8ICcnXHJcbiAgICAgICAgICBpZiAocGFyYWdyYXBoVGV4dC50cmltKCkpIHtcclxuICAgICAgICAgICAgdGV4dHMucHVzaChwYXJhZ3JhcGhUZXh0KVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAobm9kZS50eXBlID09PSAnaGVhZGluZycpIHtcclxuICAgICAgICAgIGNvbnN0IGhlYWRpbmdUZXh0ID0gbm9kZS5jb250ZW50Py5tYXAoKHRleHROb2RlOiBhbnkpID0+IFxyXG4gICAgICAgICAgICB0ZXh0Tm9kZS50ZXh0IHx8ICcnXHJcbiAgICAgICAgICApLmpvaW4oJycpIHx8ICcnXHJcbiAgICAgICAgICBpZiAoaGVhZGluZ1RleHQudHJpbSgpKSB7XHJcbiAgICAgICAgICAgIHRleHRzLnB1c2goaGVhZGluZ1RleHQpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICByZXR1cm4gdGV4dHNcclxuICB9XHJcblxyXG4gIC8vIOWIh+aNouS+p+i+ueagj1xyXG4gIGNvbnN0IHRvZ2dsZVNpZGViYXIgPSAoKSA9PiB7XHJcbiAgICBzZXRTaWRlYmFyQ29sbGFwc2VkKCFzaWRlYmFyQ29sbGFwc2VkKVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIChcclxuICAgIDxGb2xkZXJQYW5lbFByb3ZpZGVyPlxyXG4gICAgICA8ZGl2IGNsYXNzTmFtZT17Y24oJ2ZsZXggZmxleC1jb2wgaC1zY3JlZW4gYmctYmFja2dyb3VuZCcsIGNsYXNzTmFtZSl9PlxyXG4gICAgICAgIHsvKiDlpLTpg6ggKi99XHJcbiAgICAgICAgPERhc2hib2FyZEhlYWRlciBhdXRoU3RhdGU9e2F1dGhTdGF0ZX0gLz5cclxuICAgICAgICBcclxuICAgICAgICB7Lyog5Li75L2T5YaF5a65ICovfVxyXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZmxleCBmbGV4LTEgb3ZlcmZsb3ctaGlkZGVuXCI+XHJcbiAgICAgICAgICB7Lyog5L6n6L655qCPICovfVxyXG4gICAgICAgICAgPERhc2hib2FyZFNpZGViYXIgXHJcbiAgICAgICAgICAgIGNvbGxhcHNlZD17c2lkZWJhckNvbGxhcHNlZH1cclxuICAgICAgICAgICAgb25Ub2dnbGU9e3RvZ2dsZVNpZGViYXJ9XHJcbiAgICAgICAgICAvPlxyXG4gICAgICAgICAgXHJcbiAgICAgICAgICB7Lyog5Li75YaF5a655Yy6ICovfVxyXG4gICAgICAgICAgPG1haW4gY2xhc3NOYW1lPVwiZmxleC0xIG92ZXJmbG93LWhpZGRlbiBwLTZcIj5cclxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJtYXgtdy03eGwgbXgtYXV0byBoLWZ1bGxcIj5cclxuICAgICAgICAgICAgICB7Lyog54q25oCB5oyH56S65ZmoICovfVxyXG4gICAgICAgICAgICAgIHsoZm9sZGVyc0xvYWRpbmcgfHwgY2FyZHMubG9hZGluZykgJiYgKFxyXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4IGl0ZW1zLWNlbnRlciBqdXN0aWZ5LWNlbnRlciBoLTMyXCI+XHJcbiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwidGV4dC1jZW50ZXJcIj5cclxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImFuaW1hdGUtc3BpbiByb3VuZGVkLWZ1bGwgaC04IHctOCBib3JkZXItYi0yIGJvcmRlci1wcmltYXJ5IG14LWF1dG8gbWItMlwiPjwvZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgIDxwIGNsYXNzTmFtZT1cInRleHQtc20gdGV4dC1tdXRlZC1mb3JlZ3JvdW5kXCI+5Yqg6L295LitLi4uPC9wPlxyXG4gICAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICl9XHJcbiAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgey8qIOWNoeeJh+e9keagvCAqL31cclxuICAgICAgICAgICAgICB7IWZvbGRlcnNMb2FkaW5nICYmICFjYXJkcy5sb2FkaW5nICYmIChcclxuICAgICAgICAgICAgICAgIDxPcHRpbWl6ZWRNYXNvbnJ5R3JpZFxyXG4gICAgICAgICAgICAgICAgICBjYXJkcz17ZmlsdGVyZWRDYXJkc31cclxuICAgICAgICAgICAgICAgICAgZ2FwPXt2aWV3U2V0dGluZ3MuZ2FwIHx8IDE2fVxyXG4gICAgICAgICAgICAgICAgICBlbmFibGVWaXJ0dWFsaXphdGlvbj17ZmlsdGVyZWRDYXJkcy5sZW5ndGggPiA1MH1cclxuICAgICAgICAgICAgICAgIC8+XHJcbiAgICAgICAgICAgICAgKX1cclxuICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICB7Lyog56m654q25oCBICovfVxyXG4gICAgICAgICAgICAgIHshZm9sZGVyc0xvYWRpbmcgJiYgIWNhcmRzLmxvYWRpbmcgJiYgZmlsdGVyZWRDYXJkcy5sZW5ndGggPT09IDAgJiYgKFxyXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4IGZsZXgtY29sIGl0ZW1zLWNlbnRlciBqdXN0aWZ5LWNlbnRlciBoLTY0IHRleHQtY2VudGVyXCI+XHJcbiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwidGV4dC02eGwgbWItNFwiPvCfk508L2Rpdj5cclxuICAgICAgICAgICAgICAgICAgPGgzIGNsYXNzTmFtZT1cInRleHQtbGcgZm9udC1zZW1pYm9sZCBtYi0yXCI+6L+Y5rKh5pyJ5Y2h54mHPC9oMz5cclxuICAgICAgICAgICAgICAgICAgPHAgY2xhc3NOYW1lPVwidGV4dC1tdXRlZC1mb3JlZ3JvdW5kIG1iLTRcIj5cclxuICAgICAgICAgICAgICAgICAgICB7c2VsZWN0ZWRGb2xkZXJJZCB8fCBmaWx0ZXIudGFnIHx8IGZpbHRlci5zZWFyY2hcclxuICAgICAgICAgICAgICAgICAgICAgID8gJ+ayoeacieaJvuWIsOespuWQiOadoeS7tueahOWNoeeJhydcclxuICAgICAgICAgICAgICAgICAgICAgIDogJ+WIm+W7uuS9oOeahOesrOS4gOW8oOefpeivhuWNoeeJh+WQp++8gSdcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgIDwvcD5cclxuICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICl9XHJcbiAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgPC9tYWluPlxyXG4gICAgICAgIDwvZGl2PlxyXG4gICAgICA8L2Rpdj5cclxuICAgIDwvRm9sZGVyUGFuZWxQcm92aWRlcj5cclxuICApXHJcbn0iXSwidmVyc2lvbiI6M30=