260c4b9b494535fdd82311f3f35e584a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useTags = useTags;
const react_1 = require("react");
// Mock data for development
const mockTags = [
    {
        id: 'tag-1',
        name: 'react',
        color: '#3b82f6',
        count: 1,
        createdAt: new Date('2024-01-15')
    },
    {
        id: 'tag-2',
        name: 'frontend',
        color: '#8b5cf6',
        count: 1,
        createdAt: new Date('2024-01-15')
    },
    {
        id: 'tag-3',
        name: 'best-practices',
        color: '#10b981',
        count: 1,
        createdAt: new Date('2024-01-15')
    },
    {
        id: 'tag-4',
        name: 'typescript',
        color: '#f59e0b',
        count: 1,
        createdAt: new Date('2024-01-16')
    },
    {
        id: 'tag-5',
        name: 'types',
        color: '#ef4444',
        count: 1,
        createdAt: new Date('2024-01-16')
    },
    {
        id: 'tag-6',
        name: 'development',
        color: '#06b6d4',
        count: 1,
        createdAt: new Date('2024-01-16')
    }
];
const TAG_COLORS = [
    '#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4',
    '#8b5a2b', '#6b7280', '#ec4899', '#84cc16', '#f97316', '#6366f1'
];
function useTags() {
    const [tags, setTags] = (0, react_1.useState)(mockTags);
    const [hiddenTags, setHiddenTags] = (0, react_1.useState)([]);
    // Get visible tags
    const visibleTags = (0, react_1.useCallback)(() => {
        return tags.filter(tag => !hiddenTags.includes(tag.id));
    }, [tags, hiddenTags]);
    // Get popular tags (sorted by count)
    const popularTags = (0, react_1.useCallback)((limit) => {
        const sorted = [...visibleTags()].sort((a, b) => b.count - a.count);
        return limit ? sorted.slice(0, limit) : sorted;
    }, [visibleTags]);
    // Tag actions
    const dispatch = (0, react_1.useCallback)((action) => {
        setTags(prevTags => {
            switch (action.type) {
                case 'CREATE_TAG':
                    // Check if tag already exists
                    const existingTag = prevTags.find(tag => tag.name.toLowerCase() === action.payload.name.toLowerCase());
                    if (existingTag) {
                        // Increment count if tag exists
                        return prevTags.map(tag => tag.id === existingTag.id
                            ? { ...tag, count: tag.count + 1 }
                            : tag);
                    }
                    // Create new tag
                    const newTag = {
                        ...action.payload,
                        id: `tag-${Date.now()}`,
                        count: 1,
                        color: action.payload.color || TAG_COLORS[prevTags.length % TAG_COLORS.length],
                        createdAt: new Date()
                    };
                    return [...prevTags, newTag];
                case 'UPDATE_TAG':
                    return prevTags.map(tag => tag.id === action.payload.id
                        ? { ...tag, ...action.payload.updates }
                        : tag);
                case 'DELETE_TAG':
                    return prevTags.filter(tag => tag.id !== action.payload);
                case 'TOGGLE_TAG_VISIBILITY':
                    setHiddenTags(prev => prev.includes(action.payload)
                        ? prev.filter(id => id !== action.payload)
                        : [...prev, action.payload]);
                    return prevTags;
                default:
                    return prevTags;
            }
        });
    }, []);
    // Utility functions
    const getTagById = (0, react_1.useCallback)((id) => {
        return tags.find(tag => tag.id === id);
    }, [tags]);
    const getTagByName = (0, react_1.useCallback)((name) => {
        return tags.find(tag => tag.name.toLowerCase() === name.toLowerCase());
    }, [tags]);
    const createTagIfNotExists = (0, react_1.useCallback)((name, color) => {
        const existing = getTagByName(name);
        if (existing) {
            return existing;
        }
        dispatch({
            type: 'CREATE_TAG',
            payload: { name, color: color || TAG_COLORS[tags.length % TAG_COLORS.length] }
        });
        return null; // Tag will be created asynchronously
    }, [dispatch, getTagByName, tags.length]);
    const updateTagCount = (0, react_1.useCallback)((tagName, increment) => {
        const tag = getTagByName(tagName);
        if (tag) {
            const newCount = Math.max(0, tag.count + increment);
            if (newCount === 0) {
                dispatch({ type: 'DELETE_TAG', payload: tag.id });
            }
            else {
                dispatch({
                    type: 'UPDATE_TAG',
                    payload: { id: tag.id, updates: { count: newCount } }
                });
            }
        }
    }, [dispatch, getTagByName]);
    const syncTagsWithCards = (0, react_1.useCallback)((allCardTags) => {
        // Count tag usage
        const tagCounts = allCardTags.reduce((acc, tagName) => {
            acc[tagName] = (acc[tagName] || 0) + 1;
            return acc;
        }, {});
        // Update existing tags and create new ones
        const updatedTags = tags.map(tag => ({
            ...tag,
            count: tagCounts[tag.name] || 0
        }));
        const existingTagNames = new Set(tags.map(tag => tag.name));
        // Create new tags
        Object.entries(tagCounts).forEach(([tagName, count]) => {
            if (!existingTagNames.has(tagName)) {
                const newTag = {
                    id: `tag-${Date.now()}-${Math.random()}`,
                    name: tagName,
                    color: TAG_COLORS[updatedTags.length % TAG_COLORS.length],
                    count,
                    createdAt: new Date()
                };
                updatedTags.push(newTag);
            }
        });
        // Remove tags with zero count
        const finalTags = updatedTags.filter(tag => tag.count > 0);
        setTags(finalTags);
    }, [tags]);
    const searchTags = (0, react_1.useCallback)((query) => {
        if (!query.trim())
            return visibleTags();
        const lowercaseQuery = query.toLowerCase();
        return visibleTags().filter(tag => tag.name.toLowerCase().includes(lowercaseQuery));
    }, [visibleTags]);
    const getTagSuggestions = (0, react_1.useCallback)((input, limit = 5) => {
        if (!input.trim())
            return popularTags(limit);
        const matches = searchTags(input);
        return matches.slice(0, limit);
    }, [searchTags, popularTags]);
    // Rename tag
    const renameTag = (0, react_1.useCallback)((oldName, newName) => {
        const tag = getTagByName(oldName);
        if (!tag)
            return false;
        // Check if new name already exists
        const existingTag = getTagByName(newName);
        if (existingTag && existingTag.id !== tag.id) {
            return false; // Name conflict
        }
        dispatch({
            type: 'UPDATE_TAG',
            payload: {
                id: tag.id,
                updates: { name: newName.trim() }
            }
        });
        return true;
    }, [dispatch, getTagByName]);
    // Delete tag by name
    const deleteTagByName = (0, react_1.useCallback)((tagName) => {
        const tag = getTagByName(tagName);
        if (!tag)
            return false;
        dispatch({ type: 'DELETE_TAG', payload: tag.id });
        return true;
    }, [dispatch, getTagByName]);
    // Get all tag names for validation
    const getAllTagNames = (0, react_1.useCallback)(() => {
        return tags.map(tag => tag.name);
    }, [tags]);
    // Auto-save to localStorage
    (0, react_1.useEffect)(() => {
        const saveTimer = setTimeout(() => {
            localStorage.setItem('cardall-tags', JSON.stringify(tags));
            localStorage.setItem('cardall-hidden-tags', JSON.stringify(hiddenTags));
        }, 1000);
        return () => clearTimeout(saveTimer);
    }, [tags, hiddenTags]);
    // Load from localStorage on mount
    (0, react_1.useEffect)(() => {
        const savedTags = localStorage.getItem('cardall-tags');
        const savedHiddenTags = localStorage.getItem('cardall-hidden-tags');
        if (savedTags) {
            try {
                const parsedTags = JSON.parse(savedTags);
                setTags(parsedTags);
            }
            catch (error) {
                console.error('Failed to load saved tags:', error);
            }
        }
        if (savedHiddenTags) {
            try {
                const parsedHiddenTags = JSON.parse(savedHiddenTags);
                setHiddenTags(parsedHiddenTags);
            }
            catch (error) {
                console.error('Failed to load hidden tags:', error);
            }
        }
    }, []);
    return {
        tags: visibleTags(),
        allTags: tags,
        hiddenTags,
        popularTags,
        dispatch,
        getTagById,
        getTagByName,
        createTagIfNotExists,
        updateTagCount,
        syncTagsWithCards,
        searchTags,
        getTagSuggestions,
        renameTag,
        deleteTagByName,
        getAllTagNames
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRDpcXFByb2plY3RzXFxDYXJkRXZlcnl0aGluZ1xcY2FyZGFsbC1wcm90b3R5cGVcXHNyY1xcaG9va3NcXHVzZS10YWdzLnRzIiwibWFwcGluZ3MiOiI7O0FBc0RBLDBCQWlQQztBQXZTRCxpQ0FBd0Q7QUFHeEQsNEJBQTRCO0FBQzVCLE1BQU0sUUFBUSxHQUFVO0lBQ3RCO1FBQ0UsRUFBRSxFQUFFLE9BQU87UUFDWCxJQUFJLEVBQUUsT0FBTztRQUNiLEtBQUssRUFBRSxTQUFTO1FBQ2hCLEtBQUssRUFBRSxDQUFDO1FBQ1IsU0FBUyxFQUFFLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQztLQUNsQztJQUNEO1FBQ0UsRUFBRSxFQUFFLE9BQU87UUFDWCxJQUFJLEVBQUUsVUFBVTtRQUNoQixLQUFLLEVBQUUsU0FBUztRQUNoQixLQUFLLEVBQUUsQ0FBQztRQUNSLFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUM7S0FDbEM7SUFDRDtRQUNFLEVBQUUsRUFBRSxPQUFPO1FBQ1gsSUFBSSxFQUFFLGdCQUFnQjtRQUN0QixLQUFLLEVBQUUsU0FBUztRQUNoQixLQUFLLEVBQUUsQ0FBQztRQUNSLFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUM7S0FDbEM7SUFDRDtRQUNFLEVBQUUsRUFBRSxPQUFPO1FBQ1gsSUFBSSxFQUFFLFlBQVk7UUFDbEIsS0FBSyxFQUFFLFNBQVM7UUFDaEIsS0FBSyxFQUFFLENBQUM7UUFDUixTQUFTLEVBQUUsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDO0tBQ2xDO0lBQ0Q7UUFDRSxFQUFFLEVBQUUsT0FBTztRQUNYLElBQUksRUFBRSxPQUFPO1FBQ2IsS0FBSyxFQUFFLFNBQVM7UUFDaEIsS0FBSyxFQUFFLENBQUM7UUFDUixTQUFTLEVBQUUsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDO0tBQ2xDO0lBQ0Q7UUFDRSxFQUFFLEVBQUUsT0FBTztRQUNYLElBQUksRUFBRSxhQUFhO1FBQ25CLEtBQUssRUFBRSxTQUFTO1FBQ2hCLEtBQUssRUFBRSxDQUFDO1FBQ1IsU0FBUyxFQUFFLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQztLQUNsQztDQUNGLENBQUE7QUFFRCxNQUFNLFVBQVUsR0FBRztJQUNqQixTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVM7SUFDaEUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTO0NBQ2pFLENBQUE7QUFFRCxTQUFnQixPQUFPO0lBQ3JCLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFRLFFBQVEsQ0FBQyxDQUFBO0lBQ2pELE1BQU0sQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFXLEVBQUUsQ0FBQyxDQUFBO0lBRTFELG1CQUFtQjtJQUNuQixNQUFNLFdBQVcsR0FBRyxJQUFBLG1CQUFXLEVBQUMsR0FBRyxFQUFFO1FBQ25DLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUN6RCxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQTtJQUV0QixxQ0FBcUM7SUFDckMsTUFBTSxXQUFXLEdBQUcsSUFBQSxtQkFBVyxFQUFDLENBQUMsS0FBYyxFQUFFLEVBQUU7UUFDakQsTUFBTSxNQUFNLEdBQUcsQ0FBQyxHQUFHLFdBQVcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDbkUsT0FBTyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUE7SUFDaEQsQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQTtJQUVqQixjQUFjO0lBQ2QsTUFBTSxRQUFRLEdBQUcsSUFBQSxtQkFBVyxFQUFDLENBQUMsTUFBaUIsRUFBRSxFQUFFO1FBQ2pELE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUNqQixRQUFRLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDcEIsS0FBSyxZQUFZO29CQUNmLDhCQUE4QjtvQkFDOUIsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUN0QyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxLQUFLLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUM3RCxDQUFBO29CQUNELElBQUksV0FBVyxFQUFFLENBQUM7d0JBQ2hCLGdDQUFnQzt3QkFDaEMsT0FBTyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQ3hCLEdBQUcsQ0FBQyxFQUFFLEtBQUssV0FBVyxDQUFDLEVBQUU7NEJBQ3ZCLENBQUMsQ0FBQyxFQUFFLEdBQUcsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsS0FBSyxHQUFHLENBQUMsRUFBRTs0QkFDbEMsQ0FBQyxDQUFDLEdBQUcsQ0FDUixDQUFBO29CQUNILENBQUM7b0JBRUQsaUJBQWlCO29CQUNqQixNQUFNLE1BQU0sR0FBUTt3QkFDbEIsR0FBRyxNQUFNLENBQUMsT0FBTzt3QkFDakIsRUFBRSxFQUFFLE9BQU8sSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFO3dCQUN2QixLQUFLLEVBQUUsQ0FBQzt3QkFDUixLQUFLLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQzt3QkFDOUUsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO3FCQUN0QixDQUFBO29CQUNELE9BQU8sQ0FBQyxHQUFHLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQTtnQkFFOUIsS0FBSyxZQUFZO29CQUNmLE9BQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUN4QixHQUFHLENBQUMsRUFBRSxLQUFLLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRTt3QkFDMUIsQ0FBQyxDQUFDLEVBQUUsR0FBRyxHQUFHLEVBQUUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTt3QkFDdkMsQ0FBQyxDQUFDLEdBQUcsQ0FDUixDQUFBO2dCQUVILEtBQUssWUFBWTtvQkFDZixPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxLQUFLLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtnQkFFMUQsS0FBSyx1QkFBdUI7b0JBQzFCLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUNuQixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUM7d0JBQzNCLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxLQUFLLE1BQU0sQ0FBQyxPQUFPLENBQUM7d0JBQzFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FDOUIsQ0FBQTtvQkFDRCxPQUFPLFFBQVEsQ0FBQTtnQkFFakI7b0JBQ0UsT0FBTyxRQUFRLENBQUE7WUFDbkIsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRU4sb0JBQW9CO0lBQ3BCLE1BQU0sVUFBVSxHQUFHLElBQUEsbUJBQVcsRUFBQyxDQUFDLEVBQVUsRUFBRSxFQUFFO1FBQzVDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7SUFDeEMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtJQUVWLE1BQU0sWUFBWSxHQUFHLElBQUEsbUJBQVcsRUFBQyxDQUFDLElBQVksRUFBRSxFQUFFO1FBQ2hELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUE7SUFDeEUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtJQUVWLE1BQU0sb0JBQW9CLEdBQUcsSUFBQSxtQkFBVyxFQUFDLENBQUMsSUFBWSxFQUFFLEtBQWMsRUFBRSxFQUFFO1FBQ3hFLE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNuQyxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ2IsT0FBTyxRQUFRLENBQUE7UUFDakIsQ0FBQztRQUVELFFBQVEsQ0FBQztZQUNQLElBQUksRUFBRSxZQUFZO1lBQ2xCLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRTtTQUMvRSxDQUFDLENBQUE7UUFFRixPQUFPLElBQUksQ0FBQSxDQUFDLHFDQUFxQztJQUNuRCxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsWUFBWSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO0lBRXpDLE1BQU0sY0FBYyxHQUFHLElBQUEsbUJBQVcsRUFBQyxDQUFDLE9BQWUsRUFBRSxTQUFpQixFQUFFLEVBQUU7UUFDeEUsTUFBTSxHQUFHLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ2pDLElBQUksR0FBRyxFQUFFLENBQUM7WUFDUixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQyxDQUFBO1lBQ25ELElBQUksUUFBUSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUNuQixRQUFRLENBQUMsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtZQUNuRCxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sUUFBUSxDQUFDO29CQUNQLElBQUksRUFBRSxZQUFZO29CQUNsQixPQUFPLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxPQUFPLEVBQUUsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEVBQUU7aUJBQ3RELENBQUMsQ0FBQTtZQUNKLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUE7SUFFNUIsTUFBTSxpQkFBaUIsR0FBRyxJQUFBLG1CQUFXLEVBQUMsQ0FBQyxXQUFxQixFQUFFLEVBQUU7UUFDOUQsa0JBQWtCO1FBQ2xCLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLEVBQUU7WUFDcEQsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUN0QyxPQUFPLEdBQUcsQ0FBQTtRQUNaLENBQUMsRUFBRSxFQUE0QixDQUFDLENBQUE7UUFFaEMsMkNBQTJDO1FBQzNDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ25DLEdBQUcsR0FBRztZQUNOLEtBQUssRUFBRSxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7U0FDaEMsQ0FBQyxDQUFDLENBQUE7UUFFSCxNQUFNLGdCQUFnQixHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtRQUUzRCxrQkFBa0I7UUFDbEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFO1lBQ3JELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztnQkFDbkMsTUFBTSxNQUFNLEdBQVE7b0JBQ2xCLEVBQUUsRUFBRSxPQUFPLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUU7b0JBQ3hDLElBQUksRUFBRSxPQUFPO29CQUNiLEtBQUssRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDO29CQUN6RCxLQUFLO29CQUNMLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtpQkFDdEIsQ0FBQTtnQkFDRCxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQzFCLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQTtRQUVGLDhCQUE4QjtRQUM5QixNQUFNLFNBQVMsR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUMxRCxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDcEIsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtJQUVWLE1BQU0sVUFBVSxHQUFHLElBQUEsbUJBQVcsRUFBQyxDQUFDLEtBQWEsRUFBRSxFQUFFO1FBQy9DLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFO1lBQUUsT0FBTyxXQUFXLEVBQUUsQ0FBQTtRQUV2QyxNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUE7UUFDMUMsT0FBTyxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FDaEMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQ2hELENBQUE7SUFDSCxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFBO0lBRWpCLE1BQU0saUJBQWlCLEdBQUcsSUFBQSxtQkFBVyxFQUFDLENBQUMsS0FBYSxFQUFFLEtBQUssR0FBRyxDQUFDLEVBQUUsRUFBRTtRQUNqRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRTtZQUFFLE9BQU8sV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBRTVDLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNqQyxPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFBO0lBQ2hDLENBQUMsRUFBRSxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFBO0lBRTdCLGFBQWE7SUFDYixNQUFNLFNBQVMsR0FBRyxJQUFBLG1CQUFXLEVBQUMsQ0FBQyxPQUFlLEVBQUUsT0FBZSxFQUFFLEVBQUU7UUFDakUsTUFBTSxHQUFHLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ2pDLElBQUksQ0FBQyxHQUFHO1lBQUUsT0FBTyxLQUFLLENBQUE7UUFFdEIsbUNBQW1DO1FBQ25DLE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUN6QyxJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsRUFBRSxLQUFLLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUM3QyxPQUFPLEtBQUssQ0FBQSxDQUFDLGdCQUFnQjtRQUMvQixDQUFDO1FBRUQsUUFBUSxDQUFDO1lBQ1AsSUFBSSxFQUFFLFlBQVk7WUFDbEIsT0FBTyxFQUFFO2dCQUNQLEVBQUUsRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDVixPQUFPLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFO2FBQ2xDO1NBQ0YsQ0FBQyxDQUFBO1FBQ0YsT0FBTyxJQUFJLENBQUE7SUFDYixDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQTtJQUU1QixxQkFBcUI7SUFDckIsTUFBTSxlQUFlLEdBQUcsSUFBQSxtQkFBVyxFQUFDLENBQUMsT0FBZSxFQUFFLEVBQUU7UUFDdEQsTUFBTSxHQUFHLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ2pDLElBQUksQ0FBQyxHQUFHO1lBQUUsT0FBTyxLQUFLLENBQUE7UUFFdEIsUUFBUSxDQUFDLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFDakQsT0FBTyxJQUFJLENBQUE7SUFDYixDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQTtJQUU1QixtQ0FBbUM7SUFDbkMsTUFBTSxjQUFjLEdBQUcsSUFBQSxtQkFBVyxFQUFDLEdBQUcsRUFBRTtRQUN0QyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDbEMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtJQUVWLDRCQUE0QjtJQUM1QixJQUFBLGlCQUFTLEVBQUMsR0FBRyxFQUFFO1FBQ2IsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNoQyxZQUFZLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7WUFDMUQsWUFBWSxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUE7UUFDekUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFBO1FBRVIsT0FBTyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDdEMsQ0FBQyxFQUFFLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUE7SUFFdEIsa0NBQWtDO0lBQ2xDLElBQUEsaUJBQVMsRUFBQyxHQUFHLEVBQUU7UUFDYixNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFBO1FBQ3RELE1BQU0sZUFBZSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQTtRQUVuRSxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQ2QsSUFBSSxDQUFDO2dCQUNILE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUE7Z0JBQ3hDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUNyQixDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZixPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLEtBQUssQ0FBQyxDQUFBO1lBQ3BELENBQUM7UUFDSCxDQUFDO1FBRUQsSUFBSSxlQUFlLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUM7Z0JBQ0gsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFBO2dCQUNwRCxhQUFhLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtZQUNqQyxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZixPQUFPLENBQUMsS0FBSyxDQUFDLDZCQUE2QixFQUFFLEtBQUssQ0FBQyxDQUFBO1lBQ3JELENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRU4sT0FBTztRQUNMLElBQUksRUFBRSxXQUFXLEVBQUU7UUFDbkIsT0FBTyxFQUFFLElBQUk7UUFDYixVQUFVO1FBQ1YsV0FBVztRQUNYLFFBQVE7UUFDUixVQUFVO1FBQ1YsWUFBWTtRQUNaLG9CQUFvQjtRQUNwQixjQUFjO1FBQ2QsaUJBQWlCO1FBQ2pCLFVBQVU7UUFDVixpQkFBaUI7UUFDakIsU0FBUztRQUNULGVBQWU7UUFDZixjQUFjO0tBQ2YsQ0FBQTtBQUNILENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiRDpcXFByb2plY3RzXFxDYXJkRXZlcnl0aGluZ1xcY2FyZGFsbC1wcm90b3R5cGVcXHNyY1xcaG9va3NcXHVzZS10YWdzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVzZVN0YXRlLCB1c2VDYWxsYmFjaywgdXNlRWZmZWN0IH0gZnJvbSAncmVhY3QnXHJcbmltcG9ydCB7IFRhZywgVGFnQWN0aW9uIH0gZnJvbSAnQC90eXBlcy9jYXJkJ1xyXG5cclxuLy8gTW9jayBkYXRhIGZvciBkZXZlbG9wbWVudFxyXG5jb25zdCBtb2NrVGFnczogVGFnW10gPSBbXHJcbiAge1xyXG4gICAgaWQ6ICd0YWctMScsXHJcbiAgICBuYW1lOiAncmVhY3QnLFxyXG4gICAgY29sb3I6ICcjM2I4MmY2JyxcclxuICAgIGNvdW50OiAxLFxyXG4gICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgnMjAyNC0wMS0xNScpXHJcbiAgfSxcclxuICB7XHJcbiAgICBpZDogJ3RhZy0yJyxcclxuICAgIG5hbWU6ICdmcm9udGVuZCcsXHJcbiAgICBjb2xvcjogJyM4YjVjZjYnLFxyXG4gICAgY291bnQ6IDEsXHJcbiAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCcyMDI0LTAxLTE1JylcclxuICB9LFxyXG4gIHtcclxuICAgIGlkOiAndGFnLTMnLFxyXG4gICAgbmFtZTogJ2Jlc3QtcHJhY3RpY2VzJyxcclxuICAgIGNvbG9yOiAnIzEwYjk4MScsXHJcbiAgICBjb3VudDogMSxcclxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoJzIwMjQtMDEtMTUnKVxyXG4gIH0sXHJcbiAge1xyXG4gICAgaWQ6ICd0YWctNCcsXHJcbiAgICBuYW1lOiAndHlwZXNjcmlwdCcsXHJcbiAgICBjb2xvcjogJyNmNTllMGInLFxyXG4gICAgY291bnQ6IDEsXHJcbiAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCcyMDI0LTAxLTE2JylcclxuICB9LFxyXG4gIHtcclxuICAgIGlkOiAndGFnLTUnLFxyXG4gICAgbmFtZTogJ3R5cGVzJyxcclxuICAgIGNvbG9yOiAnI2VmNDQ0NCcsXHJcbiAgICBjb3VudDogMSxcclxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoJzIwMjQtMDEtMTYnKVxyXG4gIH0sXHJcbiAge1xyXG4gICAgaWQ6ICd0YWctNicsXHJcbiAgICBuYW1lOiAnZGV2ZWxvcG1lbnQnLFxyXG4gICAgY29sb3I6ICcjMDZiNmQ0JyxcclxuICAgIGNvdW50OiAxLFxyXG4gICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgnMjAyNC0wMS0xNicpXHJcbiAgfVxyXG5dXHJcblxyXG5jb25zdCBUQUdfQ09MT1JTID0gW1xyXG4gICcjM2I4MmY2JywgJyM4YjVjZjYnLCAnIzEwYjk4MScsICcjZjU5ZTBiJywgJyNlZjQ0NDQnLCAnIzA2YjZkNCcsXHJcbiAgJyM4YjVhMmInLCAnIzZiNzI4MCcsICcjZWM0ODk5JywgJyM4NGNjMTYnLCAnI2Y5NzMxNicsICcjNjM2NmYxJ1xyXG5dXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXNlVGFncygpIHtcclxuICBjb25zdCBbdGFncywgc2V0VGFnc10gPSB1c2VTdGF0ZTxUYWdbXT4obW9ja1RhZ3MpXHJcbiAgY29uc3QgW2hpZGRlblRhZ3MsIHNldEhpZGRlblRhZ3NdID0gdXNlU3RhdGU8c3RyaW5nW10+KFtdKVxyXG5cclxuICAvLyBHZXQgdmlzaWJsZSB0YWdzXHJcbiAgY29uc3QgdmlzaWJsZVRhZ3MgPSB1c2VDYWxsYmFjaygoKSA9PiB7XHJcbiAgICByZXR1cm4gdGFncy5maWx0ZXIodGFnID0+ICFoaWRkZW5UYWdzLmluY2x1ZGVzKHRhZy5pZCkpXHJcbiAgfSwgW3RhZ3MsIGhpZGRlblRhZ3NdKVxyXG5cclxuICAvLyBHZXQgcG9wdWxhciB0YWdzIChzb3J0ZWQgYnkgY291bnQpXHJcbiAgY29uc3QgcG9wdWxhclRhZ3MgPSB1c2VDYWxsYmFjaygobGltaXQ/OiBudW1iZXIpID0+IHtcclxuICAgIGNvbnN0IHNvcnRlZCA9IFsuLi52aXNpYmxlVGFncygpXS5zb3J0KChhLCBiKSA9PiBiLmNvdW50IC0gYS5jb3VudClcclxuICAgIHJldHVybiBsaW1pdCA/IHNvcnRlZC5zbGljZSgwLCBsaW1pdCkgOiBzb3J0ZWRcclxuICB9LCBbdmlzaWJsZVRhZ3NdKVxyXG5cclxuICAvLyBUYWcgYWN0aW9uc1xyXG4gIGNvbnN0IGRpc3BhdGNoID0gdXNlQ2FsbGJhY2soKGFjdGlvbjogVGFnQWN0aW9uKSA9PiB7XHJcbiAgICBzZXRUYWdzKHByZXZUYWdzID0+IHtcclxuICAgICAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xyXG4gICAgICAgIGNhc2UgJ0NSRUFURV9UQUcnOlxyXG4gICAgICAgICAgLy8gQ2hlY2sgaWYgdGFnIGFscmVhZHkgZXhpc3RzXHJcbiAgICAgICAgICBjb25zdCBleGlzdGluZ1RhZyA9IHByZXZUYWdzLmZpbmQodGFnID0+IFxyXG4gICAgICAgICAgICB0YWcubmFtZS50b0xvd2VyQ2FzZSgpID09PSBhY3Rpb24ucGF5bG9hZC5uYW1lLnRvTG93ZXJDYXNlKClcclxuICAgICAgICAgIClcclxuICAgICAgICAgIGlmIChleGlzdGluZ1RhZykge1xyXG4gICAgICAgICAgICAvLyBJbmNyZW1lbnQgY291bnQgaWYgdGFnIGV4aXN0c1xyXG4gICAgICAgICAgICByZXR1cm4gcHJldlRhZ3MubWFwKHRhZyA9PlxyXG4gICAgICAgICAgICAgIHRhZy5pZCA9PT0gZXhpc3RpbmdUYWcuaWRcclxuICAgICAgICAgICAgICAgID8geyAuLi50YWcsIGNvdW50OiB0YWcuY291bnQgKyAxIH1cclxuICAgICAgICAgICAgICAgIDogdGFnXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIFxyXG4gICAgICAgICAgLy8gQ3JlYXRlIG5ldyB0YWdcclxuICAgICAgICAgIGNvbnN0IG5ld1RhZzogVGFnID0ge1xyXG4gICAgICAgICAgICAuLi5hY3Rpb24ucGF5bG9hZCxcclxuICAgICAgICAgICAgaWQ6IGB0YWctJHtEYXRlLm5vdygpfWAsXHJcbiAgICAgICAgICAgIGNvdW50OiAxLFxyXG4gICAgICAgICAgICBjb2xvcjogYWN0aW9uLnBheWxvYWQuY29sb3IgfHwgVEFHX0NPTE9SU1twcmV2VGFncy5sZW5ndGggJSBUQUdfQ09MT1JTLmxlbmd0aF0sXHJcbiAgICAgICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIFsuLi5wcmV2VGFncywgbmV3VGFnXVxyXG5cclxuICAgICAgICBjYXNlICdVUERBVEVfVEFHJzpcclxuICAgICAgICAgIHJldHVybiBwcmV2VGFncy5tYXAodGFnID0+XHJcbiAgICAgICAgICAgIHRhZy5pZCA9PT0gYWN0aW9uLnBheWxvYWQuaWRcclxuICAgICAgICAgICAgICA/IHsgLi4udGFnLCAuLi5hY3Rpb24ucGF5bG9hZC51cGRhdGVzIH1cclxuICAgICAgICAgICAgICA6IHRhZ1xyXG4gICAgICAgICAgKVxyXG5cclxuICAgICAgICBjYXNlICdERUxFVEVfVEFHJzpcclxuICAgICAgICAgIHJldHVybiBwcmV2VGFncy5maWx0ZXIodGFnID0+IHRhZy5pZCAhPT0gYWN0aW9uLnBheWxvYWQpXHJcblxyXG4gICAgICAgIGNhc2UgJ1RPR0dMRV9UQUdfVklTSUJJTElUWSc6XHJcbiAgICAgICAgICBzZXRIaWRkZW5UYWdzKHByZXYgPT4gXHJcbiAgICAgICAgICAgIHByZXYuaW5jbHVkZXMoYWN0aW9uLnBheWxvYWQpXHJcbiAgICAgICAgICAgICAgPyBwcmV2LmZpbHRlcihpZCA9PiBpZCAhPT0gYWN0aW9uLnBheWxvYWQpXHJcbiAgICAgICAgICAgICAgOiBbLi4ucHJldiwgYWN0aW9uLnBheWxvYWRdXHJcbiAgICAgICAgICApXHJcbiAgICAgICAgICByZXR1cm4gcHJldlRhZ3NcclxuXHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgIHJldHVybiBwcmV2VGFnc1xyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH0sIFtdKVxyXG5cclxuICAvLyBVdGlsaXR5IGZ1bmN0aW9uc1xyXG4gIGNvbnN0IGdldFRhZ0J5SWQgPSB1c2VDYWxsYmFjaygoaWQ6IHN0cmluZykgPT4ge1xyXG4gICAgcmV0dXJuIHRhZ3MuZmluZCh0YWcgPT4gdGFnLmlkID09PSBpZClcclxuICB9LCBbdGFnc10pXHJcblxyXG4gIGNvbnN0IGdldFRhZ0J5TmFtZSA9IHVzZUNhbGxiYWNrKChuYW1lOiBzdHJpbmcpID0+IHtcclxuICAgIHJldHVybiB0YWdzLmZpbmQodGFnID0+IHRhZy5uYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKSlcclxuICB9LCBbdGFnc10pXHJcblxyXG4gIGNvbnN0IGNyZWF0ZVRhZ0lmTm90RXhpc3RzID0gdXNlQ2FsbGJhY2soKG5hbWU6IHN0cmluZywgY29sb3I/OiBzdHJpbmcpID0+IHtcclxuICAgIGNvbnN0IGV4aXN0aW5nID0gZ2V0VGFnQnlOYW1lKG5hbWUpXHJcbiAgICBpZiAoZXhpc3RpbmcpIHtcclxuICAgICAgcmV0dXJuIGV4aXN0aW5nXHJcbiAgICB9XHJcbiAgICBcclxuICAgIGRpc3BhdGNoKHtcclxuICAgICAgdHlwZTogJ0NSRUFURV9UQUcnLFxyXG4gICAgICBwYXlsb2FkOiB7IG5hbWUsIGNvbG9yOiBjb2xvciB8fCBUQUdfQ09MT1JTW3RhZ3MubGVuZ3RoICUgVEFHX0NPTE9SUy5sZW5ndGhdIH1cclxuICAgIH0pXHJcbiAgICBcclxuICAgIHJldHVybiBudWxsIC8vIFRhZyB3aWxsIGJlIGNyZWF0ZWQgYXN5bmNocm9ub3VzbHlcclxuICB9LCBbZGlzcGF0Y2gsIGdldFRhZ0J5TmFtZSwgdGFncy5sZW5ndGhdKVxyXG5cclxuICBjb25zdCB1cGRhdGVUYWdDb3VudCA9IHVzZUNhbGxiYWNrKCh0YWdOYW1lOiBzdHJpbmcsIGluY3JlbWVudDogbnVtYmVyKSA9PiB7XHJcbiAgICBjb25zdCB0YWcgPSBnZXRUYWdCeU5hbWUodGFnTmFtZSlcclxuICAgIGlmICh0YWcpIHtcclxuICAgICAgY29uc3QgbmV3Q291bnQgPSBNYXRoLm1heCgwLCB0YWcuY291bnQgKyBpbmNyZW1lbnQpXHJcbiAgICAgIGlmIChuZXdDb3VudCA9PT0gMCkge1xyXG4gICAgICAgIGRpc3BhdGNoKHsgdHlwZTogJ0RFTEVURV9UQUcnLCBwYXlsb2FkOiB0YWcuaWQgfSlcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBkaXNwYXRjaCh7XHJcbiAgICAgICAgICB0eXBlOiAnVVBEQVRFX1RBRycsXHJcbiAgICAgICAgICBwYXlsb2FkOiB7IGlkOiB0YWcuaWQsIHVwZGF0ZXM6IHsgY291bnQ6IG5ld0NvdW50IH0gfVxyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9LCBbZGlzcGF0Y2gsIGdldFRhZ0J5TmFtZV0pXHJcblxyXG4gIGNvbnN0IHN5bmNUYWdzV2l0aENhcmRzID0gdXNlQ2FsbGJhY2soKGFsbENhcmRUYWdzOiBzdHJpbmdbXSkgPT4ge1xyXG4gICAgLy8gQ291bnQgdGFnIHVzYWdlXHJcbiAgICBjb25zdCB0YWdDb3VudHMgPSBhbGxDYXJkVGFncy5yZWR1Y2UoKGFjYywgdGFnTmFtZSkgPT4ge1xyXG4gICAgICBhY2NbdGFnTmFtZV0gPSAoYWNjW3RhZ05hbWVdIHx8IDApICsgMVxyXG4gICAgICByZXR1cm4gYWNjXHJcbiAgICB9LCB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+KVxyXG5cclxuICAgIC8vIFVwZGF0ZSBleGlzdGluZyB0YWdzIGFuZCBjcmVhdGUgbmV3IG9uZXNcclxuICAgIGNvbnN0IHVwZGF0ZWRUYWdzID0gdGFncy5tYXAodGFnID0+ICh7XHJcbiAgICAgIC4uLnRhZyxcclxuICAgICAgY291bnQ6IHRhZ0NvdW50c1t0YWcubmFtZV0gfHwgMFxyXG4gICAgfSkpXHJcbiAgICBcclxuICAgIGNvbnN0IGV4aXN0aW5nVGFnTmFtZXMgPSBuZXcgU2V0KHRhZ3MubWFwKHRhZyA9PiB0YWcubmFtZSkpXHJcblxyXG4gICAgLy8gQ3JlYXRlIG5ldyB0YWdzXHJcbiAgICBPYmplY3QuZW50cmllcyh0YWdDb3VudHMpLmZvckVhY2goKFt0YWdOYW1lLCBjb3VudF0pID0+IHtcclxuICAgICAgaWYgKCFleGlzdGluZ1RhZ05hbWVzLmhhcyh0YWdOYW1lKSkge1xyXG4gICAgICAgIGNvbnN0IG5ld1RhZzogVGFnID0ge1xyXG4gICAgICAgICAgaWQ6IGB0YWctJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKCl9YCxcclxuICAgICAgICAgIG5hbWU6IHRhZ05hbWUsXHJcbiAgICAgICAgICBjb2xvcjogVEFHX0NPTE9SU1t1cGRhdGVkVGFncy5sZW5ndGggJSBUQUdfQ09MT1JTLmxlbmd0aF0sXHJcbiAgICAgICAgICBjb3VudCxcclxuICAgICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKVxyXG4gICAgICAgIH1cclxuICAgICAgICB1cGRhdGVkVGFncy5wdXNoKG5ld1RhZylcclxuICAgICAgfVxyXG4gICAgfSlcclxuXHJcbiAgICAvLyBSZW1vdmUgdGFncyB3aXRoIHplcm8gY291bnRcclxuICAgIGNvbnN0IGZpbmFsVGFncyA9IHVwZGF0ZWRUYWdzLmZpbHRlcih0YWcgPT4gdGFnLmNvdW50ID4gMClcclxuICAgIHNldFRhZ3MoZmluYWxUYWdzKVxyXG4gIH0sIFt0YWdzXSlcclxuXHJcbiAgY29uc3Qgc2VhcmNoVGFncyA9IHVzZUNhbGxiYWNrKChxdWVyeTogc3RyaW5nKSA9PiB7XHJcbiAgICBpZiAoIXF1ZXJ5LnRyaW0oKSkgcmV0dXJuIHZpc2libGVUYWdzKClcclxuICAgIFxyXG4gICAgY29uc3QgbG93ZXJjYXNlUXVlcnkgPSBxdWVyeS50b0xvd2VyQ2FzZSgpXHJcbiAgICByZXR1cm4gdmlzaWJsZVRhZ3MoKS5maWx0ZXIodGFnID0+XHJcbiAgICAgIHRhZy5uYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMobG93ZXJjYXNlUXVlcnkpXHJcbiAgICApXHJcbiAgfSwgW3Zpc2libGVUYWdzXSlcclxuXHJcbiAgY29uc3QgZ2V0VGFnU3VnZ2VzdGlvbnMgPSB1c2VDYWxsYmFjaygoaW5wdXQ6IHN0cmluZywgbGltaXQgPSA1KSA9PiB7XHJcbiAgICBpZiAoIWlucHV0LnRyaW0oKSkgcmV0dXJuIHBvcHVsYXJUYWdzKGxpbWl0KVxyXG4gICAgXHJcbiAgICBjb25zdCBtYXRjaGVzID0gc2VhcmNoVGFncyhpbnB1dClcclxuICAgIHJldHVybiBtYXRjaGVzLnNsaWNlKDAsIGxpbWl0KVxyXG4gIH0sIFtzZWFyY2hUYWdzLCBwb3B1bGFyVGFnc10pXHJcblxyXG4gIC8vIFJlbmFtZSB0YWdcclxuICBjb25zdCByZW5hbWVUYWcgPSB1c2VDYWxsYmFjaygob2xkTmFtZTogc3RyaW5nLCBuZXdOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgIGNvbnN0IHRhZyA9IGdldFRhZ0J5TmFtZShvbGROYW1lKVxyXG4gICAgaWYgKCF0YWcpIHJldHVybiBmYWxzZVxyXG5cclxuICAgIC8vIENoZWNrIGlmIG5ldyBuYW1lIGFscmVhZHkgZXhpc3RzXHJcbiAgICBjb25zdCBleGlzdGluZ1RhZyA9IGdldFRhZ0J5TmFtZShuZXdOYW1lKVxyXG4gICAgaWYgKGV4aXN0aW5nVGFnICYmIGV4aXN0aW5nVGFnLmlkICE9PSB0YWcuaWQpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlIC8vIE5hbWUgY29uZmxpY3RcclxuICAgIH1cclxuXHJcbiAgICBkaXNwYXRjaCh7XHJcbiAgICAgIHR5cGU6ICdVUERBVEVfVEFHJyxcclxuICAgICAgcGF5bG9hZDogeyBcclxuICAgICAgICBpZDogdGFnLmlkLCBcclxuICAgICAgICB1cGRhdGVzOiB7IG5hbWU6IG5ld05hbWUudHJpbSgpIH0gXHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgICByZXR1cm4gdHJ1ZVxyXG4gIH0sIFtkaXNwYXRjaCwgZ2V0VGFnQnlOYW1lXSlcclxuXHJcbiAgLy8gRGVsZXRlIHRhZyBieSBuYW1lXHJcbiAgY29uc3QgZGVsZXRlVGFnQnlOYW1lID0gdXNlQ2FsbGJhY2soKHRhZ05hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgY29uc3QgdGFnID0gZ2V0VGFnQnlOYW1lKHRhZ05hbWUpXHJcbiAgICBpZiAoIXRhZykgcmV0dXJuIGZhbHNlXHJcblxyXG4gICAgZGlzcGF0Y2goeyB0eXBlOiAnREVMRVRFX1RBRycsIHBheWxvYWQ6IHRhZy5pZCB9KVxyXG4gICAgcmV0dXJuIHRydWVcclxuICB9LCBbZGlzcGF0Y2gsIGdldFRhZ0J5TmFtZV0pXHJcblxyXG4gIC8vIEdldCBhbGwgdGFnIG5hbWVzIGZvciB2YWxpZGF0aW9uXHJcbiAgY29uc3QgZ2V0QWxsVGFnTmFtZXMgPSB1c2VDYWxsYmFjaygoKSA9PiB7XHJcbiAgICByZXR1cm4gdGFncy5tYXAodGFnID0+IHRhZy5uYW1lKVxyXG4gIH0sIFt0YWdzXSlcclxuXHJcbiAgLy8gQXV0by1zYXZlIHRvIGxvY2FsU3RvcmFnZVxyXG4gIHVzZUVmZmVjdCgoKSA9PiB7XHJcbiAgICBjb25zdCBzYXZlVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2NhcmRhbGwtdGFncycsIEpTT04uc3RyaW5naWZ5KHRhZ3MpKVxyXG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnY2FyZGFsbC1oaWRkZW4tdGFncycsIEpTT04uc3RyaW5naWZ5KGhpZGRlblRhZ3MpKVxyXG4gICAgfSwgMTAwMClcclxuXHJcbiAgICByZXR1cm4gKCkgPT4gY2xlYXJUaW1lb3V0KHNhdmVUaW1lcilcclxuICB9LCBbdGFncywgaGlkZGVuVGFnc10pXHJcblxyXG4gIC8vIExvYWQgZnJvbSBsb2NhbFN0b3JhZ2Ugb24gbW91bnRcclxuICB1c2VFZmZlY3QoKCkgPT4ge1xyXG4gICAgY29uc3Qgc2F2ZWRUYWdzID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2NhcmRhbGwtdGFncycpXHJcbiAgICBjb25zdCBzYXZlZEhpZGRlblRhZ3MgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY2FyZGFsbC1oaWRkZW4tdGFncycpXHJcbiAgICBcclxuICAgIGlmIChzYXZlZFRhZ3MpIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBwYXJzZWRUYWdzID0gSlNPTi5wYXJzZShzYXZlZFRhZ3MpXHJcbiAgICAgICAgc2V0VGFncyhwYXJzZWRUYWdzKVxyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIHNhdmVkIHRhZ3M6JywgZXJyb3IpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgaWYgKHNhdmVkSGlkZGVuVGFncykge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHBhcnNlZEhpZGRlblRhZ3MgPSBKU09OLnBhcnNlKHNhdmVkSGlkZGVuVGFncylcclxuICAgICAgICBzZXRIaWRkZW5UYWdzKHBhcnNlZEhpZGRlblRhZ3MpXHJcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGxvYWQgaGlkZGVuIHRhZ3M6JywgZXJyb3IpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9LCBbXSlcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHRhZ3M6IHZpc2libGVUYWdzKCksXHJcbiAgICBhbGxUYWdzOiB0YWdzLFxyXG4gICAgaGlkZGVuVGFncyxcclxuICAgIHBvcHVsYXJUYWdzLFxyXG4gICAgZGlzcGF0Y2gsXHJcbiAgICBnZXRUYWdCeUlkLFxyXG4gICAgZ2V0VGFnQnlOYW1lLFxyXG4gICAgY3JlYXRlVGFnSWZOb3RFeGlzdHMsXHJcbiAgICB1cGRhdGVUYWdDb3VudCxcclxuICAgIHN5bmNUYWdzV2l0aENhcmRzLFxyXG4gICAgc2VhcmNoVGFncyxcclxuICAgIGdldFRhZ1N1Z2dlc3Rpb25zLFxyXG4gICAgcmVuYW1lVGFnLFxyXG4gICAgZGVsZXRlVGFnQnlOYW1lLFxyXG4gICAgZ2V0QWxsVGFnTmFtZXNcclxuICB9XHJcbn0iXSwidmVyc2lvbiI6M30=