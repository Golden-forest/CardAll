0df0fd7e5d05d02cc3dc78ea2e3d9238
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.fileSystemService = void 0;
const database_1 = require("./database");
class FileSystemService {
    constructor() {
        Object.defineProperty(this, "config", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        Object.defineProperty(this, "directoryHandle", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: null
        });
        Object.defineProperty(this, "isSupported", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        this.config = {
            baseDirectory: 'CardAll',
            imageDirectory: 'images',
            tempDirectory: 'temp',
            cacheDirectory: 'cache'
        };
        this.isSupported = 'showDirectoryPicker' in window;
    }
    // 检查文件系统API支持
    isFileSystemAccessSupported() {
        return this.isSupported;
    }
    // 请求目录访问权限
    async requestDirectoryAccess() {
        if (!this.isSupported) {
            console.warn('File System Access API not supported, using fallback storage');
            return false;
        }
        try {
            this.directoryHandle = await window.showDirectoryPicker({
                mode: 'readwrite',
                startIn: 'documents'
            });
            // 创建必要的子目录
            await this.ensureDirectoryStructure();
            return true;
        }
        catch (error) {
            if (error.name === 'AbortError') {
                console.log('User cancelled directory selection');
            }
            else {
                console.error('Failed to access directory:', error);
            }
            return false;
        }
    }
    // 确保目录结构存在
    async ensureDirectoryStructure() {
        if (!this.directoryHandle)
            return;
        try {
            // 创建主要目录
            await this.getOrCreateDirectory(this.config.imageDirectory);
            await this.getOrCreateDirectory(this.config.tempDirectory);
            await this.getOrCreateDirectory(this.config.cacheDirectory);
            console.log('Directory structure created successfully');
        }
        catch (error) {
            console.error('Failed to create directory structure:', error);
        }
    }
    // 获取或创建目录
    async getOrCreateDirectory(name) {
        if (!this.directoryHandle) {
            throw new Error('No directory handle available');
        }
        try {
            return await this.directoryHandle.getDirectoryHandle(name);
        }
        catch (error) {
            // 目录不存在，创建它
            return await this.directoryHandle.getDirectoryHandle(name, { create: true });
        }
    }
    // 获取或创建嵌套目录路径
    async getOrCreateNestedDirectory(path) {
        if (!this.directoryHandle) {
            throw new Error('No directory handle available');
        }
        const parts = path.split('/');
        let currentHandle = this.directoryHandle;
        for (const part of parts) {
            if (part) {
                try {
                    currentHandle = await currentHandle.getDirectoryHandle(part);
                }
                catch (error) {
                    currentHandle = await currentHandle.getDirectoryHandle(part, { create: true });
                }
            }
        }
        return currentHandle;
    }
    // 生成文件路径
    generateImagePath(cardId, folderId) {
        const folderPath = folderId || 'uncategorized';
        return `${this.config.imageDirectory}/${folderPath}/${cardId}`;
    }
    // 处理和保存图片
    async saveImage(file, cardId, folderId) {
        const imageId = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const fileName = `${imageId}.webp`;
        const imagePath = this.generateImagePath(cardId, folderId);
        const fullPath = `${imagePath}/${fileName}`;
        try {
            // 处理图片（压缩和转换格式）
            const processedBlob = await this.processImage(file);
            const metadata = await this.getImageMetadata(file, processedBlob);
            if (this.isSupported && this.directoryHandle) {
                // 使用File System Access API保存
                await this.saveToFileSystem(fullPath, processedBlob);
            }
            else {
                // 降级到IndexedDB存储
                await this.saveToIndexedDB(fullPath, processedBlob);
            }
            // 保存图片记录到数据库
            const dbImage = {
                id: imageId,
                cardId,
                fileName,
                filePath: fullPath,
                metadata,
                createdAt: new Date(),
                syncVersion: 1,
                pendingSync: true
            };
            await database_1.db.images.add(dbImage);
            return {
                id: imageId,
                fileName,
                filePath: fullPath,
                metadata
            };
        }
        catch (error) {
            console.error('Failed to save image:', error);
            throw error;
        }
    }
    // 处理图片（压缩和格式转换）
    async processImage(file) {
        return new Promise((resolve, reject) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                try {
                    // 计算目标尺寸
                    const maxWidth = 1920;
                    const maxHeight = 1080;
                    let { width, height } = img;
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    // 绘制图片
                    ctx?.drawImage(img, 0, 0, width, height);
                    // 转换为WebP格式
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        }
                        else {
                            reject(new Error('Failed to convert image'));
                        }
                    }, 'image/webp', 0.8 // 质量设置
                    );
                }
                catch (error) {
                    reject(error);
                }
            };
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = URL.createObjectURL(file);
        });
    }
    // 获取图片元数据
    async getImageMetadata(originalFile, processedBlob) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                resolve({
                    originalName: originalFile.name,
                    size: processedBlob.size,
                    width: img.width,
                    height: img.height,
                    format: 'webp',
                    compressed: true
                });
            };
            img.src = URL.createObjectURL(processedBlob);
        });
    }
    // 保存到文件系统
    async saveToFileSystem(path, blob) {
        if (!this.directoryHandle) {
            throw new Error('No directory handle available');
        }
        const pathParts = path.split('/');
        const fileName = pathParts.pop();
        const dirPath = pathParts.join('/');
        // 创建目录结构
        const dirHandle = await this.getOrCreateNestedDirectory(dirPath);
        // 创建文件
        const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
    }
    // 降级保存到IndexedDB
    async saveToIndexedDB(path, blob) {
        // 将blob转换为ArrayBuffer存储在IndexedDB中
        const arrayBuffer = await blob.arrayBuffer();
        // 这里可以使用一个专门的表来存储文件数据
        // 暂时先用localStorage作为演示
        const base64 = await this.blobToBase64(blob);
        localStorage.setItem(`cardall_file_${path}`, base64);
    }
    // Blob转Base64
    blobToBase64(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }
    // 获取图片
    async getImage(imagePath) {
        try {
            if (this.isSupported && this.directoryHandle) {
                return await this.getFromFileSystem(imagePath);
            }
            else {
                return await this.getFromIndexedDB(imagePath);
            }
        }
        catch (error) {
            console.error('Failed to get image:', error);
            throw error;
        }
    }
    // 从文件系统获取图片
    async getFromFileSystem(path) {
        if (!this.directoryHandle) {
            throw new Error('No directory handle available');
        }
        const pathParts = path.split('/');
        const fileName = pathParts.pop();
        const dirPath = pathParts.join('/');
        const dirHandle = await this.getOrCreateNestedDirectory(dirPath);
        const fileHandle = await dirHandle.getFileHandle(fileName);
        const file = await fileHandle.getFile();
        return URL.createObjectURL(file);
    }
    // 从IndexedDB获取图片
    async getFromIndexedDB(path) {
        const base64 = localStorage.getItem(`cardall_file_${path}`);
        if (!base64) {
            throw new Error('Image not found in storage');
        }
        return base64;
    }
    // 删除图片
    async deleteImage(imagePath) {
        try {
            if (this.isSupported && this.directoryHandle) {
                await this.deleteFromFileSystem(imagePath);
            }
            else {
                await this.deleteFromIndexedDB(imagePath);
            }
            // 从数据库中删除记录
            await database_1.db.images.where('filePath').equals(imagePath).delete();
        }
        catch (error) {
            console.error('Failed to delete image:', error);
            throw error;
        }
    }
    // 从文件系统删除
    async deleteFromFileSystem(path) {
        if (!this.directoryHandle)
            return;
        try {
            const pathParts = path.split('/');
            const fileName = pathParts.pop();
            const dirPath = pathParts.join('/');
            const dirHandle = await this.getOrCreateNestedDirectory(dirPath);
            await dirHandle.removeEntry(fileName);
        }
        catch (error) {
            console.warn('Failed to delete file from filesystem:', error);
        }
    }
    // 从IndexedDB删除
    async deleteFromIndexedDB(path) {
        localStorage.removeItem(`cardall_file_${path}`);
    }
    // 获取存储统计信息
    async getStorageStats() {
        const images = await database_1.db.images.toArray();
        const totalSize = images.reduce((sum, img) => sum + img.metadata.size, 0);
        return {
            totalImages: images.length,
            totalSize,
            storageMode: this.isSupported && this.directoryHandle ? 'filesystem' : 'indexeddb'
        };
    }
}
// 创建文件系统服务实例
exports.fileSystemService = new FileSystemService();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRDpcXFByb2plY3RzXFxDYXJkRXZlcnl0aGluZ1xcY2FyZGFsbC1wcm90b3R5cGVcXHNyY1xcc2VydmljZXNcXGZpbGUtc3lzdGVtLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHlDQUF3QztBQXdCeEMsTUFBTSxpQkFBaUI7SUFLckI7UUFKUTs7Ozs7V0FBd0I7UUFDeEI7Ozs7bUJBQW9ELElBQUk7V0FBQTtRQUN4RDs7Ozs7V0FBb0I7UUFHMUIsSUFBSSxDQUFDLE1BQU0sR0FBRztZQUNaLGFBQWEsRUFBRSxTQUFTO1lBQ3hCLGNBQWMsRUFBRSxRQUFRO1lBQ3hCLGFBQWEsRUFBRSxNQUFNO1lBQ3JCLGNBQWMsRUFBRSxPQUFPO1NBQ3hCLENBQUE7UUFFRCxJQUFJLENBQUMsV0FBVyxHQUFHLHFCQUFxQixJQUFJLE1BQU0sQ0FBQTtJQUNwRCxDQUFDO0lBRUQsY0FBYztJQUNkLDJCQUEyQjtRQUN6QixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUE7SUFDekIsQ0FBQztJQUVELFdBQVc7SUFDWCxLQUFLLENBQUMsc0JBQXNCO1FBQzFCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDdEIsT0FBTyxDQUFDLElBQUksQ0FBQyw4REFBOEQsQ0FBQyxDQUFBO1lBQzVFLE9BQU8sS0FBSyxDQUFBO1FBQ2QsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxlQUFlLEdBQUcsTUFBTyxNQUFjLENBQUMsbUJBQW1CLENBQUM7Z0JBQy9ELElBQUksRUFBRSxXQUFXO2dCQUNqQixPQUFPLEVBQUUsV0FBVzthQUNyQixDQUFDLENBQUE7WUFFRixXQUFXO1lBQ1gsTUFBTSxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQTtZQUNyQyxPQUFPLElBQUksQ0FBQTtRQUNiLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFlBQVksRUFBRSxDQUFDO2dCQUNoQyxPQUFPLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxDQUFD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RSxDQUFDLENBQUE7SUFDakQsQ0FBQztJQUVELFdBQVc7SUFDWCxLQUFLLENBQUMsZUFBZTtRQUtuQixNQUFNLE1BQU0sR0FBRyxNQUFNLGFBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUE7UUFDeEMsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUV6RSxPQUFPO1lBQ0wsV0FBVyxFQUFFLE1BQU0sQ0FBQyxNQUFNO1lBQzFCLFNBQVM7WUFDVCxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLFdBQVc7U0FDbkYsQ0FBQTtJQUNILENBQUM7Q0FDRjtBQUVELGFBQWE7QUFDQSxRQUFBLGlCQUFpQixHQUFHLElBQUksaUJBQWlCLEVBQUUsQ0FBQSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJEOlxcUHJvamVjdHNcXENhcmRFdmVyeXRoaW5nXFxjYXJkYWxsLXByb3RvdHlwZVxcc3JjXFxzZXJ2aWNlc1xcZmlsZS1zeXN0ZW0udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGIsIERiSW1hZ2UgfSBmcm9tICcuL2RhdGFiYXNlJ1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGaWxlU3lzdGVtQ29uZmlnIHtcclxuICBiYXNlRGlyZWN0b3J5OiBzdHJpbmdcclxuICBpbWFnZURpcmVjdG9yeTogc3RyaW5nXHJcbiAgdGVtcERpcmVjdG9yeTogc3RyaW5nXHJcbiAgY2FjaGVEaXJlY3Rvcnk6IHN0cmluZ1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFByb2Nlc3NlZEltYWdlIHtcclxuICBpZDogc3RyaW5nXHJcbiAgZmlsZU5hbWU6IHN0cmluZ1xyXG4gIGZpbGVQYXRoOiBzdHJpbmdcclxuICB0aHVtYm5haWxQYXRoPzogc3RyaW5nXHJcbiAgbWV0YWRhdGE6IHtcclxuICAgIG9yaWdpbmFsTmFtZTogc3RyaW5nXHJcbiAgICBzaXplOiBudW1iZXJcclxuICAgIHdpZHRoOiBudW1iZXJcclxuICAgIGhlaWdodDogbnVtYmVyXHJcbiAgICBmb3JtYXQ6IHN0cmluZ1xyXG4gICAgY29tcHJlc3NlZDogYm9vbGVhblxyXG4gIH1cclxufVxyXG5cclxuY2xhc3MgRmlsZVN5c3RlbVNlcnZpY2Uge1xyXG4gIHByaXZhdGUgY29uZmlnOiBGaWxlU3lzdGVtQ29uZmlnXHJcbiAgcHJpdmF0ZSBkaXJlY3RvcnlIYW5kbGU6IEZpbGVTeXN0ZW1EaXJlY3RvcnlIYW5kbGUgfCBudWxsID0gbnVsbFxyXG4gIHByaXZhdGUgaXNTdXBwb3J0ZWQ6IGJvb2xlYW5cclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLmNvbmZpZyA9IHtcclxuICAgICAgYmFzZURpcmVjdG9yeTogJ0NhcmRBbGwnLFxyXG4gICAgICBpbWFnZURpcmVjdG9yeTogJ2ltYWdlcycsXHJcbiAgICAgIHRlbXBEaXJlY3Rvcnk6ICd0ZW1wJyxcclxuICAgICAgY2FjaGVEaXJlY3Rvcnk6ICdjYWNoZSdcclxuICAgIH1cclxuICAgIFxyXG4gICAgdGhpcy5pc1N1cHBvcnRlZCA9ICdzaG93RGlyZWN0b3J5UGlja2VyJyBpbiB3aW5kb3dcclxuICB9XHJcblxyXG4gIC8vIOajgOafpeaWh+S7tuezu+e7n0FQSeaUr+aMgVxyXG4gIGlzRmlsZVN5c3RlbUFjY2Vzc1N1cHBvcnRlZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLmlzU3VwcG9ydGVkXHJcbiAgfVxyXG5cclxuICAvLyDor7fmsYLnm67lvZXorr/pl67mnYPpmZBcclxuICBhc3luYyByZXF1ZXN0RGlyZWN0b3J5QWNjZXNzKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgaWYgKCF0aGlzLmlzU3VwcG9ydGVkKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybignRmlsZSBTeXN0ZW0gQWNjZXNzIEFQSSBub3Qgc3VwcG9ydGVkLCB1c2luZyBmYWxsYmFjayBzdG9yYWdlJylcclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgdGhpcy5kaXJlY3RvcnlIYW5kbGUgPSBhd2FpdCAod2luZG93IGFzIGFueSkuc2hvd0RpcmVjdG9yeVBpY2tlcih7XHJcbiAgICAgICAgbW9kZTogJ3JlYWR3cml0ZScsXHJcbiAgICAgICAgc3RhcnRJbjogJ2RvY3VtZW50cydcclxuICAgICAgfSlcclxuICAgICAgXHJcbiAgICAgIC8vIOWIm+W7uuW/heimgeeahOWtkOebruW9lVxyXG4gICAgICBhd2FpdCB0aGlzLmVuc3VyZURpcmVjdG9yeVN0cnVjdHVyZSgpXHJcbiAgICAgIHJldHVybiB0cnVlXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ0Fib3J0RXJyb3InKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ1VzZXIgY2FuY2VsbGVkIGRpcmVjdG9yeSBzZWxlY3Rpb24nKVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBhY2Nlc3MgZGlyZWN0b3J5OicsIGVycm9yKVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8g56Gu5L+d55uu5b2V57uT5p6E5a2Y5ZyoXHJcbiAgcHJpdmF0ZSBhc3luYyBlbnN1cmVEaXJlY3RvcnlTdHJ1Y3R1cmUoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBpZiAoIXRoaXMuZGlyZWN0b3J5SGFuZGxlKSByZXR1cm5cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAvLyDliJvlu7rkuLvopoHnm67lvZVcclxuICAgICAgYXdhaXQgdGhpcy5nZXRPckNyZWF0ZURpcmVjdG9yeSh0aGlzLmNvbmZpZy5pbWFnZURpcmVjdG9yeSlcclxuICAgICAgYXdhaXQgdGhpcy5nZXRPckNyZWF0ZURpcmVjdG9yeSh0aGlzLmNvbmZpZy50ZW1wRGlyZWN0b3J5KVxyXG4gICAgICBhd2FpdCB0aGlzLmdldE9yQ3JlYXRlRGlyZWN0b3J5KHRoaXMuY29uZmlnLmNhY2hlRGlyZWN0b3J5KVxyXG4gICAgICBcclxuICAgICAgY29uc29sZS5sb2coJ0RpcmVjdG9yeSBzdHJ1Y3R1cmUgY3JlYXRlZCBzdWNjZXNzZnVsbHknKVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGNyZWF0ZSBkaXJlY3Rvcnkgc3RydWN0dXJlOicsIGVycm9yKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8g6I635Y+W5oiW5Yib5bu655uu5b2VXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRPckNyZWF0ZURpcmVjdG9yeShuYW1lOiBzdHJpbmcpOiBQcm9taXNlPEZpbGVTeXN0ZW1EaXJlY3RvcnlIYW5kbGU+IHtcclxuICAgIGlmICghdGhpcy5kaXJlY3RvcnlIYW5kbGUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBkaXJlY3RvcnkgaGFuZGxlIGF2YWlsYWJsZScpXHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZGlyZWN0b3J5SGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShuYW1lKVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgLy8g55uu5b2V5LiN5a2Y5Zyo77yM5Yib5bu65a6DXHJcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmRpcmVjdG9yeUhhbmRsZS5nZXREaXJlY3RvcnlIYW5kbGUobmFtZSwgeyBjcmVhdGU6IHRydWUgfSlcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOiOt+WPluaIluWIm+W7uuW1jOWll+ebruW9lei3r+W+hFxyXG4gIHByaXZhdGUgYXN5bmMgZ2V0T3JDcmVhdGVOZXN0ZWREaXJlY3RvcnkocGF0aDogc3RyaW5nKTogUHJvbWlzZTxGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlPiB7XHJcbiAgICBpZiAoIXRoaXMuZGlyZWN0b3J5SGFuZGxlKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gZGlyZWN0b3J5IGhhbmRsZSBhdmFpbGFibGUnKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHBhcnRzID0gcGF0aC5zcGxpdCgnLycpXHJcbiAgICBsZXQgY3VycmVudEhhbmRsZSA9IHRoaXMuZGlyZWN0b3J5SGFuZGxlXHJcblxyXG4gICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhcnRzKSB7XHJcbiAgICAgIGlmIChwYXJ0KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGN1cnJlbnRIYW5kbGUgPSBhd2FpdCBjdXJyZW50SGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShwYXJ0KVxyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICBjdXJyZW50SGFuZGxlID0gYXdhaXQgY3VycmVudEhhbmRsZS5nZXREaXJlY3RvcnlIYW5kbGUocGFydCwgeyBjcmVhdGU6IHRydWUgfSlcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY3VycmVudEhhbmRsZVxyXG4gIH1cclxuXHJcbiAgLy8g55Sf5oiQ5paH5Lu26Lev5b6EXHJcbiAgZ2VuZXJhdGVJbWFnZVBhdGgoY2FyZElkOiBzdHJpbmcsIGZvbGRlcklkPzogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGZvbGRlclBhdGggPSBmb2xkZXJJZCB8fCAndW5jYXRlZ29yaXplZCdcclxuICAgIHJldHVybiBgJHt0aGlzLmNvbmZpZy5pbWFnZURpcmVjdG9yeX0vJHtmb2xkZXJQYXRofS8ke2NhcmRJZH1gXHJcbiAgfVxyXG5cclxuICAvLyDlpITnkIblkozkv53lrZjlm77niYdcclxuICBhc3luYyBzYXZlSW1hZ2UoXHJcbiAgICBmaWxlOiBGaWxlLCBcclxuICAgIGNhcmRJZDogc3RyaW5nLCBcclxuICAgIGZvbGRlcklkPzogc3RyaW5nXHJcbiAgKTogUHJvbWlzZTxQcm9jZXNzZWRJbWFnZT4ge1xyXG4gICAgY29uc3QgaW1hZ2VJZCA9IGBpbWdfJHtEYXRlLm5vdygpfV8ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gXHJcbiAgICBjb25zdCBmaWxlTmFtZSA9IGAke2ltYWdlSWR9LndlYnBgXHJcbiAgICBjb25zdCBpbWFnZVBhdGggPSB0aGlzLmdlbmVyYXRlSW1hZ2VQYXRoKGNhcmRJZCwgZm9sZGVySWQpXHJcbiAgICBjb25zdCBmdWxsUGF0aCA9IGAke2ltYWdlUGF0aH0vJHtmaWxlTmFtZX1gXHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgLy8g5aSE55CG5Zu+54mH77yI5Y6L57yp5ZKM6L2s5o2i5qC85byP77yJXHJcbiAgICAgIGNvbnN0IHByb2Nlc3NlZEJsb2IgPSBhd2FpdCB0aGlzLnByb2Nlc3NJbWFnZShmaWxlKVxyXG4gICAgICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IHRoaXMuZ2V0SW1hZ2VNZXRhZGF0YShmaWxlLCBwcm9jZXNzZWRCbG9iKVxyXG5cclxuICAgICAgaWYgKHRoaXMuaXNTdXBwb3J0ZWQgJiYgdGhpcy5kaXJlY3RvcnlIYW5kbGUpIHtcclxuICAgICAgICAvLyDkvb/nlKhGaWxlIFN5c3RlbSBBY2Nlc3MgQVBJ5L+d5a2YXHJcbiAgICAgICAgYXdhaXQgdGhpcy5zYXZlVG9GaWxlU3lzdGVtKGZ1bGxQYXRoLCBwcm9jZXNzZWRCbG9iKVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIOmZjee6p+WIsEluZGV4ZWREQuWtmOWCqFxyXG4gICAgICAgIGF3YWl0IHRoaXMuc2F2ZVRvSW5kZXhlZERCKGZ1bGxQYXRoLCBwcm9jZXNzZWRCbG9iKVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDkv53lrZjlm77niYforrDlvZXliLDmlbDmja7lupNcclxuICAgICAgY29uc3QgZGJJbWFnZTogRGJJbWFnZSA9IHtcclxuICAgICAgICBpZDogaW1hZ2VJZCxcclxuICAgICAgICBjYXJkSWQsXHJcbiAgICAgICAgZmlsZU5hbWUsXHJcbiAgICAgICAgZmlsZVBhdGg6IGZ1bGxQYXRoLFxyXG4gICAgICAgIG1ldGFkYXRhLFxyXG4gICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcclxuICAgICAgICBzeW5jVmVyc2lvbjogMSxcclxuICAgICAgICBwZW5kaW5nU3luYzogdHJ1ZVxyXG4gICAgICB9XHJcblxyXG4gICAgICBhd2FpdCBkYi5pbWFnZXMuYWRkKGRiSW1hZ2UpXHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGlkOiBpbWFnZUlkLFxyXG4gICAgICAgIGZpbGVOYW1lLFxyXG4gICAgICAgIGZpbGVQYXRoOiBmdWxsUGF0aCxcclxuICAgICAgICBtZXRhZGF0YVxyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2F2ZSBpbWFnZTonLCBlcnJvcilcclxuICAgICAgdGhyb3cgZXJyb3JcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOWkhOeQhuWbvueJh++8iOWOi+e8qeWSjOagvOW8j+i9rOaNou+8iVxyXG4gIHByaXZhdGUgYXN5bmMgcHJvY2Vzc0ltYWdlKGZpbGU6IEZpbGUpOiBQcm9taXNlPEJsb2I+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpXHJcbiAgICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpXHJcbiAgICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpXHJcblxyXG4gICAgICBpbWcub25sb2FkID0gKCkgPT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAvLyDorqHnrpfnm67moIflsLrlr7hcclxuICAgICAgICAgIGNvbnN0IG1heFdpZHRoID0gMTkyMFxyXG4gICAgICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gMTA4MFxyXG4gICAgICAgICAgbGV0IHsgd2lkdGgsIGhlaWdodCB9ID0gaW1nXHJcblxyXG4gICAgICAgICAgaWYgKHdpZHRoID4gbWF4V2lkdGggfHwgaGVpZ2h0ID4gbWF4SGVpZ2h0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4obWF4V2lkdGggLyB3aWR0aCwgbWF4SGVpZ2h0IC8gaGVpZ2h0KVxyXG4gICAgICAgICAgICB3aWR0aCAqPSByYXRpb1xyXG4gICAgICAgICAgICBoZWlnaHQgKj0gcmF0aW9cclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBjYW52YXMud2lkdGggPSB3aWR0aFxyXG4gICAgICAgICAgY2FudmFzLmhlaWdodCA9IGhlaWdodFxyXG5cclxuICAgICAgICAgIC8vIOe7mOWItuWbvueJh1xyXG4gICAgICAgICAgY3R4Py5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KVxyXG5cclxuICAgICAgICAgIC8vIOi9rOaNouS4uldlYlDmoLzlvI9cclxuICAgICAgICAgIGNhbnZhcy50b0Jsb2IoXHJcbiAgICAgICAgICAgIChibG9iKSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKGJsb2IpIHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoYmxvYilcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignRmFpbGVkIHRvIGNvbnZlcnQgaW1hZ2UnKSlcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICdpbWFnZS93ZWJwJyxcclxuICAgICAgICAgICAgMC44IC8vIOi0qOmHj+iuvue9rlxyXG4gICAgICAgICAgKVxyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICByZWplY3QoZXJyb3IpXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpbWcub25lcnJvciA9ICgpID0+IHJlamVjdChuZXcgRXJyb3IoJ0ZhaWxlZCB0byBsb2FkIGltYWdlJykpXHJcbiAgICAgIGltZy5zcmMgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGZpbGUpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgLy8g6I635Y+W5Zu+54mH5YWD5pWw5o2uXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRJbWFnZU1ldGFkYXRhKG9yaWdpbmFsRmlsZTogRmlsZSwgcHJvY2Vzc2VkQmxvYjogQmxvYik6IFByb21pc2U8YW55PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcclxuICAgICAgY29uc3QgaW1nID0gbmV3IEltYWdlKClcclxuICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHtcclxuICAgICAgICByZXNvbHZlKHtcclxuICAgICAgICAgIG9yaWdpbmFsTmFtZTogb3JpZ2luYWxGaWxlLm5hbWUsXHJcbiAgICAgICAgICBzaXplOiBwcm9jZXNzZWRCbG9iLnNpemUsXHJcbiAgICAgICAgICB3aWR0aDogaW1nLndpZHRoLFxyXG4gICAgICAgICAgaGVpZ2h0OiBpbWcuaGVpZ2h0LFxyXG4gICAgICAgICAgZm9ybWF0OiAnd2VicCcsXHJcbiAgICAgICAgICBjb21wcmVzc2VkOiB0cnVlXHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG4gICAgICBpbWcuc3JjID0gVVJMLmNyZWF0ZU9iamVjdFVSTChwcm9jZXNzZWRCbG9iKVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIC8vIOS/neWtmOWIsOaWh+S7tuezu+e7n1xyXG4gIHByaXZhdGUgYXN5bmMgc2F2ZVRvRmlsZVN5c3RlbShwYXRoOiBzdHJpbmcsIGJsb2I6IEJsb2IpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGlmICghdGhpcy5kaXJlY3RvcnlIYW5kbGUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBkaXJlY3RvcnkgaGFuZGxlIGF2YWlsYWJsZScpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcGF0aFBhcnRzID0gcGF0aC5zcGxpdCgnLycpXHJcbiAgICBjb25zdCBmaWxlTmFtZSA9IHBhdGhQYXJ0cy5wb3AoKSFcclxuICAgIGNvbnN0IGRpclBhdGggPSBwYXRoUGFydHMuam9pbignLycpXHJcblxyXG4gICAgLy8g5Yib5bu655uu5b2V57uT5p6EXHJcbiAgICBjb25zdCBkaXJIYW5kbGUgPSBhd2FpdCB0aGlzLmdldE9yQ3JlYXRlTmVzdGVkRGlyZWN0b3J5KGRpclBhdGgpXHJcbiAgICBcclxuICAgIC8vIOWIm+W7uuaWh+S7tlxyXG4gICAgY29uc3QgZmlsZUhhbmRsZSA9IGF3YWl0IGRpckhhbmRsZS5nZXRGaWxlSGFuZGxlKGZpbGVOYW1lLCB7IGNyZWF0ZTogdHJ1ZSB9KVxyXG4gICAgY29uc3Qgd3JpdGFibGUgPSBhd2FpdCBmaWxlSGFuZGxlLmNyZWF0ZVdyaXRhYmxlKClcclxuICAgIFxyXG4gICAgYXdhaXQgd3JpdGFibGUud3JpdGUoYmxvYilcclxuICAgIGF3YWl0IHdyaXRhYmxlLmNsb3NlKClcclxuICB9XHJcblxyXG4gIC8vIOmZjee6p+S/neWtmOWIsEluZGV4ZWREQlxyXG4gIHByaXZhdGUgYXN5bmMgc2F2ZVRvSW5kZXhlZERCKHBhdGg6IHN0cmluZywgYmxvYjogQmxvYik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgLy8g5bCGYmxvYui9rOaNouS4ukFycmF5QnVmZmVy5a2Y5YKo5ZyoSW5kZXhlZERC5LitXHJcbiAgICBjb25zdCBhcnJheUJ1ZmZlciA9IGF3YWl0IGJsb2IuYXJyYXlCdWZmZXIoKVxyXG4gICAgXHJcbiAgICAvLyDov5nph4zlj6/ku6Xkvb/nlKjkuIDkuKrkuJPpl6jnmoTooajmnaXlrZjlgqjmlofku7bmlbDmja5cclxuICAgIC8vIOaaguaXtuWFiOeUqGxvY2FsU3RvcmFnZeS9nOS4uua8lOekulxyXG4gICAgY29uc3QgYmFzZTY0ID0gYXdhaXQgdGhpcy5ibG9iVG9CYXNlNjQoYmxvYilcclxuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGBjYXJkYWxsX2ZpbGVfJHtwYXRofWAsIGJhc2U2NClcclxuICB9XHJcblxyXG4gIC8vIEJsb2LovaxCYXNlNjRcclxuICBwcml2YXRlIGJsb2JUb0Jhc2U2NChibG9iOiBCbG9iKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcclxuICAgICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHJlc29sdmUocmVhZGVyLnJlc3VsdCBhcyBzdHJpbmcpXHJcbiAgICAgIHJlYWRlci5vbmVycm9yID0gcmVqZWN0XHJcbiAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGJsb2IpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgLy8g6I635Y+W5Zu+54mHXHJcbiAgYXN5bmMgZ2V0SW1hZ2UoaW1hZ2VQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKHRoaXMuaXNTdXBwb3J0ZWQgJiYgdGhpcy5kaXJlY3RvcnlIYW5kbGUpIHtcclxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRGcm9tRmlsZVN5c3RlbShpbWFnZVBhdGgpXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0RnJvbUluZGV4ZWREQihpbWFnZVBhdGgpXHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgaW1hZ2U6JywgZXJyb3IpXHJcbiAgICAgIHRocm93IGVycm9yXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDku47mlofku7bns7vnu5/ojrflj5blm77niYdcclxuICBwcml2YXRlIGFzeW5jIGdldEZyb21GaWxlU3lzdGVtKHBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICBpZiAoIXRoaXMuZGlyZWN0b3J5SGFuZGxlKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gZGlyZWN0b3J5IGhhbmRsZSBhdmFpbGFibGUnKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHBhdGhQYXJ0cyA9IHBhdGguc3BsaXQoJy8nKVxyXG4gICAgY29uc3QgZmlsZU5hbWUgPSBwYXRoUGFydHMucG9wKCkhXHJcbiAgICBjb25zdCBkaXJQYXRoID0gcGF0aFBhcnRzLmpvaW4oJy8nKVxyXG5cclxuICAgIGNvbnN0IGRpckhhbmRsZSA9IGF3YWl0IHRoaXMuZ2V0T3JDcmVhdGVOZXN0ZWREaXJlY3RvcnkoZGlyUGF0aClcclxuICAgIGNvbnN0IGZpbGVIYW5kbGUgPSBhd2FpdCBkaXJIYW5kbGUuZ2V0RmlsZUhhbmRsZShmaWxlTmFtZSlcclxuICAgIGNvbnN0IGZpbGUgPSBhd2FpdCBmaWxlSGFuZGxlLmdldEZpbGUoKVxyXG4gICAgXHJcbiAgICByZXR1cm4gVVJMLmNyZWF0ZU9iamVjdFVSTChmaWxlKVxyXG4gIH1cclxuXHJcbiAgLy8g5LuOSW5kZXhlZERC6I635Y+W5Zu+54mHXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRGcm9tSW5kZXhlZERCKHBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICBjb25zdCBiYXNlNjQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShgY2FyZGFsbF9maWxlXyR7cGF0aH1gKVxyXG4gICAgaWYgKCFiYXNlNjQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbWFnZSBub3QgZm91bmQgaW4gc3RvcmFnZScpXHJcbiAgICB9XHJcbiAgICByZXR1cm4gYmFzZTY0XHJcbiAgfVxyXG5cclxuICAvLyDliKDpmaTlm77niYdcclxuICBhc3luYyBkZWxldGVJbWFnZShpbWFnZVBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKHRoaXMuaXNTdXBwb3J0ZWQgJiYgdGhpcy5kaXJlY3RvcnlIYW5kbGUpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLmRlbGV0ZUZyb21GaWxlU3lzdGVtKGltYWdlUGF0aClcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBhd2FpdCB0aGlzLmRlbGV0ZUZyb21JbmRleGVkREIoaW1hZ2VQYXRoKVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDku47mlbDmja7lupPkuK3liKDpmaTorrDlvZVcclxuICAgICAgYXdhaXQgZGIuaW1hZ2VzLndoZXJlKCdmaWxlUGF0aCcpLmVxdWFscyhpbWFnZVBhdGgpLmRlbGV0ZSgpXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gZGVsZXRlIGltYWdlOicsIGVycm9yKVxyXG4gICAgICB0aHJvdyBlcnJvclxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8g5LuO5paH5Lu257O757uf5Yig6ZmkXHJcbiAgcHJpdmF0ZSBhc3luYyBkZWxldGVGcm9tRmlsZVN5c3RlbShwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGlmICghdGhpcy5kaXJlY3RvcnlIYW5kbGUpIHJldHVyblxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHBhdGhQYXJ0cyA9IHBhdGguc3BsaXQoJy8nKVxyXG4gICAgICBjb25zdCBmaWxlTmFtZSA9IHBhdGhQYXJ0cy5wb3AoKSFcclxuICAgICAgY29uc3QgZGlyUGF0aCA9IHBhdGhQYXJ0cy5qb2luKCcvJylcclxuXHJcbiAgICAgIGNvbnN0IGRpckhhbmRsZSA9IGF3YWl0IHRoaXMuZ2V0T3JDcmVhdGVOZXN0ZWREaXJlY3RvcnkoZGlyUGF0aClcclxuICAgICAgYXdhaXQgZGlySGFuZGxlLnJlbW92ZUVudHJ5KGZpbGVOYW1lKVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gZGVsZXRlIGZpbGUgZnJvbSBmaWxlc3lzdGVtOicsIGVycm9yKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8g5LuOSW5kZXhlZERC5Yig6ZmkXHJcbiAgcHJpdmF0ZSBhc3luYyBkZWxldGVGcm9tSW5kZXhlZERCKHBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oYGNhcmRhbGxfZmlsZV8ke3BhdGh9YClcclxuICB9XHJcblxyXG4gIC8vIOiOt+WPluWtmOWCqOe7n+iuoeS/oeaBr1xyXG4gIGFzeW5jIGdldFN0b3JhZ2VTdGF0cygpOiBQcm9taXNlPHtcclxuICAgIHRvdGFsSW1hZ2VzOiBudW1iZXJcclxuICAgIHRvdGFsU2l6ZTogbnVtYmVyXHJcbiAgICBzdG9yYWdlTW9kZTogJ2ZpbGVzeXN0ZW0nIHwgJ2luZGV4ZWRkYidcclxuICB9PiB7XHJcbiAgICBjb25zdCBpbWFnZXMgPSBhd2FpdCBkYi5pbWFnZXMudG9BcnJheSgpXHJcbiAgICBjb25zdCB0b3RhbFNpemUgPSBpbWFnZXMucmVkdWNlKChzdW0sIGltZykgPT4gc3VtICsgaW1nLm1ldGFkYXRhLnNpemUsIDApXHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdG90YWxJbWFnZXM6IGltYWdlcy5sZW5ndGgsXHJcbiAgICAgIHRvdGFsU2l6ZSxcclxuICAgICAgc3RvcmFnZU1vZGU6IHRoaXMuaXNTdXBwb3J0ZWQgJiYgdGhpcy5kaXJlY3RvcnlIYW5kbGUgPyAnZmlsZXN5c3RlbScgOiAnaW5kZXhlZGRiJ1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLy8g5Yib5bu65paH5Lu257O757uf5pyN5Yqh5a6e5L6LXHJcbmV4cG9ydCBjb25zdCBmaWxlU3lzdGVtU2VydmljZSA9IG5ldyBGaWxlU3lzdGVtU2VydmljZSgpIl0sInZlcnNpb24iOjN9