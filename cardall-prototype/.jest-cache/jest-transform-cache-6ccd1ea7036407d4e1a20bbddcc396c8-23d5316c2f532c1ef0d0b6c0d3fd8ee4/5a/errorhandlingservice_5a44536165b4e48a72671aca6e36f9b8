ffbe686951d9b845d16e26406e85b9fd
"use strict";
/**
 * 错误处理服务
 * 统一错误处理机制的集成服务，为同步服务提供完整的错误处理能力
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handleSystemError = exports.handleDataError = exports.handleNetworkError = exports.handleSyncError = exports.errorHandlingService = exports.CardAllErrorHandlingService = void 0;
const unified_error_handler_1 = require("./unified-error-handler");
const error_monitoring_service_1 = require("./error-monitoring-service");
const recovery_strategy_manager_1 = require("./recovery-strategy-manager");
const self_healing_framework_1 = require("./self-healing-framework");
const network_state_detector_1 = require("../network-state-detector");
/**
 * 错误处理服务实现
 */
class CardAllErrorHandlingService {
    constructor(config) {
        Object.defineProperty(this, "config", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        Object.defineProperty(this, "monitoringService", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        Object.defineProperty(this, "recoveryManager", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        Object.defineProperty(this, "selfHealingFramework", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        this.config = this.mergeWithDefaultConfig(config);
        this.initializeServices();
    }
    static getInstance(config) {
        if (!CardAllErrorHandlingService.instance) {
            CardAllErrorHandlingService.instance = new CardAllErrorHandlingService(config);
        }
        return CardAllErrorHandlingService.instance;
    }
    /**
     * 处理同步错误
     */
    async handleSyncError(error, context) {
        const errorContext = this.createContext('sync', context);
        const result = await (0, unified_error_handler_1.handleError)(error, errorContext);
        // 记录同步特定的错误信息
        if (result.error) {
            result.error.operation = 'sync';
            result.error.entity = context?.entityType;
        }
        return result;
    }
    /**
     * 处理网络错误
     */
    async handleNetworkError(error, context) {
        const errorContext = this.createContext('network', context);
        const result = await (0, unified_error_handler_1.handleError)(error, errorContext);
        // 网络错误特殊处理
        if (result.error?.category === unified_error_handler_1.ErrorCategory.NETWORK) {
            // 检查网络状态
            const networkState = network_state_detector_1.networkStateDetector.getCurrentState();
            result.error.details = {
                ...result.error.details,
                networkState,
                timestamp: new Date()
            };
        }
        return result;
    }
    /**
     * 处理数据错误
     */
    async handleDataError(error, context) {
        const errorContext = this.createContext('data', context);
        const result = await (0, unified_error_handler_1.handleError)(error, errorContext);
        // 数据错误特殊处理
        if (result.error?.category === unified_error_handler_1.ErrorCategory.DATA) {
            result.error.entity = context?.entity;
            result.error.details = {
                ...result.error.details,
                dataType: context?.dataType,
                operation: context?.operation
            };
        }
        return result;
    }
    /**
     * 处理系统错误
     */
    async handleSystemError(error, context) {
        const errorContext = this.createContext('system', context);
        const result = await (0, unified_error_handler_1.handleError)(error, errorContext);
        // 系统错误特殊处理
        if (result.error?.category === unified_error_handler_1.ErrorCategory.SYSTEM) {
            result.error.level = unified_error_handler_1.ErrorLevel.CRITICAL;
            result.error.retryable = false;
        }
        return result;
    }
    /**
     * 获取错误统计信息
     */
    getErrorStatistics() {
        if (!this.config.enableMonitoring) {
            return null;
        }
        return this.monitoringService.getMetrics();
    }
    /**
     * 获取健康状态
     */
    getHealthStatus() {
        const stats = this.getErrorStatistics();
        const metrics = stats?.metrics || {};
        // 计算健康分数
        let healthScore = 100;
        // 基于错误率调整健康分数
        if (metrics.errorRate > 0.1)
            healthScore -= 20;
        if (metrics.errorRate > 0.05)
            healthScore -= 10;
        // 基于恢复率调整健康分数
        if (metrics.recoveryRate < 0.8)
            healthScore -= 15;
        if (metrics.recoveryRate < 0.9)
            healthScore -= 5;
        // 确定健康状态
        let status;
        if (healthScore >= 90)
            status = 'healthy';
        else if (healthScore >= 70)
            status = 'degraded';
        else
            status = 'unhealthy';
        return {
            status,
            score: Math.max(0, healthScore),
            timestamp: new Date(),
            metrics,
            recommendations: this.generateRecommendations(status, metrics)
        };
    }
    /**
     * 获取最近的错误
     */
    getRecentErrors(limit = 50) {
        if (!this.config.enableMonitoring) {
            return [];
        }
        return this.monitoringService.getRecentErrors(limit);
    }
    /**
     * 更新配置
     */
    updateConfig(newConfig) {
        this.config = { ...this.config, ...newConfig };
        this.reconfigureServices();
    }
    /**
     * 获取当前配置
     */
    getConfig() {
        return { ...this.config };
    }
    /**
     * 尝试恢复错误
     */
    async attemptRecovery(error) {
        if (!this.config.enableRecovery) {
            return false;
        }
        try {
            const context = (0, unified_error_handler_1.createErrorContext)({ operation: error.operation }, error.userId, 'production');
            const result = await this.recoveryManager.attemptRecovery(error, context);
            return result.success;
        }
        catch (recoveryError) {
            console.error('Recovery attempt failed:', recoveryError);
            return false;
        }
    }
    /**
     * 触发自愈
     */
    async triggerSelfHealing(error) {
        if (!this.config.enableSelfHealing) {
            return false;
        }
        try {
            const context = (0, unified_error_handler_1.createErrorContext)({ operation: error.operation }, error.userId, 'production');
            return await this.selfHealingFramework.attemptHealing(error, context);
        }
        catch (healingError) {
            console.error('Self-healing attempt failed:', healingError);
            return false;
        }
    }
    /**
     * 初始化服务
     */
    initializeServices() {
        // 初始化监控服务
        if (this.config.enableMonitoring) {
            this.monitoringService = error_monitoring_service_1.ErrorMonitoringService.getInstance();
        }
        // 初始化恢复管理器
        if (this.config.enableRecovery) {
            this.recoveryManager = recovery_strategy_manager_1.RecoveryStrategyManager.getInstance({
                maxAttempts: this.config.recovery.maxRetries,
                baseDelay: this.config.recovery.baseDelay,
                maxDelay: this.config.recovery.maxDelay
            });
        }
        // 初始化自愈框架
        if (this.config.enableSelfHealing) {
            this.selfHealingFramework = self_healing_framework_1.SelfHealingFramework.getInstance({
                autoRepair: this.config.selfHealing.autoRepair,
                learningEnabled: this.config.selfHealing.learningEnabled,
                maxApplications: this.config.selfHealing.maxApplications
            });
        }
    }
    /**
     * 重新配置服务
     */
    reconfigureServices() {
        // 重新初始化服务以应用新配置
        this.initializeServices();
    }
    /**
     * 创建错误上下文
     */
    createContext(operation, additionalContext) {
        return (0, unified_error_handler_1.createErrorContext)({ operation, ...additionalContext }, additionalContext?.userId, additionalContext?.environment || 'development');
    }
    /**
     * 合并默认配置
     */
    mergeWithDefaultConfig(config) {
        const defaultConfig = {
            enableMonitoring: true,
            enableRecovery: true,
            enableSelfHealing: true,
            monitoring: {
                bufferSize: 1000,
                historySize: 168,
                sampleRate: 1.0
            },
            recovery: {
                maxRetries: 3,
                baseDelay: 1000,
                maxDelay: 30000,
                enableCircuitBreaker: true
            },
            selfHealing: {
                enabled: true,
                autoRepair: true,
                learningEnabled: true,
                maxApplications: 100
            },
            alerts: {
                enabled: true,
                severity: 'medium',
                channels: ['console']
            }
        };
        return { ...defaultConfig, ...config };
    }
    /**
     * 生成健康建议
     */
    generateRecommendations(status, metrics) {
        const recommendations = [];
        if (status === 'unhealthy') {
            recommendations.push('系统健康状况不佳，建议立即检查错误日志');
            recommendations.push('考虑启用自动恢复机制');
            recommendations.push('检查网络连接和服务器状态');
        }
        else if (status === 'degraded') {
            if (metrics.errorRate > 0.05) {
                recommendations.push('错误率较高，建议检查错误模式');
            }
            if (metrics.recoveryRate < 0.9) {
                recommendations.push('恢复率偏低，建议优化恢复策略');
            }
        }
        return recommendations;
    }
}
exports.CardAllErrorHandlingService = CardAllErrorHandlingService;
// 导出实例
exports.errorHandlingService = CardAllErrorHandlingService.getInstance();
// 导出便捷函数
const handleSyncError = (error, context) => exports.errorHandlingService.handleSyncError(error, context);
exports.handleSyncError = handleSyncError;
const handleNetworkError = (error, context) => exports.errorHandlingService.handleNetworkError(error, context);
exports.handleNetworkError = handleNetworkError;
const handleDataError = (error, context) => exports.errorHandlingService.handleDataError(error, context);
exports.handleDataError = handleDataError;
const handleSystemError = (error, context) => exports.errorHandlingService.handleSystemError(error, context);
exports.handleSystemError = handleSystemError;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRDpcXFByb2plY3RzXFxDYXJkRXZlcnl0aGluZ1xcY2FyZGFsbC1wcm90b3R5cGVcXHNyY1xcc2VydmljZXNcXGVycm9yLWhhbmRsaW5nXFxlcnJvci1oYW5kbGluZy1zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQUVILG1FQVVnQztBQUNoQyx5RUFBbUU7QUFDbkUsMkVBQXFFO0FBQ3JFLHFFQUErRDtBQUMvRCxzRUFBZ0U7QUE4RGhFOztHQUVHO0FBQ0gsTUFBYSwyQkFBMkI7SUFPdEMsWUFBb0IsTUFBcUM7UUFMakQ7Ozs7O1dBQTJCO1FBQzNCOzs7OztXQUF5QztRQUN6Qzs7Ozs7V0FBd0M7UUFDeEM7Ozs7O1dBQTBDO1FBR2hELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2pELElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFBO0lBQzNCLENBQUM7SUFFTSxNQUFNLENBQUMsV0FBVyxDQUFDLE1BQXFDO1FBQzdELElBQUksQ0FBQywyQkFBMkIsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUMxQywyQkFBMkIsQ0FBQyxRQUFRLEdBQUcsSUFBSSwyQkFBMkIsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNoRixDQUFDO1FBQ0QsT0FBTywyQkFBMkIsQ0FBQyxRQUFRLENBQUE7SUFDN0MsQ0FBQztJQUVEOztPQUVHO0lBQ0ksS0FBSyxDQUFDLGVBQWUsQ0FBQyxLQUFVLEVBQUUsT0FBYTtRQUNwRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUN4RCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsbUNBQVcsRUFBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUE7UUFFckQsY0FBYztRQUNkLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2pCLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQTtZQUMvQixNQUFN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QUFFLEVBQUUsQ0FDM0QsNEJBQW9CLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQTtBQUR6QyxRQUFBLGVBQWUsbUJBQzBCO0FBRS9DLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxLQUFVLEVBQUUsT0FBYSxFQUFFLEVBQUUsQ0FDN0QsNEJBQW9CLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFBO0FBRDNDLFFBQUEsaUJBQWlCLHFCQUMwQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJEOlxcUHJvamVjdHNcXENhcmRFdmVyeXRoaW5nXFxjYXJkYWxsLXByb3RvdHlwZVxcc3JjXFxzZXJ2aWNlc1xcZXJyb3ItaGFuZGxpbmdcXGVycm9yLWhhbmRsaW5nLXNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiDplJnor6/lpITnkIbmnI3liqFcbiAqIOe7n+S4gOmUmeivr+WkhOeQhuacuuWItueahOmbhuaIkOacjeWKoe+8jOS4uuWQjOatpeacjeWKoeaPkOS+m+WujOaVtOeahOmUmeivr+WkhOeQhuiDveWKm1xuICovXG5cbmltcG9ydCB7XG4gIHVuaWZpZWRFcnJvckhhbmRsZXIsXG4gIFVuaWZpZWRFcnJvcixcbiAgRXJyb3JDYXRlZ29yeSxcbiAgRXJyb3JTdWJDYXRlZ29yeSxcbiAgRXJyb3JMZXZlbCxcbiAgRXJyb3JDb250ZXh0LFxuICBFcnJvckhhbmRsaW5nUmVzdWx0LFxuICBoYW5kbGVFcnJvcixcbiAgY3JlYXRlRXJyb3JDb250ZXh0XG59IGZyb20gJy4vdW5pZmllZC1lcnJvci1oYW5kbGVyJ1xuaW1wb3J0IHsgRXJyb3JNb25pdG9yaW5nU2VydmljZSB9IGZyb20gJy4vZXJyb3ItbW9uaXRvcmluZy1zZXJ2aWNlJ1xuaW1wb3J0IHsgUmVjb3ZlcnlTdHJhdGVneU1hbmFnZXIgfSBmcm9tICcuL3JlY292ZXJ5LXN0cmF0ZWd5LW1hbmFnZXInXG5pbXBvcnQgeyBTZWxmSGVhbGluZ0ZyYW1ld29yayB9IGZyb20gJy4vc2VsZi1oZWFsaW5nLWZyYW1ld29yaydcbmltcG9ydCB7IG5ldHdvcmtTdGF0ZURldGVjdG9yIH0gZnJvbSAnLi4vbmV0d29yay1zdGF0ZS1kZXRlY3RvcidcblxuLy8g6ZSZ6K+v5aSE55CG5pyN5Yqh6YWN572uXG5leHBvcnQgaW50ZXJmYWNlIEVycm9ySGFuZGxpbmdDb25maWcge1xuICAvLyDlkK/nlKjnmoTlip/og71cbiAgZW5hYmxlTW9uaXRvcmluZzogYm9vbGVhblxuICBlbmFibGVSZWNvdmVyeTogYm9vbGVhblxuICBlbmFibGVTZWxmSGVhbGluZzogYm9vbGVhblxuXG4gIC8vIOebkeaOp+mFjee9rlxuICBtb25pdG9yaW5nOiB7XG4gICAgYnVmZmVyU2l6ZTogbnVtYmVyXG4gICAgaGlzdG9yeVNpemU6IG51bWJlclxuICAgIHNhbXBsZVJhdGU6IG51bWJlclxuICB9XG5cbiAgLy8g5oGi5aSN6YWN572uXG4gIHJlY292ZXJ5OiB7XG4gICAgbWF4UmV0cmllczogbnVtYmVyXG4gICAgYmFzZURlbGF5OiBudW1iZXJcbiAgICBtYXhEZWxheTogbnVtYmVyXG4gICAgZW5hYmxlQ2lyY3VpdEJyZWFrZXI6IGJvb2xlYW5cbiAgfVxuXG4gIC8vIOiHquaEiOmFjee9rlxuICBzZWxmSGVhbGluZzoge1xuICAgIGVuYWJsZWQ6IGJvb2xlYW5cbiAgICBhdXRvUmVwYWlyOiBib29sZWFuXG4gICAgbGVhcm5pbmdFbmFibGVkOiBib29sZWFuXG4gICAgbWF4QXBwbGljYXRpb25zOiBudW1iZXJcbiAgfVxuXG4gIC8vIOWRiuitpumFjee9rlxuICBhbGVydHM6IHtcbiAgICBlbmFibGVkOiBib29sZWFuXG4gICAgc2V2ZXJpdHk6ICdsb3cnIHwgJ21lZGl1bScgfCAnaGlnaCcgfCAnY3JpdGljYWwnXG4gICAgY2hhbm5lbHM6IHN0cmluZ1tdXG4gIH1cbn1cblxuLy8g6ZSZ6K+v5aSE55CG5pyN5Yqh5o6l5Y+jXG5leHBvcnQgaW50ZXJmYWNlIEVycm9ySGFuZGxpbmdTZXJ2aWNlIHtcbiAgLy8g5qC45b+D6ZSZ6K+v5aSE55CGXG4gIGhhbmRsZVN5bmNFcnJvcihlcnJvcjogYW55LCBjb250ZXh0PzogYW55KTogUHJvbWlzZTxFcnJvckhhbmRsaW5nUmVzdWx0PlxuICBoYW5kbGVOZXR3b3JrRXJyb3IoZXJyb3I6IGFueSwgY29udGV4dD86IGFueSk6IFByb21pc2U8RXJyb3JIYW5kbGluZ1Jlc3VsdD5cbiAgaGFuZGxlRGF0YUVycm9yKGVycm9yOiBhbnksIGNvbnRleHQ/OiBhbnkpOiBQcm9taXNlPEVycm9ySGFuZGxpbmdSZXN1bHQ+XG4gIGhhbmRsZVN5c3RlbUVycm9yKGVycm9yOiBhbnksIGNvbnRleHQ/OiBhbnkpOiBQcm9taXNlPEVycm9ySGFuZGxpbmdSZXN1bHQ+XG5cbiAgLy8g55uR5o6n5ZKM57uf6K6hXG4gIGdldEVycm9yU3RhdGlzdGljcygpOiBhbnlcbiAgZ2V0SGVhbHRoU3RhdHVzKCk6IGFueVxuICBnZXRSZWNlbnRFcnJvcnMobGltaXQ/OiBudW1iZXIpOiBVbmlmaWVkRXJyb3JbXVxuXG4gIC8vIOmFjee9rueuoeeQhlxuICB1cGRhdGVDb25maWcoY29uZmlnOiBQYXJ0aWFsPEVycm9ySGFuZGxpbmdDb25maWc+KTogdm9pZFxuICBnZXRDb25maWcoKTogRXJyb3JIYW5kbGluZ0NvbmZpZ1xuXG4gIC8vIOaBouWkjeWSjOiHquaEiFxuICBhdHRlbXB0UmVjb3ZlcnkoZXJyb3I6IFVuaWZpZWRFcnJvcik6IFByb21pc2U8Ym9vbGVhbj5cbiAgdHJpZ2dlclNlbGZIZWFsaW5nKGVycm9yOiBVbmlmaWVkRXJyb3IpOiBQcm9taXNlPGJvb2xlYW4+XG59XG5cbi8qKlxuICog6ZSZ6K+v5aSE55CG5pyN5Yqh5a6e546wXG4gKi9cbmV4cG9ydCBjbGFzcyBDYXJkQWxsRXJyb3JIYW5kbGluZ1NlcnZpY2UgaW1wbGVtZW50cyBFcnJvckhhbmRsaW5nU2VydmljZSB7XG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBDYXJkQWxsRXJyb3JIYW5kbGluZ1NlcnZpY2VcbiAgcHJpdmF0ZSBjb25maWc6IEVycm9ySGFuZGxpbmdDb25maWdcbiAgcHJpdmF0ZSBtb25pdG9yaW5nU2VydmljZTogRXJyb3JNb25pdG9yaW5nU2VydmljZVxuICBwcml2YXRlIHJlY292ZXJ5TWFuYWdlcjogUmVjb3ZlcnlTdHJhdGVneU1hbmFnZXJcbiAgcHJpdmF0ZSBzZWxmSGVhbGluZ0ZyYW1ld29yazogU2VsZkhlYWxpbmdGcmFtZXdvcmtcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKGNvbmZpZz86IFBhcnRpYWw8RXJyb3JIYW5kbGluZ0NvbmZpZz4pIHtcbiAgICB0aGlzLmNvbmZpZyA9IHRoaXMubWVyZ2VXaXRoRGVmYXVsdENvbmZpZyhjb25maWcpXG4gICAgdGhpcy5pbml0aWFsaXplU2VydmljZXMoKVxuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRJbnN0YW5jZShjb25maWc/OiBQYXJ0aWFsPEVycm9ySGFuZGxpbmdDb25maWc+KTogRXJyb3JIYW5kbGluZ1NlcnZpY2Uge1xuICAgIGlmICghQ2FyZEFsbEVycm9ySGFuZGxpbmdTZXJ2aWNlLmluc3RhbmNlKSB7XG4gICAgICBDYXJkQWxsRXJyb3JIYW5kbGluZ1NlcnZpY2UuaW5zdGFuY2UgPSBuZXcgQ2FyZEFsbEVycm9ySGFuZGxpbmdTZXJ2aWNlKGNvbmZpZylcbiAgICB9XG4gICAgcmV0dXJuIENhcmRBbGxFcnJvckhhbmRsaW5nU2VydmljZS5pbnN0YW5jZVxuICB9XG5cbiAgLyoqXG4gICAqIOWkhOeQhuWQjOatpemUmeivr1xuICAgKi9cbiAgcHVibGljIGFzeW5jIGhhbmRsZVN5bmNFcnJvcihlcnJvcjogYW55LCBjb250ZXh0PzogYW55KTogUHJvbWlzZTxFcnJvckhhbmRsaW5nUmVzdWx0PiB7XG4gICAgY29uc3QgZXJyb3JDb250ZXh0ID0gdGhpcy5jcmVhdGVDb250ZXh0KCdzeW5jJywgY29udGV4dClcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVFcnJvcihlcnJvciwgZXJyb3JDb250ZXh0KVxuXG4gICAgLy8g6K6w5b2V5ZCM5q2l54m55a6a55qE6ZSZ6K+v5L+h5oGvXG4gICAgaWYgKHJlc3VsdC5lcnJvcikge1xuICAgICAgcmVzdWx0LmVycm9yLm9wZXJhdGlvbiA9ICdzeW5jJ1xuICAgICAgcmVzdWx0LmVycm9yLmVudGl0eSA9IGNvbnRleHQ/LmVudGl0eVR5cGVcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0XG4gIH1cblxuICAvKipcbiAgICog5aSE55CG572R57uc6ZSZ6K+vXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgaGFuZGxlTmV0d29ya0Vycm9yKGVycm9yOiBhbnksIGNvbnRleHQ/OiBhbnkpOiBQcm9taXNlPEVycm9ySGFuZGxpbmdSZXN1bHQ+IHtcbiAgICBjb25zdCBlcnJvckNvbnRleHQgPSB0aGlzLmNyZWF0ZUNvbnRleHQoJ25ldHdvcmsnLCBjb250ZXh0KVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZUVycm9yKGVycm9yLCBlcnJvckNvbnRleHQpXG5cbiAgICAvLyDnvZHnu5zplJnor6/nibnmrorlpITnkIZcbiAgICBpZiAocmVzdWx0LmVycm9yPy5jYXRlZ29yeSA9PT0gRXJyb3JDYXRlZ29yeS5ORVRXT1JLKSB7XG4gICAgICAvLyDmo4Dmn6XnvZHnu5znirbmgIFcbiAgICAgIGNvbnN0IG5ldHdvcmtTdGF0ZSA9IG5ldHdvcmtTdGF0ZURldGVjdG9yLmdldEN1cnJlbnRTdGF0ZSgpXG4gICAgICByZXN1bHQuZXJyb3IuZGV0YWlscyA9IHtcbiAgICAgICAgLi4ucmVzdWx0LmVycm9yLmRldGFpbHMsXG4gICAgICAgIG5ldHdvcmtTdGF0ZSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgLyoqXG4gICAqIOWkhOeQhuaVsOaNrumUmeivr1xuICAgKi9cbiAgcHVibGljIGFzeW5jIGhhbmRsZURhdGFFcnJvcihlcnJvcjogYW55LCBjb250ZXh0PzogYW55KTogUHJvbWlzZTxFcnJvckhhbmRsaW5nUmVzdWx0PiB7XG4gICAgY29uc3QgZXJyb3JDb250ZXh0ID0gdGhpcy5jcmVhdGVDb250ZXh0KCdkYXRhJywgY29udGV4dClcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVFcnJvcihlcnJvciwgZXJyb3JDb250ZXh0KVxuXG4gICAgLy8g5pWw5o2u6ZSZ6K+v54m55q6K5aSE55CGXG4gICAgaWYgKHJlc3VsdC5lcnJvcj8uY2F0ZWdvcnkgPT09IEVycm9yQ2F0ZWdvcnkuREFUQSkge1xuICAgICAgcmVzdWx0LmVycm9yLmVudGl0eSA9IGNvbnRleHQ/LmVudGl0eVxuICAgICAgcmVzdWx0LmVycm9yLmRldGFpbHMgPSB7XG4gICAgICAgIC4uLnJlc3VsdC5lcnJvci5kZXRhaWxzLFxuICAgICAgICBkYXRhVHlwZTogY29udGV4dD8uZGF0YVR5cGUsXG4gICAgICAgIG9wZXJhdGlvbjogY29udGV4dD8ub3BlcmF0aW9uXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgLyoqXG4gICAqIOWkhOeQhuezu+e7n+mUmeivr1xuICAgKi9cbiAgcHVibGljIGFzeW5jIGhhbmRsZVN5c3RlbUVycm9yKGVycm9yOiBhbnksIGNvbnRleHQ/OiBhbnkpOiBQcm9taXNlPEVycm9ySGFuZGxpbmdSZXN1bHQ+IHtcbiAgICBjb25zdCBlcnJvckNvbnRleHQgPSB0aGlzLmNyZWF0ZUNvbnRleHQoJ3N5c3RlbScsIGNvbnRleHQpXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlRXJyb3IoZXJyb3IsIGVycm9yQ29udGV4dClcblxuICAgIC8vIOezu+e7n+mUmeivr+eJueauiuWkhOeQhlxuICAgIGlmIChyZXN1bHQuZXJyb3I/LmNhdGVnb3J5ID09PSBFcnJvckNhdGVnb3J5LlNZU1RFTSkge1xuICAgICAgcmVzdWx0LmVycm9yLmxldmVsID0gRXJyb3JMZXZlbC5DUklUSUNBTFxuICAgICAgcmVzdWx0LmVycm9yLnJldHJ5YWJsZSA9IGZhbHNlXG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPlumUmeivr+e7n+iuoeS/oeaBr1xuICAgKi9cbiAgcHVibGljIGdldEVycm9yU3RhdGlzdGljcygpOiBhbnkge1xuICAgIGlmICghdGhpcy5jb25maWcuZW5hYmxlTW9uaXRvcmluZykge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5tb25pdG9yaW5nU2VydmljZS5nZXRNZXRyaWNzKClcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5blgaXlurfnirbmgIFcbiAgICovXG4gIHB1YmxpYyBnZXRIZWFsdGhTdGF0dXMoKTogYW55IHtcbiAgICBjb25zdCBzdGF0cyA9IHRoaXMuZ2V0RXJyb3JTdGF0aXN0aWNzKClcbiAgICBjb25zdCBtZXRyaWNzID0gc3RhdHM/Lm1ldHJpY3MgfHwge31cblxuICAgIC8vIOiuoeeul+WBpeW6t+WIhuaVsFxuICAgIGxldCBoZWFsdGhTY29yZSA9IDEwMFxuXG4gICAgLy8g5Z+65LqO6ZSZ6K+v546H6LCD5pW05YGl5bq35YiG5pWwXG4gICAgaWYgKG1ldHJpY3MuZXJyb3JSYXRlID4gMC4xKSBoZWFsdGhTY29yZSAtPSAyMFxuICAgIGlmIChtZXRyaWNzLmVycm9yUmF0ZSA+IDAuMDUpIGhlYWx0aFNjb3JlIC09IDEwXG5cbiAgICAvLyDln7rkuo7mgaLlpI3njofosIPmlbTlgaXlurfliIbmlbBcbiAgICBpZiAobWV0cmljcy5yZWNvdmVyeVJhdGUgPCAwLjgpIGhlYWx0aFNjb3JlIC09IDE1XG4gICAgaWYgKG1ldHJpY3MucmVjb3ZlcnlSYXRlIDwgMC45KSBoZWFsdGhTY29yZSAtPSA1XG5cbiAgICAvLyDnoa7lrprlgaXlurfnirbmgIFcbiAgICBsZXQgc3RhdHVzOiAnaGVhbHRoeScgfCAnZGVncmFkZWQnIHwgJ3VuaGVhbHRoeSdcbiAgICBpZiAoaGVhbHRoU2NvcmUgPj0gOTApIHN0YXR1cyA9ICdoZWFsdGh5J1xuICAgIGVsc2UgaWYgKGhlYWx0aFNjb3JlID49IDcwKSBzdGF0dXMgPSAnZGVncmFkZWQnXG4gICAgZWxzZSBzdGF0dXMgPSAndW5oZWFsdGh5J1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1cyxcbiAgICAgIHNjb3JlOiBNYXRoLm1heCgwLCBoZWFsdGhTY29yZSksXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICBtZXRyaWNzLFxuICAgICAgcmVjb21tZW5kYXRpb25zOiB0aGlzLmdlbmVyYXRlUmVjb21tZW5kYXRpb25zKHN0YXR1cywgbWV0cmljcylcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5pyA6L+R55qE6ZSZ6K+vXG4gICAqL1xuICBwdWJsaWMgZ2V0UmVjZW50RXJyb3JzKGxpbWl0OiBudW1iZXIgPSA1MCk6IFVuaWZpZWRFcnJvcltdIHtcbiAgICBpZiAoIXRoaXMuY29uZmlnLmVuYWJsZU1vbml0b3JpbmcpIHtcbiAgICAgIHJldHVybiBbXVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLm1vbml0b3JpbmdTZXJ2aWNlLmdldFJlY2VudEVycm9ycyhsaW1pdClcbiAgfVxuXG4gIC8qKlxuICAgKiDmm7TmlrDphY3nva5cbiAgICovXG4gIHB1YmxpYyB1cGRhdGVDb25maWcobmV3Q29uZmlnOiBQYXJ0aWFsPEVycm9ySGFuZGxpbmdDb25maWc+KTogdm9pZCB7XG4gICAgdGhpcy5jb25maWcgPSB7IC4uLnRoaXMuY29uZmlnLCAuLi5uZXdDb25maWcgfVxuICAgIHRoaXMucmVjb25maWd1cmVTZXJ2aWNlcygpXG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5b2T5YmN6YWN572uXG4gICAqL1xuICBwdWJsaWMgZ2V0Q29uZmlnKCk6IEVycm9ySGFuZGxpbmdDb25maWcge1xuICAgIHJldHVybiB7IC4uLnRoaXMuY29uZmlnIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDlsJ3or5XmgaLlpI3plJnor69cbiAgICovXG4gIHB1YmxpYyBhc3luYyBhdHRlbXB0UmVjb3ZlcnkoZXJyb3I6IFVuaWZpZWRFcnJvcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGlmICghdGhpcy5jb25maWcuZW5hYmxlUmVjb3ZlcnkpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBjb250ZXh0ID0gY3JlYXRlRXJyb3JDb250ZXh0KFxuICAgICAgICB7IG9wZXJhdGlvbjogZXJyb3Iub3BlcmF0aW9uIH0sXG4gICAgICAgIGVycm9yLnVzZXJJZCxcbiAgICAgICAgJ3Byb2R1Y3Rpb24nXG4gICAgICApXG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVjb3ZlcnlNYW5hZ2VyLmF0dGVtcHRSZWNvdmVyeShlcnJvciwgY29udGV4dClcbiAgICAgIHJldHVybiByZXN1bHQuc3VjY2Vzc1xuICAgIH0gY2F0Y2ggKHJlY292ZXJ5RXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1JlY292ZXJ5IGF0dGVtcHQgZmFpbGVkOicsIHJlY292ZXJ5RXJyb3IpXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6Kem5Y+R6Ieq5oSIXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgdHJpZ2dlclNlbGZIZWFsaW5nKGVycm9yOiBVbmlmaWVkRXJyb3IpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBpZiAoIXRoaXMuY29uZmlnLmVuYWJsZVNlbGZIZWFsaW5nKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgY29udGV4dCA9IGNyZWF0ZUVycm9yQ29udGV4dChcbiAgICAgICAgeyBvcGVyYXRpb246IGVycm9yLm9wZXJhdGlvbiB9LFxuICAgICAgICBlcnJvci51c2VySWQsXG4gICAgICAgICdwcm9kdWN0aW9uJ1xuICAgICAgKVxuXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zZWxmSGVhbGluZ0ZyYW1ld29yay5hdHRlbXB0SGVhbGluZyhlcnJvciwgY29udGV4dClcbiAgICB9IGNhdGNoIChoZWFsaW5nRXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1NlbGYtaGVhbGluZyBhdHRlbXB0IGZhaWxlZDonLCBoZWFsaW5nRXJyb3IpXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5Yid5aeL5YyW5pyN5YqhXG4gICAqL1xuICBwcml2YXRlIGluaXRpYWxpemVTZXJ2aWNlcygpOiB2b2lkIHtcbiAgICAvLyDliJ3lp4vljJbnm5HmjqfmnI3liqFcbiAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlTW9uaXRvcmluZykge1xuICAgICAgdGhpcy5tb25pdG9yaW5nU2VydmljZSA9IEVycm9yTW9uaXRvcmluZ1NlcnZpY2UuZ2V0SW5zdGFuY2UoKVxuICAgIH1cblxuICAgIC8vIOWIneWni+WMluaBouWkjeeuoeeQhuWZqFxuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVSZWNvdmVyeSkge1xuICAgICAgdGhpcy5yZWNvdmVyeU1hbmFnZXIgPSBSZWNvdmVyeVN0cmF0ZWd5TWFuYWdlci5nZXRJbnN0YW5jZSh7XG4gICAgICAgIG1heEF0dGVtcHRzOiB0aGlzLmNvbmZpZy5yZWNvdmVyeS5tYXhSZXRyaWVzLFxuICAgICAgICBiYXNlRGVsYXk6IHRoaXMuY29uZmlnLnJlY292ZXJ5LmJhc2VEZWxheSxcbiAgICAgICAgbWF4RGVsYXk6IHRoaXMuY29uZmlnLnJlY292ZXJ5Lm1heERlbGF5XG4gICAgICB9KVxuICAgIH1cblxuICAgIC8vIOWIneWni+WMluiHquaEiOahhuaetlxuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVTZWxmSGVhbGluZykge1xuICAgICAgdGhpcy5zZWxmSGVhbGluZ0ZyYW1ld29yayA9IFNlbGZIZWFsaW5nRnJhbWV3b3JrLmdldEluc3RhbmNlKHtcbiAgICAgICAgYXV0b1JlcGFpcjogdGhpcy5jb25maWcuc2VsZkhlYWxpbmcuYXV0b1JlcGFpcixcbiAgICAgICAgbGVhcm5pbmdFbmFibGVkOiB0aGlzLmNvbmZpZy5zZWxmSGVhbGluZy5sZWFybmluZ0VuYWJsZWQsXG4gICAgICAgIG1heEFwcGxpY2F0aW9uczogdGhpcy5jb25maWcuc2VsZkhlYWxpbmcubWF4QXBwbGljYXRpb25zXG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDph43mlrDphY3nva7mnI3liqFcbiAgICovXG4gIHByaXZhdGUgcmVjb25maWd1cmVTZXJ2aWNlcygpOiB2b2lkIHtcbiAgICAvLyDph43mlrDliJ3lp4vljJbmnI3liqHku6XlupTnlKjmlrDphY3nva5cbiAgICB0aGlzLmluaXRpYWxpemVTZXJ2aWNlcygpXG4gIH1cblxuICAvKipcbiAgICog5Yib5bu66ZSZ6K+v5LiK5LiL5paHXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZUNvbnRleHQob3BlcmF0aW9uOiBzdHJpbmcsIGFkZGl0aW9uYWxDb250ZXh0PzogYW55KTogRXJyb3JDb250ZXh0IHtcbiAgICByZXR1cm4gY3JlYXRlRXJyb3JDb250ZXh0KFxuICAgICAgeyBvcGVyYXRpb24sIC4uLmFkZGl0aW9uYWxDb250ZXh0IH0sXG4gICAgICBhZGRpdGlvbmFsQ29udGV4dD8udXNlcklkLFxuICAgICAgYWRkaXRpb25hbENvbnRleHQ/LmVudmlyb25tZW50IHx8ICdkZXZlbG9wbWVudCdcbiAgICApXG4gIH1cblxuICAvKipcbiAgICog5ZCI5bm26buY6K6k6YWN572uXG4gICAqL1xuICBwcml2YXRlIG1lcmdlV2l0aERlZmF1bHRDb25maWcoY29uZmlnPzogUGFydGlhbDxFcnJvckhhbmRsaW5nQ29uZmlnPik6IEVycm9ySGFuZGxpbmdDb25maWcge1xuICAgIGNvbnN0IGRlZmF1bHRDb25maWc6IEVycm9ySGFuZGxpbmdDb25maWcgPSB7XG4gICAgICBlbmFibGVNb25pdG9yaW5nOiB0cnVlLFxuICAgICAgZW5hYmxlUmVjb3Zlcnk6IHRydWUsXG4gICAgICBlbmFibGVTZWxmSGVhbGluZzogdHJ1ZSxcbiAgICAgIG1vbml0b3Jpbmc6IHtcbiAgICAgICAgYnVmZmVyU2l6ZTogMTAwMCxcbiAgICAgICAgaGlzdG9yeVNpemU6IDE2OCxcbiAgICAgICAgc2FtcGxlUmF0ZTogMS4wXG4gICAgICB9LFxuICAgICAgcmVjb3Zlcnk6IHtcbiAgICAgICAgbWF4UmV0cmllczogMyxcbiAgICAgICAgYmFzZURlbGF5OiAxMDAwLFxuICAgICAgICBtYXhEZWxheTogMzAwMDAsXG4gICAgICAgIGVuYWJsZUNpcmN1aXRCcmVha2VyOiB0cnVlXG4gICAgICB9LFxuICAgICAgc2VsZkhlYWxpbmc6IHtcbiAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgYXV0b1JlcGFpcjogdHJ1ZSxcbiAgICAgICAgbGVhcm5pbmdFbmFibGVkOiB0cnVlLFxuICAgICAgICBtYXhBcHBsaWNhdGlvbnM6IDEwMFxuICAgICAgfSxcbiAgICAgIGFsZXJ0czoge1xuICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICBzZXZlcml0eTogJ21lZGl1bScsXG4gICAgICAgIGNoYW5uZWxzOiBbJ2NvbnNvbGUnXVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IC4uLmRlZmF1bHRDb25maWcsIC4uLmNvbmZpZyB9XG4gIH1cblxuICAvKipcbiAgICog55Sf5oiQ5YGl5bq35bu66K6uXG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlUmVjb21tZW5kYXRpb25zKHN0YXR1czogc3RyaW5nLCBtZXRyaWNzOiBhbnkpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgcmVjb21tZW5kYXRpb25zOiBzdHJpbmdbXSA9IFtdXG5cbiAgICBpZiAoc3RhdHVzID09PSAndW5oZWFsdGh5Jykge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ+ezu+e7n+WBpeW6t+eKtuWGteS4jeS9s++8jOW7uuiurueri+WNs+ajgOafpemUmeivr+aXpeW/lycpXG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgn6ICD6JmR5ZCv55So6Ieq5Yqo5oGi5aSN5py65Yi2JylcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCfmo4Dmn6XnvZHnu5zov57mjqXlkozmnI3liqHlmajnirbmgIEnKVxuICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSAnZGVncmFkZWQnKSB7XG4gICAgICBpZiAobWV0cmljcy5lcnJvclJhdGUgPiAwLjA1KSB7XG4gICAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCfplJnor6/njofovoPpq5jvvIzlu7rorq7mo4Dmn6XplJnor6/mqKHlvI8nKVxuICAgICAgfVxuICAgICAgaWYgKG1ldHJpY3MucmVjb3ZlcnlSYXRlIDwgMC45KSB7XG4gICAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCfmgaLlpI3njoflgY/kvY7vvIzlu7rorq7kvJjljJbmgaLlpI3nrZbnlaUnKVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZWNvbW1lbmRhdGlvbnNcbiAgfVxufVxuXG4vLyDlr7zlh7rlrp7kvotcbmV4cG9ydCBjb25zdCBlcnJvckhhbmRsaW5nU2VydmljZSA9IENhcmRBbGxFcnJvckhhbmRsaW5nU2VydmljZS5nZXRJbnN0YW5jZSgpXG5cbi8vIOWvvOWHuuS+v+aNt+WHveaVsFxuZXhwb3J0IGNvbnN0IGhhbmRsZVN5bmNFcnJvciA9IChlcnJvcjogYW55LCBjb250ZXh0PzogYW55KSA9PlxuICBlcnJvckhhbmRsaW5nU2VydmljZS5oYW5kbGVTeW5jRXJyb3IoZXJyb3IsIGNvbnRleHQpXG5cbmV4cG9ydCBjb25zdCBoYW5kbGVOZXR3b3JrRXJyb3IgPSAoZXJyb3I6IGFueSwgY29udGV4dD86IGFueSkgPT5cbiAgZXJyb3JIYW5kbGluZ1NlcnZpY2UuaGFuZGxlTmV0d29ya0Vycm9yKGVycm9yLCBjb250ZXh0KVxuXG5leHBvcnQgY29uc3QgaGFuZGxlRGF0YUVycm9yID0gKGVycm9yOiBhbnksIGNvbnRleHQ/OiBhbnkpID0+XG4gIGVycm9ySGFuZGxpbmdTZXJ2aWNlLmhhbmRsZURhdGFFcnJvcihlcnJvciwgY29udGV4dClcblxuZXhwb3J0IGNvbnN0IGhhbmRsZVN5c3RlbUVycm9yID0gKGVycm9yOiBhbnksIGNvbnRleHQ/OiBhbnkpID0+XG4gIGVycm9ySGFuZGxpbmdTZXJ2aWNlLmhhbmRsZVN5c3RlbUVycm9yKGVycm9yLCBjb250ZXh0KSJdLCJ2ZXJzaW9uIjozfQ==