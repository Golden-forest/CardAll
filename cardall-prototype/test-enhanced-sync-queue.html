<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Sync Queue Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.danger {
            background: #dc3545;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced Sync Queue Test</h1>

        <div class="test-section">
            <h3>Queue Operations</h3>
            <button class="btn" onclick="testEnqueueOperation()">Enqueue Test Operation</button>
            <button class="btn" onclick="testEnqueueBatch()">Enqueue Batch Operations</button>
            <button class="btn" onclick="testQueueStats()">Get Queue Stats</button>
            <button class="btn" onclick="testQueueHealth()">Check Queue Health</button>
            <button class="btn success" onclick="triggerOptimization()">Trigger Optimization</button>
            <button class="btn danger" onclick="emergencyStop()">Emergency Stop</button>
            <button class="btn success" onclick="resumeProcessing()">Resume Processing</button>
        </div>

        <div class="test-section">
            <h3>Performance Metrics</h3>
            <div class="metrics">
                <div class="metric">
                    <div class="metric-value" id="totalProcessed">0</div>
                    <div class="metric-label">Total Processed</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="totalFailed">0</div>
                    <div class="metric-label">Total Failed</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="avgProcessingTime">0ms</div>
                    <div class="metric-label">Avg Processing Time</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>Operation History</h3>
            <button class="btn" onclick="getOperationHistory()">Get Recent History</button>
            <button class="btn" onclick="clearHistory()">Clear History</button>
            <div id="historyContainer"></div>
        </div>

        <div class="test-section">
            <h3>Network & Resource Status</h3>
            <div class="metrics">
                <div class="metric">
                    <div class="metric-value" id="networkStatus">Unknown</div>
                    <div class="metric-label">Network Status</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="memoryUsage">0MB</div>
                    <div class="metric-label">Memory Usage</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="circuitBreaker">Closed</div>
                    <div class="metric-label">Circuit Breaker</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="queueSize">0</div>
                    <div class="metric-label">Queue Size</div>
                </div>
            </div>
        </div>

        <div id="statusContainer"></div>
    </div>

    <script type="module">
        // 动态导入增强的同步队列服务
        import {
            syncQueueManager,
            enqueueSyncOperation,
            enqueueSyncBatch,
            getSyncQueueStats,
            getSyncQueueHealth,
            getSyncPerformanceMetrics,
            getAllSyncOperationHistory,
            triggerSyncOptimization,
            resetSyncQueue,
            emergencyStopSyncQueue,
            resumeSyncQueue
        } from './src/services/sync-queue.ts'

        // 测试用的模拟操作
        function createTestOperation(id, type = 'create', entity = 'card') {
            return {
                type,
                entity,
                entityId: `test-${id}-${Date.now()}`,
                userId: 'test-user',
                data: {
                    title: `Test ${type} ${id}`,
                    content: `Test content for ${type} operation ${id}`,
                    timestamp: new Date().toISOString()
                },
                priority: Math.random() > 0.7 ? 'high' : 'normal',
                retryCount: 0,
                maxRetries: 3,
                dependencies: []
            }
        }

        // 全局函数
        window.testEnqueueOperation = async function() {
            try {
                const operation = createTestOperation(1)
                const operationId = await enqueueSyncOperation(operation)
                showStatus(`Enqueued operation: ${operationId}`, 'success')
                updateMetrics()
            } catch (error) {
                showStatus(`Failed to enqueue operation: ${error.message}`, 'error')
            }
        }

        window.testEnqueueBatch = async function() {
            try {
                const operations = [
                    createTestOperation(1, 'create', 'card'),
                    createTestOperation(2, 'update', 'folder'),
                    createTestOperation(3, 'delete', 'tag')
                ]
                const operationIds = await enqueueSyncBatch(operations)
                showStatus(`Enqueued batch: ${operationIds.join(', ')}`, 'success')
                updateMetrics()
            } catch (error) {
                showStatus(`Failed to enqueue batch: ${error.message}`, 'error')
            }
        }

        window.testQueueStats = async function() {
            try {
                const stats = await getSyncQueueStats()
                showStatus(`Queue Stats: ${JSON.stringify(stats, null, 2)}`, 'info')
                updateQueueSize(stats.totalOperations)
            } catch (error) {
                showStatus(`Failed to get queue stats: ${error.message}`, 'error')
            }
        }

        window.testQueueHealth = async function() {
            try {
                const health = await getSyncQueueHealth()
                showStatus(`Queue Health: ${health.status.toUpperCase()}`, health.status === 'healthy' ? 'success' : 'error')
                showStatus(`Issues: ${health.issues.join(', ') || 'None'}`, 'info')
                updateNetworkStatus(health.networkStatus)
                updateCircuitBreaker(health.circuitBreaker)
                updateMemoryUsage(health.resourceUsage.memory)
            } catch (error) {
                showStatus(`Failed to get queue health: ${error.message}`, 'error')
            }
        }

        window.triggerOptimization = async function() {
            try {
                await triggerSyncOptimization()
                showStatus('Queue optimization triggered', 'success')
                updateMetrics()
            } catch (error) {
                showStatus(`Failed to trigger optimization: ${error.message}`, 'error')
            }
        }

        window.emergencyStop = function() {
            emergencyStopSyncQueue()
            showStatus('Queue processing emergency stopped', 'error')
            updateCircuitBreaker(true)
        }

        window.resumeProcessing = function() {
            resumeSyncQueue()
            showStatus('Queue processing resumed', 'success')
            updateCircuitBreaker(false)
        }

        window.getOperationHistory = async function() {
            try {
                const history = await getAllSyncOperationHistory({ limit: 10 })
                const container = document.getElementById('historyContainer')
                container.innerHTML = `
                    <h4>Recent Operations History</h4>
                    <pre>${JSON.stringify(history, null, 2)}</pre>
                `
            } catch (error) {
                showStatus(`Failed to get operation history: ${error.message}`, 'error')
            }
        }

        window.clearHistory = async function() {
            try {
                await resetSyncQueue({ clearHistory: true })
                showStatus('Operation history cleared', 'success')
                document.getElementById('historyContainer').innerHTML = ''
            } catch (error) {
                showStatus(`Failed to clear history: ${error.message}`, 'error')
            }
        }

        // 辅助函数
        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer')
            const statusDiv = document.createElement('div')
            statusDiv.className = `status ${type}`
            statusDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
            container.appendChild(statusDiv)

            // 保持最新的10条消息
            while (container.children.length > 10) {
                container.removeChild(container.firstChild)
            }
        }

        async function updateMetrics() {
            try {
                const metrics = await getSyncPerformanceMetrics()
                document.getElementById('totalProcessed').textContent = metrics.totalProcessed
                document.getElementById('totalFailed').textContent = metrics.totalFailed
                document.getElementById('avgProcessingTime').textContent = `${Math.round(metrics.averageProcessingTime)}ms`

                const successRate = metrics.totalProcessed > 0
                    ? ((metrics.totalProcessed - metrics.totalFailed) / metrics.totalProcessed * 100).toFixed(1)
                    : 0
                document.getElementById('successRate').textContent = `${successRate}%`
            } catch (error) {
                console.error('Failed to update metrics:', error)
            }
        }

        function updateQueueSize(size) {
            document.getElementById('queueSize').textContent = size
        }

        function updateNetworkStatus(networkStatus) {
            const status = networkStatus.isOnline ? 'Online' : 'Offline'
            if (networkStatus.effectiveType) {
                document.getElementById('networkStatus').textContent = `${status} (${networkStatus.effectiveType})`
            } else {
                document.getElementById('networkStatus').textContent = status
            }
        }

        function updateCircuitBreaker(isOpen) {
            document.getElementById('circuitBreaker').textContent = isOpen ? 'Open' : 'Closed'
            document.getElementById('circuitBreaker').style.color = isOpen ? '#dc3545' : '#28a745'
        }

        function updateMemoryUsage(memoryBytes) {
            const memoryMB = Math.round(memoryBytes / 1024 / 1024)
            document.getElementById('memoryUsage').textContent = `${memoryMB}MB`
        }

        // 定期更新指标
        setInterval(() => {
            updateMetrics()
        }, 5000)

        // 初始化
        updateMetrics()
        showStatus('Enhanced Sync Queue Test initialized', 'success')
    </script>
</body>
</html>